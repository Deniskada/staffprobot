# Active Context

## Текущий фокус разработки

**Эпик: Оферта + KYC ЕСИА + ПЭП подписание**  
План: `doc/plans/offer_edo_plan.md`  
Статус: **Утверждён** (2026-02-15)

Расширение Модуля 4 (Кадровое ЭДО) — новый тип договора «Оферта (договор присоединения)» с воркфлоу подписания через ПЭП и верификацией через ЕСИА.

## Контекст задачи

### Фаза A — можно начинать сейчас:
1. **Эпик 1**: Тип «Оферта» + конструктор (seed-миграция, ConstructorFlow, шаги по разделам оферты)
2. **Эпик 4**: Уведомления (OFFER_SENT, OFFER_ACCEPTED, KYC_REQUIRED и др.)

### Фаза B — параллельно с заявкой на ЕСИА:
3. **Эпик 3 (без KYC)**: Статус pending_acceptance, ПЭП через Telegram, PDF-генерация (weasyprint), сохранение в S3

### Фаза C — после получения client_id ЕСИА:
4. **Эпик 2**: ЕСИА-клиент + Docker cryptopro-sign + реальный GosuslugiKycProvider

## Зависимости

- S3-хранилище: ✅ работает (MinIO dev и prod) — `shared/services/media_storage/`
- KYC-сервис: ✅ заглушка есть — `shared/services/kyc_service.py`
- Конструктор договоров: ✅ работает — `ConstructorFlow/Step/Fragment`
- Система уведомлений: ✅ работает — `NotificationType`, `NotificationTypeMeta`, `base_templates.py`
- **Блокер ЕСИА**: ❌ нет client_id (нужна регистрация ИС в Минцифры, 2-4 недели)
- **Блокер КриптоПро**: ❌ нет серверной лицензии (триал 3 мес. для разработки)

## Ключевые решения

- KYC ЕСИА **не блокирует** подписание — только проверка заполненности реквизитов в профиле
- Сотрудник сам заполняет реквизиты в `/employee/profile` до подписания
- Обязательные поля: ФИО, пол, дата рождения, паспорт, адрес, телефон, email, СНИЛС, расчётный счёт, БИК
- Банковские реквизиты: `account_number` + `bik` уже есть в `BankDetailsMixin`
- ПЭП: абстракция каналов (`PepChannel` → TG сейчас, SMS потом)
- Множественные оферты: один владелец — несколько оферт для разных типов услуг
- Автоакцепт изменений: подписанные договоры не меняются, новые — по новой версии
- PDF: weasyprint (HTML → PDF), хранение в S3 `contracts/{id}/signed_{ver}.pdf`
- КриптоПро: только для подписи запросов к ЕСИА, для ПЭП не нужен

---

**Обновлено**: 2026-02-15
