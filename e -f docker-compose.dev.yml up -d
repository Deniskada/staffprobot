[1mdiff --git a/apps/bot/handlers_div/schedule_handlers.py b/apps/bot/handlers_div/schedule_handlers.py[m
[1mindex bb77f28..83d1d8c 100644[m
[1m--- a/apps/bot/handlers_div/schedule_handlers.py[m
[1m+++ b/apps/bot/handlers_div/schedule_handlers.py[m
[36m@@ -286,9 +286,14 @@[m [masync def handle_view_schedule(update: Update, context: ContextTypes.DEFAULT_TYP[m
             shifts = shifts_result.scalars().all()[m
             [m
             if not shifts:[m
[32m+[m[32m                keyboard = [[InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]][m
[32m+[m[32m                reply_markup = InlineKeyboardMarkup(keyboard)[m
[32m+[m[41m                [m
                 await update.callback_query.edit_message_text([m
                     "üìÖ **–í–∞—à–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–º–µ–Ω—ã**\n\n"[m
[31m-                    "–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω."[m
[32m+[m[32m                    "–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω.",[m
[32m+[m[32m                    parse_mode='Markdown',[m
[32m+[m[32m                    reply_markup=reply_markup[m
                 )[m
                 return[m
             [m
[36m@@ -408,21 +413,21 @@[m [masync def handle_cancel_shift(update: Update, context: ContextTypes.DEFAULT_TYPE[m
             [m
             # –°–æ—Ö—Ä–∞–Ω—è–µ–º shift_id –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞[m
             context.user_data['cancelling_shift_id'] = shift_id[m
[31m-            [m
[31m-            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏—á–∏–Ω—ã[m
[31m-            keyboard = [[m
[31m-                [InlineKeyboardButton("üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞", callback_data=f"cancel_reason_medical_cert")],[m
[31m-                [InlineKeyboardButton("üö® –°–ø—Ä–∞–≤–∫–∞ –æ—Ç –ú–ß–°", callback_data=f"cancel_reason_emergency_cert")],[m
[31m-                [InlineKeyboardButton("üëÆ –°–ø—Ä–∞–≤–∫–∞ –æ—Ç –ø–æ–ª–∏—Ü–∏–∏", callback_data=f"cancel_reason_police_cert")],[m
[31m-                [InlineKeyboardButton("‚ùì –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞", callback_data=f"cancel_reason_other")],[m
[31m-                [InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∞", callback_data="view_schedule")][m
[31m-            ][m
[31m-            reply_markup = InlineKeyboardMarkup(keyboard)[m
[31m-            [m
[31m-            # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è[m
[32m+[m
[32m+[m[32m            # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç (–Ω—É–∂–µ–Ω –¥–ª—è owner_id –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)[m
             object_query = select(Object).where(Object.id == shift.object_id)[m
             object_result = await session.execute(object_query)[m
             obj = object_result.scalar_one_or_none()[m
[32m+[m[41m            [m
[32m+[m[32m            # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º –ø—Ä–∏—á–∏–Ω—ã –∏–∑ –ë–î –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –æ–±—ä–µ–∫—Ç–∞[m
[32m+[m[32m            from shared.services.cancellation_policy_service import CancellationPolicyService[m
[32m+[m[32m            owner_id = obj.owner_id if obj else None[m
[32m+[m[32m            reasons = await CancellationPolicyService.get_owner_reasons(session, owner_id) if owner_id else [][m
[32m+[m[32m            keyboard_rows = [][m
[32m+[m[32m            for r in reasons:[m
[32m+[m[32m                keyboard_rows.append([InlineKeyboardButton(r.title, callback_data=f"cancel_reason_{r.code}")])[m
[32m+[m[32m            keyboard_rows.append([InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∞", callback_data="view_schedule")])[m
[32m+[m[32m            reply_markup = InlineKeyboardMarkup(keyboard_rows)[m
             object_name = obj.name if obj else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç"[m
             [m
             # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã Markdown[m
[36m@@ -466,32 +471,49 @@[m [masync def handle_cancel_reason_selection(update: Update, context: ContextTypes.D[m
     # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–∏—á–∏–Ω—É –∏–∑ callback_data[m
     reason = query.data.replace("cancel_reason_", "")[m
     shift_id = context.user_data.get('cancelling_shift_id')[m
[31m-    [m
[32m+[m
[32m+[m[32m    logger.info(f"Cancel reason selection: user={telegram_id}, reason={reason}, shift_id={shift_id}")[m
[32m+[m
     if not shift_id:[m
[32m+[m[32m        logger.error(f"No shift_id in context for user {telegram_id}")[m
         await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞: —Å–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.")[m
         return[m
[31m-    [m
[32m+[m
     # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏—á–∏–Ω—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç[m
     context.user_data['cancel_reason'] = reason[m
[31m-    [m
[31m-    # –î–ª—è —Å–ø—Ä–∞–≤–æ–∫ –∏ "–î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞" –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ/–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ[m
[31m-    if reason in ['medical_cert', 'emergency_cert', 'police_cert']:[m
[31m-        reason_names = {[m
[31m-            'medical_cert': '–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏',[m
[31m-            'emergency_cert': '—Å–ø—Ä–∞–≤–∫–∏ –æ—Ç –ú–ß–°',[m
[31m-            'police_cert': '—Å–ø—Ä–∞–≤–∫–∏ –æ—Ç –ø–æ–ª–∏—Ü–∏–∏'[m
[31m-        }[m
[31m-        [m
[32m+[m
[32m+[m[32m    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ–±—ä–µ–∫—Ç–∞[m
[32m+[m[32m    from core.database.session import get_async_session[m
[32m+[m[32m    async with get_async_session() as session:[m
[32m+[m[32m        shift_query = select(ShiftSchedule).where(ShiftSchedule.id == shift_id)[m
[32m+[m[32m        shift_result = await session.execute(shift_query)[m
[32m+[m[32m        shift = shift_result.scalar_one_or_none()[m
[32m+[m[32m        if not shift:[m
[32m+[m[32m            await query.edit_message_text("‚ùå –°–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")[m
[32m+[m[32m            return[m
[32m+[m[32m        object_query = select(Object).where(Object.id == shift.object_id)[m
[32m+[m[32m        obj = (await session.execute(object_query)).scalar_one_or_none()[m
[32m+[m[32m        if not obj:[m
[32m+[m[32m            await query.edit_message_text("‚ùå –û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")[m
[32m+[m[32m            return[m
[32m+[m[32m        from shared.services.cancellation_policy_service import CancellationPolicyService[m
[32m+[m[32m        reason_map = await CancellationPolicyService.get_reason_map(session, obj.owner_id)[m
[32m+[m[32m        policy = reason_map.get(reason)[m
[32m+[m[32m        requires_document = bool(policy and policy.requires_document)[m
[32m+[m
[32m+[m[32m    # –í–µ—Ç–≤–ª–µ–Ω–∏–µ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞[m
[32m+[m[32m    if requires_document:[m
         # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞[m
         from core.state.user_state_manager import user_state_manager, UserAction, UserStep[m
         user_state_manager.set_state([m
             telegram_id,[m
[31m-            action=UserAction.CANCEL_SHIFT,[m
[32m+[m[32m            action=UserAction.CANCEL_SCHEDULE,[m
             step=UserStep.INPUT_DOCUMENT[m
         )[m
[31m-        [m
[32m+[m
[32m+[m[32m        title = policy.title if policy else '–¥–æ–∫—É–º–µ–Ω—Ç–∞'[m
         await query.edit_message_text([m
[31m-            f"üìÑ **–û–ø–∏—Å–∞–Ω–∏–µ {reason_names[reason]}**\n\n"[m
[32m+[m[32m            f"üìÑ **–û–ø–∏—Å–∞–Ω–∏–µ {title}**\n\n"[m
             f"–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –¥–∞—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞.\n"[m
             f"–ù–∞–ø—Ä–∏–º–µ—Ä: `‚Ññ123 –æ—Ç 10.10.2025`\n\n"[m
             f"–°–ø—Ä–∞–≤–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º.",[m
[36m@@ -502,7 +524,7 @@[m [masync def handle_cancel_reason_selection(update: Update, context: ContextTypes.D[m
         from core.state.user_state_manager import user_state_manager, UserAction, UserStep[m
         user_state_manager.set_state([m
             telegram_id,[m
[31m-            action=UserAction.CANCEL_SHIFT,[m
[32m+[m[32m            action=UserAction.CANCEL_SCHEDULE,[m
             step=UserStep.INPUT_DOCUMENT[m
         )[m
         [m
[36m@@ -512,6 +534,29 @@[m [masync def handle_cancel_reason_selection(update: Update, context: ContextTypes.D[m
             "–í–∞—à–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º.",[m
             parse_mode='Markdown'[m
         )[m
[32m+[m[32m    else:[m
[32m+[m[32m        # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω (–Ω–µ —Ç—Ä–µ–±—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç) —Å—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ–º –æ—Ç–º–µ–Ω—É[m
[32m+[m[32m        logger.info(f"Executing immediate cancellation for user {telegram_id}, reason={reason}, shift_id={shift_id}")[m
[32m+[m[32m        success = await _execute_shift_cancellation([m
[32m+[m[32m            shift_id=shift_id,[m
[32m+[m[32m            telegram_id=telegram_id,[m
[32m+[m[32m            reason=reason,[m
[32m+[m[32m            reason_notes=None,[m
[32m+[m[32m            document_description=None,[m
[32m+[m[32m            context=context,[m
[32m+[m[32m            query=query[m
[32m+[m[32m        )[m
[32m+[m[41m        [m
[32m+[m[32m        if success:[m
[32m+[m[32m            await query.edit_message_text([m
[32m+[m[32m                "‚úÖ –°–º–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞!\n\n"[m
[32m+[m[32m                "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",[m
[32m+[m[32m                reply_markup=InlineKeyboardMarkup([[[m
[32m+[m[32m                    InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")[m
[32m+[m[32m                ]])[m
[32m+[m[32m            )[m
[32m+[m[32m        else:[m
[32m+[m[32m            await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–º–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")[m
 [m
 [m
 async def handle_cancellation_document_input(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:[m
[36m@@ -519,6 +564,14 @@[m [masync def handle_cancellation_document_input(update: Update, context: ContextTyp[m
     telegram_id = update.effective_user.id[m
     description_text = update.message.text[m
     [m
[32m+[m[32m    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è[m
[32m+[m[32m    from core.state.user_state_manager import user_state_manager, UserAction, UserStep[m
[32m+[m[32m    user_state = await user_state_manager.get_state(telegram_id)[m
[32m+[m[41m    [m
[32m+[m[32m    if not user_state or user_state.action != UserAction.CANCEL_SCHEDULE or user_state.step != UserStep.INPUT_DOCUMENT:[m
[32m+[m[32m        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–≤–æ–¥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º[m
[32m+[m[32m        return[m
[32m+[m[41m    [m
     shift_id = context.user_data.get('cancelling_shift_id')[m
     reason = context.user_data.get('cancel_reason')[m
     [m
[36m@@ -569,7 +622,7 @@[m [masync def handle_cancellation_document_input(update: Update, context: ContextTyp[m
             from core.state.user_state_manager import user_state_manager, UserAction, UserStep[m
             user_state_manager.set_state([m
                 telegram_id,[m
[31m-                action=UserAction.CANCEL_SHIFT,[m
[32m+[m[32m                action=UserAction.CANCEL_SCHEDULE,[m
                 step=UserStep.INPUT_PHOTO[m
             )[m
             [m
[36m@@ -729,28 +782,37 @@[m [masync def _execute_shift_cancellation([m
     context: ContextTypes.DEFAULT_TYPE,[m
     query: Optional[Any] = None,[m
     message: Optional[Any] = None[m
[31m-) -> None:[m
[32m+[m[32m) -> bool:[m
     """–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ—Ç–º–µ–Ω—É —Å–º–µ–Ω—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–µ—Ä–≤–∏—Å–∞."""[m
[32m+[m[32m    logger.info(f"Starting shift cancellation: shift_id={shift_id}, telegram_id={telegram_id}, reason={reason}")[m
[32m+[m[41m    [m
     from core.database.session import get_async_session[m
     from shared.services.shift_cancellation_service import ShiftCancellationService[m
     [m
     try:[m
         async with get_async_session() as session:[m
[32m+[m[32m            logger.info(f"Got database session for cancellation")[m
[32m+[m[41m            [m
             # –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è[m
             user_query = select(User).where(User.telegram_id == telegram_id)[m
             user_result = await session.execute(user_query)[m
             user = user_result.scalar_one_or_none()[m
             [m
[32m+[m[32m            logger.info(f"Found user: {user.id if user else 'None'}")[m
[32m+[m[41m            [m
             if not user:[m
                 text = "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."[m
                 if query:[m
                     await query.edit_message_text(text)[m
                 elif message:[m
                     await message.reply_text(text)[m
[31m-                return[m
[32m+[m[32m                return False[m
             [m
             # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–º–µ–Ω—ã[m
[32m+[m[32m            logger.info(f"Creating ShiftCancellationService")[m
             cancellation_service = ShiftCancellationService(session)[m
[32m+[m[32m            logger.info(f"Calling cancel_shift with shift_schedule_id={shift_id}, cancelled_by_user_id={user.id}")[m
[32m+[m[41m            [m
             result = await cancellation_service.cancel_shift([m
                 shift_schedule_id=shift_id,[m
                 cancelled_by_user_id=user.id,[m
[36m@@ -800,6 +862,7 @@[m [masync def _execute_shift_cancellation([m
                     await message.reply_text(text, parse_mode='Markdown')[m
                 [m
                 # TODO: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É/—É–ø—Ä–∞–≤–ª—è—é—â–µ–º—É[m
[32m+[m[32m                return True[m
                 [m
             else:[m
                 text = f"‚ùå {result['message']}"[m
[36m@@ -807,14 +870,17 @@[m [masync def _execute_shift_cancellation([m
                     await query.edit_message_text(text)[m
                 elif message:[m
                     await message.reply_text(text)[m
[32m+[m[32m                return False[m
     [m
     except Exception as e:[m
[31m-        logger.error(f"Error executing shift cancellation: {e}")[m
[32m+[m[32m        logger.error(f"Error executing shift cancellation: {e}", exc_info=True)[m
[32m+[m[32m        logger.error(f"Exception details: type={type(e)}, args={e.args}")[m
         text = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."[m
         if query:[m
             await query.edit_message_text(text)[m
         elif message:[m
             await message.reply_text(text)[m
[32m+[m[32m        return False[m
 [m
 [m
 async def handle_close_schedule(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:[m
