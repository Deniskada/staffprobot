# –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ StaffProBot

## üéØ –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç enum –∑–Ω–∞—á–µ–Ω–∏–π
**–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–ù–¶–ò–ü**: –í—Å–µ enum –ø–æ–ª—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç **`.value`** (lowercase —Å—Ç—Ä–æ–∫–∏), –∞ –Ω–µ `.name` (uppercase —Å—Ç—Ä–æ–∫–∏).

–≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è–º enum –≤ Python:
- `NotificationType.SHIFT_STARTED = "shift_started"` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `"shift_started"`
- `NotificationChannel.TELEGRAM = "telegram"` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `"telegram"`
- `NotificationStatus.PENDING = "pending"` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `"pending"`
- `NotificationPriority.NORMAL = "normal"` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `"normal"`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ enum —Ç–∏–ø–æ–≤
```python
# –í—Å–µ enum –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ domain/entities/notification.py
from domain.entities.notification import (
    NotificationType,
    NotificationStatus,
    NotificationChannel,
    NotificationPriority
)

# –ü—Ä–∏–º–µ—Ä—ã –∑–Ω–∞—á–µ–Ω–∏–π:
NotificationType.SHIFT_STARTED.value == "shift_started"  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
NotificationType.SHIFT_STARTED.name == "SHIFT_STARTED"   # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è –ë–î

NotificationChannel.TELEGRAM.value == "telegram"         # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
NotificationChannel.TELEGRAM.name == "TELEGRAM"          # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è –ë–î
```

## üìã –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ß–µ—Ä–µ–∑ NotificationService (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–±)

```python
from shared.services.notification_service import NotificationService

notification_service = NotificationService()

# –ü–µ—Ä–µ–¥–∞–µ–º enum –æ–±—ä–µ–∫—Ç—ã - —Å–µ—Ä–≤–∏—Å —Å–∞–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ .value
notification = await notification_service.create_notification(
    user_id=user_id,
    type=NotificationType.SHIFT_STARTED,  # Enum –æ–±—ä–µ–∫—Ç
    channel=NotificationChannel.TELEGRAM,  # Enum –æ–±—ä–µ–∫—Ç
    title="–ó–∞–≥–æ–ª–æ–≤–æ–∫",
    message="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
    data={"shift_id": 123, "object_id": 456},  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON)
    priority=NotificationPriority.HIGH,  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é NORMAL
    scheduled_at=datetime.now(timezone.utc)  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
)
```

**–í–ê–ñ–ù–û**: `NotificationService.create_notification()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `.value` –¥–ª—è –≤—Å–µ—Ö enum –ø–æ–ª–µ–π. –°–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–µ—Ç —Å–≤–æ—é —Å–µ—Å—Å–∏—é –ë–î, —á—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑ –ª—é–±–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

### –ß–µ—Ä–µ–∑ ORM –Ω–∞–ø—Ä—è–º—É—é (—Ç–æ–ª—å–∫–æ –≤ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö)

```python
from domain.entities.notification import Notification

# –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º .value –¥–ª—è –≤—Å–µ—Ö enum –ø–æ–ª–µ–π!
notification = Notification(
    user_id=user_id,
    type=notif_type.value,  # ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ .value
    channel=channel.value,  # ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ .value
    status=NotificationStatus.PENDING.value,  # ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ .value
    priority=priority_enum.value,  # ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ .value
    title=title,
    message=message,
    data=data or {},
    scheduled_at=scheduled_at
)

session.add(notification)
await session.commit()
```

**–ó–ê–ü–†–ï–©–ï–ù–û**:
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å .name –∏–ª–∏ enum –æ–±—ä–µ–∫—Ç –Ω–∞–ø—Ä—è–º—É—é
notification = Notification(
    type=NotificationType.SHIFT_STARTED,  # ‚ùå Enum –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ .value
    channel="TELEGRAM",  # ‚ùå Uppercase –≤–º–µ—Å—Ç–æ lowercase
    status=NotificationStatus.PENDING.name,  # ‚ùå .name –≤–º–µ—Å—Ç–æ .value
)
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```python
# –ß–µ—Ä–µ–∑ –º–µ—Ç–æ–¥—ã –º–æ–¥–µ–ª–∏ (–æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç .value)
notification.mark_as_read()  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç NotificationStatus.READ.value
notification.mark_as_sent()  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç NotificationStatus.SENT.value
notification.mark_as_failed(error_message="–û—à–∏–±–∫–∞")  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç NotificationStatus.FAILED.value

await session.commit()
```

### –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SQL (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)

```python
from sqlalchemy import update, text

# –ò—Å–ø–æ–ª—å–∑—É–µ–º .value –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
await session.execute(
    update(Notification)
    .where(Notification.id == notification_id)
    .values(
        status=NotificationStatus.READ.value,  # ‚úÖ .value
        read_at=datetime.now(timezone.utc)
    )
)
await session.commit()
```

## üîç –ß—Ç–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ enum –ø–æ–ª—è–º

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ SQL –∑–∞–ø—Ä–æ—Å—ã –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.value`, –∞ –Ω–µ `.name`!

```python
from sqlalchemy import select, cast, String

# –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ –≤ –ë–î —Ö—Ä–∞–Ω—è—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è (.value)
query = select(Notification).where(
    Notification.type == NotificationType.SHIFT_STARTED.value,  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º .value
    Notification.status == NotificationStatus.PENDING.value,  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º .value
    Notification.channel == NotificationChannel.TELEGRAM.value  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º .value
)

# –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ cast –¥–ª—è String –∫–æ–ª–æ–Ω–æ–∫ - –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º .value
from sqlalchemy import cast, String
query = select(Notification).where(
    cast(Notification.status, String) != NotificationStatus.READ.value,  # ‚úÖ .value
    cast(Notification.channel, String) == NotificationChannel.IN_APP.value  # ‚úÖ .value
)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ .name
query = select(Notification).where(
    cast(Notification.status, String) != NotificationStatus.READ.name,  # ‚ùå .name - –æ—à–∏–±–∫–∞!
    cast(Notification.channel, String) == NotificationChannel.IN_APP.name  # ‚ùå .name - –æ—à–∏–±–∫–∞!
)
```

**–í `NotificationService.get_user_notifications()` –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–∞—Ö**: –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `.value` –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î.

### –î–æ—Å—Ç—É–ø –∫ enum –∏–∑ –º–æ–¥–µ–ª–∏

```python
# –ú–æ–¥–µ–ª—å Notification –∏–º–µ–µ—Ç —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏ –≤ enum
notification = await session.get(Notification, notification_id)

# –î–æ—Å—Ç—É–ø –∫ enum –æ–±—ä–µ–∫—Ç–∞–º —á–µ—Ä–µ–∑ —Å–≤–æ–π—Å—Ç–≤–∞ –º–æ–¥–µ–ª–∏
type_enum = notification.type_enum  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç NotificationType
channel_enum = notification.channel_enum  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç NotificationChannel
status_enum = notification.status_enum  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç NotificationStatus
priority_enum = notification.priority_enum  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç NotificationPriority

# –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ —Å—Ç—Ä–æ–∫–æ–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é (–∫–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î)
type_str = notification.type  # "shift_started"
status_str = notification.status  # "pending"
```

## üö® –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞ 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ .name –≤–º–µ—Å—Ç–æ .value
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
notification = Notification(
    type=NotificationType.SHIFT_STARTED.name,  # "SHIFT_STARTED" - –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ enum!
    channel=NotificationChannel.TELEGRAM.name  # "TELEGRAM" - –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ enum!
)

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
notification = Notification(
    type=NotificationType.SHIFT_STARTED.value,  # "shift_started"
    channel=NotificationChannel.TELEGRAM.value  # "telegram"
)
```

### –û—à–∏–±–∫–∞ 2: –ü–µ—Ä–µ–¥–∞—á–∞ enum –æ–±—ä–µ–∫—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é –≤ –º–æ–¥–µ–ª—å
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç String, –∞ –Ω–µ Enum
notification = Notification(
    type=NotificationType.SHIFT_STARTED,  # Enum –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏
    channel=NotificationChannel.TELEGRAM  # Enum –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏
)
# –û—à–∏–±–∫–∞: DatatypeMismatchError

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º .value
notification = Notification(
    type=NotificationType.SHIFT_STARTED.value,
    channel=NotificationChannel.TELEGRAM.value
)
```

### –û—à–∏–±–∫–∞ 3: –°–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (uppercase –∏ lowercase)
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–º–µ—à–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—ã
notification = Notification(
    type="shift_started",  # lowercase - –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    channel="TELEGRAM",  # uppercase - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
    status="pending",  # lowercase - –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    priority="HIGH"  # uppercase - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
)

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –≤—Å–µ lowercase —á–µ—Ä–µ–∑ .value
notification = Notification(
    type=NotificationType.SHIFT_STARTED.value,  # "shift_started"
    channel=NotificationChannel.TELEGRAM.value,  # "telegram"
    status=NotificationStatus.PENDING.value,  # "pending"
    priority=NotificationPriority.NORMAL.value  # "normal"
)
```

## üìù –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è Celery –∑–∞–¥–∞—á

### –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Celery –∑–∞–¥–∞—á–∞—Ö

```python
# –í core/celery/tasks/reminder_tasks.py
from shared.services.notification_service import NotificationService

async def _create_notification_task():
    async with get_async_session() as session:
        notification_service = NotificationService()
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–∏—Å - –æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç enum
        await notification_service.create_notification(
            user_id=user_id,
            type=NotificationType.OBJECT_NO_SHIFTS_TODAY,  # Enum –æ–±—ä–µ–∫—Ç
            channel=NotificationChannel.TELEGRAM,  # Enum –æ–±—ä–µ–∫—Ç
            title="–ù–µ—Ç —Å–º–µ–Ω",
            message="–ù–∞ –æ–±—ä–µ–∫—Ç–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω",
            priority=NotificationPriority.HIGH
        )
```

### –ü—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ORM (–µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

```python
from domain.entities.notification import Notification

async def _create_notification_direct(session):
    notification = Notification(
        user_id=user_id,
        type=NotificationType.OBJECT_NO_SHIFTS_TODAY.value,  # ‚úÖ .value
        channel=NotificationChannel.TELEGRAM.value,  # ‚úÖ .value
        status=NotificationStatus.PENDING.value,  # ‚úÖ .value
        priority=NotificationPriority.HIGH.value,  # ‚úÖ .value
        title="–ó–∞–≥–æ–ª–æ–≤–æ–∫",
        message="–°–æ–æ–±—â–µ–Ω–∏–µ",
        data={}
    )
    session.add(notification)
    await session.commit()
```

## üé® –†–∞–±–æ—Ç–∞ —Å —à–∞–±–ª–æ–Ω–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```python
from shared.templates.notifications.base_templates import NotificationTemplateManager

# –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –∫–∞–Ω–∞–ª–∞
rendered = NotificationTemplateManager.render(
    notification_type=NotificationType.SHIFT_STARTED,  # Enum –æ–±—ä–µ–∫—Ç
    channel=NotificationChannel.TELEGRAM,  # Enum –æ–±—ä–µ–∫—Ç
    variables={
        "shift_id": "123",
        "object_name": "–û–±—ä–µ–∫—Ç 1",
        "employee_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
    }
)

# –†–µ–∑—É–ª—å—Ç–∞—Ç: {"title": "...", "message": "..."}
title = rendered["title"]
message = rendered["message"]

# –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º
await notification_service.create_notification(
    user_id=user_id,
    type=NotificationType.SHIFT_STARTED,  # Enum –æ–±—ä–µ–∫—Ç
    channel=NotificationChannel.TELEGRAM,  # Enum –æ–±—ä–µ–∫—Ç
    title=title,
    message=message,
    data={"shift_id": 123}
)
```

## üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user = await session.get(User, user_id)
prefs = user.notification_preferences or {}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ type_code (–∑–Ω–∞—á–µ–Ω–∏–µ enum, –Ω–∞–ø—Ä–∏–º–µ—Ä "shift_started")
type_code = NotificationType.SHIFT_STARTED.value  # "shift_started"
type_prefs = prefs.get(type_code, {})

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω –ª–∏ –∫–∞–Ω–∞–ª
telegram_enabled = type_prefs.get("telegram", True) if type_code in prefs else True
inapp_enabled = type_prefs.get("inapp", True) if type_code in prefs else True

# –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
if telegram_enabled:
    await notification_service.create_notification(
        user_id=user_id,
        type=NotificationType.SHIFT_STARTED,
        channel=NotificationChannel.TELEGRAM,  # Enum –æ–±—ä–µ–∫—Ç
        ...
    )

if inapp_enabled:
    await notification_service.create_notification(
        user_id=user_id,
        type=NotificationType.SHIFT_STARTED,
        channel=NotificationChannel.IN_APP,  # Enum –æ–±—ä–µ–∫—Ç
        ...
    )
```

## üìä –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```python
# –í –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic
def upgrade() -> None:
    # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ enum (–∏—Å–ø–æ–ª—å–∑—É–µ–º lowercase)
    op.execute("ALTER TYPE notificationtype ADD VALUE IF NOT EXISTS 'new_type_code'")
    
    # –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ notification_types_meta
    op.execute("""
        INSERT INTO notification_types_meta 
        (type_code, title, description, category, default_priority, ...)
        VALUES
        ('new_type_code', '–ù–æ–≤—ã–π —Ç–∏–ø', '–û–ø–∏—Å–∞–Ω–∏–µ', 'shifts', 'normal', ...)
        ON CONFLICT (type_code) DO NOTHING
    """)
```

**–í–ê–ñ–ù–û**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ lowercase –∑–Ω–∞—á–µ–Ω–∏—è (–∫–∞–∫ `.value` –≤ Python enum) –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ enum —Ç–∏–ø—ã PostgreSQL.

### –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π

–ï—Å–ª–∏ –≤ –ë–î –µ—Å—Ç—å —Å–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (uppercase –∏ lowercase), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```python
def upgrade() -> None:
    # 1. –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ lowercase –∑–Ω–∞—á–µ–Ω–∏—è
    op.execute("ALTER TYPE notificationtype ADD VALUE IF NOT EXISTS 'shift_started'")
    
    # 2. –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
    op.execute("""
        UPDATE notifications 
        SET type = CAST('shift_started' AS notificationtype)
        WHERE type::text = 'SHIFT_STARTED'
    """)
```

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `NotificationService.create_notification()` (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ) –∏–ª–∏ ORM —Å `.value`
- [ ] –í—Å–µ enum –ø–æ–ª—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç `.value` (lowercase —Å—Ç—Ä–æ–∫–∏), –∞ –Ω–µ `.name` (uppercase)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–¥–∞–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –í `data` –ø–µ—Ä–µ–¥–∞–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (shift_id, object_id –∏ —Ç.–¥.)
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–∏ –ë–î (–Ω–µ –≤ –Ω–æ–≤–æ–π)

## üè¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–±—ä–µ–∫—Ç–∞—Ö

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–±—ä–µ–∫—Ç–∞

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–±—ä–µ–∫—Ç–∞—Ö –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ** –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–±—ä–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ –±–æ—Ç, –∞ —Ç–∞–∫–∂–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É `check_object_openings`.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: `shared/services/object_opening_service.py`

```python
from shared.services.object_opening_service import ObjectOpeningService

# –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–±—ä–µ–∫—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
async with get_async_session() as session:
    opening_service = ObjectOpeningService(session)
    opening = await opening_service.open_object(
        object_id=object_id,
        user_id=user_id,  # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –∏–∑ –ë–î, –Ω–µ telegram_id!
        coordinates="lat,lon"
    )
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è OBJECT_OPENED –∏–ª–∏ OBJECT_LATE_OPENING —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    # –î–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ–±—ä–µ–∫—Ç–∞ (obj.owner) –≤ –∫–∞–Ω–∞–ª–∞—Ö Telegram –∏ InApp (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)

# –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–±—ä–µ–∫—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–∞–∫–∂–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
opening = await opening_service.close_object(
    object_id=object_id,
    user_id=user_id,  # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –∏–∑ –ë–î
    coordinates="lat,lon"
)
# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è OBJECT_CLOSED –∏–ª–∏ OBJECT_EARLY_CLOSING —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

**–í–∞–∂–Ω–æ**:
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—á–∏—Ç—ã–≤–∞—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ–±—ä–µ–∫—Ç–∞ (`obj.owner.notification_preferences`)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –≤–æ–≤—Ä–µ–º—è –ª–∏ –æ—Ç–∫—Ä—ã–ª—Å—è/–∑–∞–∫—Ä—ã–ª—Å—è –æ–±—ä–µ–∫—Ç (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `opening_time`/`closing_time`)
- –ï—Å–ª–∏ –æ–ø–æ–∑–¥–∞–Ω–∏–µ/—Ä–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ > 5 –º–∏–Ω—É—Ç ‚Üí `OBJECT_LATE_OPENING`/`OBJECT_EARLY_CLOSING` (HIGH –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- –ï—Å–ª–∏ –≤–æ–≤—Ä–µ–º—è ‚Üí `OBJECT_OPENED`/`OBJECT_CLOSED` (NORMAL –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (—á–µ—Ä–µ–∑ Celery –∑–∞–¥–∞—á—É)

–ó–∞–¥–∞—á–∞ `check_object_openings` (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é):
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- –°–æ–∑–¥–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ —Ä–∞–±–æ—Ç—ã –æ–±—ä–µ–∫—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –¥–∞—Ç–µ, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- **–ú–æ–¥–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**: `domain/entities/notification.py`
- **–°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**: `shared/services/notification_service.py`
- **–°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–º–µ–Ω–∞—Ö**: `shared/services/shift_notification_service.py`
- **–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞–º–∏**: `shared/services/object_opening_service.py` (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–±—ä–µ–∫—Ç–∞—Ö)
- **–®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**: `shared/templates/notifications/base_templates.py`
- **Celery –∑–∞–¥–∞—á–∏**: `core/celery/tasks/reminder_tasks.py` (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤)
- **–ú–∏–≥—Ä–∞—Ü–∏—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏**: `migrations/versions/ffaa1ceacd63_unify_notification_enums_to_lowercase_.py`

---

**–ü–æ–º–Ω–∏**: 
1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `.value` –¥–ª—è enum –ø–æ–ª–µ–π –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏! –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ —Ç–∏–ø–∞ `DatatypeMismatchError`.
2. –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ SQL –∑–∞–ø—Ä–æ—Å—ã (–æ—Å–æ–±–µ–Ω–Ω–æ —Å `cast(Notification.status, String)`) –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π `.value`, –∞ –Ω–µ `.name`!
3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–±—ä–µ–∫—Ç–∞—Ö –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ—Ä–µ–∑ `ObjectOpeningService` - –Ω–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Ö –≤—Ä—É—á–Ω—É—é –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –±–æ—Ç–∞.
