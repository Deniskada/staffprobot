# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Phase 4A: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π

## –°—Ç–∞—Ç—É—Å: ‚úÖ –ì–û–¢–û–í–û –ö –†–£–ß–ù–û–ú–£ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

–î–∞—Ç–∞: 2025-10-11  
–í–µ—Ç–∫–∞: `feature/employee-payment-accounting`  
–ö–æ–º–º–∏—Ç—ã: `a5b7869`, `0db376a`, `3078f74`, `825341e`

---

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ 1. –ú–æ–¥–µ–ª—å –∏ –º–∏–≥—Ä–∞—Ü–∏—è
- –¢–∞–±–ª–∏—Ü–∞ `payroll_adjustments` —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã: `shift_tasks`, `payroll_deductions`, `payroll_bonuses`
- –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã: employee_id, shift_id, object_id, adjustment_type, is_applied, created_at
- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞: `e6381c327d9e_create_payroll_adjustments_drop_old_tables`

### ‚úÖ 2. –ò–º–ø–æ—Ä—Ç—ã –∏ —Å–µ—Ä–≤–∏—Å—ã
- `PayrollAdjustment` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- `PayrollAdjustmentService` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- `LatePenaltyCalculator` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- `TimeslotTaskTemplate` –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª

### ‚úÖ 3. –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ 358 —Ä–æ—É—Ç–æ–≤
- –†–æ—É—Ç–µ—Ä `/owner/payroll-adjustments` —Å–æ–¥–µ—Ä–∂–∏—Ç 4 —Ä–æ—É—Ç–∞:
  - GET `/payroll-adjustments` - —Å–ø–∏—Å–æ–∫
  - POST `/payroll-adjustments/create` - —Å–æ–∑–¥–∞–Ω–∏–µ
  - POST `/payroll-adjustments/{id}/edit` - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  - GET `/payroll-adjustments/{id}/history` - –∏—Å—Ç–æ—Ä–∏—è

### ‚úÖ 4. HTTP –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
- `/owner/payroll-adjustments` ‚Üí HTTP 200 ‚úì
- `/employee/earnings` ‚Üí HTTP 302 (—Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é) ‚úì

### ‚úÖ 5. Cleanup
- –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏: `shift_task.py`, `payroll_deduction.py`, `payroll_bonus.py`
- –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ —Ä–æ—É—Ç—ã: `/owner/shift-tasks` (3 —Ä–æ—É—Ç–∞)
- –£–¥–∞–ª–µ–Ω–∞ –ø–∞–ø–∫–∞: `templates/owner/shift_tasks/`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö

---

## –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å)

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã –±–µ–∑ –æ–ø–æ–∑–¥–∞–Ω–∏—è
**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 15, –æ–±—ä–µ–∫—Ç 9)
2. –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î:
   ```sql
   SELECT * FROM payroll_adjustments WHERE shift_id = <ID>;
   ```
4. –û–∂–∏–¥–∞–µ—Ç—Å—è: 1 –∑–∞–ø–∏—Å—å —Å `adjustment_type='shift_base'`, `amount=<total_payment>`

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º
**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
- –û–±—ä–µ–∫—Ç 9 –Ω–∞—Å–ª–µ–¥—É–µ—Ç –æ—Ç org_unit 6 ‚Üí parent 1
- –ö–æ—Ä–Ω–µ–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: threshold=0 –º–∏–Ω, penalty=10‚ÇΩ/–º–∏–Ω

**–®–∞–≥–∏:**
1. –°–æ–∑–¥–∞—Ç—å planned_shift —Å planned_start –≤ –ø—Ä–æ—à–ª–æ–º
2. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º 10 –º–∏–Ω—É—Ç
3. –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å adjustments:
   - `shift_base`: +<–æ–ø–ª–∞—Ç–∞>‚ÇΩ
   - `late_start`: -100‚ÇΩ (10 –º–∏–Ω √ó 10‚ÇΩ)

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ (–≤–ª–∞–¥–µ–ª–µ—Ü)
**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å `/owner/payroll-adjustments`
2. –ù–∞–∂–∞—Ç—å "–î–æ–±–∞–≤–∏—Ç—å —Ä—É—á–Ω—É—é –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É"
3. –í—ã–±—Ä–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, —Ç–∏–ø (–ø—Ä–µ–º–∏—è), —Å—É–º–º—É 500‚ÇΩ, –æ–ø–∏—Å–∞–Ω–∏–µ
4. –°–æ–∑–¥–∞—Ç—å
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ
   - `adjustment_type='manual_bonus'`, `amount=500`

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
**–®–∞–≥–∏:**
1. –ù–∞–π—Ç–∏ —Ä—É—á–Ω—É—é –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É (unapplied)
2. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
3. –ò–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É –Ω–∞ 600‚ÇΩ, –æ–ø–∏—Å–∞–Ω–∏–µ
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –°—É–º–º–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
   - –í `edit_history` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å —Å timestamp, user_id, field, old_value, new_value

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏
**–®–∞–≥–∏:**
1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
2. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ò—Å—Ç–æ—Ä–∏—è"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
   - –ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –¥–∞—Ç–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 6: –§–∏–ª—å—Ç—Ä—ã
**–®–∞–≥–∏:**
1. –°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É (late_start)
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Ñ–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –°—Ü–µ–Ω–∞—Ä–∏–π 7: employee/earnings
**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å `/employee/earnings` –æ—Ç –∏–º–µ–Ω–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –°–º–µ–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ (—à—Ç—Ä–∞—Ñ—ã, –ø—Ä–µ–º–∏–∏) –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
   - –°—É–º–º—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
   - –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (+/-)

### –°—Ü–µ–Ω–∞—Ä–∏–π 8: Celery –∑–∞–¥–∞—á–∞
**–®–∞–≥–∏:**
1. –°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ adjustments (is_applied=false)
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å payment_schedule —Å –¥–∞—Ç–æ–π –≤—ã–ø–ª–∞—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é:
   ```python
   from core.celery.tasks.payroll_tasks import create_payroll_entries_by_schedule
   result = create_payroll_entries_by_schedule()
   ```
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –°–æ–∑–¥–∞–Ω `payroll_entry` –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞
   - Adjustments –æ—Ç–º–µ—á–µ–Ω—ã `is_applied=true`
   - `payroll_entry_id` –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω
   - –°—É–º–º—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã

‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –±–µ–∑ –æ—à–∏–±–æ–∫
- –¢–∞–±–ª–∏—Ü–∞ `payroll_adjustments` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ò–Ω–¥–µ–∫—Å—ã –∏ FK —Å–æ–∑–¥–∞–Ω—ã
- –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã

‚úÖ **–ö–æ–¥:**
- –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- –ù–µ—Ç –æ—à–∏–±–æ–∫ NameError/ModuleNotFoundError
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

‚úÖ **UI:**
- –°—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ—Å—Ç—É–ø–Ω—ã (HTTP 200/302)
- –†–æ—É—Ç–µ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- –ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **TODO –≤ –∫–æ–¥–µ:** –í `shared/services/shift_service.py` —Å—Ç—Ä–æ–∫–∞ 227:
   ```python
   # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –º–æ–¥–µ–ª–∏ –∑–∞–¥–∞—á
   ```
   –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á —Å–º–µ–Ω—ã (–∏–∑ `shift.object.shift_tasks` JSONB) –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

2. **Celery –∑–∞–¥–∞—á–∞:** –§—É–Ω–∫—Ü–∏—è `_get_payment_period_for_date()` –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç `periods` –≤ `PaymentSchedule`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ

3. **Manager UI:** UI –¥–ª—è —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö –æ—Ç–º–µ–Ω–µ–Ω (cancelled), –∏—Å–ø–æ–ª—å–∑—É—é—Ç owner UI —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Å—Ç–æ–≥–æ:** –∑–∞–∫—Ä–æ–π—Ç–µ —Å–º–µ–Ω—É –±–µ–∑ –æ–ø–æ–∑–¥–∞–Ω–∏—è
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ:** –æ–±—ä–µ–∫—Ç 9 ‚Üí org_unit 6 ‚Üí parent 1 (threshold=0, penalty=10‚ÇΩ)
3. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ UI:** –≤—Å–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã:** –≤—Å–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
5. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ Celery:** –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ payroll_entries

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. –û–±–Ω–æ–≤–∏—Ç—å Celery —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ `core/celery/celery_app.py`:
   - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É `process_automatic_deductions` ‚Üí `create_payroll_entries_by_schedule`
   - –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞ 01:00

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–¥–∞—á —Å–º–µ–Ω—ã (TODO –≤ shift_service.py)

3. –î–µ–ø–ª–æ–π –Ω–∞ production –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üéâ

