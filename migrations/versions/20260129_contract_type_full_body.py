"""Добавить full_body в contract_types; seed полного текста договора подряда.

Revision ID: full_body_260129
Revises: frag_disputes_260129
Create Date: 2026-01-29
"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

revision: str = "full_body_260129"
down_revision: Union[str, Sequence[str], None] = "frag_disputes_260129"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    op.add_column(
        "contract_types",
        sa.Column("full_body", sa.Text(), nullable=True, comment="Полный текст договора с плейсхолдерами Jinja2"),
    )
    conn = op.get_bind()
    from sqlalchemy import text
    body = _get_gpc_full_body()
    conn.execute(
        text("UPDATE contract_types SET full_body = :b WHERE code = 'gpc_contract'"),
        {"b": body},
    )


def downgrade() -> None:
    op.drop_column("contract_types", "full_body")


def _get_gpc_full_body() -> str:
    """Полный текст договора подряда с плейсхолдерами."""
    return r'''
Договор подряда № {{ contract_number }}
{{ sign_place }}	{{ sign_date }}

{{ customer_party }}

и,

{{ contractor_party }}

заключили настоящий Договор о нижеследующем:

    1. Предмет договора
        1.1. Подрядчик обязуется выполнить по заданию Заказчика Работы, указанные в пункте 1.2 настоящего Договора, а Заказчик обязуется принять и оплатить результат выполненных Работ.
        1.2. Подрядчик обязуется выполнить следующие Работы:
{% if works_list %}
{% for item in works_list %}
            1.2.{{ loop.index }}. {{ item }}.
{% endfor %}
{% else %}
            {{ works_default }}
{% endif %}
        1.3. Срок начала выполнения Работ: {{ start_date }}
Срок сдачи работ: {{ end_date }}

    2. Стоимость Работ и порядок расчетов
        2.1. Стоимость работ по настоящему Договору составляет {{ cost }} ({{ cost_words }}) рублей {{ cost_kopecks }} копеек.
        2.2. {{ cost_note }}
        2.3. {{ payment_terms }}
        2.4. {{ payment_form_text }}
        2.5. Стороны при заключении настоящего Договора исходили из того, что Подрядчик применяет специальный налоговый режим «Налог на профессиональный доход» (Федеральный закон от 27.11.2018 № 422-ФЗ).
        2.6. В соответствии со ст. 14 Федерального Закона № 422-ФЗ от 27.11.2018, Подрядчик обязуется передать Заказчику чек (в электронном виде или распечатанным на бумаге), сформированный при расчете за работы, указанные в п. 1.2 настоящего Договора.
        2.7. В случае снятия Подрядчика с учета в качестве плательщика налога на профессиональный доход он обязуется сообщить об этом Заказчику письменно в течение 3-х дней.
        2.8. В случае нарушения обязанностей, предусмотренных п. 2.6., Подрядчик уплачивает Заказчику неустойку в размере фактически понесенных им дополнительных расходов.
        2.9. По требованию Заказчика Подрядчик предоставляет справку о состоянии расчетов по налогу на профессиональный доход.

    3. Порядок выполнения и сдачи-приемки Работ
        3.1. Подрядчик приступает к началу выполнения Работ в сроки, установленные пунктом 1.3. настоящего Договора.
        3.2. Работа выполняется из материалов {{ materials_supplier }}.
        3.3. Обязанность по обеспечению сохранности материалов и оборудования несет {{ materials_responsible }}.
        3.4. Подрядчик выполняет Работы своими силами и не вправе привлекать к их выполнению третьих лиц.
{% if assistance_list %}
        3.5. Заказчик обязан обеспечить Подрядчику все необходимые условия для беспрепятственного выполнения Работ, в том числе:
{% for item in assistance_list %}
            3.5.{{ loop.index }}. {{ item }}.
{% endfor %}
{% else %}
        3.5. Заказчик обязан обеспечить Подрядчику все необходимые условия для беспрепятственного выполнения Работ.
{% endif %}
        3.6. Заказчик вправе в любое время проверять ход и качество выполнения Работ Подрядчиком.
        3.7–3.15. [Стандартные положения о приёмке, сроках, качестве — см. типовой договор подряда.]

    4. Качество работ
{% if quality_list %}
        4.1–4.2. Качество результата Работ должно соответствовать требованиям стандартов. Дополнительные требования:
{% for item in quality_list %}
            4.2.{{ loop.index }}. {{ item }}.
{% endfor %}
{% else %}
        4.1. Качество результата Работ должно соответствовать требованиям стандартов.
{% endif %}
{% if warranty_text %}
        4.3. {{ warranty_text }}
{% endif %}
{% if goals_list %}
        4.4. Цели использования результата:
{% for item in goals_list %}
            4.4.{{ loop.index }}. {{ item }}.
{% endfor %}
{% endif %}

    5. Ответственность сторон
        5.1. За неисполнение обязательств Стороны несут ответственность в соответствии с законодательством РФ.
{% if liab_contractor %}
        5.2. В случае несвоевременного окончания Работ Подрядчик выплачивает штраф в виде пени в размере {{ liab_contractor_pct }}% от общей стоимости Работ за каждый день просрочки.
{% endif %}
{% if liab_customer %}
        5.3. В случае нарушения сроков оплаты Заказчик выплачивает штраф в виде пени в размере {{ liab_customer_pct }}% от стоимости просроченного платежа за каждый день просрочки.
{% endif %}
        5.4–5.9. [Стандартные положения об ответственности.]

    6. Действие непреодолимой силы (Форс-мажор)
{% if force_majeure %}
        6.1–6.6. [Стандартные положения о форс-мажоре.]
{% endif %}

    7. Конфиденциальность
{% if confidentiality %}
        7.1–7.4. [Стандартные положения о конфиденциальности.]
{% endif %}

    8. Срок действия договора и условия его расторжения
        8.1–8.5. [Стандартные положения.]

    9. Разрешение споров
{% if claim_required %}
        9.1. Споры разрешаются в претензионном порядке. Срок ответа на претензию — {{ claim_days }} рабочих дней.
{% endif %}
        9.2. Подсудность: {{ court_place }}.

    10. Заключительные положения
        10.1–10.4. [Стандартные положения.]

    11. Адреса и реквизиты сторон

Заказчик: {{ customer_address }}
Подрядчик: {{ contractor_address }}

________________/{{ customer_signature }}
________________/{{ contractor_signature }}
'''.strip()
