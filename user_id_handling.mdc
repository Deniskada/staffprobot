# –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å user_id –≤ StaffProBot

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–ü–†–û–ë–õ–ï–ú–ê**: –í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–∞ `user_id`:
1. **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID** - `id` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `1`, `2`, `3`)
2. **Telegram ID** - `telegram_id` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `1220971779`, `987654321`)

**–û–®–ò–ë–ö–ê**: –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `telegram_id` –≤–º–µ—Å—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ `id` –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏—é –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
- –û—à–∏–±–∫–∞–º –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

## üéØ –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ID –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `telegram_id`:
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: `current_user.get("id")` –∏–ª–∏ `current_user.get("telegram_id")`
- **–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: `User.telegram_id == telegram_id`
- **API endpoints**: –í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å `telegram_id`
- **–°–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞—é—Ç `telegram_id`**: `ObjectService.get_objects_by_owner(telegram_id)`

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π `user_id`:
- **–°–≤—è–∑–∏ –≤ –ë–î**: `Object.owner_id`, `Contract.owner_id`, `Shift.user_id`
- **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤**: `ContractService.terminate_contract(user_id)`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**: `Object.owner_id == user_id`
- **–°–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID**: `ObjectService.update_object(object_id, data, owner_id)`

## üìã –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### 1. –í—Å–µ–≥–¥–∞ —Ä–∞–∑–ª–∏—á–∞–π —Ç–∏–ø—ã ID

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º telegram_id –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
user_id = current_user.get("id")  # –≠—Ç–æ telegram_id!
objects_query = select(Object).where(Object.owner_id == user_id)  # –û–®–ò–ë–ö–ê!

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ø–æ–ª—É—á–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID
if isinstance(current_user, dict):
    telegram_id = current_user.get("id")
    user_query = select(User).where(User.telegram_id == telegram_id)
    user_obj = await session.execute(user_query)
    user_id = user_obj.scalar_one_or_none().id  # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID
else:
    user_id = current_user.id  # –£–∂–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

**–°–û–ó–î–ê–ô** —Ñ—É–Ω–∫—Ü–∏—é `get_user_id_from_current_user` –≤ –∫–∞–∂–¥–æ–º —Ä–æ—É—Ç–µ:

```python
async def get_user_id_from_current_user(current_user, session):
    """–ü–æ–ª—É—á–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ current_user"""
    if isinstance(current_user, dict):
        # current_user - —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å –∏–∑ JWT payload
        telegram_id = current_user.get("id")
        user_query = select(User).where(User.telegram_id == telegram_id)
        user_result = await session.execute(user_query)
        user_obj = user_result.scalar_one_or_none()
        return user_obj.id if user_obj else None
    else:
        # current_user - —ç—Ç–æ –æ–±—ä–µ–∫—Ç User
        return current_user.id
```

### 3. –ü—Ä–∏–º–µ–Ω—è–π –≤–æ –≤—Å–µ—Ö —Ä–æ—É—Ç–∞—Ö

```python
async def some_route(request: Request):
    current_user = await require_owner_or_superadmin(request)
    if isinstance(current_user, RedirectResponse):
        return current_user
    
    async with get_async_session() as session:
        # –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è user_id
        user_id = await get_user_id_from_current_user(current_user, session)
        
        # –¢–µ–ø–µ—Ä—å user_id - —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
        objects_query = select(Object).where(Object.owner_id == user_id)
```

## üîç –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –û—à–∏–±–∫–∞ 1: "–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤ –∫–æ–º–±–æ–±–æ–∫—Å–µ"
**–ü—Ä–∏—á–∏–Ω–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `telegram_id` –≤–º–µ—Å—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ `id`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π `get_user_id_from_current_user`

### –û—à–∏–±–∫–∞ 2: "–°–º–µ–Ω—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è"
**–ü—Ä–∏—á–∏–Ω–∞**: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É `user_id`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `user_id` - —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID

### –û—à–∏–±–∫–∞ 3: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"
**–ü—Ä–∏—á–∏–Ω–∞**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–æ `telegram_id` –≤–º–µ—Å—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ `id`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `user_id` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `owner_id`

## üìù –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–æ—É—Ç–∞

- [ ] –ï—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `get_user_id_from_current_user`
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `await get_user_id_from_current_user(current_user, session)`
- [ ] –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `current_user.get("id")` –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `user_id`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –æ–±—ä–µ–∫—Ç–∞–º
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

## üö´ –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. ‚ùå **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π** `current_user.get("id")` –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
2. ‚ùå **–ù–ï –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π**, —á—Ç–æ `current_user` –≤—Å–µ–≥–¥–∞ –æ–±—ä–µ–∫—Ç User
3. ‚ùå **–ù–ï –∏–≥–Ω–æ—Ä–∏—Ä—É–π** —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É `id` –∏ `telegram_id`
4. ‚ùå **–ù–ï –∫–æ–ø–∏—Ä—É–π** –∫–æ–¥ –±–µ–∑ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è `user_id`

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω

```python
async def route_function(request: Request):
    # 1. –ü–æ–ª—É—á–∞–µ–º current_user
    current_user = await require_owner_or_superadmin(request)
    if isinstance(current_user, RedirectResponse):
        return current_user
    
    # 2. –ü–æ–ª—É—á–∞–µ–º user_role
    user_role = current_user.get("role") if isinstance(current_user, dict) else current_user.role
    
    # 3. –†–∞–±–æ—Ç–∞–µ–º —Å –ë–î
    async with get_async_session() as session:
        # 4. –í–°–ï–ì–î–ê –ø–æ–ª—É—á–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π user_id
        user_id = await get_user_id_from_current_user(current_user, session)
        
        # 5. –ò—Å–ø–æ–ª—å–∑—É–µ–º user_id –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
        objects_query = select(Object).where(Object.owner_id == user_id)
        # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

## üîÑ –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å `user_id`:

1. **–ù–∞–π–¥–∏** –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `current_user.get("id")`
2. **–ó–∞–º–µ–Ω–∏** –Ω–∞ `get_user_id_from_current_user(current_user, session)`
3. **–ü—Ä–æ–≤–µ—Ä—å** –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î —Å `user_id`
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π** —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
5. **–û–±–Ω–æ–≤–∏** —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–∏ –Ω–æ–≤—ã—Ö –Ω–∞—Ö–æ–¥–∫–∞—Ö

---

**–ü–û–ú–ù–ò**: –≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ 90% —Å–ª—É—á–∞–µ–≤ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π, –∫–∞–∫–æ–π —Ç–∏–ø ID —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å!