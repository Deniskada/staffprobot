# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∑–∞–¥–∞—á —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤

**–î–∞—Ç–∞**: 2025-10-16  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–¥–∞—á–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤ —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

1. **JSONB –ø–æ–ª–µ** `time_slots.shift_tasks` ‚Äî —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (–Ω–∞–ø—Ä—è–º—É—é –≤ JSON)
2. **–¢–∞–±–ª–∏—Ü–∞** `timeslot_task_templates` ‚Äî –Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–± (—á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (`/owner/timeslots/{id}/edit`), –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `timeslot_task_templates`. –ù–æ **–±–æ—Ç** –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∑–∞–¥–∞—á —á–∏—Ç–∞–ª **—Ç–æ–ª—å–∫–æ** JSONB –ø–æ–ª–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∑–∞–¥–∞—á–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.

### –ö–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–º–µ–Ω–∞ –Ω–∞ —Ç–∞–π–º-—Å–ª–æ—Ç
2. –ü–æ–∑–∂–µ –≤–ª–∞–¥–µ–ª–µ—Ü –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á–∏ –≤ —Ç–∞–π–º-—Å–ª–æ—Ç —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
3. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É ‚Üí **–∑–∞–¥–∞—á–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è** ‚ùå
4. –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã ‚Üí **–∑–∞–¥–∞—á–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è** ‚ùå

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∑–∞ –∑–∞–¥–∞—á–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

**–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è**: 2025-10-16 (–Ω–æ—á—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–∞ –ø—Ä–æ–¥–µ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –∫–æ–º–º–∏—Ç–∞ `c05a40e` —Å—Ç–∞–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ `task_bonus` –∏ `task_penalty`, —Ö–æ—Ç—è `shift_base` –∏ `late_start` —à—Ç—Ä–∞—Ñ—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
1. **–ó–∞–±–ª—É–∂–¥–µ–Ω–∏–µ**: –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ issue –≤ –±–æ—Ç–µ (completed_tasks –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)
2. **–†–µ–∞–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞**: –í `core/celery/tasks/adjustment_tasks.py` —Å—Ç—Ä–æ–∫–∞ 181 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π** `session.execute()` –≤–º–µ—Å—Ç–æ `await session.execute()`:
   ```python
   # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥ –≤ async Celery
   template_result = session.execute(template_query)
   ```
   –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–µ –∏–ª–∏ None –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `timeslot_task_templates`.
3. **–°–∏–º–ø—Ç–æ–º—ã**:
   - `shift_tasks` –æ—Å—Ç–∞–≤–∞–ª—Å—è –ø—É—Å—Ç—ã–º `[]`
   - –£—Å–ª–æ–≤–∏–µ `if shift_tasks:` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å (—Å—Ç—Ä–æ–∫–∞ 207)
   - –¶–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á (—Å—Ç—Ä–æ–∫–∏ 235-355) –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ `task_bonus`/`task_penalty` –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å
   - –ë–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ –∏ —à—Ç—Ä–∞—Ñ—ã –∑–∞ –æ–ø–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–ª–∏ (—Ç.–∫. –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–æ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–º–º–∏—Ç**: `c05a40e` "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è..."
- –ò–∑–º–µ–Ω–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á —Ç–∞–π–º-—Å–ª–æ—Ç–∞ —Å `shift.time_slot.shift_tasks` (JSONB) –Ω–∞ `TimeslotTaskTemplate` (—Ç–∞–±–ª–∏—Ü–∞)
- –ó–∞–±—ã—Ç `await` –ø–µ—Ä–µ–¥ `session.execute()`

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ (–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)

**–§–∞–π–ª—ã:**
- `apps/bot/handlers_div/shift_handlers.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `_load_timeslot_tasks()`, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `timeslot_task_templates`
2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ `_handle_close_shift` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `_load_timeslot_tasks()`
3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ `_handle_my_tasks` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `_load_timeslot_tasks()`
4. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚úÖ

### –≠—Ç–∞–ø 2: –£–¥–∞–ª–µ–Ω–∏–µ JSONB –ø–æ–ª—è (—á–∏—Å—Ç–æ—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)

**–§–∞–π–ª—ã:**
- `domain/entities/time_slot.py` ‚Äî —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `shift_tasks` (JSONB)
- `apps/bot/handlers_div/shift_handlers.py` ‚Äî —É–ø—Ä–æ—â–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_load_timeslot_tasks()`
- `migrations/versions/47854ebf33dc_remove_shift_tasks_jsonb_from_timeslots.py` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
```bash
# Dev
docker compose -f docker-compose.dev.yml exec web alembic upgrade head

# Prod
ssh staffprobot@staffprobot.ru 'cd /opt/staffprobot && docker compose -f docker-compose.prod.yml exec web alembic upgrade head'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞ `timeslot_task_templates` ‚úÖ

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –•—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤

**–¢–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞ `timeslot_task_templates`:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | Integer | PK |
| `timeslot_id` | Integer | FK ‚Üí time_slots.id |
| `task_text` | String | –¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ |
| `is_mandatory` | Boolean | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ |
| `deduction_amount` | Integer | –®—Ç—Ä–∞—Ñ/–ø—Ä–µ–º–∏—è (‚ÇΩ) |
| `display_order` | Integer | –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è |
| `created_by_id` | Integer | FK ‚Üí users.id |

### –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –≤ –±–æ—Ç–µ

```python
async def _load_timeslot_tasks(session: AsyncSession, timeslot: TimeSlot) -> list:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã timeslot_task_templates."""
    template_query = select(TimeslotTaskTemplate).where(
        TimeslotTaskTemplate.timeslot_id == timeslot.id
    ).order_by(TimeslotTaskTemplate.display_order)
    
    template_result = await session.execute(template_query)
    templates = template_result.scalars().all()
    
    return [
        {
            'text': template.task_text,
            'is_mandatory': template.is_mandatory or False,
            'deduction_amount': template.deduction_amount or 0,
            'source': 'timeslot'
        }
        for template in templates
    ]
```

### –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–µ–±

**–†–æ—É—Ç:** `/owner/timeslots/{id}/edit` (POST)  
**–§–∞–π–ª:** `apps/web/routes/owner_timeslots.py`

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å `task_texts[]` –∏–∑ —Ñ–æ—Ä–º—ã
2. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ `TimeslotTaskTemplate` –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ `timeslot_id`
3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ `TimeslotTaskTemplate` –∑–∞–ø–∏—Å–∏
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (JSONB + —Ç–∞–±–ª–∏—Ü–∞)
- ‚ùå –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–±–æ—Ç –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ JSONB)
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–¥–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã)
- ‚ùå –ó–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ –≤–µ–± –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤ –±–æ—Ç–µ

### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

- ‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞)
- ‚úÖ –ë–æ—Ç –∏ –≤–µ–± –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- ‚úÖ –ó–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ –≤–µ–± —Å—Ä–∞–∑—É –≤–∏–¥–Ω—ã –≤ –±–æ—Ç–µ
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –≤–µ–± –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–º–µ–Ω—ã

1. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–º–µ–Ω—É –Ω–∞ —Ç–∞–π–º-—Å–ª–æ—Ç ‚úÖ
2. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ `/owner/timeslots/{id}/edit` ‚úÖ
3. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É –≤ –±–æ—Ç–µ ‚Üí –∑–∞–¥–∞—á–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è ‚úÖ
4. –ù–∞–∂–∞—Ç—å "–ú–æ–∏ –∑–∞–¥–∞—á–∏" ‚Üí –∑–∞–¥–∞—á–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è ‚úÖ
5. –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É ‚Üí –∑–∞–¥–∞—á–∏ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á

1. –û–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –∑–∞–¥–∞—á–∏ –≤ `object.shift_tasks` (JSONB) ‚úÖ
2. –¢–∞–π–º-—Å–ª–æ—Ç –∏–º–µ–µ—Ç –∑–∞–¥–∞—á–∏ –≤ `timeslot_task_templates` ‚úÖ
3. `timeslot.ignore_object_tasks = False` ‚úÖ
4. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É ‚Üí –æ–±–µ –≥—Ä—É–ø–ø—ã –∑–∞–¥–∞—á –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á –æ–±—ä–µ–∫—Ç–∞

1. –û–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –∑–∞–¥–∞—á–∏ –≤ `object.shift_tasks` ‚úÖ
2. –¢–∞–π–º-—Å–ª–æ—Ç –∏–º–µ–µ—Ç –∑–∞–¥–∞—á–∏ –≤ `timeslot_task_templates` ‚úÖ
3. `timeslot.ignore_object_tasks = True` ‚úÖ
4. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É ‚Üí —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ ‚úÖ

## üìù –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–æ—É—Ç `/owner/timeslots/{id}/edit` (–¥–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `select`)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç —Å—Ç–∞–≤–∫–∏ (`int(float())` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ "500.0")
- ‚úÖ –£–¥–∞–ª—ë–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç `ShiftTaskService`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `doc/vision_v1/entities/timeslots.md`

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –∑–∞ –∑–∞–¥–∞—á–∏ (2025-10-16, –ø–æ–∑–¥–Ω–æ)

**–§–∞–π–ª**: `core/celery/tasks/adjustment_tasks.py` —Å—Ç—Ä–æ–∫–∞ 181

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `session.execute()` –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π Celery –∑–∞–¥–∞—á–µ.

**Fix**: –î–æ–±–∞–≤–ª–µ–Ω `await`:
```python
# –î–û (‚ùå)
template_result = session.execute(template_query)

# –ü–û–°–õ–ï (‚úÖ)
template_result = await session.execute(template_query)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: Celery –∑–∞–¥–∞—á–∞ `process_closed_shifts_adjustments` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `timeslot_task_templates` –∏ —Å–æ–∑–¥–∞—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ `task_bonus`/`task_penalty`.

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ prod**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ fix –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∑–∞ –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã.

## üöÄ –î–µ–ø–ª–æ–π

### –ü–æ—Ä—è–¥–æ–∫ –¥–µ–ø–ª–æ—è –Ω–∞ prod

1. –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:
```bash
git add apps/bot/handlers_div/shift_handlers.py \
        domain/entities/time_slot.py \
        migrations/versions/47854ebf33dc_remove_shift_tasks_jsonb_from_timeslots.py \
        doc/TIMESLOT_TASKS_REFACTORING.md

git commit -m "–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥: —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤"
git push origin main
```

2. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –Ω–∞ –ø—Ä–æ–¥–µ:
```bash
ssh staffprobot@staffprobot.ru 'cd /opt/staffprobot && git pull origin main'
```

3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
ssh staffprobot@staffprobot.ru 'cd /opt/staffprobot && docker compose -f docker-compose.prod.yml exec web alembic upgrade head'
```

4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:
```bash
ssh staffprobot@staffprobot.ru 'cd /opt/staffprobot && docker compose -f docker-compose.prod.yml restart web bot'
```

5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
```bash
ssh staffprobot@staffprobot.ru 'cd /opt/staffprobot && docker compose -f docker-compose.prod.yml logs bot --tail 50'
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ JSONB –Ω–µ –º–∏–≥—Ä–∏—Ä—É—é—Ç—Å—è** ‚Äî –æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
2. **Downgrade –≤–æ–∑–º–æ–∂–µ–Ω** ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –∫–æ–ª–æ–Ω–∫—É, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤–µ—Ä–Ω—É—Ç—Å—è
3. **Object.shift_tasks –æ—Å—Ç–∞—ë—Ç—Å—è** ‚Äî —ç—Ç–æ –∑–∞–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞ (–Ω–µ —Ç–∞–π–º-—Å–ª–æ—Ç–∞), –æ–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ JSONB

## üîó –°—Å—ã–ª–∫–∏

- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –≤–∏–¥–µ–Ω–∏–µ:** `doc/vision.md`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∑–∞–¥–∞—á–∞–º:** `doc/vision_v1/entities/shift_task.md`
- **–†–æ—É—Ç—ã —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤:** `doc/vision_v1/entities/timeslots.md`
- **–ë–æ—Ç-–ª–æ–≥–∏–∫–∞ —Å–º–µ–Ω:** `doc/bot_shift_logic.md`

