# –ê–Ω–∞–ª–∏–∑: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è

**–î–∞—Ç–∞:** 29.10.2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –≤ –±–æ—Ç–µ, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ, –Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ (–ø—Ä–µ–º–∏—è +100‚ÇΩ) –Ω–µ —Å–æ–∑–¥–∞–Ω–∞  
**–°–º–µ–Ω–∞:** 307

---

## üîç –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î

### –°–º–µ–Ω–∞ 307
```sql
id: 307
user_id: 14
object_id: 9
status: completed
end_time: 2025-10-29 15:37:42 UTC (18:37 MSK)
total_payment: 138.00
```

### –ó–∞–¥–∞—á–∞ (TaskEntryV2)
```sql
id: 3
shift_id: 307
template_id: 6 (–í–ª–∞–∂–Ω–∞—è —É–±–æ—Ä–∫–∞)
employee_id: 14
is_completed: FALSE  ‚ùå –ù–ï –ü–û–ú–ï–ß–ï–ù–ê –ö–ê–ö –í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø!
completed_at: NULL
completion_media: NULL
```

### –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ (PayrollAdjustment)
```sql
id: 428 | shift_base | +138.00 | –ë–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞
id: 429 | late_start | -6.00   | –®—Ç—Ä–∞—Ñ –∑–∞ –æ–ø–æ–∑–¥–∞–Ω–∏–µ

–ù–ï–¢ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ task_bonus –Ω–∞ +100‚ÇΩ ‚ùå
```

---

## üéØ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–ó–∞–¥–∞—á–∞ –ù–ï –±—ã–ª–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –≤ –ë–î!**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∏–∫–µ –±–æ—Ç–∞:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –≥–∞–ª–æ—á–∫—É –Ω–∞ –∑–∞–¥–∞—á–µ
- –ë–æ—Ç –∑–∞–ø—Ä–æ—Å–∏–ª —Ñ–æ—Ç–æ (—Ç.–∫. `requires_media=True`)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ `_handle_received_task_v2_media` –ù–ï —Å—Ä–∞–±–æ—Ç–∞–ª**

---

## üîç –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π

```
15:36 UTC (18:36 MSK) - –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω ‚úÖ
15:37 UTC (18:37 MSK) - –°–º–µ–Ω–∞ 307 –∑–∞–∫—Ä—ã—Ç–∞ ‚ùå
                        –ó–∞–¥–∞—á–∞ –ù–ï –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è
```

**–í—ã–≤–æ–¥:** –°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏–ª–∏ –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞!

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –ë–æ—Ç –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª —Å–º–µ–Ω—É –ù–ï —á–µ—Ä–µ–∑ –±–æ—Ç (—á–µ—Ä–µ–∑ –≤–µ–±?)

---

## üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
SELECT * FROM shifts WHERE id = 307;
-- end_time: 2025-10-29 15:37:42.697018
-- –°–º–µ–Ω–∞ –ë–´–õ–ê –∑–∞–∫—Ä—ã—Ç–∞ (–µ—Å—Ç—å end_time)
```

**–ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ –≤–µ–±:**
- –ó–∞–¥–∞—á–∏ –≤ –ë–î –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- –ù—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–µ–±-—Ä–æ—É—Ç–æ–º –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ –±–æ—Ç —Å–æ –°–¢–ê–†–´–ú –∫–æ–¥–æ–º
**–í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞:**
- –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω: 15:36 UTC
- –°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞: 15:37 UTC (—á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É!)

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è!  
–ë–æ—Ç –µ—â—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—Ç–∞—Ä—ã–π –∫–æ–¥ (–¥–æ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–≥–æ)

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–¥–∏–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**
```python
# apps/bot/main.py –∏–ª–∏ handlers —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å MessageHandler –¥–ª—è —Ñ–æ—Ç–æ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º TASK_V2_MEDIA
```

---

## üí° –û—Ç–∫—É–¥–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞?

### –í–∞—Ä–∏–∞–Ω—Ç A: –ü—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –∑–∞–¥–∞—á–∏ –≤ –±–æ—Ç–µ (–ù–ï–ú–ï–î–õ–ï–ù–ù–û)
**–ì–¥–µ:**
- `apps/bot/handlers_div/shift_handlers.py:_handle_complete_task_v2`
- `apps/bot/handlers_div/shift_handlers.py:_handle_received_task_v2_media`

**–õ–æ–≥–∏–∫–∞:**
```python
# –ü–æ—Å–ª–µ is_completed = True
# –°–æ–∑–¥–∞—Ç—å PayrollAdjustment —Å—Ä–∞–∑—É
adjustment = PayrollAdjustment(
    employee_id=entry.employee_id,
    shift_id=entry.shift_id,
    task_entry_v2_id=entry.id,
    adjustment_type="task_bonus",
    amount=template.default_bonus_amount
)
```

**–°—Ç–∞—Ç—É—Å:** ‚ùå –¢–∞–∫–æ–≥–æ –∫–æ–¥–∞ –ù–ï–¢ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –±–æ—Ç–∞!

### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ Celery (–û–¢–õ–û–ñ–ï–ù–ù–û)
**–ì–¥–µ:**
- `core/celery/tasks/task_bonuses.py:process_task_bonuses_celery`
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

**–õ–æ–≥–∏–∫–∞:**
```python
# –ù–∞–π—Ç–∏ is_completed = True
# –°–æ–∑–¥–∞—Ç—å PayrollAdjustment
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ–¥ –ï–°–¢–¨, –Ω–æ celery worker –ù–ï –∑–∞–ø—É—â–µ–Ω –Ω–∞ dev!

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Celery worker –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ dev ‚ùå
```bash
$ docker compose -f docker-compose.dev.yml ps celery-worker
no such service: celery-worker
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**
- `process_task_bonuses_celery` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
- –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∑–∞ –∑–∞–¥–∞—á–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ó–∞–¥–∞—á–∞ –Ω–µ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è ‚ùå
```sql
is_completed: FALSE
completed_at: NULL
completion_media: NULL
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**
- –î–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å celery - –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ù–ï —Å–æ–∑–¥–∞—Å—Ç—Å—è (is_completed = False)

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –≤ –±–æ—Ç–µ ‚ö†Ô∏è
**–°–µ–π—á–∞—Å:**
- –ó–∞–¥–∞—á–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
- –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ celery (–∫–∞–∂–¥—ã–µ 10 –º–∏–Ω)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞ dev –Ω–µ—Ç celery ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è!

---

## üí° –†–µ—à–µ–Ω–∏—è

### ‚úÖ –†–µ—à–µ–Ω–∏–µ 1 (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –¥–ª—è dev): –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏

```sql
-- –ü–æ–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é (–µ—Å–ª–∏ –Ω–µ –ø–æ–º–µ—á–µ–Ω–∞)
UPDATE task_entries_v2 
SET is_completed = true,
    completed_at = NOW()
WHERE id = 3;

-- –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –≤—Ä—É—á–Ω—É—é
INSERT INTO payroll_adjustments (
    shift_id, employee_id, object_id, task_entry_v2_id,
    adjustment_type, amount, description, 
    created_by, is_applied
) VALUES (
    307, 14, 9, 3,
    'task_bonus', 100.00, '–ó–∞–¥–∞—á–∞: –í–ª–∞–∂–Ω–∞—è —É–±–æ—Ä–∫–∞',
    1, false
);
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ 2 (–¥–ª—è –ø—Ä–æ–¥–∞): –ó–∞–ø—É—Å—Ç–∏—Ç—å celery worker

**–ù–∞ –ø—Ä–æ–¥–µ celery –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å:**
```bash
docker compose -f docker-compose.prod.yml ps
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å: celery-worker, celery-beat
```

**Celery –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏** –¥–ª—è –≤—Å–µ—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç.

### ‚úÖ –†–µ—à–µ–Ω–∏–µ 3 (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ): –°–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É —Å—Ä–∞–∑—É –≤ –±–æ—Ç–µ

**–î–æ–±–∞–≤–∏—Ç—å –≤ `_handle_complete_task_v2` –∏ `_handle_received_task_v2_media`:**
```python
# –ü–æ—Å–ª–µ entry.is_completed = True –∏ commit
if template.default_bonus_amount:
    # –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É —Å—Ä–∞–∑—É
    adjustment = PayrollAdjustment(...)
    session.add(adjustment)
    await session.commit()
```

**–ü–ª—é—Å—ã:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç celery

**–ú–∏–Ω—É—Å—ã:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ (celery + –±–æ—Ç)

---

## üìã –ü–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω—ã 307

**–®–∞–≥ 1:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—ã–ª–∞ –ª–∏ —Å–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ –±–æ—Ç –∏–ª–∏ –≤–µ–±
```bash
docker compose -f docker-compose.dev.yml logs web --since 30m | grep "close.*shift.*307"
```

**–®–∞–≥ 2:** –í—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É (–¥–ª—è —Ç–µ—Å—Ç–∞)
```sql
-- –°–º. –†–µ—à–µ–Ω–∏–µ 1 –≤—ã—à–µ
```

**–®–∞–≥ 3:** –û—Ç–∫—Ä—ã—Ç—å –ù–û–í–£–Æ —Å–º–µ–Ω—É –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å flow —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º –±–æ—Ç–∞

---

## ‚úÖ –î–ª—è –Ω–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É 308 –Ω–∞ –æ–±—ä–µ–∫—Ç–µ 9 (–µ—Å—Ç—å –ø–ª–∞–Ω –∑–∞–¥–∞—á)
2. –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `is_completed = TRUE` –≤ –ë–î
5. –í—Ä—É—á–Ω—É—é –≤—ã–∑–≤–∞—Ç—å celery –∑–∞–¥–∞—á—É `process_completed_tasks_bonuses`
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏

---

**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—à–µ–Ω–∏–µ - –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –∏–ª–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–æ–≤–æ–π —Å–º–µ–Ω–µ?  
**–ê–≤—Ç–æ—Ä:** AI Assistant


