# –§–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã: "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ" –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–≤–µ—Ä—Å–∏—è 2)

**–î–∞—Ç–∞:** 2025-11-01  
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –í—á–µ—Ä–∞ (1.11 –≤ 23:58 MSK) –¥–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–ª "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω, 26 –º–∏–Ω—É—Ç, 29" –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤, —Ö–æ—Ç—è –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–±—ä–µ–∫—Ç—ã –∑–∞–∫—Ä—ã–ª–∏—Å—å –≤–æ –≤—Ä–µ–º—è +10 –º–∏–Ω—É—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫—Ä—ã—Ç–∏—è (—Ç.–µ. –ø–æ–∑–∂–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ).

## üîç –ö–õ–Æ–ß–ï–í–ê–Ø –ù–ê–•–û–î–ö–ê

### –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏ –≤—ã–±–æ—Ä–∞ `last_shift`

**–°—Ç—Ä–æ–∫–∞ 287:**
```python
last_shift = max(shifts_today, key=lambda s: s.end_time or s.start_time)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `s.end_time` = `None`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `s.start_time` –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è!

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –û–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
2. –°–º–µ–Ω–∞ A: `start_time` = 09:00, `end_time` = 21:30 (–∑–∞–∫—Ä—ã–ª–∞—Å—å –Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ)
3. –°–º–µ–Ω–∞ B: `start_time` = 10:00, `end_time` = 22:10 (–∑–∞–∫—Ä—ã–ª–∞—Å—å –Ω–∞ 10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ)
4. –°–º–µ–Ω–∞ C: `start_time` = 11:00, `end_time` = `None` (–∞–∫—Ç–∏–≤–Ω–∞—è –∏–ª–∏ –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞—è)

**–†–∞—Å—á—ë—Ç `last_shift`:**
```python
max([21:30, 22:10, 11:00], key=lambda s: s.end_time or s.start_time)
```

- –°–º–µ–Ω–∞ A: `end_time = 21:30` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `21:30`
- –°–º–µ–Ω–∞ B: `end_time = 22:10` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `22:10`
- –°–º–µ–Ω–∞ C: `end_time = None` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `start_time = 11:00`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `last_shift = –°–º–µ–Ω–∞ B` (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π `end_time = 22:10`) ‚úÖ

**–ù–û:** –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞ —Å `end_time = None` –∏ `start_time` –ø–æ–∑–∂–µ, —á–µ–º `end_time` –¥—Ä—É–≥–∏—Ö —Å–º–µ–Ω, —Ç–æ `last_shift` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: `end_time = 21:30`
- –°–º–µ–Ω–∞ B: `end_time = 22:10`
- –°–º–µ–Ω–∞ C: `end_time = None`, `start_time = 23:00` (–∞–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞)

**–†–∞—Å—á—ë—Ç:**
- `max([21:30, 22:10, 23:00], key=lambda s: s.end_time or s.start_time)` = `23:00`

**–ù–û:** –£—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
```python
if last_shift.end_time and last_shift.status == 'completed' and not active_shifts_on_object:
```

–ï—Å–ª–∏ `last_shift.end_time = None`, —Ç–æ —É—Å–ª–æ–≤–∏–µ **–Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è**, –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è **–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—Å—è**!

**–í–´–í–û–î:** –≠—Ç–æ –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ".

### –ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `timezone_helper.local_tz` (MSK) –≤–º–µ—Å—Ç–æ `obj.timezone`.

**–°—Ç—Ä–æ–∫–∞ 334:**
```python
expected_close = timezone_helper.local_tz.localize(naive_expected_close)
```

**–°—Ç—Ä–æ–∫–∞ 335:**
```python
actual_close_local = timezone_helper.utc_to_local(last_shift.end_time)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–±–∞ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ MSK (`default_timezone`), –¥–∞–∂–µ –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –≤ –¥—Ä—É–≥–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ!

### –°–¶–ï–ù–ê–†–ò–ô –î–õ–Ø –û–ë–™–ï–ö–¢–ê –í MSK:

**–û–±—ä–µ–∫—Ç –≤ MSK (UTC+3):**
- `obj.closing_time` = 22:00
- `obj.timezone` = "Europe/Moscow"
- –û–±—ä–µ–∫—Ç –∑–∞–∫—Ä—ã–ª—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤ 22:10 MSK (+10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ)

**–†–∞—Å—á—ë—Ç:**
1. `naive_expected_close` = `datetime.combine(2025-11-01, 22:00)` = `2025-11-01 22:00` (naive)
2. `expected_close` = `timezone_helper.local_tz.localize(2025-11-01 22:00)` = `2025-11-01 22:00+03:00` (MSK) ‚úÖ
3. `last_shift.end_time` –≤ –ë–î (UTC): `2025-11-01 19:10 UTC` (22:10 MSK = 19:10 UTC)
4. `actual_close_local` = `timezone_helper.utc_to_local(2025-11-01 19:10 UTC)` = `2025-11-01 22:10+03:00` (MSK) ‚úÖ
5. `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç` ‚ùå

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏—è:**
```python
if early_minutes > 5:  # -10 > 5? –ù–ï–¢
```

**–í–´–í–û–î:** –£—Å–ª–æ–≤–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ —Å—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç `'closed'`, –∞ –Ω–µ `'early_closing'`.

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"!

### –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê: –í—ã–±–æ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–º–µ–Ω—ã –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –û–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –∏ –æ–¥–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –∞ –¥—Ä—É–≥–∞—è –ø–æ–∑–∂–µ.

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 21:30 MSK (–Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ)
- –°–º–µ–Ω–∞ B: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 22:10 MSK (–Ω–∞ 10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ)

**–í—ã–±–æ—Ä `last_shift`:**
```python
last_shift = max(shifts_today, key=lambda s: s.end_time or s.start_time)
```

- `last_shift` = –°–º–µ–Ω–∞ B (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π `end_time = 22:10`) ‚úÖ

**–ù–û:** –ï—Å–ª–∏ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã B:
- `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç`
- –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–ù–ï —Å—Ä–∞–±–æ—Ç–∞–µ—Ç**

**–í–û–ó–ú–û–ñ–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï:** –ï—Å–ª–∏ `max()` –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É A (21:30) –≤–º–µ—Å—Ç–æ —Å–º–µ–Ω—ã B (22:10), —Ç–æ:
- `early_minutes = (22:00 - 21:30) = 30 –º–∏–Ω—É—Ç` ‚úÖ
- –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–î–ê** ‚Üí —Å—Ç–∞—Ç—É—Å "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"

**–ù–û:** –ü–æ—á–µ–º—É `max()` –≤—ã–±—Ä–∞–ª –±—ã —Å–º–µ–Ω—É A (21:30), –µ—Å–ª–∏ —Å–º–µ–Ω–∞ B (22:10) –∏–º–µ–µ—Ç –±–æ–ª—å—à–∏–π `end_time`?

### –ì–ò–ü–û–¢–ï–ó–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º `end_time` –≤ UTC

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ `end_time` –∏–¥—ë—Ç –≤ UTC, –∞ –Ω–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –æ–±—ä–µ–∫—Ç–∞, —Ç–æ `max()` –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–º–µ–Ω—É.

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: `end_time` –≤ –ë–î = `2025-11-01 18:30 UTC` (21:30 MSK)
- –°–º–µ–Ω–∞ B: `end_time` –≤ –ë–î = `2025-11-01 19:10 UTC` (22:10 MSK)

**–ï—Å–ª–∏ `max()` —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `end_time` –≤ UTC:**
- `max([18:30 UTC, 19:10 UTC])` = –°–º–µ–Ω–∞ B (19:10 UTC) ‚úÖ

**–ù–û:** –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –≤—ã–±–æ—Ä–æ–º `end_time`, —Ç–æ `max()` –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Å–º–µ–Ω—É A.

### –§–ò–ù–ê–õ–¨–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö —Å —Ä–∞–∑–Ω—ã–º–∏ `end_time`

**–ö–õ–Æ–ß–ï–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –∏ –æ–¥–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ (21:30), –∞ –¥—Ä—É–≥–∞—è –ø–æ–∑–∂–µ (22:10), —Ç–æ –≤—ã–±–æ—Ä `last_shift` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º.

**–ù–û:** –õ–æ–≥–∏–∫–∞ `max(shifts_today, key=lambda s: s.end_time or s.start_time)` –¥–æ–ª–∂–Ω–∞ –≤—ã–±—Ä–∞—Ç—å —Å–º–µ–Ω—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `end_time`.

**–í–û–ó–ú–û–ñ–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï:** –ï—Å–ª–∏ `last_shift` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º –≤ UTC), —Ç–æ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ.

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 21:30 MSK (–Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ) ‚Üí `end_time = 18:30 UTC`
- –°–º–µ–Ω–∞ B: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 22:10 MSK (–Ω–∞ 10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ) ‚Üí `end_time = 19:10 UTC`

**–ï—Å–ª–∏ `max()` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É B (19:10 UTC):**
- –†–∞—Å—á—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã B: `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç` ‚ùå
- –£—Å–ª–æ–≤–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç

**–ù–û:** –ï—Å–ª–∏ `max()` **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ** –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É A (18:30 UTC), —Ç–æ:
- –†–∞—Å—á—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã A: `early_minutes = (22:00 - 21:30) = 30 –º–∏–Ω—É—Ç` ‚úÖ
- –£—Å–ª–æ–≤–∏–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí —Å—Ç–∞—Ç—É—Å "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"

**–í–û–ó–ú–û–ñ–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:** –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º `end_time` –≤ UTC, –µ—Å–ª–∏ —Å–º–µ–Ω—ã –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π.

## üìä –ò–¢–û–ì–û–í–´–ô –í–´–í–û–î

**–ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `timezone_helper.local_tz` (MSK) –≤–º–µ—Å—Ç–æ `obj.timezone` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ `expected_close` –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ `actual_close_local` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö.

**–í–¢–û–†–ò–ß–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö, –µ—Å–ª–∏ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–º–µ–Ω–∞ –ø–æ `end_time`).

**–°–¶–ï–ù–ê–†–ò–ô –í–û–ó–ù–ò–ö–ù–û–í–ï–ù–ò–Ø –ë–ê–ì–ê:**
1. –û–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
2. –û–¥–Ω–∞ —Å–º–µ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 21:30 (–Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ)
3. –î—Ä—É–≥–∞—è —Å–º–µ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 22:10 (–Ω–∞ 10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ)
4. **–ù–û:** –ï—Å–ª–∏ `last_shift` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏), —Ç–æ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ (21:30)
5. `early_minutes = (22:00 - 21:30) = 30 –º–∏–Ω—É—Ç` ‚úÖ
6. –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–î–ê** ‚Üí —Å—Ç–∞—Ç—É—Å "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"

**–ù–û:** –≠—Ç–æ –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É **–í–°–ï** –æ–±—ä–µ–∫—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ"!

**–í–û–ó–ú–û–ñ–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï:** –ï—Å–ª–∏ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –∏–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏, —Ç–æ –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∞—Å—á—ë—Ç –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫—Ä—ã–ª–∏—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ.

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –ò–î–ï–ù–¢–ò–§–ò–¶–ò–†–û–í–ê–ù–ê (–ù–ï–°–ö–û–õ–¨–ö–û –ì–ò–ü–û–¢–ï–ó)**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `obj.timezone` –≤–º–µ—Å—Ç–æ `timezone_helper.local_tz` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ `expected_close` –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ `actual_close_local`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö
3. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏: –≤—ã–≤–µ—Å—Ç–∏ `expected_close`, `actual_close_local`, `early_minutes` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞

