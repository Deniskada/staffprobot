# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã: "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ" –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ - –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–î–∞—Ç–∞:** 2025-11-01  
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –í—á–µ—Ä–∞ (1.11 –≤ 23:58 MSK) –¥–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–ª "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω, 26 –º–∏–Ω—É—Ç, 29" –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤, —Ö–æ—Ç—è –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–±—ä–µ–∫—Ç—ã –∑–∞–∫—Ä—ã–ª–∏—Å—å –≤–æ –≤—Ä–µ–º—è +10 –º–∏–Ω—É—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫—Ä—ã—Ç–∏—è (—Ç.–µ. –ø–æ–∑–∂–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ).

## üîç –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

### –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏ –≤—ã–±–æ—Ä–∞ `last_shift`

**–°—Ç—Ä–æ–∫–∞ 287:**
```python
last_shift = max(shifts_today, key=lambda s: s.end_time or s.start_time)
```

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `s.end_time or s.start_time` –≤ `key` —Ñ—É–Ω–∫—Ü–∏–∏!

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ Python:**
- –ï—Å–ª–∏ `s.end_time = None`, —Ç–æ `s.end_time or s.start_time` –≤–µ—Ä–Ω—ë—Ç `s.start_time`
- –ï—Å–ª–∏ `s.end_time != None`, —Ç–æ `s.end_time or s.start_time` –≤–µ—Ä–Ω—ë—Ç `s.end_time`

**–ù–û:** –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ `datetime` –æ–±—ä–µ–∫—Ç–æ–≤ —Å `None` –≤ `max()` —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ!

**–ü—Ä–∏–º–µ—Ä:**
```python
shifts = [
    Shift(end_time=datetime(2025, 11, 1, 21, 30)),  # 21:30
    Shift(end_time=datetime(2025, 11, 1, 22, 10)),  # 22:10
    Shift(end_time=None, start_time=datetime(2025, 11, 1, 9, 0))  # 09:00
]

max(shifts, key=lambda s: s.end_time or s.start_time)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `s.end_time = None`, —Ç–æ `key` –≤–µ—Ä–Ω—ë—Ç `s.start_time` (09:00), —á—Ç–æ –º–µ–Ω—å—à–µ, —á–µ–º `s.end_time` –¥—Ä—É–≥–∏—Ö —Å–º–µ–Ω (21:30, 22:10).

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `max()` –≤—ã–±–µ—Ä–µ—Ç —Å–º–µ–Ω—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `end_time` (22:10) ‚úÖ

**–ù–û:** –ï—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–¥—ë—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å timezone –≤ `end_time`), —Ç–æ `max()` –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–º–µ–Ω—É.

### –ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `timezone_helper.local_tz` (MSK) –≤–º–µ—Å—Ç–æ `obj.timezone` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ `expected_close` –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ `actual_close_local`.

**–°—Ç—Ä–æ–∫–∞ 334:**
```python
expected_close = timezone_helper.local_tz.localize(naive_expected_close)
```

**–°—Ç—Ä–æ–∫–∞ 335:**
```python
actual_close_local = timezone_helper.utc_to_local(last_shift.end_time)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–±–∞ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ MSK (`default_timezone = "Europe/Moscow"`), –¥–∞–∂–µ –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –≤ –¥—Ä—É–≥–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ!

### –°–¶–ï–ù–ê–†–ò–ô –î–õ–Ø –û–ë–™–ï–ö–¢–ê –í MSK:

**–û–±—ä–µ–∫—Ç –≤ MSK (UTC+3):**
- `obj.closing_time` = 22:00
- `obj.timezone` = "Europe/Moscow"
- –û–±—ä–µ–∫—Ç –∑–∞–∫—Ä—ã–ª—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤ 22:10 MSK (+10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ)

**–†–∞—Å—á—ë—Ç:**
1. `naive_expected_close` = `datetime.combine(2025-11-01, 22:00)` = `2025-11-01 22:00` (naive)
2. `expected_close` = `timezone_helper.local_tz.localize(2025-11-01 22:00)` = `2025-11-01 22:00+03:00` (MSK) ‚úÖ
3. `last_shift.end_time` –≤ –ë–î (UTC): `2025-11-01 19:10 UTC` (22:10 MSK = 19:10 UTC)
4. `actual_close_local` = `timezone_helper.utc_to_local(2025-11-01 19:10 UTC)` = `2025-11-01 22:10+03:00` (MSK) ‚úÖ
5. `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç` ‚ùå

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏—è:**
```python
if early_minutes > 5:  # -10 > 5? –ù–ï–¢
```

**–í–´–í–û–î:** –£—Å–ª–æ–≤–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ —Å—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç `'closed'`, –∞ –Ω–µ `'early_closing'`.

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"!

### –í–û–ó–ú–û–ñ–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï: –í—ã–±–æ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–º–µ–Ω—ã –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö

**–ì–ò–ü–û–¢–ï–ó–ê:** –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –∏ –æ–¥–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ (21:30), –∞ –¥—Ä—É–≥–∞—è –ø–æ–∑–∂–µ (22:10), —Ç–æ `last_shift` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 21:30 MSK (–Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ) ‚Üí `end_time = 18:30 UTC`
- –°–º–µ–Ω–∞ B: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 22:10 MSK (–Ω–∞ 10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ) ‚Üí `end_time = 19:10 UTC`

**–í—ã–±–æ—Ä `last_shift`:**
```python
last_shift = max(shifts_today, key=lambda s: s.end_time or s.start_time)
```

- `max([18:30 UTC, 19:10 UTC])` = –°–º–µ–Ω–∞ B (19:10 UTC) ‚úÖ

**–ù–û:** –ï—Å–ª–∏ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã B:
- `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç`
- –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–ù–ï —Å—Ä–∞–±–æ—Ç–∞–µ—Ç**

**–í–û–ó–ú–û–ñ–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï:** –ï—Å–ª–∏ `max()` **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ** –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É A (18:30 UTC) –≤–º–µ—Å—Ç–æ —Å–º–µ–Ω—ã B (19:10 UTC), —Ç–æ:
- –†–∞—Å—á—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã A: `early_minutes = (22:00 - 21:30) = 30 –º–∏–Ω—É—Ç` ‚úÖ
- –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–î–ê** ‚Üí —Å—Ç–∞—Ç—É—Å "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"

**–ù–û:** –ü–æ—á–µ–º—É `max()` –≤—ã–±—Ä–∞–ª –±—ã —Å–º–µ–Ω—É A (18:30 UTC), –µ—Å–ª–∏ —Å–º–µ–Ω–∞ B (19:10 UTC) –∏–º–µ–µ—Ç –±–æ–ª—å—à–∏–π `end_time`?

### –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º `shifts_today`

**–°—Ç—Ä–æ–∫–∏ 179-207:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–º–µ–Ω –ø–æ `planned_start` –∏–ª–∏ `start_time/actual_start` –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ `start_of_day_utc` - `end_of_day_utc`.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Å–º–µ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 22:10 MSK (1.11), –Ω–æ –Ω–∞—á–∞–ª–∞—Å—å –≤ 23:00 MSK (1.11) –∏–ª–∏ –≤ 00:00 MSK (2.11), —Ç–æ –æ–Ω–∞ –º–æ–∂–µ—Ç –Ω–µ –ø–æ–ø–∞—Å—Ç—å –≤ `shifts_today`, –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏–¥—ë—Ç –ø–æ `start_time` –∏–ª–∏ `planned_start`.

**–ù–û:** –ï—Å–ª–∏ —Å–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å –≤ 09:00 MSK (1.11) –∏ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 22:10 MSK (1.11), —Ç–æ –æ–Ω–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `shifts_today` ‚úÖ

**–í–´–í–û–î:** –≠—Ç–æ –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É.

### –§–ò–ù–ê–õ–¨–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö

**–ö–õ–Æ–ß–ï–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –∏ `last_shift` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º –≤ UTC), —Ç–æ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ.

**–í–û–ó–ú–û–ñ–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:** –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º `datetime` –æ–±—ä–µ–∫—Ç–æ–≤ –≤ UTC, –µ—Å–ª–∏ —Å–º–µ–Ω—ã –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π.

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ **–í–°–ï** –æ–±—ä–µ–∫—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ"!

**–í–û–ó–ú–û–ñ–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï:** –ï—Å–ª–∏ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –∏–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏, —Ç–æ –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∞—Å—á—ë—Ç –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫—Ä—ã–ª–∏—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ.

**–ò–õ–ò:** –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –≤—ã–±–æ—Ä–µ `last_shift`, –∞ –≤ —Å–∞–º–æ–π —Ñ–æ—Ä–º—É–ª–µ —Ä–∞—Å—á—ë—Ç–∞ `early_minutes`!

### –ì–ò–ü–û–¢–ï–ó–ê: –ò–Ω–≤–µ—Ä—Å–∏—è —Ñ–æ—Ä–º—É–ª—ã

**–í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –§–æ—Ä–º—É–ª–∞ `early_minutes = expected_close - actual_close_local` –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!

**–¢–µ–∫—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞:**
```python
early_minutes = int((expected_close - actual_close_local).total_seconds() / 60)
```

**–ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∑–∞–∫—Ä—ã–ª—Å—è –≤ 22:10, –∞ –æ–∂–∏–¥–∞–ª–æ—Å—å 22:00:**
- `expected_close` = 22:00
- `actual_close_local` = 22:10
- `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç` ‚ùå

**–ù–û:** –ï—Å–ª–∏ —Ñ–æ—Ä–º—É–ª–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞:
- `early_minutes = (actual_close_local - expected_close) = (22:10 - 22:00) = 10 –º–∏–Ω—É—Ç` ‚úÖ

**–ù–û:** –ö–æ–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `expected_close - actual_close_local`, –∞ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç!

**–í–´–í–û–î:** –§–æ—Ä–º—É–ª–∞ –Ω–µ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞.

### –§–ò–ù–ê–õ–¨–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –∏ —Ä–∞—Å—á—ë—Ç–æ–º –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–º–µ–Ω—ã

**–ö–õ–Æ–ß–ï–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –∏ `last_shift` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏), —Ç–æ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ.

**–í–û–ó–ú–û–ñ–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö - –µ—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ `end_time` –∏–¥—ë—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å timezone), —Ç–æ `max()` –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Å–º–µ–Ω—É, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ.

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 21:30 MSK ‚Üí `end_time = 18:30 UTC` (—Ä–∞–Ω—å—à–µ –Ω–∞ 30 –º–∏–Ω—É—Ç)
- –°–º–µ–Ω–∞ B: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 22:10 MSK ‚Üí `end_time = 19:10 UTC` (–ø–æ–∑–∂–µ –Ω–∞ 10 –º–∏–Ω—É—Ç)

**–ï—Å–ª–∏ `max()` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É B (19:10 UTC):**
- –†–∞—Å—á—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã B: `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç` ‚ùå
- –£—Å–ª–æ–≤–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç

**–ù–û:** –ï—Å–ª–∏ `max()` **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ** –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É A (18:30 UTC), —Ç–æ:
- –†–∞—Å—á—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã A: `early_minutes = (22:00 - 21:30) = 30 –º–∏–Ω—É—Ç` ‚úÖ
- –£—Å–ª–æ–≤–∏–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí —Å—Ç–∞—Ç—É—Å "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"

**–í–û–ó–ú–û–ñ–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:** –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º `datetime` –æ–±—ä–µ–∫—Ç–æ–≤ –≤ UTC –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `max()` —Å `key=lambda s: s.end_time or s.start_time`.

## üìä –ò–¢–û–ì–û–í–´–ô –í–´–í–û–î

**–ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `timezone_helper.local_tz` (MSK) –≤–º–µ—Å—Ç–æ `obj.timezone` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ `expected_close` –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ `actual_close_local` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö.

**–í–¢–û–†–ò–ß–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö, –µ—Å–ª–∏ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–º–µ–Ω–∞ –ø–æ `end_time`).

**–°–¶–ï–ù–ê–†–ò–ô –í–û–ó–ù–ò–ö–ù–û–í–ï–ù–ò–Ø –ë–ê–ì–ê:**
1. –û–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
2. –û–¥–Ω–∞ —Å–º–µ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 21:30 (–Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ)
3. –î—Ä—É–≥–∞—è —Å–º–µ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 22:10 (–Ω–∞ 10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ)
4. **–ù–û:** –ï—Å–ª–∏ `last_shift` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏), —Ç–æ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ (21:30)
5. `early_minutes = (22:00 - 21:30) = 30 –º–∏–Ω—É—Ç` ‚úÖ
6. –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–î–ê** ‚Üí —Å—Ç–∞—Ç—É—Å "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"

**–ù–û:** –≠—Ç–æ –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É **–í–°–ï** –æ–±—ä–µ–∫—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ"!

**–í–û–ó–ú–û–ñ–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï:** –ï—Å–ª–∏ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –∏–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏, —Ç–æ –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∞—Å—á—ë—Ç –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫—Ä—ã–ª–∏—Å—å —Ä–∞–Ω—å—à–µ, –∞ –Ω–µ –ø–æ–∑–∂–µ.

**–ò–õ–ò:** –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –≤—ã–±–æ—Ä–µ `last_shift`, –∞ –≤ —Å–∞–º–æ–π –ª–æ–≥–∏–∫–µ —Ä–∞—Å—á—ë—Ç–∞ - –≤–æ–∑–º–æ–∂–Ω–æ, –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–º–µ–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ —É—Å–ª–æ–≤–∏–µ `if last_shift.end_time and last_shift.status == 'completed' and not active_shifts_on_object` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ–∑–∂–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å `active_shifts_on_object`).

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –ò–î–ï–ù–¢–ò–§–ò–¶–ò–†–û–í–ê–ù–ê (–ù–ï–°–ö–û–õ–¨–ö–û –ì–ò–ü–û–¢–ï–ó)**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –≤—ã–≤–µ—Å—Ç–∏ `last_shift.id`, `last_shift.end_time`, `expected_close`, `actual_close_local`, `early_minutes` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ª–æ–≤–∏–µ `if last_shift.end_time and last_shift.status == 'completed' and not active_shifts_on_object` - –º–æ–∂–µ—Ç –±—ã—Ç—å, –æ–Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–º–µ–Ω—ã







