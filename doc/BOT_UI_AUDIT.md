# ü§ñ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç UI –±–æ—Ç–∞ StaffProBot

**–î–∞—Ç–∞**: 2025-10-16  
**–í–µ—Ä—Å–∏—è**: Production –Ω–∞ –∫–æ–º–º–∏—Ç–µ c59bbf0 + dev —Å fixes  
**–°—Ç–∞—Ç—É—Å**: –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏](#–æ—Å–Ω–æ–≤–Ω—ã–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏)
2. [–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ —ç–∫—Ä–∞–Ω–∞](#–¥–µ—Ç–∞–ª—å–Ω—ã–π-–∞–Ω–∞–ª–∏–∑-–∫–∞–∂–¥–æ–≥–æ-—ç–∫—Ä–∞–Ω–∞)
3. [–ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º](#–º–∞—Ç—Ä–∏—Ü–∞-–ø—Ä–æ–±–ª–µ–º)
4. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –≤–∏–¥–µ–Ω–∏–µ](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ-–≤–∏–¥–µ–Ω–∏–µ)
5. [–ü–ª–∞–Ω —Ä–∞–±–æ—Ç](#–ø–ª–∞–Ω-—Ä–∞–±–æ—Ç)

---

## –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### üü¢ –û—Å–Ω–æ–≤–Ω–æ–π flow –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```
/start (–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
  ‚îú‚îÄ üîÑ –û—Ç–∫—Ä—ã—Ç—å –æ–±—ä–µ–∫—Ç ‚Üí –ó–∞–∫—Ä—ã—Ç—å –æ–±—ä–µ–∫—Ç
  ‚îú‚îÄ üîÑ –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É ‚Üí –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É
  ‚îú‚îÄ üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ–Ω—É
  ‚îú‚îÄ üìã –ú–æ–∏ –ø–ª–∞–Ω—ã
  ‚îú‚îÄ üìä –û—Ç—á–µ—Ç
  ‚îú‚îÄ üìù –ú–æ–∏ –∑–∞–¥–∞—á–∏
  ‚îú‚îÄ üìà –°—Ç–∞—Ç—É—Å
  ‚îî‚îÄ üÜî –ú–æ–π Telegram ID
```

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ —ç–∫—Ä–∞–Ω–∞

### 1Ô∏è‚É£ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (`/start`)

**–§–∞–π–ª**: `apps/bot/handlers_div/core_handlers.py`  
**–§—É–Ω–∫—Ü–∏—è**: `start_command()`

#### UI —ç–ª–µ–º–µ–Ω—Ç—ã
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–π
- 7 –∫–Ω–æ–ø–æ–∫ –≤ 2x1 –º–∞—Ç—Ä–∏—Ü–µ
- HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –î–∞–Ω–Ω—ã–µ –≤ –ë–î
- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ User –≤ user_manager
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞

#### –õ–æ–≥–∏–∫–∞
```python
if not user_manager.is_user_registered(user.id):
    # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    user_manager.register_user(...)
else:
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π - –æ–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    user_manager.update_user_activity(...)
```

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ UserState
- –û—á–∏—â–∞–µ—Ç—Å—è: `user_state_manager.clear_state(user_id)`

#### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é

#### ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω?)

#### üü† –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_active` –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–µ–Ω—é
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### 2Ô∏è‚É£ –û—Ç–∫—Ä—ã—Ç—å –æ–±—ä–µ–∫—Ç

**–§–∞–π–ª**: `apps/bot/handlers_div/object_state_handlers.py`  
**–§—É–Ω–∫—Ü–∏—è**: `_handle_open_object()`, `_handle_select_object_to_open()`

#### UI —ç–ª–µ–º–µ–Ω—Ç—ã
- –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ (inline –∫–Ω–æ–ø–∫–∏)
- –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (KeyboardButton —Å `request_location=True`)

#### –î–∞–Ω–Ω—ã–µ –≤ –ë–î
- Opening –æ–±—ä–µ–∫—Ç–∞
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

#### –õ–æ–≥–∏–∫–∞
1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —Å `callback_data="open_object:{object_id}"`
3. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–±—ä–µ–∫—Ç–∞ ‚Üí `_handle_select_object_to_open()`
4. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –æ–±—ä–µ–∫—Ç–∞
6. –ï—Å–ª–∏ OK ‚Üí —Å–æ–∑–¥–∞—Ç—å Opening –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ UserState
```python
UserState(
    action=UserAction.OPEN_OBJECT,
    step=UserStep.LOCATION_REQUEST,
    selected_object_id=object_id
)
```

#### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ

#### ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (–Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–µ–ø–∫–∏)
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ "–æ–±—ä–µ–∫—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç?"

#### üü† –ü—Ä–æ–±–ª–µ–º—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è
- –ù–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏-–∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–±—ä–µ–∫—Ç–∞ (–º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º ReplyKeyboardMarkup)

---

### 3Ô∏è‚É£ –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É

**–§–∞–π–ª**: `apps/bot/handlers_div/shift_handlers.py`  
**–§—É–Ω–∫—Ü–∏–∏**: `_handle_open_shift()`, `_handle_open_planned_shift()`, `_handle_select_object_to_open()`

#### UI —ç–ª–µ–º–µ–Ω—Ç—ã
- "–ú–æ–∏ —Å–º–µ–Ω—ã" (–∫–Ω–æ–ø–∫–∞)
- –°–ø–∏—Å–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω (inline –∫–Ω–æ–ø–∫–∏)
- –í—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–π —Å–º–µ–Ω—ã
- –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á —Å –∫–Ω–æ–ø–∫–∞–º–∏ "–í—ã–ø–æ–ª–Ω–µ–Ω–æ"/"–ú–æ–∏ –∑–∞–¥–∞—á–∏"

#### –î–∞–Ω–Ω—ã–µ –≤ –ë–î
- Shift —Å `status='active'`, `actual_start=NOW()`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

#### –õ–æ–≥–∏–∫–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
1. –ü–æ–∫–∞–∑–∞—Ç—å "–ú–æ–∏ —Å–º–µ–Ω—ã" ‚Üí –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ + —Å–ø–æ–Ω—Ç–∞–Ω–Ω–∞—è
2. –î–ª—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π: –∑–∞–≥—Ä—É–∑–∏—Ç—å shift –ø–æ time_slot_id
3. –î–ª—è —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–π: –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞
4. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
6. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ (–∏–∑ time_slot + object)
7. –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
8. –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é

#### –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á - –ö–†–ò–¢–ò–ß–ù–û
```python
# –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–º–µ–Ω–∞
if shift.time_slot_id and shift.time_slot:
    # –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ TimeslotTaskTemplate
    timeslot_tasks = _load_timeslot_tasks(session, shift.time_slot)
    
    # –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ object
    object_tasks = shift.object.shift_tasks
    
    # –û–±—ä–µ–¥–∏–Ω–∏—Ç—å
    if not shift.time_slot.ignore_object_tasks:
        all_tasks = timeslot_tasks + object_tasks
    else:
        all_tasks = timeslot_tasks
else:
    # –°–ø–æ–Ω—Ç–∞–Ω–Ω–∞—è —Å–º–µ–Ω–∞ - —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞
    all_tasks = shift.object.shift_tasks
```

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ UserState
```python
UserState(
    action=UserAction.OPEN_SHIFT,
    step=UserStep.LOCATION_REQUEST,
    selected_shift_id=shift_id,
    selected_object_id=object_id,
    shift_tasks=[...]  # ‚Üê –í–ê–ñ–ù–û!
)
```

#### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–º–µ–Ω—ã
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ –∏ –æ–±—ä–µ–∫—Ç–∞
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ —Å –∏–∫–æ–Ω–∫–∞–º–∏ (‚ö†Ô∏è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è, üì∏ —Ñ–æ—Ç–æ)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ

#### ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (–Ω—É–∂–Ω–∞ ReplyKeyboardMarkup)
- –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ ‚Üí –º–æ–ª—á–∏—Ç, –Ω—É–∂–Ω–∞ –∫–Ω–æ–ø–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é

#### üî¥ CRITICAL (–Ω–∞–π–¥–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è)
- –ù–µ—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `_collect_shift_tasks()` - –∫–æ–¥ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

---

### 4Ô∏è‚É£ –ú–æ–∏ –∑–∞–¥–∞—á–∏

**–§–∞–π–ª**: `apps/bot/handlers_div/shift_handlers.py`  
**–§—É–Ω–∫—Ü–∏–∏**: `_handle_my_tasks()`, `_handle_complete_my_task()`

#### UI —ç–ª–µ–º–µ–Ω—Ç—ã
- Inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏: "‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å"
- –ö–Ω–æ–ø–∫–∏ "üì∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ" (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–µ–¥–∏–∞)
- –ö–Ω–æ–ø–∫–∞ "–í–µ—Ä–Ω—É—Ç—å—Å—è" (–µ—Å–ª–∏ –≤ –º–µ–Ω—é –∑–∞–¥–∞—á)

#### –î–∞–Ω–Ω—ã–µ –≤ –ë–î
- UserState.completed_tasks - –∏–Ω–¥–µ–∫—Å—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö
- UserState.task_media - –¥–∞–Ω–Ω—ã–µ –æ —Ñ–æ—Ç–æ

#### –õ–æ–≥–∏–∫–∞
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ —Å–º–µ–Ω—ã (–∫–∞–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)
2. –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. –ü—Ä–∏ –∫–ª–∏–∫–µ - –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
4. –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ñ–æ—Ç–æ - –∑–∞–ø—Ä–æ—Å–∏—Ç—å
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ UserState.task_media

#### –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
```python
# –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã!
# ‚Üê –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï –ö–û–î–ê!
```

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ UserState
```python
UserState(
    action=UserAction.COMPLETE_MY_TASKS,
    step=UserStep.TASK_COMPLETION,
    completed_tasks=[0, 2],  # –∏–Ω–¥–µ–∫—Å—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö
    task_media={'0': {'media_url': 'file_123.jpg', ...}}
)
```

#### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∑–∞–¥–∞—á–∏ (–∏–∑ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ –∏ –æ–±—ä–µ–∫—Ç–∞)
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è

#### ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ö–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è (–Ω–µ DRY)
- –ù–µ—Ç –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É" –≤ –º–µ–Ω—é –∑–∞–¥–∞—á

#### üü† –ü—Ä–æ–±–ª–µ–º—ã
- `completed_tasks` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ UserState (in-memory), –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ —Ç–µ—Ä—è–µ—Ç—Å—è

---

### 5Ô∏è‚É£ –ó–∞–∫—Ä—ã—Ç—å –æ–±—ä–µ–∫—Ç

**–§–∞–π–ª**: `apps/bot/handlers_div/object_state_handlers.py`  
**–§—É–Ω–∫—Ü–∏–∏**: `_handle_close_object()`

#### UI —ç–ª–µ–º–µ–Ω—Ç—ã
- –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ" (–µ—Å–ª–∏ –∑–∞–¥–∞—á–∏)

#### –î–∞–Ω–Ω—ã–µ –≤ –ë–î
- Closing –æ–±—ä–µ–∫—Ç–∞
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- –î–æ–ª–∂–Ω—ã –ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?

#### –õ–æ–≥–∏–∫–∞
1. –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π shift –Ω–∞ —ç—Ç–æ–º –æ–±—ä–µ–∫—Ç–µ
2. **–ü–†–û–ë–õ–ï–ú–ê**: –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞, –Ω–µ –∏–∑ —Ç–∞–π–º-—Å–ª–æ—Ç–∞!
3. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é
4. –ü–æ—Å–ª–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ ‚Üí close_object() –≤ shift_service
5. –ï—Å–ª–∏ –±—ã–ª shift ‚Üí –∑–∞–∫—Ä—ã—Ç—å –µ–≥–æ –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫—Ä—ã—Ç–∏—é —Å–º–µ–Ω—ã

#### –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á - –û–®–ò–ë–ö–ê!
```python
# –í object_state_handlers.py –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è _load_timeslot_tasks()!
# –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ object.shift_tasks

# –ü—Ä–∞–≤–∏–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# if shift.time_slot_id:
#     timeslot_tasks = _load_timeslot_tasks(...)
#     all_tasks = timeslot_tasks + object_tasks
```

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ UserState
```python
UserState(
    action=UserAction.CLOSE_OBJECT,
    step=UserStep.LOCATION_REQUEST,
    selected_object_id=object_id,
    shift_id=shift_id,
    # ‚ùå –ó–¥–µ—Å—å –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è completed_tasks –æ—Ç time_slot!
)
```

#### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é

#### ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (CRITICAL)
- **–ó–∞–¥–∞—á–∏ –∏–∑ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è**
- **completed_tasks —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ UserState**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ "–æ–±—ä–µ–∫—Ç —É–∂–µ –∑–∞–∫—Ä—ã—Ç?"

#### üî¥ CRITICAL (–Ω–∞–π–¥–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è)
- –ù–µ—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á
- –ü–æ—Ç–µ—Ä—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö —Ç–∞–π–º-—Å–ª–æ—Ç–∞

---

### 6Ô∏è‚É£ –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É

**–§–∞–π–ª**: `apps/bot/handlers_div/shift_handlers.py`  
**–§—É–Ω–∫—Ü–∏–∏**: `_handle_close_shift()`, `_handle_close_shift_with_tasks()`

#### UI —ç–ª–µ–º–µ–Ω—Ç—ã
- –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ"

#### –î–∞–Ω–Ω—ã–µ –≤ –ë–î
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `shift.notes` —Å `completed_tasks` –∏ `task_media`
- –ó–∞–∫—Ä—ã—Ç–∏–µ shift —Å `status='completed'`

#### –õ–æ–≥–∏–∫–∞
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ —Å–º–µ–Ω—ã
2. –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö ‚Üí –∑–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
4. **–í–ê–ñ–ù–û**: –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `shift_service.close_shift()` —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `shift.notes`
5. Celery –∑–∞–¥–∞—á–∞ –ø—Ä–æ—á–∏—Ç–∞–µ—Ç –∏–∑ `shift.notes` –∏ —Å–æ–∑–¥–∞—Å—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏

#### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ notes - –ö–†–ò–¢–ò–ß–ù–û
```python
# core_handlers.py handle_location() –¥–ª—è UserAction.CLOSE_SHIFT
if shift_tasks:
    completed_info = json.dumps({
        'completed_tasks': user_state.completed_tasks,
        'task_media': user_state.task_media
    }, ensure_ascii=False)
    shift.notes = f"...[TASKS]{completed_info}"
    await session.commit()  # ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
```

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ UserState
```python
UserState(
    action=UserAction.CLOSE_SHIFT,
    step=UserStep.LOCATION_REQUEST,
    selected_shift_id=shift_id,
    shift_tasks=[...],
    completed_tasks=[0, 2],  # –∏–Ω–¥–µ–∫—Å—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö
    task_media={...}
)
```

#### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç completed_tasks –≤ shift.notes
- Celery —Å–æ–∑–¥–∞—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏

#### ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á (–∫–æ–ø–∏–ø–∞—Å—Ç–∞ –∫–æ–¥–∞)

#### üü† –ü—Ä–æ–±–ª–µ–º—ã
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ "—Å–º–µ–Ω–∞ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞?"
- –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —É—Å–ø–µ—Ö–µ

---

## –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –≠–∫—Ä–∞–Ω | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | Root Cause |
|---|----------|-------|------|--------|-----------|-----------|
| 1 | –°–µ–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ | Celery | `adjustment_tasks.py:341` | ‚úÖ FIXED | üî¥ | `if not is_completed:` –ø—Ä–æ–ø—É—Å–∫–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å–æ —à—Ç—Ä–∞—Ñ–æ–º |
| 2 | –ó–∞–¥–∞—á–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ "–ó–∞–∫—Ä—ã—Ç—å –æ–±—ä–µ–∫—Ç" | Close Object | `object_state_handlers.py` | ‚ùå OPEN | üî¥ | –ù–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `_load_timeslot_tasks()` |
| 3 | –ö–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è | Open Shift + My Tasks | `shift_handlers.py` | ‚ùå OPEN | üü† | –ù–µ—Ç –µ–¥–∏–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `_collect_shift_tasks()` |
| 4 | –ü–æ—Ç–µ—Ä—è completed_tasks –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ UserState | Close Object | `object_state_handlers.py` | ‚ùå OPEN | üü† | UserState –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| 5 | –ù–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ | Open Shift + Open Object | `core_handlers.py` | ‚ùå OPEN | üü† | ReplyKeyboardMarkup –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è |
| 6 | –ú–æ–ª—á–∞–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ | Close Shift | `core_handlers.py:200-305` | ‚ö†Ô∏è PARTIAL | üü† | –ù–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é |

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –≤–∏–¥–µ–Ω–∏–µ

### –ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å

#### –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
```python
async def _collect_shift_tasks(
    session: AsyncSession,
    shift: Shift,
    timeslot: Optional[TimeSlot] = None,
    object_: Optional[Object] = None
) -> List[Dict]:
    """–°–æ–±—Ä–∞—Ç—å –í–°–ï –∑–∞–¥–∞—á–∏ —Å–º–µ–Ω—ã –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤."""
    
    all_tasks = []
    
    # 1. –ó–∞–¥–∞—á–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if timeslot:
        timeslot_tasks = await _load_timeslot_tasks(session, timeslot)
        all_tasks.extend(timeslot_tasks)
    
    # 2. –ó–∞–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
    if object_ and not (timeslot and timeslot.ignore_object_tasks):
        if object_.shift_tasks:
            for task in object_.shift_tasks:
                task_copy = dict(task)
                task_copy['source'] = 'object'
                all_tasks.append(task_copy)
    
    return all_tasks
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–µ–∑–¥–µ
```python
# –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã
all_tasks = await _collect_shift_tasks(session, shift, shift.time_slot, shift.object)

# –ü—Ä–∏ "–ú–æ–∏ –∑–∞–¥–∞—á–∏"
all_tasks = await _collect_shift_tasks(session, shift, shift.time_slot, shift.object)

# –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–±—ä–µ–∫—Ç–∞
all_tasks = await _collect_shift_tasks(session, shift, shift.time_slot, shift.object)

# –ü—Ä–∏ Celery –æ–±—Ä–∞–±–æ—Ç–∫–µ
all_tasks = await _collect_shift_tasks(session, shift, shift.time_slot, shift.object)
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ UserState
```python
@dataclass
class UserState:
    user_id: int
    action: UserAction
    step: UserStep
    
    # –¢–µ–∫—É—â–∞—è —Å–º–µ–Ω–∞/–æ–±—ä–µ–∫—Ç
    selected_shift_id: Optional[int]
    selected_object_id: Optional[int]
    
    # –ó–∞–¥–∞—á–∏ –∏ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    shift_tasks: List[Dict] = field(default_factory=list)
    completed_tasks: List[int] = field(default_factory=list)
    task_media: Dict[str, Dict] = field(default_factory=dict)
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    created_at: datetime = field(default_factory=datetime.now)
    expires_at: datetime = field(default_factory=...)
    
    # –ú–µ—Ç–æ–¥—ã
    def mark_task_completed(self, task_idx: int, media: Optional[Dict] = None):
        """–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é."""
        if task_idx not in self.completed_tasks:
            self.completed_tasks.append(task_idx)
        if media:
            self.task_media[str(task_idx)] = media
        self.expires_at = datetime.now() + timedelta(minutes=5)
    
    def save_to_shift_notes(self) -> str:
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç shift.notes."""
        return json.dumps({
            'completed_tasks': self.completed_tasks,
            'task_media': self.task_media
        }, ensure_ascii=False)
```

---

## –ü–ª–∞–Ω —Ä–∞–±–æ—Ç

### –§–∞–∑–∞ 1: EMERGENCY FIX (DONE ‚úÖ)
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–µ–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –≤ `adjustment_tasks.py`
- [x] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ dev
- [x] –ö–æ–º–º–∏—Ç `482629e`

### –§–∞–∑–∞ 2: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á (TODO)
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_collect_shift_tasks()` –≤ `shift_handlers.py`
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –≤—ã–∑–æ–≤—ã –≤:
  - [ ] `_handle_open_planned_shift()`
  - [ ] `_handle_my_tasks()`
  - [ ] `_handle_close_object()`
  - [ ] `core_handlers.py` –ø—Ä–∏ location_request
  - [ ] `adjustment_tasks.py`

### –§–∞–∑–∞ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–±—ä–µ–∫—Ç–∞ (TODO)
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_collect_shift_tasks()` –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–±—ä–µ–∫—Ç–∞
- [ ] –°–æ—Ö—Ä–∞–Ω—è—Ç—å completed_tasks –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ UserState
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ dev

### –§–∞–∑–∞ 4: UX —É–ª—É—á—à–µ–Ω–∏—è (TODO)
- [ ] –î–æ–±–∞–≤–∏—Ç—å ReplyKeyboardMarkup –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ "—É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ?", "—É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ?"

### –§–∞–∑–∞ 5: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –Ω–∞ prod (TODO)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
- [ ] –ö–æ–º–º–∏—Ç –≤—Å–µ—Ö changes
- [ ] Deploy –Ω–∞ prod —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º

---

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤**: 8 –æ—Å–Ω–æ–≤–Ω—ã—Ö
- **–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º –Ω–∞–π–¥–µ–Ω–æ**: 6
- **CRITICAL**: 2
- **HIGH**: 2
- **MEDIUM**: 2
- **–°—Ç–∞—Ç—É—Å**: 1 fixed, 5 open

