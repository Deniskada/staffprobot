# –ë–∞–≥: –ò–Ω–≤–µ—Ä—Å–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞—á v2 –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **–ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ï** —Å—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á v2 (–≥–∞–ª–æ—á–∫–∏/–∫—Ä–µ—Å—Ç–∏–∫–∏):
- –ó–∞–¥–∞—á–∞ 5: –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ "–ú–æ–∏ –∑–∞–¥–∞—á–∏", –≤ –ë–î `is_completed=TRUE`, –Ω–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã –ø–æ–∫–∞–∑–∞–Ω–∞ –ö–ê–ö –ù–ï–í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø ‚ùå
- –ó–∞–¥–∞—á–∞ 6: –ù–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –≤ –ë–î `is_completed=FALSE`, –Ω–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã –ø–æ–∫–∞–∑–∞–Ω–∞ –ö–ê–ö –í–´–ü–û–õ–ù–ï–ù–ù–ê–Ø ‚úÖ

## –î–∞–Ω–Ω—ã–µ –∏–∑ –ë–î

```sql
 id | shift_id | template_id |   task_title   | is_completed |         completed_at          
----+----------+-------------+----------------+--------------+-------------------------------
  5 |      309 |           6 | –í–ª–∞–∂–Ω–∞—è —É–±–æ—Ä–∫–∞ | t            | 2025-10-29 16:26:25.818294+00
  6 |      310 |           6 | –í–ª–∞–∂–Ω–∞—è —É–±–æ—Ä–∫–∞ | f            |                               
```

## –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º

- **–ë–î (task_entries_v2):** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
- **–í–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/owner/tasks/entries`:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (—á–∏—Ç–∞–µ—Ç –∏–∑ –ë–î)
- **–ë–æ—Ç –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã:** ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–∏–Ω–≤–µ—Ä—Å–∏—è)

## –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã

### –§–∞–π–ª: `apps/bot/handlers_div/shift_handlers.py`

**–°—Ç—Ä–æ–∫–∏ 573-586** - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∑–∞–¥–∞—á –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã:

```python
for idx, task in enumerate(shift_tasks):
    task_text = task.get('text') or task.get('task_text', '–ó–∞–¥–∞—á–∞')
    is_mandatory = task.get('is_mandatory', True)
    requires_media = task.get('requires_media', False)
    
    icon = "‚ö†Ô∏è" if is_mandatory else "‚≠ê"
    media_icon = "üì∏ " if requires_media else ""
    check = "‚úì " if idx in completed_tasks else "‚òê "  # ‚ùå –ü–†–û–ë–õ–ï–ú–ê –ó–î–ï–°–¨!
    keyboard.append([
        InlineKeyboardButton(
            f"{check}{media_icon}{icon} {task_text[:30]}...",
            callback_data=f"complete_shift_task:{shift['id']}:{idx}"
        )
    ])
```

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Å—Ç—Ä–æ–∫–µ 580:**
```python
check = "‚úì " if idx in completed_tasks else "‚òê "
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ?

1. **Legacy Tasks (v1):** —Å—Ç–∞—Ç—É—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `user_state.completed_tasks` (—Å–ø–∏—Å–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤) ‚úÖ
2. **Tasks v2:** —Å—Ç–∞—Ç—É—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î (`task_entries_v2.is_completed`) ‚ùå –ù–ï –ü–†–û–í–ï–†–Ø–ï–¢–°–Ø!

–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ `completed_tasks` (–∏–Ω–¥–µ–∫—Å—ã –∏–∑ state), –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç `is_completed` –∏–∑ –ë–î –¥–ª—è Tasks v2!

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ "–ú–æ–∏ –∑–∞–¥–∞—á–∏")

–í —Ñ—É–Ω–∫—Ü–∏–∏ `_show_my_tasks_list` (—Å—Ç—Ä–æ–∫–∞ 1745-1750) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–ü–†–ê–í–ò–õ–¨–ù–ê–Ø** –ª–æ–≥–∏–∫–∞:

```python
# –î–ª—è Tasks v2 –ø—Ä–æ–≤–µ—Ä—è–µ–º is_completed –∏–∑ –±–∞–∑—ã, –¥–ª—è legacy - –∏–∑ completed_tasks
is_task_completed = task.get('is_completed', False) if task.get('source') == 'task_v2' else (idx in completed_tasks)

# –ò–∫–æ–Ω–∫–∏
mandatory_icon = "‚ö†Ô∏è" if is_mandatory else "‚≠ê"
completed_icon = "‚úÖ " if is_task_completed else ""
```

**–≠—Ç–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –î–ª—è Tasks v2: `task.get('is_completed')` –∏–∑ –ë–î ‚úÖ
- –î–ª—è legacy: `idx in completed_tasks` –∏–∑ state ‚úÖ

## –†–µ—à–µ–Ω–∏–µ

–ó–∞–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ `_handle_close_shift` (—Å—Ç—Ä–æ–∫–∞ 580) –Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –∏–∑ `_show_my_tasks_list`:

### –î–æ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
```python
check = "‚úì " if idx in completed_tasks else "‚òê "
```

### –ü–æ—Å–ª–µ (–ü–†–ê–í–ò–õ–¨–ù–û):
```python
# –î–ª—è Tasks v2 –ø—Ä–æ–≤–µ—Ä—è–µ–º is_completed –∏–∑ –±–∞–∑—ã, –¥–ª—è legacy - –∏–∑ completed_tasks
is_task_completed = task.get('is_completed', False) if task.get('source') == 'task_v2' else (idx in completed_tasks)
check = "‚úì " if is_task_completed else "‚òê "
```

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

1. **`_handle_close_shift`** (—Å—Ç—Ä–æ–∫–∏ 411-702) - –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚ùå –ë–ê–ì
2. **`_handle_complete_shift_task`** (—Å—Ç—Ä–æ–∫–∏ 1059-1248) - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ ‚ö†Ô∏è –ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨
3. **`_show_my_tasks_list`** (—Å—Ç—Ä–æ–∫–∏ 1734-1815) - "–ú–æ–∏ –∑–∞–¥–∞—á–∏" ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
4. **`_show_my_tasks_list_update`** (—Å—Ç—Ä–æ–∫–∏ 1875-1952) - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ ‚ö†Ô∏è –ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨

## –ù–∞—á–∏—Å–ª–µ–Ω–∏—è

### –ó–∞–¥–∞—á–∞ 5 (–≤—ã–ø–æ–ª–Ω–µ–Ω–∞):
```sql
 id  | shift_id | adjustment_type | amount | description            | task_entry_v2_id | is_applied
-----+----------+-----------------+--------+------------------------+------------------+------------
 433 |          | task_bonus      | 100.00 | –ó–∞–¥–∞—á–∞: –í–ª–∞–∂–Ω–∞—è —É–±–æ—Ä–∫–∞ |                5 | f
```
‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ (Celery –æ–±—Ä–∞–±–æ—Ç–∞–ª is_completed=TRUE)

### –ó–∞–¥–∞—á–∞ 6 (–ù–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∞):
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–π –Ω–µ—Ç ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ, —Ç.–∫. is_completed=FALSE)

## –í—ã–≤–æ–¥—ã

1. **Celery —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - —Å–æ–∑–¥–∞–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (is_completed=TRUE)
2. **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - —á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –ë–î
3. **–ë–æ—Ç "–ú–æ–∏ –∑–∞–¥–∞—á–∏" —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç is_completed –¥–ª—è Tasks v2
4. **–ë–æ—Ç "–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã" —Ä–∞–±–æ—Ç–∞–µ—Ç –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û** - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç is_completed –¥–ª—è Tasks v2

## –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. ‚úÖ –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ `_handle_close_shift` (—Å—Ç—Ä–æ–∫–∞ 580-582)
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ `_handle_complete_shift_task` (—Å—Ç—Ä–æ–∫–∏ 1143-1145, 1171-1173)
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ `_show_my_tasks_list_update` (—Å—Ç—Ä–æ–∫–∏ 1893-1895, 1919-1921)
5. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥—ç–≤–µ (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã)
6. ‚úÖ –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (commit: cb1fdc6)

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:

1. **`_handle_close_shift`** (—Å—Ç—Ä–æ–∫–∏ 580-582):
```python
# –î–æ
check = "‚úì " if idx in completed_tasks else "‚òê "

# –ü–æ—Å–ª–µ
is_task_completed = task.get('is_completed', False) if task.get('source') == 'task_v2' else (idx in completed_tasks)
check = "‚úì " if is_task_completed else "‚òê "
```

2. **`_handle_complete_shift_task`** (—Å—Ç—Ä–æ–∫–∏ 1143-1145):
```python
# –î–æ
completed_icon = "‚úÖ " if idx in completed_tasks else ""

# –ü–æ—Å–ª–µ
is_task_completed = task.get('is_completed', False) if task.get('source') == 'task_v2' else (idx in completed_tasks)
completed_icon = "‚úÖ " if is_task_completed else ""
```

3. **`_handle_complete_shift_task`** (—Å—Ç—Ä–æ–∫–∏ 1171-1173):
```python
# –î–æ
check = "‚úì " if idx in completed_tasks else "‚òê "

# –ü–æ—Å–ª–µ
is_task_completed = task.get('is_completed', False) if task.get('source') == 'task_v2' else (idx in completed_tasks)
check = "‚úì " if is_task_completed else "‚òê "
```

4. **`_show_my_tasks_list_update`** (—Å—Ç—Ä–æ–∫–∏ 1893-1895):
```python
# –î–æ
completed_icon = "‚úÖ " if idx in completed_tasks else ""

# –ü–æ—Å–ª–µ
is_task_completed = task.get('is_completed', False) if task.get('source') == 'task_v2' else (idx in completed_tasks)
completed_icon = "‚úÖ " if is_task_completed else ""
```

5. **`_show_my_tasks_list_update`** (—Å—Ç—Ä–æ–∫–∏ 1919-1921):
```python
# –î–æ
check = "‚úì " if idx in completed_tasks else "‚òê "

# –ü–æ—Å–ª–µ
is_task_completed = task.get('is_completed', False) if task.get('source') == 'task_v2' else (idx in completed_tasks)
check = "‚úì " if is_task_completed else "‚òê "
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–∞–Ω –∑–∞–¥–∞—á v2 (–Ω–∞–ø—Ä–∏–º–µ—Ä, plan_id=3)
2. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É (shift_id=311+)
3. –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–Ω—É –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ "–ú–æ–∏ –∑–∞–¥–∞—á–∏" (–¥–æ–ª–∂–Ω–∞ –ø–æ–ª—É—á–∏—Ç—å is_completed=TRUE –≤ –ë–î)
4. –ù–∞—á–∞—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å –≥–∞–ª–æ—á–∫–æ–π ‚úÖ
5. –ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—Ç–æ—Ä—É—é –∑–∞–¥–∞—á—É
6. –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –±–µ–∑ –≥–∞–ª–æ—á–∫–∏ ‚ùå
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –≤ `/owner/payroll/adjustments`

