# Bug: –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å amount=0 –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è

**ID:** bug-tasks-zero-amount-skipped  
**–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:** 2025-10-12  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–¢–µ–≥–∏:** `celery`, `payroll`, `tasks`, `business-logic`

---

## üêõ –°–∏–º–ø—Ç–æ–º—ã

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ "–ø–æ—Ü–µ–ª–æ–≤–∞—Ç—å –≤ –ø–æ–ø—É" –Ω–µ —Å–æ–∑–¥–∞–µ—Ç —à—Ç—Ä–∞—Ñ –ø—Ä–∏ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏:

```sql
-- –¢–∞–π–º-—Å–ª–æ—Ç 1167 –∏–º–µ–µ—Ç –∑–∞–¥–∞—á—É:
shift_tasks: [{"text": "–ø–æ—Ü–µ–ª–æ–≤–∞—Ç—å –≤ –ø–æ–ø—É", "bonus_amount": 0.0, "is_mandatory": true, ...}]

-- –°–º–µ–Ω–∞ 90 –∑–∞–∫—Ä—ã—Ç–∞ –ë–ï–ó –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
-- –ù–æ adjustment –ù–ï —Å–æ–∑–¥–∞–Ω!

SELECT * FROM payroll_adjustments WHERE shift_id = 90;
-- –¢–æ–ª—å–∫–æ 1 –∑–∞–ø–∏—Å—å: shift_base (–Ω–µ—Ç task_penalty!)
```

---

## üîç –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–π–º-—Å–ª–æ—Ç —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ–π, —É –∫–æ—Ç–æ—Ä–æ–π `amount = 0` –∏–ª–∏ `deduction_amount = 0`
2. –û—Ç–∫—Ä—ã—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É –ë–ï–ó –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏
3. Celery —Å–æ–∑–¥–∞—Å—Ç —Ç–æ–ª—å–∫–æ `base_pay`, –∑–∞–¥–∞—á–∞ –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–∞

**SQL –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:**
```sql
UPDATE time_slots SET shift_tasks = '[{
  "text": "–¢–µ—Å—Ç –∑–∞–¥–∞—á–∞", 
  "is_mandatory": true, 
  "deduction_amount": 0
}]'::jsonb WHERE id = 1167;
```

---

## üîß –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã

**–§–∞–π–ª:** `core/celery/tasks/adjustment_tasks.py:226-231`

```python
task_text = task.get('text') or task.get('task_text', '–ó–∞–¥–∞—á–∞')
is_mandatory = task.get('is_mandatory', True)
deduction_amount = task.get('deduction_amount') or task.get('bonus_amount', 0)
requires_media = task.get('requires_media', False)

if not deduction_amount or float(deduction_amount) == 0:
    continue  # ‚ùå –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –í–°–ï –∑–∞–¥–∞—á–∏ –±–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–¥–∞–∂–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ!)
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. –ü—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –í–°–ï –∑–∞–¥–∞—á–∏ —Å amount=0, –≤–∫–ª—é—á–∞—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
2. –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç JSONB (`description`, `amount`)
3. –ù–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —à—Ç—Ä–∞—Ñ–∞ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞

```python
# –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
task_text = task.get('text') or task.get('description') or task.get('task_text', '–ó–∞–¥–∞—á–∞')
is_mandatory = task.get('is_mandatory', True)

# –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: deduction_amount, bonus_amount
# –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: amount
amount_value = task.get('amount')
if amount_value is None:
    # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
    deduction = task.get('deduction_amount')
    bonus = task.get('bonus_amount')
    if deduction is not None:
        amount_value = deduction
    elif bonus is not None:
        amount_value = bonus
    else:
        amount_value = 0
```

### 2. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ù–ï–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

```python
# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ù–ï–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
if (not amount_value or float(amount_value) == 0) and not is_mandatory:
    continue
```

### 3. –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —à—Ç—Ä–∞—Ñ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á

```python
# –î–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á –±–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —à—Ç—Ä–∞—Ñ -50‚ÇΩ
if is_mandatory and (not amount_value or float(amount_value) == 0):
    amount_value = -50
```

---

## üì¶ –ö–æ–º–º–∏—Ç

```
commit 75e91e7
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á –≤ adjustment_tasks

–ü—Ä–æ–±–ª–µ–º—ã:
1. –ó–∞–¥–∞—á–∏ —Å amount=0 –ø—Ä–æ–ø—É—Å–∫–∞–ª–∏—Å—å, –¥–∞–∂–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
2. –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª—Å—è –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (amount –≤–º–µ—Å—Ç–æ deduction_amount/bonus_amount)

–†–µ—à–µ–Ω–∏—è:
1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–ª—É—á–∞—é—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —à—Ç—Ä–∞—Ñ -50‚ÇΩ
2. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: —Å—Ç–∞—Ä–æ–≥–æ (text, deduction_amount, bonus_amount) –∏ –Ω–æ–≤–æ–≥–æ (description, amount)
3. –ù–ï–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```sql
-- –°–º–µ–Ω–∞ 90: 1 adjustment (—Ç–æ–ª—å–∫–æ base)
SELECT COUNT(*) FROM payroll_adjustments WHERE shift_id = 90;
-- 1
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è –Ω–æ–≤—ã—Ö —Å–º–µ–Ω):**
```sql
-- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ —Å amount=0 —Å–æ–∑–¥–∞–µ—Ç —à—Ç—Ä–∞—Ñ -50‚ÇΩ
-- adjustment_type = 'task_penalty', amount = -50.00
```

---

## üìä –§–æ—Ä–º–∞—Ç—ã JSONB –∑–∞–¥–∞—á

### –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–æ–±—ä–µ–∫—Ç—ã):
```json
{
  "text": "–£–±–æ—Ä–∫–∞ –ø–æ–º–µ—â–µ–Ω–∏—è",
  "is_mandatory": true,
  "requires_media": true,
  "deduction_amount": -100.0
}
```

### –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (—Ç–∞–π–º-—Å–ª–æ—Ç—ã):
```json
{
  "description": "–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞",
  "is_mandatory": true,
  "requires_media": false,
  "amount": -100.0
}
```

**–û–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è!**

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

- Roadmap: Phase 4A - Payroll Adjustments Refactoring
- Roadmap: Phase 4C (Object State) - Task fields –≤ —Ç–∞–π–º-—Å–ª–æ—Ç–∞—Ö
- Testing: `tests/manual/OBJECT_STATE_AND_TIMESLOTS_TESTING.md` (–§–∞–∑–∞ 5.1.–í-–ì)

---

## üí° Lessons Learned

1. **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, –¥–∞–∂–µ –±–µ–∑ —è–≤–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
2. **–ú–∏–≥—Ä–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ JSONB —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω—É–∂–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
3. **–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:** –Ø–≤–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç—ã –ª—É—á—à–µ, —á–µ–º –ø—Ä–æ–ø—É—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üîó –°–º. —Ç–∞–∫–∂–µ

- `domain/entities/object.py` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `shift_tasks` –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤
- `domain/entities/time_slot.py` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `shift_tasks` –¥–ª—è —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤
- `apps/web/services/object_service.py` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

