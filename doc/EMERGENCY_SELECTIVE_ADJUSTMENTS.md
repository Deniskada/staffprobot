# 🔴 EMERGENCY: Диагностика селективных корректировок

**Дата**: 2025-10-16 (поздно)  
**Статус**: CRITICAL - требует срочного fix перед деплоем  
**Найдено**: Root cause логической ошибки в `adjustment_tasks.py`

---

## 🔍 Проблема

На проде создаётся корректировка только для **одной** задачи, хотя закрывались **несколько**.

**Пример**:
- Смена с 2 задачами
- Задача 1: премия 100₽, выполнена → создалась корректировка `task_bonus` ✅
- Задача 2: штраф -50₽, выполнена → **НЕ создалась корректировка** ❌

---

## 🎯 Root Cause

### Логическая ошибка в `adjustment_tasks.py` строка 322-355

```python
elif amount > 0:
    # Положительная сумма - премия за выполнение
    if is_completed:  # ✅ Правильно: создаём только если выполнена
        # ... создаём task_bonus
else:
    # Отрицательная сумма - штраф за невыполнение
    if not is_completed:  # ❌ НЕПРАВИЛЬНО: создаём только если НЕ выполнена
        # ... создаём task_penalty
```

### Проблема

Если задача имеет **отрицательную сумму** (штраф за невыполнение) И **выполнена** (`is_completed=true`):
- Условие `if not is_completed:` = `False`
- Корректировка **не создаётся**
- **Но должна быть записана как успешная!**

### Вероятные интерпретации отрицательной суммы

1. **Штраф за невыполнение** (текущее понимание):
   - `amount = -50`
   - Если выполнена → не штрафовать (не создавать запись)
   - Если не выполнена → штрафовать (создать `task_penalty`)

2. **Альтернативная интерпретация** (возможно, ошибка задачи):
   - `amount = -50` может означать "максимум штраф -50, но можно получить бонус"
   - Если выполнена → создать `task_bonus: 0` или запись о выполнении

---

## 📊 Логика обработки задач

### Текущая (с ошибкой):

```
Задача с amount > 0 (премия)
├─ Выполнена? ✅ → task_bonus ✅
└─ Не выполнена? → (ничего)

Задача с amount <= 0 (штраф)
├─ Выполнена? → (ничего) ❌ ОШИБКА!
└─ Не выполнена? ✅ → task_penalty ✅
```

### Как должно быть:

```
Задача с amount > 0 (премия)
├─ Выполнена? ✅ → task_bonus ✅
└─ Не выполнена? → task_penalty (-amount) или (ничего)

Задача с amount < 0 (штраф)
├─ Выполнена? ✅ → task_completed (0₽, запись о выполнении)
└─ Не выполнена? → task_penalty (штраф -amount) ✅

Задача с amount == 0 (обязательная без стоимости, дефолт -50)
├─ После этапа 279: amount = -50
├─ Выполнена? ✅ → task_completed (0₽, запись о выполнении)
└─ Не выполнена? → task_penalty (-50) ✅
```

---

## ✅ План Fix

### Вариант A: Для выполненной задачи со штрафом создавать `task_completed`

```python
elif amount > 0:
    if is_completed:
        # task_bonus
        ...
else:  # amount < 0 (штраф)
    if is_completed:
        # ✅ NEW: Запись о выполнении (штраф избежан)
        adjustment_type = 'task_completed'
        amount = Decimal('0.00')
        description = f"Выполнено: {task_text} (штраф {abs(amount)}₽ избежан)"
        # ... создать adjustment
    else:
        # task_penalty
        ...
```

### Вариант B: Для выполненной задачи создавать `task_bonus: 0`

```python
else:  # amount < 0 (штраф)
    if is_completed:
        # ✅ NEW: Бонус 0 за выполнение (штраф избежан)
        adjustment_type = 'task_bonus'
        amount = Decimal('0.00')
        # ... создать adjustment
    else:
        # task_penalty
        ...
```

### Рекомендуемый вариант

**Вариант A** — логичнее, т.к. уже есть тип `task_completed` для таких случаев (строка 308).

---

## 🧪 Тестирование Fix

### На dev:
1. Создать смену с 2 задачами:
   - Задача 1: `deduction_amount=100` (премия)
   - Задача 2: `deduction_amount=-50` (штраф за невыполнение)
2. Обе выполнить
3. Проверить 2 корректировки:
   - `task_bonus: 100`
   - `task_completed: 0` (или `task_bonus: 0`)

### На prod:
- Проверить старые смены → должны ли пересчитаны корректировки или нет?
- Скорее всего → нет (не трогаем прошлое, только новые смены)

---

## 🚨 Следующие шаги

1. Выбрать вариант fix (A или B)
2. Реализовать в `adjustment_tasks.py`
3. Протестировать на dev
4. Задокументировать в BOT_UI_AUDIT.md как найденную и исправленную проблему
5. Коммит перед аудитом UI

