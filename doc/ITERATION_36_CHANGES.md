# –ò—Ç–µ—Ä–∞—Ü–∏—è 36: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Rules, Tasks –∏ Incidents - –°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 29 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ç–∫–∞:** `feature/rules-tasks-incidents`  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞ (100%)  
**–ö–æ–º–º–∏—Ç–æ–≤:** 88  
**–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 150+

## –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

–ú–∞—Å—à—Ç–∞–±–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∞–≤–∏–ª, –∑–∞–¥–∞—á –∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ unified –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:
- **Rules Engine** - –µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª —à—Ç—Ä–∞—Ñ–æ–≤/–ø—Ä–µ–º–∏–π –≤–º–µ—Å—Ç–æ —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
- **Tasks v2** - –Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞–¥–∞—á —Å –ø–æ–ª–Ω—ã–º lifecycle management
- **Incidents** - —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π
- **Media Orchestrator** - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
- **Critical Bug Fixes** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤ –≤ Tasks v2 –∏ Feature Flags

---

## 1. Rules Engine ‚úÖ

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å `Rule` (owner_id, code, scope, condition_json, action_json)
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `RulesEngine` —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ –∏ fallback –Ω–∞ legacy
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `adjustment_tasks.py` (–æ–ø–æ–∑–¥–∞–Ω–∏—è) –∏ `shift_cancellation_service.py` (–æ—Ç–º–µ–Ω—ã)
- ‚úÖ UI `/owner/rules` (—Å–ø–∏—Å–æ–∫, toggle, SEED –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª)
- ‚úÖ –î–µ–ø—Ä–µ–∫–∞—Ü–∏—è legacy-–ø–æ–ª–µ–π –≤ Object/OrgUnit (readonly + –∞–ª–µ—Ä—Ç)

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `domain/entities/rule.py`
- `shared/services/rules_engine.py`
- `apps/web/routes/owner_rules.py`
- `apps/web/templates/owner/rules/`

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
- `20251023_001_rules_tasks_incidents.py` - —Ç–∞–±–ª–∏—Ü–∞ `rules`

---

## 2. Tasks v2 ‚úÖ

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:
- ‚úÖ –ú–æ–¥–µ–ª–∏: `TaskTemplateV2`, `TaskPlanV2`, `TaskEntryV2`
- ‚úÖ Shared-—Å–µ—Ä–≤–∏—Å `TaskService` —Å —Ä–æ–ª–µ–≤—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
- ‚úÖ UI –¥–ª—è owner/manager/employee:
  - `/owner/tasks/templates` - —à–∞–±–ª–æ–Ω—ã –∑–∞–¥–∞—á
  - `/owner/tasks/plans` - –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á
  - `/owner/tasks/entries` - –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
  - `/manager/tasks/*` - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ
  - `/employee/tasks/my` - –º–æ–∏ –∑–∞–¥–∞—á–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤–∏–¥)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç:
  - –ó–∞–≥—Ä—É–∑–∫–∞ Tasks v2 —á–µ—Ä–µ–∑ `_collect_shift_tasks()`
  - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á —Å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –æ—Ç—á—ë—Ç–∞–º–∏
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –±–æ–Ω—É—Å–æ–≤/—à—Ç—Ä–∞—Ñ–æ–≤ (Celery task)
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–ª–∞–Ω–∞—Ö (`object_ids`)
- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å: —Ä–∞–∑–æ–≤—ã–µ, –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ, –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ
- ‚úÖ –ê–≤—Ç–æ-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω
- ‚úÖ –î–µ–ø—Ä–µ–∫–∞—Ü–∏—è `Object.shift_tasks` (readonly + –∞–ª–µ—Ä—Ç)

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `domain/entities/task_template.py`, `task_plan.py`, `task_entry.py`
- `shared/services/task_service.py`
- `apps/web/routes/owner_tasks.py`, `manager_tasks.py`, `employee_tasks.py`
- `apps/bot/handlers_div/shift_handlers.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç
- `core/celery/tasks/task_bonuses.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
- `20251023_001_rules_tasks_incidents.py` - —Ç–∞–±–ª–∏—Ü—ã `task_templates_v2`, `task_plans_v2`, `task_entries_v2`
- `doc/CLEAR_ALL_TASKS_V2.sql` - –æ—á–∏—Å—Ç–∫–∞ legacy –∑–∞–¥–∞—á –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. **–ò–Ω–≤–µ—Ä—Å–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞—á** (`doc/TASK_STATUS_INVERSION_BUG.md`):
   - –ü—Ä–æ–±–ª–µ–º–∞: –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á v2 –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å –Ω–∞–æ–±–æ—Ä–æ—Ç
   - –†–µ—à–µ–Ω–∏–µ: —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ `is_completed` –¥–ª—è Tasks v2 vs `idx in completed_tasks` –¥–ª—è legacy
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 5 –º–µ—Å—Ç–∞—Ö: `_handle_close_shift`, `_handle_complete_shift_task`, `_show_my_tasks_list_update`

2. **–ú–µ–¥–∏–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è Tasks v2** (`doc/TASK_MEDIA_UPLOAD_BUG.md`):
   - `ImportError`: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `domain.entities.org_structure` (–±—ã–ª–æ `org_unit`)
   - `AttributeError`: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø –∫ `telegram_report_chat_id` (–±—ã–ª–æ `telegram_chat_id`)
   - –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `logger.exception()`

3. **Task Bonuses Celery Task**:
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `created_by=9` (superadmin) –≤–º–µ—Å—Ç–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `user_id=1`
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ FK constraint

---

## 3. Incidents ‚úÖ

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:
- ‚úÖ –ú–æ–¥–µ–ª—å `Incident` (category, severity, status, evidence_media_json)
- ‚úÖ –†–æ—É—Ç–µ—Ä `/owner/incidents` + –±–∞–∑–æ–≤—ã–π UI
- ‚úÖ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞, –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞–º)
- ‚úÖ Feature flag `incidents` –≤ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `domain/entities/incident.py`
- `shared/services/incident_service.py`
- `apps/web/routes/owner_incidents.py`
- `apps/web/templates/owner/incidents/`

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
- `20251023_001_rules_tasks_incidents.py` - —Ç–∞–±–ª–∏—Ü–∞ `incidents`

---

## 4. Media Orchestrator ‚úÖ

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å `MediaOrchestrator` –¥–ª—è –≤—Å–µ—Ö –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–æ–≤
- ‚úÖ Redis-backed state management –¥–ª—è –º–µ–¥–∏–∞-–∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Tasks v2 (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –æ—Ç—á—ë—Ç—ã)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ—Ç–º–µ–Ω—É —Å–º–µ–Ω (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ —Å–ø—Ä–∞–≤–∫–∏)
- ‚úÖ `UserAction.MEDIA_FLOW` –≤ state manager

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `shared/services/media_orchestrator.py`
- `apps/bot/handlers_div/shift_handlers.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –±–æ—Ç–µ

---

## 5. Feature Keys Migration ‚úÖ

### –ü—Ä–æ–±–ª–µ–º–∞:
–í –ë–î —Ö—Ä–∞–Ω–∏–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ —Ñ–∏—á (`bonuses_and_penalties`, `shift_tasks`), –∞ –≤ –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –Ω–æ–≤—ã–µ (`rules_engine`, `tasks_v2`). –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Ñ–∏—á–∏
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏—è–º –≤ toast-—Å–æ–æ–±—â–µ–Ω–∏—è—Ö

### –†–µ—à–µ–Ω–∏–µ:
1. **Backward Compatibility** (`core/config/menu_config.py`):
   ```python
   LEGACY_FEATURE_MAPPING = {
       'bonuses_and_penalties': 'rules_engine',
       'shift_tasks': 'tasks_v2',
   }
   ```

2. **SQL Migration** (`doc/MIGRATE_FEATURE_KEYS.sql`):
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã `system_features.key`
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã `owner_profiles.enabled_features`
   - –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏—á–∞ `incidents`

3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
   - `docs/owner_profile/menu_structure.md` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
   - `doc/FEATURE_KEYS_MISMATCH_ANALYSIS.md` - –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
   - `doc/FEATURE_KEYS_FIX_SUMMARY.md` - –∏—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ú–µ–Ω—é –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ñ–∏—á
- ‚úÖ Toast-—Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

## 6. Payroll Adjustments Routing Fix ‚úÖ

### –ü—Ä–æ–±–ª–µ–º–∞:
–î–≤–æ–π–Ω–æ–π –ø—Ä–µ—Ñ–∏–∫—Å –≤ URL: `/owner/payroll/adjustments/payroll-adjustments`

### –†–µ—à–µ–Ω–∏–µ:
1. –£–±—Ä–∞–Ω `prefix="/payroll-adjustments"` –∏–∑ `APIRouter` –≤:
   - `apps/web/routes/owner_payroll_adjustments.py`
   - `apps/web/routes/manager_payroll_adjustments.py`

2. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ —Å—Å—ã–ª–∫–∏ –≤ —à–∞–±–ª–æ–Ω–∞—Ö:
   - `apps/web/templates/owner/payroll/detail.html`
   - `apps/web/templates/owner/payroll_adjustments/list.html`
   - –ò –¥—Ä.

3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ:
   - `apps/web/routes/owner.py`

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ URL: `/owner/payroll/adjustments/`
- ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç (—Å–ø–∏—Å–æ–∫, —Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ)

---

## 7. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å main ‚úÖ

### –ü–µ—Ä–µ–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ main:
1. **Payroll System Improvements** (–ò—Ç–µ—Ä–∞—Ü–∏—è 33-34):
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ terminated contracts —Å `settlement_policy='schedule'`
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
   - –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã —Ä–∞—Å—á—ë—Ç–∞ (`calculation_details`)
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ monthly –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å `payments_per_month > 1`

2. **Contract Termination Settlement** (–ò—Ç–µ—Ä–∞—Ü–∏—è 32):
   - –ù–æ–≤—ã–µ –ø–æ–ª—è: `termination_date`, `settlement_policy`
   - Celery task –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤
   - –ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –ø–ª–∞–Ω–æ–≤—ã—Ö —Å–º–µ–Ω –ø–æ—Å–ª–µ —É–≤–æ–ª—å–Ω–µ–Ω–∏—è

3. **Bug Fixes**:
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤ (–ò—Ç–µ—Ä–∞—Ü–∏—è 35)
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ timezone –≤ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞—Ö

---

## 8. –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚úÖ

### –¢–µ—Å—Ç—ã:
- ‚úÖ `tests/test_rules_engine.py` - —Ç–µ—Å—Ç—ã Rules Engine
- ‚úÖ `tests/test_task_service.py` - —Ç–µ—Å—Ç—ã TaskService
- ‚úÖ `tests/test_media_orchestrator.py` - —Ç–µ—Å—Ç—ã Media Orchestrator
- ‚úÖ E2E —Ç–µ—Å—Ç—ã: `doc/plans/finalization_checklist.md`

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- ‚úÖ `doc/RULES_TASKS_REFACTORING_STATUS.md` - —Å—Ç–∞—Ç—É—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ `doc/TASK_STATUS_INVERSION_BUG.md` - –∞–Ω–∞–ª–∏–∑ –±–∞–≥–∞ –∏–Ω–≤–µ—Ä—Å–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
- ‚úÖ `doc/TASK_MEDIA_UPLOAD_BUG.md` - –∞–Ω–∞–ª–∏–∑ –±–∞–≥–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞
- ‚úÖ `doc/FEATURE_KEYS_MISMATCH_ANALYSIS.md` - –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–ª—é—á–∞–º–∏ —Ñ–∏—á
- ‚úÖ `doc/FEATURE_KEYS_FIX_SUMMARY.md` - —Å–≤–æ–¥–∫–∞ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é
- ‚úÖ `doc/MIGRATE_FEATURE_KEYS.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π
- ‚úÖ `doc/CLEAR_ALL_TASKS_V2.sql` - –æ—á–∏—Å—Ç–∫–∞ –∑–∞–¥–∞—á –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞

---

## 9. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã)

### –ö–æ–º–º–∏—Ç dc69786: –ò–Ω–≤–µ—Ä—Å–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞—á v2
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å –∫–∞–∫ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
- **–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–ª —Ç–æ–ª—å–∫–æ legacy —Å—Ç–∞—Ç—É—Å (`idx in completed_tasks`), –∏–≥–Ω–æ—Ä–∏—Ä—É—è `is_completed` –∏–∑ –ë–î –¥–ª—è Tasks v2
- **–†–µ—à–µ–Ω–∏–µ:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ 5 –º–µ—Å—Ç–∞—Ö —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `task.get('source') == 'task_v2'`

### –ö–æ–º–º–∏—Ç 8782929: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ created_by –≤ task_bonuses
- **–ü—Ä–æ–±–ª–µ–º–∞:** `ForeignKeyViolationError` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –∑–∞ –∑–∞–¥–∞—á–∏
- **–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `created_by=1`, –Ω–æ user_id=1 –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ dev
- **–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ `created_by=9` (superadmin)

### –ö–æ–º–º–∏—Ç 1797724: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ telegram_report_chat_id
- **–ü—Ä–æ–±–ª–µ–º–∞:** `AttributeError: 'Object' object has no attribute 'telegram_chat_id'`
- **–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –ø–æ–ª–µ `telegram_chat_id` –≤–º–µ—Å—Ç–æ `telegram_report_chat_id`
- **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ –≤ `_handle_received_task_v2_media` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

### –ö–æ–º–º–∏—Ç—ã 816e402, dc3036b: –ê–Ω–∞–ª–∏–∑ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞:** `ImportError: No module named 'domain.entities.org_unit'`
- **–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å `org_unit` –≤–º–µ—Å—Ç–æ `org_structure`
- **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã –≤ `shift_handlers.py`

---

## 10. Acceptance Criteria - –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

- [x] Rules Engine —Ä–∞–±–æ—Ç–∞–µ—Ç —Å fallback –Ω–∞ legacy ‚úÖ
- [x] Tasks v2 –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è owner/manager/employee ‚úÖ
- [x] UI –ø—Ä–∞–≤–∏–ª/–∑–∞–¥–∞—á/–∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω (–±–∞–∑–æ–≤—ã–π CRUD) ‚úÖ
- [x] Legacy-–ø–æ–ª—è –ø–æ–º–µ—á–µ–Ω—ã deprecated (readonly + –∞–ª–µ—Ä—Ç—ã) ‚úÖ
- [x] –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MediaOrchestrator (Tasks v2 + –æ—Ç–º–µ–Ω–∞ —Å–º–µ–Ω) ‚úÖ
- [x] –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ‚úÖ
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚úÖ
- [x] Feature keys migration –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ
- [x] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã ‚úÖ

---

## 11. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ö–æ–º–º–∏—Ç—ã –ø–æ —Ç–µ–º–∞–º:
- **Rules Engine:** 12 –∫–æ–º–º–∏—Ç–æ–≤
- **Tasks v2:** 38 –∫–æ–º–º–∏—Ç–æ–≤
- **Incidents:** 4 –∫–æ–º–º–∏—Ç–∞
- **Media Orchestrator:** 3 –∫–æ–º–º–∏—Ç–∞
- **Feature Keys Migration:** 6 –∫–æ–º–º–∏—Ç–æ–≤
- **Payroll Adjustments Routing:** 8 –∫–æ–º–º–∏—Ç–æ–≤
- **Bug Fixes:** 15 –∫–æ–º–º–∏—Ç–æ–≤
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** 7 –∫–æ–º–º–∏—Ç–æ–≤

### –§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:
- –ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤: ~50
- –ò–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: ~100
- –ú–∏–≥—Ä–∞—Ü–∏–π –ë–î: 3

### –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:
- Unit —Ç–µ—Å—Ç—ã: 15+ –Ω–æ–≤—ã—Ö
- Integration —Ç–µ—Å—Ç—ã: 8+ –Ω–æ–≤—ã—Ö
- E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏: 3 –ø–æ–ª–Ω—ã—Ö –ø—Ä–æ—Ö–æ–¥–∞

---

## 12. –î–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ production

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏:
   - `doc/MIGRATE_FEATURE_KEYS.sql` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π —Ñ–∏—á
   - `doc/CLEAR_ALL_TASKS_V2.sql` - –æ—á–∏—Å—Ç–∫–∞ legacy –∑–∞–¥–∞—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π Alembic:
   - `20251022_001_add_cancellation_reasons.py` (–∏–∑ –ò—Ç–µ—Ä–∞—Ü–∏–∏ 29)
   - `20251023_001_rules_tasks_incidents.py` (–æ—Å–Ω–æ–≤–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è)

3. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:
   - `web` - –Ω–æ–≤—ã–µ —Ä–æ—É—Ç—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
   - `bot` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Tasks v2 –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - `celery_worker` - task_bonuses —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º created_by
   - `celery_beat` - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ –ø—Ä–æ–¥–µ:
- ‚úÖ –ü—Ä–∞–≤–∏–ª–∞ —à—Ç—Ä–∞—Ñ–æ–≤/–ø—Ä–µ–º–∏–π —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `/owner/rules`
- ‚úÖ –ó–∞–¥–∞—á–∏ v2 –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `/owner/tasks/*`
- ‚úÖ –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `/owner/incidents`
- ‚úÖ –ú–µ–Ω—é –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ñ–∏—á
- ‚úÖ –ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã
- ‚úÖ –§–æ—Ç–æ/–≤–∏–¥–µ–æ –æ—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## 13. –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:
- `doc/plans/roadmap.md` - –ò—Ç–µ—Ä–∞—Ü–∏—è 36
- `doc/RULES_TASKS_REFACTORING_STATUS.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
- `doc/plans/finalization_checklist.md` - —á–µ–∫–ª–∏—Å—Ç —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:
- `doc/TASK_STATUS_INVERSION_BUG.md` - –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ—à–µ–Ω–∏–µ
- `doc/TASK_MEDIA_UPLOAD_BUG.md` - –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ—à–µ–Ω–∏–µ
- `doc/FEATURE_KEYS_MISMATCH_ANALYSIS.md` - –∞–Ω–∞–ª–∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
- `doc/FEATURE_KEYS_FIX_SUMMARY.md` - –∏—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞

### SQL –º–∏–≥—Ä–∞—Ü–∏–∏:
- `doc/MIGRATE_FEATURE_KEYS.sql` - –º–∏–≥—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π —Ñ–∏—á
- `doc/CLEAR_ALL_TASKS_V2.sql` - –æ—á–∏—Å—Ç–∫–∞ –∑–∞–¥–∞—á

---

**–ò—Ç–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!** üéâ

–ì–æ—Ç–æ–≤–∞ –∫ –º–µ—Ä–¥–∂—É –≤ main –∏ –¥–µ–ø–ª–æ—é –Ω–∞ production.

