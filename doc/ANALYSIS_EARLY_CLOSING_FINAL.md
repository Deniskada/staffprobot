# –§–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã: "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ" –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤

**–î–∞—Ç–∞:** 2025-11-01  
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –í—á–µ—Ä–∞ (1.11 –≤ 23:58 MSK) –¥–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–ª "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω, 26 –º–∏–Ω—É—Ç, 29" –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤, —Ö–æ—Ç—è –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–±—ä–µ–∫—Ç—ã –∑–∞–∫—Ä—ã–ª–∏—Å—å –≤–æ –≤—Ä–µ–º—è +10 –º–∏–Ω—É—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫—Ä—ã—Ç–∏—è (—Ç.–µ. –ø–æ–∑–∂–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ).

## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### –ö–æ–¥ —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è

**–§–∞–π–ª:** `apps/web/routes/owner.py`  
**–°—Ç—Ä–æ–∫–∏:** 331-343

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–∫–∞–∫ –±—ã–ª–æ)
if last_shift.end_time and last_shift.status == 'completed' and not active_shifts_on_object:
    naive_expected_close = datetime.combine(today_local, obj.closing_time)
    expected_close = timezone_helper.local_tz.localize(naive_expected_close)
    actual_close_local = timezone_helper.utc_to_local(last_shift.end_time)
    early_minutes = int((expected_close - actual_close_local).total_seconds() / 60)
    if early_minutes > 5:
        work_status = 'early_closing'
        work_early = early_minutes
```

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `last_shift`

**–°—Ç—Ä–æ–∫–∞ 287:**
```python
last_shift = max(shifts_today, key=lambda s: s.end_time or s.start_time)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `s.end_time` = `None`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `s.start_time`. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –≤—ã–±–æ—Ä—É –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–º–µ–Ω—ã.

**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω, –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–º–µ–Ω–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `end_time`
- –ï—Å–ª–∏ `end_time` = `None`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `start_time` –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- **–ù–û:** –°–º–µ–Ω–∞ —Å `end_time = None` (–∞–∫—Ç–∏–≤–Ω–∞—è –∏–ª–∏ –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞—è) –Ω–µ –¥–æ–ª–∂–Ω–∞ –≤—ã–±–∏—Ä–∞—Ç—å—Å—è –∫–∞–∫ `last_shift` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è!

### –°–¶–ï–ù–ê–†–ò–ô –í–û–ó–ù–ò–ö–ù–û–í–ï–ù–ò–Ø –ë–ê–ì–ê

**–î–∞—Ç–∞:** 1.11.2025, –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: 23:58 MSK

**–û–±—ä–µ–∫—Ç:**
- `obj.closing_time` = 22:00
- `obj.timezone` = "Europe/Moscow" (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º)

**–°–º–µ–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:**
1. –°–º–µ–Ω–∞ A: –Ω–∞—á–∞–ª–æ 09:00, –∑–∞–∫—Ä—ã—Ç–∏–µ 21:30 (–∑–∞–∫—Ä—ã–ª–∞—Å—å –Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ)
2. –°–º–µ–Ω–∞ B: –Ω–∞—á–∞–ª–æ 10:00, –∑–∞–∫—Ä—ã—Ç–∏–µ 22:10 (–∑–∞–∫—Ä—ã–ª–∞—Å—å –Ω–∞ 10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ)

**–†–∞—Å—á—ë—Ç `last_shift`:**
```python
last_shift = max(shifts_today, key=lambda s: s.end_time or s.start_time)
```

- –°–º–µ–Ω–∞ A: `end_time = 2025-11-01 21:30 UTC` (18:30 MSK)
- –°–º–µ–Ω–∞ B: `end_time = 2025-11-01 22:10 UTC` (19:10 MSK)
- `last_shift` = –°–º–µ–Ω–∞ B (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π `end_time`) ‚úÖ

**–†–∞—Å—á—ë—Ç —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è —Å–º–µ–Ω—ã B:**
1. `expected_close` = `2025-11-01 22:00 MSK`
2. `actual_close_local` = `2025-11-01 22:10 MSK` (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ UTC)
3. `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç`
4. –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–ù–ï —Å—Ä–∞–±–æ—Ç–∞–µ—Ç** (–¥–ª—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"!

### –ì–ò–ü–û–¢–ï–ó–ê: –í—ã–±–æ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–º–µ–Ω—ã

**–í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Å–º–µ–Ω –Ω–µ—Å–∫–æ–ª—å–∫–æ, –∏ –æ–¥–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ (21:30), –∞ –¥—Ä—É–≥–∞—è –ø–æ–∑–∂–µ (22:10), —Ç–æ `last_shift` –±—É–¥–µ—Ç —Å–º–µ–Ω–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `end_time` (22:10).

**–ù–û:** –ï—Å–ª–∏ —Å–º–µ–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ (21:30), –∏–º–µ–µ—Ç `end_time` –±–æ–ª—å—à–µ —á–µ–º —Å–º–µ–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ–∑–∂–µ (22:10), –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏, —Ç–æ `last_shift` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: `end_time` –≤ –ë–î = `2025-11-01 18:30 UTC` (21:30 MSK)
- –°–º–µ–Ω–∞ B: `end_time` –≤ –ë–î = `2025-11-01 19:10 UTC` (22:10 MSK)
- `max()` –ø–æ `end_time` = –°–º–µ–Ω–∞ B ‚úÖ

**–ù–æ –µ—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–¥—ë—Ç –≤ UTC:**
- –°–º–µ–Ω–∞ A: `end_time = 2025-11-01 18:30 UTC`
- –°–º–µ–Ω–∞ B: `end_time = 2025-11-01 19:10 UTC`
- `last_shift = –°–º–µ–Ω–∞ B` (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤ UTC) ‚úÖ

### –ì–ò–ü–û–¢–ï–ó–ê #2: –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏ –æ–±—ä–µ–∫—Ç–∞

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `timezone_helper.local_tz` (MSK) –≤–º–µ—Å—Ç–æ `obj.timezone`.

**–°—Ç—Ä–æ–∫–∞ 334:**
```python
expected_close = timezone_helper.local_tz.localize(naive_expected_close)
```

**–°—Ç—Ä–æ–∫–∞ 335:**
```python
actual_close_local = timezone_helper.utc_to_local(last_shift.end_time)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–±–∞ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ MSK, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –≤ –¥—Ä—É–≥–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ!

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ –≤ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–µ (UTC+5):**
- `obj.closing_time` = 22:00 (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞)
- `obj.timezone` = "Asia/Yekaterinburg"

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç:**
1. `naive_expected_close` = `2025-11-01 22:00` (naive)
2. `expected_close` = `timezone_helper.local_tz.localize(2025-11-01 22:00)` = `2025-11-01 22:00 MSK` (UTC+3) ‚ùå
3. **–ù–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:** `2025-11-01 22:00 –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥` (UTC+5)

**–ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∑–∞–∫—Ä—ã–ª—Å—è –≤ 22:10 (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥):**
- –í UTC: `2025-11-01 17:10 UTC` (22:10 - 5 —á–∞—Å–æ–≤)
- –í MSK: `2025-11-01 20:10 MSK` (17:10 + 3 —á–∞—Å–∞)
- `actual_close_local` = `2025-11-01 20:10 MSK` (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ `utc_to_local` –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞)

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:**
- `expected_close` = `2025-11-01 22:00 MSK` (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 22:00 –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥)
- `actual_close_local` = `2025-11-01 20:10 MSK` (–ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è MSK, –Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)
- `early_minutes = (22:00 MSK - 20:10 MSK) = 110 –º–∏–Ω—É—Ç` ‚ùå

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω", –∞ –Ω–µ 110 –º–∏–Ω—É—Ç!

### –ì–ò–ü–û–¢–ï–ó–ê #3: –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º —Å–º–µ–Ω—ã –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö

**–°—Ç—Ä–æ–∫–∞ 287:**
```python
last_shift = max(shifts_today, key=lambda s: s.end_time or s.start_time)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω, –∏ –æ–¥–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 21:30 (—Ä–∞–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –Ω–∞ 30 –º–∏–Ω—É—Ç), –∞ –¥—Ä—É–≥–∞—è –≤ 22:10 (–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∂–µ –Ω–∞ 10 –º–∏–Ω—É—Ç), —Ç–æ `last_shift` –±—É–¥–µ—Ç —Å–º–µ–Ω–∞ —Å `end_time = 22:10`.

**–ù–û:** –ï—Å–ª–∏ —Å–º–µ–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ (21:30), –∏–º–µ–µ—Ç –±–æ–ª—å—à–∏–π `end_time` –≤ UTC –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π, —Ç–æ `last_shift` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 21:30 MSK = `2025-11-01 18:30 UTC` (—Ä–∞–Ω—å—à–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –Ω–∞ 30 –º–∏–Ω—É—Ç)
- –°–º–µ–Ω–∞ B: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 22:10 MSK = `2025-11-01 19:10 UTC` (–ø–æ–∑–∂–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –Ω–∞ 10 –º–∏–Ω—É—Ç)

**–ï—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ `end_time` –∏–¥—ë—Ç –≤ UTC:**
- `last_shift = max([18:30 UTC, 19:10 UTC])` = –°–º–µ–Ω–∞ B (19:10 UTC) ‚úÖ

**–†–∞—Å—á—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã B:**
- `expected_close` = 22:00 MSK
- `actual_close_local` = 22:10 MSK
- `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç`
- –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–ù–ï —Å—Ä–∞–±–æ—Ç–∞–µ—Ç**

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ"!

### –ì–ò–ü–û–¢–ï–ó–ê #4: –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é `work_status`

**–°—Ç—Ä–æ–∫–∏ 319-343:**
```python
if delay_minutes > threshold_minutes:
    work_status = 'late_opening'
    ...
else:
    work_status = 'timely_opening'
    ...

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–∫–∞–∫ –±—ã–ª–æ)
if last_shift.end_time and last_shift.status == 'completed' and not active_shifts_on_object:
    ...
    if early_minutes > 5:
        work_status = 'early_closing'  # –ü–ï–†–ï–ó–ê–ü–ò–°–´–í–ê–ï–¢ work_status
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `work_status` —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞–∫ `'late_opening'` –∏–ª–∏ `'timely_opening'`, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ `'early_closing'` –∏–ª–∏ `'closed'`.

**–ù–û:** –ï—Å–ª–∏ `early_minutes` –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π (–æ–±—ä–µ–∫—Ç –∑–∞–∫—Ä—ã–ª—Å—è –ø–æ–∑–∂–µ), —Ç–æ —É—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ `work_status` –æ—Å—Ç–∞–Ω–µ—Ç—Å—è `'timely_opening'` –∏–ª–∏ `'late_opening'`, –Ω–æ **–ù–ï** `'early_closing'`.

**–í–´–í–û–î:** –≠—Ç–æ –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ".

### –ì–ò–ü–û–¢–ï–ó–ê #5: –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º `closing_time` –æ–±—ä–µ–∫—Ç–∞

**–°—Ç—Ä–æ–∫–∞ 333:**
```python
naive_expected_close = datetime.combine(today_local, obj.closing_time)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `obj.closing_time` –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ **–≤—á–µ—Ä–∞—à–Ω–µ–º—É –¥–Ω—é** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—ä–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã–ª –∑–∞–∫—Ä—ã—Ç—å—Å—è –≤—á–µ—Ä–∞ –≤ 22:00, –Ω–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–ª—Å—è —Å–µ–≥–æ–¥–Ω—è –≤ 00:10), —Ç–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–¥—ë—Ç —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º `expected_close`.

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `today_local` –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –¥—Ä—É–≥–æ–º.

### –ì–ò–ü–û–¢–ï–ó–ê #6: –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö —Å —Ä–∞–∑–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ –∑–∞–∫—Ä—ã—Ç–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω, –∏ –æ–¥–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤—á–µ—Ä–∞ (31.10 –≤ 22:00), –∞ –¥—Ä—É–≥–∞—è —Å–µ–≥–æ–¥–Ω—è (1.11 –≤ 22:10), —Ç–æ `shifts_today` –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é —Å–º–µ–Ω—É.

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –¥–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å, –∑–Ω–∞—á–∏—Ç —Å–º–µ–Ω—ã –Ω–∞–π–¥–µ–Ω—ã.

### –ì–ò–ü–û–¢–ï–ó–ê #7: –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ó–∞–ø—Ä–æ—Å —Å–¥–µ–ª–∞–Ω –≤ 23:58 MSK (1.11).

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∑–∞–∫—Ä—ã–ª—Å—è –≤ 22:10 MSK (1.11), –∞ –∑–∞–ø—Ä–æ—Å —Å–¥–µ–ª–∞–Ω –≤ 23:58 MSK (1.11), —Ç–æ:
- `today_local` = 2025-11-01
- `expected_close` = 2025-11-01 22:00 MSK
- `actual_close_local` = 2025-11-01 22:10 MSK (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ UTC)
- `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç`

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"!

### –í–û–ó–ú–û–ñ–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö

**–ì–õ–ê–í–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `timezone_helper.local_tz` (MSK) –≤–º–µ—Å—Ç–æ `obj.timezone` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É `expected_close` –∏ `actual_close_local` –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö.

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ –≤ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–µ (UTC+5):**
- `obj.closing_time` = 22:00 (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞)
- –û–±—ä–µ–∫—Ç –∑–∞–∫—Ä—ã–ª—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤ 22:10 (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥)

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç:**
1. `expected_close` = `2025-11-01 22:00 MSK` (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 22:00 –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥)
2. `actual_close_local` = `2025-11-01 17:10 UTC ‚Üí 20:10 MSK` (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ MSK)
3. `early_minutes = (22:00 MSK - 20:10 MSK) = 110 –º–∏–Ω—É—Ç` ‚ùå

**–ù–û:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω", –∞ –Ω–µ 110 –º–∏–Ω—É—Ç!

### –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –û–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
2. –û–¥–Ω–∞ —Å–º–µ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 21:30 (–Ω–∞ 30 –º–∏–Ω—É—Ç —Ä–∞–Ω—å—à–µ)
3. –î—Ä—É–≥–∞—è —Å–º–µ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –≤ 22:10 (–Ω–∞ 10 –º–∏–Ω—É—Ç –ø–æ–∑–∂–µ)
4. `last_shift` = —Å–º–µ–Ω–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `end_time` = 22:10

**–ù–û:** –ï—Å–ª–∏ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã —Å `end_time = 22:10`, —Ç–æ:
- `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç`
- –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–ù–ï —Å—Ä–∞–±–æ—Ç–∞–µ—Ç**

**–í–´–í–û–î:** –≠—Ç–æ –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ".

### –§–ò–ù–ê–õ–¨–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –∏ —Ä–∞—Å—á—ë—Ç–æ–º –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–º–µ–Ω—ã

**–í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–º–µ–Ω, –∏ `last_shift` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–º–µ–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –Ω–æ –∏–º–µ–µ—Ç –±–æ–ª—å—à–∏–π `end_time` –≤ UTC –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π), —Ç–æ —Ä–∞—Å—á—ë—Ç `early_minutes` –∏–¥—ë—Ç –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–º–µ–Ω—ã.

**–ü—Ä–∏–º–µ—Ä:**
- –°–º–µ–Ω–∞ A: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 21:30 MSK = `2025-11-01 18:30 UTC` (—Ä–∞–Ω—å—à–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –Ω–∞ 30 –º–∏–Ω—É—Ç)
- –°–º–µ–Ω–∞ B: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ 22:10 MSK = `2025-11-01 19:10 UTC` (–ø–æ–∑–∂–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –Ω–∞ 10 –º–∏–Ω—É—Ç)

**–ï—Å–ª–∏ `max()` –ø–æ `end_time` –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É B (19:10 UTC > 18:30 UTC):**
- –†–∞—Å—á—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã B: `early_minutes = (22:00 - 22:10) = -10 –º–∏–Ω—É—Ç` ‚ùå

**–ù–û:** –ï—Å–ª–∏ `max()` –ø–æ `end_time` **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ** –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É A (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –∏–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º), —Ç–æ:
- –†–∞—Å—á—ë—Ç –¥–ª—è —Å–º–µ–Ω—ã A: `early_minutes = (22:00 - 21:30) = 30 –º–∏–Ω—É—Ç` ‚úÖ
- –£—Å–ª–æ–≤–∏–µ `if early_minutes > 5:` ‚Üí **–î–ê** ‚Üí —Å—Ç–∞—Ç—É—Å "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ 30 –º–∏–Ω"

**–í–û–ó–ú–û–ñ–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:** –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º `end_time` –≤ UTC, –µ—Å–ª–∏ —Å–º–µ–Ω—ã –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π.

## üìä –í–´–í–û–î

**–ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `timezone_helper.local_tz` (MSK) –≤–º–µ—Å—Ç–æ `obj.timezone` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ `expected_close` –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ `actual_close_local` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É —Ä–∞–Ω–Ω–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö.

**–í–¢–û–†–ò–ß–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–±–æ—Ä–æ–º `last_shift` –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–º–µ–Ω–∞—Ö, –µ—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ `end_time` –∏–¥—ë—Ç –≤ UTC, –∞ –Ω–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –æ–±—ä–µ–∫—Ç–∞.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –î–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö (–Ω–µ MSK) —Ä–∞—Å—á—ë—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –î–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–†–∞–Ω–Ω–µ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ" –¥–∞–∂–µ –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –∑–∞–∫—Ä—ã–ª—Å—è –≤–æ–≤—Ä–µ–º—è –∏–ª–∏ –ø–æ–∑–∂–µ
- –ó–Ω–∞—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–∑-–∑–∞ —Ä–∞–∑–Ω–∏—Ü—ã —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `obj.timezone` –≤–º–µ—Å—Ç–æ `timezone_helper.local_tz` –¥–ª—è:
1. –†–∞—Å—á—ë—Ç–∞ `expected_close` (—Å—Ç—Ä–æ–∫–∞ 334)
2. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ `actual_close_local` (—Å—Ç—Ä–æ–∫–∞ 335)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –ò–î–ï–ù–¢–ò–§–ò–¶–ò–†–û–í–ê–ù–ê**

