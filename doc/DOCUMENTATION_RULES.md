# Правила работы с техническим видением (обязательно к применению)

## Назначение
Единые правила, исключающие путаницу и рассинхронизацию между кодом и документацией. Эти правила обязательны для всех изменений.

## Куда смотреть при работе с кодом
- Веб-роуты/шаблоны по ролям: см. `doc/vision_v1/roles/*`
- Общие сущности (объекты, сотрудники, тайм-слоты, смены, отзывы, заявки, отчеты, лимиты/тарифы): см. `doc/vision_v1/entities/*`
- Общие компоненты и API (календарь, медиа, рейтинги, обжалования, системные настройки): см. `doc/vision_v1/shared/*`
- Бот (команды и callback-data): см. `doc/vision_v1/bot/README.md`
- Исторический контекст и архитектура: см. `doc/vision.md`

## Обязательная процедура при изменениях
1. Найти соответствующий раздел документации (см. выше) и убедиться, что он актуален для изменяемого кода.
2. Внести изменения в код (роуты, обработчики, шаблоны, сервисы) согласно правилам проекта.
3. ОБЯЗАТЕЛЬНО обновить документацию в `doc/vision_v1`:
   - Обновить списки эндпоинтов/шаблонов/JS.
   - Уточнить префиксы (`/owner`, `/manager`, `/employee`, `/admin`, `/moderator`) и причины возможных дублей.
   - В случае удаления/переноса роутов — немедленно удалить/перенести из документации.
4. Отправить изменения на ревью. После подтверждения владельцем проекта — смержить.

## Разрешение коллизий и дубликатов
- Если один и тот же путь встречается в нескольких ролях, в документации рядом указывать роль, источник файла и назначение.
- Для служебных редиректов добавлять пометку «редирект» и конечный URL.
- Для общих API указывать, что это shared-слой и ссылка на `doc/vision_v1/shared/*`.

## Формат аннотаций в документации
- Строка эндпоинта должна пояснять:
  - откуда подключен (файл),
  - роль/префикс,
  - назначение (редирект/страница/JSON API),
  - при дублировании — причину (например, «редирект», «меню роли», «общий API»).

## Контроль качества
- Любая правка роутов без одновременного обновления документации — нарушение правил.
- Перед коммитом: быстрый diff по `doc/vision_v1` и запуск автогенерации при необходимости.
- При обнаружении несоответствий — завести задачу на коррекцию документации.

## Недавние изменения (main, 01.11.2025)

### Админ-панель биллинга - Табличные представления с сортировкой и фильтрацией (Iteration 39)
- **Обновлённые роуты:**
  - `GET /admin/billing/transactions` - список транзакций с фильтрацией (user_id, status, transaction_type) и сортировкой (id, created_at, transaction_type, status, amount)
  - `GET /admin/subscriptions/` - список подписок с фильтрацией (user_id, status, tariff_id) и сортировкой (id, user_id, status, created_at, expires_at)
  - `GET /admin/billing/usage` - метрики использования лимитов (исправлен доступ к tariff_plan через словарь)
- **Обновлённые шаблоны:**
  - `admin/billing_transactions.html` - табличное представление вместо карточек, пагинация (50 записей на страницу)
  - `admin/user_subscriptions.html` - табличное представление вместо карточек, пагинация (50 записей на страницу)
- **Технические улучшения:**
  - Серверная сортировка и фильтрация через URL параметры (`sort_by`, `sort_order`, `page`, `per_page`)
  - Исправлена обработка пустых строк в фильтрах (user_id, tariff_id принимаются как Optional[str])
  - Добавлен импорт `func` для подсчета общего количества транзакций
  - Исправлен доступ к `tariff_plan` в `check_usage_limits` (добавлена информация о тарифе в словарь подписки)

## Недавние изменения (main, 31.10.2025)

### Система уведомлений - Мета-информация типов (Iteration 37)
- **Новая таблица БД:** `notification_types_meta` (26 типов с полной мета-информацией)
- **Новые сервисы:**
  - `NotificationTypeMetaService` (`shared/services/notification_type_meta_service.py`) - управление типами
- **Обновлённые роуты:**
  - `GET /owner/notifications` - настройки уведомлений владельца (динамическая загрузка из мета-таблицы)
  - `POST /owner/notifications` - сохранение настроек (валидация через мета-таблицу)
- **Обновлённые шаблоны:**
  - `owner/notifications.html` - Accordion группировка по категориям (Смены, Договоры, Отзывы, Платежи)
- **Архитектура:**
  - Двухуровневая система: `NotificationType` (enum) + `NotificationTypeMeta` (БД)
  - 15 типов доступны для настройки владельцем (`is_user_configurable=True`)
  - 6 системных типов - только для админа (`is_admin_only=True`)
  - Единый источник истины для всех типов уведомлений
- **Категории:** shifts, contracts, reviews, payments, system, tasks, applications
- **Планируется:**
  - Админ-панель управления типами (`/admin/notifications/types`)
  - Интеграция мета-информации со статическими шаблонами

### Инциденты и корректировки (Owner - 30.10.2025)
- Обновлены роуты и шаблоны:
  - `/owner/incidents` — список, фильтры, кнопка «Категории», переход в редактирование
  - `/owner/incidents/create` — полноэкранная форма создания (Номер, Дата, Объект, Сотрудник, Ущерб)
  - `/owner/incidents/{id}/edit` — полноэкранная форма редактирования (локализованные статусы/критичность, выбор категории из списка, выбор Объект/Сотрудник)
  - `/owner/incidents/categories` — пользовательские категории владельца
- Автокорректировки при инцидентах:
  - При создании инцидента с ущербом — `PayrollAdjustment.adjustment_type=incident_deduction`, `details.incident_id=<id>`; дата берётся из пользовательской Даты
  - При переводе в «Решён» — создаётся `incident_refund` (возврат удержания)
- Отображение типов корректировок в `/owner/payroll/adjustments`:
  - Для новых типов `incident_deduction`/`incident_refund` необходимо настроить бейджи/цвета в шаблоне `apps/web/templates/owner/payroll_adjustments/list.html` (см. блок формирования класса бейджа)

### Итерация 36: Rules, Tasks v2, Incidents (29–30.10.2025) ✅
- **Rules Engine:** Единая система правил штрафов/премий
  - Роутер `/owner/rules` для управления правилами (late, cancel, task)
  - Депрекация legacy-полей (late_penalty_amount, cancellation_penalty) в Object/OrgUnit
  - Fallback на legacy-настройки для обратной совместимости
- **Tasks v2:** Новая архитектура задач
  - Роутеры: `/owner/tasks/*`, `/manager/tasks/*`, `/employee/tasks/my`
  - Модели: TaskTemplateV2, TaskPlanV2, TaskEntryV2
  - Планирование задач с периодичностью и множественным выбором объектов
  - Выполнение задач через бот с фото/видео отчётами
  - Автоматические начисления через Celery (task_bonuses)
  - Депрекация Object.shift_tasks (readonly + алерт)
- **Incidents:** MVP система инцидентов
  - Роутер `/owner/incidents` с базовым CRUD
  - Регистрация нарушений и проблем с медиа-доказательствами
- **Media Orchestrator:** Унифицированная работа с медиа
  - Единый сервис для всех медиа-потоков (задачи, отмены, инциденты)
- **Feature Keys Migration:**
  - Миграция ключей: bonuses_and_penalties → rules_engine, shift_tasks → tasks_v2
  - Backward compatibility через LEGACY_FEATURE_MAPPING
  - Добавлена фича `incidents` в system_features
- **Critical Bug Fixes:**
  - Исправлена инверсия статусов задач v2 при закрытии смены
  - Исправлены ошибки загрузки медиа для Tasks v2 (ImportError, AttributeError)
  - Исправлен created_by в task_bonuses (user_id=1 → 9)
  - Исправлен роутинг payroll-adjustments (двойной префикс)

### Итерации 32-35: Payroll и Contract Improvements
- Начисления (/owner/payroll): критические исправления системы начислений
  - Пересчёт с учётом привязанных корректировок (is_applied=true, payroll_entry_id!=NULL)
  - Поддержка monthly графиков с несколькими выплатами в месяц (payments_per_month > 1)
  - Создание новых начислений (не только обновление) через "Пересчитать вручную"
  - Детальный протокол расчёта (calculation_details) для всех начислений
  - Синхронизация логики celery и manual_recalculate
  - Отчёты: "Премия" → "Доплачено", "Штраф" → "Удержано"
  - Учёт корректировок без смены, привязанных к начислению (игнорируем created_at)
- Celery (core/celery/tasks/payroll_tasks.py):
  - Убран фильтр Contract.is_active (теперь только status)
  - Добавлена логика обновления существующих начислений
  - Расширенный фильтр корректировок (is_applied + зависшие + привязанные)
  - Формирование calculation_details с деталями смен и корректировок
  - Новая задача: task_bonuses для автоматических начислений за задачи v2
- Payment schedules (_get_payment_period_for_date):
  - Поддержка массива payments для monthly графиков
  - Корректная обработка is_end_of_month (месяцы с 28/30/31 днями)
  - Обратная совместимость со старым форматом (calc_rules)
- Contract Termination Settlement:
  - Финальные расчёты при расторжении договора
  - Режимы: по графику или в дату увольнения
  - Автоотмена плановых смен после увольнения

См. также: `doc/ITERATION_36_CHANGES.md`, `doc/vision_v1/entities/payroll.md`, `doc/plans/roadmap.md`.

### Дополнения (30.10.2025)
- Автооткрытие смен (Celery): actual_start устанавливается равным плановому началу тайм-слота. Поиск «следующей» смены при автооткрытии фильтруется по тому же объекту и точному времени (planned_start == planned_end закрытой).
- Бот (отчётные чаты): использовать `Object.get_effective_report_chat_id()` с наследованием от подразделения; в обработчиках загружать `Object` с `selectinload(Object.org_unit)` для избежания `MissingGreenlet`.
- Календарь (быстрое создание тайм-слота): объект берётся из фильтра `object_id` в URL; время подставляется по первой «дыре» между тайм-слотами внутри рабочего окна объекта; fallback — загрузка тайм‑слотов дня через `/owner/calendar/api/data` при отсутствии данных в памяти.
- Детали смены (Owner): для реальных смен вывод задач построен на `TaskEntryV2` (вместо legacy `shift_tasks`); удалён локальный импорт `selectinload`.

### Дополнения (31.10.2025)
- Tasks v2 — создание плана задач (Owner):
  - Новая полноэкранная страница: `GET /owner/tasks/plan/create` (шаблон `apps/web/templates/owner/tasks/plan_create.html`).
  - Кнопка в списке планов ведёт на страницу создания (вместо модального окна).
  - JS: `apps/web/static/js/tasks/plan_form.js` — переименования лейблов, предпросмотр ближайших назначений, реакции на периодичность.
- Периодичность/интервалы:
  - Безопасный парсинг `day_interval` в `apps/web/routes/owner_tasks.py` (минимум 1).
  - `recurrence_config` строго в форматах: `{weekdays:[...]}` или `{interval:N}`.
- Мгновенное назначение при активной смене:
  - При создании/редактировании плана создаются `TaskEntryV2`, привязанные к активным сменам (`shift_id`) на целевых объектах, чтобы задачи сразу появились в «Мои задачи».
- Уведомления сотруднику о новых задачах: РЕАЛИЗОВАНО (31.10.2025)
  - Telegram: при создании/редактировании плана и ручном назначении отправляется сообщение через `send_notification_now.delay()`.
  - In-App: создаются записи `Notification` для отображения в колокольчике.
  - API: `/api/notifications/unread-count`, `/api/notifications/list`, `/api/notifications/mark-all-read`.
  - Дропдаун колокольчика: показывает 10 последних уведомлений, кнопка «Отметить все как прочитанные».
  - Страница настроек уведомлений: `/owner/notifications/settings` (контролируется фичей `notifications_settings`).
  - Скрипты: `apps/web/static/js/shared/applications_badge.js` (пуллинг бейджа), `apps/web/static/js/shared/notifications_dropdown.js` (дропдаун).
  - Роуты: `apps/web/routes/notifications.py` (API + UI настроек владельца).