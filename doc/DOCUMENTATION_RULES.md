# Правила работы с техническим видением (обязательно к применению)

## Назначение
Единые правила, исключающие путаницу и рассинхронизацию между кодом и документацией. Эти правила обязательны для всех изменений.

## Куда смотреть при работе с кодом
- Веб-роуты/шаблоны по ролям: см. `doc/vision_v1/roles/*`
- Общие сущности (объекты, сотрудники, тайм-слоты, смены, отзывы, заявки, отчеты, лимиты/тарифы): см. `doc/vision_v1/entities/*`
- Общие компоненты и API (календарь, медиа, рейтинги, обжалования, системные настройки): см. `doc/vision_v1/shared/*`
- Бот (команды и callback-data): см. `doc/vision_v1/bot/README.md`
- Исторический контекст и архитектура: см. `doc/vision.md`

## Обязательная процедура при изменениях
1. Найти соответствующий раздел документации (см. выше) и убедиться, что он актуален для изменяемого кода.
2. Внести изменения в код (роуты, обработчики, шаблоны, сервисы) согласно правилам проекта.
3. ОБЯЗАТЕЛЬНО обновить документацию в `doc/vision_v1`:
   - Обновить списки эндпоинтов/шаблонов/JS.
   - Уточнить префиксы (`/owner`, `/manager`, `/employee`, `/admin`, `/moderator`) и причины возможных дублей.
   - В случае удаления/переноса роутов — немедленно удалить/перенести из документации.
4. Отправить изменения на ревью. После подтверждения владельцем проекта — смержить.

## Разрешение коллизий и дубликатов
- Если один и тот же путь встречается в нескольких ролях, в документации рядом указывать роль, источник файла и назначение.
- Для служебных редиректов добавлять пометку «редирект» и конечный URL.
- Для общих API указывать, что это shared-слой и ссылка на `doc/vision_v1/shared/*`.

## Формат аннотаций в документации
- Строка эндпоинта должна пояснять:
  - откуда подключен (файл),
  - роль/префикс,
  - назначение (редирект/страница/JSON API),
  - при дублировании — причину (например, «редирект», «меню роли», «общий API»).

## Контроль качества
- Любая правка роутов без одновременного обновления документации — нарушение правил.
- Перед коммитом: быстрый diff по `doc/vision_v1` и запуск автогенерации при необходимости.
- При обнаружении несоответствий — завести задачу на коррекцию документации.

## Недавние изменения (ветка feature/cancellation-reasons-bot-flow)

- Бот: обновлён флоу отмены смен сотрудником
  - Динамические причины из БД (`cancellation_reasons`) по владельцу (+ фолбэк на глобальные)
  - Финальное сообщение после отмены всегда отправляется отдельным сообщением
  - Сообщение для пользователя берётся из сервиса отмены (штрафы/модерация)
- Сервис отмены: мгновенная обработка неуважительных причин
  - «Уважительность» определяется по `treated_as_valid` у причины
  - Штраф «короткий срок» при `hours_before_shift < short_notice_hours` (наследование настроек объекта/подразделения)
  - Штраф «неуважительная причина» для всех неуважительных отмен (без модерации)
- Веб (PIN): понятная ошибка при `chat not found` — пользователю предлагается открыть `@ShiftsPlan_bot` и нажать Start
- Владелец: страница `/owner/cancellations/reasons` — настройка причин (видимость/уважительность/активность/порядок)

См. также: `doc/vision_v1/features/shift_cancellation.md` — уточнение логики штрафов и наследования.