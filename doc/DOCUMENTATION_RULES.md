# Правила работы с техническим видением (обязательно к применению)

## Назначение
Единые правила, исключающие путаницу и рассинхронизацию между кодом и документацией. Эти правила обязательны для всех изменений.

## Куда смотреть при работе с кодом
- Веб-роуты/шаблоны по ролям: см. `doc/vision_v1/roles/*`
- Общие сущности (объекты, сотрудники, тайм-слоты, смены, отзывы, заявки, отчеты, лимиты/тарифы): см. `doc/vision_v1/entities/*`
- Общие компоненты и API (календарь, медиа, рейтинги, обжалования, системные настройки): см. `doc/vision_v1/shared/*`
- Бот (команды и callback-data): см. `doc/vision_v1/bot/README.md`
- Исторический контекст и архитектура: см. `doc/vision.md`

## Обязательная процедура при изменениях
1. Найти соответствующий раздел документации (см. выше) и убедиться, что он актуален для изменяемого кода.
2. Внести изменения в код (роуты, обработчики, шаблоны, сервисы) согласно правилам проекта.
3. ОБЯЗАТЕЛЬНО обновить документацию в `doc/vision_v1`:
   - Обновить списки эндпоинтов/шаблонов/JS.
   - Уточнить префиксы (`/owner`, `/manager`, `/employee`, `/admin`, `/moderator`) и причины возможных дублей.
   - В случае удаления/переноса роутов — немедленно удалить/перенести из документации.
4. Отправить изменения на ревью. После подтверждения владельцем проекта — смержить.

## Разрешение коллизий и дубликатов
- Если один и тот же путь встречается в нескольких ролях, в документации рядом указывать роль, источник файла и назначение.
- Для служебных редиректов добавлять пометку «редирект» и конечный URL.
- Для общих API указывать, что это shared-слой и ссылка на `doc/vision_v1/shared/*`.

## Формат аннотаций в документации
- Строка эндпоинта должна пояснять:
  - откуда подключен (файл),
  - роль/префикс,
  - назначение (редирект/страница/JSON API),
  - при дублировании — причину (например, «редирект», «меню роли», «общий API»).

## Контроль качества
- Любая правка роутов без одновременного обновления документации — нарушение правил.
- Перед коммитом: быстрый diff по `doc/vision_v1` и запуск автогенерации при необходимости.
- При обнаружении несоответствий — завести задачу на коррекцию документации.

## Недавние изменения (main, 09.01.2026)

### Исправление отметки уведомлений как прочитанных и предотвращение дубликатов уведомлений об объектах ✅

**Статус:** Завершено (09.01.2026)
- **Проблемы:**
  1. Кнопка "Все прочитаны" в дропдауне колокольчика не работала - уведомления не помечались как прочитанные
  2. Кнопка "Отметить все как прочитанные" в центре уведомлений работала, но после обновления страницы уведомления снова становились непрочитанными
  3. Уведомления "Объект закрылся раньше" и "Объект открылся с опозданием" приходили каждые 10 минут вместо одного раза в день
- **Причины:**
  1. Метод `mark_all_as_read()` использовал SQLAlchemy `update()` с `cast()`, что не работало корректно для enum типов
  2. Кэш не инвалидировался полностью, из-за чего после обновления страницы уведомления снова показывались как непрочитанные
  3. Функция `_check_notification_exists()` не находила существующие уведомления, т.к. в `data` не было поля `"date"`, а сравнение JSONB полей работало некорректно
- **Решение:**
  1. **Метод `mark_all_as_read()`:**
     - Используется raw SQL `UPDATE` через `text()` для массового обновления статуса
     - Прямое обновление через `CAST(:status AS notificationstatus)` для надежности
  2. **Метод `mark_as_read()`:**
     - Аналогично используется raw SQL `UPDATE` для прямого обновления статуса
  3. **Инвалидация кэша:**
     - Упрощена инвалидация: используются паттерны `user_notifications:*` и `unread_count:*`
     - Это инвалидирует все ключи с этими префиксами
  4. **Автоматическое переключение фильтра:**
     - После отметки всех как прочитанных, если был выбран фильтр "Непрочитанные", он автоматически переключается на "Все"
  5. **Предотвращение дубликатов уведомлений об объектах:**
     - Добавлено поле `"date"` в `data` уведомлений при создании (`OBJECT_OPENED`, `OBJECT_LATE_OPENING`, `OBJECT_CLOSED`, `OBJECT_EARLY_CLOSING`)
     - Исправлена функция `_check_notification_exists()`: используется правильный синтаксис PostgreSQL для JSONB через оператор `->>` и `text()`
     - Проверка уникальности по `{"object_id": ..., "date": ...}` для каждого типа уведомления
- **Результаты:**
  - ✅ Кнопка "Все прочитаны" в дропдауне работает корректно
  - ✅ Кнопка "Отметить все как прочитанные" в центре уведомлений работает, уведомления остаются прочитанными после обновления страницы
  - ✅ Уведомления об объектах создаются только один раз в день для каждого объекта
- **Файлы:**
  - `shared/services/notification_service.py` — исправлены методы `mark_all_as_read()` и `mark_as_read()` с использованием raw SQL (~40 строк изменений)
  - `apps/web/static/js/shared/notifications_center.js` — добавлена логика автоматического переключения фильтра на "all" после отметки всех как прочитанных (~10 строк изменений)
  - `core/celery/tasks/reminder_tasks.py` — добавлено поле `"date"` в `data` уведомлений, исправлена функция `_check_notification_exists()` для работы с JSONB (~30 строк изменений)
- **Правила документации:**
  - При изменении логики отметки уведомлений как прочитанных использовать raw SQL для надежности
  - При работе с JSONB полями в PostgreSQL использовать оператор `->>` и `text()` для формирования условий
  - При создании уведомлений об объектах всегда включать поле `"date"` в `data` для проверки дубликатов
  - При инвалидации кэша использовать широкие паттерны для полной очистки

### Улучшение дашборда владельца: фильтрация активных объектов и столбец "Сотрудник" ✅

**Статус:** Завершено (09.01.2026)
- **Изменения:**
  1. Фильтрация объектов: на дашборде `/owner/` отображаются только активные объекты (`Object.is_active = True`)
  2. Новый столбец "Сотрудник": добавлен между столбцами "Статус" и "Время", отображает ФИО сотрудника (Фамилия Имя), который совершил действие, соответствующее времени в столбце "Время"
  3. Логика заполнения `work_employee`:
     - При открытии объекта: сотрудник из `opener_shift.user` (первая смена, открывшая объект)
     - При закрытии объекта: сотрудник из `last_shift.user` (последняя смена, закрывшая объект)
     - При статусе "Нет смен на объекте": прочерк (—)
     - Fallback: если `user` не загружен через `selectinload`, выполняется `session.refresh(shift, ['user'])` для загрузки
  4. Порядок вывода: сначала фамилия, потом имя (`last_name first_name`)
- **Результаты:**
  - ✅ На дашборде отображаются только активные объекты
  - ✅ Столбец "Сотрудник" корректно показывает ФИО сотрудника для всех статусов
  - ✅ Логика заполнения `work_employee` работает с fallback для загрузки `user`
- **Файлы:**
  - `apps/web/routes/owner.py` — добавлена фильтрация по `Object.is_active == True`, обновлена логика заполнения `work_employee` с fallback через `session.refresh` (~50 строк изменений)
  - `apps/web/templates/owner/dashboard.html` — добавлен столбец "Сотрудник" между "Статус" и "Время", обновлено отображение `work_employee` (~10 строк изменений)
- **Правила документации:**
  - При изменении логики дашборда учитывать, что отображаются только активные объекты
  - Столбец "Сотрудник" должен отображать ФИО сотрудника, который совершил действие, соответствующее времени в столбце "Время"
  - При работе с `work_employee` использовать fallback через `session.refresh` для загрузки `user`, если он не загружен через `selectinload`

### Исправление скрытия тайм-слотов для текущего дня с активными сменами ✅

**Статус:** Завершено (09.01.2026)
- **Проблема:** Тайм-слоты текущего дня с активными сменами не скрывались в календаре, хотя тайм-слот уже начался и занят. Условие `!has_free_track && current_employees > 0` не срабатывало, т.к. `current_employees=0` из-за того, что активные смены не учитывались при вычислении.
- **Причины:**
  1. Активные смены не учитывались при вычислении `current_employees` - они не проходили фильтр `allowed_shift_statuses` (только `PLANNED` и `CONFIRMED`)
  2. Условие скрытия на фронте требовало `current_employees > 0`, но для текущего дня достаточно `has_free_track=false`
  3. Активные смены в `fallback_candidates` не проверялись правильно (использовался `allowed_shift_statuses` вместо прямой проверки `status == ACTIVE`)
- **Решение:**
  - Активные смены теперь учитываются при вычислении `current_employees` - они регистрируются в `register_interval` даже если их статус не в `allowed_shift_statuses`
  - Условие скрытия на фронте обновлено: для текущего дня тайм-слот скрывается если `has_free_track=false`, даже если `current_employees=0`
  - Исправлена проверка активных смен в `fallback_candidates` - проверяется `status == ShiftStatus.ACTIVE` напрямую
  - Логика `has_free_track` для текущего дня: если тайм-слот уже начался и есть активные смены, то `has_free_track = False`
- **Результаты:**
  - ✅ Тайм-слоты текущего дня с активными сменами правильно скрываются
  - ✅ Активные смены учитываются при вычислении `current_employees`
  - ✅ Условие скрытия работает корректно для текущего дня
- **Файлы:**
  - `shared/services/calendar_filter_service.py` — исправлена регистрация активных смен для вычисления `current_employees`, обновлена логика `has_free_track` для текущего дня (~30 строк изменений)
  - `apps/web/templates/shared/calendar/grid_unified.html` — обновлено условие скрытия для текущего дня (~5 строк изменений)
- **Правила документации:**
  - При изменении логики отображения тайм-слотов учитывать, что для текущего дня условие скрытия работает по-другому: достаточно `has_free_track=false`
  - Активные смены должны учитываться при вычислении `current_employees`, даже если их статус не в `allowed_shift_statuses`
  - При проверке активных смен в `fallback_candidates` использовать прямую проверку `status == ShiftStatus.ACTIVE`

## Недавние изменения (main, 14.12.2025)

### Исправление автоматического обновления SSL-сертификатов (Iteration 53) ✅

**Статус:** Завершено (14.12.2025)
- **Проблема:** После успешного обновления SSL-сертификата через Celery задачу конфигурация Nginx не обновлялась автоматически. Certbot создавал новый сертификат в директории с суффиксом (например, `staffprobot.ru-0002`), но Nginx продолжал использовать старый путь.
- **Решение:**
  - Добавлен вызов `_find_certificate_path()` и `_update_nginx_certificate_path()` после успешного `certbot renew` в методе `renew_certificates()`
  - Автоматическое обновление конфигурации Nginx при изменении пути к сертификату (включая директории с суффиксами `-0001`, `-0002` и т.д.)
  - Проверено на проде: задача успешно получает сертификат и обновляет Nginx автоматически
- **Результаты:**
  - ✅ Автоматическое обновление конфигурации Nginx после успешного обновления сертификата
  - ✅ Поддержка директорий с суффиксами
  - ✅ Задача работает как при отсутствии сертификатов, так и при их истечении
- **Файлы:**
  - `apps/web/services/ssl_service.py` — добавлен вызов обновления конфигурации Nginx после успешного `certbot renew` (+5 строк)
- **Правила документации:**
  - При изменении логики обновления SSL-сертификатов учитывать, что Certbot может создавать новые директории с суффиксами
  - ВСЕГДА обновлять конфигурацию Nginx после успешного обновления сертификата
  - Использовать `_find_certificate_path()` для поиска актуального пути к сертификату (включая суффиксы)
  - При работе с SSL-сертификатами проверять работу на проде перед финализацией изменений

## Недавние изменения (main, 08.12.2025)

### Скрытие тайм-слотов с полным покрытием и фильтр подразделений с иерархией (Iteration 52, Фаза 1) ✅

**Статус:** Завершено (08.12.2025)
- **Проблемы:**
  1. Тайм-слоты с полностью запланированными сменами отображались в календаре
  2. Фильтр по подразделениям в мобильной версии не применялся к данным day view
  3. Дропдаун подразделений не показывал иерархию и не учитывал вложенные подразделения
- **Решение:**
  - Добавлены флаги `fully_occupied` и `has_free_track` в модель `CalendarTimeslot` для определения полного покрытия тайм-слота запланированными сменами и наличия свободных треков для активных смен
  - Логика проверки полного покрытия реализована в `_update_timeslot_statuses()`: если запланированная смена покрывает весь тайм-слот (от start_time до end_time), тайм-слот помечается как `fully_occupied`
  - Проверка треков для активных смен: если все треки заняты активными сменами по плану и нет свободного времени, `has_free_track = False`
  - Фильтрация на фронте в day view и month view: тайм-слоты скрываются если `fully_occupied = True` или `has_free_track = False`
  - API поддерживает `org_unit_ids` (массив ID через запятую) вместо устаревшего `org_unit_id`
  - На бэке при выборе подразделения автоматически получаются все потомки через `OrgStructureService._get_all_descendants()`
  - Дропдаун подразделений показывает иерархию с отступами и символами вложенности (├─)
  - Обновлены функции `filterByOrgUnit()` и `applyMobileFilters()` для использования `org_unit_ids`
- **Результаты:**
  - ✅ Тайм-слоты с полным покрытием сменами скрываются в day view и month view
  - ✅ Фильтр по подразделениям работает в мобильной версии day view
  - ✅ Дропдаун подразделений показывает иерархию и учитывает вложенные подразделения
- **Файлы:**
  - `shared/models/calendar_data.py` — добавлены флаги `fully_occupied` и `has_free_track`
  - `shared/services/calendar_filter_service.py` — логика проверки полного покрытия и треков (~30 строк)
  - `apps/web/routes/owner.py` — поддержка `org_unit_ids` с получением потомков (~40 строк)
  - `apps/web/static/js/shared/universal_calendar.js` — фильтрация тайм-слотов и поддержка `org_unit_ids` (~50 строк)
  - `apps/web/templates/shared/calendar/grid.html` — фильтрация в month view (~15 строк)
  - `apps/web/templates/shared/calendar/grid_unified.html` — иерархическое отображение подразделений (~10 строк)
- **Правила документации:**
  - При изменении логики отображения тайм-слотов учитывать флаги `fully_occupied` и `has_free_track` из API
  - При работе с фильтром подразделений использовать `org_unit_ids` (массив) вместо `org_unit_id` (одиночный ID)
  - При выборе подразделения в фильтре автоматически включаются все потомки через `_get_all_descendants()`
  - В дропдауне подразделений отображать иерархию с отступами и символами вложенности

### Исправление редактирования смен и адаптация календаря для мобильных (Iteration 52, Фаза 1) ✅

**Статус:** Завершено (07.12.2025)
- **Проблема:** 
  1. При редактировании запланированной смены бегунки не могли двигаться на свободное время до и после смены
  2. При переключении дня в дневном режиме возникала ошибка "Calendar grid not found"
  3. Календарь не был адаптирован для мобильных устройств
- **Решение:**
  - Исправлена логика определения свободного времени в режиме редактирования: редактируемая смена исключается из занятых интервалов, свободное время до и после неё правильно вычисляется и включается в `activeRange`
  - Исправлена инициализация бегунков: в режиме редактирования используются границы редактируемой смены, а не первый свободный интервал
  - Убрана лишняя обработка `onDataLoaded` в дневном виде календаря, что устранило ошибку "Calendar grid not found"
  - Реализована адаптация календаря для мобильных устройств: дневной вид по умолчанию, навигация по дням, поддержка свайпов, модальное окно фильтров
- **Результаты:**
  - ✅ Бегунки могут двигаться в пределах редактируемой смены и примыкающего свободного времени
  - ✅ Ошибка "Calendar grid not found" устранена
  - ✅ Календарь адаптирован для мобильных устройств с дневным видом
- **Файлы:**
  - `apps/web/static/js/shared/plan_shift_modal.js` — исправлена логика редактирования смен (~200 строк изменений)
  - `apps/web/static/js/shared/universal_calendar.js` — добавлена поддержка дневного вида и мобильной навигации (~300 строк)
  - `apps/web/templates/owner/calendar/index.html` — исправлена обработка кликов по сменам
- **Правила документации:**
  - При редактировании смен учитывать, что редактируемая смена не считается занятой и должна быть доступна для изменения вместе с примыкающим свободным временем
  - В дневном виде календаря не вызывать `onDataLoaded`, который предназначен для месячного вида
  - При адаптации календаря для мобильных использовать дневной вид по умолчанию с сохранением выбора в localStorage

### Исправление обработки корректировок без фильтра по allowed_objects (Iteration 52) ✅

**Статус:** Завершено (02.12.2025)
- **Проблема:** Корректировки для смен на объектах, доступ к которым был отозван после работы, не попадали в начисления. Например, смена 504 (объект 3) не попала в начисления для сотрудника 93, т.к. в договоре `allowed_objects=[1]` (объект 3 был удалён из доступа).
- **Причина:** Celery задача `create_payroll_entries_by_schedule` фильтровала договоры по условию `object_id in allowed_objects`, из-за чего корректировки для объектов, не входящих в текущий список доступа, игнорировались.
- **Решение:**
  - Изменена логика обработки: вместо поиска договоров по объектам → поиск договоров по владельцам объектов
  - Для каждого владельца находятся все активные договоры (без фильтра по `allowed_objects`)
  - Собираются ВСЕ неприменённые корректировки сотрудника за период (независимо от объекта)
  - Корректировки группируются по `object_id` и создаются отдельные начисления для каждого объекта
- **Результаты:**
  - ✅ Смена 504 (объект 3) теперь попадает в начисления для сотрудника 93
  - ✅ Создано 2 начисления: для объекта 1 (1,405₽) и объекта 3 (2,970₽)
  - ✅ Все 3 корректировки применены (shift_base для обоих объектов + late_start)
- **Файлы:**
  - `core/celery/tasks/payroll_tasks.py` — переработана логика обработки корректировок (~150 строк изменений)
- **Правила документации:**
  - При изменении логики начислений учитывать исторические данные: сотрудник должен получить начисление за смену, даже если доступ к объекту был отозван после работы
  - ВСЕГДА собирать корректировки по сотруднику, а не по объекту из `allowed_objects`
  - Группировать корректировки по `object_id` для создания отдельных начислений

### Исправление расчёта периодов для месячных графиков (Iteration 51) ✅

**Статус:** Завершено (02.12.2025)
- **Проблема:** Автоматические начисления не создавались для владельца 1170536174 (даты 25.11 и 10.12) из-за некорректной логики определения периодов в месячных графиках с несколькими выплатами.
- **Причины:**
  - Функция `get_payment_period_for_date` проверяла точное совпадение с устаревшим `next_payment_date` вместо дня месяца
  - Фиксированный `start_offset=-25` для второй выплаты давал разные результаты для месяцев с 30 и 31 днём (15.11 вместо 16.11 для ноября)
  - Периоды пересекались: 01.11-15.11 и 15.11-30.11 (15-е число дублировалось)
- **Решение:**
  - Изменена проверка дня выплаты: вместо `next_payment == target_date` используется `target_date.day == payment_day_of_month`
  - Для `is_start_of_month=True` берётся `schedule.payment_day`, для остальных - день из `next_payment_date`
  - Для `is_end_of_month=True` period_start вычисляется как день после окончания первой выплаты (16-е число), независимо от количества дней в месяце
  - period_end всегда последний день предыдущего месяца от даты выплаты
- **Результаты:**
  - ✅ Периоды без пересечений: 01-15 и 16-30/31 для всех месяцев
  - ✅ Weekly/biweekly графики не затронуты
  - ✅ Отображение на `/owner/payment-schedules/{id}/view` корректное
- **Файлы:**
  - `shared/services/payment_schedule_service.py` — исправлена логика определения дня выплаты и расчёта периодов для `is_end_of_month`
- **Правила документации:**
  - При изменении логики расчёта периодов обязательно тестировать на графиках с разным frequency (daily, weekly, monthly)
  - При работе с месячными графиками учитывать разное количество дней (28/29/30/31)
  - ВСЕГДА проверять что периоды не пересекаются (period1_end + 1 день = period2_start)

### Индивидуальные графики выплат и исправление начислений (Iteration 50) ✅

**Статус:** Завершено (02.12.2025)
- **Проблема:** Автоматические начисления не создавались для владельцев из-за ошибок в Celery задаче и отсутствия поддержки индивидуальных графиков выплат для сотрудников.
- **Причины:**
  - `NameError` в `payroll_tasks.py`: не инициализирована `total_entries_updated`, не импортирована `get_payment_period_for_date`
  - Celery задача искала только объекты с графиками, игнорируя сотрудников с индивидуальными графиками
  - Корректировки не были перенесены с прода на дэв
- **Решение:**
  - Исправлены критические ошибки в `core/celery/tasks/payroll_tasks.py`
  - Добавлено поле `inherit_payment_schedule` (Boolean, default=True) в модель `Contract`
  - Создан сервис `shared/services/contract_helper.py` с функцией `get_inherited_payment_schedule_id()` для цепочки наследования: Contract → Object → OrgUnit → Parent OrgUnit
  - Расширена Celery задача: добавлена обработка contracts с `inherit_payment_schedule=False` (~250 строк кода)
  - Перенесены 523 неприменённые корректировки с прода на дэв
- **Результаты:**
  - Создано 23 начисления на сумму 127,903.48 руб (22 по наследуемому графику + 1 по индивидуальному)
  - Применено 113 корректировок
  - Протестирована работа для обоих типов графиков
- **Файлы:**
  - `core/celery/tasks/payroll_tasks.py` — исправлены ошибки, добавлена обработка индивидуальных графиков (+250 строк)
  - `domain/entities/contract.py` — добавлено поле `inherit_payment_schedule`
  - `shared/services/contract_helper.py` — новый сервис для наследования графиков
  - `migrations/versions/ab7a492ca980_add_inherit_payment_schedule_to_.py` — миграция
- **Архитектура:**
  - Двухуровневая логика: наследование (`inherit_payment_schedule=True`) или индивидуальный график (`inherit_payment_schedule=False`)
  - Цепочка наследования: Contract → Object → OrgStructureUnit → Parent OrgUnit → Root
  - Приоритет: индивидуальный график > график объекта > график подразделения
- **Правила документации:**
  - При изменении логики начислений обязательно обновлять `doc/vision_v1/entities/payroll.md`
  - При добавлении новых полей в Contract обновлять `doc/vision_v1/entities/contracts.md`
  - При изменении Celery задач обновлять `doc/vision.md` (раздел Background Tasks)
  - ВСЕГДА использовать `get_inherited_payment_schedule_id()` для определения эффективного графика выплат

## Недавние изменения (main, 28.11.2025)

### Исправление колокольчика уведомлений на дашборде управляющего (Iteration 48) ✅

**Статус:** Завершено (28.11.2025)
- **Проблема:** На странице `/manager/dashboard` колокольчик уведомлений не работал - крутился кружок вместо показа сообщений, и в логах не было ошибок.
- **Причина:** Блок `{% block extra_js %}` в `manager/dashboard.html` переопределял родительский блок из `base_manager.html` без `{{ super() }}`, из-за чего скрипт `notifications_dropdown.js` не загружался.
- **Решение:** Добавлен `{{ super() }}` в начало блока `extra_js` в `manager/dashboard.html` для сохранения родительских скриптов.
- **Файлы:**
  - `apps/web/templates/manager/dashboard.html` — добавлен `{{ super() }}` в блок `extra_js`.
- **Правила документации:**
  - При переопределении блоков `extra_js`, `extra_css` и других в дочерних шаблонах ВСЕГДА использовать `{{ super() }}` для сохранения родительских скриптов/стилей, если они не должны быть полностью заменены.
  - При добавлении новых страниц с кастомными скриптами проверять, что родительские скрипты (например, `notifications_dropdown.js`) не затираются.

### Центр уведомлений (Notification Center) ✅

**Статус:** Завершено (owner + manager)
- **Новый функционал:**
  - Полноценная страница центра уведомлений с infinite scroll, фильтрацией и группировкой.
  - Доступ: `/owner/notifications/center` и `/manager/notifications/center`.
  - Кнопка "Показать все уведомления" в дропдауне колокольчика.
  - **Фильтры:** по статусу (все/непрочитанные/прочитанные), по категории (смены/договоры/объекты/отзывы/задачи/платежи/системные), сортировка (дата/приоритет), режим отображения (список/группировка).
  - **Действия:** отметить как прочитанное (одно/массово), удалить (одно/массово), перейти к связанному объекту.
  - **Визуальная иерархия:** непрочитанные (жирный шрифт, синяя граница), срочные (красная граница), прочитанные (серые).
  - **Infinite Scroll:** автоматическая подгрузка по 30 уведомлений при прокрутке.
  - **Группировка:** Accordion для категорий с счетчиками и иконками.
- **API endpoints (новые):**
  - `GET /api/notifications/center` — список уведомлений с пагинацией (параметры: limit, offset, type_filter, status_filter, sort_by).
  - `GET /api/notifications/center/grouped` — уведомления с группировкой по категориям (параметры: limit, offset, group_by).
  - `POST /api/notifications/{id}/mark-read` — отметить одно уведомление как прочитанное.
  - `POST /api/notifications/mark-read-bulk` — массовая отметка (body: {notification_ids: [...]}).
  - `POST /api/notifications/{id}/delete` — удалить одно уведомление.
  - `POST /api/notifications/delete-bulk` — массовое удаление (body: {notification_ids: [...]}).
  - `GET /api/notifications/{id}/action-url` — получить URL для перехода к связанному объекту.
- **Сервисы:**
  - `shared/services/notification_action_service.py` — определение action_url по типу уведомления и роли пользователя.
  - Обновлен `shared/services/notification_service.py` — добавлен параметр `sort_by` в `get_user_notifications`.
- **Frontend компоненты:**
  - `apps/web/templates/shared/notifications/center.html` — общий шаблон центра уведомлений.
  - `apps/web/static/js/shared/notifications_center.js` — JS класс NotificationCenter с логикой infinite scroll, группировки, фильтрации и массовых действий.
  - `apps/web/templates/owner/notifications/center.html` — страница для owner.
  - `apps/web/templates/manager/notifications/center.html` — страница для manager.
- **Интеграция:**
  - Обновлены `apps/web/templates/owner/base_owner.html` и `apps/web/templates/manager/base_manager.html` — добавлена кнопка "Показать все уведомления" в дропдаун колокольчика.
  - Роуты в `apps/web/routes/owner.py` и `apps/web/routes/manager.py`.
- **Правила документации:**
  - При добавлении новых типов уведомлений обновлять `domain/entities/notification.py` и `shared/services/notification_action_service.py` (маппинг типов на action_url).
  - При изменении API endpoints обновлять `doc/vision_v1/shared/notifications.md`.
  - При изменении UI/UX центра уведомлений обновлять `doc/vision_v1/shared/notifications.md` (раздел "Центр уведомлений").

### Расчётные листы уволенных сотрудников (Iteration 46) ✅

**Статус:** Завершено (owner + manager)
- **Новый функционал:**
  - Кнопка «Расчётный лист» в деталях сотрудника на `/owner/payroll` и `/manager/payroll`.
  - Маршруты:
    - `GET /owner/payroll/statement/{employee_id}` — просмотр отчёта (шаблон `owner/payroll/statement.html`).
    - `GET /owner/payroll/statement/{employee_id}/export` — выгрузка в Excel (ASCII filename, URL-encoded).
    - `GET /manager/payroll/statement/{employee_id}` / `.../export` — аналогичная функциональность для управляющего.
  - Shared-сервисы: `PayrollStatementService`, `PayrollGenerationService`, `PayrollStatementExporter`.
  - Логи: `payroll_statement_logs` (entity + миграция).
- **Правила документации:**
  - Любые правки в расчётных листах требуют обновления `doc/vision_v1/roles/owner.md`, `doc/vision_v1/roles/manager.md` и этой страницы (описание роутов и экспортов).
  - При изменении логики генерации начислений обязательно фиксировать сервисы в `doc/vision_v1/entities/payroll.md`.

### Синхронизация статусов Shift и ShiftSchedule (Iteration 44) ✅

**Статус:** Завершено
- **Матрица переходов статусов:**
  - Создана документация `doc/vision_v1/entities/shift_status_transitions.md` с полной матрицей переходов статусов
  - Стандартные статусы: `ShiftSchedule` (planned, confirmed (legacy), cancelled, completed), `Shift` (active, cancelled, completed)
  - Запрещенные комбинации: cancelled + active/completed, completed + active
- **ShiftStatusSyncService:**
  - Расширен методами `sync_on_shift_open()`, `sync_on_shift_close()`, `sync_on_shift_cancel()`, `sync_on_schedule_cancel()`
  - Интегрирован во все места изменения статусов (shared/services/shift_service.py, core/scheduler/shift_scheduler.py, apps/bot/services/shift_service.py, core/celery/tasks/shift_tasks.py, shared/services/shift_cancellation_service.py)
  - Добавлены проверки запрещенных комбинаций статусов
- **Устранены нестандартные статусы:**
  - `in_progress` заменен на использование синхронизации (расписание остается planned при открытии смены)
  - `auto_closed` заменен на `completed`
- **Тесты:**
  - Созданы unit-тесты `tests/unit/test_shift_status_sync_service.py` (12 тестов, все проходят)
- **Файлы:**
  - `shared/services/shift_status_sync_service.py` - расширен методами синхронизации
  - `shared/services/shift_service.py` - интегрирован ShiftStatusSyncService
  - `core/scheduler/shift_scheduler.py` - интегрирован ShiftStatusSyncService, заменен auto_closed на completed
  - `apps/bot/services/shift_service.py` - интегрирован ShiftStatusSyncService, удален нестандартный статус in_progress
  - `core/celery/tasks/shift_tasks.py` - интегрирован ShiftStatusSyncService, удален нестандартный статус in_progress
  - `shared/services/shift_cancellation_service.py` - обновлен для использования sync_on_schedule_cancel
  - `doc/vision_v1/entities/shift_status_transitions.md` - документация матрицы переходов

## Недавние изменения (main, 06.11.2025)

### Улучшения интерфейса (Login & Manager - Iteration 43) ✅

**Статус:** Фаза 2 завершена, Фаза 3 начата
- **Форма логина (`/auth/login`):**
  - Исправлена обработка PIN-кода: PIN остаётся в кэше до успешного входа, не удаляется при проверке
  - Добавлен метод `delete_pin()` для удаления PIN после успешного входа
  - Мобильная версия: кнопка "Получить код" только значком без текста (Bootstrap классы `d-none d-md-inline`)
- **Дашборд управляющего (`/manager/dashboard`):**
  - "Доступные объекты" → "Объекты" (кликабельная карточка, переход на `/manager/objects`)
  - "Активные смены" кликабельны (переход на `/manager/shifts?status=active&object_id=&dateRange=&date_from=&date_to=`)
  - "Сотрудники" кликабельны (переход на `/manager/employees`)
  - "Запланированные смены" → "Запланированные" (счетчик запланированных смен на сегодня из `ShiftSchedule`, кликабельная карточка с переходом в `/manager/calendar?scrollToToday=true`)
  - Удалена секция "Быстрые действия"
  - Исправлен подсчет сотрудников: учитываются только сотрудники с активными договорами у владельцев, с которыми есть активный контракт у управляющего
- **Календарь управляющего (`/manager/calendar`):**
  - Автоматический скролл на сегодняшний день при переходе с дашборда (параметр `scrollToToday=true`)
- **Страница объектов (`/manager/objects`):**
  - Убраны старые фильтры (карточка с фильтрами)
  - Убрано переключение вида (карточки/список), оставлена только таблица
  - Фильтрация по названию и адресу в заголовках таблицы (серверная с debounce 500 мс)
  - Сортировка при клике по столбцам (название, адрес, ставка, время работы, статус) с индикатором только на активном столбце
  - Пагинация как на `/owner/shifts/` (Первая, Назад, X / Y, Вперед, Последняя, выбор количества на странице 25/50/100)
  - Сохранение фокуса в фильтрах: фокус восстанавливается после перезагрузки страницы через sessionStorage (для серверных фильтров)
- **Страница сотрудников (`/manager/employees`):**
  - Фильтрация по ФИО в заголовке таблицы (клиентская, мгновенная)
  - Сортировка при клике по столбцам (name, phone, created_at) с индикатором только на активном столбце
  - Отображение сотрудника: "Фамилия Имя" (сортировка по фамилии, затем имени)
  - Пагинация как на `/owner/shifts/` (Первая, Назад, X / Y, Вперед, Последняя, выбор количества на странице 25/50/100)
  - Сохранение фокуса в фильтрах: фокус не теряется при вводе символов (для клиентских фильтров — `.focus()` после фильтрации, для серверных — восстановление через sessionStorage)
- **Страница редактирования договора (`/manager/contracts/{contract_id}/edit`):**
  - В разделе "Доступ к объектам" выводятся все объекты, доступные управляющему по договору, в котором есть объект из редактируемого договора сотрудника
  - Логика: определяется владелец объектов из договора сотрудника, находятся договоры управляющего с этими владельцами, выводятся все объекты из `allowed_objects` этих договоров
- **Страница смен сотрудника (`/manager/employees/{employee_id}/shifts`):**
  - Исправлено отображение времени смен с учетом временной зоны объекта
  - Время начала и окончания смены отображается в локальном времени объекта (через `web_timezone_helper.format_datetime_with_timezone`)
  - Исправлена ссылка на редактирование сотрудника: используется внутренний `user_id` вместо `telegram_id`
- **Страница планирования смен (`/manager/shifts/plan`):**
  - Полноэкранная страница планирования смен (общий `plan_shift.js`)
  - Показывает свободные интервалы по всем трекам тайм-слота, первый свободный диапазон выделен жирным
  - Раздел «Запланированные смены» (с бейджем «Запланировано») позволяет отметить смены для отмены прямо в форме
  - Использует API: `/manager/calendar/api/objects`, `/manager/api/employees/for-object/{objectId}` (возвращает `{"active": [...], "former": [...]}`; UI добавляет разделитель «Бывшие»), `/manager/calendar/api/data`, `/manager/api/calendar/check-availability`, `/manager/api/calendar/plan-shift`, `/manager/shifts/api/schedule/{schedule_id}/cancel`
  - `preselectedEmployeeId` подставляется при переходе с календаря (клик по смене/тайм-слоту)
  - Параметр `return_to` сохраняет фильтры (`object_id`) и возвращает на календарь/список смен
- **Календарь (`/manager/calendar`):**
  - Стартовая загрузка ограничена текущим месяцем; при прокрутке вызывается `loadMonthRange()` (текущий + следующий месяц)
  - Тайм-слоты → общая модалка `plan_shift_modal.js` (tabs по `max_employees`, автоматическое расширение свободного интервала)
  - Запланированные смены → `/manager/shifts/plan` с параметрами `employee_id`, `object_id`, `return_to`
  - Drag&drop панелей отключён; поддерживаются только клики
  - Endpoints: `/manager/calendar/api/timeslot/{timeslot_id}` возвращает занятость по трекам, `.../plan-shift` принимает частичные интервалы, очищает кэш (`calendar_shifts:*`, `api_response:*`)
- **Роуты:**
  - `GET /manager/dashboard` — обновлен (apps/web/routes/manager.py)
  - `GET /manager/objects` — обновлен (apps/web/routes/manager.py, добавлены query параметры для фильтрации, сортировки и пагинации)
  - `GET /manager/employees` — обновлен (apps/web/routes/manager.py, добавлены query параметры для фильтрации, сортировки и пагинации)
  - `GET /manager/calendar` — обновлен (apps/web/templates/manager/calendar.html)
  - `GET /manager/timeslots` — обновлен (apps/web/routes/manager_timeslots.py, табличное представление всех тайм-слотов с фильтрацией и сортировкой)
  - `GET /manager/shifts` — обновлен (apps/web/routes/manager.py)
    - Постоянная панель фильтров (статус, объект, период)
    - Клиентский фильтр по ФИО в заголовке таблицы (мгновенно)
    - Автоприменение серверных фильтров при изменении (без кнопки «Применить»)
    - Выбор периода с навигацией по месяцам в модальном календаре
    - Сортировка по клику, индикатор только у активного столбца
    - Отображение ФИО: «Фамилия Имя», сортировка по фамилии, затем имени
    - Пагинация как у владельца (Первая/Назад X/Y Вперед/Последняя, 25/50/100)
  - `POST /manager/timeslots/{timeslot_id}/delete` — добавлен (apps/web/routes/manager_timeslots.py, удаление одного тайм-слота)
  - `POST /manager/timeslots/bulk-edit` — обновлен (apps/web/routes/manager_timeslots.py, поддержка `cancel_late_penalties` — принудительно отключает `penalize_late_start`)
  
  Меню управляющего (navbar, `apps/web/templates/manager/base_manager.html`):
  - Убран пункт «Отзывы» (`/manager/reviews`)
  - Добавлен пункт «Задачи» (dropdown, временно скрыто):
    - «Шаблоны» — `/manager/tasks/templates`
    - «Планирование» — `/manager/tasks/plan`
    - «Аудит» — `/manager/tasks/entries`
  - Добавлен пункт «Инциденты» — `/manager/incidents` ✅
- **Шаблоны:**
  - `manager/dashboard.html` — обновлен (кликабельные карточки, удалена секция "Быстрые действия")
  - `manager/objects.html` — обновлен (фильтрация, сортировка, пагинация, кнопки очистки с белым цветом)
  - `manager/employees.html` — обновлен (фильтрация, сортировка, пагинация, отображение "Фамилия Имя", кнопки очистки с белым цветом)
  - `manager/calendar.html` — обновлен (автоскролл на сегодня)
  - `manager/timeslots/index.html` — обновлен (табличное представление всех тайм-слотов вместо карточек объектов, фильтрация по объекту и датам, сортировка по дате, времени, ставке)
  - `manager/timeslots/list.html` — обновлен (в массовом редактировании заменено поле «Игнорировать задачи объекта» на «Отменить штрафы за опоздания»)
  - `manager/timeslots/create.html` — обновлен (удалено поле «Игнорировать задачи объекта»)
  - `manager/timeslots/edit.html` — обновлен (удалено поле «Игнорировать задачи объекта»)
  - `manager/incidents/index.html` — новый (список инцидентов с фильтрацией, сортировкой и пагинацией)
  - `manager/incidents/create.html` — новый (форма создания инцидента с динамической загрузкой категорий и сотрудников)
  - `manager/incidents/edit.html` — новый (форма редактирования инцидента с историей изменений, запрет редактирования resolved/rejected)
- **Роуты инцидентов:**
  - `GET /manager/incidents` — список инцидентов (apps/web/routes/manager.py, фильтрация по объекту и статусу, сортировка, пагинация)
  - `GET /manager/incidents/create` — форма создания инцидента (apps/web/routes/manager.py)
  - `POST /manager/incidents/create` — создание инцидента (apps/web/routes/manager.py)
  - `GET /manager/incidents/{id}` — детали инцидента (apps/web/routes/manager.py, открывает форму редактирования)
  - `GET /manager/incidents/{id}/edit` — форма редактирования инцидента (apps/web/routes/manager.py)
  - `POST /manager/incidents/{id}/edit` — сохранение изменений (apps/web/routes/manager.py, перераспределение корректировок при смене сотрудника)
  - `POST /manager/incidents/{id}/status` — изменение статуса (apps/web/routes/manager.py, использует IncidentService.update_incident_status)
  - `GET /manager/incidents/api/categories` — API категорий по объекту (apps/web/routes/manager.py, JSONResponse)
- **Сервисы:**
  - `apps/web/services/auth_service.py` — изменена логика проверки PIN (не удаляется при проверке, только после успешного входа)
  - `apps/web/routes/auth.py` — добавлено удаление PIN после успешного входа
  - `shared/services/incident_service.py` — обновлен метод `update_incident`:
    - Проверка статуса: запрет редактирования resolved/rejected инцидентов
    - Перераспределение корректировок при смене сотрудника:
      - Старому сотруднику создается доплата (возврат удержания) с датой по логике доплат
      - Новому сотруднику создается удержание с датой по логике удержаний

### Улучшения интерфейса (Owner - Iteration 43) ✅

**Статус:** Завершено
- **Страница сотрудников (`/owner/employees`):**
  - Моментальная фильтрация по сотрудникам при вводе (без Enter) — клиентский фильтр
- **Страница объектов (`/owner/objects`):**
  - По умолчанию открывается в виде списка (`view_mode=list`)
  - Фильтрация по названию и адресу в заголовках столбцов (клиентский фильтр, мгновенный поиск)
  - Сортировка при клике по столбцам, индикатор только на активном столбце
- **Страница смен (`/owner/shifts`):**
  - Отображение сотрудника: "Фамилия Имя" с сортировкой по фамилии, затем имени
  - Фильтры в заголовках: клиентский фильтр по сотруднику (мгновенный поиск), серверные фильтры по объекту, датам и статусу
  - Поле дата — выбор периода (серверный фильтр)
  - Сортировка по столбцам, индикатор только на активном столбце
  - Пагинация как на `/owner/payroll/adjustments` с выбором количества на странице (25, 50, 100)
- **Страница тайм-слотов (`/owner/timeslots/`):**
  - Кнопки "Создать тайм-слот" и "Редактировать выбранные" всегда видимы
  - Массовое редактирование: добавлено поле "Отменить штрафы за опоздания"
  - Удалено поле "Игнорировать задачи объекта" из всех форм и модели
- **Страница начислений (`/owner/payroll`):**
  - Список сотрудников: сортировка по фамилии, затем имени
  - Фильтр по объектам вместо сотрудников, клиентский фильтр по ФИО в заголовке таблицы
  - Сортировка по полям ID, Сотрудник, Период с одним активным индикатором
  - Пагинация как на странице смен
- **Страница корректировок (`/owner/payroll/adjustments`):**
  - Для типа "Базовая оплата за смену" — ссылка на смену в столбце "Описание"
  - Ручные удержания и доплаты отображаются с человекочитаемыми типами (Налог, За результат, Сверхурочные)
- **Дашборд:**
  - Исправлена логика "Открыто с опозданием": учитываются только смены, начало которых совпадает с временем открытия объекта
  - Выводится ФИО сотрудника, который открыл объект вовремя (для всех статусов)
- **Сотрудники:**
  - Форма редактирования профиля: `/owner/employees/{id}/edit` (имя, фамилия, телефон, email, дата рождения)
  - Форма создания сотрудника: добавлены поля профиля, сохраняются в `User` при создании договора
- **Планирование смен:**
  - Новая страница `/owner/shifts/plan` вместо модального окна
  - API `/owner/shifts/api/schedule/{schedule_id}/object-id` для получения object_id из запланированной смены
  - Интеграция с календарем: при клике на запланированную смену открывается страница планирования с предзаполненным объектом
  - Параметр `return_to` для возврата на исходную страницу (календарь или список смен)
- **Роуты:**
  - `GET /owner/shifts` — список смен (apps/web/routes/owner_shifts.py)
  - `GET /owner/shifts/plan` — страница планирования смен (apps/web/routes/owner_shifts.py)
  - `GET /owner/shifts/api/schedule/{schedule_id}/object-id` — API для получения object_id (apps/web/routes/owner_shifts.py)
  - `GET /owner/employees/{employee_id}/edit` — форма редактирования профиля (apps/web/routes/owner.py)
  - `POST /owner/employees/{employee_id}/edit` — сохранение профиля (apps/web/routes/owner.py)
  - `GET /owner/objects` — список объектов (apps/web/routes/objects.py, обновлен)
- **Шаблоны:**
  - `owner/shifts/list.html` — обновлен (убрано модальное окно, добавлены фильтры и пагинация)
  - `owner/shifts/plan.html` — новый шаблон страницы планирования
  - `owner/employees/edit.html` — новый шаблон редактирования профиля
  - `owner/employees/create.html` — обновлен (добавлены поля профиля)
  - `owner/objects/list.html` — обновлен (клиентские фильтры, сортировка)
  - `owner/payroll/list.html` — обновлен (фильтр по объектам, клиентский фильтр по ФИО, пагинация)
  - `owner/payroll_adjustments/list.html` — обновлен (ссылка на смену, человекочитаемые типы)
  - `owner/timeslots/list_all.html` — обновлен (кнопки всегда видимы)
  - `owner/timeslots/create.html` — обновлен (удалено поле "Игнорировать задачи объекта")
  - `owner/timeslots/edit.html` — обновлен (удалено поле "Игнорировать задачи объекта")
  - `owner/timeslots/list.html` — обновлен (массовое редактирование: добавлено поле "Отменить штрафы за опоздания", удалено поле "Игнорировать задачи объекта")
  - `owner/dashboard.html` — обновлен (логика открытия, ФИО сотрудника)
  - `owner/calendar/index.html` — обновлен (интеграция с новой страницей планирования)

## Недавние изменения (main, 05.11.2025)

### Конфигурация Nginx — dev/prod режим и SSH ✅

Статус: Завершено
- UI: переключатель «Режим: production (SSH)», поля SSH (host/user/key), кнопка «Живой предпросмотр (host)».
- Backend: executor (локально/SSH) для генерации, валидации, применения и бэкапов.
- Dev: конфиги и backup’ы в `deployment/nginx/dev_out`; валидация без `nginx -t`.
- Prod: операции по SSH с `nginx -t` и `systemctl reload nginx`.
- Обновлён шаблон CSP для Яндекс.Карт.

### Исправление обработки геопозиции для Tasks v2 и открытия/закрытия смен ✅

**Статус:** Завершено
- **Проблема:** Конфликты области видимости переменных (`UnboundLocalError`) при обработке геопозиции в разных сценариях (открытие/закрытие смены, завершение задач Tasks v2)
- **Решение:** 
  - Добавлен глобальный импорт `User` в начало файла `core_handlers.py`
  - Убраны все локальные импорты классов `Shift`, `Object`, `User` из функции `handle_location`
  - Добавлено явное объявление `global Shift, Object, User, select` в начале функции для корректной работы Python
- **Результат:** Все сценарии обработки геопозиции работают корректно:
  - Открытие смены с гео (через "Открыть объект" или обычное открытие)
  - Закрытие смены с гео (через меню "Закрыть смену")
  - Завершение задачи Tasks v2 с требованием геопозиции
- **Файлы:**
  - `apps/bot/handlers_div/core_handlers.py` - исправлена логика обработки геопозиции

### Множественная загрузка медиа для задач Tasks v2 ✅

**Статус:** Завершено
- **Улучшения Media Orchestrator:**
  - Добавлены методы `get_collected_count()` и `can_add_more()` для проверки состояния медиа-потока
  - Поддержка загрузки до 5 файлов (фото/видео) для задач Tasks v2
  - Поддержка загрузки до 5 файлов для подтверждающих документов при отмене смены
- **Обработчики бота:**
  - Упрощен UX: пользователь просто отправляет файлы подряд, кнопка "✅ Готово" появляется после каждого файла
  - Убрана кнопка "➕ Добавить еще" - файлы добавляются автоматически при отправке
  - Исправлена ошибка с `caption` в `InputMediaPhoto`/`InputMediaVideo` (caption передается в конструктор)
  - Добавлено логирование всех этапов загрузки медиа
  - Исправлена race condition при параллельной обработке файлов (атомарное обновление user_state)
- **Отправка в группу:**
  - Функция `_send_multiple_media_to_group()` отправляет все файлы одним медиа-группой (для одинаковых типов) или отдельными сообщениями (для смешанных типов)
  - Все файлы сохраняются в `TaskEntryV2.completion_media` с URL и типом
- **Файлы:**
  - `shared/services/media_orchestrator.py` - добавлены методы проверки состояния потока
  - `apps/bot/handlers_div/shift_handlers.py` - улучшена логика обработки множественных файлов, исправлена отправка в группу
  - `apps/bot/handlers_div/schedule_handlers.py` - увеличено max_photos до 5 для документов отмены смены

### Исправление шаблонов поддержки для всех ролей ✅

**Статус:** Завершено
- **Исправлены шаблоны:**
  - `support/hub.html` — добавлены блоки `manager_content` и `content` для совместимости с разными базовыми шаблонами
  - `support/bug.html` — добавлены блоки `manager_content` и `content`
  - `support/faq.html` — добавлены блоки `manager_content` и `content`
  - `support/my_bugs.html` — добавлены блоки `manager_content` и `content`
- **Контекст шаблонов:**
  - Все шаблоны support используют динамический `base_template` (base_manager.html, base_employee.html, base_owner.html)
  - Для manager используется блок `manager_content`, для employee/owner — блок `content`
  - Добавлены переменные `applications_count` и `new_applications_count` в контекст всех support-роутов
- **Роуты:**
  - `GET /support` — (apps/web/routes/support.py) — доступен для owner, manager, employee
  - `GET /support/bug` — (apps/web/routes/support.py) — доступен для owner, manager, employee
  - `GET /support/faq` — (apps/web/routes/support.py) — доступен для owner, manager, employee
  - `GET /support/my-bugs` — (apps/web/routes/support.py) — доступен для owner, manager, employee
- **Документация:**
  - Обновлены `doc/vision_v1/roles/owner.md`, `doc/vision_v1/roles/manager.md`, `doc/vision_v1/roles/employee.md`

## Недавние изменения (main, 03.11.2025)

### DevOps Command Center (Iteration 41) ✅

**Статус:** Завершено, MVP реализован
- **Новые роуты:**
  - `GET /support` - Support Hub (хаб поддержки для всех ролей)
  - `GET /support/bug` - форма подачи бага
  - `GET /support/faq` - FAQ база знаний
  - `GET /support/my-bugs` - список моих багов
  - `GET /admin/devops` - DevOps Dashboard для owner/superadmin
- **Новые бот-команды:**
  - `/support` - меню поддержки
  - `/bug` - FSM форма подачи бага
  - `/faq` - быстрые ответы
  - `/morning` - утренний обзор (owner/superadmin)
  - `/devops` - DevOps панель (owner/superadmin)
- **Новые таблицы БД:**
  - `bug_logs` - отчеты о багах
  - `deployments` - история деплоев (авторегистрация через GitHub Actions)
  - `changelog_entries` - архитектурные изменения
  - `faq_entries` - FAQ база знаний
- **Новые сервисы:**
  - `GitHubService` - работа с GitHub Issues API
- **CI/CD:**
  - `.github/workflows/main.yml` - автоматический деплой на production
  - Регистрация деплоев в БД при успехе/провале (health check шаг)
  - Уведомления в Telegram
  - Настройка firewall для GitHub Actions SSH доступа
- **Документация:**
  - `doc/DEVOPS_COMMAND_CENTER.md` - полное описание компонентов
  - `doc/GITHUB_ACTIONS_SETUP.md` - настройка CI/CD

## Недавние изменения (main, 01.11.2025)

### Админ-панель биллинга - Табличные представления с сортировкой и фильтрацией (Iteration 39) ✅

**Статус:** Завершено, деплой на production выполнен, миграции применены
- **Обновлённые роуты:**
  - `GET /admin/billing/transactions` - список транзакций с фильтрацией (user_id, status, transaction_type) и сортировкой (id, created_at, transaction_type, status, amount)
  - `GET /admin/subscriptions/` - список подписок с фильтрацией (user_id, status, tariff_id) и сортировкой (id, user_id, status, created_at, expires_at)
  - `GET /admin/billing/usage` - метрики использования лимитов (исправлен доступ к tariff_plan через словарь)
- **Обновлённые шаблоны:**
  - `admin/billing_transactions.html` - табличное представление вместо карточек, пагинация (50 записей на страницу)
  - `admin/user_subscriptions.html` - табличное представление вместо карточек, пагинация (50 записей на страницу)
- **Технические улучшения:**
  - Серверная сортировка и фильтрация через URL параметры (`sort_by`, `sort_order`, `page`, `per_page`)
  - Исправлена обработка пустых строк в фильтрах (user_id, tariff_id принимаются как Optional[str])
  - Добавлен импорт `func` для подсчета общего количества транзакций
  - Исправлен доступ к `tariff_plan` в `check_usage_limits` (добавлена информация о тарифе в словарь подписки)
  - Опциональный импорт `yookassa` SDK для запуска без зависимости (проверки `YOOKASSA_AVAILABLE` во всех методах)
  - Миграции применены на production (Alembic upgrade head)

## Недавние изменения (main, 31.10.2025)

### Система уведомлений - Мета-информация типов (Iteration 37)
- **Новая таблица БД:** `notification_types_meta` (26 типов с полной мета-информацией)
- **Новые сервисы:**
  - `NotificationTypeMetaService` (`shared/services/notification_type_meta_service.py`) - управление типами
- **Обновлённые роуты:**
  - `GET /owner/notifications` - настройки уведомлений владельца (динамическая загрузка из мета-таблицы)
  - `POST /owner/notifications` - сохранение настроек (валидация через мета-таблицу)
- **Обновлённые шаблоны:**
  - `owner/notifications.html` - Accordion группировка по категориям (Смены, Договоры, Отзывы, Платежи)
- **Архитектура:**
  - Двухуровневая система: `NotificationType` (enum) + `NotificationTypeMeta` (БД)
  - 15 типов доступны для настройки владельцем (`is_user_configurable=True`)
  - 6 системных типов - только для админа (`is_admin_only=True`)
  - Единый источник истины для всех типов уведомлений
- **Категории:** shifts, contracts, reviews, payments, system, tasks, applications
- **Планируется:**
  - Админ-панель управления типами (`/admin/notifications/types`)
  - Интеграция мета-информации со статическими шаблонами

### Инциденты и корректировки (Owner - 30.10.2025)
- Обновлены роуты и шаблоны:
  - `/owner/incidents` — список, фильтры, кнопка «Категории», переход в редактирование
  - `/owner/incidents/create` — полноэкранная форма создания (Номер, Дата, Объект, Сотрудник, Ущерб)
  - `/owner/incidents/{id}/edit` — полноэкранная форма редактирования (локализованные статусы/критичность, выбор категории из списка, выбор Объект/Сотрудник)
  - `/owner/incidents/categories` — пользовательские категории владельца
- Автокорректировки при инцидентах:
  - При создании инцидента с ущербом — `PayrollAdjustment.adjustment_type=incident_deduction`, `details.incident_id=<id>`; дата берётся из пользовательской Даты
  - При переводе в «Решён» — создаётся `incident_refund` (возврат удержания)
- Отображение типов корректировок в `/owner/payroll/adjustments`:
  - Для новых типов `incident_deduction`/`incident_refund` необходимо настроить бейджи/цвета в шаблоне `apps/web/templates/owner/payroll_adjustments/list.html` (см. блок формирования класса бейджа)

### Итерация 36: Rules, Tasks v2, Incidents (29–30.10.2025) ✅
- **Rules Engine:** Единая система правил штрафов/премий
  - Роутер `/owner/rules` для управления правилами (late, cancel, task)
  - Депрекация legacy-полей (late_penalty_amount, cancellation_penalty) в Object/OrgUnit
  - Fallback на legacy-настройки для обратной совместимости
- **Tasks v2:** Новая архитектура задач
  - Роутеры: `/owner/tasks/*`, `/manager/tasks/*`, `/employee/tasks/my`
  - Модели: TaskTemplateV2, TaskPlanV2, TaskEntryV2
  - Планирование задач с периодичностью и множественным выбором объектов
  - Выполнение задач через бот с фото/видео отчётами
  - Автоматические начисления через Celery (task_bonuses)
  - Депрекация Object.shift_tasks (readonly + алерт)
- **Incidents:** MVP система инцидентов
  - Роутер `/owner/incidents` с базовым CRUD
  - Регистрация нарушений и проблем с медиа-доказательствами
- **Media Orchestrator:** Унифицированная работа с медиа
  - Единый сервис для всех медиа-потоков (задачи, отмены, инциденты)
- **Feature Keys Migration:**
  - Миграция ключей: bonuses_and_penalties → rules_engine, shift_tasks → tasks_v2
  - Backward compatibility через LEGACY_FEATURE_MAPPING
  - Добавлена фича `incidents` в system_features
- **Critical Bug Fixes:**
  - Исправлена инверсия статусов задач v2 при закрытии смены
  - Исправлены ошибки загрузки медиа для Tasks v2 (ImportError, AttributeError)
  - Исправлен created_by в task_bonuses (user_id=1 → 9)
  - Исправлен роутинг payroll-adjustments (двойной префикс)

### Итерации 32-35: Payroll и Contract Improvements
- Начисления (/owner/payroll): критические исправления системы начислений
  - Пересчёт с учётом привязанных корректировок (is_applied=true, payroll_entry_id!=NULL)
  - Поддержка monthly графиков с несколькими выплатами в месяц (payments_per_month > 1)
  - Создание новых начислений (не только обновление) через "Пересчитать вручную"
  - Детальный протокол расчёта (calculation_details) для всех начислений
  - Синхронизация логики celery и manual_recalculate
  - Отчёты: "Премия" → "Доплачено", "Штраф" → "Удержано"
  - Учёт корректировок без смены, привязанных к начислению (игнорируем created_at)
- Celery (core/celery/tasks/payroll_tasks.py):
  - Убран фильтр Contract.is_active (теперь только status)
  - Добавлена логика обновления существующих начислений
  - Расширенный фильтр корректировок (is_applied + зависшие + привязанные)
  - Формирование calculation_details с деталями смен и корректировок
  - Новая задача: task_bonuses для автоматических начислений за задачи v2
- Payment schedules (_get_payment_period_for_date):
  - Поддержка массива payments для monthly графиков
  - Корректная обработка is_end_of_month (месяцы с 28/30/31 днями)
  - Обратная совместимость со старым форматом (calc_rules)
- Contract Termination Settlement:
  - Финальные расчёты при расторжении договора
  - Режимы: по графику или в дату увольнения
  - Автоотмена плановых смен после увольнения

См. также: `doc/ITERATION_36_CHANGES.md`, `doc/vision_v1/entities/payroll.md`, `doc/plans/roadmap.md`.

### Дополнения (30.10.2025)
- Автооткрытие смен (Celery): actual_start устанавливается равным плановому началу тайм-слота. Поиск «следующей» смены при автооткрытии фильтруется по тому же объекту и точному времени (planned_start == planned_end закрытой).
- Бот (отчётные чаты): использовать `Object.get_effective_report_chat_id()` с наследованием от подразделения; в обработчиках загружать `Object` с `selectinload(Object.org_unit)` для избежания `MissingGreenlet`.
- Календарь (быстрое создание тайм-слота): объект берётся из фильтра `object_id` в URL; время подставляется по первой «дыре» между тайм-слотами внутри рабочего окна объекта; fallback — загрузка тайм‑слотов дня через `/owner/calendar/api/data` при отсутствии данных в памяти.
- Детали смены (Owner): для реальных смен вывод задач построен на `TaskEntryV2` (вместо legacy `shift_tasks`); удалён локальный импорт `selectinload`.

### Дополнения (31.10.2025)
- Tasks v2 — создание плана задач (Owner):
  - Новая полноэкранная страница: `GET /owner/tasks/plan/create` (шаблон `apps/web/templates/owner/tasks/plan_create.html`).
  - Кнопка в списке планов ведёт на страницу создания (вместо модального окна).
  - JS: `apps/web/static/js/tasks/plan_form.js` — переименования лейблов, предпросмотр ближайших назначений, реакции на периодичность.
- Периодичность/интервалы:
  - Безопасный парсинг `day_interval` в `apps/web/routes/owner_tasks.py` (минимум 1).
  - `recurrence_config` строго в форматах: `{weekdays:[...]}` или `{interval:N}`.
- Мгновенное назначение при активной смене:
  - При создании/редактировании плана создаются `TaskEntryV2`, привязанные к активным сменам (`shift_id`) на целевых объектах, чтобы задачи сразу появились в «Мои задачи».
- Уведомления сотруднику о новых задачах: РЕАЛИЗОВАНО (31.10.2025)
  - Telegram: при создании/редактировании плана и ручном назначении отправляется сообщение через `send_notification_now.delay()`.
  - In-App: создаются записи `Notification` для отображения в колокольчике.
  - API: `/api/notifications/unread-count`, `/api/notifications/list`, `/api/notifications/mark-all-read`.
  - Дропдаун колокольчика: показывает 10 последних уведомлений, кнопка «Отметить все как прочитанные».
  - Страница настроек уведомлений: `/owner/notifications/settings` (контролируется фичей `notifications_settings`).
  - Скрипты: `apps/web/static/js/shared/applications_badge.js` (пуллинг бейджа), `apps/web/static/js/shared/notifications_dropdown.js` (дропдаун).
  - Роуты: `apps/web/routes/notifications.py` (API + UI настроек владельца).