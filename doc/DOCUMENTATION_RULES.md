# Правила работы с техническим видением (обязательно к применению)

## Назначение
Единые правила, исключающие путаницу и рассинхронизацию между кодом и документацией. Эти правила обязательны для всех изменений.

## Куда смотреть при работе с кодом
- Веб-роуты/шаблоны по ролям: см. `doc/vision_v1/roles/*`
- Общие сущности (объекты, сотрудники, тайм-слоты, смены, отзывы, заявки, отчеты, лимиты/тарифы): см. `doc/vision_v1/entities/*`
- Общие компоненты и API (календарь, медиа, рейтинги, обжалования, системные настройки): см. `doc/vision_v1/shared/*`
- Бот (команды и callback-data): см. `doc/vision_v1/bot/README.md`
- Исторический контекст и архитектура: см. `doc/vision.md`

## Обязательная процедура при изменениях
1. Найти соответствующий раздел документации (см. выше) и убедиться, что он актуален для изменяемого кода.
2. Внести изменения в код (роуты, обработчики, шаблоны, сервисы) согласно правилам проекта.
3. ОБЯЗАТЕЛЬНО обновить документацию в `doc/vision_v1`:
   - Обновить списки эндпоинтов/шаблонов/JS.
   - Уточнить префиксы (`/owner`, `/manager`, `/employee`, `/admin`, `/moderator`) и причины возможных дублей.
   - В случае удаления/переноса роутов — немедленно удалить/перенести из документации.
4. Отправить изменения на ревью. После подтверждения владельцем проекта — смержить.

## Разрешение коллизий и дубликатов
- Если один и тот же путь встречается в нескольких ролях, в документации рядом указывать роль, источник файла и назначение.
- Для служебных редиректов добавлять пометку «редирект» и конечный URL.
- Для общих API указывать, что это shared-слой и ссылка на `doc/vision_v1/shared/*`.

## Формат аннотаций в документации
- Строка эндпоинта должна пояснять:
  - откуда подключен (файл),
  - роль/префикс,
  - назначение (редирект/страница/JSON API),
  - при дублировании — причину (например, «редирект», «меню роли», «общий API»).

## Контроль качества
- Любая правка роутов без одновременного обновления документации — нарушение правил.
- Перед коммитом: быстрый diff по `doc/vision_v1` и запуск автогенерации при необходимости.
- При обнаружении несоответствий — завести задачу на коррекцию документации.

## Недавние изменения (main, 29.10.2025)

- Начисления (/owner/payroll): критические исправления системы начислений
  - Пересчёт с учётом привязанных корректировок (is_applied=true, payroll_entry_id!=NULL)
  - Поддержка monthly графиков с несколькими выплатами в месяц (payments_per_month > 1)
  - Создание новых начислений (не только обновление) через "Пересчитать вручную"
  - Детальный протокол расчёта (calculation_details) для всех начислений
  - Синхронизация логики celery и manual_recalculate
  - Отчёты: "Премия" → "Доплачено", "Штраф" → "Удержано"
  - Учёт корректировок без смены, привязанных к начислению (игнорируем created_at)
- Celery (core/celery/tasks/payroll_tasks.py):
  - Убран фильтр Contract.is_active (теперь только status)
  - Добавлена логика обновления существующих начислений
  - Расширенный фильтр корректировок (is_applied + зависшие + привязанные)
  - Формирование calculation_details с деталями смен и корректировок
- Payment schedules (_get_payment_period_for_date):
  - Поддержка массива payments для monthly графиков
  - Корректная обработка is_end_of_month (месяцы с 28/30/31 днями)
  - Обратная совместимость со старым форматом (calc_rules)

См. также: `doc/vision_v1/entities/payroll.md`, `doc/plans/roadmap.md` — Итерация 36.