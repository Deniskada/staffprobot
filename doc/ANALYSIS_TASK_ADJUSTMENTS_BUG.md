# Анализ и исправление: Bug корректировок за задачи

**Дата**: 2025-10-16 (вечер/ночь)  
**Статус**: ✅ Исправлено  
**Коммит**: 83c46f3

---

## 🔴 Проблема

На production после деплоя **коммита c05a40e** "Исправление: инвалидация кэша календаря..." корректировки за задачи (`task_bonus`, `task_penalty`) **перестали создаваться**.

Симптомы:
- ✅ `shift_base` — создавалась корректно
- ✅ `late_start` штраф за опоздания — создавался корректно
- ❌ `task_bonus` (премия за выполнение) — **НЕ создавалась**
- ❌ `task_penalty` (штраф за невыполнение) — **НЕ создавалась**

---

## 🔎 Диагностика: От заблуждения к истине

### Этап 1: Первый анализ (неправильный)

**Гипотеза**: Completed_tasks не сохраняются в `shift.notes`, поэтому Celery ничего не видит.

**Проверка**: В dev изменил логику в `core_handlers.py` для сохранения `completed_tasks` перед `close_shift()`.

**Результат**: Создал 4 новые проблемы:
1. Задачи из тайм-слота опять не отображаются ❌
2. Закрытые задачи показаны как незакрытые ❌
3. При закрытии смены — ошибка "Непредвиденная ситуация" ❌
4. Пошли кругом по одной проблеме весь день ❌

**Вывод**: Это был неправильный путь анализа.

### Этап 2: Глубокий анализ (правильный)

**Методика**:
1. Откатил все мои изменения до версии prod (c59bbf0) — там БЫЛа корректная логика сохранения
2. Сравнил версию c05a40e~1 с c05a40e — что изменилось в Celery задаче
3. Нашел разницу в `adjustment_tasks.py` строке 181

**Root Cause Found**: 

В коммите c05a40e при рефакторинге загрузки задач была ошибка:

```python
# Старый код (c05a40e~1) - читал из JSONB
if shift.time_slot.shift_tasks:
    for task in shift.time_slot.shift_tasks:
        shift_tasks.append(task)

# Новый код (c05a40e) - читает из таблицы
template_query = sql_select(TimeslotTaskTemplate).where(...)
template_result = session.execute(template_query)  # ❌ БЕЗ await!
templates = template_result.scalars().all()
```

**Проблема**: `session.execute()` — это **асинхронный** метод, но его вызывают **синхронно**!

В асинхронной Celery задаче это приводит к:
- Ошибке или None возврату
- `template_result` = None
- `templates = []` (пустой список)
- Условие `if shift_tasks:` (строка 207) **НЕ выполняется**
- Цикл обработки задач (строки 235-355) **никогда не работает**
- Корректировки за задачи **не создаются**

---

## ✅ Fix

### Изменение 1: Добавлен `await`

**Файл**: `core/celery/tasks/adjustment_tasks.py` строка 181

```python
# ДО (❌)
template_result = session.execute(template_query)

# ПОСЛЕ (✅)
template_result = await session.execute(template_query)
```

### Изменение 2: Откачены некорректные изменения в `core_handlers.py`

Восстановлена версия из c59bbf0, которая **уже содержала** правильную логику сохранения `completed_tasks` в `shift.notes`.

### Восстановленные контейнеры

```bash
docker compose -f docker-compose.dev.yml restart bot celery_worker celery_beat
```

---

## 📊 Root Cause Analysis

```
┌─────────────────────────────────────────┐
│ Рефакторинг c05a40e                     │
│ (JSONB -> TimeslotTaskTemplate)         │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ Забыт `await` перед session.execute()   │
│ (асинхронный вызов в async контексте)   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ template_result = None или ошибка       │
│ shift_tasks остается пустым []          │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ Блок if shift_tasks (строка 207)        │
│ НЕ выполняется                          │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ Цикл обработки задач (235-355)          │
│ НИКОГДА не работает                     │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ ❌ task_bonus / task_penalty             │
│   НЕ создаются                          │
└─────────────────────────────────────────┘
```

---

## 🧪 Тестирование

План тестирования сохранён в: `doc/TEST_PLAN_TASK_ADJUSTMENTS.md`

### Быстрая проверка

1. **Открыть смену с задачей** (стоимость +100)
2. **Выполнить задачу** и **закрыть смену**
3. **Проверить shift.notes**:
   ```bash
   SELECT notes FROM shifts WHERE id = <ID>;
   ```
   Должно содержать: `[TASKS]{"completed_tasks": [0], "task_media": {}}`

4. **Дождаться 10 минут** (или запустить Celery вручную)

5. **Проверить корректировки**:
   ```bash
   SELECT adjustment_type, amount FROM payroll_adjustments 
   WHERE shift_id = <ID>;
   ```
   
   **Ожидается**:
   - `shift_base` | 99.00
   - `task_bonus` | 100.00

---

## 📚 Документация

- **Подробный анализ**: `doc/TIMESLOT_TASKS_REFACTORING.md`
- **План тестирования**: `doc/TEST_PLAN_TASK_ADJUSTMENTS.md`
- **Коммит**: `83c46f3` с полным описанием

---

## ⚠️ Уроки

1. **Async/await требует внимания**: В асинхронных контекстах (Celery, async функции) нужно ВСЕГДА использовать `await` для асинхронных методов.

2. **Глубокий анализ важнее поверхностного fix**: Первый импульс часто неправильный. Нужно понять root cause, прежде чем менять код.

3. **Коммиты перед деплоем требуют review**: Такие critical changes как рефакторинг загрузки данных должны пройти тщательный review, особенно в Celery задачах.

4. **Документация спасает**: Наличие `doc/TIMESLOT_TASKS_REFACTORING.md` помогло быстро разобраться в истории изменений.

