# üìã –§–ê–ó–ê 2: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á

**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞**: 2025-10-16 (–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ CRITICAL  
**–í—Ä–µ–º—è**: 1-2 —á–∞—Å–∞  
**–°—Ç–∞—Ç—É—Å**: üìù Planning

---

## üéØ –¶–µ–ª—å –§–∞–∑—ã 2

–°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `_collect_shift_tasks()` –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –≤–µ–∑–¥–µ –≤–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞.

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?

- **DRY –Ω–∞—Ä—É—à–µ–Ω–∏–µ**: –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 4+ —Ä–∞–∑–∞
- **–ë–∞–≥–∏**: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤–µ–∑–¥–µ
- **Maintenance**: –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **Ready for –§–∞–∑—ã 3-4**: –ë–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ–ª—å–∑—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–±—ä–µ–∫—Ç–∞

---

## üîç –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á?

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ‚ùå):

```
1. _handle_open_planned_shift() (shift_handlers.py:~650)
   ‚îî‚îÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–º–µ–Ω—ã

2. _handle_my_tasks() (shift_handlers.py:~1450)
   ‚îî‚îÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ "–ú–æ–∏ –∑–∞–¥–∞—á–∏"

3. _handle_close_object() (object_state_handlers.py)
   ‚îî‚îÄ ‚ùå –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç tasks –∏–∑ timeslot! –ü–†–û–ë–õ–ï–ú–ê!

4. handle_location() –≤ core_handlers.py (CLOSE_SHIFT –±–ª–æ–∫)
   ‚îî‚îÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ shift.notes

5. process_closed_shifts_adjustments() (adjustment_tasks.py:170-205)
   ‚îî‚îÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
```

### –ü–æ—Å–ª–µ –§–∞–∑—ã 2 (—É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è ‚úÖ):

–í—Å–µ –±—É–¥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å:
```python
all_tasks = await _collect_shift_tasks(session, shift, shift.time_slot, shift.object)
```

---

## üìê –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏

```python
async def _collect_shift_tasks(
    session: AsyncSession,
    shift: Shift,
    timeslot: Optional[TimeSlot] = None,
    object_: Optional[Object] = None
) -> List[Dict]:
    """
    –°–æ–±—Ä–∞—Ç—å –í–°–ï –∑–∞–¥–∞—á–∏ —Å–º–µ–Ω—ã –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
    
    Args:
        session: AsyncSession –¥–ª—è –ë–î –∑–∞–ø—Ä–æ—Å–æ–≤
        shift: –°–º–µ–Ω–∞ –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π —Å–æ–±–∏—Ä–∞–µ–º –∑–∞–¥–∞—á–∏
        timeslot: TimeSlot (–µ—Å–ª–∏ –µ—Å—Ç—å)
        object_: Object –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å shift_tasks
    
    Returns:
        –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (text, deduction_amount, source, etc)
    
    Logic:
        1. –ó–∞–¥–∞—á–∏ –∏–∑ timeslot (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ –Ω–µ ignore_object_tasks)
        2. –ó–∞–¥–∞—á–∏ –∏–∑ object (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
    """
```

---

## ‚úÖ Checklist –§–∞–∑—ã 2

### Step 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (30 –º–∏–Ω)
- [ ] –°–æ–∑–¥–∞—Ç—å `_collect_shift_tasks()` –≤ `shift_handlers.py`
- [ ] –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ 4 –º–µ—Å—Ç
- [ ] –î–æ–±–∞–≤–∏—Ç—å type hints –∏ docstring
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### Step 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–µ—Å—Ç–∞ #1 (10 –º–∏–Ω)
- [ ] `_handle_open_planned_shift()` ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_collect_shift_tasks()`
- [ ] –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ —Å–ª–æ–º–∞–ª–æ—Å—å –ª–∏

### Step 3: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–µ—Å—Ç–∞ #2 (10 –º–∏–Ω)
- [ ] `_handle_my_tasks()` ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_collect_shift_tasks()`
- [ ] –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥
- [ ] –¢–µ—Å—Ç

### Step 4: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–µ—Å—Ç–∞ #3 (10 –º–∏–Ω)
- [ ] `handle_location()` (CLOSE_SHIFT –±–ª–æ–∫) ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
- [ ] –¢–µ—Å—Ç

### Step 5: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–µ—Å—Ç–∞ #4 (10 –º–∏–Ω)
- [ ] `adjustment_tasks.py` ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Celery
- [ ] –¢–µ—Å—Ç

### Step 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (30 –º–∏–Ω)
- [ ] Dev: –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É ‚Üí –ú–æ–∏ –∑–∞–¥–∞—á–∏ ‚Üí –ó–∞–∫—Ä—ã—Ç—å ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- [ ] –ö–æ–º–º–∏—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–∞ dev:
1. –°–æ–∑–¥–∞—Ç—å —Å–º–µ–Ω—É —Å –∑–∞–¥–∞—á–∞–º–∏ (—Ç–∞–π–º-—Å–ª–æ—Ç + –æ–±—ä–µ–∫—Ç)
2. –û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É ‚Üí –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –æ–±–µ –∑–∞–¥–∞—á–∏
3. "–ú–æ–∏ –∑–∞–¥–∞—á–∏" ‚Üí –æ–±–µ –∑–∞–¥–∞—á–∏
4. –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–µ
5. –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å shift.notes
6. –î–æ–∂–¥–∞—Ç—å—Å—è Celery ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 2 –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –°–º–µ–Ω–∞ 339 —Å–æ–∑–¥–∞–ª–∞ **3 –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏** (–∫–∞–∫ –±—ã–ª–æ –≤ –§–∞–∑–µ 1 fix)
- –ù–æ–≤—ã–µ —Å–º–µ–Ω—ã —Ç–æ–∂–µ —Å–æ–∑–¥–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
- –û–±–Ω–æ–≤–∏—Ç—å `doc/BOT_UI_AUDIT.md` (–ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ fixed)
- –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ docstring
- –ö–æ–º–º–∏—Ç: "–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è: —Å–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è _collect_shift_tasks()"

---

## üéØ –ü–æ—Å–ª–µ –§–∞–∑—ã 2

–ú–æ–∂–Ω–æ –±—É–¥–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ:
- –§–∞–∑–∞ 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–±—ä–µ–∫—Ç–∞ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é)
- –§–∞–∑–∞ 4: –î–æ–±–∞–≤–∏—Ç—å UX —É–ª—É—á—à–µ–Ω–∏—è
- –§–∞–∑–∞ 5: Deploy –Ω–∞ prod

---

## üìö Reference

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- `apps/bot/handlers_div/shift_handlers.py` (—Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é + 2 –º–µ—Å—Ç–∞)
- `apps/bot/handlers_div/core_handlers.py` (1 –º–µ—Å—Ç–æ)
- `core/celery/tasks/adjustment_tasks.py` (1 –º–µ—Å—Ç–æ)

**Project Brain –∑–∞–ø—Ä–æ—Å**:
> "–ò—Å–ø–æ–ª—å–∑—É—è BOT_UI_AUDIT.md –∏ —Ç–µ–∫—É—â–∏–π –∫–æ–¥, —Å–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é _collect_shift_tasks() 
> –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –≤ –±–æ—Ç–µ. –ü–æ–∫–∞–∂–∏ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∏–∑ –≤—Å–µ—Ö 4 –º–µ—Å—Ç
> –≥–¥–µ –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞."

