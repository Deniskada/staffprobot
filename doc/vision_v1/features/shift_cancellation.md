# –°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω —Å —É—á–µ—Ç–æ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –≤—Å–µ—Ö –æ—Ç–º–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏, —Ä–∞—Å—á–µ—Ç–æ–º —à—Ç—Ä–∞—Ñ–æ–≤ –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è–º–∏ –∑–∞—Ä–ø–ª–∞—Ç—ã.

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 14.10.2025 - –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —à—Ç—Ä–∞—Ñ–æ–≤ (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏), –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å —Ñ–æ—Ç–æ, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã –≤ –±–æ—Ç–µ.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### –¢–∞–±–ª–∏—Ü–∞ `shift_cancellations`

–•—Ä–∞–Ω–∏—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–π –æ—Ç–º–µ–Ω–µ —Å–º–µ–Ω—ã:

- **–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è:**
  - `shift_schedule_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–º–µ–Ω—É
  - `employee_id` - —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, —á—å—è —Å–º–µ–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
  - `object_id` - –æ–±—ä–µ–∫—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—ã–ª–∞ —Å–º–µ–Ω–∞
  
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–º–µ–Ω–µ:**
  - `cancelled_by_id` - –∫—Ç–æ –æ—Ç–º–µ–Ω–∏–ª (user_id)
  - `cancelled_by_type` - —Ç–∏–ø –æ—Ç–º–µ–Ω–∏–≤—à–µ–≥–æ (employee/owner/manager/system)
  - `cancellation_reason` - –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã
  - `reason_notes` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏
  - `hours_before_shift` - –∑–∞ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –¥–æ —Å–º–µ–Ω—ã –±—ã–ª–∞ –æ—Ç–º–µ–Ω–∞
  
- **–£–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã (—Å–ø—Ä–∞–≤–∫–∏):**
  - `document_description` - –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–æ–º–µ—Ä, –¥–∞—Ç–∞)
  - `document_verified` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –ª–∏ —Å–ø—Ä–∞–≤–∫–∞
  - `verified_by_id`, `verified_at` - –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä–∏–ª
  
- **–®—Ç—Ä–∞—Ñ—ã:**
  - `fine_amount` - —Å—É–º–º–∞ —à—Ç—Ä–∞—Ñ–∞
  - `fine_reason` - –ø—Ä–∏—á–∏–Ω–∞ —à—Ç—Ä–∞—Ñ–∞ (short_notice/invalid_reason)
  - `fine_applied` - –ø—Ä–∏–º–µ–Ω–µ–Ω –ª–∏ –∫ —Ä–∞—Å—á–µ—Ç–Ω–æ–º—É –ª–∏—Å—Ç—É
  - `payroll_adjustment_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É
  
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
  - `contract_id` - –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –º–æ–º–µ–Ω—Ç –æ—Ç–º–µ–Ω—ã

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ç—Ä–∞—Ñ–æ–≤

#### –ü–æ–ª—è –≤ Object –∏ OrgStructureUnit:

- `inherit_cancellation_settings` - –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
- `cancellation_short_notice_hours` - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ –æ—Ç–º–µ–Ω—ã (—á–∞—Å–æ–≤)
- `cancellation_short_notice_fine` - —à—Ç—Ä–∞—Ñ –∑–∞ –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ (‚ÇΩ)
- `cancellation_invalid_reason_fine` - —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É (‚ÇΩ)

#### –ú–µ—Ç–æ–¥—ã:

- `object.get_cancellation_settings()` - –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —É—á–µ—Ç–æ–º –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
- `org_unit.get_inherited_cancellation_settings()` - –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è

#### –õ–æ–≥–∏–∫–∞ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:

1. –ï—Å–ª–∏ `inherit_cancellation_settings = False` –∏ –∑–∞–¥–∞–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ
2. –ò–Ω–∞—á–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)
3. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 24 —á–∞—Å–∞, –±–µ–∑ —à—Ç—Ä–∞—Ñ–æ–≤

## –¢–∏–ø—ã –ø—Ä–∏—á–∏–Ω –æ—Ç–º–µ–Ω—ã

### –ü—Ä–∏—á–∏–Ω—ã (`cancellation_reason`):

- **`short_notice`** - –æ—Ç–º–µ–Ω–∞ –≤ –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ (< X —á–∞—Å–æ–≤)
- **`no_reason`** - –æ—Ç–º–µ–Ω–∞ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã
- **`medical_cert`** ‚úÖ - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ (—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è, —Ç—Ä–µ–±—É–µ—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏)
- **`emergency_cert`** ‚úÖ - —Å–ø—Ä–∞–≤–∫–∞ –æ—Ç –ú–ß–° (—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è, —Ç—Ä–µ–±—É–µ—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏)
- **`police_cert`** ‚úÖ - —Å–ø—Ä–∞–≤–∫–∞ –æ—Ç –ø–æ–ª–∏—Ü–∏–∏ (—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è, —Ç—Ä–µ–±—É–µ—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏)
- **`owner_decision`** - —Ä–µ—à–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞/—É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ
- **`contract_termination`** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ –ø—Ä–∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞
- **`other`** - –¥—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –¢–∏–ø—ã –æ—Ç–º–µ–Ω–∏–≤—à–∏—Ö (`cancelled_by_type`):

- **`employee`** - —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ç–º–µ–Ω–∏–ª —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- **`owner`** - –≤–ª–∞–¥–µ–ª–µ—Ü –æ—Ç–º–µ–Ω–∏–ª —á–µ—Ä–µ–∑ –≤–µ–±
- **`manager`** - —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –æ—Ç–º–µ–Ω–∏–ª —á–µ—Ä–µ–∑ –≤–µ–±
- **`system`** - —Å–∏—Å—Ç–µ–º–∞ (–ø—Ä–∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞)

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –û—Ç–º–µ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º —á–µ—Ä–µ–∑ –±–æ—Ç–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "–ú–æ–∏ –ø–ª–∞–Ω—ã" (–æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ —Å–º–µ–Ω—ã)
2. –í—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É –¥–ª—è –æ—Ç–º–µ–Ω—ã
3. –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏—á–∏–Ω—ã:
   - üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞
   - üö® –°–ø—Ä–∞–≤–∫–∞ –æ—Ç –ú–ß–°
   - üëÆ –°–ø—Ä–∞–≤–∫–∞ –æ—Ç –ø–æ–ª–∏—Ü–∏–∏
   - ‚ùì –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞
4. **–î–ª—è —Å–ø—Ä–∞–≤–æ–∫ (1-3):**
   - –ó–∞–ø—Ä–æ—Å –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–æ–º–µ—Ä, –¥–∞—Ç–∞)
   - –ó–∞–ø—Ä–æ—Å —Ñ–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å `telegram_report_chat_id` —É –æ–±—ä–µ–∫—Ç–∞/–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è)
   - –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –≥—Ä—É–ø–ø—É –¢–ì
   - –ö–Ω–æ–ø–∫–∞ "‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ —Ñ–æ—Ç–æ
5. **–î–ª—è "–î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞":**
   - –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
   - –ó–∞–ø—Ä–æ—Å —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å `telegram_report_chat_id`)
   - –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –≥—Ä—É–ø–ø—É –¢–ì
6. –†–∞—Å—á–µ—Ç `hours_before_shift` (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è —É–∂–µ –Ω–∞—á–∞–≤—à–∏—Ö—Å—è —Å–º–µ–Ω)
7. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ `ShiftCancellation` **–ë–ï–ó —à—Ç—Ä–∞—Ñ–æ–≤** (–≤—Å–µ –æ—Ç–º–µ–Ω—ã –∏–¥—É—Ç –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é)
8. –°–º–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å `cancelled`
9. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "–°–º–µ–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞, –æ–∂–∏–¥–∞–µ—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏"
10. –í—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Europe/Moscow)

**–§–∞–π–ª—ã:**
- `apps/bot/handlers_div/schedule_handlers.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞
- `apps/bot/handlers_div/shift_handlers.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
- `apps/bot/handlers_div/utility_handlers.py` - —Ä–æ—É—Ç–∏–Ω–≥ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `shared/services/shift_cancellation_service.py` - –ª–æ–≥–∏–∫–∞ –æ—Ç–º–µ–Ω—ã
- `core/state/user_state_manager.py` - —Å–æ—Å—Ç–æ—è–Ω–∏—è (INPUT_DOCUMENT, INPUT_PHOTO)
- `core/utils/timezone_helper.py` - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏

### 2. –û—Ç–º–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º/—É–ø—Ä–∞–≤–ª—è—é—â–∏–º —á–µ—Ä–µ–∑ –≤–µ–±

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í–ª–∞–¥–µ–ª–µ—Ü/—É–ø—Ä–∞–≤–ª—è—é—â–∏–π –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–º–µ–Ω (`/owner/shifts` –∏–ª–∏ `/manager/shifts`)
2. –ù–∞–∂–∏–º–∞–µ—Ç "–û—Ç–º–µ–Ω–∏—Ç—å —Å–º–µ–Ω—É" –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
3. –í –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ:
   - –í—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
     - –†–µ—à–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
     - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
     - –ü—Ä–æ—Å—å–±–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
     - –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞
   - –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç `ShiftCancellation` —Å `cancelled_by_type = 'owner'/'manager'`
5. –®—Ç—Ä–∞—Ñ—ã –ù–ï –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è (–æ—Ç–º–µ–Ω–∞ –ø–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞)
6. –°–º–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å `cancelled`

**Endpoints:**
- `POST /owner/shifts/schedule/{schedule_id}/cancel` (Form: reason, notes)
- `POST /manager/shifts/schedule/{schedule_id}/cancel` (Form: reason, notes)

**–§–∞–π–ª—ã:**
- `apps/web/routes/cancellations.py` - —Ä–æ—É—Ç—ã –æ—Ç–º–µ–Ω—ã
- `apps/web/templates/owner/shifts/list.html` - –º–æ–¥–∞–ª –æ—Ç–º–µ–Ω—ã
- `apps/web/templates/owner/shifts/detail.html` - –º–æ–¥–∞–ª –æ—Ç–º–µ–Ω—ã
- `apps/web/templates/manager/shifts/list.html` - –º–æ–¥–∞–ª –æ—Ç–º–µ–Ω—ã
- `apps/web/templates/manager/shifts/detail.html` - –º–æ–¥–∞–ª –æ—Ç–º–µ–Ω—ã (–¥—É–±–ª–∏—Ä—É—é—â–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞)

### 3. –ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –ø—Ä–∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ —á–µ—Ä–µ–∑ `ContractService.terminate_contract_by_telegram_id()`
2. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–∫—Ä–æ–º–µ —Ä–∞—Å—Ç–æ—Ä–≥–∞–µ–º–æ–≥–æ)
3. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `lost_objects = terminated_contract.allowed_objects - remaining_objects`
4. –ü–æ–∏—Å–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω –Ω–∞ `lost_objects` —Å `planned_start > now()`
5. –î–ª—è –∫–∞–∂–¥–æ–π —Å–º–µ–Ω—ã:
   - `status = 'cancelled'`
   - –°–æ–∑–¥–∞–Ω–∏–µ `ShiftCancellation`:
     - `cancelled_by_type = 'system'`
     - `cancellation_reason = 'contract_termination'`
     - `reason_notes = "–†–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç –¥–æ–≥–æ–≤–æ—Ä ‚ÑñXXX. –ü—Ä–∏—á–∏–Ω–∞: ..."`
     - –ë–µ–∑ —à—Ç—Ä–∞—Ñ–æ–≤

**–§–∞–π–ª—ã:**
- `apps/web/services/contract_service.py::_cancel_shifts_on_contract_termination()`

### 4. –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í–ª–∞–¥–µ–ª–µ—Ü –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `/owner/cancellations`
2. –í–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ **–í–°–ï–•** –æ—Ç–º–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ (`cancelled_by_type = 'employee'`)
3. –î–ª—è –∫–∞–∂–¥–æ–π –æ—Ç–º–µ–Ω—ã:
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –æ–±—ä–µ–∫—Ç, –¥–∞—Ç–∞/–≤—Ä–µ–º—è, –ø—Ä–∏—á–∏–Ω–∞
   - –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (`reason_notes`) - –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
   - –ï—Å–ª–∏ –µ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (`document_description`) - –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
   - –°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –ö–Ω–æ–ø–∫–∏ "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" / "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å"
4. **–ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏:**
   - `document_verified = True`
   - –®—Ç—Ä–∞—Ñ—ã –ù–ï –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è
5. **–ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:**
   - `document_verified = False`
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —à—Ç—Ä–∞—Ñ–æ–≤ —á–µ—Ä–µ–∑ `object.get_cancellation_settings()` (—Å —É—á–µ—Ç–æ–º –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
   - –°–æ–∑–¥–∞–Ω–∏–µ **–î–í–£–•** –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —à—Ç—Ä–∞—Ñ–æ–≤ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã):
     - **–®—Ç—Ä–∞—Ñ 1:** –ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ (`cancellation_fine_short_notice`)
       - –ï—Å–ª–∏ `hours_before_shift < short_notice_hours`
       - –°—É–º–º–∞: `short_notice_fine` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000‚ÇΩ)
       - –û–ø–∏—Å–∞–Ω–∏–µ: "–®—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–º–µ–Ω—É —Å–º–µ–Ω—ã –º–µ–Ω–µ–µ —á–µ–º –∑–∞ X—á"
     - **–®—Ç—Ä–∞—Ñ 2:** –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ (`cancellation_fine_invalid_reason`)
       - –°—É–º–º–∞: `invalid_reason_fine` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2000‚ÇΩ)
       - –û–ø–∏—Å–∞–Ω–∏–µ: "–®—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–º–µ–Ω—É —Å–º–µ–Ω—ã –±–µ–∑ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã"
       - –î–ª—è "–î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞" + –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ: "...–±–µ–∑ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã. –û–±—ä—è—Å–Ω–µ–Ω–∏–µ: {—Ç–µ–∫—Å—Ç}"
   - –û–±–∞ —à—Ç—Ä–∞—Ñ–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ `payroll_adjustments`
   - –í —Ç–∞–±–ª–∏—Ü–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π —Ç–∏–ø –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ "–®—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–º–µ–Ω—É —Å–º–µ–Ω—ã"
   - –î–µ—Ç–∞–ª–∏ –≤ —Å—Ç–æ–ª–±—Ü–µ "–û–ø–∏—Å–∞–Ω–∏–µ"
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `cancellation.fine_amount = total`, `fine_reason = 'both'/'short_notice'/'invalid_reason'`

**Endpoints:**
- `GET /owner/cancellations` - —Å–ø–∏—Å–æ–∫ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
- `POST /owner/cancellations/{cancellation_id}/verify` - –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

**–§–∞–π–ª—ã:**
- `apps/web/routes/cancellations.py`
- `apps/web/templates/owner/cancellations/list.html`

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è–º–∏

### PayrollAdjustment —Ç–∏–ø—ã:

- `cancellation_fine` - –æ–±—â–∏–π —à—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–º–µ–Ω—É
- `cancellation_fine_short_notice` - —à—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–º–µ–Ω—É –º–µ–Ω–µ–µ —á–µ–º –∑–∞ X —á–∞—Å–æ–≤
- `cancellation_fine_invalid_reason` - —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:

```python
{
    "adjustment_type": "cancellation_fine_short_notice",
    "amount": -500.00,  # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ (–≤—ã—á–µ—Ç)
    "description": "–®—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç–º–µ–Ω—É —Å–º–µ–Ω—ã –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 12—á",
    "details": {
        "cancellation_id": 123,
        "shift_schedule_id": 456,
        "cancellation_reason": "short_notice",
        "hours_before_shift": 12.5,
        "planned_start": "2025-10-15T09:00:00"
    }
}
```

## –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

### GET /owner/analytics/cancellations

**–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏:**
- –í—Å–µ–≥–æ –æ—Ç–º–µ–Ω –∑–∞ –ø–µ—Ä–∏–æ–¥
- –°—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤ (–Ω–∞—á–∏—Å–ª–µ–Ω–æ/–ø—Ä–∏–º–µ–Ω–µ–Ω–æ)
- –ü—Ä–æ—Ü–µ–Ω—Ç —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –æ—Ç–º–µ–Ω–∏–≤—à–∏—Ö
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º
- –¢–æ–ø-10 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—Ç–º–µ–Ω
- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –æ—Ç–º–µ–Ω

**–§–∏–ª—å—Ç—Ä—ã:**
- –ü–µ—Ä–∏–æ–¥ (date_from, date_to)
- –û–±—ä–µ–∫—Ç
- –°–æ—Ç—Ä—É–¥–Ω–∏–∫

## API Reference

### ShiftCancellationService

#### `cancel_shift()`
```python
async def cancel_shift(
    shift_schedule_id: int,
    cancelled_by_user_id: int,
    cancelled_by_type: str,
    cancellation_reason: str,
    reason_notes: Optional[str] = None,
    document_description: Optional[str] = None,
    contract_id: Optional[int] = None
) -> Dict[str, Any]
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
    'success': bool,
    'cancellation_id': int or None,
    'fine_amount': Decimal or None,
    'message': str
}
```

#### `verify_cancellation_document()`
```python
async def verify_cancellation_document(
    cancellation_id: int,
    verified_by_user_id: int,
    is_approved: bool
) -> Dict[str, Any]
```

## –ú–∏–≥—Ä–∞—Ü–∏–∏

### 1. `add_shift_cancellations_table.py`
–°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `shift_cancellations` —Å–æ –≤—Å–µ–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏.

### 2. `add_cancellation_settings_fields.py`
–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —à—Ç—Ä–∞—Ñ–æ–≤ –∑–∞ –æ—Ç–º–µ–Ω—É –≤ `objects` –∏ `org_structure_units`.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ç—Ä–∞—Ñ–æ–≤ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞

1. –û—Ç–∫—Ä—ã—Ç—å `/owner/objects/{id}/edit`
2. –í —Å–µ–∫—Ü–∏–∏ "–®—Ç—Ä–∞—Ñ—ã –∑–∞ –æ—Ç–º–µ–Ω—É —Å–º–µ–Ω—ã":
   - –°–Ω—è—Ç—å –≥–∞–ª–æ—á–∫—É "–ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è" (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
   - –£–∫–∞–∑–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ –æ—Ç–º–µ–Ω—ã (—á–∞—Å–æ–≤): `24`
   - –£–∫–∞–∑–∞—Ç—å —à—Ç—Ä–∞—Ñ –∑–∞ –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫: `500‚ÇΩ`
   - –£–∫–∞–∑–∞—Ç—å —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É: `1000‚ÇΩ`
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

### –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Å–ø—Ä–∞–≤–æ–∫

1. –û—Ç–∫—Ä—ã—Ç—å `/owner/cancellations`
2. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ç–º–µ–Ω —Å —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–∏—á–∏–Ω–∞–º–∏
3. –î–ª—è –∫–∞–∂–¥–æ–π —Å–ø—Ä–∞–≤–∫–∏:
   - –ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
   - –ù–∞–∂–∞—Ç—å "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" –∏–ª–∏ "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å"
4. –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ —à—Ç—Ä–∞—Ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç—Å—è

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

1. –û—Ç–∫—Ä—ã—Ç—å `/owner/analytics/cancellations`
2. –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
3. –ù–∞–∂–∞—Ç—å "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
4. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
5. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel (TODO)

## TODO / –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ shift_cancellations
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ç—Ä–∞—Ñ–æ–≤ –≤ Object/OrgStructureUnit
- ‚úÖ –ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –ø—Ä–∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞
- ‚úÖ –û—Ç–º–µ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º —á–µ—Ä–µ–∑ –±–æ—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–∏—á–∏–Ω—ã
- ‚úÖ –û—Ç–º–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º/—É–ø—Ä–∞–≤–ª—è—é—â–∏–º —á–µ—Ä–µ–∑ –≤–µ–±
- ‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PayrollAdjustment
- ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç–º–µ–Ω
- ‚è≥ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–º–µ–Ω—ã
- ‚è≥ –≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ Excel
- ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–ø—Ä–∞–≤–æ–∫ (—Å–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
- ‚è≥ Celery –∑–∞–¥–∞—á–∞ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö —Å–ø—Ä–∞–≤–∫–∞—Ö (48—á)
- ‚è≥ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–º–µ–Ω—ã –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –æ—Ç–º–µ–Ω–∞—Ö –±–µ–∑ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω

## –ü—Ä–∏–º–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ç–º–µ–Ω—è–µ—Ç —Å–º–µ–Ω—É –∑–∞ 2 —á–∞—Å–∞ —Å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–æ–π

1. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤ –±–æ—Ç–µ: "–ú–æ–∏ —Å–º–µ–Ω—ã" ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç —Å–º–µ–Ω—É ‚Üí "–û—Ç–º–µ–Ω–∏—Ç—å"
2. –í—ã–±–∏—Ä–∞–µ—Ç "üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞"
3. –í–≤–æ–¥–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ: "‚Ññ123 –æ—Ç 13.10.2025"
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –°–º–µ–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ (`status = 'cancelled'`)
   - –°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å `ShiftCancellation`:
     - `hours_before_shift = 2`
     - `cancellation_reason = 'medical_cert'`
     - `document_description = "‚Ññ123 –æ—Ç 13.10.2025"`
   - –®—Ç—Ä–∞—Ñ –Ω–∞—á–∏—Å–ª–µ–Ω: 500‚ÇΩ (–∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫) + 1000‚ÇΩ (–Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞) = 1500‚ÇΩ
   - –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω: "–®—Ç—Ä–∞—Ñ 1500‚ÇΩ. –°–ø—Ä–∞–≤–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º"
   - –í–ª–∞–¥–µ–ª–µ—Ü —É–≤–µ–¥–æ–º–ª–µ–Ω –æ–± –æ—Ç–º–µ–Ω–µ
5. –í–ª–∞–¥–µ–ª–µ—Ü –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `/owner/cancellations`, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ø—Ä–∞–≤–∫—É
6. –ï—Å–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí —à—Ç—Ä–∞—Ñ —Å–Ω–∏–º–∞–µ—Ç—Å—è (amount = 0)
7. –ï—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç ‚Üí —à—Ç—Ä–∞—Ñ –æ—Å—Ç–∞–µ—Ç—Å—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –†–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞ —Å –∞–≤—Ç–æ–æ—Ç–º–µ–Ω–æ–π —Å–º–µ–Ω

1. –í–ª–∞–¥–µ–ª–µ—Ü —Ä–∞—Å—Ç–æ—Ä–≥–∞–µ—Ç –¥–æ–≥–æ–≤–æ—Ä —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º (–æ–±—ä–µ–∫—Ç—ã: [1, 2, 3])
2. –£ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –µ—Å—Ç—å –¥—Ä—É–≥–æ–π –∞–∫—Ç–∏–≤–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä (–æ–±—ä–µ–∫—Ç—ã: [2, 3, 4])
3. **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ:**
   - `remaining_objects = {2, 3, 4}`
   - `lost_objects = {1, 2, 3} - {2, 3, 4} = {1}`
4. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–º–µ–Ω—ã –Ω–∞ –æ–±—ä–µ–∫—Ç 1
5. –î–ª—è –∫–∞–∂–¥–æ–π —Å–º–µ–Ω—ã:
   - `status = 'cancelled'`
   - –°–æ–∑–¥–∞–µ—Ç `ShiftCancellation`:
     - `cancelled_by_type = 'system'`
     - `cancellation_reason = 'contract_termination'`
     - `reason_notes = "–†–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç –¥–æ–≥–æ–≤–æ—Ä ‚Ññ456. –ü—Ä–∏—á–∏–Ω–∞: –ø–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—é —Å—Ç–æ—Ä–æ–Ω"`
     - –ë–µ–∑ —à—Ç—Ä–∞—Ñ–æ–≤
6. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω –æ–± –æ—Ç–º–µ–Ω–µ —Å–º–µ–Ω

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –í–ª–∞–¥–µ–ª–µ—Ü –æ—Ç–º–µ–Ω—è–µ—Ç —Å–º–µ–Ω—É –∑–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞

1. –í–ª–∞–¥–µ–ª–µ—Ü –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–º–µ–Ω—ã `/owner/shifts/` –∏–ª–∏ `/owner/shifts/{id}` –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–º–µ–Ω–∏—Ç—å —Å–º–µ–Ω—É"
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–æ—Ä–º–æ–π:
   - –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏—á–∏–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
   - –ü–æ–ª–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. –í—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É "–ü—Ä–æ—Å—å–±–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
3. –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–º–µ—Ç–∫—É "–°–µ–º–µ–π–Ω—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞"
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –°–º–µ–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
   - `ShiftCancellation`:
     - `cancelled_by_type = 'owner'`
     - `cancellation_reason = 'employee_request'`
     - `reason_notes = "–°–µ–º–µ–π–Ω—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞"`
     - –ë–µ–∑ —à—Ç—Ä–∞—Ñ–æ–≤ (–≤–ª–∞–¥–µ–ª–µ—Ü –Ω–µ —à—Ç—Ä–∞—Ñ—É–µ—Ç)
   - –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω –æ–± –æ—Ç–º–µ–Ω–µ

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

- **–û—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞:** –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–º–µ–Ω—ã
- **–û—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –≤–µ–± (–≤–ª–∞–¥–µ–ª–µ—Ü):** –¢–æ–ª—å–∫–æ —Å–º–µ–Ω—ã –Ω–∞ —Å–≤–æ–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö
- **–û—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –≤–µ–± (—É–ø—Ä–∞–≤–ª—è—é—â–∏–π):** –¢–æ–ª—å–∫–æ —Å–º–µ–Ω—ã –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö
- **–ú–æ–¥–µ—Ä–∞—Ü–∏—è:** –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –æ–±—ä–µ–∫—Ç–∞ –º–æ–∂–µ—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–ø—Ä–∞–≤–∫–∏
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:** –¢–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º –≤–ª–∞–¥–µ–ª—å—Ü–∞

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ò–Ω–¥–µ–∫—Å—ã:**
  - `shift_schedule_id`, `employee_id` - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –æ—Ç–º–µ–Ω
  - `cancelled_by_type`, `cancellation_reason` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
  - `created_at` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º
  - `fine_applied` - –≤—ã–±–æ—Ä–∫–∞ –Ω–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö —à—Ç—Ä–∞—Ñ–æ–≤

- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ç—Ä–∞—Ñ–æ–≤ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–±—ä–µ–∫—Ç–∞ (–º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict)
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∞ –≤ Redis (TODO)

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏

- **Contracts:** –ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –ø—Ä–∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ (`contract_service.py::_cancel_shifts_on_contract_termination`)
- **Payroll:** –®—Ç—Ä–∞—Ñ—ã –∫–∞–∫ PayrollAdjustment (–æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —à—Ç—Ä–∞—Ñ–∞)
- **Notifications:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç–º–µ–Ω–µ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (TODO)
- **Analytics:** –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ `/owner/analytics/cancellations`
- **Calendar:** –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–æ—Å–ª–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–º–µ–Ω—ã –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

## –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Eager Loading
–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –æ–±—ä–µ–∫—Ç–∞–º –∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º –∏—Å–ø–æ–ª—å–∑—É—é—Ç eager loading –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ `greenlet_spawn`:
```python
object_query = select(Object).where(...).options(
    joinedload(Object.org_unit).joinedload('parent').joinedload('parent').joinedload('parent')
)
```

### –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã
- –í—Å–µ –¥–∞—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ UTC
- –í –±–æ—Ç–µ –≤—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `timezone_helper.py`
- –§—É–Ω–∫—Ü–∏–∏: `get_user_timezone(user)`, `convert_utc_to_local(dt, tz)`

### –ö—ç—à –∫–∞–ª–µ–Ω–¥–∞—Ä—è
- –ü–æ—Å–ª–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–º–µ–Ω—ã –æ—á–∏—â–∞–µ—Ç—Å—è: `cache.clear_pattern("calendar_shifts:*")` –∏ `cache.clear_pattern("api_response:*")`
- Frontend –≤—ã–∑—ã–≤–∞–µ—Ç `window.universalCalendar.refresh()` –±–µ–∑ setTimeout

### –°–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞
- `UserAction.CANCEL_SHIFT` - –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω—ã
- `UserStep.INPUT_DOCUMENT` - –≤–≤–æ–¥ –æ–ø–∏—Å–∞–Ω–∏—è/–æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- `UserStep.INPUT_PHOTO` - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –≤ `shift_handlers.py::handle_media()` - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∑–∞–¥–∞—á–∞–º–∏

### –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:
```python
context.user_data.pop('cancelling_shift_id', None)
context.user_data.pop('cancel_reason', None)
context.user_data.pop('cancel_reason_notes', None)
context.user_data.pop('cancel_document_description', None)
context.user_data.pop('report_chat_id', None)
```

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É/–≤–ª–∞–¥–µ–ª—å—Ü—É –æ–± –æ—Ç–º–µ–Ω–µ (TODO)
- –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –≥—Ä—É–ø–ø—É, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
- –ù–µ—Ç API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ –æ–±—Ä–∞—Ç–Ω–æ –∏–∑ –≥—Ä—É–ø–ø—ã
- Timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω (Europe/Moscow), –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ

