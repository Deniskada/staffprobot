# Системы оплаты труда (Payment Systems)

## Описание

Системы оплаты определяют метод расчета зарплаты для сотрудников. Каждая система имеет свои особенности и применяется на уровне договора или объекта (с наследованием от подразделения).

## Модель данных

**Таблица:** `payment_systems`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer | Первичный ключ |
| `code` | String(50) | Уникальный код системы |
| `name` | String(255) | Название системы |
| `description` | Text | Описание и особенности |
| `display_order` | Integer | Порядок отображения |
| `is_active` | Boolean | Активность системы |
| `created_at` | DateTime | Дата создания |

## Типы систем

### 1. Простая повременная (`simple_hourly`)
- **ID:** 1
- **Описание:** Оплата только за отработанные часы
- **Формула:** `Сумма = Часы × Ставка`
- **Особенности:** Не применяются премии и штрафы за задачи

### 2. Окладная (`salary`)
- **ID:** 2
- **Описание:** Фиксированная оплата за период
- **Формула:** `Сумма = Оклад`
- **Особенности:** Не зависит от количества часов

### 3. Повременно-премиальная (`hourly_bonus`)
- **ID:** 3
- **Описание:** Оплата за часы + премии/штрафы за задачи
- **Формула:** `Сумма = (Часы × Ставка) + Премии - Штрафы`
- **Особенности:** Применяются автоматические премии за выполнение задач и штрафы за невыполнение

## Использование

### В договорах (Contract)
```python
contract.payment_system_id = 3  # Повременно-премиальная
```

### В объектах (Object)
```python
object.payment_system_id = 1  # Простая повременная
# Если None - наследуется от подразделения
```

### В подразделениях (OrgStructureUnit)
```python
org_unit.payment_system_id = 2  # Окладная
# Наследуется дочерними подразделениями и объектами
```

## Логика применения

### Приоритет при расчете:
1. **Договор** → `contract.payment_system_id` (если указано)
2. **Объект** → `object.payment_system_id` (если указано)
3. **Подразделение** → `org_unit.get_inherited_payment_system_id()` (наследование)
4. **По умолчанию** → Простая повременная (ID: 1)

### Особенности расчета

#### Для "Простая повременная":
- ✅ Учитывается базовая ставка
- ✅ Учитываются ручные удержания/доплаты
- ❌ НЕ учитываются штрафы/премии за задачи
- ❌ НЕ учитываются штрафы за опоздание

#### Для "Повременно-премиальная":
- ✅ Учитывается базовая ставка
- ✅ Учитываются ручные удержания/доплаты
- ✅ **Учитываются автоматические штрафы/премии за задачи**
- ✅ **Учитываются штрафы за опоздание**

## API

### Получение активных систем
```python
from apps.web.services.payment_system_service import PaymentSystemService

service = PaymentSystemService(db)
systems = await service.get_active_systems()
```

### Получение по коду
```python
system = await service.get_system_by_code('hourly_bonus')
```

## UI

### Dropdown в формах
- Форма создания/редактирования договора
- Форма создания/редактирования объекта
- Форма создания/редактирования подразделения

**Опция по умолчанию:** "Не указано (наследуется от подразделения)"

## Связи

- **Contract** → `payment_system_id` (FK)
- **Object** → `payment_system_id` (FK, nullable)
- **OrgStructureUnit** → `payment_system_id` (FK, nullable)

## Индексы

- `idx_payment_systems_code` - на поле `code` (unique)
- `idx_payment_systems_is_active` - на поле `is_active`

## См. также

- [Начисления и выплаты](payroll.md)
- [Договоры](contract.md)
- [Организационная структура](org_structure.md)

