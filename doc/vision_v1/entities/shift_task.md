# –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–º–µ–Ω—É (Shift Tasks)

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∑–∞–¥–∞—á, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–æ –≤—Ä–µ–º—è —Å–º–µ–Ω—ã. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —à—Ç—Ä–∞—Ñ—ã/–ø—Ä–µ–º–∏–∏ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ/–Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. ShiftTask (–ó–∞–¥–∞—á–∞ —Å–º–µ–Ω—ã)

**–¢–∞–±–ª–∏—Ü–∞:** `shift_tasks`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| `shift_id` | Integer | FK ‚Üí shifts.id |
| `task_text` | Text | –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ |
| `is_completed` | Boolean | –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ –∑–∞–¥–∞—á–∞ |
| `completed_at` | DateTime | –î–∞—Ç–∞/–≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| `source` | String(50) | object / timeslot / manual |
| `source_id` | Integer | ID –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–æ–±—ä–µ–∫—Ç–∞/—Ç–∞–π–º-—Å–ª–æ—Ç–∞) |
| `is_mandatory` | Boolean | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ |
| `deduction_amount` | Numeric(10,2) | –°—É–º–º–∞ —à—Ç—Ä–∞—Ñ–∞/–ø—Ä–µ–º–∏–∏ |
| `created_at` | DateTime | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `created_by_id` | Integer | FK ‚Üí users.id |

### 2. TimeslotTaskTemplate (–®–∞–±–ª–æ–Ω –∑–∞–¥–∞—á–∏ –¥–ª—è —Ç–∞–π–º-—Å–ª–æ—Ç–∞)

**–¢–∞–±–ª–∏—Ü–∞:** `timeslot_task_templates`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | Integer | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á |
| `timeslot_id` | Integer | FK ‚Üí time_slots.id |
| `task_text` | Text | –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ |
| `is_mandatory` | Boolean | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ |
| `deduction_amount` | Numeric(10,2) | –°—É–º–º–∞ —à—Ç—Ä–∞—Ñ–∞/–ø—Ä–µ–º–∏–∏ |
| `display_order` | Integer | –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è |
| `created_at` | DateTime | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `created_by_id` | Integer | FK ‚Üí users.id |

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–∞–¥–∞—á (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

1. **–¢–∞–π–º-—Å–ª–æ—Ç** ‚Üí `timeslot_task_templates` (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç)
2. **–û–±—ä–µ–∫—Ç** ‚Üí `object.shift_tasks` (JSONB, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
3. **–†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ** ‚Üí —É–ø—Ä–∞–≤–ª—è—é—â–∏–π/–≤–ª–∞–¥–µ–ª–µ—Ü

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ shift_tasks –≤ Object
```json
[
  {
    "text": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
    "is_mandatory": true,
    "deduction_amount": -100  // –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
  },
  {
    "text": "–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –æ—Ç—á–µ—Ç",
    "is_mandatory": false,
    "deduction_amount": 50  // –ü—Ä–µ–º–∏—è –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
  }
]
```

## –ü—Ä–æ—Ü–µ—Å—Å —Å–º–µ–Ω—ã

### 1. –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã
```python
from apps.web.services.shift_task_service import ShiftTaskService

# –°–æ–∑–¥–∞—é—Ç—Å—è –∑–∞–¥–∞—á–∏ –∏–∑ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –æ–±—ä–µ–∫—Ç–∞
await shift_task_service.create_tasks_for_shift(
    shift_id=100,
    object_id=9,
    timeslot_id=1165  # –∏–ª–∏ None
)
```

### 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á (–≤ –±–æ—Ç–µ)
–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á:
```
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è)
‚òê –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –æ—Ç—á–µ—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è)
```

–ú–æ–∂–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é ‚Üí `is_completed = True`, `completed_at = now()`

### 3. –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã
–ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:
```python
incomplete_tasks = await shift_task_service.get_incomplete_tasks(shift_id)

# Celery –∑–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Ö –ø–æ–∑–∂–µ
```

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è (Celery)
**–ó–∞–¥–∞—á–∞:** `process_automatic_deductions()` (01:00 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ)

**–õ–æ–≥–∏–∫–∞ –¥–ª—è –∑–∞–¥–∞—á (—Ç–æ–ª—å–∫–æ –¥–ª—è "–ü–æ–≤—Ä–µ–º–µ–Ω–Ω–æ-–ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è"):**
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ù–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∞** ‚Üí `deduction_amount < 0` ‚Üí —à—Ç—Ä–∞—Ñ
  - –°–æ–∑–¥–∞–µ—Ç—Å—è `PayrollDeduction` —Å `is_automatic=True`
- **–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞** ‚Üí `deduction_amount > 0` ‚Üí –ø—Ä–µ–º–∏—è
  - –°–æ–∑–¥–∞–µ—Ç—Å—è `PayrollBonus` —Å `is_automatic=True`

## –¢–∏–ø—ã –∑–∞–¥–∞—á

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è (`is_mandatory=True`)
- **–¶–µ–ª—å:** –ó–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –î–û–õ–ñ–ù–´ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- **–®—Ç—Ä–∞—Ñ:** –ï—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Üí `abs(deduction_amount)` —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
- **–ü—Ä–∏–º–µ—Ä:** "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", "–°–¥–µ–ª–∞—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é"

### –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è (`is_mandatory=False`)
- **–¶–µ–ª—å:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∑–∞ –ø—Ä–µ–º–∏—é
- **–ü—Ä–µ–º–∏—è:** –ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Üí `deduction_amount` –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è
- **–ü—Ä–∏–º–µ—Ä:** "–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –æ—Ç—á–µ—Ç", "–£–±—Ä–∞—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é"

## UI

### –î–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞/—É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ

#### –í —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
```html
<h5>–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–º–µ–Ω–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</h5>
<div class="task-item">
  <input name="task_texts[]" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
  <input name="task_deductions[]" placeholder="–ü—Ä–µ–º–∏—è (‚ÇΩ)">
  <input type="checkbox" name="task_mandatory[]"> –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è
</div>
[+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É]
```

#### –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/owner/shift-tasks`
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–¥–∞—á –ø–æ –≤—Å–µ–º —Å–º–µ–Ω–∞–º
- –§–∏–ª—å—Ç—Ä—ã: –æ–±—ä–µ–∫—Ç, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–≤—ã–ø–æ–ª–Ω–µ–Ω–∞/–Ω–µ—Ç), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –°—Ç–æ–ª–±—Ü—ã: –°–º–µ–Ω–∞, –û–±—ä–µ–∫—Ç, –ó–∞–¥–∞—á–∞, –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ù–∞—á–∏—Å–ª–µ–Ω–∏—è (—Ü–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞)

### –î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–≤ –±–æ—Ç–µ)

–ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã:
```
üìã –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–º–µ–Ω–µ:
‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
‚òê –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –æ—Ç—á–µ—Ç

[‚úì –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏] [–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ]
```

## –°–µ—Ä–≤–∏—Å: ShiftTaskService

### –ú–µ—Ç–æ–¥—ã
```python
# –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏ –¥–ª—è —Å–º–µ–Ω—ã
create_tasks_for_shift(shift_id, object_id, timeslot_id)

# –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏ —Å–º–µ–Ω—ã
get_shift_tasks(shift_id) -> List[ShiftTask]

# –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
mark_task_completed(task_id) -> ShiftTask

# –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
get_incomplete_tasks(shift_id) -> List[ShiftTask]

# –ü–æ–ª—É—á–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
get_completed_tasks(shift_id) -> List[ShiftTask]
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è–º–∏

### –°–≤—è–∑—å —á–µ—Ä–µ–∑ Celery
```python
# –í process_automatic_deductions()
for shift in completed_shifts:
    incomplete_tasks = await shift_task_service.get_incomplete_tasks(shift.id)
    
    for task in incomplete_tasks:
        if task.is_mandatory and task.deduction_amount < 0:
            # –°–æ–∑–¥–∞—Ç—å —à—Ç—Ä–∞—Ñ
            await payroll_service.add_deduction(...)
    
    completed_optional = [t for t in all_tasks if not t.is_mandatory and t.is_completed]
    for task in completed_optional:
        if task.deduction_amount > 0:
            # –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–º–∏—é
            await payroll_service.add_bonus(...)
```

## –ò–Ω–¥–µ–∫—Å—ã

- `idx_shift_tasks_shift_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Å–º–µ–Ω–µ
- `idx_shift_tasks_is_completed` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- `idx_shift_tasks_is_mandatory` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- `idx_timeslot_task_templates_timeslot_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∞–π–º-—Å–ª–æ—Ç—É

## –°–º. —Ç–∞–∫–∂–µ

- [–°–º–µ–Ω—ã](shifts.md)
- [–û–±—ä–µ–∫—Ç—ã](objects.md)
- [–¢–∞–π–º-—Å–ª–æ—Ç—ã](timeslots.md)
- [–ù–∞—á–∏—Å–ª–µ–Ω–∏—è –∏ –≤—ã–ø–ª–∞—Ç—ã](payroll.md)

