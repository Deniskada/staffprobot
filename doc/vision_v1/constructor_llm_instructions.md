# Инструкции для нейросети: конструктор шаблонов договоров

Документ задаёт однозначную связь между **пунктами текста договора**, **шагами мастера** и **условиями показа**. Используй его при проектировании или доработке мастера конструктора, чтобы не путать «что в договоре» и «что в мастере».

---

## 1. Три слоя

| Слой | Описание | Пример |
|------|----------|--------|
| **Пункт договора** | Конкретный фрагмент итогового текста (раздел, абзац, таблица). Подставляется в шаблон при сборке. | «6.1. Условия о качестве» + таблица требований |
| **Шаг мастера** | Страница мастера: заголовок, форма (поля, выбор, таблицы). Собирает данные в `step_choices[slug]`. | Шаг «Условия о качестве» (slug `quality`) |
| **Условие показа** | Когда шаг мастера показывать, а когда — нет. Когда какой фрагмент договора включать. | Шаг 7 показывать только если в шаге 6 отмечено «Требования к качеству» |

**Важно:** не смешивать. «13% / 30%» в шаге «Стоимость» — это **ставка НДФЛ (налог)**, а не «размер стоимости» или «процент от суммы». Пункт договора про стоимость работ и пункт про удержание НДФЛ — разные вещи; привязка к шагу и полям должна это отражать.

---

## 2. Связь «пункт договора» ↔ «шаг мастера»

- Каждый **фрагмент** (`constructor_fragments`) привязан к шагу (`step_id`) и опционально к варианту выбора (`option_key`).
- Фрагмент — это кусок HTML/текста договора. В нём плейсхолдеры `{{ key }}` для подстановки значений из `step_choices` (поля шага, таблицы, `_option`).
- **Какой пункт договора куда попадает:** явно по привязке фрагмента к шагу (и варианту). Нет фрагмента — пункт в шаблоне из этого шага не собирается.

Правило для проектирования:

1. Перечисли **пункты договора** (разделы, таблицы, абзацы).
2. Для каждого пункта реши: **какой шаг мастера** собирает данные для него (какой `slug`).
3. Если пункт бывает в разных формулировках в зависимости от выбора — заведи отдельные фрагменты с разными `option_key` и опиши, при каком выборе какой фрагмент берётся.

---

## 3. Условия показа шагов мастера

- Шаги могут быть **условными**: показывать только при выполнении условия (часто — выбор в другом шаге).
- В `schema` шага задаётся `show_if`: `{ "step_slug": "...", "field": "..." }`. Шаг показывается только если у `step_choices[step_slug][field]` значение truthy (например, чекбокс отмечен).
- **Пример:** шаги 7–10 (качество, гарантия, цели, содействие) показываются только если в шаге 6 («Дополнительные требования») отмечен соответствующий чекбокс.

При добавлении условных шагов:

1. Указать в `show_if` шаг и поле, от которого зависит показ.
2. В мастере при «Далее» / «Назад» пропускать шаги, для которых условие не выполнено.
3. В `build_template` не добавлять фрагменты шагов, чьё `show_if` не выполнено (по `step_choices`).

---

## 4. Условия показа полей внутри шага

- В `schema` шага задаётся `conditionals`: массив `{ "if_field", "eq", "then_show_fields": [...] }`.
- Поле показывается только если оно входит в `then_show_fields` какого‑то условия, у которого значение `if_field` равно `eq`. Иначе поле скрыто.
- `if_field` может быть `_option` — тогда сравнивается выбранный вариант (кнопки/radio).

**Пример (шаг «Гарантийный срок»):**

- Варианты: «По календарной дате» / «По истечении срока».
- Если «По календарной дате» — показывать только поле «Дата окончания».
- Если «По истечении срока» — показывать «Значение» (число) и «Срок» (выбор: дней / недель / месяцев / лет).

---

## 5. Таблицы, выбор, типы полей

- **Таблицы** (`schema.tables`): данные собираются в `step_choices[slug][table_id]` как массив объектов. Во фрагменте `{{ table_id }}` подставляется форматированный вывод строк.
- **Выбор варианта** (`options`): хранится в `_option`; при подстановке во фрагмент доступен и как `{{ _option }}`.
- **Типы полей:** `text`, `number`, `date`, `checkbox`, `radio`, `select`. Для `select` у поля задаётся `options`: `[{ "key", "label" }]`.

Соблюдай соглашения по названиям и смыслу (например, «Срок» для единицы исчисления — выбор из дней/недель/месяцев/лет, не вольный текст).

---

## 6. Контрольный список при проектировании мастера

1. **Пункты договора:** перечисли все разделы/таблицы/абзацы, которые должны попадать в шаблон.
2. **Шаги мастера:** для каждого пункта — какой шаг (и при каком варианте) его заполняет.
3. **Условия показа шагов:** какие шаги показываются только при определённых отметках/выборах в других шагах (`show_if`).
4. **Условия показа полей:** в каких шагах часть полей показывается только при определённом выборе (`conditionals`).
5. **Плейсхолдеры:** какие ключи из `step_choices` подставляются в какой фрагмент; не использовать ключи «из контекста» без явной привязки.

---

## 7. Ошибки, которых нужно избегать

- Трактовать элементы формы (например, 13% / 30%) как «стоимость» или «долю», если по смыслу это **налог (НДФЛ)**.
- Показывать шаги 6.1–6.4 (качество, гарантия, цели, содействие) всегда: они должны появляться **только** при включении соответствующей галки в шаге 6.
- Путать «единицу» и «срок» в гарантии: «Срок» — выбор из дней/недель/месяцев/лет; число — «Значение» (количество этих единиц).
- Добавлять фрагменты в итоговый шаблон для шагов, которые пользователь не проходил из‑за `show_if`.

---

## 8. Ссылки

- Схема шага, API, плейсхолдеры: `doc/vision_v1/contract_constructor.md`
- Воркфлоу «Договор подряда»: `doc/plans/wf_konstr_shablonov.md`
