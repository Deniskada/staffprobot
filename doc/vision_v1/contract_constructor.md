# Конструктор шаблонов договоров

## Назначение

Универсальный движок создания шаблона договора через пошаговый мастер. Шаги, варианты выбора и фрагменты текста хранятся в БД (без хардкода в коде), что позволяет добавлять новые типы договоров и в перспективе генерировать мастера нейросетью.

## Модель данных

- **contract_types** — справочник типов договоров (подряд, услуги, трудовой и т.д.).
- **constructor_flows** — сценарий мастера для типа договора (название, версия, source: manual | llm_generated).
- **constructor_steps** — шаг мастера: `sort_order`, `title`, `slug`, `schema` (JSON), `request_at_conclusion` (поля шага попадают в `fields_schema` при заключении).
- **constructor_fragments** — фрагмент текста договора: `step_id`, `option_key` (nullable), `fragment_content` (HTML/текст).

Итоговый шаблон создаётся записью **ContractTemplate** с `content` = склейка фрагментов по выбранным вариантам, `fields_schema` из шагов с `request_at_conclusion=true`, `contract_type_id`, `constructor_flow_id`.

## Схема шага (constructor_steps.schema)

JSON-объект с полями:

- **info_block** (string) — текст подсказки/инфоблока над формой.
- **fields** (array) — поля формы:
  - `key`, `label`, `type` (text | number | date | checkbox | radio | select | profile_select), `required?`, `options?` (для select/radio).
- **options** (array) — варианты выбора для radio/select: `{ "key": "...", "label": "..." }`.
- **tables** (array) — таблицы с CRUD: `{ "id": "...", "columns": [{ "key", "label", "type" }] }`.
- **conditionals** (array) — условный показ полей: `{ "if_field", "eq", "then_show_fields": [] }`. Поле показывается только если входит в `then_show_fields` при совпадении `if_field` с `eq` (для варианта кнопок — `if_field: "_option"`).
- **show_if** (object) — условный показ всего шага: `{ "step_slug": "...", "field": "..." }`. Шаг показывается только если у выбора `step_slug` поле `field` truthy (например, чекбокс отмечен).

Пример:

```json
{
  "info_block": "Укажите тип заказчика.",
  "fields": [
    { "key": "customer_type", "label": "Тип заказчика", "type": "radio", "required": true }
  ],
  "options": [
    { "key": "ip", "label": "ИП" },
    { "key": "legal", "label": "ЮЛ" },
    { "key": "individual", "label": "ФЛ" }
  ]
}
```

## Формат step_choices (вход build-template)

Объект: ключ = `slug` шага, значение — либо строка (выбранный `option_key`), либо объект с полями шага и опционально `_option`:

- **Только выбор варианта:** `{ "customer": "ip", "object": "in_contract" }`.
- **Поля + вариант:** `{ "contract_info": { "contract_number": "1", "sign_place": "Москва", "sign_date": "2026-01-29" }, "customer": { "_option": "ip" } }`.

Для шагов с `request_at_conclusion=true` поля из `schema.fields` попадают в `ContractTemplate.fields_schema` и запрашиваются при заключении договора.

## Плейсхолдеры во фрагментах

В `fragment_content` поддерживается подстановка:

- **{{ key }}** — значение из `step_choices` по ключу поля (или из значений полей текущего шага).
- Для полей-таблиц значение может быть массивом объектов; он форматируется в строку (строки через перенос).

При заключении договора в контенте шаблона подставляются также теги из справочника тегов (владелец, сотрудник, дата и т.д.).

## API (owner)

- `GET /api/constructor/contract-types` — список типов договоров.
- `GET /api/constructor/flows?contract_type_id=` — список активных flows.
- `GET /api/constructor/flows/{id}` — flow с шагами (для мастера).
- `POST /api/constructor/flows/{id}/build-template` — тело: `{ "step_choices", "template_name", "template_description" }`; ответ: `{ "success", "template_id" }`.

## Веб-маршруты

- `GET /owner/contract-templates/constructor` — выбор типа договора (и при одном flow — переход в мастер).
- `GET /owner/contract-templates/constructor/wizard/{flow_id}` — пошаговый мастер по flow.

Страница списка шаблонов содержит кнопку «Мастер конструктора», ведущую на выбор типа.

## UI мастера

- Для шага с **options** (radio) поле из `fields` с тем же смыслом не рендерится повторно: выбор идёт только кнопками, лишнего поля «как название шага» внизу нет.
- Если у шага несколько полей и только одно — radio с вариантами, в seed лучше ставить это поле первым в `fields`, чтобы варианты были привязаны к нему.

## Таблицы в мастере

В шаге с `schema.tables` отображаются таблицы с CRUD: колонки из `columns` (key, label, type), кнопки «Добавить строку» и «Удалить». Данные собираются в `step_choices[slug][table_id]` как массив объектов (строка = объект с ключами по column.key). Во фрагменте плейсхолдер `{{ table_id }}` подставляется форматированием строк через перенос (значения через « | »).

## Фаза 3 (реализовано)

- **Навигация:** клик по номеру шага → переход; активный шаг подсвечен зелёным. Кнопка «Отмена» слева, «Далее» справа.
- **Шаг 1:** полные названия кнопок (ИП, ЮЛ, ФЛ); `profile_select` для выбора профиля собственника.
- **Шаг 2:** полные названия; чекбокс «Самозанятый» (только при ФЛ).
- **Шаг 3:** таблица работ только при выборе «В договоре».
- **Шаг 4:** три варианта поставщика; conditionals для срока и ответственности при вариантах заказчика.
- **Шаг 5:** исключён из мастера (заполняется при заключении).
- **Шаг 6:** подсветка чекбоксов, добавляющих шаги; при изменении — обновление списка шагов.
- **Шаги 12–15:** select вместо text; show_if для 13–15 от чекбоксов шага 12; conditionals в 13 и 15.
- **Шаги 17–18:** переименования полей; conditionals для вложенных полей; опции подсудности с «по месту нахождения».
- **Стили:** компактность; чекбоксы: текст слева, квадратик справа.
- **constructor_values:** сохранение step_choices в шаблоне (customer_profile_id и др.) для подстановки при создании договора.

## Текущие данные (черновики)

Flow «Договор подряда» содержит **19 шагов** (1–5 исходные + 6–19 по `wf_konstr_shablonov`):

- **Шаг 3** (Объект): варианты «В договоре» / «В смете» / «В ТЗ», таблица `works`, чекбокс «субподряд».
- **Шаги 6–19**: доп. требования, качество, гарантия, цели, содействие, стоимость, оплата (в т.ч. предоплата/факт/отсрочка), приёмка, ответственность, споры, доп. условия. Таблицы: quality, goals, assistance.
- **Шаг 11 (Стоимость):** 13% / 30% — это **ставка НДФЛ (налог)**, не «стоимость» в контексте раздела. Интерпретацию и привязку к пунктам договора пересмотреть позже; пока пауза.
- **Условия:** шаги 7–10 показываются только при включении соответствующих чекбоксов в шаге 6. В шаге 8 (гарантия) при «по дате» — только дата; при «по сроку» — значение + срок (дни/недели/месяцы/годы).
- Нет развитых **подсказок** (только `info_block`).
- Формулировки **ИП / ФЛ / ЮЛ** зашиты в `options[].label` и во фрагментах — нужна возможность редактировать (через редактор конструктора или отдельный справочник).

После появления редактора конструктора владельцем эти вещи можно будет дописать и привязать к нужным пунктам текста.

## Перспектива: редактор конструктора (владелец)

Цель — дать владельцу управлять тем, **что отображается** в мастере и **какому пункту текста** это соответствует:

- **Flows**: название, тип договора, версия, активность.
- **Шаги**: порядок, заголовок, slug, схема (info_block, fields, options, tables, conditionals), request_at_conclusion.
- **Фрагменты**: привязка к шагу и option_key, HTML-контент фрагмента (в т.ч. формулировки ИП/ФЛ/ЮЛ и плейсхолдеры).

В UI: список flows → выбор flow → список шагов с редактированием title/schema → для каждого шага список фрагментов с привязкой к варианту и редактированием текста. Так будет явная связь «что показываем на шаге» ↔ «какой кусок договора подставляется».

## Полный текст договора и формирование документа

**Реализовано.**

- **Хранение:** поле `full_body` в `contract_types` (Text). Для типа «Договор подряда» (code: `gpc_contract`) загружен полный текст с плейсхолдерами Jinja2.
- **Рендер при заключении:** при создании договора по шаблону с `contract_type_id` и `full_body` используется полный текст вместо `template.content`.
- **Контекст:** `shared/services/contract_full_body_renderer.build_contract_context()` собирает:
  - `contract_number`, `sign_place`, `sign_date` (из values / contract_info);
  - `customer_party`, `contractor_party`, адреса — из OrganizationProfile (владелец) и Profile (сотрудник);
  - `works_list`, `start_date`, `end_date`, `cost`, `payment_terms`, гарантия, ответственность, подсудность и т.д. — из `values` (выборы конструктора, в т.ч. вложенные по step slug).
- **Пункт «Сведения о договоре»** в превью конструктора не выводится; его поля попадают в `fields_schema` и запрашиваются при заключении.

## Инструкции для нейросети

Спека по связи **пункт договора ↔ шаг мастера ↔ условия показа** и типичные ошибки — в `doc/vision_v1/constructor_llm_instructions.md`. Использовать при проектировании или генерации мастера конструктора.
