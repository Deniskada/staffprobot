# Redis UserState: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –î–µ–ø–ª–æ–π

**–î–∞—Ç–∞:** 2025-10-17  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω–æ –Ω–∞ –ø—Ä–æ–¥  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ CRITICAL

---

## üéØ –¶–µ–ª—å

–†–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –ø–æ—Ç–µ—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UserState) –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- –ü–æ—Ç–µ—Ä–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (`completed_tasks`)
- –ü–æ—Ç–µ—Ä–µ –º–µ–¥–∏–∞ –æ—Ç—á–µ—Ç–æ–≤ (`task_media`)
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å –ø—Ä–µ–º–∏–∏/—à—Ç—Ä–∞—Ñ—ã –∑–∞ –∑–∞–¥–∞—á–∏

---

## üìã –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. Redis UserState (Async)

**–§–∞–π–ª:** `core/state/user_state_manager.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ async –º–µ—Ç–æ–¥—ã (`create_state`, `get_state`, `update_state`, `clear_state`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Redis —á–µ—Ä–µ–∑ `RedisCache`
- ‚úÖ Feature flag `state_backend` –¥–ª—è –≤—ã–±–æ—Ä–∞ `memory` –∏–ª–∏ `redis`
- ‚úÖ Lazy initialization Redis
- ‚úÖ Fallback –Ω–∞ in-memory –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Redis
- ‚úÖ TTL = 15 –º–∏–Ω—É—Ç —Å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º
- ‚úÖ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JSON

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
async def create_state(user_id, action, step, **kwargs) -> UserState
async def get_state(user_id) -> Optional[UserState]
async def update_state(user_id, **updates) -> Optional[UserState]
async def clear_state(user_id) -> None
```

### 2. Async –≤—ã–∑–æ–≤—ã –≤–æ –≤—Å–µ—Ö handlers

**–§–∞–π–ª—ã:** `apps/bot/handlers_div/*.py` (8 —Ñ–∞–π–ª–æ–≤, 84 –≤—ã–∑–æ–≤–∞)

**–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–º–µ–Ω–∞:**
```bash
user_state_manager.create_state(...)  ‚Üí  await user_state_manager.create_state(...)
user_state_manager.get_state(...)     ‚Üí  await user_state_manager.get_state(...)
user_state_manager.update_state(...)  ‚Üí  await user_state_manager.update_state(...)
user_state_manager.clear_state(...)   ‚Üí  await user_state_manager.clear_state(...)
```

### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞

**–§–∞–π–ª:** `apps/bot/bot.py`

```python
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis –¥–ª—è UserState (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
if settings.state_backend == 'redis':
    from core.cache.redis_cache import cache
    if not cache.is_connected:
        await cache.connect()
```

### 4. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á

**–§–∞–π–ª:** `apps/bot/handlers_div/shift_handlers.py`

**–°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è** `_collect_shift_tasks()`:
```python
async def _collect_shift_tasks(
    session: AsyncSession,
    shift: Shift,
    timeslot: Optional[TimeSlot] = None,
    object_: Optional[Object] = None
) -> List[Dict]:
```

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:**
- ‚úÖ `_handle_close_shift()` - –≤–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ (—Å—Ç—Ä–æ–∫–∏ 444-478)
- ‚úÖ `_handle_my_tasks()` - –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ `adjustment_tasks.py` (Celery) - –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫

### 5. UI —É–ª—É—á—à–µ–Ω–∏—è

**–§–∞–π–ª—ã:** `apps/bot/handlers_div/core_handlers.py`, `shift_handlers.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á —Å —Ü–µ–Ω–∞–º–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" –≤–æ –≤—Å–µ—Ö —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö:
  - –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã
  - –ü–æ—Å–ª–µ –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è –æ–±—ä–µ–∫—Ç–∞
  - –í "–ú–æ–∏ –∑–∞–¥–∞—á–∏"

### 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤

**–§–∞–π–ª—ã:** 
- `apps/web/routes/owner_timeslots.py`
- `apps/web/routes/owner.py`
- `apps/web/services/object_service.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –®—Ç—Ä–∞—Ñ—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –∫–∞–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (`abs(amount)`)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# ‚ùå –ë–´–õ–û
deduction_amount=abs(deduction) if deduction else None

# ‚úÖ –°–¢–ê–õ–û
deduction_amount=deduction if deduction else None  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ!
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–º–µ–Ω–∞ 352 (–æ–±–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã):
```sql
notes: {"completed_tasks": [0, 1], "task_media": {...}}

–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:
- shift_base: +7.77‚ÇΩ
- late_start: -100‚ÇΩ
- task_bonus: +123‚ÇΩ (–ø—Ä–æ–µ—Ö–∞–ª–∏ 123)
```

### –°–º–µ–Ω–∞ 364 (–Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª —à—Ç—Ä–∞—Ñ + –≤—ã–ø–æ–ª–Ω–∏–ª –ø—Ä–µ–º–∏—é):
```sql
- shift_base: +9.90‚ÇΩ
- task_penalty: -33‚ÇΩ (—à—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
- task_bonus: +100‚ÇΩ (–ø—Ä–µ–º–∏—è –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
```

### –°–º–µ–Ω–∞ 365 (–≤—ã–ø–æ–ª–Ω–∏–ª —à—Ç—Ä–∞—Ñ + –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª –ø—Ä–µ–º–∏—é):
```sql
- shift_base: +0.44‚ÇΩ
- task_completed: 0‚ÇΩ (—à—Ç—Ä–∞—Ñ -44‚ÇΩ –∏–∑–±–µ–∂–∞–Ω)
```

---

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏

1. ‚úÖ **Event loop –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã Redis –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
2. ‚úÖ **CANCEL_SHIFT ‚Üí CANCEL_SCHEDULE** - –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π enum
3. ‚úÖ **–î—É–±–ª–∏—Ä—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** - `open_object`, `open_shift`, `close_shift` –≤ `button_callback`
4. ‚úÖ **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã** - `_handle_complete_my_task`, `_handle_my_tasks`
5. ‚úÖ **–õ–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç InlineKeyboardButton** - –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º
6. ‚úÖ **–ì–∞–ª–æ—á–∫–∏ –∑–∞–¥–∞—á** - —Ö–∞—Ä–¥–∫–æ–¥ `"‚úì "` –≤–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ `completed_tasks`
7. ‚úÖ **–ü–æ—Ç–µ—Ä—è –∑–∞–¥–∞—á —Ç–∞–π–º-—Å–ª–æ—Ç–∞** - –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ CLOSE_OBJECT
8. ‚úÖ **–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã** - `abs()` –≤ —Ñ–æ—Ä–º–∞—Ö —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ö–æ–º–º–∏—Ç–æ–≤:** 20  
**–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 12  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~500+

**–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `core/state/user_state_manager.py` - –ø–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ async + Redis
- `apps/bot/handlers_div/*.py` - 84 async –≤—ã–∑–æ–≤–∞
- `apps/web/services/object_service.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ abs()
- `apps/web/routes/owner_timeslots.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ abs()

---

## üöÄ Deployment

**–í–µ—Ç–∫–∞:** `main`  
**–ö–æ–º–º–∏—Ç:** `59d7904`  
**–î–∞—Ç–∞ –¥–µ–ø–ª–æ—è:** 2025-10-17  

**–†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ:**
- ‚úÖ Redis –¥–ª—è UserState (backend=redis)
- ‚úÖ Async handlers (84 await)
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
- ‚úÖ UI —É–ª—É—á—à–µ–Ω–∏—è
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:
- ‚ùå UserState —Ç–µ—Ä—è–ª—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
- ‚ùå `completed_tasks` –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å
- ‚ùå –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∑–∞ –∑–∞–¥–∞—á–∏ –ù–ï —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å
- ‚ùå –ó–∞–¥–∞—á–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ —Ç–µ—Ä—è–ª–∏—Å—å –ø—Ä–∏ CLOSE_OBJECT

### –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:
- ‚úÖ UserState —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Redis
- ‚úÖ `completed_tasks` –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ (—Ç–∞–π–º-—Å–ª–æ—Ç + –æ–±—ä–µ–∫—Ç) –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤–µ–∑–¥–µ
- ‚úÖ UI –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –∏ —É–¥–æ–±–Ω—ã–π

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚è≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Redis –Ω–∞ –ø—Ä–æ–¥–µ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏, TTL)
2. ‚è≥ Smoke test –Ω–∞ –ø—Ä–æ–¥–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
3. ‚è≥ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤–µ–±-—Ñ–æ—Ä–º —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤
4. ‚è≥ –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è `adjustment_tasks.py` —á–µ—Ä–µ–∑ `_collect_shift_tasks()`

---

## üìù –°—Å—ã–ª–∫–∏

- [PHASE_2_PLAN.md](PHASE_2_PLAN.md) - –ø–ª–∞–Ω —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–¥–∞—á
- [BOT_UI_AUDIT.md](BOT_UI_AUDIT.md) - –∞—É–¥–∏—Ç UI –±–æ—Ç–∞
- [DOCUMENTATION_RULES.md](DOCUMENTATION_RULES.md) - –ø—Ä–∞–≤–∏–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

