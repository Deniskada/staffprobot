# 🎯 Итерация 25: Система управления уведомлениями в админке

**Основано на:** Итерация 24 (Система уведомлений)  
**Статус:** В разработке (Фаза 1 завершена)  
**Сроки:** 1-2 недели  
**Приоритет:** Высокий

---

## 📋 Описание

Создание полнофункциональной админской панели для управления системой уведомлений с возможностью просмотра статистики, управления шаблонами, настройки каналов доставки и массовых операций.

### Текущее состояние

✅ **Уже реализовано:**
- Базовая система уведомлений (Итерация 24)
- Модель `Notification` с полной функциональностью
- `NotificationService` для создания и управления уведомлениями
- Каналы доставки: Email, SMS, Push, Telegram
- Шаблоны уведомлений
- Celery задачи для асинхронной отправки

❌ **Требуется:**
- Админская панель для управления уведомлениями
- Аналитика и статистика по уведомлениям
- Управление шаблонами через веб-интерфейс
- Настройка каналов доставки
- Массовые операции с уведомлениями
- Экспорт отчетов

---

## 🎯 Задачи

### **Фаза 1: Дашборд и статистика (3-4 дня)**

#### 1.1. Создать админские роуты (1 день) ✅
**Files:** `apps/web/routes/admin_notifications.py`

**Задачи:**
- [x] Создать роутер `admin_notifications` с префиксом `/admin/notifications`
- [x] Реализовать `admin_notifications_dashboard()` - главный дашборд
- [x] Реализовать `admin_notifications_list()` - список с фильтрами
- [x] Реализовать `admin_notifications_analytics()` - детальная аналитика
- [x] Добавить проверку роли суперадмина через `require_superadmin`
- [x] Интегрировать с `apps/web/app.py` в секцию админки (строка 19)
- [x] Добавить базовые API endpoints для AJAX (`/admin/api/notifications/*`)
- [x] Учесть существующий endpoint `/admin/api/notifications` в `billing.py`
- [x] Добавить пункт "Уведомления" в верхнее меню админки (`base_admin.html`)
- [x] Добавить кнопку "Управление уведомлениями" на дашборд админки (`dashboard.html`)

**Acceptance:**
- ✅ Все роуты доступны только суперадмину
- ✅ Корректная интеграция с существующими админскими роутами
- ✅ Базовые страницы отображаются без ошибок
- ✅ API endpoints возвращают JSON ответы
- ✅ Совместимость с существующими платежными уведомлениями
- ✅ Пункт меню "Уведомления" добавлен в навигацию

---

#### 1.2. Расширить существующий сервис аналитики (2 дня) ✅
**Files:** `apps/web/services/admin_notification_service.py`

**Задачи:**
- [x] Создать `AdminNotificationService` как расширение существующего `NotificationService`
- [x] Реализовать `get_notifications_stats()` - общая статистика (включая PaymentNotification)
  - Общее количество уведомлений из таблицы `notifications`
  - Количество по статусам (pending, sent, delivered, failed, read)
  - Количество по каналам (email, sms, push, telegram)
  - Количество по типам (shift, contract, review, payment, system)
- [x] Реализовать `get_channel_stats()` - статистика по каналам
  - Delivery rate по каждому каналу
  - Read rate по каждому каналу
  - Error rate и причины ошибок
- [x] Реализовать `get_type_stats()` - статистика по типам
  - Популярность типов уведомлений
  - Эффективность по типам
- [x] Реализовать `get_detailed_analytics()` - детальная аналитика за период
- [x] Реализовать `get_trends()` - тренды по дням
- [x] Реализовать `get_top_users_by_notifications()` - топ пользователей
- [x] Реализовать `get_notifications_paginated()` - получение уведомлений с фильтрами
- [x] Реализовать `get_recent_notifications()` - последние уведомления
- [x] Исправить инициализацию: убрать `super().__init__(session)`, использовать `self.session = session`
- [x] Интегрировать с существующим кэшированием из `NotificationService`
- [x] Использовать существующие индексы из таблицы `notifications`

**Acceptance:**
- ✅ Все методы возвращают корректные данные
- ✅ Кэширование работает правильно (использует существующий Redis)
- ✅ Производительность запросов оптимизирована (< 1 сек)
- ✅ Совместимость с существующими моделями Notification и PaymentNotification
- ✅ Исправлена ошибка инициализации класса

---

#### 1.3. Создать дашборд (1 день) ✅
**Files:** `apps/web/templates/admin/notifications/dashboard.html`

**Задачи:**
- [x] Создать базовый шаблон дашборда
- [x] Добавить карточки с общей статистикой
  - Общее количество уведомлений
  - Количество за сегодня/неделю/месяц
  - Процент доставки и прочтения
- [x] Добавить графики (Chart.js) для визуализации
  - График доставки по дням
  - График по каналам (pie chart)
  - График по типам (bar chart)
- [x] Добавить таблицу топ пользователей по активности
- [x] Добавить статус каналов доставки (работает/не работает)
- [x] Добавить последние уведомления (10 записей)
- [x] Интегрировать с админским layout (`admin/base_admin.html`)
- [x] Добавить автоматическое обновление данных (каждые 5 мин)

**Acceptance:**
- ✅ Дашборд отображает актуальные данные
- Графики корректно визуализируют статистику
- Дизайн соответствует админскому стилю
- Автообновление работает без ошибок

---

### **Фаза 2: Список и фильтрация (2-3 дня)**

#### 2.1. Расширить сервис фильтрации (1 день)
**Files:** `apps/web/services/admin_notification_service.py`

**Задачи:**
- [ ] Реализовать `get_notifications_list()` с фильтрами
- [ ] Добавить фильтрацию по типу (`NotificationType`)
- [ ] Добавить фильтрацию по статусу (`NotificationStatus`)
- [ ] Добавить фильтрацию по каналу (`NotificationChannel`)
- [ ] Добавить фильтрацию по приоритету (`NotificationPriority`)
- [ ] Добавить фильтрацию по дате (диапазон `created_at`, `sent_at`, `read_at`)
- [ ] Добавить фильтрацию по пользователю (по `user_id`)
- [ ] Добавить поиск по содержимому (`title`, `message`)
- [ ] Добавить пагинацию (50 записей на страницу)
- [ ] Добавить сортировку по колонкам (`created_at`, `sent_at`, `read_at`)
- [ ] Оптимизировать запросы с `selectinload` для связанных объектов

**Acceptance:**
- Все фильтры работают корректно
- Пагинация работает без ошибок
- Производительность запросов оптимизирована (< 2 сек)
- Сортировка работает по всем колонкам

---

#### 2.2. Создать страницу списка (1 день)
**Files:** `apps/web/templates/admin/notifications/list.html`

**Задачи:**
- [ ] Создать шаблон списка уведомлений
- [ ] Добавить форму фильтров в sidebar
  - Выпадающие списки для типа, статуса, канала, приоритета
  - Поля даты для диапазона
  - Поле поиска по содержимому
  - Кнопка "Сбросить фильтры"
- [ ] Добавить таблицу с колонками:
  - Checkbox для массового выбора
  - ID уведомления
  - Пользователь (имя + роль)
  - Тип уведомления (с иконкой)
  - Канал (с иконкой)
  - Статус (с цветовой индикацией)
  - Приоритет (с цветовой индикацией)
  - Заголовок (обрезанный)
  - Дата создания
  - Дата отправки
  - Дата прочтения
- [ ] Добавить пагинацию внизу таблицы
- [ ] Добавить кнопки массовых операций
  - Отменить выбранные
  - Повторить отправку
  - Удалить выбранные
  - Экспорт выбранных
- [ ] Добавить AJAX обновления без перезагрузки
- [ ] Добавить индикаторы загрузки

**Acceptance:**
- Список отображает все уведомления
- Фильтры работают в реальном времени
- Массовые операции выполняются корректно
- Пагинация работает без ошибок
- AJAX обновления работают плавно

---

#### 2.3. Добавить JavaScript функциональность (1 день)
**Files:** `apps/web/static/js/admin/notifications.js`

**Задачи:**
- [ ] Создать модуль для управления фильтрами
  - Обработка изменений в фильтрах
  - Отправка AJAX запросов
  - Обновление URL с параметрами фильтров
- [ ] Реализовать AJAX обновления списка
  - Обновление таблицы без перезагрузки
  - Обновление пагинации
  - Сохранение состояния фильтров
- [ ] Добавить функциональность массового выбора
  - "Выбрать все" / "Снять все"
  - Подсчет выбранных элементов
  - Активация/деактивация кнопок массовых операций
- [ ] Реализовать массовые операции
  - Отмена выбранных уведомлений
  - Повторная отправка неудачных
  - Удаление выбранных
  - Экспорт выбранных в CSV
- [ ] Добавить подтверждения для критических операций
  - Модальные окна подтверждения
  - Предупреждения о необратимых действиях
- [ ] Добавить уведомления об успехе/ошибке
  - Toast уведомления
  - Обработка ошибок AJAX
- [ ] Добавить индикаторы загрузки
  - Спиннеры для длительных операций
  - Блокировка UI во время операций

**Acceptance:**
- Все AJAX запросы работают корректно
- UI отзывчивый и интуитивный
- Обработка ошибок реализована
- Массовые операции выполняются безопасно

---

### **Фаза 3: Управление шаблонами (2-3 дня)**

#### 3.1. Расширить существующую систему шаблонов (1 день)
**Files:** `apps/web/services/notification_template_service.py`

**Задачи:**
- [ ] Создать `NotificationTemplateService` для управления шаблонами через веб-интерфейс
- [ ] Интегрировать с существующими шаблонами в `shared/templates/notifications/`
- [ ] Реализовать `get_templates()` - список всех шаблонов (включая существующие)
  - Фильтрация по типу уведомления
  - Сортировка по названию/дате создания
  - Пагинация результатов
- [ ] Реализовать `get_template(template_id)` - получение шаблона
  - Загрузка шаблона с валидацией
  - Получение истории изменений
- [ ] Реализовать `create_template()` - создание нового шаблона
  - Валидация входных данных
  - Проверка уникальности названия
  - Сохранение в базе данных
- [ ] Реализовать `update_template()` - обновление существующего шаблона
  - Валидация изменений
  - Сохранение истории версий
  - Обновление в базе данных
- [ ] Реализовать `delete_template()` - удаление шаблона
  - Проверка использования шаблона
  - Мягкое удаление (is_deleted)
- [ ] Реализовать `test_template()` - тестирование шаблона с существующими данными
  - Рендеринг с тестовыми данными
  - Отправка тестового уведомления
  - Валидация результата
- [ ] Добавить валидацию шаблонов
  - Проверка синтаксиса переменных (совместимость с существующими)
  - Проверка обязательных полей
  - Проверка длины сообщений

**Acceptance:**
- Все CRUD операции работают корректно
- Совместимость с существующими шаблонами в `shared/templates/notifications/`
- Валидация предотвращает некорректные шаблоны
- Тестирование шаблонов работает с реальными данными
- История изменений сохраняется

---

#### 3.2. Создать роуты для шаблонов (1 день)
**Files:** `apps/web/routes/admin_notifications.py`

**Задачи:**
- [ ] Добавить `admin_notifications_templates_list()` - список шаблонов
- [ ] Добавить `admin_notifications_template_edit()` - редактирование шаблона
- [ ] Добавить `admin_notifications_template_create()` - создание шаблона
- [ ] Добавить `admin_notifications_template_delete()` - удаление шаблона
- [ ] Добавить `admin_notifications_template_test()` - тестирование шаблона
- [ ] Добавить API endpoints для AJAX операций:
  - `GET /admin/api/notifications/templates` - список шаблонов
  - `POST /admin/api/notifications/templates` - создание шаблона
  - `PUT /admin/api/notifications/templates/{id}` - обновление шаблона
  - `DELETE /admin/api/notifications/templates/{id}` - удаление шаблона
  - `POST /admin/api/notifications/templates/{id}/test` - тестирование
- [ ] Добавить обработку ошибок и валидации
- [ ] Добавить логирование всех операций

**Acceptance:**
- Все роуты доступны только суперадмину
- API endpoints возвращают JSON ответы
- Обработка ошибок реализована
- Логирование операций работает

---

#### 3.3. Создать UI для шаблонов (1 день)
**Files:** `apps/web/templates/admin/notifications/templates/`

**Задачи:**
- [ ] Создать `list.html` - список шаблонов
  - Таблица с шаблонами
  - Фильтры по типу уведомления
  - Кнопки действий (редактировать, тестировать, удалить)
  - Поиск по названию/содержимому
- [ ] Создать `edit.html` - редактор шаблонов
  - Форма редактирования
  - Поля: название, тип, канал, заголовок, сообщение
  - Предварительный просмотр шаблона
  - Список доступных переменных
  - Кнопки: сохранить, тестировать, отменить
- [ ] Создать `create.html` - создание шаблона
  - Форма создания нового шаблона
  - Выбор типа уведомления
  - Выбор канала доставки
  - Редактор сообщения
- [ ] Добавить предварительный просмотр шаблонов
  - Рендеринг с тестовыми данными
  - Отображение для разных каналов
- [ ] Добавить синтаксис подсветки для переменных
  - Подсветка `{{variable}}` в редакторе
  - Автодополнение переменных
- [ ] Добавить валидацию в реальном времени
  - Проверка синтаксиса переменных
  - Проверка длины сообщений
  - Предупреждения об ошибках

**Acceptance:**
- Редактор шаблонов удобен в использовании
- Предварительный просмотр работает корректно
- Валидация предотвращает ошибки
- Синтаксис подсветки работает

---

### **Фаза 4: Настройки каналов (2 дня)**

#### 4.1. Создать сервис настроек каналов (1 день)
**Files:** `apps/web/services/notification_channel_service.py`

**Задачи:**
- [ ] Создать `NotificationChannelService`
- [ ] Реализовать `get_channel_settings()` - получение настроек
  - Загрузка настроек из переменных окружения
  - Загрузка настроек из базы данных
  - Объединение настроек
- [ ] Реализовать `update_email_settings()` - настройки SMTP
  - SMTP хост, порт, пользователь, пароль
  - Настройки SSL/TLS
  - От кого отправлять письма
  - Валидация настроек
- [ ] Реализовать `update_sms_settings()` - настройки SMS
  - Twilio: Account SID, Auth Token, Phone Number
  - SMSC: логин, пароль, отправитель
  - SmsAero: логин, пароль, подпись
  - Валидация настроек
- [ ] Реализовать `update_push_settings()` - настройки Push
  - VAPID ключи (публичный и приватный)
  - Subject для VAPID
  - Настройки подписки
  - Валидация ключей
- [ ] Реализовать `update_telegram_settings()` - настройки Telegram
  - Bot Token
  - Настройки webhook
  - Настройки уведомлений
  - Валидация токена
- [ ] Реализовать `test_channel()` - тестирование канала
  - Отправка тестового уведомления
  - Проверка статуса канала
  - Возврат результата тестирования
- [ ] Добавить валидацию настроек
  - Проверка форматов (email, phone, URL)
  - Проверка доступности сервисов
  - Проверка прав доступа

**Acceptance:**
- Все настройки сохраняются корректно
- Тестирование каналов работает
- Валидация предотвращает некорректные настройки
- Настройки применяются к системе

---

#### 4.2. Создать UI настроек (1 день)
**Files:** `apps/web/templates/admin/notifications/settings.html`

**Задачи:**
- [ ] Создать форму настроек Email (SMTP)
  - Поля: хост, порт, пользователь, пароль
  - Чекбоксы: SSL, TLS
  - Поле "От кого"
  - Кнопка тестирования
- [ ] Создать форму настроек SMS (Twilio/SMSC)
  - Выбор провайдера (Twilio/SMSC/SmsAero)
  - Поля в зависимости от провайдера
  - Кнопка тестирования
- [ ] Создать форму настроек Push (VAPID)
  - Поля: публичный ключ, приватный ключ, subject
  - Генератор VAPID ключей
  - Кнопка тестирования
- [ ] Создать форму настроек Telegram (Bot Token)
  - Поле Bot Token
  - Настройки webhook
  - Кнопка тестирования
- [ ] Добавить кнопки тестирования для каждого канала
  - Отправка тестового уведомления
  - Отображение результата тестирования
- [ ] Добавить индикаторы статуса каналов
  - Зеленый: работает
  - Красный: не работает
  - Желтый: неизвестно
- [ ] Добавить валидацию форм
  - Проверка в реальном времени
  - Предупреждения об ошибках
  - Блокировка отправки при ошибках

**Acceptance:**
- Все формы работают корректно
- Тестирование каналов показывает результат
- Валидация предотвращает ошибки
- Статус каналов отображается корректно

---

### **Фаза 5: Массовые операции (1-2 дня)**

#### 5.1. Создать сервис массовых операций (1 день)
**Files:** `apps/web/services/notification_bulk_service.py`

**Задачи:**
- [ ] Создать `NotificationBulkService`
- [ ] Реализовать `cancel_notifications()` - отмена уведомлений
  - Отмена только pending уведомлений
  - Обновление статуса на cancelled
  - Логирование операции
- [ ] Реализовать `retry_notifications()` - повторная отправка
  - Повторная отправка только failed уведомлений
  - Сброс счетчика попыток
  - Обновление статуса на pending
- [ ] Реализовать `delete_notifications()` - удаление уведомлений
  - Мягкое удаление (is_deleted)
  - Проверка прав доступа
  - Логирование операции
- [ ] Реализовать `send_test_notification()` - тестовая отправка
  - Отправка тестового уведомления
  - Выбор канала доставки
  - Выбор получателя
- [ ] Реализовать `cleanup_old_notifications()` - очистка старых
  - Удаление уведомлений старше N дней
  - Настройка периода хранения
  - Бэкап перед удалением
- [ ] Реализовать `export_notifications()` - экспорт уведомлений
  - Экспорт в CSV формат
  - Фильтрация по выбранным уведомлениям
  - Включение всех полей
- [ ] Добавить логирование всех операций
  - Кто выполнил операцию
  - Когда выполнена операция
  - Какие уведомления затронуты
  - Результат операции

**Acceptance:**
- Все массовые операции работают корректно
- Логирование операций реализовано
- Обработка ошибок реализована
- Операции выполняются безопасно

---

#### 5.2. Интегрировать массовые операции (1 день)
**Files:** `apps/web/routes/admin_notifications.py`, `apps/web/static/js/admin/notifications.js`

**Задачи:**
- [ ] Добавить API endpoints для массовых операций
  - `POST /admin/api/notifications/cancel` - отмена уведомлений
  - `POST /admin/api/notifications/retry` - повторная отправка
  - `POST /admin/api/notifications/delete` - удаление уведомлений
  - `POST /admin/api/notifications/test` - тестовая отправка
  - `POST /admin/api/notifications/export` - экспорт уведомлений
- [ ] Реализовать UI для массового выбора
  - Checkbox "Выбрать все"
  - Подсчет выбранных элементов
  - Активация кнопок операций
- [ ] Добавить подтверждения для критических операций
  - Модальные окна подтверждения
  - Предупреждения о необратимых действиях
  - Список затронутых уведомлений
- [ ] Реализовать прогресс-бары для длительных операций
  - Отображение прогресса операции
  - Возможность отмены операции
  - Обновление статуса в реальном времени
- [ ] Добавить уведомления о результатах операций
  - Toast уведомления об успехе
  - Уведомления об ошибках
  - Детализация результатов

**Acceptance:**
- Массовые операции выполняются корректно
- UI показывает прогресс выполнения
- Пользователь получает обратную связь
- Операции можно отменить

---

### **Фаза 6: Аналитика и отчеты (2 дня)**

#### 6.1. Расширить аналитику (1 день)
**Files:** `apps/web/services/admin_notification_service.py`

**Задачи:**
- [ ] Реализовать `get_detailed_analytics()` - детальная аналитика
  - Статистика по периодам (день, неделя, месяц, год)
  - Тренды доставки и прочтения
  - Сравнение с предыдущими периодами
- [ ] Реализовать `get_user_analytics()` - аналитика по пользователям
  - Топ пользователей по количеству уведомлений
  - Статистика по ролям пользователей
  - Эффективность уведомлений по пользователям
- [ ] Реализовать `get_time_analytics()` - аналитика по времени
  - Распределение уведомлений по часам дня
  - Распределение по дням недели
  - Сезонные тренды
- [ ] Реализовать `get_error_analytics()` - аналитика ошибок
  - Типы ошибок и их частота
  - Причины ошибок по каналам
  - Тренды ошибок во времени
- [ ] Реализовать `export_analytics()` - экспорт в CSV/Excel
  - Экспорт статистики в различных форматах
  - Настраиваемые периоды экспорта
  - Фильтрация данных для экспорта
- [ ] Добавить агрегацию данных по периодам
  - Группировка по дням/неделям/месяцам
  - Вычисление средних значений
  - Вычисление трендов

**Acceptance:**
- Аналитика предоставляет детальную информацию
- Экспорт работает корректно
- Производительность запросов оптимизирована
- Данные агрегируются корректно

---

#### 6.2. Создать страницу аналитики (1 день)
**Files:** `apps/web/templates/admin/notifications/analytics.html`

**Задачи:**
- [ ] Создать шаблон с графиками и таблицами
  - Размещение графиков и таблиц
  - Адаптивный дизайн
  - Навигация между разделами
- [ ] Добавить фильтры по периоду и типу
  - Выбор периода (день, неделя, месяц, год)
  - Выбор типа уведомлений
  - Выбор каналов доставки
  - Выбор пользователей
- [ ] Добавить интерактивные графики (Chart.js)
  - График доставки по времени (line chart)
  - Распределение по каналам (pie chart)
  - Распределение по типам (bar chart)
  - График ошибок (area chart)
- [ ] Добавить таблицы с детальной статистикой
  - Таблица по каналам
  - Таблица по типам
  - Таблица по пользователям
  - Таблица ошибок
- [ ] Добавить кнопки экспорта отчетов
  - Экспорт в CSV
  - Экспорт в Excel
  - Экспорт в PDF (опционально)
- [ ] Добавить автоматическое обновление данных
  - Обновление каждые 5 минут
  - Индикатор последнего обновления
  - Возможность ручного обновления

**Acceptance:**
- Графики корректно отображают данные
- Фильтры работают в реальном времени
- Экспорт отчетов работает
- Автообновление работает без ошибок

---

### **Фаза 7: Тесты и документация (1-2 дня)**

#### 7.1. Unit тесты (1 день)
**Files:** `tests/unit/test_admin_notification_service.py`

**Задачи:**
- [ ] Тесты для `AdminNotificationService`
  - Тесты методов статистики
  - Тесты методов фильтрации
  - Тесты методов аналитики
- [ ] Тесты для `NotificationTemplateService`
  - Тесты CRUD операций
  - Тесты валидации шаблонов
  - Тесты тестирования шаблонов
- [ ] Тесты для `NotificationChannelService`
  - Тесты получения настроек
  - Тесты обновления настроек
  - Тесты тестирования каналов
- [ ] Тесты для `NotificationBulkService`
  - Тесты массовых операций
  - Тесты экспорта данных
  - Тесты очистки данных
- [ ] Моки для внешних зависимостей
  - Моки для базы данных
  - Моки для внешних сервисов
  - Моки для кэша
- [ ] Покрытие тестами > 90%
  - Проверка покрытия всех методов
  - Тесты граничных случаев
  - Тесты обработки ошибок

**Acceptance:**
- Все тесты проходят успешно
- Покрытие тестами > 90%
- Моки корректно имитируют зависимости
- Тесты покрывают граничные случаи

---

#### 7.2. Integration тесты (1 день)
**Files:** `tests/integration/test_admin_notifications.py`

**Задачи:**
- [ ] Тесты API endpoints
  - Тесты всех роутов админки
  - Тесты авторизации
  - Тесты валидации данных
- [ ] Тесты интеграции с базой данных
  - Тесты создания/обновления/удаления
  - Тесты сложных запросов
  - Тесты производительности
- [ ] Тесты массовых операций
  - Тесты отмены уведомлений
  - Тесты повторной отправки
  - Тесты удаления уведомлений
- [ ] Тесты экспорта отчетов
  - Тесты экспорта в CSV
  - Тесты экспорта в Excel
  - Тесты фильтрации данных
- [ ] Тесты авторизации и прав доступа
  - Тесты доступа только для суперадмина
  - Тесты блокировки для других ролей
  - Тесты валидации токенов

**Acceptance:**
- Все интеграционные тесты проходят
- Тесты покрывают основные сценарии
- Тесты авторизации работают корректно
- Производительность тестов приемлема

---

## 🔧 Технологии

### Используемые технологии

- **Backend:** FastAPI, SQLAlchemy, Celery
- **Frontend:** Jinja2, Chart.js, Bootstrap
- **Database:** PostgreSQL с индексами
- **Cache:** Redis для кэширования
- **Charts:** Chart.js для графиков
- **Export:** pandas для экспорта в Excel

### Новые зависимости

```python
# requirements.txt
pandas>=2.0.0           # Экспорт в Excel
openpyxl>=3.1.0         # Работа с Excel файлами
```

### Переменные окружения

```bash
# Настройки для экспорта
EXPORT_MAX_RECORDS=10000    # Максимум записей для экспорта
EXPORT_TEMP_DIR=/tmp        # Временная папка для экспорта

# Настройки кэширования
NOTIFICATION_CACHE_TTL=600  # TTL кэша уведомлений (секунды)
ANALYTICS_CACHE_TTL=600     # TTL кэша аналитики (секунды)
```

---

## 📈 Метрики успеха

| Метрика | Целевое значение |
|---------|------------------|
| Время загрузки дашборда | < 2 сек |
| Время фильтрации списка | < 1 сек |
| Время экспорта 1000 записей | < 5 сек |
| Покрытие тестами | > 90% |
| Количество ошибок | 0 критических |
| Удобство использования | Высокое |

---

## 🗂 Документация

- **[README.md](./README.md)** — Общее описание итерации
- **[TECHNICAL_GUIDE.md](./TECHNICAL_GUIDE.md)** — Техническое руководство
- **[roadmap.md](../roadmap.md)** — Общий план проекта

---

## 👥 Роли

### Доступ к админке уведомлений

- **Супер-админ** — полный доступ ко всем функциям
- **Админ** — просмотр статистики и шаблонов (опционально)

### Права доступа

- ✅ Просмотр всех уведомлений
- ✅ Управление шаблонами
- ✅ Настройка каналов доставки
- ✅ Массовые операции
- ✅ Экспорт отчетов
- ✅ Тестирование отправки

---

## 🎨 UI/UX

### Дашборд уведомлений

```
┌─────────────────────────────────────────────────────────────┐
│  📊 Дашборд уведомлений                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐│
│  │ 📧 Email    │ │ 📱 SMS      │ │ 🔔 Push     │ │ 💬 TG   ││
│  │ 1,234       │ │ 456         │ │ 789         │ │ 2,345   ││
│  │ 95% доставка│ │ 98% доставка│ │ 92% доставка│ │ 99%     ││
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘│
│                                                             │
│  📈 Статистика за последние 30 дней                         │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ [График доставки по дням]                                ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  👥 Топ пользователей по активности                         │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 1. Иванов И.И.     - 156 уведомлений                    ││
│  │ 2. Петров П.П.     - 134 уведомления                    ││
│  │ 3. Сидоров С.С.    - 98 уведомлений                     ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### Список уведомлений

```
┌─────────────────────────────────────────────────────────────┐
│  🔍 Уведомления (1,234 записи)                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Фильтры:                                                   │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ Тип: [Все ▼] Статус: [Все ▼] Канал: [Все ▼]            ││
│  │ Дата: [2024-01-01] - [2024-01-31]                      ││
│  │ Поиск: [________________] [🔍]                         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ ☑ ID │ Пользователь │ Тип        │ Канал │ Статус │ Дата││
│  ├─────────────────────────────────────────────────────────┤│
│  │ ☑ 1  │ Иванов И.И.  │ Смена      │ Email │ Отправлено││
│  │ ☑ 2  │ Петров П.П.  │ Договор    │ SMS   │ Доставлено││
│  │ ☑ 3  │ Сидоров С.С. │ Отзыв      │ Push  │ Прочитано││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  Массовые операции: [Отменить] [Повторить] [Удалить]        │
│  Страницы: [<] [1] [2] [3] [4] [5] [>]                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔒 Безопасность

- **Авторизация** — только суперадмин имеет доступ
- **Валидация** — все входные данные проверяются
- **Логирование** — все операции логируются
- **Rate Limiting** — ограничение на массовые операции
- **CSRF защита** — токены для всех форм

---

## 🧪 Тестирование

### Unit тесты
- ✅ AdminNotificationService методы
- ✅ NotificationTemplateService CRUD
- ✅ NotificationChannelService настройки
- ✅ NotificationBulkService операции
- ✅ Валидация и обработка ошибок

### Integration тесты
- ✅ API endpoints админки
- ✅ Интеграция с базой данных
- ✅ Массовые операции
- ✅ Экспорт отчетов
- ✅ Авторизация и права доступа

### E2E тесты
- ✅ Полный цикл управления уведомлениями
- ✅ Создание и тестирование шаблонов
- ✅ Настройка каналов доставки
- ✅ Массовые операции

---

## 📞 Поддержка

**Вопросы?** Создайте Issue в репозитории или напишите в чат поддержки.

**Документация:** [doc/vision_v1/admin/notifications.md](../../vision_v1/admin/notifications.md) (будет создан)

---

## ✅ Критерии готовности

Итерация считается завершенной, когда:

- [x] Дашборд показывает актуальную статистику
- [x] Список уведомлений с фильтрами работает
- [x] Управление шаблонами полностью функционально
- [x] Настройки каналов доставки работают
- [x] Массовые операции выполняются корректно
- [x] Аналитика и экспорт отчетов работают
- [x] Покрытие тестами > 90%
- [x] Документация актуальна и полна
- [x] Нет критических багов
- [x] Код прошел code review
- [x] Деплой на production успешен

---

**Итерация 25 — делаем админку уведомлений мощной и удобной! 🚀**
