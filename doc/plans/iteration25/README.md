# 🔔 Итерация 25: Система управления уведомлениями в админке

> **Статус:** В разработке (Фаза 1: Дашборд и статистика - ✅ завершена)  
> **Базируется на:** Итерация 24 (Система уведомлений)  
> **Сроки:** 1-2 недели  
> **Приоритет:** Высокий

---

## 📝 Краткое описание

Создание полнофункциональной админской панели для управления системой уведомлений с возможностью просмотра статистики, управления шаблонами, настройки каналов доставки и массовых операций.

---

## 🎯 Цели

1. **Централизованное управление** — единая панель для всех уведомлений системы
2. **Аналитика и мониторинг** — детальная статистика по доставке и эффективности
3. **Управление шаблонами** — создание и редактирование шаблонов уведомлений
4. **Массовые операции** — отправка, отмена, повторная отправка уведомлений
5. **Настройка каналов** — конфигурация Email, SMS, Push, Telegram

---

## 🚀 Что будет реализовано

### ✅ Основные функции

- **📊 Дашборд уведомлений:**
  - Общая статистика по каналам и типам
  - Графики доставки и прочтения
  - Топ пользователей по активности
  - Статус каналов доставки

- **🔍 Расширенная фильтрация:**
  - По типу, статусу, каналу, приоритету
  - По дате создания/отправки/прочтения
  - По пользователю, объекту, смене
  - Поиск по содержимому

- **📝 Управление шаблонами:**
  - Создание и редактирование шаблонов
  - Предварительный просмотр
  - Тестирование шаблонов
  - Версионирование изменений

- **⚙️ Настройки каналов:**
  - Конфигурация SMTP для Email
  - Настройки SMS провайдеров
  - Push уведомления (VAPID ключи)
  - Telegram Bot настройки

- **🔄 Массовые операции:**
  - Отправка тестовых уведомлений
  - Отмена запланированных уведомлений
  - Повторная отправка неудачных
  - Очистка старых уведомлений

- **📈 Аналитика:**
  - Delivery Rate по каналам
  - Read Rate по типам уведомлений
  - Error Rate и причины ошибок
  - Экспорт отчетов в CSV/Excel

---

## 📦 Компоненты

### Роуты админки

| Роут | Описание |
|------|----------|
| `/admin/notifications/` | Главный дашборд уведомлений |
| `/admin/notifications/list` | Список всех уведомлений с фильтрами |
| `/admin/notifications/analytics` | Детальная аналитика |
| `/admin/notifications/templates` | Управление шаблонами |
| `/admin/notifications/settings` | Настройки каналов доставки |
| `/admin/notifications/test` | Тестирование отправки |

### Сервисы

| Сервис | Ответственность |
|--------|------------------|
| `AdminNotificationService` | Аналитика и статистика уведомлений (наследует NotificationService) |
| `NotificationTemplateService` | CRUD операции с шаблонами (интегрируется с shared/templates/) |
| `NotificationChannelService` | Настройка каналов доставки |
| `NotificationBulkService` | Массовые операции |

### Шаблоны

| Шаблон | Описание |
|--------|----------|
| `admin/notifications/dashboard.html` | Главный дашборд |
| `admin/notifications/list.html` | Список с фильтрами |
| `admin/notifications/analytics.html` | Аналитика и графики |
| `admin/notifications/templates/list.html` | Список шаблонов |
| `admin/notifications/templates/edit.html` | Редактор шаблонов |
| `admin/notifications/settings.html` | Настройки каналов |

---

## 📊 Фазы разработки

### Фаза 1: Дашборд и статистика (3-4 дня)

#### 1.1. Создать админские роуты (1 день)
**Files:** `apps/web/routes/admin_notifications.py`

**Задачи:**
- [ ] Создать роутер `admin_notifications`
- [ ] Реализовать `admin_notifications_dashboard()`
- [ ] Реализовать `admin_notifications_list()` с фильтрами
- [ ] Реализовать `admin_notifications_analytics()`
- [ ] Добавить проверку роли суперадмина
- [ ] Интегрировать с существующими админскими роутами

**Acceptance:**
- Все роуты доступны только суперадмину
- Корректная интеграция с `apps/web/app.py`
- Базовые страницы отображаются без ошибок

---

#### 1.2. Создать сервис аналитики (2 дня)
**Files:** `apps/web/services/admin_notification_service.py`

**Задачи:**
- [ ] Создать `AdminNotificationService`
- [ ] Реализовать `get_notifications_stats()` - общая статистика
- [ ] Реализовать `get_channel_stats()` - статистика по каналам
- [ ] Реализовать `get_type_stats()` - статистика по типам
- [ ] Реализовать `get_delivery_rate()` - процент доставки
- [ ] Реализовать `get_read_rate()` - процент прочтения
- [ ] Реализовать `get_error_analysis()` - анализ ошибок
- [ ] Добавить кэширование результатов (TTL 10 мин)

**Acceptance:**
- Все методы возвращают корректные данные
- Кэширование работает правильно
- Производительность запросов оптимизирована

---

#### 1.3. Создать дашборд (1 день)
**Files:** `apps/web/templates/admin/notifications/dashboard.html`

**Задачи:**
- [ ] Создать базовый шаблон дашборда
- [ ] Добавить карточки с общей статистикой
- [ ] Добавить графики (Chart.js) для визуализации
- [ ] Добавить таблицу топ пользователей
- [ ] Добавить статус каналов доставки
- [ ] Добавить последние уведомления
- [ ] Интегрировать с админским layout

**Acceptance:**
- Дашборд отображает актуальные данные
- Графики корректно визуализируют статистику
- Дизайн соответствует админскому стилю

---

### Фаза 2: Список и фильтрация (2-3 дня)

#### 2.1. Расширить сервис фильтрации (1 день)
**Files:** `apps/web/services/admin_notification_service.py`

**Задачи:**
- [ ] Реализовать `get_notifications_list()` с фильтрами
- [ ] Добавить фильтрацию по типу, статусу, каналу
- [ ] Добавить фильтрацию по дате (диапазон)
- [ ] Добавить фильтрацию по пользователю
- [ ] Добавить поиск по содержимому
- [ ] Добавить пагинацию (50 записей на страницу)
- [ ] Добавить сортировку по колонкам

**Acceptance:**
- Все фильтры работают корректно
- Пагинация работает без ошибок
- Производительность запросов оптимизирована

---

#### 2.2. Создать страницу списка (1 день)
**Files:** `apps/web/templates/admin/notifications/list.html`

**Задачи:**
- [ ] Создать шаблон списка уведомлений
- [ ] Добавить форму фильтров в sidebar
- [ ] Добавить таблицу с колонками: ID, Пользователь, Тип, Канал, Статус, Дата
- [ ] Добавить пагинацию внизу таблицы
- [ ] Добавить кнопки массовых операций
- [ ] Добавить AJAX обновления без перезагрузки

**Acceptance:**
- Список отображает все уведомления
- Фильтры работают в реальном времени
- Массовые операции выполняются корректно

---

#### 2.3. Добавить JavaScript функциональность (1 день)
**Files:** `apps/web/static/js/admin/notifications.js`

**Задачи:**
- [ ] Создать модуль для управления фильтрами
- [ ] Реализовать AJAX обновления списка
- [ ] Добавить функциональность массового выбора
- [ ] Реализовать массовые операции (отмена, повтор)
- [ ] Добавить подтверждения для критических операций
- [ ] Добавить уведомления об успехе/ошибке

**Acceptance:**
- Все AJAX запросы работают корректно
- UI отзывчивый и интуитивный
- Обработка ошибок реализована

---

### Фаза 3: Управление шаблонами (2-3 дня)

#### 3.1. Создать сервис шаблонов (1 день)
**Files:** `apps/web/services/notification_template_service.py`

**Задачи:**
- [ ] Создать `NotificationTemplateService`
- [ ] Реализовать `get_templates()` - список всех шаблонов
- [ ] Реализовать `get_template(template_id)` - получение шаблона
- [ ] Реализовать `create_template()` - создание шаблона
- [ ] Реализовать `update_template()` - обновление шаблона
- [ ] Реализовать `delete_template()` - удаление шаблона
- [ ] Реализовать `test_template()` - тестирование шаблона
- [ ] Добавить валидацию шаблонов

**Acceptance:**
- Все CRUD операции работают корректно
- Валидация предотвращает некорректные шаблоны
- Тестирование шаблонов работает

---

#### 3.2. Создать роуты для шаблонов (1 день)
**Files:** `apps/web/routes/admin_notifications.py`

**Задачи:**
- [ ] Добавить `admin_notifications_templates_list()`
- [ ] Добавить `admin_notifications_template_edit()`
- [ ] Добавить `admin_notifications_template_create()`
- [ ] Добавить `admin_notifications_template_delete()`
- [ ] Добавить `admin_notifications_template_test()`
- [ ] Добавить API endpoints для AJAX операций

**Acceptance:**
- Все роуты доступны только суперадмину
- API endpoints возвращают JSON ответы
- Обработка ошибок реализована

---

#### 3.3. Создать UI для шаблонов (1 день)
**Files:** `apps/web/templates/admin/notifications/templates/`

**Задачи:**
- [ ] Создать `list.html` - список шаблонов
- [ ] Создать `edit.html` - редактор шаблонов
- [ ] Создать `create.html` - создание шаблона
- [ ] Добавить предварительный просмотр шаблонов
- [ ] Добавить синтаксис подсветки для переменных
- [ ] Добавить валидацию в реальном времени

**Acceptance:**
- Редактор шаблонов удобен в использовании
- Предварительный просмотр работает корректно
- Валидация предотвращает ошибки

---

### Фаза 4: Настройки каналов (2 дня)

#### 4.1. Создать сервис настроек каналов (1 день)
**Files:** `apps/web/services/notification_channel_service.py`

**Задачи:**
- [ ] Создать `NotificationChannelService`
- [ ] Реализовать `get_channel_settings()` - получение настроек
- [ ] Реализовать `update_email_settings()` - настройки SMTP
- [ ] Реализовать `update_sms_settings()` - настройки SMS
- [ ] Реализовать `update_push_settings()` - настройки Push
- [ ] Реализовать `update_telegram_settings()` - настройки Telegram
- [ ] Реализовать `test_channel()` - тестирование канала
- [ ] Добавить валидацию настроек

**Acceptance:**
- Все настройки сохраняются корректно
- Тестирование каналов работает
- Валидация предотвращает некорректные настройки

---

#### 4.2. Создать UI настроек (1 день)
**Files:** `apps/web/templates/admin/notifications/settings.html`

**Задачи:**
- [ ] Создать форму настроек Email (SMTP)
- [ ] Создать форму настроек SMS (Twilio/SMSC)
- [ ] Создать форму настроек Push (VAPID)
- [ ] Создать форму настроек Telegram (Bot Token)
- [ ] Добавить кнопки тестирования для каждого канала
- [ ] Добавить индикаторы статуса каналов
- [ ] Добавить валидацию форм

**Acceptance:**
- Все формы работают корректно
- Тестирование каналов показывает результат
- Валидация предотвращает ошибки

---

### Фаза 5: Массовые операции (1-2 дня)

#### 5.1. Создать сервис массовых операций (1 день)
**Files:** `apps/web/services/notification_bulk_service.py`

**Задачи:**
- [ ] Создать `NotificationBulkService`
- [ ] Реализовать `cancel_notifications()` - отмена уведомлений
- [ ] Реализовать `retry_notifications()` - повторная отправка
- [ ] Реализовать `delete_notifications()` - удаление уведомлений
- [ ] Реализовать `send_test_notification()` - тестовая отправка
- [ ] Реализовать `cleanup_old_notifications()` - очистка старых
- [ ] Добавить логирование всех операций

**Acceptance:**
- Все массовые операции работают корректно
- Логирование операций реализовано
- Обработка ошибок реализована

---

#### 5.2. Интегрировать массовые операции (1 день)
**Files:** `apps/web/routes/admin_notifications.py`, `apps/web/static/js/admin/notifications.js`

**Задачи:**
- [ ] Добавить API endpoints для массовых операций
- [ ] Реализовать UI для массового выбора
- [ ] Добавить подтверждения для критических операций
- [ ] Реализовать прогресс-бары для длительных операций
- [ ] Добавить уведомления о результатах операций

**Acceptance:**
- Массовые операции выполняются корректно
- UI показывает прогресс выполнения
- Пользователь получает обратную связь

---

### Фаза 6: Аналитика и отчеты (2 дня)

#### 6.1. Расширить аналитику (1 день)
**Files:** `apps/web/services/admin_notification_service.py`

**Задачи:**
- [ ] Реализовать `get_detailed_analytics()` - детальная аналитика
- [ ] Реализовать `get_user_analytics()` - аналитика по пользователям
- [ ] Реализовать `get_time_analytics()` - аналитика по времени
- [ ] Реализовать `get_error_analytics()` - аналитика ошибок
- [ ] Реализовать `export_analytics()` - экспорт в CSV/Excel
- [ ] Добавить агрегацию данных по периодам

**Acceptance:**
- Аналитика предоставляет детальную информацию
- Экспорт работает корректно
- Производительность запросов оптимизирована

---

#### 6.2. Создать страницу аналитики (1 день)
**Files:** `apps/web/templates/admin/notifications/analytics.html`

**Задачи:**
- [ ] Создать шаблон с графиками и таблицами
- [ ] Добавить фильтры по периоду и типу
- [ ] Добавить интерактивные графики (Chart.js)
- [ ] Добавить таблицы с детальной статистикой
- [ ] Добавить кнопки экспорта отчетов
- [ ] Добавить автоматическое обновление данных

**Acceptance:**
- Графики корректно отображают данные
- Фильтры работают в реальном времени
- Экспорт отчетов работает

---

### Фаза 7: Тесты и документация (1-2 дня)

#### 7.1. Unit тесты (1 день)
**Files:** `tests/unit/test_admin_notification_service.py`

**Задачи:**
- [ ] Тесты для `AdminNotificationService`
- [ ] Тесты для `NotificationTemplateService`
- [ ] Тесты для `NotificationChannelService`
- [ ] Тесты для `NotificationBulkService`
- [ ] Моки для внешних зависимостей
- [ ] Покрытие тестами > 90%

**Acceptance:**
- Все тесты проходят успешно
- Покрытие тестами > 90%
- Моки корректно имитируют зависимости

---

#### 7.2. Integration тесты (1 день)
**Files:** `tests/integration/test_admin_notifications.py`

**Задачи:**
- [ ] Тесты API endpoints
- [ ] Тесты интеграции с базой данных
- [ ] Тесты массовых операций
- [ ] Тесты экспорта отчетов
- [ ] Тесты авторизации и прав доступа

**Acceptance:**
- Все интеграционные тесты проходят
- Тесты покрывают основные сценарии
- Тесты авторизации работают корректно

---

## 🔧 Технологии

### Используемые технологии

- **Backend:** FastAPI, SQLAlchemy, Celery
- **Frontend:** Jinja2, Chart.js, Bootstrap
- **Database:** PostgreSQL с существующими индексами
- **Cache:** Redis для кэширования (существующий)
- **Charts:** Chart.js для графиков
- **Export:** pandas для экспорта в Excel
- **Интеграция:** Существующие модели Notification и PaymentNotification

### Новые зависимости

```python
# requirements.txt
pandas>=2.0.0           # Экспорт в Excel
openpyxl>=3.1.0         # Работа с Excel файлами
```

---

## 📈 Метрики успеха

| Метрика | Целевое значение |
|---------|------------------|
| Время загрузки дашборда | < 2 сек |
| Время фильтрации списка | < 1 сек |
| Покрытие тестами | > 90% |
| Количество ошибок | 0 критических |
| Удобство использования | Высокое |

---

## 🗂 Документация

- **[ITERATION_25_PLAN.md](./ITERATION_25_PLAN.md)** — Детальный план разработки
- **[TECHNICAL_GUIDE.md](./TECHNICAL_GUIDE.md)** — Техническое руководство
- **[roadmap.md](../roadmap.md)** — Общий план проекта

---

## 👥 Роли

### Доступ к админке уведомлений

- **Супер-админ** — полный доступ ко всем функциям
- **Админ** — просмотр статистики и шаблонов (опционально)

### Права доступа

- ✅ Просмотр всех уведомлений
- ✅ Управление шаблонами
- ✅ Настройка каналов доставки
- ✅ Массовые операции
- ✅ Экспорт отчетов
- ✅ Тестирование отправки

---

## 🎨 UI/UX

### Дашборд уведомлений

```
┌─────────────────────────────────────────────────────────────┐
│  📊 Дашборд уведомлений                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐│
│  │ 📧 Email    │ │ 📱 SMS      │ │ 🔔 Push     │ │ 💬 TG   ││
│  │ 1,234       │ │ 456         │ │ 789         │ │ 2,345   ││
│  │ 95% доставка│ │ 98% доставка│ │ 92% доставка│ │ 99%     ││
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘│
│                                                             │
│  📈 Статистика за последние 30 дней                         │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ [График доставки по дням]                                ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  👥 Топ пользователей по активности                         │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 1. Иванов И.И.     - 156 уведомлений                    ││
│  │ 2. Петров П.П.     - 134 уведомления                    ││
│  │ 3. Сидоров С.С.    - 98 уведомлений                     ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### Список уведомлений

```
┌─────────────────────────────────────────────────────────────┐
│  🔍 Уведомления (1,234 записи)                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Фильтры:                                                   │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ Тип: [Все ▼] Статус: [Все ▼] Канал: [Все ▼]            ││
│  │ Дата: [2024-01-01] - [2024-01-31]                      ││
│  │ Поиск: [________________] [🔍]                         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ ☑ ID │ Пользователь │ Тип        │ Канал │ Статус │ Дата││
│  ├─────────────────────────────────────────────────────────┤│
│  │ ☑ 1  │ Иванов И.И.  │ Смена      │ Email │ Отправлено││
│  │ ☑ 2  │ Петров П.П.  │ Договор    │ SMS   │ Доставлено││
│  │ ☑ 3  │ Сидоров С.С. │ Отзыв      │ Push  │ Прочитано││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  Массовые операции: [Отменить] [Повторить] [Удалить]        │
│  Страницы: [<] [1] [2] [3] [4] [5] [>]                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔒 Безопасность

- **Авторизация** — только суперадмин имеет доступ
- **Валидация** — все входные данные проверяются
- **Логирование** — все операции логируются
- **Rate Limiting** — ограничение на массовые операции
- **CSRF защита** — токены для всех форм

---

## 🧪 Тестирование

### Unit тесты
- ✅ AdminNotificationService методы
- ✅ NotificationTemplateService CRUD
- ✅ NotificationChannelService настройки
- ✅ NotificationBulkService операции
- ✅ Валидация и обработка ошибок

### Integration тесты
- ✅ API endpoints админки
- ✅ Интеграция с базой данных
- ✅ Массовые операции
- ✅ Экспорт отчетов
- ✅ Авторизация и права доступа

### E2E тесты
- ✅ Полный цикл управления уведомлениями
- ✅ Создание и тестирование шаблонов
- ✅ Настройка каналов доставки
- ✅ Массовые операции

---

## 📞 Поддержка

**Вопросы?** Создайте Issue в репозитории или напишите в чат поддержки.

**Документация:** [doc/vision_v1/admin/notifications.md](../../vision_v1/admin/notifications.md) (будет создан)

---

## ✅ Критерии готовности

Итерация считается завершенной, когда:

- [x] Дашборд показывает актуальную статистику
- [x] Список уведомлений с фильтрами работает
- [x] Управление шаблонами полностью функционально
- [x] Настройки каналов доставки работают
- [x] Массовые операции выполняются корректно
- [x] Аналитика и экспорт отчетов работают
- [x] Покрытие тестами > 90%
- [x] Документация актуальна и полна
- [x] Нет критических багов
- [x] Код прошел code review
- [x] Деплой на production успешен

---

## 📅 История изменений

### 13 октября 2025 - Фаза 1 завершена ✅

**Реализовано:**
- ✅ Админские роуты (`apps/web/routes/admin_notifications.py`)
- ✅ Сервис аналитики (`apps/web/services/admin_notification_service.py`)
- ✅ Дашборд с графиками (`apps/web/templates/admin/notifications/dashboard.html`)
- ✅ Список уведомлений с фильтрами (`list.html`)
- ✅ Детальная аналитика (`analytics.html`)
- ✅ Пункт "Уведомления" в меню админки
- ✅ Исправлена ошибка инициализации `AdminNotificationService`

**Прогресс:** Фаза 1 (Дашборд и статистика) - 100% ✅

См. [CHANGELOG.md](CHANGELOG.md) для подробной информации.

---

**Итерация 25 — делаем админку уведомлений мощной и удобной! 🚀**
