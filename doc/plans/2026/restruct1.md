# Общий план: медиа-сервис, договоры, KEDO, Max

**Версия:** 1.1 (обновлён с учётом опции хранилища, типов оплаты и НДФЛ)  
**Файл:** `doc/plans/2026/restruct1.md`

---

## Исходные решения (учтены в плане)

- **Порядок:** медиа-сервис → типы/шаблоны/мастер договоров → KEDO и Max.
- **Max:** тот же код `apps/bot`, слой абстракции «мессенджер»; хендлеры работают с событиями от Telegram или Max.
- **Типы и шаблоны:** несколько шаблонов на тип; при создании: выбор типа → выбор шаблона.
- **Устный договор:** только запись в БД (тип, дата, условия), без документа и подписи.
- **KEDO:** отдельный этап; в мастере пока только обычные договоры, ветвление «ЭТД» потом.
- **Медиа и договоры:** договорные документы (сканы, приложения, архив 578н) тоже в едином медиа-сервисе.

---

## Фаза 1: Единый сервис загрузки медиа

Основа — [PHASE_4_MEDIA_STORAGE_PLAN.md](../iteration44/PHASE_4_MEDIA_STORAGE_PLAN.md) с ответами «x». Кратко:

**Хранение:** retention 3 года; доступ владелец + управляющие + сотрудник (свои); presigned URLs; типы и лимиты: фото 5 МБ, видео 50 МБ, документы 100 МБ. **Selectel:** да, private + presigned, без CDN. **Существующие данные:** оставить в Telegram; новые — в Object Storage. **Обратная совместимость:** поддерживать Telegram и S3 параллельно. **Presigned:** срок настраиваемый (1 ч–7 дн), кэш на клиенте.

**Структура медиа по папкам:**

- `tasks/{entry_id}/`, `incidents/{incident_id}/`, `cancellations/{cancellation_id}/` — как в PHASE_4;
- `contracts/{contract_id}/` — под сканы, приложения, будущий архив 578н (папка вводится в Фазе 1, использование — в Фазах 2 и при KEDO).

**Ключевые отличия от черновика PHASE_4:**

- Медиа отмен: **таблица `shift_cancellation_media`** (по аналогии с `ReviewMedia`), не JSON `media_meta`. Миграция: добавить таблицу, убрать использование `document_description` в пользу медиа.
- Shared-страница отмены: загрузка/просмотр/удаление до модерации, модерация владельцем/управляющим; использовать на `/owner/`, `/manager/`, `/employee/` (редирект на shared).

### 1.1. Опция «Использовать защищённое хранилище файлов»

- Ввести функцию/опцию **«Использовать защищённое хранилище файлов»** (secure media storage). Включение даёт доступ к Object Storage (S3/Selectel) вместо или вдобавок к Telegram.
- **Выбор по собственнику:** у каждого владельца (owner) — настройки, **что и где** сохранять:
  - Контексты: задачи (Tasks v2), отмены смен, инциденты, договоры (сканы/приложения).
  - По каждому контексту — выбор: **только Telegram**, **только хранилище** или **оба** (например, TG для превью, хранилище для долгосрочного хранения).
- Хранить настройки в БД: например, таблица `owner_media_storage_options` (или поля в `OwnerProfile` / аналоге): `owner_id`, контекст (`tasks` | `cancellations` | `incidents` | `contracts`), `storage` (`telegram` | `storage` | `both`). Либо JSON по owner’у.
- При загрузке медиа: смотреть настройки владельца объекта/договора и направлять в TG, в хранилище или в оба в соответствии с выбором.

### 1.2. Цены хранения и учёт в биллинге

- Ввести возможность **установки цен** на хранение в разрезе:
  - **Telegram** (если тарифицируется);
  - **Хранилище** (Object Storage);
  - **Опция** «Использовать защищённое хранилище» (доп. плата за включение опции, не за объём).
- Цены задаются на уровне тарифного плана (или глобального прайса): например, поля/справочник `tariff_storage_prices` или расширение `TariffPlan`: `storage_price_telegram`, `storage_price_object_storage`, `storage_option_price` (за опцию).
- **Лог изменений тарифных планов:** вести историю изменений тарифов и **включения/выключения опций** (в т.ч. «защищённое хранилище») по подписке. Варианты:
  - Отдельная таблица `tariff_plan_change_log` (или `subscription_option_log`): `subscription_id`, `changed_at`, `old_tariff_id`, `new_tariff_id`, `options_enabled` (JSON), `options_disabled` (JSON), и т.п.
  - Либо расширить существующий аудит, если он есть — главное, чтобы фиксировалось включение/отключение опции «защищённое хранилище» и момент изменения.
- **Расчёт итоговой стоимости подписки к оплате:** при формировании счёта/оплаты учитывать:
  - базовую цену тарифа;
  - доплату за опцию «Использовать защищённое хранилище», если она включена у владельца;
  - при необходимости — отдельно тарификацию по объёму TG/хранилища (если решим считать по объёму). На первом этапе достаточно учёта **включения опции** и фиксированной цены за неё.
- Итоговая сумма к оплате клиентом = база тарифа + цена опции хранилища (если включена) + прочие опции. Лог изменений тарифов/опций используется для корректного расчёта на период действия подписки (в т.ч. при смене тарифа или отключении опции в середине периода).

### 1.3. Этапы Фазы 1 (сводка)

1. Техаудит (MediaOrchestrator, места использования, форматы).
2. Хранилище: MinIO (dev), Selectel (prod), `.env`, фабрика провайдеров.
3. `MediaStorageClient` (abc), `TelegramMediaStorageClient`, `S3MediaStorageClient`, фабрика, обновление `MediaOrchestrator`.
4. Миграция: `shift_cancellation_media`; shared-страница отмены; редиректы owner/manager/employee; обновление бота и `ShiftCancellationService`.
5. **Опция «Использовать защищённое хранилище»:** настройки по владельцу (что/где хранить); выбор TG / хранилище / оба по контекстам.
6. **Цены хранения:** TG, хранилище, опция; привязка к тарифам; лог изменений тарифов и опций; учёт опций в расчёте стоимости подписки к оплате.
7. Документация (обновление `doc/vision_v1/*`, `env.example`, `S3_STORAGE_SETUP.md`, `CHANGELOG_PHASE1.md`), тесты (unit + manual `RESTRUCT1_PHASE1_MANUAL_TESTING.md`), деплой Фазы 1 на prod.

**Риски:** уже учтены в PHASE_4. Дополнительно: не трогать текущие договоры до Фазы 2.

---

## Фаза 2: Типы договоров, шаблоны, мастер заключения

### 2.1. Типы договоров и связь с шаблонами

- Ввести справочник типов договоров. Рекомендация: **таблица `contract_types`** (id, code, label). Коды: `employment`, `gpc_individual`, `gpc_self_employed`, `gpc_sole_proprietor`, `apprenticeship`, `oral`.
- `ContractTemplate`: добавить `contract_type_id` (FK). Один тип — много шаблонов.
- `Contract`: добавить `contract_type_id`. При создании тип задаётся явно (из шаблона или выбором для устного).

### 2.2. Устный договор

- Отдельная ветка в мастере: тип «Устный» → сотрудник, даты, объекты, описание. Без шаблона, без документа, без подписи. Только запись в БД.

### 2.3. Тип оплаты и ставка

- Сейчас: только **почасовая ставка** (`hourly_rate`). Добавить **тип оплаты** с выбором:
  - **«За час»** (текущее поведение): ставка за час, расчёт по отработанным часам.
  - **«За смену»**: ставка за смену; при расчёте зарплаты — сумма за смену × число смен (часы не используются для расчёта суммы, только для учёта).
  - **«В месяц»**: фиксированная сумма в месяц; при расчёте — пропорция по отработанным дням/часам или полная сумма за месяц по правилам, которые заложим.
- **Реализация:** новое поле `payment_type` (`per_hour` | `per_shift` | `per_month`). При `per_shift` — хранить «ставку за смену» (например, `shift_rate` или переиспользовать `hourly_rate` как «ставка за смену» с семантикой по типу). При `per_month` — `monthly_rate`. Либо одно поле `rate` + `payment_type`. Добавить поля в `Contract`, миграции.
- **Мастер и страницы договора:** выбор типа оплаты и соответствующего поля (за час / за смену / в месяц) — и в **мастере** заключения, и на странице **создания** и **редактирования** договора.

### 2.4. Налог (НДФЛ) и «на руки» / «до вычета налогов»

- Добавить параметр **«На руки»** / **«До вычета налогов»** (`tax_mode` или аналог):
  - **«До вычета налогов» (gross):** указанная в договоре сумма — начисление (gross). НДФЛ 13% удерживаем из неё.
  - **«На руки» (net):** указанная сумма — желаемая выплата сотруднику. Доначисляем gross из net (например, `gross = net / (1 - 0.13)`), затем удерживаем НДФЛ 13%.
- **Применимость:** для всех типов договоров **кроме устного**. Устный — без НДФЛ и без этой настройки.
- **Интеграция с расчётом зарплаты:** при формировании `PayrollEntry` и расчёте `gross_amount`, `total_deductions`, `net_amount` учитывать `tax_mode` и `payment_type`. Логика НДФЛ единая: либо «gross задан — удерживаем 13%», либо «net задан — восстанавливаем gross, удерживаем 13%». Детали (округление, учёт вычетов и т.п.) оформить в сервисе расчёта зарплаты.
- **UI:** выбор «На руки» / «До вычета налогов» — в мастере и на страницах создания/редактирования договора (для неустных типов).

### 2.5. Модификация шаблонов

- Расширить `ContractTemplate` под типы: `contract_type_id`, при необходимости — доработка `fields_schema` под разные типы.
- UI: фильтрация шаблонов по типу при создании; при необходимости — доработка админки шаблонов.

### 2.6. Мастер заключения вместо страницы

- Заменить форму «Создание договора» на **пошаговый мастер**. Шаги:
  1. Тип договора (в т.ч. «Устный»).
  2. Сотрудник.
  3. Шаблон (для устного пропуск).
  4. Поля по шаблону + **общие:** даты, объекты, **тип оплаты** (за час / за смену / в месяц), **ставка**, **«На руки» / «До вычета налогов»** (для неустных).
  5. Превью.
  6. Завершение (сохранение, активация).
- Реализация: multi-step форма (маршруты или `step`), состояние в сессии/Redis. Существующие `ContractService` и `Contract` — без дублирования логики.
- Детали, редактирование, расторжение — без изменений. На странице **редактирования** договора добавить те же поля: тип оплаты, ставка, «На руки»/«До вычета налогов».

### 2.7. Хранение документов по договорам в медиа

- Использовать папку `contracts/{contract_id}/` в медиа-сервисе. На Фазе 2 — опционально загрузка скан-копий/приложений. Полноценное использование (в т.ч. 578н) — при KEDO.

### 2.8. Зависимости и риски

- **Зависимости:** Фаза 1 завершена (медиа, опция хранилища, цены, лог тарифов).
- **Риски:** устный договор без НДФЛ и без типа оплаты в смысле «ставка»; мастер и расчёт зарплаты не ломают текущие контракты и payroll.

---

## Фаза 3: KEDO (кадровое ЭДО)

- Опираться на [KEDO.md](KEDO.md): KYC, УКЭП работодателя, УНЭП/УКЭП работника (Госключ), архив по 578н.
- В мастере: ветвление «обычный договор» / «ЭТД» (после выбора типа и шаблона). ЭТД — только для подходящих типов (например, Трудовой).
- Договорные документы и архив 578н хранить в медиа-сервисе (`contracts/{id}/`).
- Детальный план KEDO — отдельный документ.

---

## Фаза 4: Бот Max и мессенджер-адаптер

- **Цель:** один код `apps/bot`, работа с Telegram и Max.
- **Архитектура:** слой «мессенджер» (источник событий); адаптеры Telegram и Max. Хендлеры получают нормализованные события.
- **Медиа:** загрузка из Max — через `MediaOrchestrator` и `MediaStorageClient`. Уведомления о договорах при KEDO — отправка через Max API, подписание в Госключе.
- **Зависимости:** Фаза 1 (медиа, опция хранилища) желательна до Max.

---

## Порядок работ и артефакты

| Фаза | Что делаем | Ключевые артефакты |
|------|------------|---------------------|
| 1 | Медиа-сервис + опция хранилища + биллинг | `MediaStorageClient`, S3/TG, `shift_cancellation_media`, shared-страница отмены, папка `contracts/`; опция «Защищённое хранилище», настройки по owner; цены TG/хранилище/опция; лог изменений тарифов и опций; учёт в стоимости подписки |
| 2 | Типы, шаблоны, мастер, оплата и НДФЛ | `contract_types`, доработка `Contract`/`ContractTemplate`; `payment_type`, `tax_mode`, ставки; мастер в веб; правки создания/редактирования; интеграция с расчётом зарплаты |
| 3 | KEDO | Ветвление ЭТД в мастере, KYC, Госключ, 578н, хранение в медиа |
| 4 | Max | Мессенджер-адаптер, Max-адаптер, медиа и при KEDO — отправка на подпись |

---

## Сводка по решениям из PHASE_4 («x»)

- Retention 3 года; доступ владелец + управляющие + сотрудник; presigned.
- Файлы: все типы, лимиты 5 / 50 / 100 МБ.
- Существующие в TG не мигрируем; новые — Object Storage; поддержка TG + S3.
- Selectel: private, presigned, без CDN.
- Presigned: настраиваемый TTL, кэш на клиенте.
- Отмена смен: shared-страница, загрузка/просмотр/удаление/модерация; `shift_cancellation_media`; отказ от `document_description` в пользу медиа.

---

## Что не меняем

- Текущие роуты договоров (детали, расторжение) и расчёт payroll — работают как раньше; **расширяем** расчёт учётом `payment_type` и `tax_mode`.
- Роли и префиксы, правила `user_id`/`telegram_id`, `URLHelper`, `get_db_session`, shared calendar — без изменений.
