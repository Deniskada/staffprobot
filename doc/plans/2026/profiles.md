## Профили пользователей и KYC‑верификация (2026)

### Статус этапов

| Блок                            | Описание                                                                                       | Статус      |
|---------------------------------|------------------------------------------------------------------------------------------------|-------------|
| Доменная модель                 | Таблицы `profiles`, `individual_profiles`, `legal_profiles`, `sole_proprietor_profiles`, `addresses` | **Готово**  |
| Backend‑API профилей и адресов  | `/api/profiles/*`, `/api/addresses/*`, сервис `ProfileService`                                | **Готово**  |
| Веб‑мастер профилей             | Страница `/owner/profiles` с мастером‑вкладками и общим компонентом выбора адреса             | **Готово**  |
| KYC‑слой                        | Поля `kyc_*` в `Profile`, сервис `KycService`, API `/api/profiles/{id}/kyc/*`                 | **Готово**  |
| Миграция схемы                  | Alembic‑миграция `20260128_profiles_and_addresses.py`                                         | **Готово**  |
| Миграция данных из старых профилей | Перенос данных из `OwnerProfile`/`OrganizationProfile` в новую модель                         | **Планируется** |
| Обновление договоров/шаблонов   | Переход на использование `Profile` в договорной логике и шаблонах                             | **Планируется** |

### Цели

- Разрешить нескольким профилям (ФЛ, ИП, ЮЛ) существовать для одного Telegram‑ID пользователя.
- Дать владельцу, управляющему и сотруднику единый мастер‑интерфейс для создания и редактирования профилей на веб‑портале.
- Подготовить слой KYC‑верификации профилей через провайдер госуслуг с отметкой «Профиль подтвержден».

### Доменная модель

- Ввести базовую сущность `Profile` с полями `user_id`, `profile_type` (`individual`, `legal`, `sole_proprietor`), `display_name`, `is_default`, `is_archived`.
- Вынести типоспецифичные данные в отдельные таблицы:
  - `individual_profiles` — физическое лицо (гражданство, ФИО, паспорт, СНИЛС/ИНН, контакты, банковские реквизиты, адрес регистрации).
  - `legal_profiles` — юридическое лицо (полное наименование, ОГРН, ИНН, ОКПО, адрес в РФ, представитель‑физлицо, контакты и банк).
  - `sole_proprietor_profiles` — индивидуальный предприниматель (ФИО, ОГРНИП, ИНН, ОКПО, адрес проживания, контакты и банк).
- Создать нормализованную сущность адреса `Address` и использовать `address_id`‑ссылки в профилях вместо хранения адресов строкой.
  - В `Address` хранить `user_id` добавившего адрес (внутренний ID пользователя), чтобы в дальнейшем можно было предлагать пользователю «его» адреса.
  - При создании нового объекта (`/owner/objects/create`) пополнять локальную базу адресов, сохраняя связку `user_id` + человекочитаемый адрес объекта.

### KYC‑слой

- Добавить в `Profile` KYC‑поля: `kyc_status` (`unverified`, `pending`, `verified`, `failed`), `kyc_provider`, `kyc_verified_at`, `kyc_metadata` (JSON).
- Реализовать абстрактный сервис `KycService` и интерфейс провайдера `KycProvider` с базовой реализацией `GosuslugiKycProvider` (пока как заглушка).
- Определить API:
  - `POST /api/profiles/{id}/kyc/start` — инициировать KYC‑поток профиля.
  - `POST /api/profiles/{id}/kyc/mark-verified` — временный endpoint для пометки профиля как подтверждённого (до полноценного callback’а госуслуг).
- На веб‑странице мастера профилей (`/owner/profiles`) отображать бейдж «Профиль подтвержден» и кнопку «Подтвердить через Госуслуги», вызывающую KYC‑API.

### Веб‑интерфейс

- Для владельца добавить страницу `/owner/profiles` с общей разметкой:
  - Левая колонка — список профилей текущего пользователя с типом (ФЛ / ИП / ЮЛ), флагом «по умолчанию» и отметкой KYC.
  - Правая колонка — мастер‑форма на вкладках:
    - «Основные данные» (типозависимые блоки ФЛ / ИП / ЮЛ).
    - «Документы» (паспорт/ОГРН/ОГРНИП и др.).
    - «Адреса» (через общий модальный компонент выбора адреса и работу с таблицей `addresses`).
    - «Контакты».
    - «Банковские реквизиты».
- Сделать форму полноэкранным мастером без вертикальной прокрутки между шагами, с навигацией «Назад/Далее» и итоговой кнопкой «Сохранить профиль».
- Вынести выбор/создание адреса в общий модальный компонент, работающий через API `/api/addresses/search` и `POST /api/addresses`.

### Backend‑API

- Ввести shared‑роутер `/api/profiles` (доступен owner/manager/employee):
  - `GET /api/profiles/` — список профилей пользователя.
  - `GET /api/profiles/{id}` — получение одного профиля.
  - `POST /api/profiles/` — создание профиля (базовые поля + details payload).
  - `PUT /api/profiles/{id}` — обновление профиля и типоспецифичных деталей.
  - `DELETE /api/profiles/{id}` — архивирование профиля.
  - `POST /api/profiles/{id}/set-default` — установка профиля по умолчанию.
- Реализовать сервис `ProfileService` в `shared/services` для инкапсуляции логики CRUD и маппинга DTO.

### Миграции и этапность

- Добавить миграцию `20260128_profiles_and_addresses.py`, создающую таблицы:
  - `addresses` — база адресов.
  - `profiles`, `individual_profiles`, `legal_profiles`, `sole_proprietor_profiles` — новая модель профилей.
- На первом этапе:
  - Запустить миграцию, не трогая существующие `owner_profiles` и `organization_profiles`.
  - Включить страницу `/owner/profiles` и API `/api/profiles`, дав владельцу возможность заполнять новые профили.
- На следующем этапе:
  - Спланировать и реализовать скрипт миграции данных из `OwnerProfile`/`OrganizationProfile` в новые таблицы (создание стартовых профилей для существующих владельцев).
  - Перевести использование реквизитов и профиля собственника в договорах и шаблонах на новую модель, затем постепенно выводить старые структуры из эксплуатации.

