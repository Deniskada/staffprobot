# –ò—Ç–µ—Ä–∞—Ü–∏—è 44, –§–∞–∑–∞ 4: –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞ - –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 14.12.2025  
**–°—Ç–∞—Ç—É—Å:** –í –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–û—Ü–µ–Ω–∫–∞:** 8-10 –¥–Ω–µ–π

---

## üìã –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. **MediaOrchestrator** (`shared/services/media_orchestrator.py`):
   - ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞–º–∏ –º–µ–¥–∏–∞ —á–µ—Ä–µ–∑ Redis (state machine)
   - ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (require_text, require_photo, max_photos)
   - ‚úÖ –ú–µ—Ç–æ–¥—ã: `begin_flow()`, `add_text()`, `add_photo()`, `finish()`, `cancel()`
   - ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç: Tasks v2, –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω (—á–∞—Å—Ç–∏—á–Ω–æ)

2. **–¢–µ–∫—É—â–µ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥–∏–∞:**
   - **Telegram file_id**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –±–æ—Ç–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
   - **TaskEntryV2.completion_media**: JSON `[{"url": "...", "type": "photo"}]` - —Å—Å—ã–ª–∫–∏ –Ω–∞ Telegram –ø–æ—Å—Ç—ã
   - **Incident.evidence_media_ids**: Text (JSON list) - —Å–ø–∏—Å–æ–∫ ID –º–µ–¥–∏–∞
   - **ShiftCancellation**: –Ω–µ—Ç –ø–æ–ª—è –¥–ª—è –º–µ–¥–∏–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å)

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
   - Tasks v2: —Ñ–æ—Ç–æ-–æ—Ç—á—ë—Ç—ã —á–µ—Ä–µ–∑ MediaOrchestrator ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `completion_media`
   - –û—Ç–º–µ–Ω—ã —Å–º–µ–Ω: —á–∞—Å—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ MediaOrchestrator (–≤ –±–æ—Ç–µ)
   - –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã: –∑–∞–≥–ª—É—à–∫–∞ (–ø–æ–ª–µ –µ—Å—Ç—å, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è

1. **–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:**
   - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `MediaStorageClient` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏
   - –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã: `TelegramMediaStorageClient` (—Ç–µ–∫—É—â–∏–π), `S3MediaStorageClient` (Selectel/MinIO)
   - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (dev/prod)

2. **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `media_meta` –≤ `ShiftCancellation`
   - –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram file_id –≤ Object Storage
   - –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Telegram (fallback)

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - –û–±–Ω–æ–≤–∏—Ç—å `MediaOrchestrator` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
   - –°–æ–∑–¥–∞—Ç—å shared-—Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
   - –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—ã owner/manager/employee

---

## ‚ùì –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã

### 1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é

**1.1. Retention (—Å—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è):**
- –ö–∞–∫–æ–π —Å—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤?
  - [ ] –ë–µ—Å—Å—Ä–æ—á–Ω–æ (–¥–æ —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é)
  - [ ] –ü–æ —Å—Ä–æ–∫—É –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏)
  - [ ] –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 –≥–æ–¥, 3 –≥–æ–¥–∞)
  - [ ] –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –≤–ª–∞–¥–µ–ª—å—Ü–µ–º

**1.2. –î–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º:**
- –ö—Ç–æ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞?
  - [ ] –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –æ–±—ä–µ–∫—Ç–∞
  - [ ] –í–ª–∞–¥–µ–ª–µ—Ü + —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –æ–±—ä–µ–∫—Ç–∞
  - [ ] –í–ª–∞–¥–µ–ª–µ—Ü + —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ + —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ (–¥–ª—è —Å–≤–æ–∏—Ö —Ñ–∞–π–ª–æ–≤)
  - [ ] –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø (presigned URLs —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å—Ä–æ–∫–æ–º)

**1.3. –¢–∏–ø—ã —Ñ–∞–π–ª–æ–≤:**
- –ö–∞–∫–∏–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å?
  - [ ] –¢–æ–ª—å–∫–æ —Ñ–æ—Ç–æ (jpg, png, webp)
  - [ ] –§–æ—Ç–æ + –≤–∏–¥–µ–æ (mp4, mov, avi)
  - [ ] –§–æ—Ç–æ + –≤–∏–¥–µ–æ + –¥–æ–∫—É–º–µ–Ω—Ç—ã (pdf, doc, docx)
  - [ ] –í—Å–µ —Ç–∏–ø—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞

**1.4. –õ–∏–º–∏—Ç—ã —Ä–∞–∑–º–µ—Ä–∞:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:
  - [ ] 5 –ú–ë (–¥–ª—è —Ñ–æ—Ç–æ)
  - [ ] 50 –ú–ë (–¥–ª—è –≤–∏–¥–µ–æ)
  - [ ] 100 –ú–ë (–¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
  - [ ] –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–æ —Ç–∏–ø—É —Ñ–∞–π–ª–∞

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**2.1. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
- –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ–¥–∏–∞ –≤ Telegram?
  - [ ] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –≤ Object Storage (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è)
  - [ ] –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ Object Storage
  - [ ] –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é (lazy migration)

**2.2. Telegram file_id:**
- –ù—É–∂–Ω–∞ –ª–∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Telegram file_id?
  - [ ] –î–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–±–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
  - [ ] –ù–µ—Ç, –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ Object Storage
  - [ ] –î–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è (fallback)

### 3. Selectel Object Storage

**3.1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç Selectel?
  - [ ] –î–∞, –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å –±–∞–∫–µ—Ç
  - [ ] –ù–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  - [ ] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

**3.2. –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞:**
- –ö–∞–∫–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–Ω—ã?
  - [ ] Private (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ presigned URLs)
  - [ ] Public read (–¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞)
  - [ ] IAM —Ä–æ–ª–∏ (–≤–ª–∞–¥–µ–ª–µ—Ü/—É–ø—Ä–∞–≤–ª—è—é—â–∏–π/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫)

**3.3. CDN:**
- –ù—É–∂–µ–Ω –ª–∏ CDN –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ –º–µ–¥–∏–∞?
  - [ ] –î–∞, —á–µ—Ä–µ–∑ Selectel CDN
  - [ ] –ù–µ—Ç, –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Object Storage
  - [ ] –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ)

### 4. Presigned URLs

**4.1. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:**
- –ö–∞–∫–æ–π —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è presigned URLs?
  - [ ] 1 —á–∞—Å (–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ)
  - [ ] 24 —á–∞—Å–∞ (–¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)
  - [ ] –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π (1 —á–∞—Å - 7 –¥–Ω–µ–π)

**4.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL:**
- –ö–∞–∫ –æ–±–Ω–æ–≤–ª—è—Ç—å –∏—Å—Ç—ë–∫—à–∏–µ URLs?
  - [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ URL)
  - [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é)
  - [ ] –ü—Ä–µ–¥–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

### 5. Shared-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω

**5.1. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ö–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ?
  - [ ] –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—Ñ–æ—Ç–æ —Å–ø—Ä–∞–≤–æ–∫)
  - [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - [ ] –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–¥–æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏)
  - [ ] –ú–æ–¥–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–≤–ª–∞–¥–µ–ª–µ—Ü/—É–ø—Ä–∞–≤–ª—è—é—â–∏–π)

**5.2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ì–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å shared-—Å—Ç—Ä–∞–Ω–∏—Ü—É?
  - [ ] `/owner/shifts/{id}/cancel` - –æ—Ç–º–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
  - [ ] `/manager/shifts/{id}/cancel` - –æ—Ç–º–µ–Ω–∞ —É–ø—Ä–∞–≤–ª—è—é—â–∏–º
  - [ ] `/employee/shifts/{id}/cancel` - –æ—Ç–º–µ–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º
  - [ ] –í—Å–µ –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ

### 6. –ú–∏–≥—Ä–∞—Ü–∏—è ShiftCancellation

**6.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**
- –ö–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å –º–µ–¥–∏–∞ –≤ `ShiftCancellation`?
  - [ ] JSON –ø–æ–ª–µ `media_meta`: `[{"url": "...", "type": "photo", "size": 12345}]`
  - [ ] –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `shift_cancellation_media` (–∫–∞–∫ –≤ ReviewMedia)
  - [ ] –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: JSON –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

**6.2. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- –ù—É–∂–Ω–∞ –ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ `document_description`?
  - [ ] –î–∞, –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)
  - [ ] –ù–µ—Ç, –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –º–µ–¥–∏–∞
  - [ ] –î–∞, –Ω–æ –ø–æ–º–µ—á–∞—Ç—å –∫–∞–∫ deprecated

---

## üìù –ü–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (1 –¥–µ–Ω—å)

**–ó–∞–¥–∞—á–∏:**
- [ ] 1.1. –ê—É–¥–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `MediaOrchestrator`:
  - –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (tasks, incidents, cancellations)
  - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö (file_id, URL, JSON)
  - –û—Ü–µ–Ω–∏—Ç—å –æ–±—ä—ë–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

- [ ] 1.2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É:
  - Retention –ø–æ–ª–∏—Ç–∏–∫–∏
  - –õ–∏–º–∏—Ç—ã —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤
  - –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (IAM/ACL)

- [ ] 1.3. –ò–∑—É—á–∏—Ç—å Selectel Object Storage API:
  - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ API
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∫–µ—Ç–æ–≤ –∏ –ø–æ–ª–∏—Ç–∏–∫
  - Presigned URLs –∏ CDN

- [ ] 1.4. –ò–∑—É—á–∏—Ç—å MinIO –¥–ª—è dev –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  - Docker –æ–±—Ä–∞–∑ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  - S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å docker-compose.dev.yml

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –î–æ–∫—É–º–µ–Ω—Ç —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –û—Ü–µ–Ω–∫–∞ –æ–±—ä—ë–º–∞ —Ä–∞–±–æ—Ç

---

### –≠—Ç–∞–ø 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (1-2 –¥–Ω—è)

#### 2.1. MinIO –¥–ª—è dev (0.5 –¥–Ω—è)

**–ó–∞–¥–∞—á–∏:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å MinIO –≤ `docker-compose.dev.yml`:
  ```yaml
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
  ```

- [ ] –°–æ–∑–¥–∞—Ç—å –±–∞–∫–µ—Ç `staffprobot-media` –≤ MinIO
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (private –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env`:
  ```
  MEDIA_STORAGE_PROVIDER=minio  # minio | selectel | telegram
  MINIO_ENDPOINT=http://minio:9000
  MINIO_ACCESS_KEY=minioadmin
  MINIO_SECRET_KEY=minioadmin
  MINIO_BUCKET=staffprobot-media
  MINIO_USE_SSL=false
  ```

**–§–∞–π–ª—ã:**
- `docker-compose.dev.yml` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ MinIO
- `.env` - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### 2.2. Selectel Object Storage –¥–ª—è prod (1 –¥–µ–Ω—å)

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç –≤ Selectel (–µ—Å–ª–∏ –Ω–µ—Ç)
- [ ] –°–æ–∑–¥–∞—Ç—å –±–∞–∫–µ—Ç `staffprobot-media-prod`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å IAM/ACL:
  - –°–æ–∑–¥–∞—Ç—å IAM –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (read/write –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, read –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤)
  - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞)

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env` (prod):
  ```
  MEDIA_STORAGE_PROVIDER=selectel
  SELECTEL_ENDPOINT=https://s3.selcdn.ru
  SELECTEL_ACCESS_KEY=<access_key>
  SELECTEL_SECRET_KEY=<secret_key>
  SELECTEL_BUCKET=staffprobot-media-prod
  SELECTEL_REGION=ru-1
  SELECTEL_CDN_ENABLED=false  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  ```

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD —Å–µ–∫—Ä–µ—Ç—ã (GitHub Actions):
  - –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
  - –û–±–Ω–æ–≤–∏—Ç—å deployment —Å–∫—Ä–∏–ø—Ç—ã

**–§–∞–π–ª—ã:**
- `.env.prod.example` - –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
- `deployment/scripts/setup-selectel-storage.sh` - —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

### –≠—Ç–∞–ø 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ (2-3 –¥–Ω—è)

#### 3.1. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å MediaStorageClient (0.5 –¥–Ω—è)

**–§–∞–π–ª:** `shared/services/media_storage/__init__.py`

```python
from abc import ABC, abstractmethod
from typing import Optional, List, Dict, Any
from dataclasses import dataclass

@dataclass
class MediaFile:
    """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞."""
    key: str  # –ü—É—Ç—å –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "tasks/123/photo_1.jpg")
    url: str  # –ü—É–±–ª–∏—á–Ω—ã–π URL –∏–ª–∏ presigned URL
    type: str  # "photo" | "video" | "document"
    size: int  # –†–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö
    mime_type: str  # MIME —Ç–∏–ø
    uploaded_at: datetime
    metadata: Dict[str, Any]  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

class MediaStorageClient(ABC):
    """–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –º–µ–¥–∏–∞."""
    
    @abstractmethod
    async def upload(
        self,
        file_content: bytes,
        file_name: str,
        content_type: str,
        folder: str,  # "tasks" | "incidents" | "cancellations"
        metadata: Optional[Dict[str, Any]] = None
    ) -> MediaFile:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ."""
        pass
    
    @abstractmethod
    async def get_url(
        self,
        key: str,
        expires_in: int = 3600  # –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è URL –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    ) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å URL –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É (presigned –∏–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π)."""
        pass
    
    @abstractmethod
    async def delete(self, key: str) -> bool:
        """–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞."""
        pass
    
    @abstractmethod
    async def list_files(
        self,
        folder: str,
        prefix: Optional[str] = None
    ) -> List[MediaFile]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ."""
        pass
    
    @abstractmethod
    async def exists(self, key: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞."""
        pass
```

#### 3.2. TelegramMediaStorageClient (0.5 –¥–Ω—è)

**–§–∞–π–ª:** `shared/services/media_storage/telegram_client.py`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Telegram Bot API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç file_id –≤ –ë–î
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL —á–µ—Ä–µ–∑ `get_file` API
- Fallback –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–ú–µ—Ç–æ–¥—ã:**
- `upload()` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ Telegram, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç file_id
- `get_url()` - –ø–æ–ª—É—á–∞–µ—Ç URL —á–µ—Ä–µ–∑ `bot.get_file(file_id).file_path`
- `delete()` - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (Telegram –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–¥–∞–ª—è—Ç—å)
- `list_files()` - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–Ω–µ—Ç —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤)

#### 3.3. S3MediaStorageClient (1 –¥–µ–Ω—å)

**–§–∞–π–ª:** `shared/services/media_storage/s3_client.py`

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `boto3` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º API
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ MinIO –∏ Selectel

**–ú–µ—Ç–æ–¥—ã:**
- `upload()` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç —á–µ—Ä–µ–∑ `boto3.client('s3').upload_fileobj()`
- `get_url()` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç presigned URL —á–µ—Ä–µ–∑ `generate_presigned_url()`
- `delete()` - —É–¥–∞–ª—è–µ—Ç —á–µ—Ä–µ–∑ `delete_object()`
- `list_files()` - –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ `list_objects_v2()`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫:**
```
staffprobot-media/
  tasks/
    {entry_id}/
      photo_1.jpg
      video_1.mp4
  incidents/
    {incident_id}/
      evidence_1.jpg
  cancellations/
    {cancellation_id}/
      document_1.jpg
```

#### 3.4. –§–∞–±—Ä–∏–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (0.5 –¥–Ω—è)

**–§–∞–π–ª:** `shared/services/media_storage/factory.py`

```python
from core.config.settings import settings
from shared.services.media_storage.telegram_client import TelegramMediaStorageClient
from shared.services.media_storage.s3_client import S3MediaStorageClient

def get_media_storage_client() -> MediaStorageClient:
    """–ü–æ–ª—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –º–µ–¥–∏–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."""
    provider = settings.media_storage_provider  # "telegram" | "minio" | "selectel"
    
    if provider == "telegram":
        return TelegramMediaStorageClient()
    elif provider in ["minio", "selectel"]:
        return S3MediaStorageClient(
            endpoint=settings.media_storage_endpoint,
            access_key=settings.media_storage_access_key,
            secret_key=settings.media_storage_secret_key,
            bucket=settings.media_storage_bucket,
            region=settings.media_storage_region
        )
    else:
        raise ValueError(f"Unknown media storage provider: {provider}")
```

#### 3.5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MediaOrchestrator (0.5 –¥–Ω—è)

**–§–∞–π–ª:** `shared/services/media_orchestrator.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `MediaStorageClient`
- –í `finish()` - –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ `MediaStorageClient.upload()`
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (key, url, type, size) –≤–º–µ—Å—Ç–æ file_id
- –û–±–Ω–æ–≤–∏—Ç—å `MediaFlowConfig.collected_photos` - —Ö—Ä–∞–Ω–∏—Ç—å `MediaFile` –≤–º–µ—Å—Ç–æ file_id

**–ü—Ä–∏–º–µ—Ä:**
```python
async def finish(self, user_id: int) -> Optional[MediaFlowConfig]:
    """–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ—Ç–æ–∫ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ."""
    cfg = await self.get_flow(user_id)
    if not cfg:
        return None
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–¥–∏–∞ —á–µ—Ä–µ–∑ MediaStorageClient
    from shared.services.media_storage.factory import get_media_storage_client
    storage = get_media_storage_client()
    
    uploaded_files = []
    for file_id in cfg.collected_photos:
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∏–∑ Telegram (–µ—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä - telegram)
        # –ò–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é (–µ—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä - s3)
        media_file = await storage.upload(...)
        uploaded_files.append(media_file)
    
    cfg.collected_photos = uploaded_files  # –¢–µ–ø–µ—Ä—å —ç—Ç–æ MediaFile[]
    
    # –û—á–∏—â–∞–µ–º –ø–æ—Ç–æ–∫
    key = self._make_key(user_id)
    await self.redis.delete(key)
    
    return cfg
```

---

### –≠—Ç–∞–ø 4: –ú–∏–≥—Ä–∞—Ü–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (2 –¥–Ω—è)

#### 4.1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ media_meta –≤ ShiftCancellation (0.5 –¥–Ω—è)

**–§–∞–π–ª:** `migrations/versions/XXXX_add_media_meta_to_shift_cancellations.py`

```python
def upgrade():
    op.add_column(
        'shift_cancellations',
        sa.Column('media_meta', sa.JSON, nullable=True)
    )
    # media_meta: [{"key": "...", "url": "...", "type": "photo", "size": 12345}]
```

#### 4.2. Shared-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω (1 –¥–µ–Ω—å)

**–§–∞–π–ª:** `apps/web/templates/shared/shifts/cancel.html`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –§–æ—Ä–º–∞ –æ—Ç–º–µ–Ω—ã —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–∏—á–∏–Ω—ã
- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (drag&drop –∏–ª–∏ file input)
- –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –ö–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤, —Ä–∞–∑–º–µ—Ä, —Ç–∏–ø

**–†–æ—É—Ç—ã:**
- `GET /shared/shifts/{schedule_id}/cancel` - —Ñ–æ—Ä–º–∞ –æ—Ç–º–µ–Ω—ã
- `POST /shared/shifts/{schedule_id}/cancel` - —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω—ã
- `POST /shared/shifts/{schedule_id}/cancel/upload` - –∑–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ (AJAX)
- `DELETE /shared/shifts/{schedule_id}/cancel/media/{media_key}` - —É–¥–∞–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞

**JavaScript:**
- `apps/web/static/js/shared/shift_cancel.js` - –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

#### 4.3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Ñ–æ—Ä–º—ã owner/manager/employee (0.5 –¥–Ω—è)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–∏—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã –æ—Ç–º–µ–Ω—ã –Ω–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ shared-—Å—Ç—Ä–∞–Ω–∏—Ü—É
- –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ –±–æ—Ç–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- –û–±–Ω–æ–≤–∏—Ç—å `ShiftCancellationService` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è `media_meta`

**–§–∞–π–ª—ã:**
- `apps/web/routes/owner_shifts.py` - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ shared-—Å—Ç—Ä–∞–Ω–∏—Ü—É
- `apps/web/routes/manager_shifts.py` - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ shared-—Å—Ç—Ä–∞–Ω–∏—Ü—É
- `apps/web/routes/employee_shifts.py` - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ shared-—Å—Ç—Ä–∞–Ω–∏—Ü—É
- `apps/bot/handlers_div/schedule_handlers.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- `shared/services/shift_cancellation_service.py` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ media_meta

---

### –≠—Ç–∞–ø 5: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ Project Brain (0.5 –¥–Ω—è)

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å `doc/vision_v1/shared/media_storage.md`:
  - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞
  - API –º–µ—Ç–æ–¥—ã
  - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `doc/DOCUMENTATION_RULES.md`:
  - –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –º–µ–¥–∏–∞
  - –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
  - –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `doc/plans/roadmap.md`:
  - –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –§–∞–∑—ã 4
  - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ò—Ç–µ—Ä–∞—Ü–∏–∏ 44

- [ ] –ó–∞–Ω–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ Project Brain:
  - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ MediaStorageClient
  - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

---

### –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π (1 –¥–µ–Ω—å)

#### 6.1. –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã (0.3 –¥–Ω—è)

**–§–∞–π–ª—ã:**
- `tests/unit/test_media_storage_client.py`:
  - –¢–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–º–æ–∫–∏)
  - –¢–µ—Å—Ç—ã —Ñ–∞–±—Ä–∏–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
  - –¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤

- `tests/unit/test_media_orchestrator_integration.py`:
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è MediaOrchestrator —Å MediaStorageClient
  - –¢–µ—Å—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è URL

#### 6.2. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã (0.4 –¥–Ω—è)

**–°—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞ dev (MinIO):**
- [ ] –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è Tasks v2
- [ ] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω—ã
- [ ] –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ –¥–ª—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
- [ ] –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (presigned URLs)
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ç–∏–ø–∞ —Ñ–∞–π–ª–æ–≤

**–°—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞ prod (Selectel):**
- [ ] –¢–µ –∂–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, —á—Ç–æ –∏ –Ω–∞ dev
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ presigned URLs (—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ CDN (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)

#### 6.3. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (0.3 –¥–Ω—è)

**–°–∫—Ä–∏–ø—Ç:** `scripts/migrate_telegram_media_to_storage.py`

**–õ–æ–≥–∏–∫–∞:**
- –ù–∞–π—Ç–∏ –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å Telegram file_id
- –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –∏–∑ Telegram —á–µ—Ä–µ–∑ Bot API
- –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ Object Storage —á–µ—Ä–µ–∑ MediaStorageClient
- –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ –ë–î (–∑–∞–º–µ–Ω–∏—Ç—å file_id –Ω–∞ key/url)
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏

**–ó–∞–ø—É—Å–∫:**
```bash
docker compose -f docker-compose.dev.yml exec web python scripts/migrate_telegram_media_to_storage.py
```

---

## üìä –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

| –≠—Ç–∞–ø | –û—Ü–µ–Ω–∫–∞ | –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ |
|------|--------|--------------|
| 1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ | 1 –¥–µ–Ω—å | - |
| 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ | 1-2 –¥–Ω—è | - |
| 3. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ | 2-3 –¥–Ω—è | - |
| 4. –ú–∏–≥—Ä–∞—Ü–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | 2 –¥–Ω—è | - |
| 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 0.5 –¥–Ω—è | - |
| 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π | 1 –¥–µ–Ω—å | - |
| **–ò—Ç–æ–≥–æ** | **8-10 –¥–Ω–µ–π** | - |

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **–ò—Ç–µ—Ä–∞—Ü–∏—è 44, –§–∞–∑–∞ 2**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å–æ —Å–º–µ–Ω–∞–º–∏ (–∑–∞–≤–µ—Ä—à–µ–Ω–∞)
- **–ò—Ç–µ—Ä–∞—Ü–∏—è 44, –§–∞–∑–∞ 3**: UI/–æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å (–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
- **–ò—Ç–µ—Ä–∞—Ü–∏—è 36**: MediaOrchestrator (–∑–∞–≤–µ—Ä—à–µ–Ω–∞)

---

## ‚úÖ Acceptance Criteria

- [ ] MediaStorageClient –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Telegram, MinIO –∏ Selectel –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- [ ] MediaOrchestrator –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MediaStorageClient –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞
- [ ] Shared-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–º–µ–Ω—ã —Å–º–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π (owner/manager/employee)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram –≤ Object Storage –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- [ ] Presigned URLs —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ä–∞–∑–º–µ—Ä, —Ç–∏–ø, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
- [ ] –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- [ ] –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –Ω–∞ dev –∏ prod
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

---

## üö® –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

1. **–†–∏—Å–∫:** –ú–∏–≥—Ä–∞—Ü–∏—è –±–æ–ª—å—à–æ–≥–æ –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** Lazy migration (–º–∏–≥—Ä–∞—Ü–∏—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é), batch processing

2. **–†–∏—Å–∫:** –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ Selectel Object Storage
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** Fallback –Ω–∞ Telegram –ø—Ä–æ–≤–∞–π–¥–µ—Ä, –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **–†–∏—Å–∫:** Presigned URLs –∏—Å—Ç–µ–∫–∞—é—Ç –¥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

4. **–†–∏—Å–∫:** –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Selectel
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ü–æ–ª–∏—Ç–∏–∫–∏ lifecycle (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤), –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `doc/plans/roadmap.md` - –ò—Ç–µ—Ä–∞—Ü–∏—è 44, –§–∞–∑–∞ 4
- `shared/services/media_orchestrator.py` - —Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `doc/ITERATION_36_SUMMARY.md` - MediaOrchestrator –≤ –ò—Ç–µ—Ä–∞—Ü–∏–∏ 36
- `doc/vision_v1/shared/media_storage.md` - (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞)

