# Итерация 23: Система учета выплат сотрудникам

**Статус:** Планирование  
**Срок:** Ноябрь 2025 (4-5 недель)  
**Приоритет:** Высокий

## Цели итерации

Реализация полноценной системы учета выплат сотрудникам с поддержкой различных систем оплаты труда, графиков выплат и организационной структуры.

## Основные задачи

### Задача 1: Приоритет договорной ставки (3-4 дня)
Для некоторых сотрудников важна ставка из договора, а не из объекта/тайм-слота.

**Решение:**
- Добавить флаг `use_contract_rate` в таблицу `contracts`
- Изменить логику расчета выплат: приоритет договорной ставки над ставкой объекта/тайм-слота
- Обновить UI: чекбокс "Использовать ставку из договора"

### Задача 2: Справочник систем оплаты труда (4-5 дней)
Создать справочник видов систем оплаты труда с возможностью применения к объектам и единицам организационной структуры.

**Решение:**
- Таблица `payment_systems` с видами систем
- 3 вида для старта:
  - Простая повременная (текущая)
  - Окладная (фиксированная месячная оплата)
  - Повременно-премиальная (оплата + премии/демотивация)
- Связать с договорами и объектами

### Задача 3: Система учета начислений и выплат (7-8 дней)
Полноценный учет начислений, удержаний и выплат с графиками выплат.

**Решение:**
- Таблицы: `payment_schedules`, `payroll_entries`, `payroll_deductions`, `employee_payments`
- UI для владельца: расчет начислений, одобрение, запись выплат
- UI для сотрудника: история выплат, предстоящие выплаты
- График выплат (общая компонента)

### Задача 4: Организационная структура (5-6 дней)
Древовидная структура подразделений с наследованием настроек.

**Решение:**
- Таблица `org_structure_units` (самосвязанная)
- По умолчанию "Основное подразделение"
- Наследование системы оплаты и графика выплат от родителя
- Привязка объектов к подразделениям
- UI: управление структурой, drag-and-drop

## Технические детали

### Изменения в БД

**Новые таблицы:**
- `payment_systems` - виды систем оплаты труда
- `payment_schedules` - графики выплат
- `org_structure_units` - организационная структура
- `payroll_entries` - начисления
- `payroll_deductions` - удержания
- `employee_payments` - выплаты

**Изменения в существующих таблицах:**
- `contracts`: добавить `use_contract_rate`, `payment_system_id`, `payment_schedule_id`
- `objects`: добавить `payment_system_id`, `payment_schedule_id`, `org_unit_id`

### Изменения в сервисах

**Новые сервисы:**
- `PaymentSystemService` - управление системами оплаты
- `PayrollService` - расчет начислений и выплат
- `OrgStructureService` - управление организационной структурой

**Изменения в существующих:**
- `ContractService` - логика определения ставки с учетом флага
- `ShiftService` - расчет выплат с учетом приоритетов

### Изменения в UI

**Новые страницы:**
- `/owner/payment_systems` - справочник систем оплаты
- `/owner/payroll` - управление начислениями и выплатами
- `/owner/payroll/{entry_id}` - детализация начисления
- `/owner/org_structure` - управление организационной структурой
- `/employee/payroll` - история выплат сотрудника

**Изменения в существующих:**
- Формы создания/редактирования договоров: чекбокс `use_contract_rate`, выбор системы оплаты
- Формы создания/редактирования объектов: выбор системы оплаты, графика выплат, подразделения

## Риски

1. **Миграция существующих данных** - нужно корректно назначить системы оплаты и подразделения
2. **Циклические ссылки** - валидация при создании/перемещении подразделений
3. **Производительность** - расчет начислений за большие периоды может быть медленным

## DoD

- [ ] Код следует @conventions.mdc
- [ ] Покрытие тестами ≥80%
- [ ] Линтер без ошибок
- [ ] Документация обновлена
- [ ] Миграции применены на dev
- [ ] Smoke-тесты пройдены
- [ ] Code review выполнен
- [ ] Коммиты на русском

## Зависимости

- Текущая система договоров (Итерация 18)
- Система тайм-слотов (Итерация 4)
- Система смен (Итерация 1)

## Ссылки

- [Roadmap](/doc/plans/roadmap.md) - общий план проекта
- [Setting](/doc/plans/iteration23/setting.md) - исходная постановка задачи
- [Vision](/doc/vision.md) - техническое видение проекта

