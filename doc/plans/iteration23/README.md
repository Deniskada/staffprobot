# Итерация 23: Система учета выплат сотрудникам

**Статус:** Планирование  
**Срок:** Ноябрь 2025 (5-6 недель)  
**Приоритет:** Высокий  
**Задач:** 45

## Цели итерации

Реализация полноценной системы учета выплат сотрудникам с поддержкой различных систем оплаты труда, графиков выплат и организационной структуры.

## Основные задачи

### Задача 1: Приоритет договорной ставки (3-4 дня)
Для некоторых сотрудников важна ставка из договора, а не из объекта/тайм-слота.

**Решение:**
- Добавить флаг `use_contract_rate` в таблицу `contracts`
- Изменить логику расчета выплат: приоритет договорной ставки над ставкой объекта/тайм-слота
- Обновить UI: чекбокс "Использовать ставку из договора"

### Задача 2: Справочник систем оплаты труда (4-5 дней)
Создать справочник видов систем оплаты труда с возможностью применения к объектам и единицам организационной структуры.

**Решение:**
- Таблица `payment_systems` с видами систем
- 3 вида для старта:
  - Простая повременная (текущая)
  - Окладная (фиксированная месячная оплата)
  - Повременно-премиальная (оплата + премии/демотивация)
- Связать с договорами и объектами

### Задача 3: Система учета начислений и выплат (7-8 дней)
Полноценный учет начислений, удержаний и выплат с графиками выплат.

**Решение:**
- Таблицы: `payment_schedules` (с полем payment_period), `payroll_entries`, `payroll_deductions` (с is_automatic), `payroll_bonuses`, `employee_payments`
- Удержания бывают автоматические (опоздание, невыполнение задач) и ручные (владелец/управляющий)
- Доплаты добавляют владелец/управляющий
- UI для владельца: расчет начислений, добавление удержаний/доплат, одобрение, запись фактических выплат
- UI для сотрудника: история выплат, предстоящие выплаты
- **Кнопка "Записать выплату"** = фиксация факта перевода денег сотруднику (approved → paid)

### Задача 3А: Система задач на смену и автоматические удержания (4-5 дней)
Задачи на смене и автоматические удержания за опоздания и невыполнение задач.

**Решение:**
- Таблицы: `shift_tasks`, `timeslot_task_templates`
- Обновление `objects.shift_tasks`: структура `[{task, is_mandatory, deduction_amount}]`
- Задачи по умолчанию берутся из объекта, можно переопределить для тайм-слота
- **ВАЖНО:** Премии и штрафы за задачи применяются **только** для "Повременно-премиальной" системы оплаты труда (`payment_system_id=3`)
- При открытии смены создаются задачи, при закрытии проверяются
- UI в боте для отметки задач как выполненных
- Celery задача `process_automatic_deductions()` (ежедневно в 01:00):
  - Опоздание на смену > 15 мин → автоудержание
  - Невыполненные обязательные задачи → автоудержание
- Уведомления сотрудникам об автоудержаниях

### Задача 4: Организационная структура (5-6 дней)
Древовидная структура подразделений с наследованием настроек.

**Решение:**
- Таблица `org_structure_units` (самосвязанная)
- По умолчанию "Основное подразделение"
- Наследование системы оплаты и графика выплат от родителя
- Привязка объектов к подразделениям
- UI: управление структурой, drag-and-drop

### Задача 5: Права управляющих и UI для выплат (2 дня)
Управляющие с правом `can_manage_payroll` могут управлять начислениями.

**Решение:**
- В `manager_permissions` договора добавить поле `can_manage_payroll`
- UI для управляющего: страница `/manager/payroll`
  - Список сотрудников с начислениями (только по доступным объектам)
  - Детализация с возможностью добавления удержаний/доплат
  - Кнопка "Одобрить" (если есть право)
  - Кнопка "Записать выплату" НЕ доступна (только владельцу)
- Проверка прав доступа к объектам и сотрудникам

## Технические детали

### Изменения в БД

**Новые таблицы:**
- `payment_systems` - виды систем оплаты труда
- `payment_schedules` - графики выплат (с полем payment_period)
- `org_structure_units` - организационная структура
- `payroll_entries` - начисления
- `payroll_deductions` - удержания (с полями is_automatic, shift_id)
- `payroll_bonuses` - доплаты
- `employee_payments` - фактические выплаты
- `shift_tasks` - задачи на смене
- `timeslot_task_templates` - шаблоны задач для тайм-слотов

**Изменения в существующих таблицах:**
- `contracts`: добавить `use_contract_rate`, `payment_system_id`, `payment_schedule_id`, `manager_permissions.can_manage_payroll`
- `objects`: добавить `payment_system_id`, `payment_schedule_id`, `org_unit_id`, обновить структуру `shift_tasks`

### Изменения в сервисах

**Новые сервисы:**
- `PaymentSystemService` - управление системами оплаты
- `PayrollService` - расчет начислений, удержаний, доплат и выплат
- `OrgStructureService` - управление организационной структурой
- `ShiftTaskService` - управление задачами на смене

**Новые Celery задачи:**
- `process_automatic_deductions()` - автоматические удержания (ежедневно в 01:00)

**Изменения в существующих:**
- `ContractService` - логика определения ставки с учетом флага `use_contract_rate`
- `ShiftService` - расчет выплат с учетом приоритетов, создание задач при открытии смены, проверка задач при закрытии

### Изменения в UI

**Новые страницы:**
- `/owner/payment_systems` - справочник систем оплаты
- `/owner/payroll` - управление начислениями и выплатами
- `/owner/payroll/{entry_id}` - детализация начисления (с кнопками добавления удержаний/доплат)
- `/owner/org_structure` - управление организационной структурой
- `/manager/payroll` - управление начислениями для управляющего (только доступные объекты)
- `/manager/payroll/{entry_id}` - детализация для управляющего
- `/employee/payroll` - история выплат сотрудника

**Изменения в существующих:**
- Формы создания/редактирования договоров: чекбокс `use_contract_rate`, выбор системы оплаты, чекбокс `can_manage_payroll` для управляющих
- Формы создания/редактирования объектов: выбор системы оплаты, графика выплат, подразделения, управление задачами на смене
- Формы создания/редактирования тайм-слотов: управление задачами для тайм-слота
- Бот: UI для отметки задач как выполненных

## Риски

1. **Миграция существующих данных** - нужно корректно назначить системы оплаты, подразделения и обновить структуру задач на смене
2. **Циклические ссылки** - валидация при создании/перемещении подразделений в организационной структуре
3. **Производительность** - расчет начислений за большие периоды может быть медленным
4. **Интеграция задач** - задачи на смену нужно интегрировать в существующий процесс открытия/закрытия смен без нарушения работы
5. **Точность автоудержаний** - корректное определение опозданий (учет часовых поясов) и невыполненных задач
6. **Права управляющих** - сложная логика проверки доступа к объектам и сотрудникам при работе с начислениями
7. **Celery задача** - надежность ежедневной обработки автоудержаний и уведомлений

## DoD

- [ ] Код следует @conventions.mdc
- [ ] Покрытие тестами ≥80%
- [ ] Линтер без ошибок
- [ ] Документация обновлена
- [ ] Миграции применены на dev
- [ ] Smoke-тесты пройдены
- [ ] Code review выполнен
- [ ] Коммиты на русском

## Зависимости

- Текущая система договоров (Итерация 18)
- Система тайм-слотов (Итерация 4)
- Система смен (Итерация 1)

## Ссылки

- [Roadmap](/doc/plans/roadmap.md) - общий план проекта
- [Setting](/doc/plans/iteration23/setting.md) - исходная постановка задачи
- [Vision](/doc/vision.md) - техническое видение проекта

