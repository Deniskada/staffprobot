# План реструктуризации проекта StaffProBot

**Дата создания:** 2026-01-09  
**Статус:** План  
**Версия:** 1.0

## 1. Анализ текущего состояния

### 1.1. Текущая архитектура

**Структура проекта:**
- `apps/web/` - FastAPI веб-приложение (роуты, сервисы, шаблоны)
- `apps/bot/` - Telegram бот (обработчики, сервисы)
- `domain/entities/` - 58 моделей БД (User, Object, Shift, Contract, Payroll, Review и др.)
- `shared/services/` - общие сервисы
- `core/` - базовая инфраструктура (auth, database, logging, geolocation)
- `infrastructure/` - внешние интеграции

**Текущий прогресс:** 504/521 задач (96.7%)  
**Итерации:** 1-53 (большинство завершены)

**Ключевые реализованные модули:**
- ✅ Система смен (Shift, ShiftSchedule, TimeSlot)
- ✅ Управление объектами (Object, ObjectOpening)
- ✅ Договоры (Contract, ContractTemplate, ContractVersion)
- ✅ Расчет зарплат (PayrollEntry, PayrollAdjustment, EmployeePayment)
- ✅ Система отзывов (Review, ReviewAppeal, Rating)
- ✅ Уведомления (Notification, NotificationTemplate)
- ✅ Биллинг (BillingTransaction, UserSubscription, TariffPlan)
- ✅ Календарь планирования (drag&drop, фильтры)
- ✅ Задачи на смену (TaskPlan, TaskEntry, ShiftTask)
- ✅ Организационная структура (OrgStructureUnit)

### 1.2. Новое видение продукта

**4 модуля:**
1. **Модуль 1: Биржа фрилансеров «Быстрая смена»** (подбор за 4 часа)
2. **Модуль 2: Интеллектуальное планирование смен и учет времени**
3. **Модуль 3: Автоматический расчет и прозрачные выплаты**
4. **Модуль 4: Кадровое ЭДО «Легально 24/7»**

**3 фазы разработки:**
- **Фаза 1 (0-6 мес.):** MVP + Версия 1.1
- **Фаза 2 (6-12 мес.):** Версия 2.0 + 2.1
- **Фаза 3 (12-18 мес.):** Платформа + расширение

## 2. Маппинг текущих фич на новые модули

### 2.1. Модуль 1: Биржа фрилансеров

**Что уже есть:**
- ✅ Базовые сущности: User, Object, Shift, Contract
- ✅ Система отзывов (Review, Rating) - можно использовать для рейтинга
- ✅ Геолокация (Object.coordinates, Shift.start_coordinates)
- ✅ Telegram бот для коммуникации
- ✅ Система уведомлений (Notification)

**Что нужно добавить:**
- ❌ Карточка вакансии-смены (2 клика: дата, время, точка, ставка, навыки)
- ❌ Верификация паспорта и СНИЛС (интеграция с «Госуслуги.Идентификация»)
- ❌ Система тегов фрилансеров (TagReference расширить)
- ❌ Push-уведомления подходящим кандидатам (скоринг)
- ❌ Чат между работодателем и кандидатом (в приложении)
- ❌ Автопринятие смены при подтверждении
- ❌ Автогенерация договора ГПХ/самозанятый при подтверждении

**Новые сущности:**
- `FreelancerProfile` - профиль фрилансера (верификация, рейтинг, теги)
- `VacancyShift` - вакансия-смена (отдельно от обычных смен)
- `FreelancerTag` - теги фрилансеров (опыт с Ozon, ночные смены, машина)
- `VerificationDocument` - документы верификации (паспорт, СНИЛС)
- `FreelancerMatch` - подбор кандидатов (скоринг, уведомления)
- `ChatMessage` - сообщения в чате работодатель-кандидат

### 2.2. Модуль 2: Интеллектуальное планирование

**Что уже есть:**
- ✅ Визуальный календарь (FullCalendar.js, drag&drop)
- ✅ TimeSlot, ShiftSchedule - планирование смен
- ✅ Учет рабочих норм часов (частично через Contract)
- ✅ Геолокация для отметки начала/окончания смены
- ✅ QR-код на точке (можно добавить в Object)
- ✅ Контроль опозданий (ShiftHistory, ObjectOpening)

**Что нужно добавить:**
- ⚠️ Умный подбор замены (при болезни - 3 кандидата с биржи)
- ⚠️ Фотоподтверждение закрытия точки
- ⚠️ Интеграция с биржей для подбора замены

**Новые сущности:**
- `ReplacementCandidate` - кандидаты на замену (связь с биржей)
- `PhotoConfirmation` - фотоподтверждение закрытия точки
- `WorkNorm` - нормы рабочих часов (расширение Contract)

### 2.3. Модуль 3: Расчет и выплаты

**Что уже есть:**
- ✅ Гибкий конструктор формул (Rule, PayrollEntry, PayrollAdjustment)
- ✅ Расчет зарплат (PayrollEntry, EmployeePayment)
- ✅ Личный кабинет сотрудника (/employee/*)
- ✅ Детализация расчетного листка (PayrollStatementLog)
- ✅ История выплат (EmployeePayment)
- ✅ Система выплат (PaymentSystem, PaymentSchedule)
- ✅ Апелляции по штрафу (частично через ReviewAppeal)

**Что нужно добавить:**
- ❌ Интеграция с API маркетплейсов (Ozon, Wildberries, Яндекс Маркет)
- ❌ Автоимпорт данных по заказам/браку для расчета премий
- ❌ Мгновенные выплаты фрилансерам по завершении смены
- ❌ Поддержка НПД (самозанятые) - расширение PaymentSystem

**Новые сущности:**
- `MarketplaceIntegration` - интеграции с маркетплейсами
- `OrderData` - данные по заказам (для расчета премий)
- `DefectData` - данные по браку (для расчета штрафов)
- `InstantPayment` - мгновенные выплаты фрилансерам
- `NPDPayment` - выплаты через НПД (самозанятые)

### 2.4. Модуль 4: Кадровое ЭДО

**Что уже есть:**
- ✅ Система договоров (Contract, ContractTemplate, ContractVersion)
- ✅ Мастер приема на работу (частично через Contract)
- ✅ Хранилище документов (частично через ContractVersion)

**Что нужно добавить:**
- ❌ Мастер приема для разных типов (штат Т-1, ГПХ, самозанятые)
- ❌ Библиотека юр. документов (расширение ContractTemplate)
- ❌ Автоматическая отчетность (ПФР, ФНС: СЗВ-ТД, СЗВ-СТАЖ, 6-НДФЛ, ЕФС-1)
- ❌ Работа с ЭТК (электронные трудовые книжки)
- ❌ Персональные дела сотрудников (цифровое хранилище с ЭП)

**Новые сущности:**
- `EmployeeOnboarding` - мастер приема на работу
- `LegalDocument` - библиотека юр. документов (приказы, доп. соглашения)
- `GovernmentReport` - отчеты в госорганы (СЗВ-ТД, 6-НДФЛ и др.)
- `ETKRecord` - записи в электронной трудовой книжке
- `EmployeeFile` - персональное дело сотрудника
- `DigitalSignature` - электронная подпись документов

## 3. Реструктуризация Roadmap

### 3.1. Новый формат Roadmap

**Текущий формат:** Итерации 1-53 (технические задачи)  
**Новый формат:** Продуктовые версии + Эпики + Итерации

**Структура:**
```
Фаза 1: Ядро продукта (0-6 месяцев)
├── MVP (0-3 мес.)
│   ├── Эпик: Биржа смен (Модуль 1.1-1.3)
│   ├── Эпик: Календарь планирования (Модуль 2.1)
│   ├── Эпик: Простой расчет (Модуль 3.1)
│   └── Эпик: Чат (Модуль 1.3)
├── Версия 1.1 (3-6 мес.)
│   ├── Эпик: Интеграция маркетплейсов (Модуль 3.2)
│   └── Эпик: Базовое ЭДО (Модуль 4.1-4.2)

Фаза 2: Дифференциация (6-12 месяцев)
├── Версия 2.0
│   ├── Эпик: Полноценное ЭДО (Модуль 4.3-4.4)
│   └── Эпик: AI-скоринг (Модуль 1.2)
└── Версия 2.1
    ├── Эпик: Интеграции (1С, все маркетплейсы)
    └── Эпик: Умный подбор замены (Модуль 2.2)

Фаза 3: Экосистема (12-18 месяцев)
└── Версия 3.0
    ├── Эпик: Белая этикетка для маркетплейсов
    └── Эпик: Расширение на смежные вертикали
```

### 3.2. Маппинг текущих итераций на новые эпики

**Итерации 1-23** → Базовый функционал (уже реализован, остается как есть)  
**Итерации 24-53** → Поддержка и улучшения (остаются, но группируются по модулям)

**Новые эпики для Фазы 1:**

**Эпик 1.1: Биржа смен (MVP)**
- Задачи из Модуля 1.1-1.3
- Оценка: 3 месяца
- Зависимости: текущие User, Object, Shift

**Эпик 1.2: Календарь планирования (MVP)**
- Уже реализован (Итерации 28, 52)
- Доработка: интеграция с биржей

**Эпик 1.3: Простой расчет (MVP)**
- Уже реализован (Итерации 23, 33, 34)
- Доработка: конструктор формул (частично есть через Rule)

**Эпик 1.4: Чат (MVP)**
- Новая задача
- Оценка: 1 месяц

**Эпик 1.5: Интеграция маркетплейсов (v1.1)**
- Задачи из Модуля 3.2
- Оценка: 2 месяца

**Эпик 1.6: Базовое ЭДО (v1.1)**
- Задачи из Модуля 4.1-4.2
- Оценка: 2 месяца

## 4. Архитектурная реструктуризация

### 4.1. Новая структура доменов

**Текущая структура:**
```
domain/
└── entities/  # Все сущности в одном месте
```

**Новая структура (DDD):**
```
domain/
├── modules/
│   ├── freelancer_marketplace/  # Модуль 1
│   │   ├── entities/
│   │   │   ├── freelancer_profile.py
│   │   │   ├── vacancy_shift.py
│   │   │   ├── freelancer_tag.py
│   │   │   └── verification_document.py
│   │   ├── repositories/
│   │   ├── services/
│   │   │   ├── freelancer_scoring_service.py
│   │   │   ├── vacancy_service.py
│   │   │   └── verification_service.py
│   │   └── value_objects/
│   ├── shift_planning/  # Модуль 2
│   │   ├── entities/
│   │   │   ├── replacement_candidate.py
│   │   │   └── photo_confirmation.py
│   │   ├── services/
│   │   │   ├── smart_replacement_service.py
│   │   │   └── planning_service.py
│   ├── payroll/  # Модуль 3
│   │   ├── entities/
│   │   │   ├── marketplace_integration.py
│   │   │   ├── order_data.py
│   │   │   └── instant_payment.py
│   │   ├── services/
│   │   │   ├── marketplace_import_service.py
│   │   │   └── instant_payment_service.py
│   └── hr_edo/  # Модуль 4
│       ├── entities/
│       │   ├── employee_onboarding.py
│       │   ├── legal_document.py
│       │   ├── government_report.py
│       │   └── etk_record.py
│       └── services/
│           ├── onboarding_service.py
│           ├── report_generation_service.py
│           └── etk_service.py
├── shared/  # Общие сущности (User, Object, Shift)
│   └── entities/
│       ├── user.py
│       ├── object.py
│       └── shift.py
└── core/  # Базовые домены
    └── entities/
        ├── contract.py
        └── notification.py
```

### 4.2. Реструктуризация сервисов

**Текущая структура:**
```
apps/web/services/  # Все сервисы в одном месте
shared/services/    # Общие сервисы
```

**Новая структура:**
```
apps/web/services/
├── freelancer_marketplace/
│   ├── freelancer_service.py
│   ├── vacancy_service.py
│   └── chat_service.py
├── shift_planning/
│   ├── smart_replacement_service.py
│   └── planning_service.py
├── payroll/
│   ├── marketplace_import_service.py
│   └── instant_payment_service.py
└── hr_edo/
    ├── onboarding_service.py
    └── report_service.py

shared/services/  # Остаются общие сервисы
```

### 4.3. Реструктуризация роутов

**Текущая структура:**
```
apps/web/routes/
├── owner.py
├── manager.py
├── employee.py
└── admin.py
```

**Новая структура (по модулям):**
```
apps/web/routes/
├── owner/
│   ├── marketplace.py      # Биржа смен
│   ├── planning.py         # Планирование
│   ├── payroll.py          # Расчеты
│   └── hr_edo.py           # ЭДО
├── manager/
│   ├── planning.py
│   └── payroll.py
├── employee/
│   ├── marketplace.py      # Просмотр вакансий
│   ├── payroll.py          # Личный кабинет
│   └── hr_edo.py           # Документы
└── admin/
    └── modules.py          # Управление модулями
```

### 4.4. Новые интеграции

**Внешние сервисы:**
```
infrastructure/external/
├── gosuslugi/              # Верификация паспорта/СНИЛС
│   └── identification_client.py
├── marketplaces/
│   ├── ozon_client.py
│   ├── wildberries_client.py
│   └── yandex_market_client.py
├── government/
│   ├── pfr_client.py       # ПФР (СЗВ-ТД, СЗВ-СТАЖ)
│   ├── fns_client.py      # ФНС (6-НДФЛ, ЕФС-1)
│   └── etk_client.py      # Электронные трудовые книжки
└── payment/
    ├── npd_client.py       # НПД (самозанятые)
    └── instant_payment_client.py  # Мгновенные выплаты
```

## 5. Этапы миграции

### 5.1. Фаза 0: Подготовка (1 месяц)

**Цель:** Подготовить инфраструктуру для реструктуризации

**Задачи:**
1. **Создать новую структуру директорий**
   - Создать `domain/modules/` с подпапками для 4 модулей
   - Создать `apps/web/services/` по модулям
   - Создать `apps/web/routes/` по модулям

2. **Миграция существующих сущностей**
   - Перенести общие сущности в `domain/shared/entities/`
   - Оставить `domain/entities/` для обратной совместимости (deprecated)
   - Создать алиасы для старых импортов

3. **Обновление документации**
   - Создать новый roadmap в формате версий
   - Обновить `doc/vision.md` с новой структурой
   - Создать `doc/architecture.md` с описанием модулей

4. **Тестирование**
   - Убедиться, что все тесты проходят
   - Обновить импорты в тестах

**Критерии готовности:**
- ✅ Новая структура создана
- ✅ Старые импорты работают (через алиасы)
- ✅ Все тесты проходят
- ✅ Документация обновлена

### 5.2. Фаза 1: MVP (0-3 месяца)

**Цель:** Реализовать базовую биржу смен и календарь

**Эпик 1.1: Биржа смен**
- Создать `FreelancerProfile`, `VacancyShift`, `FreelancerTag`
- Реализовать создание вакансии за 2 клика
- Реализовать систему тегов
- Реализовать базовый скоринг (по рейтингу, локации)
- Push-уведомления подходящим кандидатам

**Эпик 1.2: Календарь планирования**
- Интеграция биржи с календарем
- Drag&drop с учетом вакансий

**Эпик 1.3: Простой расчет**
- Улучшить конструктор формул (Rule → FormulaBuilder)
- Интеграция с вакансиями

**Эпик 1.4: Чат**
- Создать `ChatMessage`
- Реализовать чат в веб-интерфейсе
- Интеграция с Telegram ботом

**Критерии готовности:**
- ✅ Владелец может создать вакансию за 2 клика
- ✅ Фрилансеры получают уведомления о подходящих вакансиях
- ✅ Есть чат между работодателем и кандидатом
- ✅ Автопринятие смены при подтверждении

### 5.3. Фаза 1.1: Интеграции (3-6 месяцев)

**Эпик 1.5: Интеграция маркетплейсов**
- Создать клиенты для Ozon, Wildberries, Яндекс Маркет
- Реализовать импорт данных по заказам
- Интеграция с расчетом премий

**Эпик 1.6: Базовое ЭДО**
- Расширить мастер приема на работу (штат, ГПХ, самозанятые)
- Создать библиотеку юр. документов
- Автогенерация договора ГПХ при подтверждении смены

**Критерии готовности:**
- ✅ Данные по заказам импортируются из маркетплейсов
- ✅ Премии рассчитываются автоматически
- ✅ Договор ГПХ генерируется при подтверждении смены

### 5.4. Фаза 2: Дифференциация (6-12 месяцев)

**Версия 2.0:**
- Полноценное ЭДО с отчетностью в госорганы
- AI-скоринг для фрилансеров
- Верификация через Госуслуги

**Версия 2.1:**
- Интеграции с 1С
- Все крупные маркетплейсы
- Умный подбор замены

### 5.5. Фаза 3: Экосистема (12-18 месяцев)

**Версия 3.0:**
- Белая этикетка для маркетплейсов
- Расширение на смежные вертикали

## 6. Риски и митигация

### 6.1. Технические риски

**Риск 1: Нарушение обратной совместимости**
- **Митигация:** Создать алиасы для старых импортов, постепенная миграция

**Риск 2: Сложность рефакторинга существующего кода**
- **Митигация:** Делать миграцию поэтапно, модуль за модулем

**Риск 3: Интеграции с внешними сервисами**
- **Митигация:** Использовать адаптеры, моки для тестирования

### 6.2. Организационные риски

**Риск 4: Долгая миграция может затормозить разработку новых фич**
- **Митигация:** Параллельная разработка (новая структура + старый код)

**Риск 5: Недостаток ресурсов на реструктуризацию**
- **Митигация:** Приоритизировать критичные модули, остальное постепенно

## 7. План действий

### 7.1. Немедленные действия (неделя 1)

1. ✅ Создать этот план реструктуризации
2. ⏳ Согласовать план с командой
3. ⏳ Создать задачи в roadmap для Фазы 0

### 7.2. Краткосрочные действия (месяц 1)

1. Реализовать Фазу 0 (подготовка)
2. Начать Фазу 1 (MVP биржи смен)

### 7.3. Среднесрочные действия (месяцы 2-6)

1. Завершить MVP
2. Реализовать версию 1.1

### 7.4. Долгосрочные действия (месяцы 6-18)

1. Реализовать Фазу 2
2. Реализовать Фазу 3

## 8. Метрики успеха

### 8.1. Технические метрики

- ✅ Все тесты проходят после реструктуризации
- ✅ Время сборки не увеличилось
- ✅ Производительность не ухудшилась

### 8.2. Продуктовые метрики

- ✅ Время подбора на смену < 4 часов (Модуль 1)
- ✅ Нет простоев точек (Модуль 2)
- ✅ Нет ошибок в расчетах (Модуль 3)
- ✅ Легальное оформление за 24/7 (Модуль 4)

## 9. Заключение

Этот план реструктуризации обеспечивает:
- **Плавный переход** от текущей архитектуры к новой
- **Минимальные риски** благодаря поэтапной миграции
- **Соответствие новому видению** продукта с 4 модулями
- **Масштабируемость** для будущего роста

**Следующие шаги:**
1. Согласовать план с командой
2. Создать детальные задачи для Фазы 0
3. Начать реализацию

---

**Автор:** AI Assistant  
**Дата:** 2026-01-09  
**Версия:** 1.0
