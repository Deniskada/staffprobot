# Анализ автоправил «Двойная ставка»

## 1. Влияние по подсистемам

- **Планирование смен**
  - `plan_shift_modal.js`, `plan_shift.js`, `shared/services/schedule_service.py`, `apps/web/routes/{owner,manager,employee}.py`
  - Разрешение перекрытий требует изменения валидации (`ScheduleService.create_scheduled_shift_from_timeslot`, `check-availability`) для сценариев «два объекта / один объект».
  - Риск: разрушение расчёта свободных окон → календарь/бот показывают «Свободно» при полной загрузке. Восстановление ≈ 0.5 дня (откат сервиса + JS).

- **Открытие/автооткрытие смен**
  - `core/celery/tasks/shift_tasks.py`, `apps/web/services/shift_service.py`
  - При разрешённом совмещении автооткрытие не должно блокировать вторую смену; учитывать `max_employees` и режим автоправила.
  - Риск: вторая смена не откроется → ≈ 1 день диагностики/фикса.

- **Закрытие / автопродление**
  - `shift_tasks.py`, `ScheduleService` (правила вечерней ставки)
  - В режимах двойной ставки нельзя продлевать без учёта второй смены.
  - Риск: двойное закрытие или потеря оплаты → 1–2 дня.

- **Расчёт стоимости**
  - `shared/services/payroll_service.py`, `core/celery/tasks/payroll_tasks.py`, `apps/web/routes/payroll*.py`
  - Правило «двойная ставка» влияет на базовые начисления и штрафы/премии.
  - Риск: некорректные суммы в выплатах/отчётах → 2 дня восстановления.

- **Отображение в календаре**
  - `calendar_filter_service.py`, `universal_calendar.js`, шаблоны календаря
  - Нужно корректно показывать совмещённые смены (бейджи, интервалы).
  - Риск: календарь показывает «Нет окон» при активном правиле → 0.5 дня.

- **Корректировки / отчёты**
  - `PayrollAdjustmentService`, страницы `/owner/manager/payroll`, `/analytics`
  - Корректировки по задачам и штрафам должны учитывать совмещение, избегать дублей.
  - Риск: двойной штраф/премия → 1–2 дня + ручные исправления.

- **Задачи на смену**
  - `shared/services/task_service.py`, `apps/web/routes/tasks/*`, `apps/bot/handlers_div/tasks_*`
  - При двух сменах нельзя создавать две копии одинаковых задач; нужна привязка к ведущей смене.
  - Риск: задвоение или отсутствие задач → 1 день + чистка данных.

- **Бот**
  - `schedule_handlers.py`, `shift_handlers.py`
  - Новая логика интервалов/совмещений затрагивает планирование и открытие через бота.
  - Риск: пользователи не смогут планировать/закрывать смены → 0.5–1 день.

- **Документация и Project Brain**
  - `doc/vision_v1/shared/calendar.md`, `doc/vision_v1/roles/{owner,manager}.md`, `doc/vision_v1/bot/README.md`, `brainrules`
  - Актуализация обязательна, иначе попадание в несоответствие.

## 2. Негативный сценарий

| Узел | Возможные последствия | Время восстановления |
|------|----------------------|----------------------|
| Расчёт свободных интервалов | Календарь/бот не покажут окна | ≈ 0.5 дня |
| Payroll / корректировки | Двойные начисления/штрафы | 1–2 дня |
| Автооткрытие | Вторая смена не откроется | ≈ 1 день |
| Задачи | Дубли или отсутствие задач | ≈ 1 день + чистка |
| Отчёты | Некорректные суммы в `/payroll`, `/analytics` | 1–2 дня |
| Бот | Планирование/закрытие недоступно | 0.5–1 день |

## 3. План изменений (если реализуем)

1. **Расширение Rule Engine**
   - Добавить два правила `/owner/rules`, расширить `Rule` (условия «один объект»/«разные объекты», коэффициенты двойной ставки).
   - UI настройки (описания, чекбоксы, коэффициент).
   - Оценка: 1.5–2 дня.

2. **Расчёт свободного времени**
   - `ScheduleService`: поддержка дополнительных слотов по объекту/глобально, флаги правил в ответе.
   - JS/бот: обновить обработку интервалов с учётом нового флага.
   - Оценка: 2.5–3 дня (backend + frontend + bot).

3. **Планирование / проверка доступности**
   - `check-availability`, `create_scheduled_shift_from_timeslot`: разрешить перекрытия при активном правиле, учитывать «разные объекты» (логистика/дистанция).
   - Подробное логирование конфликтов.
   - Оценка: 2 дня.

4. **Открытие/закрытие/автопродление**
   - `shift_tasks`, `shift_service`: учесть двойные смены при автооткрытии/закрытии, корректно встраивать вечерние правила.
   - Оценка: 1.5 дня.

5. **Расчёт начислений / отчёты**
   - Payroll сервисы: коэффициенты двойной ставки, корректное распределение корректировок, правка отчётов (`/owner/payroll/report`, `/analytics`).
   - Оценка: 2 дня.

6. **Задачи и корректировки за задачи**
   - `TaskService`: исключить дубли, выбрать ведущую смену для задач; корректировки учитывать однократно.
   - Оценка: 1.5 дня.

7. **Документация и тесты**
   - Обновить `vision_v1`, `DOCUMENTATION_RULES`, `roadmap`, Project Brain.
   - Написать unit + интеграционные тесты (планирование, payroll, задачи).
   - Оценка: 1 день.

8. **Флаг/риски**
   - Внедрить feature-flag для отключения правил, логирование аномалий, скрипт проверки двойных начислений.
   - Оценка: 0.5 дня.

**Итого оценка трудозатрат:** ~12–13 рабочих дней (с тестированием и буфером) + до 1 дня на возможный rollback/фиксацию.


