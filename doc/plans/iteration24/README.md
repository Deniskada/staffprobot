# 🔔 Итерация 24: Система уведомлений

> **Статус:** В планировании  
> **Базируется на:** Итерация 10 из roadmap.md  
> **Сроки:** 2-3 недели  
> **Приоритет:** Высокий

---

## 📝 Краткое описание

Разработка полнофункциональной системы уведомлений с поддержкой множественных каналов доставки, персонализацией настроек, шаблонами сообщений и аналитикой эффективности.

---

## 🎯 Цели

1. **Унифицировать систему уведомлений** — единый интерфейс для всех типов уведомлений
2. **Множественные каналы** — Email, SMS, Push, Telegram
3. **Персонализация** — пользователь выбирает, что и как получать
4. **Надежность** — гарантия доставки, retry логика, мониторинг
5. **Аналитика** — статистика доставки и прочтения

---

## 🚀 Что будет реализовано

### ✅ Основные функции

- **4 канала доставки:**
  - 📧 Email (SMTP)
  - 📱 SMS (Twilio / SMSC / SmsAero)
  - 🔔 Push (Web Push API)
  - 💬 Telegram (уже работает, унифицируем)

- **Типы уведомлений:**
  - Смены (напоминания, подтверждения, отмены)
  - Договоры (подписание, расторжение, истечение)
  - Отзывы (новые отзывы, модерация, обжалования)
  - Платежи (оплаты, лимиты, подписки)
  - Системные (welcome, пароли, блокировки)

- **Персонализация:**
  - Пользователь выбирает каналы для каждого типа
  - Частота доставки: мгновенно / дайджест каждый час / дайджест каждый день
  - Полное отключение типов уведомлений

- **Планирование:**
  - Отложенные уведомления (запланированные на будущее)
  - Группировка похожих уведомлений
  - Дайджесты (hourly, daily)

- **Аналитика:**
  - Статистика по каналам, типам, периодам
  - Delivery rate, read rate, error rate
  - Экспорт в CSV

---

## 📦 Компоненты

### Модели данных

| Модель | Описание |
|--------|----------|
| `Notification` | Основная модель уведомления |
| `NotificationPreferences` | Настройки пользователя |

### Сервисы

| Сервис | Ответственность |
|--------|------------------|
| `NotificationService` | Создание, получение, обновление уведомлений |
| `NotificationTemplateManager` | Управление шаблонами сообщений |
| `NotificationAnalytics` | Статистика и отчеты |

### Каналы доставки

| Канал | Технология | Статус |
|-------|------------|--------|
| Email | `aiosmtplib` | ✨ Новый |
| SMS | `twilio` / `smsc` | ✨ Новый |
| Push | `pywebpush` | ✨ Новый |
| Telegram | Bot API | ♻️ Унифицируем |

### API Endpoints

```
GET    /api/notifications                   # Список уведомлений
GET    /api/notifications/unread/count      # Количество непрочитанных
POST   /api/notifications/{id}/read         # Отметить прочитанным
POST   /api/notifications/read-all          # Отметить все прочитанными
DELETE /api/notifications/{id}              # Удалить

GET    /api/notifications/preferences       # Получить настройки
POST   /api/notifications/preferences       # Обновить настройки
POST   /api/notifications/push/subscribe    # Подписаться на Push
POST   /api/notifications/push/unsubscribe  # Отписаться от Push

GET    /admin/notifications/analytics       # Аналитика (admin)
POST   /admin/notifications/test            # Тестовая отправка (admin)
```

---

## 📊 Фазы разработки

### Фаза 1: Основа (3-4 дня)
- Модель `Notification`
- Восстановление `NotificationService`
- Система шаблонов

### Фаза 2: Каналы доставки (4-5 дней)
- Email канал
- SMS канал
- Push канал
- Унификация Telegram канала

### Фаза 3: Настройки пользователей (2 дня)
- Модель `NotificationPreferences`
- UI страница настроек

### Фаза 4: Расписание и группировка (2 дня)
- Celery планировщик
- Дайджесты

### Фаза 5: Аналитика (2 дня)
- Сервис аналитики
- UI страница статистики

### Фаза 6: Дополнительно (опционально, 2 дня)
- A/B тестирование шаблонов
- Интеграции (Slack, Discord)
- Система отписки
- Защита от спама

### Фаза 7: Тесты и документация (2 дня)
- Unit тесты
- Integration тесты
- Обновление документации

---

## 🔧 Технологии

### Новые зависимости

```python
# requirements.txt
aiosmtplib>=3.0.0        # Email
email-validator>=2.0.0   # Валидация email
pywebpush>=1.14.0        # Push уведомления
twilio>=8.0.0            # SMS (или smsc/smsaero)
```

### Переменные окружения

```bash
# Email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=notifications@staffprobot.ru
SMTP_PASSWORD=***
SMTP_FROM=StaffProBot <notifications@staffprobot.ru>

# SMS
TWILIO_ACCOUNT_SID=***
TWILIO_AUTH_TOKEN=***
TWILIO_PHONE_NUMBER=+7...

# Push
VAPID_PUBLIC_KEY=***
VAPID_PRIVATE_KEY=***
VAPID_SUBJECT=mailto:admin@staffprobot.ru
```

---

## 📈 Метрики успеха

| Метрика | Целевое значение |
|---------|------------------|
| Delivery Rate | > 95% |
| Read Rate | > 70% |
| Error Rate | < 5% |
| Покрытие тестами | > 90% |
| Каналов доставки | 4+ |

---

## 🗂 Документация

- **[ITERATION_24_PLAN.md](./ITERATION_24_PLAN.md)** — Детальный план разработки
- **[TECHNICAL_GUIDE.md](./TECHNICAL_GUIDE.md)** — Техническое руководство
- **[roadmap.md](../roadmap.md)** — Общий план проекта

---

## 👥 Роли

### Для пользователей

- **Владелец** — получает уведомления о договорах, сменах, отзывах
- **Управляющий** — уведомления о сменах на своих объектах
- **Сотрудник** — напоминания о сменах, изменения договоров
- **Модератор** — уведомления о новых отзывах и обжалованиях
- **Админ** — системные уведомления, аналитика

### Настройки по ролям

Каждая роль может настроить:
- ✅ Включение/отключение типов уведомлений
- ✅ Выбор каналов доставки
- ✅ Частоту получения (мгновенно / дайджест)

---

## 🎨 UI/UX

### Страница настроек уведомлений

```
┌────────────────────────────────────────────────┐
│  Настройки уведомлений                         │
├────────────────────────────────────────────────┤
│                                                │
│  ┌────────────────────────────────────────┐   │
│  │ Тип уведомления     Email  SMS  Push  TG│   │
│  ├────────────────────────────────────────┤   │
│  │ 📅 Смены              ✓     -    ✓    ✓ │   │
│  │ 📝 Договоры           ✓     -    -    ✓ │   │
│  │ ⭐ Отзывы             ✓     -    -    - │   │
│  │ 💳 Платежи            ✓     ✓    -    ✓ │   │
│  │ ⚙️ Системные          ✓     -    -    - │   │
│  └────────────────────────────────────────┘   │
│                                                │
│  Частота доставки:                             │
│  ○ Мгновенно                                   │
│  ○ Дайджест каждый час                         │
│  ● Дайджест каждый день (в 9:00)               │
│                                                │
│  [Сохранить настройки]                         │
└────────────────────────────────────────────────┘
```

### Список уведомлений

```
┌────────────────────────────────────────────────┐
│  Уведомления (15 непрочитанных)                │
├────────────────────────────────────────────────┤
│                                                │
│  🔴 Напоминание о смене                   2ч   │
│     Смена начинается через 2 часа              │
│                                                │
│  ⚪ Договор подписан                      вчера│
│     Договор №123 подписан сотрудником          │
│                                                │
│  ⚪ Новый отзыв                           3д   │
│     Получен отзыв на объект "Офис А"           │
│                                                │
│  [Отметить все как прочитанные]                │
└────────────────────────────────────────────────┘
```

---

## 🔒 Безопасность

- **Rate Limiting** — max 10 уведомлений/час на пользователя
- **Валидация данных** — проверка email, телефонов
- **Отписка** — возможность отписаться от email через токен
- **Защита от спама** — мониторинг превышений лимита

---

## 🧪 Тестирование

### Unit тесты
- ✅ NotificationService методы
- ✅ Каждый канал доставки (с моками)
- ✅ Шаблоны рендеринга
- ✅ Планировщик
- ✅ Группировка и дайджесты

### Integration тесты
- ✅ Полный цикл: создание → отправка → чтение
- ✅ Настройки пользователей
- ✅ Retry логика при ошибках
- ✅ Дайджесты

### E2E тесты
- ✅ Отправка реального Email (test mode)
- ✅ Push подписка в браузере
- ✅ Telegram уведомление

---

## 📞 Поддержка

**Вопросы?** Создайте Issue в репозитории или напишите в чат поддержки.

**Документация:** [doc/vision_v1/shared/notifications.md](../../vision_v1/shared/notifications.md) (будет создан)

---

## ✅ Критерии готовности

Итерация считается завершенной, когда:

- [x] Все 4 канала доставки работают
- [x] Пользователи могут настраивать предпочтения
- [x] Дайджесты отправляются согласно расписанию
- [x] Аналитика показывает delivery rate > 95%
- [x] Покрытие тестами > 90%
- [x] Документация актуальна и полна
- [x] Нет критических багов
- [x] Код прошел code review
- [x] Деплой на production успешен

---

**Итерация 24 — делаем уведомления надежными, гибкими и удобными! 🚀**

