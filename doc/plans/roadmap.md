# Roadmap (из @tasklist.md)

**Общий прогресс:** 348/401 (86.8%)  
**Итерация 23 (Employee Payment Accounting):** Фазы 0-4В ✅ | Фаза 5: 5/7 задач | DoD: 6/8 критериев  
**Итерация 24 (Notification System):** ✅ Завершена (7/7 задач)  
**Итерация 25 (Admin Notifications Management):** ✅ 80% завершена (20/25 задач)  
**Итерация 26 (Owner Sidebar Redesign):** ✅ Завершена (5/5 задач)  
**Итерация 27 (Доработки):** ✅ Завершена (6/6 задач)  
**Итерация 28 (Calendar Filters):** ✅ Завершена (7/7 задач)  
**Итерация 29 (Shift Cancellation System):** ✅ Завершена (8/8 задач)  
**Итерация 30 (Bug Fixes & Improvements):** ✅ Завершена (1/1 задача)  
**Итерация 31 (Owner Profile Enhancement):** ✅ Завершена (3/3 задачи)  
**Итерация 32 (Contract Termination Settlement):** ✅ Завершена (8/8 задач)

## Итерация 25: Система управления уведомлениями в админке

**Статус:** ✅ 80% завершена (4 из 5 фаз)  
**Длительность:** 7 дней  
**Приоритет:** Высокий  
**Описание:** Создание полноценной системы управления уведомлениями в админ-панели с аналитикой, шаблонами и массовыми операциями.

**Ссылки:**
- [README](doc/plans/iteration25/README.md) - общий план итерации
- [ITERATION_25_PLAN.md](doc/plans/iteration25/ITERATION_25_PLAN.md) - детальный план задач
- [TECHNICAL_GUIDE.md](doc/plans/iteration25/TECHNICAL_GUIDE.md) - техническое руководство
- [CHANGELOG.md](doc/plans/iteration25/CHANGELOG.md) - история изменений

**Фазы:**
- [x] **Фаза 1:** Дашборд и статистика (3 дня) ✅
  - [x] 1.1. Создать админские роуты (`admin_notifications.py`)
  - [x] 1.2. Создать сервис аналитики (`admin_notification_service.py`)
  - [x] 1.3. Создать дашборд с графиками Chart.js (`dashboard.html`)
  - [x] Добавить навигацию в админ-панель
  - [x] Исправлена критическая ошибка паттерна работы с БД
- [x] **Фаза 2:** Список и фильтрация с AJAX (1 день) ✅
  - [x] 2.1. Список уведомлений с пагинацией
  - [x] 2.2. Фильтры по статусу, каналу, типу, дате
  - [x] 2.3. AJAX функциональность (`notifications.js`)
  - [x] 2.4. Модальное окно просмотра деталей
- [x] **Фаза 3:** CRUD для кастомных шаблонов (2 дня) ✅
  - [x] 3.1. Модель `NotificationTemplate` + миграция БД
  - [x] 3.2. Полный CRUD сервис с версионированием
  - [x] 3.3. HTML формы создания и редактирования
  - [x] 3.4. Управление переменными шаблонов
  - [x] 3.5. Логика приоритета: кастомные → статические
- [ ] **Фаза 4:** Настройки каналов (пропущена - управляется через .env)
- [x] **Фаза 5:** Массовые операции (1 день) ✅
  - [x] 5.1. Сервис массовых операций (`notification_bulk_service.py`)
  - [x] 5.2. API endpoints для отмены, повтора, удаления
  - [x] 5.3. Экспорт в CSV, JSON, XLSX
  - [x] 5.4. JavaScript для UI
  - [x] 5.5. Добавлены статусы SCHEDULED и DELETED

**Итого:** 4/5 фаз завершены (80%)

## Итерация 26: Owner Sidebar Redesign

**Статус:** ✅ Завершена  
**Длительность:** 3 дня  
**Приоритет:** Средний  
**Описание:** Редизайн боковой панели владельца с улучшенной навигацией и современным интерфейсом.

**Результаты:**
- ✅ Обновлен дизайн боковой панели
- ✅ Улучшена навигация между разделами
- ✅ Добавлены иконки и визуальные улучшения
- ✅ Оптимизирована мобильная версия
- ✅ Обновлена документация

## Итерация 27: Доработки

**Статус:** ✅ Завершена  
**Длительность:** 2 дня  
**Приоритет:** Средний  
**Описание:** Различные доработки и улучшения системы.

**Результаты:**
- ✅ Исправлены мелкие баги
- ✅ Улучшена производительность
- ✅ Обновлена документация
- ✅ Оптимизированы запросы к БД
- ✅ Улучшена обработка ошибок
- ✅ Добавлены дополнительные проверки

## Итерация 28: Calendar Filters

**Статус:** ✅ Завершена  
**Длительность:** 4 дня  
**Приоритет:** Высокий  
**Описание:** Добавление расширенных фильтров для календаря с возможностью фильтрации по различным критериям.

**Результаты:**
- ✅ Добавлены фильтры по статусу смен
- ✅ Реализована фильтрация по сотрудникам
- ✅ Добавлены фильтры по объектам
- ✅ Реализована фильтрация по датам
- ✅ Добавлены комбинированные фильтры
- ✅ Улучшен UX фильтрации
- ✅ Обновлена документация

## Итерация 29: Система отмены смен с учетом ответственности ✅

**Статус:** ✅ Завершена  
**Длительность:** 2 дня  
**Приоритет:** Высокий  
**Описание:** Реализовать полную систему учета отмен запланированных смен с автоматическим расчетом штрафов, модерацией уважительных причин и интеграцией с начислениями зарплаты для обеспечения ответственности сотрудников.

### Задачи

- [x] **1.1. База данных: таблица shift_cancellations (0.3 дня)**
  - Type: feature | Files: domain/entities/shift_cancellation.py, migrations/
  - Acceptance: таблица создана с полной структурой
  
- [x] **1.2. Настройки штрафов в Object/OrgStructure (0.2 дня)**
  - Type: feature | Files: domain/entities/object.py, domain/entities/org_structure.py
  - Acceptance: настройки с наследованием
  
- [x] **1.3. Автоотмена при расторжении договора (0.4 дня)**
  - Type: feature | Files: apps/web/services/contract_service.py
  - Acceptance: отмена смен на недоступные объекты
  
- [x] **1.4. Отмена сотрудником через бота (0.5 дня)**
  - Type: feature | Files: apps/bot/handlers_div/schedule_handlers.py
  - Acceptance: выбор причины и автоматический расчет штрафа
  
- [x] **1.5. Отмена владельцем/управляющим через веб (0.3 дня)**
  - Type: feature | Files: apps/web/routes/cancellations.py
  - Acceptance: отмена без штрафов
  
- [x] **1.6. Модерация уважительных причин (0.3 дня)**
  - Type: feature | Files: apps/web/routes/cancellations.py
  - Acceptance: проверка справок владельцем
  
- [x] **1.7. UI настроек штрафов (0.4 дня)**
  - Type: feature | Files: apps/web/templates/owner/objects/*.html
  - Acceptance: секция настроек в формах
  
- [x] **1.8. Аналитика отмен (0.6 дня)**
  - Type: feature | Files: apps/analytics/analytics_service.py
  - Acceptance: статистика и детальный отчет

### Результат
- ✅ Полный учет отмен: кто, когда, почему, на основании чего
- ✅ Автоматические штрафы по настраиваемым правилам
- ✅ Модерация справок владельцем
- ✅ Интеграция с PayrollAdjustment
- ✅ Автоотмена при расторжении договора
- ✅ Детальная аналитика

### DoD
- [x] Код следует @conventions.mdc ✅
- [x] Миграции созданы ✅
- [x] Функционал реализован ✅
- [x] Документация создана ✅

## Итерация 30: Исправления багов и улучшения ✅

**Статус:** ✅ Завершена  
**Длительность:** 1 день  
**Приоритет:** Высокий  
**Описание:** Реализация автооткрытия последовательных смен при автозакрытии для бесшовной работы сотрудников.

### Задачи

- [x] **1.1. Автооткрытие последовательных смен (1 день)**
  - Type: feature | Files: core/celery/tasks/shift_tasks.py
  - Acceptance: при автозакрытии смены автоматически открывается следующая, если время совпадает

### Реализация

**Логика:**
1. При автозакрытии смены (каждые 30 минут через Celery Beat)
2. Проверка: есть ли следующая запланированная смена в этот день?
3. Проверка: совпадает ли `end_time` закрытой == `start_time` следующей?
4. Если да → автоматическое открытие следующей смены

**Ключевые моменты:**
- `start_time` = время начала тайм-слота (НЕ текущее время)
- `actual_start` = фактическое время автооткрытия
- Координаты берутся из предыдущей смены
- Срабатывает ТОЛЬКО при автозакрытии (не при ручном)
- Обработка обоих типов: фактические Shift и ShiftSchedule

**Исправления:**
- ✅ Добавлен импорт `Notification` в `domain/entities/__init__.py`
- ✅ Добавлен eager loading для `org_unit` (избежание greenlet ошибок)
- ✅ Упрощена логика `late_threshold_minutes` (без обхода иерархии)
- ✅ Исправлено время открытия: используется время тайм-слота

**Документация:**
- ✅ Создана документация: `doc/vision_v1/shared/auto_shift_opening.md`
- ✅ Примечание о статусе `confirmed` в ShiftSchedule (legacy/не используется)

### Результат
- ✅ Бесшовная работа сотрудников при последовательных сменах
- ✅ Не требуется повторная отправка геопозиции
- ✅ Корректное время начала смены (из тайм-слота)
- ✅ Подробное логирование для отладки
- ✅ Задеплоено на production

### DoD
- [x] Код следует правилам проекта ✅
- [x] Функционал протестирован на dev ✅
- [x] Документация создана ✅
- [x] Задеплоено на production ✅

## Итерация 31: Owner Profile Enhancement ✅

**Статус:** ✅ Завершена  
**Длительность:** 0.5 дня  
**Приоритет:** Средний  
**Описание:** Улучшение профиля владельца: автосохранение полей и исправление логики включения функций.

### Задачи

- [x] **1.1. Автосохранение полей профиля (0.3 дня)**
  - Type: feature | Files: apps/web/routes/owner.py, apps/web/services/tag_service.py, apps/web/templates/owner/profile/index.html
  - Acceptance: поля «О компании», «Ценности», «Для связи» автоматически сохраняются с debounce 600мс
  
- [x] **1.2. Авто-создание OwnerProfile при переключении функций (0.1 дня)**
  - Type: bugfix | Files: shared/services/system_features_service.py
  - Acceptance: если профиль отсутствует, создаётся автоматически с telegram_bot по умолчанию
  
- [x] **1.3. Очистка Redis кэша enabled_features (0.1 дня)**
  - Type: maintenance | Files: deployment scripts
  - Acceptance: кэш корректно инвалидируется при изменении функций

### Реализация

**Автосохранение:**
- Новый API endpoint: `POST /owner/profile/api/autosave`
- Частичное обновление полей через `TagService.update_owner_profile_fields()`
- JavaScript debounce 600мс для текстовых полей
- Мгновенное сохранение при изменении чекбоксов мессенджеров

**Авто-создание профиля:**
- При вызове `toggle_user_feature()` профиль создаётся автоматически
- По умолчанию включается функция `telegram_bot`
- Предотвращение ошибки "Owner profile not found"

**Очистка кэша:**
- Redis паттерн: `enabled_features:*`
- Инвалидация при toggle функции
- Инвалидация при деплое на прод

### Результат
- ✅ UX: не требуется кнопка "Сохранить" для основных полей
- ✅ Надёжность: профиль создаётся автоматически при первом использовании
- ✅ Производительность: кэш корректно обновляется
- ✅ Задеплоено на production

### DoD
- [x] Код следует правилам проекта ✅
- [x] Функционал протестирован на dev ✅
- [x] Документация обновлена ✅
- [x] Задеплоено на production ✅

## Итерация 32: Contract Termination Settlement ✅

**Статус:** ✅ Завершена  
**Длительность:** 1 день  
**Приоритет:** Высокий  
**Описание:** Система финального расчёта при расторжении договора с выбором режима выплаты.

### Задачи

- [x] **1.1. База данных: новые поля в Contract (0.1 дня)**
  - Type: feature | Files: domain/entities/contract.py, migrations/
  - Acceptance: добавлены termination_date и settlement_policy

- [x] **1.2. База данных: таблица contract_terminations (0.1 дня)**
  - Type: feature | Files: domain/entities/contract_termination.py, migrations/
  - Acceptance: таблица для аналитики расторжений

- [x] **1.3. Расширение форм расторжения (0.2 дня)**
  - Type: feature | Files: apps/web/templates/owner/employees/contract_detail.html, apps/web/templates/manager/employees/detail.html
  - Acceptance: добавлены поля: дата увольнения, режим финрасчёта, категория причины

- [x] **1.4. ContractService: логика расторжения (0.2 дня)**
  - Type: feature | Files: apps/web/services/contract_service.py
  - Acceptance: сохранение полей, создание termination записи, отмена плановых смен

- [x] **1.5. Учёт terminated contracts в начислениях (0.1 дня)**
  - Type: feature | Files: core/celery/tasks/payroll_tasks.py
  - Acceptance: terminated с settlement_policy='schedule' включены в выплаты по графику

- [x] **1.6. Celery task финрасчёта (0.2 дня)**
  - Type: feature | Files: core/celery/tasks/payroll_tasks.py, core/celery/celery_app.py
  - Acceptance: create_final_settlements_by_termination_date запускается ежедневно в 01:05

- [x] **1.7. PayrollAdjustmentService расширение (0.05 дня)**
  - Type: feature | Files: shared/services/payroll_adjustment_service.py
  - Acceptance: метод get_unapplied_adjustments_until()

- [x] **1.8. Аналитика расторжений (0.15 дня)**
  - Type: feature | Files: apps/web/routes/cancellations.py, apps/web/templates/owner/analytics/cancellations.html
  - Acceptance: новая секция на странице /owner/analytics/cancellations

### Реализация

**Модель данных:**
- Contract: `termination_date`, `settlement_policy`
- ContractTermination: полная история расторжений

**Режимы финрасчёта:**
1. **По графику** (`settlement_policy='schedule'`):
   - Начисления продолжают создаваться по регулярному графику
   - Договор остаётся в выборке для payroll даже после расторжения

2. **В дату увольнения** (`settlement_policy='termination_date'`):
   - Разовая выплата всех накопленных adjustments в указанную дату
   - Автоматическая задача создаёт PayrollEntry с payment_type='final_settlement'

**Автоотмена смен:**
- При указании termination_date автоматически отменяются все плановые смены после этой даты
- Создаются ShiftCancellation записи с cancelled_by = владелец/управляющий

**Celery конфигурация:**
- `create_final_settlements_by_termination_date` - ежедневно 01:05
- Очередь: 'shifts'

**Категории причин расторжения:**
- Нарушение дисциплины
- Недостаточное качество работы
- Соглашение сторон
- Инициатива сотрудника
- Сокращение штата
- Переезд
- Проблемы со здоровьем
- Другое

### Результат
- ✅ Гибкий выбор режима финрасчёта при увольнении
- ✅ Автоматическая обработка выплат уволенным сотрудникам
- ✅ Автоотмена плановых смен после даты увольнения
- ✅ Полная аналитика расторжений с категориями причин
- ✅ Интеграция с существующей системой начислений
- ✅ Backfill исторических adjustments (30.09-18.10)
- ✅ Задеплоено на production

### DoD
- [x] Код следует правилам проекта ✅
- [x] Миграции созданы и применены ✅
- [x] Функционал протестирован на dev ✅
- [x] Документация создана (`doc/vision_v1/features/contract_termination_settlement.md`) ✅
- [x] Задеплоено на production ✅

### Связанная документация
- [Contract Termination Settlement](../vision_v1/features/contract_termination_settlement.md)
- [Payroll System](../vision_v1/entities/payroll.md)
- [Contract](../vision_v1/entities/contract.md)

## Итерация 33: Mobile App Integration

**Статус:** В планировании  
**Длительность:** 10 дней  
**Приоритет:** Высокий  
**Описание:** Интеграция с мобильным приложением для сотрудников с push-уведомлениями и геолокацией.

## Итерация 33: API v2

**Статус:** В планировании  
**Длительность:** 7 дней  
**Приоритет:** Средний  
**Описание:** Создание второй версии API с улучшенной архитектурой и дополнительными возможностями.

## Итерация 34: Performance Optimization

**Статус:** В планировании  
**Длительность:** 6 дней  
**Приоритет:** Высокий  
**Описание:** Оптимизация производительности системы, включая кэширование, индексы БД и асинхронные операции.

## Итерация 35: Security Hardening

**Статус:** В планировании  
**Длительность:** 4 дня  
**Приоритет:** Высокий  
**Описание:** Усиление безопасности системы, включая аудит доступа, шифрование данных и защиту от атак.

## Итерация 36: Documentation & Training

**Статус:** В планировании  
**Длительность:** 3 дня  
**Приоритет:** Средний  
**Описание:** Создание подробной документации для пользователей и обучающих материалов.

## Итерация 37: Final Testing & Deployment

**Статус:** В планировании  
**Длительность:** 5 дней  
**Приоритет:** Высокий  
**Описание:** Финальное тестирование системы, подготовка к продакшену и развертывание.

---

**Примечание:** Этот roadmap обновляется по мере выполнения итераций. Текущий прогресс отражает состояние на момент последнего обновления.