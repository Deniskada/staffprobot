# Диаграмма логики входа и переключения ролей

## Точки входа в систему

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram Bot  │    │   Веб-сайт      │    │  Прямые ссылки  │
│   /start        │    │   ID + PIN      │    │  /owner/dashboard│
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │   Авторизация пользователя  │
                    │   (Telegram ID + PIN)      │
                    └────────────┬────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │   Определение ролей      │
                    │   (RoleService)         │
                    └────────────┬────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │   Доступные интерфейсы   │
                    │   (на основе ролей)      │
                    └────────────┬────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │   Выбор интерфейса       │
                    │   (автоматический или    │
                    │    ручной)              │
                    └────────────┬────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │   Переход к интерфейсу   │
                    │   /admin/* /owner/*     │
                    │   /manager/* /employee/*│
                    └─────────────────────────┘
```

## Система множественных ролей

```
┌─────────────────────────────────────────────────────────────────┐
│                    Пользователь с ролями                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  applicant  │  │    owner    │  │   employee  │            │
│  │   (базовая) │  │ (создал     │  │ (заключил   │            │
│  │             │  │  объекты)   │  │  договор)   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   manager   │  │ superadmin  │  │  manager +  │            │
│  │ (назначен   │  │ (системный  │  │  employee   │            │
│  │  владельцем)│  │  админ)     │  │ (множество  │            │
│  └─────────────┘  └─────────────┘  │  ролей)     │            │
│                                    └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

## Приоритет ролей и доступные интерфейсы

```
Приоритет ролей (от высшего к низшему):

1. superadmin ──┐
                ├──► /admin/* (полный доступ)
                │
2. owner ───────┼──► /owner/* (управление объектами)
                │
3. manager ─────┼──► /manager/* (управление по правам)
                │
4. employee ────┼──► /employee/* (работа на объектах)
                │
5. applicant ───┘──► /employee/* (ограниченный доступ к объектам)

Логика выбора интерфейса:
- Автоматический выбор: интерфейс с наивысшим приоритетом
- Ручное переключение: любой доступный интерфейс
- Сохранение выбора: запоминание последнего выбранного интерфейса
```

## Компонент переключения ролей

```
┌─────────────────────────────────────────────────────────────┐
│  Навигационная панель                                       │
│                                                             │
│  [StaffProBot] [Объекты] [Сотрудники] [Календарь] [Отчеты] │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  [👤 Управляющий ▼]  ←── Компонент переключения ролей   │ │
│  │  ├─ 👑 Владелец                                        │ │
│  │  ├─ 👨‍💼 Управляющий                                   │ │
│  │  ├─ 👷 Сотрудник                                       │ │
│  │  └─ 📋 Соискатель                                      │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Логика назначения ролей

```
Создание объекта ──┐
                   ├──► Назначение роли "owner"
Удаление последнего │
объекта ───────────┘

Заключение договора ──┐
                      ├──► Назначение роли "employee"
Расторжение всех      │
договоров ────────────┘

Назначение управляющим ──┐
                         ├──► Назначение роли "manager"
Отзыв прав управляющего  │
─────────────────────────┘

Первый старт бота ──────► Назначение роли "applicant"
```

## Права управляющего на объекты

```
┌─────────────────────────────────────────────────────────────┐
│  Договор с управляющим                                      │
│                                                             │
│  Общие права:                                               │
│  ├─ can_create_objects: true/false                         │
│  ├─ can_manage_contracts: true/false                       │
│  ├─ can_view_all_reports: true/false                       │
│  └─ can_manage_managers: true/false                        │
│                                                             │
│  Права на конкретные объекты:                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Объект "Кафе на Невском"                              │ │
│  │  ├─ can_view: true                                     │ │
│  │  ├─ can_edit: true                                     │ │
│  │  ├─ can_delete: false                                  │ │
│  │  ├─ can_manage_employees: true                         │ │
│  │  ├─ can_view_finances: true                            │ │
│  │  ├─ can_edit_rates: true                               │ │
│  │  └─ can_edit_schedule: true                            │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Объект "Склад на Васильевском"                        │ │
│  │  ├─ can_view: true                                     │ │
│  │  ├─ can_edit: false                                    │ │
│  │  ├─ can_delete: false                                  │ │
│  │  ├─ can_manage_employees: false                        │ │
│  │  ├─ can_view_finances: false                           │ │
│  │  ├─ can_edit_rates: false                              │ │
│  │  └─ can_edit_schedule: false                           │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Фильтрация объектов по ролям

```
┌─────────────────────────────────────────────────────────────┐
│  Логика фильтрации объектов                                 │
│                                                             │
│  Сотрудники (employee):                                     │
│  ├─ Видят ВСЕ объекты (включая available_for_applicants)   │
│  ├─ Могут работать на объектах по договорам                │
│  └─ Полный доступ к функциям /employee/*                   │
│                                                             │
│  Соискатели (applicant):                                   │
│  ├─ Видят только объекты с available_for_applicants = TRUE │
│  ├─ Могут подавать заявки на доступные объекты             │
│  └─ Ограниченный доступ к /employee/*                      │
│                                                             │
│  Владельцы (owner):                                        │
│  ├─ Видят только свои объекты                              │
│  ├─ Могут управлять настройками available_for_applicants   │
│  └─ Полный доступ к /owner/*                               │
│                                                             │
│  Управляющие (manager):                                    │
│  ├─ Видят объекты по правам в договоре                     │
│  ├─ Могут управлять доступными объектами                   │
│  └─ Ограниченный доступ к /manager/*                      │
└─────────────────────────────────────────────────────────────┘
```

## API для проверки прав

```
┌─────────────────────────────────────────────────────────────┐
│  Middleware и декораторы                                    │
│                                                             │
│  @require_any_role(['owner', 'manager'])                   │
│  ├─ Проверка наличия любой из указанных ролей              │
│                                                             │
│  @require_all_roles(['owner', 'manager'])                  │
│  ├─ Проверка наличия всех указанных ролей                  │
│                                                             │
│  @require_manager_or_owner                                  │
│  ├─ Проверка роли управляющего или владельца               │
│                                                             │
│  @require_object_access(object_id)                         │
│  ├─ Проверка доступа к конкретному объекту                 │
│                                                             │
│  @require_applicant_object_access(object_id)               │
│  ├─ Проверка доступности объекта для соискателей           │
│                                                             │
│  @require_manager_permission('can_edit_rates')             │
│  └─ Проверка конкретного права управляющего                │
└─────────────────────────────────────────────────────────────┘
```

## Примеры сценариев использования

### Сценарий 1: Пользователь с ролями owner + employee
```
1. Вход в систему → определение ролей [owner, employee]
2. Доступные интерфейсы: [/admin/*, /owner/*, /manager/*, /employee/*]
3. Автоматический выбор: /owner/dashboard (наивысший приоритет)
4. Возможность переключения на /employee/dashboard
```

### Сценарий 2: Управляющий с ограниченными правами
```
1. Вход в систему → определение ролей [manager, employee]
2. Доступные интерфейсы: [/manager/*, /employee/*]
3. Автоматический выбор: /manager/dashboard
4. Ограниченный доступ к объектам по правам в договоре
5. Не может видеть объекты, к которым нет доступа
```

### Сценарий 3: Сотрудник без прав управляющего
```
1. Вход в систему → определение ролей [employee]
2. Доступные интерфейсы: [/employee/*]
3. Автоматический выбор: /employee/dashboard
4. Доступ только к функциям сотрудника
```

### Сценарий 4: Соискатель
```
1. Вход в систему → определение ролей [applicant]
2. Доступные интерфейсы: [/employee/*, /auth/*]
3. Автоматический выбор: /employee/dashboard
4. Ограниченный доступ к объектам (только available_for_applicants = TRUE)
5. Может подавать заявки на смены на доступных объектах
```

### Сценарий 5: Соискатель + Сотрудник
```
1. Вход в систему → определение ролей [applicant, employee]
2. Доступные интерфейсы: [/employee/*, /auth/*]
3. Автоматический выбор: /employee/dashboard
4. Полный доступ к объектам (все объекты + доступные для соискателей)
5. Может работать на любых объектах по договорам
```
