# План тестирования: Корректировки за задачи тайм-слотов

## Предусловия
- Dev окружение с fresh Docker контейнерами (После перезапуска бота и Celery)
- База данных с очищенными корректировками или отдельная смена

## Сценарий 1: Выполненная задача с премией

### Шаги
1. Открыть календарь владельца: http://localhost:8001/owner/calendar
2. Создать тайм-слот на сегодня (09:00-21:00) на объект 9
3. Добавить в тайм-слот задачу:
   - Текст: "Уборка дома"
   - Тип: обязательная
   - Стоимость: +100 (премия за выполнение)
4. Запланировать сотрудника на этот тайм-слот
5. От сотрудника в боте:
   - Открыть смену: /start → Мои смены → выбрать тайм-слот
   - Отправить геопозицию
   - Перейти в "Мои задачи"
   - Отметить задачу как выполненную
   - Закрыть смену: "Закрыть смену" → отправить геопозицию

### Проверка shift.notes
```bash
docker compose -f docker-compose.dev.yml exec postgres psql -U postgres -d staffprobot_dev -c \
  "SELECT id, notes FROM shifts WHERE id = <SHIFT_ID> ORDER BY id DESC LIMIT 1;"
```
**Ожидание**: `notes` содержит `[TASKS]{"completed_tasks": [0], "task_media": {}}`

### Проверка корректировок (через 10-15 минут)
```bash
docker compose -f docker-compose.dev.yml exec postgres psql -U postgres -d staffprobot_dev -c \
  "SELECT adjustment_type, amount FROM payroll_adjustments WHERE shift_id = <SHIFT_ID> ORDER BY adjustment_type;"
```
**Ожидание**:
- `shift_base` | 99.00
- `task_bonus` | 100.00

---

## Сценарий 2: Невыполненная обязательная задача

### Шаги
1. Создать тайм-слот с задачей:
   - Текст: "Проверка склада"
   - Тип: обязательная
   - Стоимость: 0 (дефолтный штраф -50 за невыполнение)
2. Открыть смену, **НЕ отмечать задачу как выполненную**
3. Закрыть смену

### Проверка корректировок
**Ожидание**:
- `shift_base` | 99.00
- `task_penalty` | -50.00

---

## Сценарий 3: Задача с фото-отчетом и штрафом

### Шаги
1. Создать тайм-слот с задачей:
   - Текст: "Фотоотчет ремонта"
   - Тип: обязательная
   - Требуется фото: ✅
   - Стоимость: -25 (штраф за невыполнение)
2. Открыть смену
3. Отметить задачу как выполненную **И** отправить фото
4. Закрыть смену

### Проверка корректировок
**Ожидание**:
- `shift_base` | 99.00
- `task_completed` | 0.00 (запись о выполнении с фото, штраф избежан)

---

## Сценарий 4: Смешанные задачи (тайм-слот + объект)

### Шаги
1. Создать объект 9 с задачей:
   - Текст: "Уборка торгового зала"
   - Стоимость: +50
2. Создать тайм-слот с задачей:
   - Текст: "Уборка дома"
   - Стоимость: +100
   - `ignore_object_tasks` = false (учитывать задачи объекта)
3. Открыть смену
4. В "Мои задачи" выполнить ОБЕИХ задачи
5. Закрыть смену

### Проверка корректировок
**Ожидание**:
- `shift_base` | 99.00
- `task_bonus` | 100.00 (от тайм-слота)
- `task_bonus` | 50.00 (от объекта)

---

## Техническая проверка

### Логи Celery
```bash
docker compose -f docker-compose.dev.yml logs celery_worker --tail 50 | grep -A 5 "Adjustments created"
```

### Ручной запуск Celery задачи
```bash
docker compose -f docker-compose.dev.yml exec celery_worker celery -A core.celery.celery_app call core.celery.tasks.adjustment_tasks.process_closed_shifts_adjustments
```

---

## Успешное завершение

✅ Все четыре сценария выполнены без ошибок  
✅ Корректировки создаются в течение 15 минут  
✅ Логи не содержат ошибок SQL  
✅ `completed_tasks` правильно сохраняются в `shift.notes`

