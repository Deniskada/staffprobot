# –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Tasks v2

**–î–∞—Ç–∞:** 29.10.2025  
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –∑–∞–¥–∞—á v2

---

## ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

**–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã:**
- ‚úÖ web (16:25 UTC)
- ‚úÖ bot (15:36 UTC) 
- ‚úÖ celery_worker (15:56 UTC)
- ‚úÖ celery_beat (15:56 UTC)

**Celery —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ Worker –∑–∞–ø—É—â–µ–Ω –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª `process_task_bonuses`
- ‚úÖ Beat –∑–∞–ø—É—â–µ–Ω
- ‚ö†Ô∏è –ó–∞–¥–∞—á–∞ `process-task-bonuses` –ù–ï –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ BEAT_SCHEDULE)

**–ë–î –≥–æ—Ç–æ–≤–∞:**
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã Tasks v2 —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –ö–ª—é—á–∏ —Ñ–∏—á –æ–±–Ω–æ–≤–ª–µ–Ω—ã (tasks_v2)
- ‚úÖ Legacy –∑–∞–¥–∞—á–∏ –æ—á–∏—â–µ–Ω—ã
- ‚úÖ –ü–ª–∞–Ω id=2 —Å–æ–∑–¥–∞–Ω –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ 9

---

## üìã –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)

**–®–∞–≥ 1:** –û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: techpodru (user_id=14)
–û–±—ä–µ–∫—Ç: Home Office (object_id=9)
–û–∂–∏–¥–∞–µ—Ç—Å—è: TaskEntryV2 —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:**
```sql
-- –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–º–µ–Ω—É
SELECT id, object_id, status FROM shifts 
WHERE user_id = 14 AND object_id = 9 
ORDER BY id DESC LIMIT 1;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
SELECT id, shift_id, template_id, is_completed 
FROM task_entries_v2 
WHERE shift_id = (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–º–µ–Ω–∞);

-- –û–∂–∏–¥–∞–µ—Ç—Å—è: 1 –∑–∞–ø–∏—Å—å —Å is_completed = FALSE
```

**–®–∞–≥ 2:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –±–æ—Ç–µ
```
–ö–Ω–æ–ø–∫–∞: "üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏"
–û–∂–∏–¥–∞–µ—Ç—Å—è: –°–ø–∏—Å–æ–∫ —Å –∑–∞–¥–∞—á–µ–π "–í–ª–∞–∂–Ω–∞—è —É–±–æ—Ä–∫–∞"
```

**–®–∞–≥ 3:** –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
```
–î–µ–π—Å—Ç–≤–∏–µ: –ù–∞–∂–∞—Ç—å –≥–∞–ª–æ—á–∫—É –Ω–∞ –∑–∞–¥–∞—á–µ
–û–∂–∏–¥–∞–µ—Ç—Å—è: –ó–∞–ø—Ä–æ—Å —Ñ–æ—Ç–æ (—Ç.–∫. requires_media = TRUE)
```

**–®–∞–≥ 4:** –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
```
–î–µ–π—Å—Ç–≤–∏–µ: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≤ –±–æ—Ç
–û–∂–∏–¥–∞–µ—Ç—Å—è: 
- –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ Telegram –≥—Ä—É–ø–ø—É –æ–±—ä–µ–∫—Ç–∞
- –ó–∞–¥–∞—á–∞ –ø–æ–º–µ—Ç–∏—Ç—Å—è is_completed = TRUE
- completion_media —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:**
```sql
SELECT id, is_completed, completed_at, completion_media::text
FROM task_entries_v2 
WHERE shift_id = (—Ç–µ–∫—É—â–∞—è —Å–º–µ–Ω–∞);

-- –û–∂–∏–¥–∞–µ—Ç—Å—è:
-- is_completed: TRUE ‚úÖ
-- completed_at: NOT NULL ‚úÖ
-- completion_media: [{...}] ‚úÖ
```

**–®–∞–≥ 5:** –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É
```
–î–µ–π—Å—Ç–≤–∏–µ: –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É —á–µ—Ä–µ–∑ –±–æ—Ç
–û–∂–∏–¥–∞–µ—Ç—Å—è: –°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞, —Å–æ–∑–¥–∞–Ω shift_base
```

**–®–∞–≥ 6:** –í—ã–∑–≤–∞—Ç—å celery –∑–∞–¥–∞—á—É –≤—Ä—É—á–Ω—É—é
```bash
docker compose -f docker-compose.dev.yml exec celery_worker \
  celery -A core.celery.celery_app call process_task_bonuses
```

**–®–∞–≥ 7:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
```sql
SELECT id, shift_id, employee_id, adjustment_type, amount, description, task_entry_v2_id
FROM payroll_adjustments
WHERE task_entry_v2_id IS NOT NULL
ORDER BY id DESC
LIMIT 3;

-- –û–∂–∏–¥–∞–µ—Ç—Å—è:
-- task_bonus, amount=100.00, description="–ó–∞–¥–∞—á–∞: –í–ª–∞–∂–Ω–∞—è —É–±–æ—Ä–∫–∞" ‚úÖ
```

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–ó–∞–¥–∞—á–∞ `process-task-bonuses` –ù–ï –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ celery beat!**

**–í celery_app.py:**
```python
'process-task-bonuses': {
    'task': 'process_task_bonuses',
    'schedule': 600,  # –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
}
```

**–ù–æ –≤ –ª–æ–≥–∞—Ö beat:**
```
–ù–ï–¢ —Å–æ–æ–±—â–µ–Ω–∏–π "Sending due task process-task-bonuses"
```

**–ü—Ä–∏—á–∏–Ω–∞:** Beat –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—Ç–∞—Ä—É—é –ë–î —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (`/tmp/celerybeat-schedule`)

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
docker compose -f docker-compose.dev.yml exec celery_beat rm /tmp/celerybeat-schedule

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å beat
docker compose -f docker-compose.dev.yml restart celery_beat
```

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –û—á–∏—Å—Ç–∫–∞ celerybeat-schedule

```bash
docker compose -f docker-compose.dev.yml exec celery_beat rm -f /tmp/celerybeat-schedule
docker compose -f docker-compose.dev.yml restart celery_beat
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
# –ß–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker compose -f docker-compose.dev.yml logs celery_beat --tail 50 | grep "process-task-bonuses"

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# [TIME] Scheduler: Sending due task process-task-bonuses (process_task_bonuses)
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞

- [ ] –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã
- [ ] –ó–∞–¥–∞—á–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –±–æ—Ç–µ
- [ ] –ó–∞–¥–∞—á—É –º–æ–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
- [ ] –ü—Ä–∏ requires_media=TRUE –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è —Ñ–æ—Ç–æ
- [ ] –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ is_completed = TRUE
- [ ] Celery beat –∑–∞–ø—É—Å–∫–∞–µ—Ç process-task-bonuses –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω
- [ ] Celery worker —Å–æ–∑–¥–∞—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ /owner/payroll/adjustments

---

**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ celerybeat-schedule –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç  
**–ê–≤—Ç–æ—Ä:** AI Assistant


