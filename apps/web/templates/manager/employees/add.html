{% extends "manager/base_manager.html" %}

{% block manager_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a href="/manager/employees" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left me-1"></i>
                    Назад к списку
                </a>
                <h2><i class="bi bi-person-plus me-2"></i>Добавление сотрудника</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Информация о сотруднике</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/manager/employees/add">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telegram_id" class="form-label">Telegram ID *</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="telegram_id" 
                                       name="telegram_id" 
                                       required
                                       placeholder="123456789">
                                <div class="form-text">Уникальный идентификатор пользователя в Telegram</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="username" 
                                       name="username" 
                                       placeholder="@username">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="first_name" class="form-label">Имя *</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="first_name" 
                                       name="first_name" 
                                       required
                                       placeholder="Иван">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="last_name" class="form-label">Фамилия</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="last_name" 
                                       name="last_name" 
                                       placeholder="Иванов">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phone" class="form-label">Телефон</label>
                                <input type="tel" 
                                       class="form-control" 
                                       id="phone" 
                                       name="phone" 
                                       placeholder="+7 (999) 123-45-67">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" 
                                       class="form-control" 
                                       id="email" 
                                       name="email" 
                                       placeholder="user@example.com">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="birth_date" class="form-label">Дата рождения</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="birth_date" 
                                       name="birth_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="role" class="form-label">Роль</label>
                                <select class="form-select" id="role" name="role">
                                    <option value="employee">Сотрудник</option>
                                    <option value="manager">Управляющий</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Дополнительные поля профиля (только для сотрудников) -->
                    <div id="profile-fields" style="display: none;">
                        <hr>
                        <h6 class="text-muted mb-3">Дополнительная информация (необязательно)</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="work_experience" class="form-label">Опыт работы</label>
                                    <select class="form-select" id="work_experience" name="work_experience">
                                        <option value="">Выберите опыт</option>
                                        <option value="no_experience">Без опыта</option>
                                        <option value="less_than_year">Менее года</option>
                                        <option value="1-3_years">1-3 года</option>
                                        <option value="3-5_years">3-5 лет</option>
                                        <option value="5-10_years">5-10 лет</option>
                                        <option value="more_than_10_years">Более 10 лет</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="education" class="form-label">Образование</label>
                                    <select class="form-select" id="education" name="education">
                                        <option value="">Выберите образование</option>
                                        <option value="secondary">Среднее</option>
                                        <option value="secondary_special">Среднее специальное</option>
                                        <option value="incomplete_higher">Неоконченное высшее</option>
                                        <option value="higher">Высшее</option>
                                        <option value="postgraduate">Послевузовское</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="preferred_schedule" class="form-label">Предпочитаемый график</label>
                                    <select class="form-select" id="preferred_schedule" name="preferred_schedule">
                                        <option value="">Выберите график</option>
                                        <option value="full_time">Полный день</option>
                                        <option value="part_time">Неполный день</option>
                                        <option value="flexible">Гибкий график</option>
                                        <option value="shift_work">Сменная работа</option>
                                        <option value="weekends">Выходные</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="min_salary" class="form-label">Минимальная зарплата (₽/час)</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="min_salary" 
                                           name="min_salary" 
                                           min="0" 
                                           step="1"
                                           placeholder="500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="skills" class="form-label">Навыки и умения</label>
                            <textarea class="form-control" 
                                      id="skills" 
                                      name="skills" 
                                      rows="3" 
                                      placeholder="Опишите ваши навыки и умения..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="about" class="form-label">О себе</label>
                            <textarea class="form-control" 
                                      id="about" 
                                      name="about" 
                                      rows="3" 
                                      placeholder="Расскажите о себе..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="availability_notes" class="form-label">Примечания о доступности</label>
                            <textarea class="form-control" 
                                      id="availability_notes" 
                                      name="availability_notes" 
                                      rows="2" 
                                      placeholder="Когда вы доступны для работы..."></textarea>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="is_active" 
                                   name="is_active" 
                                   value="true"
                                   checked>
                            <label class="form-check-label" for="is_active">
                                Активен
                            </label>
                        </div>
                    </div>
                    
                    <!-- Шаблон договора -->
                    <div class="mb-3">
                        <label for="contract_template" class="form-label">Шаблон договора</label>
                        <select class="form-select" id="contract_template" name="contract_template">
                            <option value="">Выберите шаблон</option>
                            {% for template in contract_templates %}
                            <option value="{{ template.id }}">{{ template.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Объекты для договора -->
                    <div class="mb-3">
                        <label class="form-label">Объекты для договора</label>
                        <div class="row">
                            {% for object in accessible_objects %}
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="object_{{ object.id }}" 
                                           name="contract_objects" 
                                           value="{{ object.id }}">
                                    <label class="form-check-label" for="object_{{ object.id }}">
                                        {{ object.name }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if not accessible_objects %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Нет доступных объектов для назначения
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Дополнительные параметры договора -->
                    <div class="mb-3">
                        <label for="hourly_rate" class="form-label">Ставка (₽/час)</label>
                        <input type="number" 
                               class="form-control" 
                               id="hourly_rate" 
                               name="hourly_rate" 
                               value="500"
                               min="0" step="1">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_date" class="form-label">Дата начала договора</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="start_date" 
                                       name="start_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end_date" class="form-label">Дата окончания договора</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="end_date" 
                                       name="end_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check me-1"></i>
                            Создать сотрудника
                        </button>
                        <a href="/manager/employees" class="btn btn-outline-secondary">
                            <i class="bi bi-x me-1"></i>
                            Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Информация</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Как получить Telegram ID?</strong>
                    <ol class="mt-2 mb-0">
                        <li>Напишите боту @staffprobot</li>
                        <li>Отправьте любое сообщение</li>
                        <li>Скопируйте ID из ответа</li>
                    </ol>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Важно!</strong>
                    <p class="mt-2 mb-0">После создания сотрудника необходимо будет создать договор для назначения на объекты.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Форматирование телефона
document.getElementById('phone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 0) {
        if (value[0] === '8') {
            value = '7' + value.slice(1);
        }
        if (value[0] === '7' && value.length > 1) {
            value = '+7 (' + value.slice(1, 4) + ') ' + value.slice(4, 7) + '-' + value.slice(7, 9) + '-' + value.slice(9, 11);
        }
    }
    e.target.value = value;
});

// Форматирование username
document.getElementById('username').addEventListener('input', function(e) {
    let value = e.target.value;
    if (value && !value.startsWith('@')) {
        e.target.value = '@' + value;
    }
});

// Устанавливаем текущую дату
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start_date').value = today;
});

// Показ/скрытие дополнительных полей профиля
document.getElementById('role').addEventListener('change', function() {
    const profileFields = document.getElementById('profile-fields');
    if (this.value === 'employee') {
        profileFields.style.display = 'block';
    } else {
        profileFields.style.display = 'none';
    }
});

// Валидация формы
document.querySelector('form').addEventListener('submit', function(e) {
    const telegramId = document.getElementById('telegram_id').value;
    const firstName = document.getElementById('first_name').value;
    
    if (!telegramId || !firstName) {
        e.preventDefault();
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }
    
    if (telegramId.length < 5) {
        e.preventDefault();
        alert('Telegram ID должен содержать минимум 5 цифр');
        return;
    }
});
</script>
{% endblock %}
