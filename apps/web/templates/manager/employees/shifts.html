{% extends "manager/base_manager.html" %}

{% block manager_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a href="/manager/employees/{{ employee.id }}" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left me-1"></i>
                    Назад к сотруднику
                </a>
                <h2><i class="bi bi-clock me-2"></i>Смены {{ employee.first_name }} {{ employee.last_name or '' }}</h2>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshShifts()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Обновить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Статистика -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Всего смен</h6>
                        <h3 class="mb-0">{{ shifts|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Завершено</h6>
                        <h3 class="mb-0">{{ shifts|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Отработано часов</h6>
                        <h3 class="mb-0">{{ total_hours or 0 }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-hourglass fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Заработано</h6>
                        <h3 class="mb-0">{{ total_earnings or 0 }}₽</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-currency-ruble fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Фильтры -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="status_filter" class="form-label">Статус</label>
                        <select class="form-select" id="status_filter" onchange="filterShifts()">
                            <option value="">Все</option>
                            <option value="active">Активные</option>
                            <option value="completed">Завершенные</option>
                            <option value="cancelled">Отмененные</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="object_filter" class="form-label">Объект</label>
                        <select class="form-select" id="object_filter" onchange="filterShifts()">
                            <option value="">Все объекты</option>
                            {% for object in objects %}
                            <option value="{{ object.id }}">{{ object.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="date_from" class="form-label">С даты</label>
                        <input type="date" class="form-control" id="date_from" onchange="filterShifts()">
                    </div>
                    <div class="col-md-3">
                        <label for="date_to" class="form-label">По дату</label>
                        <input type="date" class="form-control" id="date_to" onchange="filterShifts()">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Список смен -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Список смен</h5>
            </div>
            <div class="card-body">
                {% if shifts %}
                <div class="table-responsive">
                    <table class="table table-hover" id="shiftsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Дата</th>
                                <th>Объект</th>
                                <th>Время</th>
                                <th>Длительность</th>
                                <th>Статус</th>
                                <th>Ставка</th>
                                <th>Заработок</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shift in shifts %}
                            <tr class="shift-row" 
                                data-status="{{ shift.status }}" 
                                data-object="{{ shift.object.id if shift.object else '' }}"
                                data-date="{{ shift.start_time.strftime('%Y-%m-%d') if shift.start_time else '' }}">
                                <td>
                                    <i class="bi bi-calendar3 me-1"></i>
                                    {{ shift.start_time.strftime('%d.%m.%Y') if shift.start_time else 'Не указана' }}
                                </td>
                                <td>
                                    <i class="bi bi-building me-1"></i>
                                    {{ shift.object.name if shift.object else 'Не указан' }}
                                </td>
                                <td>
                                    {% if shift.start_time and shift.end_time %}
                                        {{ shift.start_time.strftime('%H:%M') }} - {{ shift.end_time.strftime('%H:%M') }}
                                    {% elif shift.start_time %}
                                        {{ shift.start_time.strftime('%H:%M') }} - ...
                                    {% else %}
                                        Не указано
                                    {% endif %}
                                </td>
                                <td>
                                    {% if shift.duration_hours %}
                                        {{ shift.duration_hours }}ч
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if shift.status == 'active' %}
                                        <span class="badge bg-success">Активна</span>
                                    {% elif shift.status == 'completed' %}
                                        <span class="badge bg-primary">Завершена</span>
                                    {% elif shift.status == 'cancelled' %}
                                        <span class="badge bg-secondary">Отменена</span>
                                    {% else %}
                                        <span class="badge bg-warning">{{ shift.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ shift.hourly_rate or 0 }}₽/час
                                </td>
                                <td>
                                    <strong>{{ shift.total_payment or 0 }}₽</strong>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewShift({{ shift.id }})" title="Подробнее">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        {% if shift.status == 'active' %}
                                        <button class="btn btn-outline-success" onclick="completeShift({{ shift.id }})" title="Завершить">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-clock text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">Нет смен</h5>
                    <p class="text-muted">У этого сотрудника пока нет смен</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function refreshShifts() {
    location.reload();
}

function filterShifts() {
    const statusFilter = document.getElementById('status_filter').value;
    const objectFilter = document.getElementById('object_filter').value;
    const dateFrom = document.getElementById('date_from').value;
    const dateTo = document.getElementById('date_to').value;
    
    const rows = document.querySelectorAll('.shift-row');
    
    rows.forEach(row => {
        let show = true;
        
        // Фильтр по статусу
        if (statusFilter && row.dataset.status !== statusFilter) {
            show = false;
        }
        
        // Фильтр по объекту
        if (objectFilter && row.dataset.object !== objectFilter) {
            show = false;
        }
        
        // Фильтр по дате
        if (dateFrom && row.dataset.date < dateFrom) {
            show = false;
        }
        
        if (dateTo && row.dataset.date > dateTo) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function viewShift(shiftId) {
    // Открываем детали смены
    window.location.href = '/manager/shifts/' + shiftId + '?shift_type=shift';
}

function completeShift(shiftId) {
    if (confirm('Завершить смену?')) {
        // TODO: Реализовать завершение смены
        alert('Завершение смены ' + shiftId);
    }
}

// Устанавливаем текущую дату в фильтры
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date_to').value = today;
});
</script>
{% endblock %}
