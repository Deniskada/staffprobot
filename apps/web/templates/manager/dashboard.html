{% extends "manager/base_manager.html" %}

{% block title %}Дашборд - StaffProBot - Управляющий{% endblock %}

{% block manager_content %}
<div class="row">
    <div class="col-12">
        <h2 class="h4 mb-4">
            <i class="bi bi-speedometer2 me-2"></i>
            Дашборд управляющего
        </h2>
    </div>
</div>

<!-- Статистика -->
<div class="row mb-4">
    <div class="col-md-3">
        <a href="/manager/objects" class="text-decoration-none">
            <div class="card bg-primary text-white" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body" onmouseover="this.parentElement.style.transform='scale(1.02)'" onmouseout="this.parentElement.style.transform='scale(1)'">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Объекты</h6>
                            <h3 class="mb-0">{{ accessible_objects_count or 0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-building fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3">
        <a href="/manager/shifts?status=active&object_id=&dateRange=&date_from=&date_to=" class="text-decoration-none">
            <div class="card bg-success text-white" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body" onmouseover="this.parentElement.style.transform='scale(1.02)'" onmouseout="this.parentElement.style.transform='scale(1)'">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Активные смены</h6>
                            <h3 class="mb-0">{{ active_shifts_count or 0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-clock fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3">
        <a href="/manager/employees" class="text-decoration-none">
            <div class="card bg-info text-white" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body" onmouseover="this.parentElement.style.transform='scale(1.02)'" onmouseout="this.parentElement.style.transform='scale(1)'">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Сотрудники</h6>
                            <h3 class="mb-0">{{ employees_count or 0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-md-3">
        <a href="/manager/calendar" class="text-decoration-none" id="scheduledShiftsLink">
            <div class="card bg-warning text-white" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body" onmouseover="this.parentElement.style.transform='scale(1.02)'" onmouseout="this.parentElement.style.transform='scale(1)'">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Запланированные</h6>
                            <h3 class="mb-0">{{ scheduled_shifts_count_today or 0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-calendar3 fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Открытые объекты -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-unlock me-2"></i>
                    Открытые объекты
                </h5>
                <a href="/manager/objects" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye me-1"></i>
                    Все объекты
                </a>
            </div>
            <div class="card-body">
                {% if open_objects %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Объект</th>
                                <th>Дата открытия</th>
                                <th>Время открытия</th>
                                <th>Открыл</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for opening in open_objects %}
                            <tr>
                                <td>
                                    <a href="/manager/objects/{{ opening.object.id }}" class="text-decoration-none">
                                        <i class="bi bi-building me-1"></i>
                                        {{ opening.object.name }}
                                    </a>
                                </td>
                                <td>{{ format_datetime_local(opening.opened_at, 'Europe/Moscow', '%d.%m.%Y') }}</td>
                                <td>{{ format_datetime_local(opening.opened_at, 'Europe/Moscow', '%H:%M') }}</td>
                                <td>{{ opening.opener.first_name }} {{ opening.opener.last_name or '' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-lock fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Нет открытых объектов</h5>
                    <p class="text-muted">Все объекты закрыты</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Последние смены -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock me-2"></i>
                    Последние смены
                </h5>
                <a href="/manager/calendar" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-calendar3 me-1"></i>
                    Календарь
                </a>
            </div>
            <div class="card-body">
                {% if recent_shifts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Сотрудник</th>
                                <th>Объект</th>
                                <th>Дата</th>
                                <th>Время</th>
                                <th>Статус</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shift in recent_shifts %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                            {{ shift.user.first_name[0] }}
                                        </div>
                                        <div>
                                            <div class="fw-medium">{{ shift.user.first_name }} {{ shift.user.last_name or '' }}</div>
                                            <small class="text-muted">{{ shift.user.username or 'Нет username' }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ shift.object.name }}</td>
                                <td>{{ format_datetime_local(shift.start_time, shift.object.timezone or 'Europe/Moscow', '%d.%m.%Y') }}</td>
                                <td>{{ format_datetime_local(shift.start_time, shift.object.timezone or 'Europe/Moscow', '%H:%M') }} - {{ format_datetime_local(shift.end_time, shift.object.timezone or 'Europe/Moscow', '%H:%M') if shift.end_time else 'Активна' }}</td>
                                <td>
                                    {% if shift.status == 'active' %}
                                        <span class="badge bg-success">Активна</span>
                                    {% elif shift.status == 'completed' %}
                                        <span class="badge bg-primary">Завершена</span>
                                    {% elif shift.status == 'scheduled' %}
                                        <span class="badge bg-warning">Запланирована</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ shift.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if shift.total_payment %}
                                        {{ "%.2f"|format(shift.total_payment) }} ₽
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-clock fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Нет смен</h5>
                    <p class="text-muted">Смены по вашим объектам будут отображаться здесь</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Обработка клика на "Запланированные" - переход в календарь с скроллом на сегодня
    document.addEventListener('DOMContentLoaded', function() {
        const scheduledLink = document.getElementById('scheduledShiftsLink');
        if (scheduledLink) {
            scheduledLink.addEventListener('click', function(e) {
                e.preventDefault();
                // Переход в календарь с параметром для скролла на сегодня
                window.location.href = '/manager/calendar?scrollToToday=true';
            });
        }
    });
    
    // Обновление статистики каждые 30 секунд
    setInterval(function() {
        // Здесь можно добавить AJAX запрос для обновления статистики
        console.log('Обновление статистики...');
    }, 30000);
</script>
{% endblock %}
