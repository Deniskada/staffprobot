{% extends "manager/base_manager.html" %}
{% block title %}Создать инцидент{% endblock %}
{% block manager_content %}
<div class="container mt-4">
  <h2>Создать инцидент</h2>
  <form method="post" action="/manager/incidents/create" class="mt-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Объект</label>
        <select name="object_id" id="incidentObject" class="form-select" required>
          <option value="">Выберите объект</option>
          {% for obj in objects %}
          <option value="{{ obj.id }}">{{ obj.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Категория</label>
        <select name="category" id="incidentCategory" class="form-select" disabled>
          <option value="">Сначала выберите объект</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Критичность</label>
        <select name="severity" class="form-select">
          <option value="low">Низкая</option>
          <option value="medium" selected>Средняя</option>
          <option value="high">Высокая</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Номер инцидента</label>
        <input type="text" name="custom_number" class="form-control" placeholder="Например: INC-2025-001" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Сотрудник</label>
        <select name="employee_id" id="incidentEmployee" class="form-select" disabled>
          <option value="">Сначала выберите объект</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Ущерб (₽)</label>
        <input type="number" step="0.01" min="0" name="damage_amount" class="form-control" placeholder="0.00" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Дата удержания</label>
        <input type="date" name="custom_date" class="form-control" />
        <div class="form-text">Дата, на которую будет создана корректировка начислений</div>
      </div>
      <div class="col-12">
        <label class="form-label">Описание</label>
        <textarea name="notes" class="form-control" rows="4" placeholder="Краткое описание инцидента..."></textarea>
      </div>
    </div>
    <div class="mt-3 d-flex gap-2">
      <button type="submit" class="btn btn-danger"><i class="fas fa-exclamation-triangle"></i> Создать</button>
      <a href="/manager/incidents" class="btn btn-outline-secondary">Отмена</a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const objectSelect = document.getElementById('incidentObject');
  const categorySelect = document.getElementById('incidentCategory');
  const employeeSelect = document.getElementById('incidentEmployee');

  if (!objectSelect || !categorySelect || !employeeSelect) {
    console.error('Не найдены элементы формы');
    return;
  }

  async function loadCategories(objectId) {
    categorySelect.innerHTML = '<option value="">Загрузка...</option>';
    categorySelect.disabled = true;
    try {
      const resp = await fetch(`/manager/incidents/api/categories?object_id=${encodeURIComponent(objectId)}`);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      const data = await resp.json();
      categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
      if (data.categories && data.categories.length > 0) {
        data.categories.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          categorySelect.appendChild(opt);
        });
      }
      categorySelect.disabled = false;
    } catch (e) {
      console.error('Ошибка загрузки категорий:', e);
      categorySelect.innerHTML = '<option value="">Ошибка загрузки</option>';
      categorySelect.disabled = true;
    }
  }

  async function loadEmployees(objectId) {
    employeeSelect.innerHTML = '<option value="">Загрузка...</option>';
    employeeSelect.disabled = true;
    try {
      const resp = await fetch(`/manager/api/employees/for-object/${encodeURIComponent(objectId)}`);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      const list = await resp.json();
      employeeSelect.innerHTML = '<option value="">Выберите сотрудника</option>';
      if (list && list.length > 0) {
        list.forEach(e => {
          const fio = `${(e.name||'').trim()}`;
          const opt = document.createElement('option');
          opt.value = e.id;
          opt.textContent = fio;
          employeeSelect.appendChild(opt);
        });
      }
      employeeSelect.disabled = false;
    } catch (e) {
      console.error('Ошибка загрузки сотрудников:', e);
      employeeSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
      employeeSelect.disabled = true;
    }
  }

  objectSelect.addEventListener('change', function() {
    const oid = this.value;
    if (!oid) {
      categorySelect.innerHTML = '<option value="">Сначала выберите объект</option>';
      categorySelect.disabled = true;
      employeeSelect.innerHTML = '<option value="">Сначала выберите объект</option>';
      employeeSelect.disabled = true;
      return;
    }
    loadCategories(oid);
    loadEmployees(oid);
  });
});
</script>
{% endblock %}

