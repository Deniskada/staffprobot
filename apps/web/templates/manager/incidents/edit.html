{% extends "manager/base_manager.html" %}
{% block title %}Редактировать инцидент #{{ incident.id }}{% endblock %}
{% block manager_content %}
<div class="container mt-4">
  <h2>Редактировать инцидент #{{ incident.id }}</h2>
  <form method="post" action="/manager/incidents/{{ incident.id }}/edit" class="mt-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Статус</label>
        <select name="status" class="form-select">
          <option value="new" {% if incident.status == 'new' %}selected{% endif %}>Новый</option>
          <option value="in_review" {% if incident.status == 'in_review' %}selected{% endif %}>На рассмотрении</option>
          <option value="resolved" {% if incident.status == 'resolved' %}selected{% endif %}>Решен</option>
          <option value="rejected" {% if incident.status == 'rejected' %}selected{% endif %}>Отклонен</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Объект</label>
        <select name="object_id" class="form-select">
          {% for obj in objects %}
          <option value="{{ obj.id }}" {% if incident.object and incident.object.id == obj.id %}selected{% endif %}>{{ obj.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Сотрудник</label>
        <select name="employee_id" class="form-select">
          <option value="">Не указан</option>
          {% for emp in employees %}
          <option value="{{ emp.id }}" {% if incident.employee and incident.employee.id == emp.id %}selected{% endif %}>
            {{ (emp.last_name or '') }} {{ (emp.first_name or '') }} (ID: {{ emp.id }})
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Категория</label>
        <select name="category" class="form-select">
          {% if categories %}
            {% for c in categories %}
            <option value="{{ c.name }}" {% if incident.category == c.name %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          {% else %}
            <option value="{{ incident.category or '' }}" selected>{{ incident.category or 'Без категории' }}</option>
          {% endif %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Критичность</label>
        <select name="severity" class="form-select">
          <option value="low" {% if incident.severity == 'low' %}selected{% endif %}>Низкая</option>
          <option value="medium" {% if incident.severity == 'medium' %}selected{% endif %}>Средняя</option>
          <option value="high" {% if incident.severity == 'high' %}selected{% endif %}>Высокая</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Ущерб (₽)</label>
        <input type="number" step="0.01" min="0" name="damage_amount" class="form-control" value="{{ incident.damage_amount or '' }}" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Номер инцидента</label>
        <input type="text" name="custom_number" class="form-control" value="{{ incident.custom_number or '' }}" />
      </div>
      <div class="col-12">
        <label class="form-label">Описание</label>
        <textarea name="notes" class="form-control" rows="4">{{ incident.notes or '' }}</textarea>
      </div>
    </div>
    <hr>
    <div class="mt-3 d-flex gap-2">
      <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Сохранить</button>
      <a href="/manager/incidents/{{ incident.id }}" class="btn btn-outline-secondary">Отмена</a>
    </div>
  </form>

  <hr>
  <h5 class="mt-4">История изменений</h5>
  <div class="table-responsive">
    <table class="table table-sm table-hover align-middle">
      <thead>
        <tr>
          <th>Дата</th>
          <th>Пользователь</th>
          <th>Поле</th>
          <th>Было</th>
          <th>Стало</th>
          <th>Сумма удержания</th>
          <th>Дата удержания</th>
        </tr>
      </thead>
      <tbody>
        {% if history and history|length > 0 %}
          {% for h in history %}
          <tr>
            <td>{{ h.changed_at.strftime('%d.%m.%Y %H:%M') if h.changed_at else '—' }}</td>
            <td>{% if h.changer %}{{ (h.changer.last_name or '') }} {{ (h.changer.first_name or '') }}{% else %}—{% endif %}</td>
            <td>{{ h.field }}</td>
            <td>{{ h.old_value or '—' }}</td>
            <td>{{ h.new_value or '—' }}</td>
            <td>{{ incident.damage_amount if incident.damage_amount is not none else '—' }}</td>
            <td>{{ incident.custom_date.strftime('%d.%m.%Y') if incident.custom_date else '—' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="7" class="text-muted">История отсутствует</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}


