{% extends "manager/base_manager.html" %}
{% block title %}Редактировать тикет #{{ incident.id }}{% endblock %}
{% block manager_content %}
<div class="container mt-4">
  <h2>Редактировать тикет #{{ incident.id }}
    <span class="badge {{ 'bg-danger' if incident.incident_type == 'deduction' else 'bg-primary' }}" style="font-size:.6em;">
      {{ 'Удержание' if incident.incident_type == 'deduction' else 'Обращение' }}
    </span>
  </h2>
  
  {% if incident.status in ['resolved', 'rejected'] %}
  <div class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle"></i> Нельзя редактировать тикет со статусом "{{ 'Решен' if incident.status == 'resolved' else 'Отклонен' }}".
    <a href="/manager/incidents" class="alert-link">Вернуться к списку тикетов</a>
  </div>
  {% else %}
  <form method="post" action="/manager/incidents/{{ incident.id }}/edit" class="mt-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Статус</label>
        <select name="status" class="form-select">
          <option value="new" {% if incident.status == 'new' %}selected{% endif %}>Новый</option>
          <option value="in_review" {% if incident.status == 'in_review' %}selected{% endif %}>На рассмотрении</option>
          <option value="resolved" {% if incident.status == 'resolved' %}selected{% endif %}>Решен</option>
          <option value="rejected" {% if incident.status == 'rejected' %}selected{% endif %}>Отклонен</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Объект</label>
        <select name="object_id" id="incidentObject" class="form-select" required>
          <option value="">Выберите объект</option>
          {% for obj in objects %}
          <option value="{{ obj.id }}" {% if incident.object and incident.object.id == obj.id %}selected{% endif %}>{{ obj.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Категория</label>
        <select name="category" id="incidentCategory" class="form-select" {% if not incident.object %}disabled{% endif %}>
          <option value="">{% if not incident.object %}Сначала выберите объект{% else %}Выберите категорию{% endif %}</option>
          {% if categories %}
            {% for c in categories %}
            <option value="{{ c.name }}" {% if incident.category == c.name %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          {% elif incident.category %}
            <option value="{{ incident.category }}" selected>{{ incident.category }}</option>
          {% endif %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Сотрудник</label>
        <select name="employee_id" id="incidentEmployee" class="form-select" {% if not incident.object %}disabled{% endif %}>
          <option value="">{% if not incident.object %}Сначала выберите объект{% else %}Выберите сотрудника{% endif %}</option>
          {% if employees %}
            {% for emp in employees %}
            <option value="{{ emp.id }}" {% if incident.employee and incident.employee.id == emp.id %}selected{% endif %}>
              {{ (emp.last_name or '') }} {{ (emp.first_name or '') }}
            </option>
            {% endfor %}
          {% elif incident.employee %}
            <option value="{{ incident.employee.id }}" selected>
              {{ (incident.employee.last_name or '') }} {{ (incident.employee.first_name or '') }}
            </option>
          {% endif %}
        </select>
      </div>
      {% if incident.incident_type == 'deduction' %}
      <div class="col-md-4">
        <label class="form-label">Критичность</label>
        <select name="severity" class="form-select">
          <option value="low" {% if incident.severity == 'low' %}selected{% endif %}>Низкая</option>
          <option value="medium" {% if incident.severity == 'medium' %}selected{% endif %}>Средняя</option>
          <option value="high" {% if incident.severity == 'high' %}selected{% endif %}>Высокая</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Ущерб (₽)</label>
        <input type="number" step="0.01" min="0" name="damage_amount" class="form-control" value="{{ incident.damage_amount or '' }}" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Номер тикета</label>
        <input type="text" name="custom_number" class="form-control" value="{{ incident.custom_number or '' }}" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Дата тикета</label>
        <input type="date" name="custom_date" class="form-control" value="{{ incident.custom_date.strftime('%Y-%m-%d') if incident.custom_date else '' }}" />
      </div>
      {% endif %}
      {% if incident.incident_type == 'request' %}
      <div class="col-md-4">
        <div class="form-check mt-4">
          <input type="checkbox" class="form-check-input" name="compensate_purchase" id="compensate_purchase" value="1" {% if incident.compensate_purchase %}checked{% endif %}>
          <label class="form-check-label" for="compensate_purchase">Компенсировать покупку</label>
        </div>
      </div>
      {% endif %}
      <div class="col-12">
        <label class="form-label">Описание</label>
        <textarea name="notes" class="form-control" rows="4">{{ incident.notes or '' }}</textarea>
      </div>
    </div>
    {% if incident.incident_type == 'request' and incident_items %}
    <div class="card mt-3">
      <div class="card-header"><i class="bi bi-cart3"></i> Позиции обращения</div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr><th>Товар</th><th class="text-center">Кол-во</th><th class="text-end">Цена</th><th class="text-end">Сумма</th></tr>
          </thead>
          <tbody>
            {% set ns = namespace(total=0) %}
            {% for it in incident_items %}
            <tr>
              <td>{{ it.product_name }}</td>
              <td class="text-center">{{ it.quantity }}</td>
              <td class="text-end">{{ "%.2f"|format(it.price) }} ₽</td>
              <td class="text-end">{{ "%.2f"|format(it.total) }} ₽</td>
            </tr>
            {% set ns.total = ns.total + it.total %}
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light"><td colspan="3" class="text-end fw-bold">Итого:</td><td class="text-end fw-bold">{{ "%.2f"|format(ns.total) }} ₽</td></tr>
          </tfoot>
        </table>
      </div>
    </div>
    {% endif %}

    <hr>
    <div class="mt-3 d-flex gap-2">
      <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Сохранить</button>
      <a href="/manager/incidents?incident_type={{ incident.incident_type }}" class="btn btn-outline-secondary">Отмена</a>
    </div>
  </form>
  {% endif %}

  <hr>
  <h5 class="mt-4">История изменений</h5>
  <div class="table-responsive">
    <table class="table table-sm table-hover align-middle">
      <thead>
        <tr>
          <th>Дата</th>
          <th>Пользователь</th>
          <th>Поле</th>
          <th>Было</th>
          <th>Стало</th>
          <th>Сумма удержания</th>
          <th>Дата удержания</th>
        </tr>
      </thead>
      <tbody>
        {% if history and history|length > 0 %}
          {% for h in history %}
          <tr>
            <td>{{ h.changed_at.strftime('%d.%m.%Y %H:%M') if h.changed_at else '—' }}</td>
            <td>{% if h.changer %}{{ (h.changer.last_name or '') }} {{ (h.changer.first_name or '') }}{% else %}—{% endif %}</td>
            <td>{{ h.field }}</td>
            <td>{{ h.old_value or '—' }}</td>
            <td>{{ h.new_value or '—' }}</td>
            <td>{{ incident.damage_amount if incident.damage_amount is not none else '—' }}</td>
            <td>{{ incident.custom_date.strftime('%d.%m.%Y') if incident.custom_date else '—' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="7" class="text-muted">История отсутствует</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <h5 class="mt-4">Связанные корректировки</h5>
  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Тип</th>
          <th>Сумма</th>
          <th>Дата</th>
          <th>Применена</th>
        </tr>
      </thead>
      <tbody>
        {% if adjustments and adjustments|length > 0 %}
          {% for adj in adjustments %}
          <tr>
            <td>{{ adj.id }}</td>
            <td>{{ adj.get_type_label() }}</td>
            <td>{{ adj.amount }}</td>
            <td>{{ adj.created_at.strftime('%d.%m.%Y') if adj.created_at else '—' }}</td>
            <td>{{ 'Да' if adj.is_applied else 'Нет' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="text-muted">Корректировок нет</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const objectSelect = document.getElementById('incidentObject');
  const categorySelect = document.getElementById('incidentCategory');
  const employeeSelect = document.getElementById('incidentEmployee');

  if (!objectSelect || !categorySelect || !employeeSelect) {
    console.error('Не найдены элементы формы');
    return;
  }

  // Сохраняем текущие значения для предзаполнения
  const currentCategory = '{{ incident.category or '' }}';
  const currentEmployeeId = {{ incident.employee.id if incident.employee else 'null' }};
  const currentObjectId = {{ incident.object.id if incident.object else 'null' }};

  async function loadCategories(objectId) {
    categorySelect.innerHTML = '<option value="">Загрузка...</option>';
    categorySelect.disabled = true;
    try {
      const resp = await fetch(`/manager/incidents/api/categories?object_id=${encodeURIComponent(objectId)}`);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      const data = await resp.json();
      categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
      if (data.categories && data.categories.length > 0) {
        data.categories.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          if (c.name === currentCategory) {
            opt.selected = true;
          }
          categorySelect.appendChild(opt);
        });
      } else if (currentCategory) {
        const opt = document.createElement('option');
        opt.value = currentCategory;
        opt.textContent = currentCategory;
        opt.selected = true;
        categorySelect.appendChild(opt);
      }
      categorySelect.disabled = false;
    } catch (e) {
      console.error('Ошибка загрузки категорий:', e);
      categorySelect.innerHTML = '<option value="">Ошибка загрузки</option>';
      categorySelect.disabled = true;
    }
  }

  function formatEmployee(emp) {
    const parts = [];
    if (emp.last_name) parts.push(emp.last_name);
    if (emp.first_name) parts.push(emp.first_name);
    if (emp.middle_name) parts.push(emp.middle_name);
    return parts.join(' ').trim() || `ID ${emp.id}`;
  }

  function renderEmployeeGroups(groups, selectedId) {
    employeeSelect.innerHTML = '<option value="">Выберите сотрудника</option>';

    if (groups.active && groups.active.length > 0) {
      groups.active.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.id;
        opt.textContent = formatEmployee(emp);
        if (selectedId && emp.id === selectedId) {
          opt.selected = true;
        }
        employeeSelect.appendChild(opt);
      });
    }

    if (groups.former && groups.former.length > 0) {
      const divider = document.createElement('option');
      divider.value = '';
      divider.disabled = true;
      divider.textContent = 'Бывшие';
      divider.classList.add('fw-bold', 'fst-italic', 'text-muted');
      employeeSelect.appendChild(divider);

      groups.former.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.id;
        opt.textContent = formatEmployee(emp);
        opt.classList.add('fst-italic', 'text-muted');
        if (selectedId && emp.id === selectedId) {
          opt.selected = true;
        }
        employeeSelect.appendChild(opt);
      });
    }

    employeeSelect.disabled = false;
  }

  async function loadEmployees(objectId, selectedId = null) {
    employeeSelect.innerHTML = '<option value="">Загрузка...</option>';
    employeeSelect.disabled = true;
    try {
      const resp = await fetch(`/manager/api/employees/for-object/${encodeURIComponent(objectId)}`);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      const data = await resp.json();
      renderEmployeeGroups(data || { active: [], former: [] }, selectedId);
    } catch (e) {
      console.error('Ошибка загрузки сотрудников:', e);
      employeeSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
      employeeSelect.disabled = true;
    }
  }

  // Обработчик изменения объекта
  objectSelect.addEventListener('change', function() {
    const oid = this.value;
    if (!oid) {
      categorySelect.innerHTML = '<option value="">Сначала выберите объект</option>';
      categorySelect.disabled = true;
      employeeSelect.innerHTML = '<option value="">Сначала выберите объект</option>';
      employeeSelect.disabled = true;
      return;
    }
    loadCategories(oid);
    loadEmployees(oid);
  });

  // При загрузке страницы, если объект уже выбран, загружаем категории и сотрудников
  if (objectSelect.value) {
    // Небольшая задержка, чтобы убедиться, что элементы готовы
    setTimeout(() => {
      loadCategories(objectSelect.value);
      loadEmployees(objectSelect.value, currentEmployeeId);
    }, 100);
  } else {
    employeeSelect.innerHTML = '<option value="">Сначала выберите объект</option>';
    employeeSelect.disabled = true;
  }
});
</script>
{% endblock %}


