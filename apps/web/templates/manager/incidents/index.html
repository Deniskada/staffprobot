{% extends "manager/base_manager.html" %}
{% block title %}Инциденты{% endblock %}
{% block manager_content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <div class="d-flex align-items-center gap-2">
      <h2 class="mb-0">Инциденты</h2>
      <a href="/manager/incidents/categories" class="btn btn-outline-secondary btn-sm"><i class="bi bi-tags"></i> Категории</a>
      <a href="/manager/incidents/create" class="btn btn-danger btn-sm"><i class="fas fa-exclamation-triangle"></i> Создать инцидент</a>
    </div>
    <form method="get" class="d-flex gap-2">
      <div>
        <label for="object_id" class="form-label">Объект</label>
        <select name="object_id" id="object_id" class="form-select" onchange="this.form.submit()">
          <option value="">Все объекты</option>
          {% for obj in objects %}
          <option value="{{ obj.id }}" {% if selected_object_id and (selected_object_id|string) == (obj.id|string) %}selected{% endif %}>{{ obj.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label">Статус</label>
        <select name="status" class="form-select" onchange="this.form.submit()">
          <option value="" {% if not status_filter %}selected{% endif %}>Все</option>
          <option value="new" {% if status_filter == 'new' %}selected{% endif %}>Новые</option>
          <option value="in_review" {% if status_filter == 'in_review' %}selected{% endif %}>На рассмотрении</option>
          <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Решённые</option>
          <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Отклонённые</option>
        </select>
      </div>
    </form>
  </div>

  <table class="table table-sm table-hover">
    <thead>
      <tr>
        <th>Номер</th>
        <th>Дата</th>
        <th>Объект</th>
        <th>Сотрудник</th>
        <th>Категория</th>
        <th>Статус</th>
        <th>Ущерб</th>
        <th>Дата удержания</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for i in incidents %}
      <tr class="{{ 'table-danger' if i.severity == 'critical' else 'table-warning' if i.severity == 'high' else '' }}">
        <td>{{ i.custom_number or i.id }}</td>
        <td>{{ i.custom_date.strftime('%d.%m.%Y') if i.custom_date else (i.created_at.strftime('%d.%m.%Y') if i.created_at else '—') }}</td>
        <td>{{ i.object.name if i.object else '—' }}</td>
        <td>{% if i.employee %}{{ (i.employee.last_name or '') }} {{ (i.employee.first_name or '') }}{% else %}—{% endif %}</td>
        <td>{{ i.category or '—' }}</td>
        <td>
          {% if i.status == 'new' %}
            <span class="badge bg-danger">Новый</span>
          {% elif i.status == 'in_review' %}
            <span class="badge bg-warning">На рассмотрении</span>
          {% elif i.status == 'resolved' %}
            <span class="badge bg-success">Решён</span>
          {% elif i.status == 'rejected' %}
            <span class="badge bg-secondary">Отклонён</span>
          {% else %}
            {{ i.status or '—' }}
          {% endif %}
        </td>
        <td>{{ '{:,.2f}'.format(i.damage_amount).replace(',', ' ') if i.damage_amount is not none else '—' }}</td>
        <td>{{ i.custom_date.strftime('%d.%m.%Y') if i.custom_date else '—' }}</td>
        <td>
          <a href="/manager/incidents/{{ i.id }}/edit" class="btn btn-sm btn-outline-primary me-1" title="Редактировать">
            <i class="bi bi-pencil"></i>
          </a>
          {% if i.status == 'new' %}
            <form method="post" action="/manager/incidents/{{ i.id }}/status" class="d-inline">
              <input type="hidden" name="status" value="in_review">
              <button type="submit" class="btn btn-sm btn-warning" title="Взять на рассмотрение">
                <i class="fas fa-eye"></i>
              </button>
            </form>
          {% elif i.status == 'in_review' %}
            <form method="post" action="/manager/incidents/{{ i.id }}/status" class="d-inline">
              <input type="hidden" name="status" value="resolved">
              <button type="submit" class="btn btn-sm btn-success" title="Решить">
                <i class="fas fa-check"></i>
              </button>
            </form>
            <form method="post" action="/manager/incidents/{{ i.id }}/status" class="d-inline">
              <input type="hidden" name="status" value="rejected">
              <button type="submit" class="btn btn-sm btn-secondary" title="Отклонить">
                <i class="fas fa-times"></i>
              </button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="9" class="text-center text-muted">Инциденты не найдены</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}


