{% extends "manager/base_manager.html" %}
{% block title %}Инциденты{% endblock %}
{% block manager_content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <div class="d-flex align-items-center gap-2">
      <h2 class="mb-0">Инциденты</h2>
      <a href="/manager/incidents/categories" class="btn btn-outline-secondary btn-sm"><i class="bi bi-tags"></i> Категории</a>
      <a href="/manager/incidents/create" class="btn btn-danger btn-sm"><i class="fas fa-exclamation-triangle"></i> Создать инцидент</a>
    </div>
    <form method="get" class="d-flex gap-2">
      <div>
        <label for="object_id" class="form-label">Объект</label>
        <select name="object_id" id="object_id" class="form-select" onchange="this.form.submit()">
          <option value="">Все объекты</option>
          {% for obj in objects %}
          <option value="{{ obj.id }}" {% if selected_object_id and (selected_object_id|string) == (obj.id|string) %}selected{% endif %}>{{ obj.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label">Статус</label>
        <select name="status" class="form-select" onchange="this.form.submit()">
          <option value="" {% if not status_filter %}selected{% endif %}>Все</option>
          <option value="new" {% if status_filter == 'new' %}selected{% endif %}>Новые</option>
          <option value="in_review" {% if status_filter == 'in_review' %}selected{% endif %}>На рассмотрении</option>
          <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Решённые</option>
          <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Отклонённые</option>
        </select>
      </div>
    </form>
  </div>

  <table class="table table-sm table-hover">
    <thead>
      <tr>
        {% set toggle = 'desc' if order == 'asc' else 'asc' %}
        <th>
          <a href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort=number&order={{ 'asc' if sort != 'number' else toggle }}&page=1&per_page={{ pagination.per_page }}">Номер</a>
          {% if sort == 'number' %} <i class="bi bi-arrow-{{ 'down' if order=='desc' else 'up' }}"></i>{% endif %}
        </th>
        <th>
          <a href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort=date&order={{ 'asc' if sort != 'date' else toggle }}&page=1&per_page={{ pagination.per_page }}">Дата</a>
          {% if sort == 'date' %} <i class="bi bi-arrow-{{ 'down' if order=='desc' else 'up' }}"></i>{% endif %}
        </th>
        <th>
          <a href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort=object&order={{ 'asc' if sort != 'object' else toggle }}&page=1&per_page={{ pagination.per_page }}">Объект</a>
          {% if sort == 'object' %} <i class="bi bi-arrow-{{ 'down' if order=='desc' else 'up' }}"></i>{% endif %}
        </th>
        <th>
          <a href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort=employee&order={{ 'asc' if sort != 'employee' else toggle }}&page=1&per_page={{ pagination.per_page }}">Сотрудник</a>
          {% if sort == 'employee' %} <i class="bi bi-arrow-{{ 'down' if order=='desc' else 'up' }}"></i>{% endif %}
        </th>
        <th>
          <a href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort=category&order={{ 'asc' if sort != 'category' else toggle }}&page=1&per_page={{ pagination.per_page }}">Категория</a>
          {% if sort == 'category' %} <i class="bi bi-arrow-{{ 'down' if order=='desc' else 'up' }}"></i>{% endif %}
        </th>
        <th>
          <a href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort=status&order={{ 'asc' if sort != 'status' else toggle }}&page=1&per_page={{ pagination.per_page }}">Статус</a>
          {% if sort == 'status' %} <i class="bi bi-arrow-{{ 'down' if order=='desc' else 'up' }}"></i>{% endif %}
        </th>
        <th>
          <a href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort=damage&order={{ 'asc' if sort != 'damage' else toggle }}&page=1&per_page={{ pagination.per_page }}">Ущерб</a>
          {% if sort == 'damage' %} <i class="bi bi-arrow-{{ 'down' if order=='desc' else 'up' }}"></i>{% endif %}
        </th>
        <th>
          <a href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort=retention_date&order={{ 'asc' if sort != 'retention_date' else toggle }}&page=1&per_page={{ pagination.per_page }}">Дата удержания</a>
          {% if sort == 'retention_date' %} <i class="bi bi-arrow-{{ 'down' if order=='desc' else 'up' }}"></i>{% endif %}
        </th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for i in incidents %}
      <tr class="{{ 'table-danger' if i.severity == 'critical' else 'table-warning' if i.severity == 'high' else '' }}">
        <td>{{ i.custom_number or i.id }}</td>
        <td>{{ i.custom_date.strftime('%d.%m.%Y') if i.custom_date else (i.created_at.strftime('%d.%m.%Y') if i.created_at else '—') }}</td>
        <td>{{ i.object.name if i.object else '—' }}</td>
        <td>{% if i.employee %}{{ (i.employee.last_name or '') }} {{ (i.employee.first_name or '') }}{% else %}—{% endif %}</td>
        <td>{{ i.category or '—' }}</td>
        <td>
          {% if i.status == 'new' %}
            <span class="badge bg-danger">Новый</span>
          {% elif i.status == 'in_review' %}
            <span class="badge bg-warning">На рассмотрении</span>
          {% elif i.status == 'resolved' %}
            <span class="badge bg-success">Решён</span>
          {% elif i.status == 'rejected' %}
            <span class="badge bg-secondary">Отклонён</span>
          {% else %}
            {{ i.status or '—' }}
          {% endif %}
        </td>
        <td>{{ '{:,.2f}'.format(i.damage_amount).replace(',', ' ') if i.damage_amount is not none else '—' }}</td>
        <td>{{ i.custom_date.strftime('%d.%m.%Y') if i.custom_date else '—' }}</td>
        <td>
          <a href="/manager/incidents/{{ i.id }}/edit" class="btn btn-sm btn-outline-primary me-1" title="Редактировать">
            <i class="bi bi-pencil"></i>
          </a>
          {% if i.status == 'new' %}
            <form method="post" action="/manager/incidents/{{ i.id }}/status" class="d-inline">
              <input type="hidden" name="new_status" value="in_review">
              <button type="submit" class="btn btn-sm btn-warning" title="Взять на рассмотрение">
                <i class="fas fa-eye"></i>
              </button>
            </form>
          {% elif i.status == 'in_review' %}
            <form method="post" action="/manager/incidents/{{ i.id }}/status" class="d-inline">
              <input type="hidden" name="new_status" value="resolved">
              <button type="submit" class="btn btn-sm btn-success" title="Решить">
                <i class="fas fa-check"></i>
              </button>
            </form>
            <form method="post" action="/manager/incidents/{{ i.id }}/status" class="d-inline">
              <input type="hidden" name="new_status" value="rejected">
              <button type="submit" class="btn btn-sm btn-secondary" title="Отклонить">
                <i class="fas fa-times"></i>
              </button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="9" class="text-center text-muted">Инциденты не найдены</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if pagination.total > 0 %}
  <div class="d-flex justify-content-between align-items-center mt-3">
    <div>
      На странице:
      <select class="form-select d-inline-block w-auto" onchange="location.href='?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort={{ sort }}&order={{ order }}&page=1&per_page='+this.value">
        <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
        <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
      </select>
    </div>
    <div class="pagination d-flex align-items-center gap-2">
      <a class="btn btn-outline-secondary btn-sm {% if pagination.page <= 1 %}disabled{% endif %}"
         href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort={{ sort }}&order={{ order }}&page=1&per_page={{ pagination.per_page }}">Первая</a>
      <a class="btn btn-outline-secondary btn-sm {% if pagination.page <= 1 %}disabled{% endif %}"
         href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort={{ sort }}&order={{ order }}&page={{ pagination.page - 1 }}&per_page={{ pagination.per_page }}">Назад</a>
      <span>{{ pagination.page }} / {{ pagination.pages or 1 }}</span>
      <a class="btn btn-outline-secondary btn-sm {% if pagination.page >= pagination.pages %}disabled{% endif %}"
         href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort={{ sort }}&order={{ order }}&page={{ pagination.page + 1 }}&per_page={{ pagination.per_page }}">Вперёд</a>
      <a class="btn btn-outline-secondary btn-sm {% if pagination.page >= pagination.pages %}disabled{% endif %}"
         href="?object_id={{ selected_object_id or '' }}&status={{ status_filter or '' }}&sort={{ sort }}&order={{ order }}&page={{ pagination.pages }}&per_page={{ pagination.per_page }}">Последняя</a>
    </div>
    <div>
      {{ pagination.start }}-{{ pagination.end }} из {{ pagination.total }}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}


