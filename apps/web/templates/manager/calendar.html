{% extends "manager/base_manager.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/shared/calendar.css') }}">
{% endblock %}

{% block manager_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            {% include 'shared/calendar/objects_panel.html' %}
            {% include 'shared/calendar/employees_panel.html' %}
            {% include 'shared/calendar/quick_create_form.html' %}
            {% include 'shared/calendar/grid.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='js/shared/calendar.js') }}"></script>
<script src="{{ url_for('static', path='js/shared/calendar_panels.js') }}"></script>
<script>
// Define callback functions before using them
function showShiftDetails(shiftId) {
    if (shiftId.toString().startsWith('schedule_')) {
        const scheduleId = shiftId.toString().replace('schedule_', '');
        window.location.href = `/manager/shifts/${scheduleId}?shift_type=schedule`;
    } else {
        window.location.href = `/manager/shifts/${shiftId}`;
    }
}

function showTimeslotDetails(timeslotId) {
    window.location.href = `/manager/timeslots/${timeslotId}`;
}

function showDateDetails(date) {}

const calendarManager = new CalendarManager({
    currentDate: new Date('{{ current_date }}'),
    viewType: '{{ view_type }}',
    baseUrl: '{{ request.url.path }}',
    onShiftClick: showShiftDetails,
    onTimeslotClick: showTimeslotDetails,
    onDateClick: showDateDetails
});
const calendarPanels = new CalendarPanels('manager');

calendarManager.assignEmployeeToTimeslot = async function(employeeId, timeslotId) {
    try {
        const employeeResponse = await fetch(`/manager/api/employees`);
        if (!employeeResponse.ok) throw new Error(`HTTP ${employeeResponse.status}`);
        const employees = await employeeResponse.json();
        const employee = employees.find(e => e.id == parseInt(employeeId));
        if (!employee) return calendarPanels.showNotification('Сотрудник не найден', 'error');

        const tsResp = await fetch(`/manager/calendar/api/timeslot/${timeslotId}`);
        if (!tsResp.ok) throw new Error(`HTTP ${tsResp.status}`);
        const timeslot = await tsResp.json();
        if (!timeslot || !timeslot.slot) return calendarPanels.showNotification('Тайм-слот не найден', 'error');
        const timeStr = `${timeslot.slot.start_time} - ${timeslot.slot.end_time}`;

        const planResp = await fetch('/manager/api/calendar/plan-shift', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ timeslot_id: Number(timeslotId), employee_id: Number(employeeId) })
        });
        const planData = await planResp.json().catch(() => ({}));
        if (!planResp.ok || planData.success === false) {
            const detail = planData && (planData.detail || planData.message);
            throw new Error(detail || `HTTP ${planResp.status}`);
        }
        calendarPanels.showNotification(`Сотрудник ${employee.name} назначен на тайм-слот ${timeStr}`, 'success');
        setTimeout(() => calendarManager.refresh(), 300);
    } catch (err) {
        console.error(err);
        calendarPanels.showNotification(`Ошибка назначения: ${err.message}`, 'error');
    }
};

calendarManager.createTimeslotFromObject = async function(objectId, date) {
    try {
        const objResp = await fetch(`/manager/calendar/api/objects`);
        const objects = await objResp.json();
        const object = objects.find(o => o.id == objectId);
        if (!object) return calendarPanels.showNotification('Объект не найден', 'error');
        await calendarPanels.showQuickCreateForm({
            id: objectId, name: object.name,
            hourlyRate: object.hourly_rate || 0,
            openingTime: object.opening_time || '09:00',
            closingTime: object.closing_time || '18:00'
        }, date);
    } catch (err) {
        console.error(err);
        calendarPanels.showNotification('Ошибка создания тайм-слота', 'error');
    }
};


document.addEventListener('DOMContentLoaded', function() {
    calendarPanels.init();
    setTimeout(() => { calendarManager.setupDragDrop(); }, 1000);
});
</script>
{% endblock %}
