{% extends "manager/base_manager.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/shared/calendar.css') }}">
{% endblock %}

{% block manager_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            {# Панели drag&drop скрыты для менеджера (3.7.3) #}
            <div style="display: none;">
                {% include 'shared/calendar/objects_panel.html' %}
                {% include 'shared/calendar/employees_panel.html' %}
            </div>
            {% include 'shared/calendar/quick_create_form.html' %}
            {% include 'shared/calendar/grid_unified.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Calendar Panels -->
<script src="{{ 'js/shared/calendar_panels.js' | static_version }}"></script>
<!-- Universal Calendar Integration -->
<script src="{{ 'js/shared/universal_calendar.js' | static_version }}"></script>
<script src="{{ 'js/shared/plan_shift_modal.js' | static_version }}"></script>
<script>
    function notifyCalendar(message, type = 'info') {
        if (window.calendarPanels && typeof window.calendarPanels.showNotification === 'function') {
            window.calendarPanels.showNotification(message, type);
        } else if (type === 'error') {
            alert(message);
        } else {
            console.log(`[${type}] ${message}`);
        }
    }

    if (window.PlanShiftModal) {
        window.PlanShiftModal.configure({
            role: 'manager',
            timeslotDetailEndpoint: (timeslotId) => `/manager/calendar/api/timeslot/${timeslotId}`,
            employeesForObjectEndpoint: (objectId) => `/manager/api/employees/for-object/${objectId}`,
            planShiftEndpoint: '/manager/api/calendar/plan-shift',
            notify: notifyCalendar,
            preparePlannedShifts: true,
            refreshCalendar: () => {
                if (window.universalCalendar && typeof window.universalCalendar.refresh === 'function') {
                    window.universalCalendar.refresh();
                } else {
                    setTimeout(() => window.location.reload(), 800);
                }
            }
        });
    }

    // Инициализация универсального календаря для управляющего
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализируем панели (без drag&drop, только для быстрого создания тайм-слотов) (3.7.3)
        if (typeof CalendarPanels !== 'undefined') {
            window.calendarPanels = new CalendarPanels('manager');
            // Инициализируем только для быстрого создания, drag&drop отключен в loadObjects/loadEmployees
            window.calendarPanels.loadObjects();
            window.calendarPanels.loadEmployees();
            
            // Делаем методы глобально доступными для быстрого создания
            window.showQuickCreateForm = (object, date) => window.calendarPanels.showQuickCreateForm(object, date);
            window.createQuickTimeslot = () => window.calendarPanels.createQuickTimeslot();
        }
        
        // Создаем экземпляр универсального календаря
        const buildManagerReturnTo = () => {
            const search = window.location.search || '';
            return `/manager/calendar${search}`;
        };

        const navigateToManagerPlan = (objectId, employeeId) => {
            const params = new URLSearchParams();
            if (objectId) {
                params.set('object_id', objectId);
            }
            if (employeeId) {
                params.set('employee_id', employeeId);
            }
            params.set('return_to', buildManagerReturnTo());
            window.location.href = `/manager/shifts/plan?${params.toString()}`;
        };

        if (typeof UniversalCalendarManager !== 'undefined') {
            window.universalCalendar = new UniversalCalendarManager({
                currentDate: new Date({{ year }}, {{ month - 1 }}, 1),
                viewType: 'month',
                baseUrl: '/manager/calendar',
                userRole: 'manager',
                apiEndpoint: '/manager/calendar/api/data',
                onShiftClick: function(shiftId) {
                    console.log('Shift clicked:', shiftId);
                    if (shiftId.toString().startsWith('schedule_')) {
                        const scheduleId = shiftId.toString().replace('schedule_', '');
                        // Получаем object_id из данных календаря
                        let objectId = null;
                        if (window.calendarData && window.calendarData.shifts) {
                            const shift = window.calendarData.shifts.find(s => s.id === shiftId);
                            if (shift && shift.object_id) {
                                objectId = shift.object_id;
                            }
                        }
                        // Если не нашли в данных, делаем запрос к API
                        if (!objectId) {
                            fetch(`/manager/shifts/api/schedule/${scheduleId}/object-id`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.object_id) {
                                        const employeeId = data.employee_id || (window.calendarData?.shifts?.find(s => s.id === shiftId)?.user_id) || null;
                                        navigateToManagerPlan(data.object_id, employeeId);
                                    } else {
                                        const employeeId = data.employee_id || (window.calendarData?.shifts?.find(s => s.id === shiftId)?.user_id) || null;
                                        navigateToManagerPlan(null, employeeId);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error fetching object_id:', error);
                                    const cached = window.calendarData?.shifts?.find(s => s.id === shiftId);
                                    const employeeId = cached?.user_id || null;
                                    navigateToManagerPlan(null, employeeId);
                                });
                        } else {
                            const cached = window.calendarData?.shifts?.find(s => s.id === shiftId);
                            const employeeId = cached?.user_id || null;
                            navigateToManagerPlan(objectId, employeeId);
                        }
                    } else {
                        window.location.href = `/manager/shifts/${shiftId}?shift_type=shift`;
                    }
                },
                onTimeslotClick: function(timeslotId) {
                    console.log('Timeslot clicked:', timeslotId);
                    if (window.PlanShiftModal && typeof window.PlanShiftModal.open === 'function') {
                        window.PlanShiftModal.open(timeslotId);
                        return;
                    }

                    let objectId = null;
                    let employeeId = null;
                    if (window.calendarData) {
                        if (window.calendarData.timeslots) {
                            const timeslot = window.calendarData.timeslots.find(ts => ts.id == timeslotId);
                            if (timeslot && timeslot.object_id) {
                                objectId = timeslot.object_id;
                            }
                        }
                        if (window.calendarData.shifts) {
                            const plannedShift = window.calendarData.shifts.find(shift => String(shift.time_slot_id) === String(timeslotId) && (shift.status === 'planned' || shift.status === 'confirmed'));
                            if (plannedShift && plannedShift.user_id) {
                                employeeId = plannedShift.user_id;
                            }
                        }
                    }
                    navigateToManagerPlan(objectId, employeeId);
                },
                onDataLoaded: function(calendarData) {
                    console.log('Manager calendar data loaded:', calendarData);
                    // Сохраняем данные глобально для использования в onShiftClick
                    window.calendarData = calendarData;
                    // Обновляем отображение с новыми данными
                    if (typeof window.renderCalendarGrid === 'function') {
                        window.renderCalendarGrid(calendarData);
                    }
                }
            });
            
            // Проверяем параметр scrollToToday и скроллим к сегодняшнему дню
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('scrollToToday') === 'true') {
                // Удаляем параметр из URL
                urlParams.delete('scrollToToday');
                const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                window.history.replaceState({}, '', newUrl);
                
                // Вызываем goToToday после небольшой задержки, чтобы календарь успел инициализироваться
                setTimeout(() => {
                    if (window.universalCalendar && typeof window.universalCalendar.goToToday === 'function') {
                        window.universalCalendar.goToToday();
                    }
                }, 500);
            }
        }
        
        // Добавляем обработчик клика на пустой день календаря для быстрого создания тайм-слота (3.7.1)
        // Клик на пустой день (не на тайм-слот и не на смену) → форма создания тайм-слота
        document.addEventListener('click', function(e) {
            const calendarDay = e.target.closest('.calendar-day');
            // Проверяем, что клик не на тайм-слот и не на смену
            if (calendarDay && !e.target.closest('.timeslot-item') && !e.target.closest('.shift-item') && !e.target.closest('.calendar-timeslot')) {
                const dateStr = calendarDay.dataset.date;
                if (dateStr && !calendarDay.classList.contains('other-month')) {
                    // Открываем форму быстрого создания тайм-слота
                    if (window.calendarPanels) {
                        window.calendarPanels.showQuickCreateForm(null, dateStr);
                    }
                }
            }
        });
    });

</script>
{% endblock %}