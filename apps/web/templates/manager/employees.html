{% extends "manager/base_manager.html" %}

{% block manager_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-people me-2"></i>
                    Сотрудники
                </h1>
                <div class="d-flex gap-2">
                    <a href="/manager/employees/add" class="btn btn-primary">
                        <i class="bi bi-person-plus me-1"></i>
                        Создать договор
                    </a>
                    <button class="btn btn-outline-primary" onclick="refreshEmployees()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Обновить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Всего</h6>
                            <h3 class="mb-0">{{ pagination.total }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Активные</h6>
                            <h3 class="mb-0">{{ employees|selectattr('is_active')|list|length }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-person-check fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">На смене</h6>
                            <h3 class="mb-0">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-clock fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Новые</h6>
                            <h3 class="mb-0">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-person-plus fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список сотрудников -->
    {% if employees %}
    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th>
                        <a href="?sort=name&order={% if sort.field == 'name' %}{% if sort.order == 'desc' %}asc{% else %}desc{% endif %}{% else %}asc{% endif %}&per_page={{ pagination.per_page }}{% if filters.q_name %}&q_name={{ filters.q_name }}{% endif %}"
                           class="text-decoration-none text-dark">
                            Сотрудник
                            {% if sort.field == 'name' %}
                                {% if sort.order == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                        <div class="mt-1 d-flex gap-1">
                            <input type="text" class="form-control form-control-sm flex-grow-1" id="filterEmployeeName" placeholder="Фильтр по ФИО" value="{{ filters.q_name or '' }}" onkeyup="filterEmployeesTable()">
                            <button type="button" class="btn btn-outline-secondary btn-sm text-white" onclick="clearEmployeeFilter('filterEmployeeName')" title="Очистить">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </th>
                    <th>
                        <a href="?sort=phone&order={% if sort.field == 'phone' %}{% if sort.order == 'desc' %}asc{% else %}desc{% endif %}{% else %}asc{% endif %}&per_page={{ pagination.per_page }}{% if filters.q_name %}&q_name={{ filters.q_name }}{% endif %}"
                           class="text-decoration-none text-dark">
                            Телефон
                            {% if sort.field == 'phone' %}
                                {% if sort.order == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>Роль</th>
                    <th>Статус</th>
                    <th>
                        <a href="?sort=created_at&order={% if sort.field == 'created_at' %}{% if sort.order == 'desc' %}asc{% else %}desc{% endif %}{% else %}asc{% endif %}&per_page={{ pagination.per_page }}{% if filters.q_name %}&q_name={{ filters.q_name }}{% endif %}"
                           class="text-decoration-none text-dark">
                            Дата регистрации
                            {% if sort.field == 'created_at' %}
                                {% if sort.order == 'asc' %}
                                    <i class="bi bi-arrow-up"></i>
                                {% else %}
                                    <i class="bi bi-arrow-down"></i>
                                {% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="employeesTableBody">
                {% for employee in employees %}
                <tr data-name="{{ ((employee.last_name or '') + ' ' + (employee.first_name or '')).strip().lower() }}"
                    data-username="{{ (employee.username or '').lower() }}">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3">
                                {{ (employee.first_name or '?')[0] }}
                            </div>
                            <div>
                                <strong>{{ (employee.last_name or '') }} {{ employee.first_name or '' }}</strong>
                                {% if employee.username %}
                                <br><small class="text-muted">@{{ employee.username }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if employee.phone %}
                            <i class="bi bi-telephone me-1"></i>{{ employee.phone }}
                        {% else %}
                            <span class="text-muted">Не указан</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if employee.roles %}
                            {% for role in employee.roles %}
                                <span class="badge bg-secondary me-1">{{ role }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="badge bg-secondary">{{ employee.role }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if employee.is_active %}
                            <span class="badge bg-success">Активен</span>
                        {% else %}
                            <span class="badge bg-secondary">Неактивен</span>
                        {% endif %}
                    </td>
                    <td>
                        <i class="bi bi-calendar3 me-1"></i>
                        {% if employee.created_at %}
                            {{ employee.created_at.strftime('%d.%m.%Y') }}
                        {% else %}
                            Не указана
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewEmployee({{ employee.id }})" title="Подробнее">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="editEmployee({{ employee.id }})" title="Редактировать">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="viewShifts({{ employee.id }})" title="Смены">
                                <i class="bi bi-clock"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Пагинация -->
    {% if pagination.total > 0 and pagination.pages > 1 %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex align-items-center gap-2">
                    <label for="perPageSelect" class="mb-0">На странице:</label>
                    <select class="form-select form-select-sm" id="perPageSelect" style="width: auto;" onchange="changePerPage(this.value)">
                        <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <a href="?page=1&per_page={{ pagination.per_page }}{% if sort.field %}&sort={{ sort.field }}&order={{ sort.order }}{% endif %}{% if filters.q_name %}&q_name={{ filters.q_name }}{% endif %}" 
                       class="btn btn-sm btn-outline-secondary {% if pagination.page == 1 %}disabled{% endif %}">
                        Первая
                    </a>
                    <a href="?page={{ pagination.page - 1 }}&per_page={{ pagination.per_page }}{% if sort.field %}&sort={{ sort.field }}&order={{ sort.order }}{% endif %}{% if filters.q_name %}&q_name={{ filters.q_name }}{% endif %}" 
                       class="btn btn-sm btn-outline-secondary {% if pagination.page == 1 %}disabled{% endif %}">
                        Назад
                    </a>
                    <span class="px-3">
                        {{ pagination.page }} / {{ pagination.pages }}
                    </span>
                    <a href="?page={{ pagination.page + 1 }}&per_page={{ pagination.per_page }}{% if sort.field %}&sort={{ sort.field }}&order={{ sort.order }}{% endif %}{% if filters.q_name %}&q_name={{ filters.q_name }}{% endif %}" 
                       class="btn btn-sm btn-outline-secondary {% if pagination.page >= pagination.pages %}disabled{% endif %}">
                        Вперед
                    </a>
                    <a href="?page={{ pagination.pages }}&per_page={{ pagination.per_page }}{% if sort.field %}&sort={{ sort.field }}&order={{ sort.order }}{% endif %}{% if filters.q_name %}&q_name={{ filters.q_name }}{% endif %}" 
                       class="btn btn-sm btn-outline-secondary {% if pagination.page >= pagination.pages %}disabled{% endif %}">
                        Последняя
                    </a>
                </div>
                <div class="text-muted">
                    {% set start_item = (pagination.page - 1) * pagination.per_page + 1 %}
                    {% set end_item = [pagination.page * pagination.per_page, pagination.total]|min %}
                    {{ start_item }}-{{ end_item }} из {{ pagination.total }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
        <h5 class="mt-3 text-muted">Нет сотрудников</h5>
        <p class="text-muted">Сотрудники, назначенные на ваши объекты, появятся здесь</p>
    </div>
    {% endif %}
</div>

<style>
.avatar-sm {
    width: 40px;
    height: 40px;
    font-size: 16px;
    font-weight: bold;
}
</style>

<script>
// Клиентский фильтр для таблицы сотрудников (без перезагрузки)
function filterEmployeesTable() {
    const nameFilterInput = document.getElementById('filterEmployeeName');
    const nameFilter = nameFilterInput?.value.toLowerCase() || '';
    
    const rows = document.querySelectorAll('#employeesTableBody tr');
    
    rows.forEach(row => {
        const name = row.dataset.name || '';
        const username = row.dataset.username || '';
        
        let show = true;
        
        if (nameFilter && !name.includes(nameFilter) && !username.includes(nameFilter)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
    
    // Сохраняем фокус на поле ввода
    if (nameFilterInput) {
        nameFilterInput.focus();
    }
}

function clearEmployeeFilter(filterId) {
    const filter = document.getElementById(filterId);
    if (filter) {
        filter.value = '';
        filterEmployeesTable();
    }
}

function changePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1'); // Сбрасываем на первую страницу
    window.location.href = url.toString();
}

function refreshEmployees() {
    location.reload();
}

function viewEmployee(employeeId) {
    window.location.href = '/manager/employees/' + employeeId;
}

function editEmployee(employeeId) {
    window.location.href = '/manager/employees/' + employeeId + '/edit';
}

function viewShifts(employeeId) {
    window.location.href = '/manager/employees/' + employeeId + '/shifts';
}

// Восстановление фильтров из URL при загрузке
document.addEventListener('DOMContentLoaded', function() {
    filterEmployeesTable();
});
</script>
{% endblock %}
