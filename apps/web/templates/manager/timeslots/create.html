{% extends "manager/base_manager.html" %}

{% block title %}Создать тайм-слот - {{ object.name }}{% endblock %}

{% macro format_time(value) %}
    {% if value is not none %}
        {% if value is string %}
            {{ value }}
        {% else %}
            {{ value.strftime('%H:%M') }}
        {% endif %}
    {% else %}
        —
    {% endif %}
{% endmacro %}

{% block manager_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Создать тайм-слот</h1>
                    <p class="text-muted mb-0">{{ object.name }}</p>
                </div>
                <div>
                    <a href="/manager/timeslots/object/{{ object.id }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Назад к списку
                    </a>
                </div>
            </div>
            
            <!-- Информация об объекте -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <small class="text-muted">Адрес</small>
                            <div class="fw-bold">{{ object.address or "Не указан" }}</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Время работы</small>
                            <div class="fw-bold">{{ format_time(object.opening_time) }} - {{ format_time(object.closing_time) }}</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Ставка</small>
                            <div class="fw-bold">{{ object.hourly_rate }} ₽/час</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Макс. расстояние</small>
                            <div class="fw-bold">{{ object.max_distance_meters }} м</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Форма создания -->
            <div class="card">
                <div class="card-body">
                    <form method="post" action="/manager/timeslots/object/{{ object.id }}/create">
                        <!-- Режим создания -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label fw-bold">Режим создания</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="creation_mode" id="mode-single" value="single" checked>
                                    <label class="btn btn-outline-primary" for="mode-single">
                                        <i class="fas fa-calendar-day"></i> Один тайм-слот
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="creation_mode" id="mode-template" value="template">
                                    <label class="btn btn-outline-primary" for="mode-template">
                                        <i class="fas fa-calendar-week"></i> Много тайм-слотов
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Режим: Один тайм-слот -->
                        <div id="single-mode" class="creation-mode">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="slot_date" class="form-label">Дата <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="slot_date" name="slot_date" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="start_time" class="form-label">Время начала <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control" id="start_time" name="start_time" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="end_time" class="form-label">Время окончания <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control" id="end_time" name="end_time" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="hourly_rate" class="form-label">Ставка за час (₽) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="hourly_rate" name="hourly_rate" 
                                           value="{{ object.hourly_rate }}" min="0" step="0.01" required>
                                    <div class="form-text">Оставьте пустым для использования ставки объекта</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="max_employees" class="form-label">Максимум сотрудников</label>
                                    <input type="number" class="form-control" id="max_employees" name="max_employees" 
                                           value="1" min="1" max="10">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="notes" class="form-label">Примечания</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="Дополнительная информация о тайм-слоте"></textarea>
                                </div>
                            </div>
                            
                            <!-- Настройки опозданий и задач -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="penalize_late_start" name="penalize_late_start" checked>
                                        <label class="form-check-label" for="penalize_late_start">
                                            <i class="bi bi-alarm text-warning"></i> Штрафовать за опоздание
                                            <small class="text-muted d-block">Применять штраф за опоздание на начало этого тайм-слота</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ignore_object_tasks" name="ignore_object_tasks">
                                        <label class="form-check-label" for="ignore_object_tasks">
                                            <i class="bi bi-x-circle text-danger"></i> Игнорировать задачи объекта
                                            <small class="text-muted d-block">Использовать только задачи этого тайм-слота</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Задачи на смену -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h5><i class="bi bi-check2-square me-2"></i>Задачи на смену</h5>
                                    <div id="tasks-container"></div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-task">
                                        <i class="bi bi-plus-circle me-1"></i>Добавить задачу
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Режим: Много тайм-слотов -->
                        <div id="template-mode" class="creation-mode" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="start_time_multi" class="form-label">Время начала <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control" id="start_time_multi" name="start_time_multi" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="end_time_multi" class="form-label">Время окончания <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control" id="end_time_multi" name="end_time_multi" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="hourly_rate_multi" class="form-label">Ставка за час (₽)</label>
                                    <input type="number" class="form-control" id="hourly_rate_multi" name="hourly_rate_multi" 
                                           min="0" step="0.01" placeholder="Оставьте пустым для использования ставки объекта">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="max_employees_multi" class="form-label">Максимум сотрудников</label>
                                    <input type="number" class="form-control" id="max_employees_multi" name="max_employees_multi" 
                                           value="1" min="1" max="10">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="start_date" class="form-label">Дата начала <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="end_date" class="form-label">Дата окончания <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" required>
                                </div>
                            </div>
                            
                            <!-- Выбор дней недели -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label">Дни недели <span class="text-danger">*</span></label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="checkbox" class="btn-check" id="day-monday" name="weekdays" value="1">
                                        <label class="btn btn-outline-primary" for="day-monday">Пн</label>
                                        
                                        <input type="checkbox" class="btn-check" id="day-tuesday" name="weekdays" value="2">
                                        <label class="btn btn-outline-primary" for="day-tuesday">Вт</label>
                                        
                                        <input type="checkbox" class="btn-check" id="day-wednesday" name="weekdays" value="3">
                                        <label class="btn btn-outline-primary" for="day-wednesday">Ср</label>
                                        
                                        <input type="checkbox" class="btn-check" id="day-thursday" name="weekdays" value="4">
                                        <label class="btn btn-outline-primary" for="day-thursday">Чт</label>
                                        
                                        <input type="checkbox" class="btn-check" id="day-friday" name="weekdays" value="5">
                                        <label class="btn btn-outline-primary" for="day-friday">Пт</label>
                                        
                                        <input type="checkbox" class="btn-check" id="day-saturday" name="weekdays" value="6">
                                        <label class="btn btn-outline-primary" for="day-saturday">Сб</label>
                                        
                                        <input type="checkbox" class="btn-check" id="day-sunday" name="weekdays" value="0">
                                        <label class="btn btn-outline-primary" for="day-sunday">Вс</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Чередование дней -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="alternation_type" class="form-label">Чередование</label>
                                    <select class="form-select" id="alternation_type" name="alternation_type">
                                        <option value="daily">Ежедневно</option>
                                        <option value="weekly">Еженедельно</option>
                                        <option value="biweekly">Раз в две недели</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="notes_multi" class="form-label">Примечания</label>
                                    <textarea class="form-control" id="notes_multi" name="notes_multi" rows="2" 
                                              placeholder="Дополнительная информация..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Кнопки -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="/manager/timeslots/object/{{ object.id }}" class="btn btn-outline-secondary">
                                        Отмена
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Создать тайм-слот
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modeSingle = document.getElementById('mode-single');
    const modeTemplate = document.getElementById('mode-template');
    const singleMode = document.getElementById('single-mode');
    const templateMode = document.getElementById('template-mode');
    const multiStartTime = document.getElementById('start_time_multi');
    const multiEndTime = document.getElementById('end_time_multi');
    const multiHourlyRate = document.getElementById('hourly_rate_multi');
    const multiMaxEmployees = document.getElementById('max_employees_multi');

    const singleDateInput = document.getElementById('slot_date');
    const singleStartInput = document.getElementById('start_time');
    const singleEndInput = document.getElementById('end_time');

    const templateStartDate = document.getElementById('start_date');
    const templateEndDate = document.getElementById('end_date');

    function setTemplateFieldsRequired(isRequired) {
        if (isRequired) {
            multiStartTime.setAttribute('required', 'required');
            multiEndTime.setAttribute('required', 'required');
            templateStartDate.setAttribute('required', 'required');
            templateEndDate.setAttribute('required', 'required');
        } else {
            multiStartTime.removeAttribute('required');
            multiEndTime.removeAttribute('required');
            templateStartDate.removeAttribute('required');
            templateEndDate.removeAttribute('required');
        }
    }

    function setSingleFieldsRequired(isRequired) {
        if (isRequired) {
            singleDateInput.setAttribute('required', 'required');
            singleStartInput.setAttribute('required', 'required');
            singleEndInput.setAttribute('required', 'required');
        } else {
            singleDateInput.removeAttribute('required');
            singleStartInput.removeAttribute('required');
            singleEndInput.removeAttribute('required');
        }
    }

    // Переключение режимов
    function toggleModes() {
        if (modeSingle.checked) {
            singleMode.style.display = 'block';
            templateMode.style.display = 'none';
            setSingleFieldsRequired(true);
            setTemplateFieldsRequired(false);
        } else {
            singleMode.style.display = 'none';
            templateMode.style.display = 'block';
            setSingleFieldsRequired(false);
            setTemplateFieldsRequired(true);
        }
    }
    
    modeSingle.addEventListener('change', toggleModes);
    modeTemplate.addEventListener('change', toggleModes);
    
    // Валидация выбора дней недели
    function validateWeekdays() {
        const weekdays = document.querySelectorAll('input[name="weekdays"]:checked');
        if (weekdays.length === 0) {
            alert('Выберите хотя бы один день недели');
            return false;
        }
        return true;
    }
    
    // Обработка отправки формы
    document.querySelector('form').addEventListener('submit', function(e) {
        if (modeTemplate.checked && !validateWeekdays()) {
            e.preventDefault();
            return false;
        }
    });
    
    // Установка минимальной даты на сегодня
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('slot_date').setAttribute('min', today);
    document.getElementById('start_date').setAttribute('min', today);
    document.getElementById('end_date').setAttribute('min', today);
    
    // Работа с задачами
    let taskIndex = 0;
    
    document.getElementById('add-task').addEventListener('click', function() {
        const taskHtml = `
            <div class="task-item mb-2 p-3 border rounded">
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <input type="text" class="form-control" name="task_text[]" placeholder="Описание задачи" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" name="task_amount[]" step="0.01" placeholder="Премия (₽)" value="0">
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="task_mandatory_${taskIndex}" value="true">
                            <label class="form-check-label">Обязательная</label>
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="task_media_${taskIndex}" value="true">
                            <label class="form-check-label">Медиа отчет</label>
                        </div>
                    </div>
                    <div class="col-md-1 text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-task">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('tasks-container').insertAdjacentHTML('beforeend', taskHtml);
        taskIndex++;
    });
    
    // Удаление задачи
    document.getElementById('tasks-container').addEventListener('click', function(e) {
        if (e.target.closest('.remove-task')) {
            e.target.closest('.task-item').remove();
        }
    });
    
    // Обработка unchecked checkboxes перед отправкой формы
    document.querySelector('form').addEventListener('submit', function(e) {
        const penalizeCheckbox = document.getElementById('penalize_late_start');
        const ignoreCheckbox = document.getElementById('ignore_object_tasks');
        
        if (!penalizeCheckbox.checked) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'penalize_late_start';
            hiddenInput.value = 'false';
            this.appendChild(hiddenInput);
        }
        
        if (!ignoreCheckbox.checked) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'ignore_object_tasks';
            hiddenInput.value = 'false';
            this.appendChild(hiddenInput);
        }
        
        // Валидация выбора дней недели для режима шаблона
        if (modeTemplate.checked) {
            return validateWeekdays();
        }
    });
    
    // Инициализация
    toggleModes();
});
</script>
{% endblock %}
