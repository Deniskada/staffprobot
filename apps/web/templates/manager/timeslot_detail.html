{% extends "manager/base_manager.html" %}

{% block title %}{{ title }}{% endblock %}

{% block manager_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-clock"></i> Детали тайм-слота</h2>
                <div>
                    <button type="button" class="btn btn-primary me-2" onclick="toggleEditMode()">
                        <i class="bi bi-pencil"></i> Редактировать
                    </button>
                    <a href="/manager/calendar" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Назад к календарю
                    </a>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-building"></i> {{ timeslot.object.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Время работы</h6>
                            <p class="text-muted">
                                <i class="bi bi-clock"></i> 
                                {{ timeslot.start_time.strftime('%H:%M') }} - {{ timeslot.end_time.strftime('%H:%M') }}
                            </p>
                            
                            <h6>Дата</h6>
                            <p class="text-muted">
                                <i class="bi bi-calendar"></i> 
                                {{ timeslot.slot_date.strftime('%d.%m.%Y') }}
                            </p>
                            
                            <h6>Часовая ставка</h6>
                            <p class="text-muted">
                                <i class="bi bi-currency-dollar"></i> 
                                {{ timeslot.object.hourly_rate }} руб/час
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>Адрес</h6>
                            <p class="text-muted">
                                <i class="bi bi-geo-alt"></i> 
                                {{ timeslot.object.address or 'Не указан' }}
                            </p>
                            
                            <h6>Максимальное количество сотрудников</h6>
                            <p class="text-muted">
                                <i class="bi bi-people"></i> 
                                {{ timeslot.max_employees or 1 }} сотрудников
                            </p>
                            
                            <h6>Статус</h6>
                            <p class="text-muted">
                                {% if scheduled_shifts %}
                                    <span class="badge bg-warning">Запланирован</span>
                                {% elif actual_shifts %}
                                    <span class="badge bg-success">Активен</span>
                                {% else %}
                                    <span class="badge bg-secondary">Свободен</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% if timeslot.notes %}
                    <div class="mt-3">
                        <h6>Примечания</h6>
                        <p class="text-muted">{{ timeslot.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Запланированные смены -->
            {% if scheduled_shifts %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check"></i> Запланированные смены
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Сотрудник</th>
                                    <th>Время начала</th>
                                    <th>Время окончания</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for shift in scheduled_shifts %}
                                <tr>
                                    <td>
                                        <strong>{{ shift.user.first_name }} {{ shift.user.last_name or '' }}</strong>
                                        {% if shift.user.username %}
                                            <br><small class="text-muted">
                                                {% if shift.user.username.startswith('@') %}
                                                    {{ shift.user.username }}
                                                {% else %}
                                                    @{{ shift.user.username }}
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>{{ shift.planned_start.strftime('%H:%M') }}</td>
                                    <td>{{ shift.planned_end.strftime('%H:%M') }}</td>
                                    <td>
                                        {% if shift.status == 'planned' %}
                                            <span class="badge bg-warning">Запланирована</span>
                                        {% elif shift.status == 'confirmed' %}
                                            <span class="badge bg-info">Подтверждена</span>
                                        {% elif shift.status == 'cancelled' %}
                                            <span class="badge bg-danger">Отменена</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ shift.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Фактические смены -->
            {% if actual_shifts %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Фактические смены
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Сотрудник</th>
                                    <th>Время начала</th>
                                    <th>Время окончания</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for shift in actual_shifts %}
                                <tr>
                                    <td>
                                        <strong>{{ shift.user.first_name }} {{ shift.user.last_name or '' }}</strong>
                                        {% if shift.user.username %}
                                            <br><small class="text-muted">
                                                {% if shift.user.username.startswith('@') %}
                                                    {{ shift.user.username }}
                                                {% else %}
                                                    @{{ shift.user.username }}
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>{{ shift.start_time.strftime('%H:%M') }}</td>
                                    <td>
                                        {% if shift.end_time %}
                                            {{ shift.end_time.strftime('%H:%M') }}
                                        {% else %}
                                            <span class="text-muted">Не завершена</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if shift.status == 'active' %}
                                            <span class="badge bg-success">Активна</span>
                                        {% elif shift.status == 'completed' %}
                                            <span class="badge bg-primary">Завершена</span>
                                        {% elif shift.status == 'cancelled' %}
                                            <span class="badge bg-danger">Отменена</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ shift.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Если нет смен -->
            {% if not scheduled_shifts and not actual_shifts %}
            <div class="card mt-4">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">Нет запланированных смен</h5>
                    <p class="text-muted">Этот тайм-слот свободен для планирования</p>
                </div>
            </div>
            {% endif %}

            <!-- Форма редактирования (скрыта по умолчанию) -->
            <div id="editForm" class="card mt-4" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil"></i> Редактирование тайм-слота
                    </h5>
                </div>
                <div class="card-body">
                    <form id="timeslotEditForm" onsubmit="updateTimeslot(event)">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_employees" class="form-label">Максимальное количество сотрудников</label>
                                    <input type="number" class="form-control" id="max_employees" 
                                           name="max_employees" min="1" max="10" 
                                           value="{{ timeslot.max_employees or 1 }}" required>
                                    <div class="form-text">Количество сотрудников, которые могут работать в этом тайм-слоте</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hourly_rate" class="form-label">Часовая ставка (руб/час)</label>
                                    <input type="number" class="form-control" id="hourly_rate" 
                                           name="hourly_rate" min="0" step="0.01" 
                                           value="{{ timeslot.hourly_rate or timeslot.object.hourly_rate }}" required>
                                    <div class="form-text">Ставка за час работы для этого тайм-слота</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Примечания</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Дополнительная информация о тайм-слоте">{{ timeslot.notes or '' }}</textarea>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="is_active" 
                                   name="is_active" {% if timeslot.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">
                                Активный тайм-слот
                            </label>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="cancelEdit()">
                                Отмена
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check"></i> Сохранить изменения
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleEditMode() {
    const editForm = document.getElementById('editForm');
    const editButton = document.querySelector('button[onclick="toggleEditMode()"]');
    
    if (editForm.style.display === 'none') {
        editForm.style.display = 'block';
        editButton.innerHTML = '<i class="bi bi-x"></i> Отменить';
        editButton.onclick = cancelEdit;
    } else {
        editForm.style.display = 'none';
        editButton.innerHTML = '<i class="bi bi-pencil"></i> Редактировать';
        editButton.onclick = toggleEditMode;
    }
}

function cancelEdit() {
    const editForm = document.getElementById('editForm');
    const editButton = document.querySelector('button[onclick="cancelEdit()"]');
    
    editForm.style.display = 'none';
    editButton.innerHTML = '<i class="bi bi-pencil"></i> Редактировать';
    editButton.onclick = toggleEditMode;
}

async function updateTimeslot(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        max_employees: parseInt(formData.get('max_employees')),
        hourly_rate: parseFloat(formData.get('hourly_rate')),
        notes: formData.get('notes'),
        is_active: formData.get('is_active') === 'on'
    };
    
    try {
        const response = await fetch(`/manager/timeslots/{{ timeslot.id }}/edit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            // Показываем уведомление об успехе
            showNotification('Тайм-слот успешно обновлен', 'success');
            // Перезагружаем страницу через 1 секунду
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const errorData = await response.json();
            showNotification(`Ошибка: ${errorData.detail || 'Неизвестная ошибка'}`, 'error');
        }
    } catch (error) {
        console.error('Error updating timeslot:', error);
        showNotification('Ошибка при обновлении тайм-слота', 'error');
    }
}

function showNotification(message, type) {
    // Создаем уведомление
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>
{% endblock %}
