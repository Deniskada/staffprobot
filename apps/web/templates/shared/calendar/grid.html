<!-- Shared Calendar Grid Component -->
<div class="calendar-container">
    <div class="calendar-header">
        <div class="calendar-legend mb-2" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#e3f2fd; border:1px solid #2196f3;"></span>
                <small>Запланированная смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#ccff90; border:1px solid #43a047;"></span>
                <small>Текущая смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#c8e6c9; border:2px solid #2e7d32;"></span>
                <small>Завершённая смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#ffebee; border:1px solid #f44336;"></span>
                <small>Свободный тайм‑слот</small>
            </div>
        </div>
        <div class="calendar-navigation">
            <div class="nav-group">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="navigateCalendar('prev')">
                    <i class="bi bi-chevron-left"></i> Предыдущий
                </button>
                <h4 class="calendar-title mb-0">{{ calendar_title }}</h4>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="navigateCalendar('next')">
                    Следующий <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            <div class="nav-actions">
                {% if show_today_button %}
                <button type="button" class="btn btn-primary btn-sm" onclick="goToToday()">
                    <i class="bi bi-calendar-today"></i> Сегодня
                </button>
                {% endif %}
            </div>
        </div>
    </div>


    <div class="calendar-grid">
        <!-- Day headers -->
        <div class="calendar-day-header">Пн</div>
        <div class="calendar-day-header">Вт</div>
        <div class="calendar-day-header">Ср</div>
        <div class="calendar-day-header">Чт</div>
        <div class="calendar-day-header">Пт</div>
        <div class="calendar-day-header">Сб</div>
        <div class="calendar-day-header">Вс</div>

        <!-- Calendar days -->
        {% for week in calendar_weeks %}
            {% for day in week %}
                <div class="calendar-day {% if day.is_other_month %}other-month{% endif %} {% if day.is_today %}today{% endif %}" 
                     data-date="{{ day.date }}" 
                     data-day="{{ day.day }}">
                    <div class="day-number">{{ day.day }}</div>
                    
                    <!-- Day content -->
                    <div class="day-content">
                        {% if day.shifts %}
                            {% for shift in day.shifts %}
                                {% set shift_class = "shift-item" %}
                                {% if shift.status == "completed" %}
                                    {% set shift_class = shift_class + " shift-completed-positive" %}
                                {% elif shift.status == "active" %}
                                    {% set shift_class = shift_class + " shift-active-positive" %}
                                {% elif shift.status == "planned" %}
                                    {% set shift_class = shift_class + " shift-planned" %}
                                {% else %}
                                    {% set shift_class = shift_class + " shift-" + shift.status %}
                                {% endif %}
                                <div class="{{ shift_class }}" 
                                     data-shift-id="{{ shift.id }}"
                                     onclick="showShiftDetails('{{ shift.id }}')">
                                    <div class="shift-time">{{ shift.start_time }} - {{ shift.end_time }}</div>
                                    <div class="shift-employee">{{ shift.employee_name }}</div>
                                    {% if shift.object_name %}
                                    <div class="shift-object">{{ shift.object_name }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endif %}
                        
                        {% if day.timeslots %}
                            {% for timeslot in day.timeslots %}
                                {% set timeslot_class = "timeslot-item" %}
                                {% if timeslot.status == "available" %}
                                    {% set timeslot_class = timeslot_class + " timeslot-free" %}
                                {% else %}
                                    {% set timeslot_class = timeslot_class + " timeslot-" + timeslot.status %}
                                {% endif %}
                                <div class="{{ timeslot_class }}" 
                                     data-timeslot-id="{{ timeslot.id }}"
                                     data-object-id="{{ timeslot.object_id }}"
                                     data-max-employees="{{ timeslot.max_employees or 1 }}"
                                     onclick="showTimeslotDetails({{ timeslot.id }})">
                                    <div class="timeslot-time">{{ timeslot.start_time }} - {{ timeslot.end_time }}</div>
                                    <div class="timeslot-object">{{ timeslot.object_name }}</div>
                                    {% if timeslot.employee_count %}
                                    <div class="timeslot-employees">{{ timeslot.employee_count }} сотрудников</div>
                                    {% endif %}
                                    
                                    <!-- Shifts within timeslot -->
                                    {% if timeslot.scheduled_shifts %}
                                        <div class="timeslot-shifts">
                                            {% for shift in timeslot.scheduled_shifts %}
                                                {% set shift_class = "shift-item" %}
                                                {% if shift.status == "completed" %}
                                                    {% set shift_class = shift_class + " shift-completed-positive" %}
                                                {% elif shift.status == "active" %}
                                                    {% set shift_class = shift_class + " shift-active-positive" %}
                                                {% elif shift.status == "planned" %}
                                                    {% set shift_class = shift_class + " shift-planned" %}
                                                {% else %}
                                                    {% set shift_class = shift_class + " shift-" + shift.status %}
                                                {% endif %}
                                                <div class="{{ shift_class }}" 
                                                     data-shift-id="{{ shift.id }}"
                                                     onclick="showShiftDetails('{{ shift.id }}')">
                                                    <div class="shift-time">{{ shift.start_time }} - {{ shift.end_time }}</div>
                                                    <div class="shift-employee">{{ shift.user_name }}</div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Occupancy Indicator -->
                                    <div class="timeslot-occupancy" 
                                         data-timeslot-id="{{ timeslot.id }}"
                                         data-object-id="{{ timeslot.object_id }}"
                                         data-max-employees="{{ timeslot.max_employees or 1 }}"
                                         data-planned-employees="0">
                                        <span class="occupancy-text">0/{{ timeslot.max_employees or 1 }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>


<!-- Calendar JavaScript -->
<script>
// Calendar navigation
function navigateCalendar(direction) {
    const currentDate = new Date('{{ current_date }}');
    const newDate = new Date(currentDate);
    
    if (direction === 'prev') {
        newDate.setMonth(newDate.getMonth() - 1);
    } else {
        newDate.setMonth(newDate.getMonth() + 1);
    }
    
    // Reload calendar with new date
    loadCalendar(newDate);
}

function goToToday() {
    const today = new Date();
    loadCalendar(today);
}


function loadCalendar(date) {
    const params = new URLSearchParams(window.location.search);
    params.set('year', date.getFullYear());
    params.set('month', date.getMonth() + 1);
    window.location.search = params.toString();
}

// Shift and timeslot details
function showShiftDetails(shiftId) {
    // This will be implemented by the parent template
    if (typeof window.showShiftDetails === 'function') {
        window.showShiftDetails(shiftId);
    }
}

function showTimeslotDetails(timeslotId) {
    // This will be implemented by the parent template
    if (typeof window.showTimeslotDetails === 'function') {
        window.showTimeslotDetails(timeslotId);
    }
}

</script>
