<!-- Shared Calendar Grid Component -->
<div class="calendar-wrapper">
    <!-- Фиксированная верхняя часть -->
    <div class="calendar-header-fixed">
        <div class="calendar-legend mb-2" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#e3f2fd; border:1px solid #2196f3;"></span>
                <small>Запланированная смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#fff3e0; border:1px solid #ff9800;"></span>
                <small>Активная смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#c8e6c9; border:2px solid #2e7d32;"></span>
                <small>Завершённая смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#f3e5f5; border:1px solid #9c27b0;"></span>
                <small>Свободный тайм‑слот</small>
            </div>
        </div>
        <div class="calendar-navigation">
            <div class="nav-group">
                <!-- Новый красивый переключатель месяцев -->
                <div class="month-selector">
                    <div class="month-picker">
                        <div class="month-display" id="monthDisplay">
                            <span class="month-name" id="monthName">{{ calendar_title }}</span>
                            <i class="bi bi-chevron-down dropdown-icon"></i>
                        </div>
                        <div class="month-dropdown" id="monthDropdown">
                            <div class="dropdown-content">
                                <div class="year-selector">
                                    <button type="button" class="year-btn" onclick="changeYear(-1)">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <span class="year-display" id="yearDisplay">2025</span>
                                    <button type="button" class="year-btn" onclick="changeYear(1)">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                                <div class="months-grid" id="monthsGrid">
                                    <div class="month-option" data-month="1">Янв</div>
                                    <div class="month-option" data-month="2">Фев</div>
                                    <div class="month-option" data-month="3">Мар</div>
                                    <div class="month-option" data-month="4">Апр</div>
                                    <div class="month-option" data-month="5">Май</div>
                                    <div class="month-option" data-month="6">Июн</div>
                                    <div class="month-option" data-month="7">Июл</div>
                                    <div class="month-option" data-month="8">Авг</div>
                                    <div class="month-option" data-month="9">Сен</div>
                                    <div class="month-option" data-month="10">Окт</div>
                                    <div class="month-option" data-month="11">Ноя</div>
                                    <div class="month-option" data-month="12">Дек</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-actions">
                {% if objects and objects|length > 1 %}
                <div class="object-filter me-3">
                    <script>console.log('Object filter HTML rendered, objects count:', {{ objects|length }});</script>
                    <select class="form-select form-select-sm" id="objectFilter" style="min-width: 200px;">
                        <option value="">Все объекты</option>
                        {% for obj in objects %}
                        <option value="{{ obj.id }}" {% if selected_object_id and selected_object_id == obj.id %}selected{% endif %}>
                            {{ obj.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% else %}
                <script>console.log('Object filter not shown - objects count:', {{ objects|length if objects else 0 }});</script>
                {% endif %}
                
                {% if show_today_button %}
                <button type="button" class="btn btn-primary btn-sm" onclick="goToToday()">
                    <i class="bi bi-calendar-today"></i> Сегодня
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Заголовки дней недели (фиксированные) -->
        <div class="calendar-day-headers">
            <div class="calendar-day-header">Пн</div>
            <div class="calendar-day-header">Вт</div>
            <div class="calendar-day-header">Ср</div>
            <div class="calendar-day-header">Чт</div>
            <div class="calendar-day-header">Пт</div>
            <div class="calendar-day-header">Сб</div>
            <div class="calendar-day-header">Вс</div>
        </div>
    </div>

    <!-- Скроллируемая часть с днями календаря -->
    <div class="calendar-scrollable">
        <div class="calendar-grid">
            <!-- Calendar days will be created by JavaScript -->
        </div>
    </div>
</div>


<!-- Calendar JavaScript -->
<script>
console.log('Shared calendar grid script loading...');

// Calendar navigation
function navigateCalendar(direction) {
    const currentDate = new Date('{{ current_date }}');
    const newDate = new Date(currentDate);
    
    if (direction === 'prev') {
        newDate.setMonth(newDate.getMonth() - 1);
    } else {
        newDate.setMonth(newDate.getMonth() + 1);
    }
    
    // Reload calendar with new date
    loadCalendar(newDate);
}

function goToToday() {
    const today = new Date();
    loadCalendar(today);
}

function filterByObject() {
    console.log('filterByObject called');
    const objectSelect = document.getElementById('objectFilter');
    console.log('objectSelect found:', !!objectSelect);
    
    const selectedObjectId = objectSelect ? objectSelect.value : '';
    console.log('selectedObjectId:', selectedObjectId);
    
    // Получаем текущие параметры из URL или создаем новые
    let currentSearch = window.location.search;
    console.log('current search string:', currentSearch);
    
    const params = new URLSearchParams(currentSearch);
    console.log('current params:', params.toString());
    
    if (selectedObjectId) {
        params.set('object_id', selectedObjectId);
    } else {
        params.delete('object_id');
    }
    
    const newSearch = params.toString();
    console.log('new params:', newSearch);
    
    // Формируем новый URL
    const newUrl = newSearch ? `${window.location.pathname}?${newSearch}` : window.location.pathname;
    console.log('new URL:', newUrl);
    
    window.location.href = newUrl;
}

// Universal Calendar Integration
function renderCalendarGrid(calendarData) {
    console.log('renderCalendarGrid called with data:', calendarData);
    
    if (!calendarData) {
        console.log('No calendar data provided');
        return;
    }
    
    try {
        console.log('About to call createCalendarGrid');
        // Создаем календарную сетку
        createCalendarGrid(calendarData);
        
        console.log('About to call updateCalendarStatistics');
        // Обновляем статистику
        updateCalendarStatistics(calendarData);
        
        console.log('About to call updateCalendarDisplay');
        // Обновляем отображение смен и тайм-слотов
        updateCalendarDisplay(calendarData);
        
        console.log('renderCalendarGrid completed');
    } catch (error) {
        console.error('Error in renderCalendarGrid:', error);
    }
}

function createCalendarGrid(calendarData) {
    console.log('createCalendarGrid called');
    
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!calendarGrid) {
        console.error('Calendar grid not found');
        return;
    }
    
    // Удаляем существующие дни (оставляем только заголовки)
    const existingDays = calendarGrid.querySelectorAll('.calendar-day');
    existingDays.forEach(day => day.remove());
    
    // Получаем текущую дату из URL параметров или используем сегодняшнюю дату
    const urlParams = new URLSearchParams(window.location.search);
    const yearParam = urlParams.get('year');
    const monthParam = urlParams.get('month');
    
    const today = new Date();
    const year = yearParam ? parseInt(yearParam) : today.getFullYear();
    const month = monthParam ? parseInt(monthParam) - 1 : today.getMonth(); // monthParam 1-based, month 0-based
    
    // Создаем сетку для 3 месяцев: предыдущий, текущий, следующий
    const months = [
        { year: year, month: month - 1, label: 'prev' },    // Предыдущий месяц
        { year: year, month: month, label: 'current' },      // Текущий месяц
        { year: year, month: month + 1, label: 'next' }     // Следующий месяц
    ];
    
    // Корректируем год для месяцев < 0 или > 11
    months.forEach(m => {
        if (m.month < 0) {
            m.month = 11;
            m.year--;
        } else if (m.month > 11) {
            m.month = 0;
            m.year++;
        }
    });
    
    // Создаем дни для каждого месяца
    months.forEach(monthData => {
        const firstDay = new Date(monthData.year, monthData.month, 1);
        const lastDay = new Date(monthData.year, monthData.month + 1, 0);
        
        // Находим понедельник первой недели месяца
        const firstMonday = new Date(firstDay);
        firstMonday.setDate(firstDay.getDate() - firstDay.getDay() + 1);
        
        // Находим воскресенье последней недели месяца
        const lastSunday = new Date(lastDay);
        lastSunday.setDate(lastDay.getDate() + (6 - lastDay.getDay()));
        
        // Создаем дни для этого месяца
        let workingDate = new Date(firstMonday);
        
        while (workingDate <= lastSunday) {
            const dateStr = workingDate.toISOString().split('T')[0];
            const dayNumber = workingDate.getDate();
            const isOtherMonth = workingDate.getMonth() !== monthData.month;
            const isToday = dateStr === today.toISOString().split('T')[0];
            
            const dayElement = createDayElement(dateStr, dayNumber, isOtherMonth, isToday);
            calendarGrid.appendChild(dayElement);
            
            workingDate.setDate(workingDate.getDate() + 1);
        }
    });
    
    console.log(`Created multi-month calendar grid with ${calendarGrid.querySelectorAll('.calendar-day').length} days`);
}

function createDayElement(dateStr, day, isOtherMonth, isToday) {
    const dayElement = document.createElement('div');
    dayElement.className = `calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
    dayElement.setAttribute('data-date', dateStr);
    dayElement.setAttribute('data-day', day);
    
    dayElement.innerHTML = `
        <div class="day-number">${day}</div>
        <div class="day-content"></div>
    `;
    
    return dayElement;
}

function updateCalendarStatistics(calendarData) {
    console.log('updateCalendarStatistics called');
    try {
        // Обновляем статистику в шапке календаря
        const statsElement = document.getElementById('calendar-stats');
        console.log('statsElement found:', statsElement);
        if (statsElement && calendarData.stats) {
            console.log('Updating stats with data:', calendarData.stats);
            statsElement.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Тайм-слоты:</span>
                    <span class="stat-value">${calendarData.stats.total_timeslots || calendarData.total_timeslots || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Смены:</span>
                    <span class="stat-value">${calendarData.stats.total_shifts || calendarData.total_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Запланировано:</span>
                    <span class="stat-value">${calendarData.stats.planned_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Активные:</span>
                    <span class="stat-value">${calendarData.stats.active_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Завершено:</span>
                    <span class="stat-value">${calendarData.stats.completed_shifts || 0}</span>
                </div>
            `;
        } else {
            console.log('No stats element or stats data');
        }
        console.log('updateCalendarStatistics completed successfully');
    } catch (error) {
        console.error('Error in updateCalendarStatistics:', error);
    }
}

function updateCalendarDisplay(calendarData) {
    console.log('updateCalendarDisplay called - START');
    console.log('calendarData:', calendarData);
    console.log('calendarData type:', typeof calendarData);
    try {
        console.log('Updating calendar display with:', calendarData);
        console.log('timeslotsByDate keys:', Object.keys(calendarData.timeslotsByDate || {}));
        console.log('shiftsByDate keys:', Object.keys(calendarData.shiftsByDate || {}));
        
        // Обновляем отображение для каждого дня
        Object.keys(calendarData.timeslotsByDate || {}).forEach(date => {
            console.log(`Looking for day element with date: ${date}`);
            const dayElement = document.querySelector(`[data-date="${date}"]`);
            console.log(`Found day element for ${date}:`, dayElement);
            if (dayElement) {
                updateDayDisplay(dayElement, date, calendarData);
            } else {
                console.log(`No day element found for date: ${date}`);
            }
        });
        
        Object.keys(calendarData.shiftsByDate || {}).forEach(date => {
            console.log(`Looking for day element with date: ${date}`);
            const dayElement = document.querySelector(`[data-date="${date}"]`);
            console.log(`Found day element for ${date}:`, dayElement);
            if (dayElement) {
                updateDayDisplay(dayElement, date, calendarData);
            } else {
                console.log(`No day element found for date: ${date}`);
            }
        });
        
        console.log('updateCalendarDisplay completed successfully');
    } catch (error) {
        console.error('Error in updateCalendarDisplay:', error);
    }
}

function updateDayDisplay(dayElement, date, calendarData) {
    console.log(`Updating day display for ${date}`);
    const dayContent = dayElement.querySelector('.day-content');
    console.log(`Day content element:`, dayContent);
    if (!dayContent) {
        console.log(`No day-content found for date ${date}`);
        return;
    }
    
    // Очищаем существующий контент
    dayContent.innerHTML = '';
    console.log(`Cleared day content for ${date}`);
    
    // Добавляем тайм-слоты
    const timeslots = calendarData.timeslotsByDate[date] || [];
    console.log(`Adding ${timeslots.length} timeslots for ${date}`);
    timeslots.forEach(timeslot => {
        const timeslotElement = createTimeslotElement(timeslot);
        if (timeslotElement) {  // Проверяем, что элемент не null (не полностью занятый тайм-слот)
            dayContent.appendChild(timeslotElement);
            console.log(`Added timeslot ${timeslot.id} to ${date}`);
        } else {
            console.log(`Skipped fully occupied timeslot ${timeslot.id} for ${date}`);
        }
    });
    
    // Добавляем смены
    const shifts = calendarData.shiftsByDate[date] || [];
    console.log(`Adding ${shifts.length} shifts for ${date}`);
    shifts.forEach(shift => {
        const shiftElement = createShiftElement(shift);
        if (shiftElement) {  // Проверяем, что элемент не null (не отмененная смена)
            dayContent.appendChild(shiftElement);
            console.log(`Added shift ${shift.id} to ${date}`);
        } else {
            console.log(`Skipped cancelled shift ${shift.id} for ${date}`);
        }
    });
}

function createTimeslotElement(timeslot) {
    // Определяем занятость тайм-слота
    const currentEmployees = timeslot.current_employees || 0;
    const maxEmployees = timeslot.max_employees || 1;
    
    // Не отображаем полностью занятые тайм-слоты
    if (currentEmployees >= maxEmployees) {
        console.log(`Skipping fully occupied timeslot ${timeslot.id} (${currentEmployees}/${maxEmployees})`);
        return null;
    }
    
    const div = document.createElement('div');
    div.className = 'timeslot-item timeslot-free';
    div.setAttribute('data-timeslot-id', timeslot.id);
    div.onclick = () => showTimeslotDetails(timeslot.id);
    
    const occupancyBadge = `<div class="timeslot-badge">${currentEmployees}/${maxEmployees}</div>`;
    
    div.innerHTML = `
        <div class="timeslot-time">${timeslot.start_time} - ${timeslot.end_time}</div>
        <div class="timeslot-object">${timeslot.object_name}</div>
        <div class="timeslot-rate">${timeslot.hourly_rate}₽/ч</div>
        ${occupancyBadge}
    `;
    
    return div;
}

function createShiftElement(shift) {
    // Не отображаем отмененные смены
    if (shift.status === 'cancelled') {
        console.log(`Skipping cancelled shift ${shift.id}`);
        return null;
    }
    
    const div = document.createElement('div');
    div.className = `shift-item shift-${shift.shift_type}`;
    div.setAttribute('data-shift-id', shift.id);
    div.onclick = () => showShiftDetails(shift.id);
    
    // Определяем время начала и окончания
    let startTime = '';
    let endTime = '';
    
    if (shift.shift_type === 'planned') {
        // Для запланированных смен используем planned_start и planned_end
        startTime = shift.planned_start ? shift.planned_start.split('T')[1].substring(0, 5) : '';
        endTime = shift.planned_end ? shift.planned_end.split('T')[1].substring(0, 5) : '';
    } else {
        // Для активных/завершенных смен используем start_time и end_time
        startTime = shift.start_time ? shift.start_time.split('T')[1].substring(0, 5) : '';
        endTime = shift.end_time ? shift.end_time.split('T')[1].substring(0, 5) : '';
    }
    
    // Добавляем стикер для запланированных смен
    const sticker = shift.shift_type === 'planned' ? '<div class="shift-sticker">1/1</div>' : '';
    
    div.innerHTML = `
        <div class="shift-time">${startTime} - ${endTime}</div>
        <div class="shift-employee">${shift.user_name}</div>
        <div class="shift-object">${shift.object_name}</div>
        ${sticker}
    `;
    
    return div;
}

// Делаем функцию доступной глобально
window.renderCalendarGrid = renderCalendarGrid;

// Month Selector JavaScript
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;

// Инициализация переключателя месяцев
function initMonthSelector() {
    const monthDisplay = document.getElementById('monthDisplay');
    const monthDropdown = document.getElementById('monthDropdown');
    const yearDisplay = document.getElementById('yearDisplay');
    const monthOptions = document.querySelectorAll('.month-option');
    
    // Получаем текущие значения из URL
    const urlParams = new URLSearchParams(window.location.search);
    const yearParam = urlParams.get('year');
    const monthParam = urlParams.get('month');
    
    if (yearParam) currentYear = parseInt(yearParam);
    if (monthParam) currentMonth = parseInt(monthParam);
    
    // Обновляем отображение
    updateMonthDisplay();
    
    // Обработчики событий
    monthDisplay.addEventListener('click', toggleMonthDropdown);
    
    // Закрытие при клике вне элемента
    document.addEventListener('click', (e) => {
        if (!monthDisplay.contains(e.target) && !monthDropdown.contains(e.target)) {
            closeMonthDropdown();
        }
    });
    
    // Обработчики для месяцев
    monthOptions.forEach(option => {
        option.addEventListener('click', () => {
            const month = parseInt(option.dataset.month);
            selectMonth(month);
        });
    });
}

function toggleMonthDropdown() {
    const monthDisplay = document.getElementById('monthDisplay');
    const monthDropdown = document.getElementById('monthDropdown');
    
    monthDisplay.classList.toggle('active');
    monthDropdown.classList.toggle('show');
    
    if (monthDropdown.classList.contains('show')) {
        updateMonthOptions();
    }
}

function closeMonthDropdown() {
    const monthDisplay = document.getElementById('monthDisplay');
    const monthDropdown = document.getElementById('monthDropdown');
    
    monthDisplay.classList.remove('active');
    monthDropdown.classList.remove('show');
}

function updateMonthDisplay() {
    const monthName = document.getElementById('monthName');
    const yearDisplay = document.getElementById('yearDisplay');
    
    const monthNames = [
        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
    ];
    
    monthName.textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;
    yearDisplay.textContent = currentYear;
}

function updateMonthOptions() {
    const monthOptions = document.querySelectorAll('.month-option');
    
    monthOptions.forEach(option => {
        const month = parseInt(option.dataset.month);
        option.classList.toggle('active', month === currentMonth);
    });
}

function changeYear(delta) {
    currentYear += delta;
    updateMonthDisplay();
    updateMonthOptions();
}

function selectMonth(month) {
    currentMonth = month;
    closeMonthDropdown();
    updateMonthDisplay();
    updateMonthOptions();
    
    // Перезагружаем календарь
    const newDate = new Date(currentYear, currentMonth - 1, 1);
    loadCalendar(newDate);
}

// Инициализация при загрузке DOM
document.addEventListener('DOMContentLoaded', function() {
    initMonthSelector();
});

// Проверяем что функция доступна после загрузки и привязываем события
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, filterByObject available:', typeof window.filterByObject === 'function');
    
    // Привязываем событие к фильтру объектов
    const objectFilter = document.getElementById('objectFilter');
    if (objectFilter) {
        console.log('Object filter element found, binding change event');
        objectFilter.addEventListener('change', function() {
            console.log('Object filter change event triggered, value:', this.value);
            if (typeof window.filterByObject === 'function') {
                window.filterByObject();
            } else {
                console.error('filterByObject function not available');
            }
        });
    } else {
        console.log('Object filter element not found');
    }
});

function loadCalendar(date) {
    const params = new URLSearchParams(window.location.search);
    params.set('year', date.getFullYear());
    params.set('month', date.getMonth() + 1);
    
    // Сохраняем фильтр объекта при навигации
    const objectSelect = document.getElementById('objectFilter');
    if (objectSelect && objectSelect.value) {
        params.set('object_id', objectSelect.value);
    }
    
    window.location.search = params.toString();
}

// Shift and timeslot details
function showShiftDetails(shiftId) {
    console.log('Shift clicked:', shiftId);
    if (shiftId.toString().startsWith('schedule_')) {
        const scheduleId = shiftId.toString().replace('schedule_', '');
        window.location.href = `/manager/shifts/${scheduleId}?shift_type=schedule`;
    } else {
        window.location.href = `/manager/shifts/${shiftId}`;
    }
}

function showTimeslotDetails(timeslotId) {
    console.log('Timeslot clicked:', timeslotId);
    window.location.href = `/manager/timeslots/${timeslotId}`;
}

</script>
