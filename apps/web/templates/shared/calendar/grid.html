<!-- Shared Calendar Grid Component -->
<div class="calendar-container">
    <div class="calendar-header">
        <div class="calendar-legend mb-2" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#e3f2fd; border:1px solid #2196f3;"></span>
                <small>Запланированная смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#fff3e0; border:1px solid #ff9800;"></span>
                <small>Активная смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#c8e6c9; border:2px solid #2e7d32;"></span>
                <small>Завершённая смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#f3e5f5; border:1px solid #9c27b0;"></span>
                <small>Свободный тайм‑слот</small>
            </div>
        </div>
        <div class="calendar-navigation">
            <div class="nav-group">
                <button type="button" class="btn btn-primary btn-sm calendar-nav-btn" onclick="navigateCalendar('prev')">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <h4 class="calendar-title mb-0">{{ calendar_title }}</h4>
                <button type="button" class="btn btn-primary btn-sm calendar-nav-btn" onclick="navigateCalendar('next')">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            <div class="nav-actions">
                {% if objects and objects|length > 1 %}
                <div class="object-filter me-3">
                    <script>console.log('Object filter HTML rendered, objects count:', {{ objects|length }});</script>
                    <select class="form-select form-select-sm" id="objectFilter" style="min-width: 200px;">
                        <option value="">Все объекты</option>
                        {% for obj in objects %}
                        <option value="{{ obj.id }}" {% if selected_object_id and selected_object_id == obj.id %}selected{% endif %}>
                            {{ obj.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% else %}
                <script>console.log('Object filter not shown - objects count:', {{ objects|length if objects else 0 }});</script>
                {% endif %}
                
                {% if show_today_button %}
                <button type="button" class="btn btn-primary btn-sm" onclick="goToToday()">
                    <i class="bi bi-calendar-today"></i> Сегодня
                </button>
                {% endif %}
            </div>
        </div>
    </div>


    <div class="calendar-grid">
        <!-- Day headers -->
        <div class="calendar-day-header">Пн</div>
        <div class="calendar-day-header">Вт</div>
        <div class="calendar-day-header">Ср</div>
        <div class="calendar-day-header">Чт</div>
        <div class="calendar-day-header">Пт</div>
        <div class="calendar-day-header">Сб</div>
        <div class="calendar-day-header">Вс</div>

        <!-- Calendar days -->
        {% for week in calendar_weeks %}
            {% for day in week %}
                <div class="calendar-day {% if day.is_other_month %}other-month{% endif %} {% if day.is_today %}today{% endif %}" 
                     data-date="{{ day.date }}" 
                     data-day="{{ day.day }}">
                    <div class="day-number">{{ day.day }}</div>
                    
                    <!-- Day content -->
                    <div class="day-content">
                        {% if day.shifts %}
                            {% for shift in day.shifts %}
                                {% set shift_class = "shift-item" %}
                                {% if shift.status == "completed" %}
                                    {% set shift_class = shift_class + " shift-completed-positive" %}
                                {% elif shift.status == "active" %}
                                    {% set shift_class = shift_class + " shift-active-positive" %}
                                {% elif shift.status == "planned" %}
                                    {% set shift_class = shift_class + " shift-planned" %}
                                {% else %}
                                    {% set shift_class = shift_class + " shift-" + shift.status %}
                                {% endif %}
                                <div class="{{ shift_class }}" 
                                     data-shift-id="{{ shift.id }}"
                                     onclick="showShiftDetails('{{ shift.id }}')">
                                    <div class="shift-time">{{ shift.start_time }} - {{ shift.end_time }}</div>
                                    <div class="shift-employee">{{ shift.employee_name }}</div>
                                    {% if shift.object_name %}
                                    <div class="shift-object">{{ shift.object_name }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endif %}
                        
                        {% if day.timeslots %}
                            {% for timeslot in day.timeslots %}
                                {% set timeslot_class = "timeslot-item" %}
                                {% if timeslot.status == "available" %}
                                    {% set timeslot_class = timeslot_class + " timeslot-free" %}
                                {% else %}
                                    {% set timeslot_class = timeslot_class + " timeslot-" + timeslot.status %}
                                {% endif %}
                                <div class="{{ timeslot_class }}" 
                                     data-timeslot-id="{{ timeslot.id }}"
                                     data-object-id="{{ timeslot.object_id }}"
                                     data-max-employees="{{ timeslot.max_employees or 1 }}"
                                     onclick="showTimeslotDetails({{ timeslot.id }})">
                                    <div class="timeslot-time">{{ timeslot.start_time }} - {{ timeslot.end_time }}</div>
                                    <div class="timeslot-object">{{ timeslot.object_name }}</div>
                                    {% if timeslot.employee_count %}
                                    <div class="timeslot-employees">{{ timeslot.employee_count }} сотрудников</div>
                                    {% endif %}
                                    
                                    <!-- Shifts within timeslot -->
                                    {% if timeslot.scheduled_shifts %}
                                        <div class="timeslot-shifts">
                                            {% for shift in timeslot.scheduled_shifts %}
                                                {% set shift_class = "shift-item" %}
                                                {% if shift.status == "completed" %}
                                                    {% set shift_class = shift_class + " shift-completed-positive" %}
                                                {% elif shift.status == "active" %}
                                                    {% set shift_class = shift_class + " shift-active-positive" %}
                                                {% elif shift.status == "planned" %}
                                                    {% set shift_class = shift_class + " shift-planned" %}
                                                {% else %}
                                                    {% set shift_class = shift_class + " shift-" + shift.status %}
                                                {% endif %}
                                                <div class="{{ shift_class }}" 
                                                     data-shift-id="{{ shift.id }}"
                                                     onclick="showShiftDetails('{{ shift.id }}')">
                                                    <div class="shift-time">{{ shift.start_time }} - {{ shift.end_time }}</div>
                                                    <div class="shift-employee">{{ shift.user_name }}</div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Occupancy Indicator -->
                                    <div class="timeslot-occupancy" 
                                         data-timeslot-id="{{ timeslot.id }}"
                                         data-object-id="{{ timeslot.object_id }}"
                                         data-max-employees="{{ timeslot.max_employees or 1 }}"
                                         data-planned-employees="0">
                                        <span class="occupancy-text">0/{{ timeslot.max_employees or 1 }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>


<!-- Calendar JavaScript -->
<script>
console.log('Shared calendar grid script loading...');

// Calendar navigation
function navigateCalendar(direction) {
    const currentDate = new Date('{{ current_date }}');
    const newDate = new Date(currentDate);
    
    if (direction === 'prev') {
        newDate.setMonth(newDate.getMonth() - 1);
    } else {
        newDate.setMonth(newDate.getMonth() + 1);
    }
    
    // Reload calendar with new date
    loadCalendar(newDate);
}

function goToToday() {
    const today = new Date();
    loadCalendar(today);
}

function filterByObject() {
    console.log('filterByObject called');
    const objectSelect = document.getElementById('objectFilter');
    console.log('objectSelect found:', !!objectSelect);
    
    const selectedObjectId = objectSelect ? objectSelect.value : '';
    console.log('selectedObjectId:', selectedObjectId);
    
    // Получаем текущие параметры из URL или создаем новые
    let currentSearch = window.location.search;
    console.log('current search string:', currentSearch);
    
    const params = new URLSearchParams(currentSearch);
    console.log('current params:', params.toString());
    
    if (selectedObjectId) {
        params.set('object_id', selectedObjectId);
    } else {
        params.delete('object_id');
    }
    
    const newSearch = params.toString();
    console.log('new params:', newSearch);
    
    // Формируем новый URL
    const newUrl = newSearch ? `${window.location.pathname}?${newSearch}` : window.location.pathname;
    console.log('new URL:', newUrl);
    
    window.location.href = newUrl;
}

// Universal Calendar Integration
function renderCalendarGrid(calendarData) {
    console.log('renderCalendarGrid called with data:', calendarData);
    
    if (!calendarData) {
        console.log('No calendar data provided');
        return;
    }
    
    try {
        console.log('About to call updateCalendarStatistics');
        // Обновляем статистику
        updateCalendarStatistics(calendarData);
        
        console.log('About to call updateCalendarDisplay');
        // Обновляем отображение смен и тайм-слотов
        updateCalendarDisplay(calendarData);
        
        console.log('renderCalendarGrid completed');
    } catch (error) {
        console.error('Error in renderCalendarGrid:', error);
    }
}

function updateCalendarStatistics(calendarData) {
    console.log('updateCalendarStatistics called');
    try {
        // Обновляем статистику в шапке календаря
        const statsElement = document.getElementById('calendar-stats');
        console.log('statsElement found:', statsElement);
        if (statsElement && calendarData.stats) {
            console.log('Updating stats with data:', calendarData.stats);
            statsElement.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Тайм-слоты:</span>
                    <span class="stat-value">${calendarData.stats.total_timeslots || calendarData.total_timeslots || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Смены:</span>
                    <span class="stat-value">${calendarData.stats.total_shifts || calendarData.total_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Запланировано:</span>
                    <span class="stat-value">${calendarData.stats.planned_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Активные:</span>
                    <span class="stat-value">${calendarData.stats.active_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Завершено:</span>
                    <span class="stat-value">${calendarData.stats.completed_shifts || 0}</span>
                </div>
            `;
        } else {
            console.log('No stats element or stats data');
        }
        console.log('updateCalendarStatistics completed successfully');
    } catch (error) {
        console.error('Error in updateCalendarStatistics:', error);
    }
}

function updateCalendarDisplay(calendarData) {
    console.log('updateCalendarDisplay called');
    try {
        console.log('Updating calendar display with:', calendarData);
        console.log('timeslotsByDate keys:', Object.keys(calendarData.timeslotsByDate || {}));
        console.log('shiftsByDate keys:', Object.keys(calendarData.shiftsByDate || {}));
        
        // Обновляем отображение для каждого дня
        Object.keys(calendarData.timeslotsByDate || {}).forEach(date => {
            console.log(`Looking for day element with date: ${date}`);
            const dayElement = document.querySelector(`[data-date="${date}"]`);
            console.log(`Found day element for ${date}:`, dayElement);
            if (dayElement) {
                updateDayDisplay(dayElement, date, calendarData);
            } else {
                console.log(`No day element found for date: ${date}`);
            }
        });
        
        Object.keys(calendarData.shiftsByDate || {}).forEach(date => {
            console.log(`Looking for day element with date: ${date}`);
            const dayElement = document.querySelector(`[data-date="${date}"]`);
            console.log(`Found day element for ${date}:`, dayElement);
            if (dayElement) {
                updateDayDisplay(dayElement, date, calendarData);
            } else {
                console.log(`No day element found for date: ${date}`);
            }
        });
        
        console.log('updateCalendarDisplay completed successfully');
    } catch (error) {
        console.error('Error in updateCalendarDisplay:', error);
    }
}

function updateDayDisplay(dayElement, date, calendarData) {
    console.log(`Updating day display for ${date}`);
    const dayContent = dayElement.querySelector('.day-content');
    console.log(`Day content element:`, dayContent);
    if (!dayContent) {
        console.log(`No day-content found for date ${date}`);
        return;
    }
    
    // Очищаем существующий контент
    dayContent.innerHTML = '';
    console.log(`Cleared day content for ${date}`);
    
    // Добавляем тайм-слоты
    const timeslots = calendarData.timeslotsByDate[date] || [];
    console.log(`Adding ${timeslots.length} timeslots for ${date}`);
    timeslots.forEach(timeslot => {
        const timeslotElement = createTimeslotElement(timeslot);
        dayContent.appendChild(timeslotElement);
        console.log(`Added timeslot ${timeslot.id} to ${date}`);
    });
    
    // Добавляем смены
    const shifts = calendarData.shiftsByDate[date] || [];
    console.log(`Adding ${shifts.length} shifts for ${date}`);
    shifts.forEach(shift => {
        const shiftElement = createShiftElement(shift);
        dayContent.appendChild(shiftElement);
        console.log(`Added shift ${shift.id} to ${date}`);
    });
}

function createTimeslotElement(timeslot) {
    const div = document.createElement('div');
    div.className = 'timeslot-item timeslot-free';
    div.setAttribute('data-timeslot-id', timeslot.id);
    div.onclick = () => showTimeslotDetails(timeslot.id);
    
    div.innerHTML = `
        <div class="timeslot-time">${timeslot.start_time} - ${timeslot.end_time}</div>
        <div class="timeslot-object">${timeslot.object_name}</div>
        <div class="timeslot-rate">${timeslot.hourly_rate}₽/ч</div>
    `;
    
    return div;
}

function createShiftElement(shift) {
    const div = document.createElement('div');
    div.className = `shift-item shift-${shift.shift_type}`;
    div.setAttribute('data-shift-id', shift.id);
    div.onclick = () => showShiftDetails(shift.id);
    
    const startTime = shift.start_time ? shift.start_time.split('T')[1].substring(0, 5) : '';
    const endTime = shift.end_time ? shift.end_time.split('T')[1].substring(0, 5) : '';
    
    div.innerHTML = `
        <div class="shift-time">${startTime} - ${endTime}</div>
        <div class="shift-employee">${shift.user_name}</div>
        <div class="shift-object">${shift.object_name}</div>
    `;
    
    return div;
}

// Делаем функцию доступной глобально
window.renderCalendarGrid = renderCalendarGrid;

// Проверяем что функция доступна после загрузки и привязываем события
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, filterByObject available:', typeof window.filterByObject === 'function');
    
    // Привязываем событие к фильтру объектов
    const objectFilter = document.getElementById('objectFilter');
    if (objectFilter) {
        console.log('Object filter element found, binding change event');
        objectFilter.addEventListener('change', function() {
            console.log('Object filter change event triggered, value:', this.value);
            if (typeof window.filterByObject === 'function') {
                window.filterByObject();
            } else {
                console.error('filterByObject function not available');
            }
        });
    } else {
        console.log('Object filter element not found');
    }
});

function loadCalendar(date) {
    const params = new URLSearchParams(window.location.search);
    params.set('year', date.getFullYear());
    params.set('month', date.getMonth() + 1);
    
    // Сохраняем фильтр объекта при навигации
    const objectSelect = document.getElementById('objectFilter');
    if (objectSelect && objectSelect.value) {
        params.set('object_id', objectSelect.value);
    }
    
    window.location.search = params.toString();
}

// Shift and timeslot details
function showShiftDetails(shiftId) {
    // This will be implemented by the parent template
    if (typeof window.showShiftDetails === 'function') {
        window.showShiftDetails(shiftId);
    }
}

function showTimeslotDetails(timeslotId) {
    // This will be implemented by the parent template
    if (typeof window.showTimeslotDetails === 'function') {
        window.showTimeslotDetails(timeslotId);
    }
}

</script>
