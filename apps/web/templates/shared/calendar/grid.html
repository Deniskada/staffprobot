<!-- Shared Calendar Grid Component -->
<div class="calendar-container">
    <div class="calendar-header">
        <div class="calendar-legend mb-2" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#e3f2fd; border:1px solid #2196f3;"></span>
                <small>Запланированная смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#fff3e0; border:1px solid #ff9800;"></span>
                <small>Активная смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#c8e6c9; border:2px solid #2e7d32;"></span>
                <small>Завершённая смена</small>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <span style="display:inline-block; width:14px; height:14px; border-radius:3px; background:#f3e5f5; border:1px solid #9c27b0;"></span>
                <small>Свободный тайм‑слот</small>
            </div>
        </div>
        <div class="calendar-navigation">
            <div class="nav-group">
                <button type="button" class="btn btn-primary btn-sm calendar-nav-btn" onclick="navigateCalendar('prev')">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <h4 class="calendar-title mb-0">{{ calendar_title }}</h4>
                <button type="button" class="btn btn-primary btn-sm calendar-nav-btn" onclick="navigateCalendar('next')">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            <div class="nav-actions">
                {% if objects and objects|length > 1 %}
                <div class="object-filter me-3">
                    <script>console.log('Object filter HTML rendered, objects count:', {{ objects|length }});</script>
                    <select class="form-select form-select-sm" id="objectFilter" style="min-width: 200px;">
                        <option value="">Все объекты</option>
                        {% for obj in objects %}
                        <option value="{{ obj.id }}" {% if selected_object_id and selected_object_id == obj.id %}selected{% endif %}>
                            {{ obj.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% else %}
                <script>console.log('Object filter not shown - objects count:', {{ objects|length if objects else 0 }});</script>
                {% endif %}
                
                {% if show_today_button %}
                <button type="button" class="btn btn-primary btn-sm" onclick="goToToday()">
                    <i class="bi bi-calendar-today"></i> Сегодня
                </button>
                {% endif %}
            </div>
        </div>
    </div>


    <div class="calendar-grid">
        <!-- Day headers -->
        <div class="calendar-day-header">Пн</div>
        <div class="calendar-day-header">Вт</div>
        <div class="calendar-day-header">Ср</div>
        <div class="calendar-day-header">Чт</div>
        <div class="calendar-day-header">Пт</div>
        <div class="calendar-day-header">Сб</div>
        <div class="calendar-day-header">Вс</div>

        <!-- Calendar days will be created by JavaScript -->
    </div>
</div>


<!-- Calendar JavaScript -->
<script>
console.log('Shared calendar grid script loading...');

// Calendar navigation
function navigateCalendar(direction) {
    const currentDate = new Date('{{ current_date }}');
    const newDate = new Date(currentDate);
    
    if (direction === 'prev') {
        newDate.setMonth(newDate.getMonth() - 1);
    } else {
        newDate.setMonth(newDate.getMonth() + 1);
    }
    
    // Reload calendar with new date
    loadCalendar(newDate);
}

function goToToday() {
    const today = new Date();
    loadCalendar(today);
}

function filterByObject() {
    console.log('filterByObject called');
    const objectSelect = document.getElementById('objectFilter');
    console.log('objectSelect found:', !!objectSelect);
    
    const selectedObjectId = objectSelect ? objectSelect.value : '';
    console.log('selectedObjectId:', selectedObjectId);
    
    // Получаем текущие параметры из URL или создаем новые
    let currentSearch = window.location.search;
    console.log('current search string:', currentSearch);
    
    const params = new URLSearchParams(currentSearch);
    console.log('current params:', params.toString());
    
    if (selectedObjectId) {
        params.set('object_id', selectedObjectId);
    } else {
        params.delete('object_id');
    }
    
    const newSearch = params.toString();
    console.log('new params:', newSearch);
    
    // Формируем новый URL
    const newUrl = newSearch ? `${window.location.pathname}?${newSearch}` : window.location.pathname;
    console.log('new URL:', newUrl);
    
    window.location.href = newUrl;
}

// Universal Calendar Integration
function renderCalendarGrid(calendarData) {
    console.log('renderCalendarGrid called with data:', calendarData);
    
    if (!calendarData) {
        console.log('No calendar data provided');
        return;
    }
    
    try {
        console.log('About to call createCalendarGrid');
        // Создаем календарную сетку
        createCalendarGrid(calendarData);
        
        console.log('About to call updateCalendarStatistics');
        // Обновляем статистику
        updateCalendarStatistics(calendarData);
        
        console.log('About to call updateCalendarDisplay');
        // Обновляем отображение смен и тайм-слотов
        updateCalendarDisplay(calendarData);
        
        console.log('renderCalendarGrid completed');
    } catch (error) {
        console.error('Error in renderCalendarGrid:', error);
    }
}

function createCalendarGrid(calendarData) {
    console.log('createCalendarGrid called');
    
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!calendarGrid) {
        console.error('Calendar grid not found');
        return;
    }
    
    // Удаляем существующие дни (оставляем только заголовки)
    const existingDays = calendarGrid.querySelectorAll('.calendar-day');
    existingDays.forEach(day => day.remove());
    
    // Получаем текущую дату из календарных данных
    const currentDate = new Date(calendarData.date_range.start);
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Создаем календарную сетку как у владельца
    const today = new Date();
    let firstMonday;
    
    if (today.getFullYear() === year && today.getMonth() === month) {
        // Если смотрим текущий месяц - начинаем за 2 недели до текущей
        const currentMonday = new Date(today);
        currentMonday.setDate(today.getDate() - today.getDay() + 1); // Понедельник текущей недели
        firstMonday = new Date(currentMonday);
        firstMonday.setDate(currentMonday.getDate() - 14); // За 2 недели
    } else {
        // Для других месяцев - начинаем с первого понедельника месяца
        const firstDay = new Date(year, month, 1);
        firstMonday = new Date(firstDay);
        firstMonday.setDate(firstDay.getDate() - firstDay.getDay() + 1); // Понедельник первой недели
    }
    
    // Создаем сетку 6x7 (6 недель, 7 дней) - текущая неделя будет 3-й строкой
    const currentDate = new Date(firstMonday);
    
    for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const dayNumber = currentDate.getDate();
            const isOtherMonth = currentDate.getMonth() !== month;
            const isToday = dateStr === today.toISOString().split('T')[0];
            
            const dayElement = createDayElement(dateStr, dayNumber, isOtherMonth, isToday);
            calendarGrid.appendChild(dayElement);
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }
    
    console.log(`Created calendar grid with ${calendarGrid.querySelectorAll('.calendar-day').length} days`);
}

function createDayElement(dateStr, day, isOtherMonth, isToday) {
    const dayElement = document.createElement('div');
    dayElement.className = `calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
    dayElement.setAttribute('data-date', dateStr);
    dayElement.setAttribute('data-day', day);
    
    dayElement.innerHTML = `
        <div class="day-number">${day}</div>
        <div class="day-content"></div>
    `;
    
    return dayElement;
}

function updateCalendarStatistics(calendarData) {
    console.log('updateCalendarStatistics called');
    try {
        // Обновляем статистику в шапке календаря
        const statsElement = document.getElementById('calendar-stats');
        console.log('statsElement found:', statsElement);
        if (statsElement && calendarData.stats) {
            console.log('Updating stats with data:', calendarData.stats);
            statsElement.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Тайм-слоты:</span>
                    <span class="stat-value">${calendarData.stats.total_timeslots || calendarData.total_timeslots || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Смены:</span>
                    <span class="stat-value">${calendarData.stats.total_shifts || calendarData.total_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Запланировано:</span>
                    <span class="stat-value">${calendarData.stats.planned_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Активные:</span>
                    <span class="stat-value">${calendarData.stats.active_shifts || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Завершено:</span>
                    <span class="stat-value">${calendarData.stats.completed_shifts || 0}</span>
                </div>
            `;
        } else {
            console.log('No stats element or stats data');
        }
        console.log('updateCalendarStatistics completed successfully');
    } catch (error) {
        console.error('Error in updateCalendarStatistics:', error);
    }
}

function updateCalendarDisplay(calendarData) {
    console.log('updateCalendarDisplay called - START');
    console.log('calendarData:', calendarData);
    console.log('calendarData type:', typeof calendarData);
    try {
        console.log('Updating calendar display with:', calendarData);
        console.log('timeslotsByDate keys:', Object.keys(calendarData.timeslotsByDate || {}));
        console.log('shiftsByDate keys:', Object.keys(calendarData.shiftsByDate || {}));
        
        // Обновляем отображение для каждого дня
        Object.keys(calendarData.timeslotsByDate || {}).forEach(date => {
            console.log(`Looking for day element with date: ${date}`);
            const dayElement = document.querySelector(`[data-date="${date}"]`);
            console.log(`Found day element for ${date}:`, dayElement);
            if (dayElement) {
                updateDayDisplay(dayElement, date, calendarData);
            } else {
                console.log(`No day element found for date: ${date}`);
            }
        });
        
        Object.keys(calendarData.shiftsByDate || {}).forEach(date => {
            console.log(`Looking for day element with date: ${date}`);
            const dayElement = document.querySelector(`[data-date="${date}"]`);
            console.log(`Found day element for ${date}:`, dayElement);
            if (dayElement) {
                updateDayDisplay(dayElement, date, calendarData);
            } else {
                console.log(`No day element found for date: ${date}`);
            }
        });
        
        console.log('updateCalendarDisplay completed successfully');
    } catch (error) {
        console.error('Error in updateCalendarDisplay:', error);
    }
}

function updateDayDisplay(dayElement, date, calendarData) {
    console.log(`Updating day display for ${date}`);
    const dayContent = dayElement.querySelector('.day-content');
    console.log(`Day content element:`, dayContent);
    if (!dayContent) {
        console.log(`No day-content found for date ${date}`);
        return;
    }
    
    // Очищаем существующий контент
    dayContent.innerHTML = '';
    console.log(`Cleared day content for ${date}`);
    
    // Добавляем тайм-слоты
    const timeslots = calendarData.timeslotsByDate[date] || [];
    console.log(`Adding ${timeslots.length} timeslots for ${date}`);
    timeslots.forEach(timeslot => {
        const timeslotElement = createTimeslotElement(timeslot);
        if (timeslotElement) {  // Проверяем, что элемент не null (не полностью занятый тайм-слот)
            dayContent.appendChild(timeslotElement);
            console.log(`Added timeslot ${timeslot.id} to ${date}`);
        } else {
            console.log(`Skipped fully occupied timeslot ${timeslot.id} for ${date}`);
        }
    });
    
    // Добавляем смены
    const shifts = calendarData.shiftsByDate[date] || [];
    console.log(`Adding ${shifts.length} shifts for ${date}`);
    shifts.forEach(shift => {
        const shiftElement = createShiftElement(shift);
        if (shiftElement) {  // Проверяем, что элемент не null (не отмененная смена)
            dayContent.appendChild(shiftElement);
            console.log(`Added shift ${shift.id} to ${date}`);
        } else {
            console.log(`Skipped cancelled shift ${shift.id} for ${date}`);
        }
    });
}

function createTimeslotElement(timeslot) {
    // Определяем занятость тайм-слота
    const currentEmployees = timeslot.current_employees || 0;
    const maxEmployees = timeslot.max_employees || 1;
    
    // Не отображаем полностью занятые тайм-слоты
    if (currentEmployees >= maxEmployees) {
        console.log(`Skipping fully occupied timeslot ${timeslot.id} (${currentEmployees}/${maxEmployees})`);
        return null;
    }
    
    const div = document.createElement('div');
    div.className = 'timeslot-item timeslot-free';
    div.setAttribute('data-timeslot-id', timeslot.id);
    div.onclick = () => showTimeslotDetails(timeslot.id);
    
    const occupancyBadge = `<div class="timeslot-badge">${currentEmployees}/${maxEmployees}</div>`;
    
    div.innerHTML = `
        <div class="timeslot-time">${timeslot.start_time} - ${timeslot.end_time}</div>
        <div class="timeslot-object">${timeslot.object_name}</div>
        <div class="timeslot-rate">${timeslot.hourly_rate}₽/ч</div>
        ${occupancyBadge}
    `;
    
    return div;
}

function createShiftElement(shift) {
    // Не отображаем отмененные смены
    if (shift.status === 'cancelled') {
        console.log(`Skipping cancelled shift ${shift.id}`);
        return null;
    }
    
    const div = document.createElement('div');
    div.className = `shift-item shift-${shift.shift_type}`;
    div.setAttribute('data-shift-id', shift.id);
    div.onclick = () => showShiftDetails(shift.id);
    
    // Определяем время начала и окончания
    let startTime = '';
    let endTime = '';
    
    if (shift.shift_type === 'planned') {
        // Для запланированных смен используем planned_start и planned_end
        startTime = shift.planned_start ? shift.planned_start.split('T')[1].substring(0, 5) : '';
        endTime = shift.planned_end ? shift.planned_end.split('T')[1].substring(0, 5) : '';
    } else {
        // Для активных/завершенных смен используем start_time и end_time
        startTime = shift.start_time ? shift.start_time.split('T')[1].substring(0, 5) : '';
        endTime = shift.end_time ? shift.end_time.split('T')[1].substring(0, 5) : '';
    }
    
    // Добавляем стикер для запланированных смен
    const sticker = shift.shift_type === 'planned' ? '<div class="shift-sticker">1/1</div>' : '';
    
    div.innerHTML = `
        <div class="shift-time">${startTime} - ${endTime}</div>
        <div class="shift-employee">${shift.user_name}</div>
        <div class="shift-object">${shift.object_name}</div>
        ${sticker}
    `;
    
    return div;
}

// Делаем функцию доступной глобально
window.renderCalendarGrid = renderCalendarGrid;

// Проверяем что функция доступна после загрузки и привязываем события
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, filterByObject available:', typeof window.filterByObject === 'function');
    
    // Привязываем событие к фильтру объектов
    const objectFilter = document.getElementById('objectFilter');
    if (objectFilter) {
        console.log('Object filter element found, binding change event');
        objectFilter.addEventListener('change', function() {
            console.log('Object filter change event triggered, value:', this.value);
            if (typeof window.filterByObject === 'function') {
                window.filterByObject();
            } else {
                console.error('filterByObject function not available');
            }
        });
    } else {
        console.log('Object filter element not found');
    }
});

function loadCalendar(date) {
    const params = new URLSearchParams(window.location.search);
    params.set('year', date.getFullYear());
    params.set('month', date.getMonth() + 1);
    
    // Сохраняем фильтр объекта при навигации
    const objectSelect = document.getElementById('objectFilter');
    if (objectSelect && objectSelect.value) {
        params.set('object_id', objectSelect.value);
    }
    
    window.location.search = params.toString();
}

// Shift and timeslot details
function showShiftDetails(shiftId) {
    console.log('Shift clicked:', shiftId);
    if (shiftId.toString().startsWith('schedule_')) {
        const scheduleId = shiftId.toString().replace('schedule_', '');
        window.location.href = `/manager/shifts/${scheduleId}?shift_type=schedule`;
    } else {
        window.location.href = `/manager/shifts/${shiftId}`;
    }
}

function showTimeslotDetails(timeslotId) {
    console.log('Timeslot clicked:', timeslotId);
    window.location.href = `/manager/timeslots/${timeslotId}`;
}

</script>
