{% set back_url = back_url|default('/owner/profile') %}
{% set close_redirect_url = close_redirect_url|default('/owner/profile?success=1') %}
{% set selected_id = selected_profile_id if selected_profile_id is defined else '' %}

<style>
  .sp-profiles-layout {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 80px);
  }
  .sp-profiles-header {
    padding: 1rem 1.5rem 0.5rem 1.5rem;
  }
  .sp-profiles-body {
    display: flex;
    flex: 1;
    min-height: 0;
    padding: 0 1.5rem 1.5rem 1.5rem;
    gap: 1.5rem;
  }
  .sp-profiles-list {
    width: 28rem;
    min-width: 22rem;
    max-width: 32rem;
    overflow-y: auto;
  }
  .sp-profiles-editor {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }
  .sp-tabs {
    border-bottom: 1px solid #dee2e6;
  }
  .sp-tabs .nav-link {
    cursor: pointer;
  }
  .sp-tab-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1rem 0.5rem 1rem;
  }
  .sp-wizard-footer {
    border-top: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .sp-help-block {
    background: #f8f9fa;
    border-left: 3px solid #0d6efd;
    padding: 0.75rem 1rem;
    border-radius: 0.25rem;
    font-size: 0.9rem;
  }
</style>

<div class="sp-profiles-layout">
  <div class="sp-profiles-header d-flex justify-content-between align-items-center">
    <div>
      <h1 class="h4 mb-1">
        <i class="bi bi-file-earmark-person me-2"></i>
        Мои профили
      </h1>
      <div class="text-muted small">
        Несколько профилей для одного Telegram‑аккаунта: физические лица, ИП и юридические лица.
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <a href="{{ back_url }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Вернуться в профиль
      </a>
    </div>
  </div>

  <div class="sp-profiles-body">
    <!-- Левая колонка: список профилей -->
    <div class="card sp-profiles-list">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Мои профили</span>
        <span class="badge bg-secondary" id="spProfilesCount">0</span>
      </div>
      <div class="list-group list-group-flush" id="spProfilesList">
        <!-- Элемент для создания нового профиля -->
        <button type="button"
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                onclick="spCreateNewProfileFromList()">
          <div>
            <div class="fw-semibold text-primary">
              <i class="bi bi-plus-circle me-1"></i>
              Создать новый профиль
            </div>
            <div class="small text-muted">Выберите тип профиля и заполните данные</div>
          </div>
        </button>
      </div>
      <div class="card-footer small text-muted">
        Профиль с отметкой
        <span class="badge bg-success">KYC</span>
        прошёл проверку через госуслуги.
      </div>
    </div>

    <!-- Правая колонка: мастер‑форма -->
    <div class="card sp-profiles-editor" id="spProfileEditorCard" style="display: none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold" id="spEditorTitle">Новый профиль</div>
          <div class="small text-muted" id="spEditorSubtitle"></div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-success d-none" id="spProfileVerifiedBadge">
            <i class="bi bi-patch-check-fill"></i> Профиль подтвержден
          </span>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="spStartKycBtn"
                  disabled title="Функция подтверждения через Госуслуги будет доступна позже">
            <i class="bi bi-shield-check"></i> Подтвердить через Госуслуги
          </button>
        </div>
      </div>

      <ul class="nav nav-tabs sp-tabs" id="spWizardTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-main" data-bs-toggle="tab" data-bs-target="#pane-main" type="button" role="tab">
            1. Основные данные
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-docs" data-bs-toggle="tab" data-bs-target="#pane-docs" type="button" role="tab">
            2. Документы
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-address" data-bs-toggle="tab" data-bs-target="#pane-address" type="button" role="tab">
            3. Адреса
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-contacts" data-bs-toggle="tab" data-bs-target="#pane-contacts" type="button" role="tab">
            4. Контакты
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-bank" data-bs-toggle="tab" data-bs-target="#pane-bank" type="button" role="tab">
            5. Банковские реквизиты
          </button>
        </li>
      </ul>

      <form id="spProfileForm" class="sp-tab-content tab-content">
        <!-- Основные данные -->
        <div class="tab-pane fade show active" id="pane-main" role="tabpanel">
          <div class="mb-3">
            <label class="form-label">Тип профиля *</label>
            <div class="btn-group" role="group" aria-label="Тип профиля">
              <input type="radio" class="btn-check" name="spProfileType" id="spTypeIndividual" autocomplete="off" value="individual" checked onchange="spChangeType('individual')">
              <label class="btn btn-outline-secondary btn-sm" for="spTypeIndividual">
                <i class="bi bi-person"></i> Физическое лицо
              </label>
              <input type="radio" class="btn-check" name="spProfileType" id="spTypeSP" autocomplete="off" value="sole_proprietor" onchange="spChangeType('sole_proprietor')">
              <label class="btn btn-outline-secondary btn-sm" for="spTypeSP">
                <i class="bi bi-person-badge"></i> ИП
              </label>
              <input type="radio" class="btn-check" name="spProfileType" id="spTypeLegal" autocomplete="off" value="legal" onchange="spChangeType('legal')">
              <label class="btn btn-outline-secondary btn-sm" for="spTypeLegal">
                <i class="bi bi-building"></i> Юр. лицо
              </label>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Отображаемое название профиля *</label>
            <input type="text" class="form-control" id="spDisplayName" name="display_name"
                   placeholder="Например: Петров И.И., ИП Петров, ООО «Ромашка»" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Тип профиля</label>
            <div class="d-flex gap-2">
              <span class="badge bg-secondary" id="spProfileTypeLabel"></span>
            </div>
          </div>

          <div id="spMainFieldsIndividual" class="d-none">
            <div class="sp-help-block mb-3">
              <strong>Физическое лицо.</strong>
              Используется для сотрудников, представителей или частных контрагентов.
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Фамилия *</label>
                <input type="text" class="form-control" name="last_name">
              </div>
              <div class="col-md-4">
                <label class="form-label">Имя *</label>
                <input type="text" class="form-control" name="first_name">
              </div>
              <div class="col-md-4">
                <label class="form-label">Отчество</label>
                <input type="text" class="form-control" name="middle_name">
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label">Гражданство *</label>
                <select class="form-select" name="citizenship">
                  <option value="rf">РФ</option>
                  <option value="foreign">Иностранное</option>
                  <option value="stateless">Лицо без гражданства</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Пол</label>
                <select class="form-select" name="gender">
                  <option value="">Не выбрано</option>
                  <option value="male">Мужской</option>
                  <option value="female">Женский</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Дата рождения</label>
                <input type="date" class="form-control" name="birth_date">
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="spIsSelfEmployed" name="is_self_employed">
                  <label class="form-check-label" for="spIsSelfEmployed">
                    Самозанятый
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div id="spMainFieldsLegal" class="d-none">
            <div class="sp-help-block mb-3">
              <strong>Юридическое лицо.</strong>
              Юридическим лицом признается зарегистрированная в установленном порядке коммерческая
              или некоммерческая организация, действующая на основании учредительных документов.
            </div>
            <div class="mb-3">
              <label class="form-label">Полное наименование *</label>
              <input type="text" class="form-control" name="full_name">
            </div>
          </div>

          <div id="spMainFieldsSP" class="d-none">
            <div class="sp-help-block mb-3">
              <strong>Индивидуальный предприниматель.</strong>
              Индивидуальным предпринимателем признается зарегистрированное в установленном порядке физическое лицо,
              осуществляющее предпринимательскую деятельность.
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Фамилия *</label>
                <input type="text" class="form-control" name="last_name">
              </div>
              <div class="col-md-4">
                <label class="form-label">Имя *</label>
                <input type="text" class="form-control" name="first_name">
              </div>
              <div class="col-md-4">
                <label class="form-label">Отчество</label>
                <input type="text" class="form-control" name="middle_name">
              </div>
            </div>
          </div>
        </div>

        <!-- Документы -->
        <div class="tab-pane fade" id="pane-docs" role="tabpanel">
          <div id="spDocsIndividual" class="d-none">
            <h6 class="mb-3">Паспортные данные</h6>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Серия</label>
                <input type="text" class="form-control" name="passport_series">
              </div>
              <div class="col-md-3">
                <label class="form-label">Номер</label>
                <input type="text" class="form-control" name="passport_number">
              </div>
              <div class="col-md-3">
                <label class="form-label">Дата выдачи</label>
                <input type="date" class="form-control" name="passport_issued_at">
              </div>
              <div class="col-md-3">
                <label class="form-label">Код подразделения</label>
                <input type="text" class="form-control" name="passport_department_code">
              </div>
            </div>
            <div class="mb-3 mt-3">
              <label class="form-label">Кем выдан</label>
              <input type="text" class="form-control" name="passport_issued_by">
            </div>
            <h6 class="mt-4 mb-2">Регистрационные данные</h6>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">СНИЛС</label>
                <input type="text" class="form-control" name="snils">
              </div>
              <div class="col-md-4">
                <label class="form-label">ИНН</label>
                <input type="text" class="form-control" name="inn">
              </div>
            </div>
          </div>

          <div id="spDocsLegal" class="d-none">
            <h6 class="mb-3">Регистрационные данные ЮЛ</h6>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">ОГРН</label>
                <input type="text" class="form-control" name="ogrn">
              </div>
              <div class="col-md-4">
                <label class="form-label">Дата присвоения ОГРН</label>
                <input type="date" class="form-control" name="ogrn_assigned_at">
              </div>
              <div class="col-md-4">
                <label class="form-label">ИНН</label>
                <input type="text" class="form-control" name="inn">
              </div>
            </div>
            <div class="row g-3 mt-3">
              <div class="col-md-4">
                <label class="form-label">ОКПО</label>
                <input type="text" class="form-control" name="okpo">
              </div>
            </div>

            <hr class="my-4">
            <h6 class="mb-2">Сведения о представителе</h6>
            <p class="small text-muted mb-2">
              Выберите профиль физического лица, которое выступает представителем юридического лица.
            </p>
            <div class="input-group mb-2">
              <input type="text" class="form-control" id="spRepresentativeDisplay" readonly
                     placeholder="Выберите профиль представителя">
              <button class="btn btn-outline-secondary" type="button" onclick="spSelectRepresentative()">
                <i class="bi bi-person-search"></i> Выбрать
              </button>
            </div>
            <input type="hidden" name="representative_profile_id" id="spRepresentativeId">

            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label class="form-label">Основание полномочий</label>
                <input type="text" class="form-control" name="representative_basis"
                       placeholder="Например: Устав">
              </div>
              <div class="col-md-6">
                <label class="form-label">Наименование должности</label>
                <input type="text" class="form-control" name="representative_position"
                       placeholder="Например: Генеральный директор">
              </div>
            </div>
          </div>

          <div id="spDocsSP" class="d-none">
            <h6 class="mb-3">Регистрационные данные ИП</h6>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">ОГРНИП</label>
                <input type="text" class="form-control" name="ogrnip">
              </div>
              <div class="col-md-4">
                <label class="form-label">ИНН</label>
                <input type="text" class="form-control" name="inn">
              </div>
              <div class="col-md-4">
                <label class="form-label">ОКПО</label>
                <input type="text" class="form-control" name="okpo">
              </div>
            </div>
          </div>
        </div>

        <!-- Адреса -->
        <div class="tab-pane fade" id="pane-address" role="tabpanel">
          {% include "shared/address_map.html" %}

          <div id="spAddressIndividual" class="d-none mt-3">
            <input type="hidden" name="registration_address_id" id="spRegAddressId">
            <input type="hidden" id="spRegAddressText">

            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="spSameAsReg" checked>
              <label class="form-check-label" for="spSameAsReg">
                Совпадает с адресом регистрации
              </label>
            </div>

            <div id="spAddressIndividualResidence" class="mt-2" style="display: none;">
              <label class="form-label">Адрес проживания</label>
              <input type="text" class="form-control mb-2" id="spResidenceAddressDisplayInd"
                     placeholder="Выберите адрес проживания на карте или в списке подсказок">
            </div>
            <input type="hidden" name="residence_address_id" id="spResidenceAddressId">
          </div>

          <div id="spAddressLegal" class="d-none mt-3">
            <input type="hidden" name="registration_address_id" id="spLegalRegAddressId">

            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="spLegalSameAsReg" checked>
              <label class="form-check-label" for="spLegalSameAsReg">
                Адрес в РФ совпадает с адресом регистрации
              </label>
            </div>

            <div id="spAddressLegalRF" class="mt-2" style="display: none;">
              <label class="form-label">Адрес в РФ</label>
              <input type="text" class="form-control mb-2" id="spLegalAddressDisplay"
                     placeholder="Выберите адрес в РФ на карте или в списке подсказок">
            </div>
            <input type="hidden" name="address_rf_id" id="spLegalAddressId">
          </div>

          <div id="spAddressSP" class="d-none mt-3">
            <input type="hidden" name="residence_address_id" id="spResidenceAddressId">
          </div>
        </div>

        <!-- Контакты -->
        <div class="tab-pane fade" id="pane-contacts" role="tabpanel">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Телефон</label>
              <input type="tel" class="form-control" name="phone">
            </div>
            <div class="col-md-4">
              <label class="form-label">E‑mail</label>
              <input type="email" class="form-control" name="email">
            </div>
            <div class="col-md-4">
              <label class="form-label">MAX</label>
              <input type="text" class="form-control" name="max_contact">
            </div>
          </div>
        </div>

        <!-- Банковские реквизиты -->
        <div class="tab-pane fade" id="pane-bank" role="tabpanel">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Расчетный счет</label>
              <input type="text" class="form-control" name="account_number">
            </div>
            <div class="col-md-6">
              <label class="form-label">Корреспондентский счет</label>
              <input type="text" class="form-control" name="correspondent_account">
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-8">
              <label class="form-label">Наименование банка</label>
              <input type="text" class="form-control" name="bank_name">
            </div>
            <div class="col-md-4">
              <label class="form-label">БИК</label>
              <input type="text" class="form-control" name="bik">
            </div>
          </div>
        </div>
      </form>

      <div class="sp-wizard-footer">
        <div class="small text-muted">
          <span id="spWizardStepLabel">Шаг 1 из 5</span>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="spWizardPrev" onclick="spWizardPrev()" disabled>
            Назад
          </button>
          <button class="btn btn-primary btn-sm" type="button" id="spWizardNext" onclick="spWizardNext()">
            Далее
          </button>
          <button class="btn btn-success btn-sm d-none" type="button" id="spWizardSave" onclick="spSaveProfile(false)" disabled>
            Сохранить
          </button>
          <button class="btn btn-outline-success btn-sm d-none" type="button" id="spWizardSaveClose" onclick="spSaveProfile(true)" disabled>
            Сохранить и закрыть
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const spSelectedProfileId = "{{ selected_id }}";
const spCloseRedirectUrl = "{{ close_redirect_url }}";
</script>
