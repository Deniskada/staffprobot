{% extends base_template %}

{% block title %}База знаний - StaffProBot{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex align-items-center mb-4">
                <a href="/support" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <h1 class="mb-0">
                    <i class="bi bi-book text-primary"></i> База знаний
                </h1>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Категории -->
        <div class="col-md-3">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-list"></i> Категории
                </div>
                <div class="list-group list-group-flush">
                    <a href="/support/faq" class="list-group-item list-group-item-action {% if not selected_category %}active{% endif %}">
                        <i class="bi bi-grid"></i> Все категории
                    </a>
                    <a href="/support/faq?category=shifts" class="list-group-item list-group-item-action {% if selected_category == 'shifts' %}active{% endif %}">
                        <i class="bi bi-clock"></i> Смены
                    </a>
                    <a href="/support/faq?category=salary" class="list-group-item list-group-item-action {% if selected_category == 'salary' %}active{% endif %}">
                        <i class="bi bi-currency-dollar"></i> Зарплата
                    </a>
                    <a href="/support/faq?category=technical" class="list-group-item list-group-item-action {% if selected_category == 'technical' %}active{% endif %}">
                        <i class="bi bi-gear"></i> Технические
                    </a>
                </div>
            </div>

            <!-- Быстрые действия -->
            <div class="card mt-3">
                <div class="card-body text-center">
                    <p class="card-text small text-muted mb-3">
                        Не нашли ответ?
                    </p>
                    <a href="/support/bug" class="btn btn-sm btn-danger w-100">
                        <i class="bi bi-bug"></i> Сообщить о проблеме
                    </a>
                </div>
            </div>
        </div>

        <!-- Вопросы и ответы -->
        <div class="col-md-9">
            <!-- Поиск -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input 
                            type="text" 
                            class="form-control" 
                            placeholder="Поиск по вопросам..."
                            id="searchInput"
                        >
                    </div>
                </div>
            </div>

            <!-- FAQ контент -->
            <div id="faqContent">
                {% for category_key, category_data in faq_data.items() %}
                <div class="mb-5">
                    <h3 class="mb-3 pb-2 border-bottom" id="category-{{ category_key }}">
                        {{ category_data.title }}
                    </h3>

                    <div class="accordion" id="accordion-{{ category_key }}">
                        {% for question in category_data.questions %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-{{ category_key }}-{{ loop.index }}">
                                <button 
                                    class="accordion-button {% if not loop.first %}collapsed{% endif %}" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-{{ category_key }}-{{ loop.index }}" 
                                    aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" 
                                    aria-controls="collapse-{{ category_key }}-{{ loop.index }}"
                                >
                                    <strong>{{ question.q }}</strong>
                                </button>
                            </h2>
                            <div 
                                id="collapse-{{ category_key }}-{{ loop.index }}" 
                                class="accordion-collapse collapse {% if loop.first and not selected_category %}show{% endif %}" 
                                aria-labelledby="heading-{{ category_key }}-{{ loop.index }}" 
                                data-bs-parent="#accordion-{{ category_key }}"
                            >
                                <div class="accordion-body">
                                    {{ question.a }}
                                    
                                    <!-- Было ли это полезно? -->
                                    <div class="mt-3 pt-3 border-top">
                                        <small class="text-muted">Была ли эта информация полезной?</small>
                                        <div class="btn-group ms-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-success" onclick="markHelpful(true)">
                                                <i class="bi bi-hand-thumbs-up"></i> Да
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="markHelpful(false)">
                                                <i class="bi bi-hand-thumbs-down"></i> Нет
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Сообщение, если ничего не найдено -->
            <div id="noResults" class="text-center py-5" style="display: none;">
                <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                <h4 class="mt-3 text-muted">Ничего не найдено</h4>
                <p class="text-muted">
                    Попробуйте изменить запрос или 
                    <a href="/support/bug">сообщите о проблеме</a>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Простой поиск по FAQ
document.getElementById('searchInput').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const faqContent = document.getElementById('faqContent');
    const noResults = document.getElementById('noResults');
    
    if (query.length < 2) {
        // Показать все
        document.querySelectorAll('.accordion-item').forEach(item => {
            item.style.display = 'block';
        });
        noResults.style.display = 'none';
        return;
    }
    
    let hasResults = false;
    
    document.querySelectorAll('.accordion-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(query)) {
            item.style.display = 'block';
            hasResults = true;
        } else {
            item.style.display = 'none';
        }
    });
    
    if (!hasResults) {
        noResults.style.display = 'block';
    } else {
        noResults.style.display = 'none';
    }
});

// Отметить как полезное
function markHelpful(isHelpful) {
    // TODO: Отправить на сервер
    alert(isHelpful ? 'Спасибо за отзыв!' : 'Мы постараемся улучшить этот ответ.');
}
</script>
{% endblock %}

