{% extends base_template %}

{% block title %}–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è - StaffProBot{% endblock %}

{% block manager_content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex align-items-center mb-4">
                <a href="/support" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <h1 class="mb-0">
                    <i class="bi bi-list-check text-success"></i> –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
                </h1>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            {% if bugs %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>GitHub Issue</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bug in bugs %}
                            <tr>
                                <td>
                                    <small>{{ bug.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                </td>
                                <td>{{ bug.title }}</td>
                                <td>
                                    {% if bug.priority == 'critical' %}
                                        <span class="badge bg-danger">üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–π</span>
                                    {% elif bug.priority == 'high' %}
                                        <span class="badge bg-warning">üü† –í—ã—Å–æ–∫–∏–π</span>
                                    {% elif bug.priority == 'medium' %}
                                        <span class="badge bg-info">üü° –°—Ä–µ–¥–Ω–∏–π</span>
                                    {% else %}
                                        <span class="badge bg-success">üü¢ –ù–∏–∑–∫–∏–π</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bug.status == 'resolved' %}
                                        <span class="badge bg-success">‚úì –†–µ—à–µ–Ω–æ</span>
                                    {% elif bug.status == 'in_progress' %}
                                        <span class="badge bg-primary">–í —Ä–∞–±–æ—Ç–µ</span>
                                    {% else %}
                                        <span class="badge bg-secondary">–û—Ç–∫—Ä—ã—Ç–æ</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bug.github_issue_number %}
                                        <a href="https://github.com/OWNER/REPO/issues/{{ bug.github_issue_number }}" 
                                           target="_blank" 
                                           class="btn btn-sm btn-outline-dark">
                                            <i class="bi bi-github"></i> #{{ bug.github_issue_number }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showBugDetails({{ bug.id }})">
                                        <i class="bi bi-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <h5 class="alert-heading">
                        <i class="bi bi-inbox"></i> –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π
                    </h5>
                    <p class="mb-0">
                        –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π. 
                        <a href="/support/bug">–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ?</a>
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –±–∞–≥–∞ -->
<div class="modal fade" id="bugDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bugDetailsContent">
                <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
function showBugDetails(bugId) {
    const bug = {{ bugs_json | tojson }};
    const bugData = bug.find(b => b.id === bugId);
    
    if (!bugData) return;
    
    const content = `
        <div class="mb-3">
            <strong>–ß—Ç–æ –¥–µ–ª–∞–ª–∏:</strong>
            <p class="border rounded p-2">${bugData.what_doing}</p>
        </div>
        
        <div class="mb-3">
            <strong>–û–∂–∏–¥–∞–µ–º–æ–µ:</strong>
            <p class="border rounded p-2">${bugData.expected}</p>
        </div>
        
        <div class="mb-3">
            <strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ:</strong>
            <p class="border rounded p-2">${bugData.actual}</p>
        </div>
        
        ${bugData.screenshot_url ? `
        <div class="mb-3">
            <strong>–°–∫—Ä–∏–Ω—à–æ—Ç:</strong>
            <img src="${bugData.screenshot_url}" class="img-fluid rounded" alt="Screenshot">
        </div>
        ` : ''}
        
        <div class="mt-4">
            <small class="text-muted">
                –°–æ–∑–¥–∞–Ω–æ: ${new Date(bugData.created_at).toLocaleString('ru-RU')}
                ${bugData.resolved_at ? '<br>–†–µ—à–µ–Ω–æ: ' + new Date(bugData.resolved_at).toLocaleString('ru-RU') : ''}
            </small>
        </div>
    `;
    
    document.getElementById('bugDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('bugDetailsModal')).show();
}
</script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex align-items-center mb-4">
                <a href="/support" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <h1 class="mb-0">
                    <i class="bi bi-list-check text-success"></i> –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
                </h1>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            {% if bugs %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>GitHub Issue</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bug in bugs %}
                            <tr>
                                <td>
                                    <small>{{ bug.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                </td>
                                <td>{{ bug.title }}</td>
                                <td>
                                    {% if bug.priority == 'critical' %}
                                        <span class="badge bg-danger">üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–π</span>
                                    {% elif bug.priority == 'high' %}
                                        <span class="badge bg-warning">üü† –í—ã—Å–æ–∫–∏–π</span>
                                    {% elif bug.priority == 'medium' %}
                                        <span class="badge bg-info">üü° –°—Ä–µ–¥–Ω–∏–π</span>
                                    {% else %}
                                        <span class="badge bg-success">üü¢ –ù–∏–∑–∫–∏–π</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bug.status == 'resolved' %}
                                        <span class="badge bg-success">‚úì –†–µ—à–µ–Ω–æ</span>
                                    {% elif bug.status == 'in_progress' %}
                                        <span class="badge bg-primary">–í —Ä–∞–±–æ—Ç–µ</span>
                                    {% else %}
                                        <span class="badge bg-secondary">–û—Ç–∫—Ä—ã—Ç–æ</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bug.github_issue_number %}
                                        <a href="https://github.com/OWNER/REPO/issues/{{ bug.github_issue_number }}" 
                                           target="_blank" 
                                           class="btn btn-sm btn-outline-dark">
                                            <i class="bi bi-github"></i> #{{ bug.github_issue_number }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showBugDetails({{ bug.id }})">
                                        <i class="bi bi-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <h5 class="alert-heading">
                        <i class="bi bi-inbox"></i> –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π
                    </h5>
                    <p class="mb-0">
                        –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π. 
                        <a href="/support/bug">–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ?</a>
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –±–∞–≥–∞ -->
<div class="modal fade" id="bugDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bugDetailsContent">
                <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
function showBugDetails(bugId) {
    const bug = {{ bugs_json | tojson }};
    const bugData = bug.find(b => b.id === bugId);
    
    if (!bugData) return;
    
    const content = `
        <div class="mb-3">
            <strong>–ß—Ç–æ –¥–µ–ª–∞–ª–∏:</strong>
            <p class="border rounded p-2">${bugData.what_doing}</p>
        </div>
        
        <div class="mb-3">
            <strong>–û–∂–∏–¥–∞–µ–º–æ–µ:</strong>
            <p class="border rounded p-2">${bugData.expected}</p>
        </div>
        
        <div class="mb-3">
            <strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ:</strong>
            <p class="border rounded p-2">${bugData.actual}</p>
        </div>
        
        ${bugData.screenshot_url ? `
        <div class="mb-3">
            <strong>–°–∫—Ä–∏–Ω—à–æ—Ç:</strong>
            <img src="${bugData.screenshot_url}" class="img-fluid rounded" alt="Screenshot">
        </div>
        ` : ''}
        
        <div class="mt-4">
            <small class="text-muted">
                –°–æ–∑–¥–∞–Ω–æ: ${new Date(bugData.created_at).toLocaleString('ru-RU')}
                ${bugData.resolved_at ? '<br>–†–µ—à–µ–Ω–æ: ' + new Date(bugData.resolved_at).toLocaleString('ru-RU') : ''}
            </small>
        </div>
    `;
    
    document.getElementById('bugDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('bugDetailsModal')).show();
}
</script>
{% endblock %}