{% extends "admin/base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.form-section {
    background: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.form-section h4 {
    color: #333;
    margin-bottom: 20px;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.feature-tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.9rem;
    margin: 3px;
    display: inline-block;
}

.feature-input {
    border: 2px dashed #ddd;
    padding: 15px;
    border-radius: 10px;
    background: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/admin/tariffs">–¢–∞—Ä–∏—Ñ—ã</a>
                    </li>
                    <li class="breadcrumb-item active">
                        {% if is_create %}–°–æ–∑–¥–∞–Ω–∏–µ{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% endif %}
                    </li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="/admin/tariffs" class="btn btn-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–∞—Ä–∏—Ñ–∞–º
            </a>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ -->
    <form method="POST" action="{% if is_create %}/admin/tariffs/create{% else %}/admin/tariffs/{{ tariff_plan.id }}/edit{% endif %}">
        <div class="row">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="col-md-8">
                <div class="form-section">
                    <h4>üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ tariff_plan.name if tariff_plan else '' }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="currency" class="form-label">–í–∞–ª—é—Ç–∞</label>
                                <select class="form-control" id="currency" name="currency">
                                    <option value="RUB" {% if tariff_plan and tariff_plan.currency == 'RUB' %}selected{% endif %}>RUB</option>
                                    <option value="USD" {% if tariff_plan and tariff_plan.currency == 'USD' %}selected{% endif %}>USD</option>
                                    <option value="EUR" {% if tariff_plan and tariff_plan.currency == 'EUR' %}selected{% endif %}>EUR</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ tariff_plan.description if tariff_plan else '' }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="price" class="form-label">–¶–µ–Ω–∞ *</label>
                                <input type="number" class="form-control" id="price" name="price" 
                                       value="{{ tariff_plan.price if tariff_plan else '' }}" 
                                       step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="billing_period" class="form-label">–ü–µ—Ä–∏–æ–¥ –±–∏–ª–ª–∏–Ω–≥–∞</label>
                                <select class="form-control" id="billing_period" name="billing_period">
                                    <option value="month" {% if tariff_plan and tariff_plan.billing_period == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                                    <option value="year" {% if tariff_plan and tariff_plan.billing_period == 'year' %}selected{% endif %}>–ì–æ–¥</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="price_per_month" class="form-label">–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—è—Ü</label>
                                <input type="text" class="form-control" id="price_per_month" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –õ–∏–º–∏—Ç—ã -->
                <div class="form-section">
                    <h4>üìä –õ–∏–º–∏—Ç—ã —Ç–∞—Ä–∏—Ñ–∞</h4>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="max_objects" class="form-label">–ú–∞–∫—Å–∏–º—É–º –æ–±—ä–µ–∫—Ç–æ–≤</label>
                                <input type="number" class="form-control" id="max_objects" name="max_objects" 
                                       value="{{ tariff_plan.max_objects if tariff_plan else '2' }}" 
                                       min="-1" required>
                                <small class="form-text text-muted">-1 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="max_employees" class="form-label">–ú–∞–∫—Å–∏–º—É–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</label>
                                <input type="number" class="form-control" id="max_employees" name="max_employees" 
                                       value="{{ tariff_plan.max_employees if tariff_plan else '5' }}" 
                                       min="-1" required>
                                <small class="form-text text-muted">-1 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="max_managers" class="form-label">–ú–∞–∫—Å–∏–º—É–º —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö</label>
                                <input type="number" class="form-control" id="max_managers" name="max_managers" 
                                       value="{{ tariff_plan.max_managers if tariff_plan else '0' }}" 
                                       min="-1" required>
                                <small class="form-text text-muted">-1 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ -->
                <div class="form-section">
                    <h4>‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç–∞—Ä–∏—Ñ–∞</h4>
                    
                    <div class="mb-3">
                        <label class="form-label">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</label>
                        <div class="feature-input">
                            <div id="features-list">
                                {% if tariff_plan and tariff_plan.features %}
                                    {% for feature in tariff_plan.features %}
                                    <span class="feature-tag">
                                        {{ feature }}
                                        <button type="button" class="btn-close" onclick="removeFeature(this)"></button>
                                    </span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="mt-3">
                                <div class="mb-2">
                                    <small class="text-muted">–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</small>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="addPresetFeature('basic_reports')">–ë–∞–∑–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addPresetFeature('telegram_bot')">Telegram –±–æ—Ç</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addPresetFeature('shared_calendar')">–û–±—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addPresetFeature('notifications')">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addPresetFeature('advanced_reports')">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addPresetFeature('api_access')">API –¥–æ—Å—Ç—É–ø</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addPresetFeature('advanced_calendar')">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addPresetFeature('custom_notifications')">–ö–∞—Å—Ç–æ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                                    </div>
                                </div>
                                <input type="text" id="new-feature" class="form-control" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å">
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addFeature()">
                                    –î–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="features" name="features" value="{{ tariff_plan.features | tojson if tariff_plan and tariff_plan.features else '[]' }}">
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="col-md-4">
                <div class="form-section">
                    <h4>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                               {% if not tariff_plan or tariff_plan.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">
                            –ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞—Ä–∏—Ñ
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_popular" name="is_popular" 
                               {% if tariff_plan and tariff_plan.is_popular %}checked{% endif %}>
                        <label class="form-check-label" for="is_popular">
                            –ü–æ–ø—É–ª—è—Ä–Ω—ã–π —Ç–∞—Ä–∏—Ñ
                        </label>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
                <div class="form-section">
                    <h4>üëÄ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h4>
                    <div class="card">
                        <div class="card-header">
                            <h5 id="preview-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞</h5>
                            <span id="preview-popular" class="badge bg-warning" style="display: none;">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</span>
                        </div>
                        <div class="card-body">
                            <p id="preview-description" class="card-text">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞</p>
                            <h4 id="preview-price" class="text-primary">–¶–µ–Ω–∞</h4>
                            <div id="preview-limits">
                                <small class="text-muted">–õ–∏–º–∏—Ç—ã:</small>
                                <ul class="list-unstyled">
                                    <li>–û–±—ä–µ–∫—Ç—ã: <span id="preview-objects">-</span></li>
                                    <li>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: <span id="preview-employees">-</span></li>
                                    <li>–£–ø—Ä–∞–≤–ª—è—é—â–∏–µ: <span id="preview-managers">-</span></li>
                                </ul>
                            </div>
                            <div id="preview-features">
                                <small class="text-muted">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</small>
                                <ul id="preview-features-list" class="list-unstyled"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="form-section">
            <div class="d-flex justify-content-between">
                <a href="/admin/tariffs" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                <button type="submit" class="btn btn-primary">
                    {% if is_create %}–°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ{% else %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function updatePreview() {
    const name = document.getElementById('name').value || '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞';
    const description = document.getElementById('description').value || '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞';
    const price = parseFloat(document.getElementById('price').value) || 0;
    const currency = document.getElementById('currency').value;
    const billing_period = document.getElementById('billing_period').value;
    const max_objects = document.getElementById('max_objects').value;
    const max_employees = document.getElementById('max_employees').value;
    const max_managers = document.getElementById('max_managers').value;
    const is_popular = document.getElementById('is_popular').checked;

    document.getElementById('preview-name').textContent = name;
    document.getElementById('preview-description').textContent = description;
    
    let priceText = '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ';
    if (price > 0) {
        priceText = `${price} ${currency}/${billing_period}`;
    }
    document.getElementById('preview-price').textContent = priceText;
    
    document.getElementById('preview-objects').textContent = max_objects == -1 ? '‚àû' : max_objects;
    document.getElementById('preview-employees').textContent = max_employees == -1 ? '‚àû' : max_employees;
    document.getElementById('preview-managers').textContent = max_managers == -1 ? '‚àû' : max_managers;
    
    document.getElementById('preview-popular').style.display = is_popular ? 'inline' : 'none';
    
    updatePricePerMonth();
    updateFeaturesPreview();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∑–∞ –º–µ—Å—è—Ü
function updatePricePerMonth() {
    const price = parseFloat(document.getElementById('price').value) || 0;
    const billing_period = document.getElementById('billing_period').value;
    
    let pricePerMonth = price;
    if (billing_period === 'year') {
        pricePerMonth = (price / 12).toFixed(2);
    }
    
    document.getElementById('price_per_month').value = `${pricePerMonth} ${document.getElementById('currency').value}`;
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏
function addFeature() {
    const input = document.getElementById('new-feature');
    const feature = input.value.trim();
    
    if (feature) {
        addFeatureTag(feature);
        input.value = '';
    }
}

function addPresetFeature(feature) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
    const existingFeatures = Array.from(document.querySelectorAll('#features-list .feature-tag')).map(tag => tag.textContent.trim());
    if (existingFeatures.includes(feature)) {
        return; // –£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞
    }
    
    addFeatureTag(feature);
}

function addFeatureTag(feature) {
    const featuresList = document.getElementById('features-list');
    const tag = document.createElement('span');
    tag.className = 'feature-tag';
    tag.innerHTML = `${feature} <button type="button" class="btn-close" onclick="removeFeature(this)"></button>`;
    featuresList.appendChild(tag);
    
    updateFeaturesInput();
    updatePreview();
}

function removeFeature(button) {
    button.parentElement.remove();
    updateFeaturesInput();
    updatePreview();
}

function updateFeaturesInput() {
    const features = [];
    document.querySelectorAll('#features-list .feature-tag').forEach(tag => {
        const text = tag.textContent.trim();
        if (text) {
            features.push(text);
        }
    });
    
    document.getElementById('features').value = JSON.stringify(features);
}

function updateFeaturesPreview() {
    const featuresList = document.getElementById('preview-features-list');
    featuresList.innerHTML = '';
    
    document.querySelectorAll('#features-list .feature-tag').forEach(tag => {
        const text = tag.textContent.trim();
        if (text) {
            const li = document.createElement('li');
            li.innerHTML = '<i class="bi bi-check-circle text-success"></i> ' + text;
            featuresList.appendChild(li);
        }
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.addEventListener('DOMContentLoaded', function() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
    ['name', 'description', 'price', 'currency', 'billing_period', 'max_objects', 'max_employees', 'max_managers', 'is_popular'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePreview);
        document.getElementById(id).addEventListener('change', updatePreview);
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ Enter
    document.getElementById('new-feature').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addFeature();
        }
    });
    
    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    updatePreview();
});
</script>
{% endblock %}
