{% extends "admin/base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.tariff-card {
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.tariff-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.tariff-card.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.user-search {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
}

.feature-list {
    list-style: none;
    padding: 0;
}

.feature-list li {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.feature-list li:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/admin/subscriptions/">–ü–æ–¥–ø–∏—Å–∫–∏</a>
                    </li>
                    <li class="breadcrumb-item active">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="/admin/subscriptions/" class="btn btn-secondary">
                ‚Üê –ö –ø–æ–¥–ø–∏—Å–∫–∞–º
            </a>
        </div>
    </div>

    <form method="POST" action="/admin/subscriptions/assign" id="assignForm">
        <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="user-search">
            <h5>üë§ –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
            {% if selected_user %}
            <div class="alert alert-success">
                <strong>–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong>
                {{ selected_user.first_name }} {{ selected_user.last_name }}
                (ID: {{ selected_user.id }}, Telegram: @{{ selected_user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω' }})
            </div>
            <input type="hidden" name="user_id" id="selected_user_id" value="{{ selected_user.id }}">
            {% else %}
            <div class="row">
                <div class="col-md-8">
                    <label for="user_search" class="form-label">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID –∏–ª–∏ –∏–º–µ–Ω–∏</label>
                    <input type="number" class="form-control" id="user_search" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-primary d-block w-100" onclick="searchUser()">
                        <i class="bi bi-search"></i> –ù–∞–π—Ç–∏
                    </button>
                </div>
            </div>
            <input type="hidden" name="user_id" id="selected_user_id" required>
            {% endif %}
        </div>

        <!-- –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ -->
        <div class="mb-4">
            <h5>üí∞ –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞</h5>
            <div class="row">
                {% for tariff in tariff_plans %}
                <div class="col-md-4 mb-3">
                    <div class="tariff-card" onclick="selectTariff({{ tariff.id }}, this)">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="mb-0">{{ tariff.name }}</h6>
                            {% if tariff.is_popular %}
                            <span class="badge bg-warning">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</span>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <h4 class="text-primary mb-0">
                                {% if tariff.price == 0 %}
                                    –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
                                {% else %}
                                    {{ tariff.price }} {{ tariff.currency }}
                                    <small class="text-muted">/{{ tariff.billing_period }}</small>
                                {% endif %}
                            </h4>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">–õ–∏–º–∏—Ç—ã:</small>
                            <ul class="list-unstyled">
                                <li>–û–±—ä–µ–∫—Ç—ã: {{ tariff.max_objects if tariff.max_objects != -1 else '‚àû' }}</li>
                                <li>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: {{ tariff.max_employees if tariff.max_employees != -1 else '‚àû' }}</li>
                                <li>–£–ø—Ä–∞–≤–ª—è—é—â–∏–µ: {{ tariff.max_managers if tariff.max_managers != -1 else '‚àû' }}</li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</small>
                            <ul class="feature-list">
                                {% for feature in tariff.features[:5] %}
                                <li><i class="bi bi-check-circle text-success"></i> {{ feature }}</li>
                                {% endfor %}
                                {% if tariff.features|length > 5 %}
                                <li><i class="bi bi-three-dots text-muted"></i> –∏ –µ—â–µ {{ tariff.features|length - 5 }}...</li>
                                {% endif %}
                            </ul>
                        </div>
                        
                        {% if tariff.description %}
                        <p class="text-muted small">{{ tariff.description }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <input type="hidden" name="tariff_plan_id" id="selected_tariff_id" required>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="payment_method" class="form-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                            <select class="form-control" id="payment_method" name="payment_method">
                                <option value="manual">–†—É—á–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</option>
                                <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
                                <option value="bank_transfer">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</option>
                                <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="notes" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="d-flex justify-content-between mt-4">
            <a href="/admin/subscriptions/" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                <i class="bi bi-check-circle"></i> –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
            </button>
        </div>
    </form>
</div>

<script>
let selectedTariffId = null;

function selectTariff(tariffId, element) {
    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
    document.querySelectorAll('.tariff-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    element.classList.add('selected');
    selectedTariffId = tariffId;
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
    const tariffIdElement = document.getElementById('selected_tariff_id');
    if (tariffIdElement) {
        tariffIdElement.value = tariffId;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É
    checkFormValidity();
}

function searchUser() {
    const userId = document.getElementById('user_search').value;
    if (userId) {
        window.location.href = `/admin/subscriptions/assign?user_id=${userId}`;
    } else {
        alert('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    }
}

function checkFormValidity() {
    const userIdElement = document.getElementById('selected_user_id');
    const tariffIdElement = document.getElementById('selected_tariff_id');
    const submitBtn = document.getElementById('submitBtn');
    
    const userId = userIdElement ? userIdElement.value : null;
    const tariffId = tariffIdElement ? tariffIdElement.value : null;
    
    if (userId && tariffId) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    {% if selected_user %}
    checkFormValidity();
    {% endif %}
});
</script>
{% endblock %}
