{% extends "admin/base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    transition: transform 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
}

.metric-card h3 {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 0;
}

.metric-card p {
    margin: 0;
    opacity: 0.9;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-completed { background-color: #28a745; color: white; }
.status-pending { background-color: #ffc107; color: black; }
.status-failed { background-color: #dc3545; color: white; }
.status-processing { background-color: #17a2b8; color: white; }

.chart-container {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.quick-action-btn {
    background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
    border: none;
    color: white;
    padding: 15px 25px;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    margin: 5px;
}

.quick-action-btn:hover {
    transform: scale(1.05);
    color: white;
    text-decoration: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
                    </li>
                    <li class="breadcrumb-item active">–ë–∏–ª–ª–∏–Ω–≥</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="/admin/billing/transactions" class="btn btn-primary">
                <i class="bi bi-credit-card"></i> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            </a>
            <a href="/admin/billing/usage" class="btn btn-success">
                <i class="bi bi-graph-up"></i> –ú–µ—Ç—Ä–∏–∫–∏
            </a>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <h3 id="total-transactions">-</h3>
                <p>–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <h3 id="total-revenue">-</h3>
                <p>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <h3 id="active-subscriptions">-</h3>
                <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <h3 id="pending-payments">-</h3>
                <p>–û–∂–∏–¥–∞—é—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üöÄ –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                </div>
                <div class="card-body">
                    <a href="/admin/billing/transactions" class="quick-action-btn">
                        <i class="bi bi-list-ul"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                    </a>
                    <a href="/admin/billing/usage" class="quick-action-btn">
                        <i class="bi bi-pie-chart"></i> –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    </a>
                    <a href="/admin/subscriptions/" class="quick-action-btn">
                        <i class="bi bi-people"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
                    </a>
                    <a href="/admin/tariffs/" class="quick-action-btn">
                        <i class="bi bi-credit-card-2-front"></i> –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <h5>üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h5>
                <div id="recent-transactions">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <h5>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</h5>
                <div id="billing-warnings">
                    <div class="text-center text-muted">
                        <i class="bi bi-shield-check fs-1"></i>
                        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <h5>üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º</h5>
                <div id="tariff-distribution">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    {% if statistics %}
    updateMetricsFromServer({
        total_transactions: {{ statistics.total_transactions }},
        total_revenue: {{ statistics.total_revenue }},
        active_subscriptions: {{ statistics.active_subscriptions }},
        pending_payments: {{ statistics.pending_payments }}
    });
    {% endif %}
    
    loadDashboardData();
});

async function loadDashboardData() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        const transactionsResponse = await fetch('/admin/billing/api/transactions?limit=10');
        const transactionsData = await transactionsResponse.json();
        
        if (transactionsData.success) {
            displayRecentTransactions(transactionsData.data);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
        loadTariffDistribution();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        loadBillingWarnings();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞:', error);
    }
}

async function loadTariffDistribution() {
    try {
        const response = await fetch('/admin/billing/api/tariff-distribution');
        const data = await response.json();
        
        if (data.success && data.distribution) {
            displayTariffDistribution(data.distribution);
        } else {
            document.getElementById('tariff-distribution').innerHTML = 
                '<div class="text-center text-muted"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p></div>';
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º:', error);
        document.getElementById('tariff-distribution').innerHTML = 
            '<div class="text-center text-danger"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
}

function displayTariffDistribution(distribution) {
    const container = document.getElementById('tariff-distribution');
    
    if (!distribution || Object.keys(distribution).length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p></div>';
        return;
    }
    
    let html = '<div class="list-group">';
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (—É–±—ã–≤–∞–Ω–∏–µ)
    const sortedTariffs = Object.entries(distribution)
        .sort((a, b) => b[1] - a[1]);
    
    sortedTariffs.forEach(([tariffName, count]) => {
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>${tariffName}</span>
                <span class="badge bg-primary rounded-pill">${count}</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayRecentTransactions(transactions) {
    const container = document.getElementById('recent-transactions');
    
    if (transactions.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p></div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th></tr></thead><tbody>';
    
    transactions.forEach(transaction => {
        const statusClass = `status-${transaction.status}`;
        const date = new Date(transaction.created_at).toLocaleDateString('ru-RU');
        
        html += `
            <tr>
                <td>#${transaction.id}</td>
                <td>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${transaction.user_id}</td>
                <td>${transaction.amount} ${transaction.currency}</td>
                <td><span class="status-badge ${statusClass}">${transaction.status}</span></td>
                <td>${date}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function updateMetricsFromServer(stats) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞
    document.getElementById('total-transactions').textContent = stats.total_transactions || 0;
    document.getElementById('total-revenue').textContent = `${(stats.total_revenue || 0).toFixed(2)} ‚ÇΩ`;
    document.getElementById('active-subscriptions').textContent = stats.active_subscriptions || 0;
    document.getElementById('pending-payments').textContent = stats.pending_payments || 0;
}

async function loadBillingWarnings() {
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –∏ —Ç.–¥.
}

function formatCurrency(amount, currency = 'RUB') {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: currency
    }).format(amount);
}
</script>
{% endblock %}
