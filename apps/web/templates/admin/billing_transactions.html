{% extends "admin/base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.transaction-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.transaction-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.status-completed { border-left-color: #28a745; }
.status-pending { border-left-color: #ffc107; }
.status-failed { border-left-color: #dc3545; }
.status-processing { border-left-color: #17a2b8; }
.status-cancelled { border-left-color: #6c757d; }

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-completed { background-color: #28a745; color: white; }
.status-pending { background-color: #ffc107; color: black; }
.status-failed { background-color: #dc3545; color: white; }
.status-processing { background-color: #17a2b8; color: white; }
.status-cancelled { background-color: #6c757d; color: white; }

.filter-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
}

.amount-display {
    font-size: 1.2rem;
    font-weight: bold;
}

.amount-positive { color: #28a745; }
.amount-negative { color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/admin/billing/">–ë–∏–ª–ª–∏–Ω–≥</a>
                    </li>
                    <li class="breadcrumb-item active">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="/admin/billing/" class="btn btn-secondary">
                ‚Üê –ö –±–∏–ª–ª–∏–Ω–≥—É
            </a>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filter-section">
        <h5>üîç –§–∏–ª—å—Ç—Ä—ã</h5>
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="user_id" class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                <input type="number" class="form-control" id="user_id" name="user_id" 
                       value="{{ selected_user_id or '' }}" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-control" id="status" name="status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                    <option value="processing">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                    <option value="failed">–ù–µ —É–¥–∞–ª–∞—Å—å</option>
                    <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="transaction_type" class="form-label">–¢–∏–ø</label>
                <select class="form-control" id="transaction_type" name="transaction_type">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="payment">–ü–ª–∞—Ç–µ–∂</option>
                    <option value="refund">–í–æ–∑–≤—Ä–∞—Ç</option>
                    <option value="credit">–ö—Ä–µ–¥–∏—Ç</option>
                    <option value="debit">–°–ø–∏—Å–∞–Ω–∏–µ</option>
                    <option value="adjustment">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -->
    <div class="row">
        {% for transaction in transactions %}
        <div class="col-md-6 mb-4">
            <div class="card transaction-card status-{{ transaction.status.value }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-credit-card"></i> 
                        –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è #{{ transaction.id }}
                    </h6>
                    <span class="status-badge status-{{ transaction.status.value }}">
                        {{ transaction.status.value | title }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h6>
                            <p class="mb-1"><strong>ID:</strong> {{ transaction.user_id }}</p>
                            <p class="mb-1"><strong>–ü–æ–¥–ø–∏—Å–∫–∞:</strong> {{ transaction.subscription_id or '–ù–µ—Ç' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>üí∞ –î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞</h6>
                            <p class="mb-1">
                                <span class="amount-display {% if transaction.transaction_type.value in ['payment', 'credit'] %}amount-positive{% else %}amount-negative{% endif %}">
                                    {% if transaction.transaction_type.value in ['payment', 'credit'] %}+{% else %}-{% endif %}{{ transaction.amount }} {{ transaction.currency }}
                                </span>
                            </p>
                            <p class="mb-1"><strong>–¢–∏–ø:</strong> {{ transaction.transaction_type.value | title }}</p>
                            <p class="mb-0"><strong>–°–ø–æ—Å–æ–±:</strong> {{ transaction.payment_method.value if transaction.payment_method else '–ù–µ —É–∫–∞–∑–∞–Ω' }}</p>
                        </div>
                    </div>
                    
                    {% if transaction.description %}
                    <div class="mt-3">
                        <h6>üìù –û–ø–∏—Å–∞–Ω–∏–µ</h6>
                        <p class="mb-0">{{ transaction.description }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <small class="text-muted">–°–æ–∑–¥–∞–Ω–∞:</small>
                            <p class="mb-0">{{ transaction.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                        </div>
                        <div class="col-md-6">
                            {% if transaction.processed_at %}
                            <small class="text-muted">–û–±—Ä–∞–±–æ—Ç–∞–Ω–∞:</small>
                            <p class="mb-0">{{ transaction.processed_at.strftime('%d.%m.%Y %H:%M') }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if transaction.expires_at and transaction.expires_at > now %}
                    <div class="mt-2">
                        <small class="text-warning">
                            <i class="bi bi-clock"></i> –ò—Å—Ç–µ–∫–∞–µ—Ç: {{ transaction.expires_at.strftime('%d.%m.%Y %H:%M') }}
                        </small>
                    </div>
                    {% endif %}
                    
                    {% if transaction.external_id %}
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="bi bi-link"></i> –í–Ω–µ—à–Ω–∏–π ID: {{ transaction.external_id }}
                        </small>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <div class="btn-group w-100">
                        {% if transaction.status.value == 'pending' %}
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                onclick="updateTransactionStatus({{ transaction.id }}, 'completed')">
                            <i class="bi bi-check-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="updateTransactionStatus({{ transaction.id }}, 'failed')">
                            <i class="bi bi-x-circle"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                        {% endif %}
                        
                        {% if transaction.status.value == 'processing' %}
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                onclick="updateTransactionStatus({{ transaction.id }}, 'completed')">
                            <i class="bi bi-check-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                onclick="updateTransactionStatus({{ transaction.id }}, 'pending')">
                            <i class="bi bi-arrow-counterclockwise"></i> –í –æ–∂–∏–¥–∞–Ω–∏–µ
                        </button>
                        {% endif %}
                        
                        <a href="/admin/billing/transactions?user_id={{ transaction.user_id }}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-person"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <h5>üìã –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h5>
                <p>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                {% if selected_user_id %}
                <a href="/admin/billing/transactions" class="btn btn-primary">
                    –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if transactions %}
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π">
            <ul class="pagination">
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="–°–ª–µ–¥—É—é—â–∞—è">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
function updateTransactionStatus(transactionId, newStatus) {
    const statusNames = {
        'completed': '–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π',
        'failed': '–æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω–æ–π',
        'pending': '–æ–∂–∏–¥–∞—é—â–µ–π',
        'cancelled': '–æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–π'
    };
    
    const statusName = statusNames[newStatus] || newStatus;
    
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ "${statusName}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/billing/transactions/${transactionId}/status`;
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = newStatus;
        form.appendChild(statusInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
