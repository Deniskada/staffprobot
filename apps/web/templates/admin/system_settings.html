{% extends "admin/base_admin.html" %}

{% block title %}Системные настройки - StaffProBot - Администратор{% endblock %}

{% block admin_content %}
<div class="row">
    <div class="col-12">
        <h2 class="h4 mb-4">
            <i class="bi bi-gear me-2"></i>
            Системные настройки
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Настройки домена -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-globe me-2"></i>
                    Настройки домена
                </h5>
            </div>
            <div class="card-body">
                <form id="domainForm">
                    <div class="mb-3">
                        <label for="domain" class="form-label">Домен системы</label>
                        <input type="text" class="form-control" id="domain" name="domain" 
                               placeholder="example.com" required>
                        <div class="form-text">Введите домен без протокола (например: example.com)</div>
                        <div id="domainValidation" class="invalid-feedback"></div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useHttps" name="use_https">
                            <label class="form-check-label" for="useHttps">
                                Использовать HTTPS
                            </label>
                        </div>
                        <div class="form-text">Включить защищенное соединение</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sslEmail" class="form-label">Email для SSL сертификатов</label>
                        <input type="email" class="form-control" id="sslEmail" name="ssl_email" 
                               placeholder="admin@example.com">
                        <div class="form-text">Email для получения Let's Encrypt сертификатов</div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>
                            Сохранить настройки
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="validateDomain()">
                            <i class="bi bi-check-circle me-1"></i>
                            Проверить домен
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="previewConfig()">
                            <i class="bi bi-eye me-1"></i>
                            Предпросмотр
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Nginx Configuration Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-server me-2"></i>
                    Конфигурация Nginx
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Управление конфигурацией</h6>
                        <div class="btn-group-vertical d-grid gap-2" role="group">
                            <button type="button" class="btn btn-outline-info" id="previewNginxBtn">
                                <i class="bi bi-eye me-1"></i>
                                Предпросмотр конфигурации
                            </button>
                            <button type="button" class="btn btn-outline-success" id="generateNginxBtn">
                                <i class="bi bi-file-earmark-code me-1"></i>
                                Генерировать конфигурацию
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="validateNginxBtn">
                                <i class="bi bi-check-circle me-1"></i>
                                Валидировать конфигурацию
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="applyNginxBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Применить конфигурацию
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Статус Nginx</h6>
                        <button type="button" class="btn btn-outline-secondary mb-2" id="checkNginxStatusBtn">
                            <i class="bi bi-arrow-repeat me-1"></i>
                            Проверить статус
                        </button>
                        <div id="nginxStatus" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- Nginx Configuration Preview -->
                <div id="nginxPreview" class="mt-4" style="display: none;">
                    <h6>Предпросмотр конфигурации Nginx</h6>
                    <pre class="bg-light p-3 rounded"><code id="nginxConfigContent"></code></pre>
                </div>
                
                <!-- Nginx Backups Management -->
                <div class="mt-4">
                    <h6>Управление backup'ами конфигурации</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-info btn-sm" id="listNginxBackupsBtn">
                                <i class="bi bi-list me-1"></i>
                                Показать backup'ы
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-warning btn-sm" id="createNginxBackupBtn">
                                <i class="bi bi-plus-circle me-1"></i>
                                Создать backup
                            </button>
                        </div>
                    </div>
                    
                    <div id="nginxBackupsList" class="mt-3" style="display: none;">
                        <h6>Список backup'ов:</h6>
                        <div id="nginxBackupsContent"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SSL Monitoring Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check me-2"></i>
                    Мониторинг SSL
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Статус SSL</h6>
                        <div class="btn-group-vertical d-grid gap-2" role="group">
                            <button type="button" class="btn btn-outline-info" id="checkSslStatusBtn">
                                <i class="bi bi-shield-check me-1"></i>
                                Проверить статус SSL
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="checkSslAlertsBtn">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Показать алерты
                            </button>
                            <button type="button" class="btn btn-outline-success" id="renewSslBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Обновить сертификаты
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Информация о сертификате</h6>
                        <div id="sslStatus" class="mt-2"></div>
                        <div id="sslAlerts" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- SSL Statistics -->
                <div id="sslStatistics" class="mt-4" style="display: none;">
                    <h6>Статистика SSL</h6>
                    <div class="row" id="sslStatsContent"></div>
                </div>
            </div>
        </div>

        <!-- Предварительный просмотр конфигурации -->
        <div class="card mb-4" id="configPreview" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-eye me-2"></i>
                    Предварительный просмотр конфигурации
                </h5>
            </div>
            <div class="card-body">
                <div id="configContent">
                    <!-- Контент будет загружен через AJAX -->
                </div>
            </div>
        </div>

        <!-- История изменений -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    История изменений
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Настройка</th>
                                <th>Старое значение</th>
                                <th>Новое значение</th>
                                <th>Дата изменения</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    История изменений будет отображаться здесь
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Текущие настройки -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Текущие настройки
                </h5>
            </div>
            <div class="card-body">
                <div id="currentSettings">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Быстрые действия -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning me-2"></i>
                    Быстрые действия
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="loadCurrentSettings()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Обновить настройки
                    </button>
                    <button class="btn btn-outline-warning" onclick="clearCache()">
                        <i class="bi bi-trash me-1"></i>
                        Очистить кэш
                    </button>
                    <button class="btn btn-outline-info" onclick="initializeSettings()">
                        <i class="bi bi-gear me-1"></i>
                        Инициализировать по умолчанию
                    </button>
                </div>
            </div>
        </div>

        <!-- Статус системы -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-activity me-2"></i>
                    Статус системы
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Домен:</strong> 
                    <span id="statusDomain" class="text-muted">Загрузка...</span>
                </div>
                <div class="mb-2">
                    <strong>Протокол:</strong> 
                    <span id="statusProtocol" class="text-muted">Загрузка...</span>
                </div>
                <div class="mb-2">
                    <strong>SSL:</strong> 
                    <span id="statusSSL" class="text-muted">Загрузка...</span>
                </div>
                <div class="mb-2">
                    <strong>Кэш:</strong> 
                    <span id="statusCache" class="badge bg-success">Активен</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Загрузка текущих настроек при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentSettings();
});

// Загрузка текущих настроек
async function loadCurrentSettings() {
    try {
        const response = await fetch('/api/system-settings/all');
        const data = await response.json();
        
        if (data.success) {
            const settings = data.settings;
            
            // Заполняем форму
            document.getElementById('domain').value = settings.domain || '';
            document.getElementById('useHttps').checked = settings.use_https === 'true';
            document.getElementById('sslEmail').value = settings.ssl_email || '';
            
            // Обновляем статус
            updateStatus(settings);
            
            // Обновляем текущие настройки
            updateCurrentSettings(settings);
        }
    } catch (error) {
        console.error('Error loading settings:', error);
        showNotification('Ошибка загрузки настроек', 'error');
    }
}

// Обновление статуса системы
function updateStatus(settings) {
    document.getElementById('statusDomain').textContent = settings.domain || 'Не установлен';
    document.getElementById('statusProtocol').textContent = settings.use_https === 'true' ? 'HTTPS' : 'HTTP';
    document.getElementById('statusSSL').textContent = settings.use_https === 'true' ? 'Включен' : 'Отключен';
}

// Обновление блока текущих настроек
function updateCurrentSettings(settings) {
    const container = document.getElementById('currentSettings');
    container.innerHTML = `
        <div class="mb-2">
            <strong>Домен:</strong> ${settings.domain || 'Не установлен'}
        </div>
        <div class="mb-2">
            <strong>Протокол:</strong> ${settings.use_https === 'true' ? 'HTTPS' : 'HTTP'}
        </div>
        <div class="mb-2">
            <strong>SSL Email:</strong> ${settings.ssl_email || 'Не установлен'}
        </div>
        <div class="mb-2">
            <strong>Nginx Path:</strong> ${settings.nginx_config_path || '/etc/nginx/sites-available'}
        </div>
        <div class="mb-2">
            <strong>Certbot Path:</strong> ${settings.certbot_path || '/usr/bin/certbot'}
        </div>
    `;
}

// Валидация домена
async function validateDomain() {
    const domain = document.getElementById('domain').value;
    
    if (!domain) {
        showNotification('Введите домен для проверки', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/system-settings/domain/validate?domain=${encodeURIComponent(domain)}`);
        const data = await response.json();
        
        if (data.valid) {
            showNotification('Домен валиден', 'success');
        } else {
            showNotification(`Домен невалиден: ${data.errors.join(', ')}`, 'error');
        }
    } catch (error) {
        console.error('Error validating domain:', error);
        showNotification('Ошибка валидации домена', 'error');
    }
}

// Предварительный просмотр конфигурации
async function previewConfig() {
    try {
        const response = await fetch('/api/system-settings/domain/preview');
        const data = await response.json();
        
        if (data.success) {
            const config = data.config;
            const preview = document.getElementById('configPreview');
            const content = document.getElementById('configContent');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Основные URL:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Базовый URL:</strong> ${config.base_url}</li>
                            <li><strong>Веб-интерфейс:</strong> ${config.web_url}</li>
                            <li><strong>API:</strong> ${config.api_url}</li>
                            <li><strong>Админка:</strong> ${config.admin_url}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Интерфейсы:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Управляющий:</strong> ${config.manager_url}</li>
                            <li><strong>Сотрудник:</strong> ${config.employee_url}</li>
                            <li><strong>Webhook:</strong> ${config.bot_webhook_url}</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>SSL настройки:</h6>
                    <ul class="list-unstyled">
                        <li><strong>SSL включен:</strong> ${config.ssl_enabled ? 'Да' : 'Нет'}</li>
                        <li><strong>SSL Email:</strong> ${config.ssl_email}</li>
                    </ul>
                </div>
            `;
            
            preview.style.display = 'block';
        }
    } catch (error) {
        console.error('Error previewing config:', error);
        showNotification('Ошибка предварительного просмотра', 'error');
    }
}

// Сохранение настроек
document.getElementById('domainForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const domain = formData.get('domain');
    const useHttps = formData.get('use_https') === 'on';
    const sslEmail = formData.get('ssl_email');
    
    try {
        // Обновляем домен
        const domainResponse = await fetch('/api/system-settings/domain', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ domain: domain })
        });
        const domainData = await domainResponse.json();
        
        if (!domainData.success) {
            showNotification(`Ошибка обновления домена: ${domainData.message}`, 'error');
            return;
        }
        
        // Обновляем настройку HTTPS
        const httpsResponse = await fetch('/api/system-settings/https', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ use_https: useHttps })
        });
        const httpsData = await httpsResponse.json();
        
        if (!httpsData.success) {
            showNotification(`Ошибка обновления HTTPS: ${httpsData.message}`, 'error');
            return;
        }
        
        // Обновляем SSL email
        if (sslEmail) {
            const emailResponse = await fetch('/api/system-settings/ssl/email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: sslEmail })
            });
            const emailData = await emailResponse.json();
            
            if (!emailData.success) {
                showNotification(`Ошибка обновления email: ${emailData.message}`, 'error');
                return;
            }
        }
        
        showNotification('Настройки успешно сохранены', 'success');
        loadCurrentSettings();
        
    } catch (error) {
        console.error('Error saving settings:', error);
        showNotification('Ошибка сохранения настроек', 'error');
    }
});

// Очистка кэша
async function clearCache() {
    try {
        const response = await fetch('/api/system-settings/cache/clear', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Кэш успешно очищен', 'success');
        } else {
            showNotification(`Ошибка очистки кэша: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('Error clearing cache:', error);
        showNotification('Ошибка очистки кэша', 'error');
    }
}

// Инициализация настроек по умолчанию
async function initializeSettings() {
    if (!confirm('Вы уверены, что хотите инициализировать настройки по умолчанию?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/system-settings/initialize', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Настройки по умолчанию инициализированы', 'success');
            loadCurrentSettings();
        } else {
            showNotification(`Ошибка инициализации: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('Error initializing settings:', error);
        showNotification('Ошибка инициализации настроек', 'error');
    }
}

// Показ уведомлений
function showNotification(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Добавляем уведомление в начало страницы
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alert, container.firstChild);
    
    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Nginx функции
document.addEventListener('DOMContentLoaded', function() {
    // Предпросмотр конфигурации Nginx
    document.getElementById('previewNginxBtn').addEventListener('click', async function() {
        const domain = document.getElementById('domain').value;
        const useHttps = document.getElementById('useHttps').checked;
        
        if (!domain) {
            showNotification('Введите домен для предпросмотра', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/system-settings/nginx/preview?domain=${encodeURIComponent(domain)}&use_https=${useHttps}`);
            const data = await response.json();
            
            if (data.preview) {
                document.getElementById('nginxConfigContent').textContent = data.preview;
                document.getElementById('nginxPreview').style.display = 'block';
                showNotification('Предпросмотр конфигурации загружен', 'success');
            } else {
                showNotification('Ошибка загрузки предпросмотра', 'error');
            }
        } catch (error) {
            console.error('Error previewing nginx config:', error);
            showNotification('Ошибка загрузки предпросмотра', 'error');
        }
    });
    
    // Генерация конфигурации Nginx
    document.getElementById('generateNginxBtn').addEventListener('click', async function() {
        const domain = document.getElementById('domain').value;
        const useHttps = document.getElementById('useHttps').checked;
        
        if (!domain) {
            showNotification('Введите домен для генерации', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/system-settings/nginx/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain: domain, use_https: useHttps })
            });
            const data = await response.json();
            
            if (data.message) {
                showNotification(data.message, 'success');
            } else {
                showNotification('Ошибка генерации конфигурации', 'error');
            }
        } catch (error) {
            console.error('Error generating nginx config:', error);
            showNotification('Ошибка генерации конфигурации', 'error');
        }
    });
    
    // Валидация конфигурации Nginx
    document.getElementById('validateNginxBtn').addEventListener('click', async function() {
        const domain = document.getElementById('domain').value;
        const useHttps = document.getElementById('useHttps').checked;
        
        if (!domain) {
            showNotification('Введите домен для валидации', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/system-settings/nginx/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain: domain, use_https: useHttps })
            });
            const data = await response.json();
            
            if (data.valid) {
                showNotification('Конфигурация Nginx валидна', 'success');
            } else {
                showNotification(`Конфигурация Nginx невалидна: ${data.message}`, 'error');
            }
        } catch (error) {
            console.error('Error validating nginx config:', error);
            showNotification('Ошибка валидации конфигурации', 'error');
        }
    });
    
    // Применение конфигурации Nginx
    document.getElementById('applyNginxBtn').addEventListener('click', async function() {
        const domain = document.getElementById('domain').value;
        
        if (!domain) {
            showNotification('Введите домен для применения', 'warning');
            return;
        }
        
        if (!confirm('Вы уверены, что хотите применить конфигурацию Nginx? Это может повлиять на работу сайта.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/system-settings/nginx/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain: domain })
            });
            const data = await response.json();
            
            if (data.message) {
                showNotification(data.message, 'success');
            } else {
                showNotification('Ошибка применения конфигурации', 'error');
            }
        } catch (error) {
            console.error('Error applying nginx config:', error);
            showNotification('Ошибка применения конфигурации', 'error');
        }
    });
    
    // Проверка статуса Nginx
    document.getElementById('checkNginxStatusBtn').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/system-settings/nginx/status');
            const data = await response.json();
            
            const statusDiv = document.getElementById('nginxStatus');
            let statusHtml = '';
            
            if (data.is_active) {
                statusHtml += '<span class="badge bg-success">Активен</span>';
            } else {
                statusHtml += '<span class="badge bg-danger">Неактивен</span>';
            }
            
            if (data.config_valid) {
                statusHtml += ' <span class="badge bg-success">Конфигурация валидна</span>';
            } else {
                statusHtml += ' <span class="badge bg-warning">Конфигурация невалидна</span>';
            }
            
            if (data.status_output) {
                statusHtml += `<div class="mt-2"><small class="text-muted">${data.status_output}</small></div>`;
            }
            
            if (data.config_output) {
                statusHtml += `<div class="mt-1"><small class="text-muted">${data.config_output}</small></div>`;
            }
            
            statusDiv.innerHTML = statusHtml;
            showNotification('Статус Nginx обновлен', 'info');
        } catch (error) {
            console.error('Error checking nginx status:', error);
            showNotification('Ошибка проверки статуса Nginx', 'error');
        }
    });
    
    // Nginx Backups функции
    // Показать список backup'ов
    document.getElementById('listNginxBackupsBtn').addEventListener('click', async function() {
        const domain = document.getElementById('domain').value;
        
        if (!domain) {
            showNotification('Введите домен для просмотра backup\'ов', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/system-settings/nginx/backups?domain=${encodeURIComponent(domain)}`);
            const data = await response.json();
            
            const backupsDiv = document.getElementById('nginxBackupsContent');
            let backupsHtml = '';
            
            if (data.backups && data.backups.length > 0) {
                backupsHtml = '<div class="table-responsive"><table class="table table-sm">';
                backupsHtml += '<thead><tr><th>Файл</th><th>Дата создания</th><th>Размер</th><th>Действия</th></tr></thead><tbody>';
                
                data.backups.forEach(backup => {
                    const createdDate = new Date(backup.created_at).toLocaleString('ru-RU');
                    const sizeKB = Math.round(backup.size / 1024);
                    
                    backupsHtml += `
                        <tr>
                            <td><code>${backup.filename}</code></td>
                            <td>${createdDate}</td>
                            <td>${sizeKB} KB</td>
                            <td>
                                <button class="btn btn-outline-success btn-sm me-1" onclick="restoreNginxBackup('${backup.filename}')">
                                    <i class="bi bi-arrow-clockwise"></i> Восстановить
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteNginxBackup('${backup.filename}')">
                                    <i class="bi bi-trash"></i> Удалить
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                backupsHtml += '</tbody></table></div>';
            } else {
                backupsHtml = '<div class="alert alert-info">Нет backup\'ов конфигурации для этого домена</div>';
            }
            
            backupsDiv.innerHTML = backupsHtml;
            document.getElementById('nginxBackupsList').style.display = 'block';
            showNotification('Список backup\'ов загружен', 'info');
            
        } catch (error) {
            console.error('Error listing nginx backups:', error);
            showNotification('Ошибка загрузки списка backup\'ов', 'error');
        }
    });
    
    // Создать backup
    document.getElementById('createNginxBackupBtn').addEventListener('click', async function() {
        const domain = document.getElementById('domain').value;
        
        if (!domain) {
            showNotification('Введите домен для создания backup\'а', 'warning');
            return;
        }
        
        try {
            // Создаем backup через генерацию новой конфигурации
            const useHttps = document.getElementById('useHttps').checked;
            const response = await fetch('/api/system-settings/nginx/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain: domain, use_https: useHttps })
            });
            const data = await response.json();
            
            if (data.message) {
                showNotification('Backup конфигурации создан', 'success');
                // Обновляем список backup'ов
                document.getElementById('listNginxBackupsBtn').click();
            } else {
                showNotification('Ошибка создания backup\'а', 'error');
            }
        } catch (error) {
            console.error('Error creating nginx backup:', error);
            showNotification('Ошибка создания backup\'а', 'error');
        }
    });
    
    // Восстановить из backup'а
    window.restoreNginxBackup = async function(backupFilename) {
        const domain = document.getElementById('domain').value;
        
        if (!confirm(`Вы уверены, что хотите восстановить конфигурацию из backup'а ${backupFilename}?`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/system-settings/nginx/backups/restore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain: domain, backup_filename: backupFilename })
            });
            const data = await response.json();
            
            if (data.message) {
                showNotification(data.message, 'success');
                // Обновляем список backup'ов
                document.getElementById('listNginxBackupsBtn').click();
            } else {
                showNotification('Ошибка восстановления из backup\'а', 'error');
            }
        } catch (error) {
            console.error('Error restoring nginx backup:', error);
            showNotification('Ошибка восстановления из backup\'а', 'error');
        }
    };
    
    // Удалить backup
    window.deleteNginxBackup = async function(backupFilename) {
        const domain = document.getElementById('domain').value;
        
        if (!confirm(`Вы уверены, что хотите удалить backup ${backupFilename}?`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/system-settings/nginx/backups/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain: domain, backup_filename: backupFilename })
            });
            const data = await response.json();
            
            if (data.message) {
                showNotification(data.message, 'success');
                // Обновляем список backup'ов
                document.getElementById('listNginxBackupsBtn').click();
            } else {
                showNotification('Ошибка удаления backup\'а', 'error');
            }
        } catch (error) {
            console.error('Error deleting nginx backup:', error);
            showNotification('Ошибка удаления backup\'а', 'error');
        }
    };
    
    // SSL Monitoring функции
    // Проверка статуса SSL
    document.getElementById('checkSslStatusBtn').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/system-settings/ssl/monitoring/status');
            const data = await response.json();
            
            const statusDiv = document.getElementById('sslStatus');
            let statusHtml = '';
            
            // Статус сертификата
            const status = data.status || 'unknown';
            const criticality = data.criticality || 'low';
            
            let statusBadge = '';
            if (status === 'healthy') {
                statusBadge = '<span class="badge bg-success">Здоровый</span>';
            } else if (status === 'expiring_soon') {
                statusBadge = '<span class="badge bg-warning">Истекает скоро</span>';
            } else if (status === 'expired') {
                statusBadge = '<span class="badge bg-danger">Истек</span>';
            } else if (status === 'no_certificate') {
                statusBadge = '<span class="badge bg-secondary">Нет сертификата</span>';
            } else {
                statusBadge = '<span class="badge bg-dark">Неизвестно</span>';
            }
            
            statusHtml += `<div class="mb-2">${statusBadge}</div>`;
            
            // Информация о сертификате
            const certInfo = data.certificate_info || {};
            if (certInfo.days_remaining !== undefined) {
                statusHtml += `<div class="mb-1"><strong>Дней до истечения:</strong> ${certInfo.days_remaining}</div>`;
            }
            if (certInfo.expiry_date) {
                statusHtml += `<div class="mb-1"><strong>Дата истечения:</strong> ${certInfo.expiry_date}</div>`;
            }
            if (certInfo.domains) {
                statusHtml += `<div class="mb-1"><strong>Домены:</strong> ${certInfo.domains.join(', ')}</div>`;
            }
            
            // Рекомендации
            const recommendations = data.recommendations || [];
            if (recommendations.length > 0) {
                statusHtml += '<div class="mt-3"><strong>Рекомендации:</strong><ul class="mb-0">';
                recommendations.forEach(rec => {
                    statusHtml += `<li>${rec}</li>`;
                });
                statusHtml += '</ul></div>';
            }
            
            statusDiv.innerHTML = statusHtml;
            showNotification('Статус SSL обновлен', 'info');
            
        } catch (error) {
            console.error('Error checking SSL status:', error);
            showNotification('Ошибка проверки статуса SSL', 'error');
        }
    });
    
    // Показать алерты SSL
    document.getElementById('checkSslAlertsBtn').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/system-settings/ssl/monitoring/alerts');
            const data = await response.json();
            
            const alertsDiv = document.getElementById('sslAlerts');
            let alertsHtml = '';
            
            if (data.alerts && data.alerts.length > 0) {
                alertsHtml = '<h6>Алерты SSL:</h6>';
                data.alerts.forEach(alert => {
                    let alertClass = 'alert-info';
                    if (alert.type === 'critical') alertClass = 'alert-danger';
                    else if (alert.type === 'warning') alertClass = 'alert-warning';
                    else if (alert.type === 'error') alertClass = 'alert-danger';
                    
                    alertsHtml += `
                        <div class="alert ${alertClass} alert-sm mb-2">
                            <strong>${alert.type.toUpperCase()}:</strong> ${alert.message}
                            <br><small class="text-muted">${alert.timestamp}</small>
                        </div>
                    `;
                });
            } else {
                alertsHtml = '<div class="alert alert-success alert-sm">Нет активных алертов SSL</div>';
            }
            
            alertsDiv.innerHTML = alertsHtml;
            alertsDiv.style.display = 'block';
            showNotification('Алерты SSL загружены', 'info');
            
        } catch (error) {
            console.error('Error getting SSL alerts:', error);
            showNotification('Ошибка получения алертов SSL', 'error');
        }
    });
    
    // Обновление SSL сертификатов
    document.getElementById('renewSslBtn').addEventListener('click', async function() {
        if (!confirm('Вы уверены, что хотите обновить SSL сертификаты? Это может занять некоторое время.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/system-settings/ssl/monitoring/renew', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('SSL сертификаты успешно обновлены', 'success');
            } else {
                showNotification(`Ошибка обновления SSL: ${data.message}`, 'error');
            }
            
        } catch (error) {
            console.error('Error renewing SSL:', error);
            showNotification('Ошибка обновления SSL сертификатов', 'error');
        }
    });
});
</script>
{% endblock %}
