{% extends "admin/base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.report-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
}

.users-table {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.table th {
    background: #f8f9fa;
    border: none;
    font-weight: 600;
}

.table td {
    border: none;
    border-bottom: 1px solid #f1f3f4;
    vertical-align: middle;
}

.role-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.role-owner { background-color: #d4edda; color: #155724; }
.role-manager { background-color: #cce5ff; color: #004085; }
.role-employee { background-color: #fff3cd; color: #856404; }
.role-superadmin { background-color: #f8d7da; color: #721c24; }

.status-active { color: #28a745; }
.status-inactive { color: #dc3545; }

.export-section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.summary-stats {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.stat-item {
    text-align: center;
    padding: 15px;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin: 0;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á–µ—Ç–∞ -->
    <div class="report-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2>{{ title }}</h2>
                <p class="mb-0">
                    {% if filters.start_date or filters.end_date %}
                    –ü–µ—Ä–∏–æ–¥: 
                    {% if filters.start_date %}{{ filters.start_date }}{% else %}—Å –Ω–∞—á–∞–ª–∞{% endif %} - 
                    {% if filters.end_date %}{{ filters.end_date }}{% else %}–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è{% endif %}
                    {% else %}
                    –ó–∞ –≤—Å–µ –≤—Ä–µ–º—è
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/admin/reports/" class="btn btn-light">
                    ‚Üê –ö –æ—Ç—á–µ—Ç–∞–º
                </a>
            </div>
        </div>
    </div>

    <!-- –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    {% if report_data.summary %}
    <div class="summary-stats">
        <div class="row">
            <div class="col-md-3">
                <div class="stat-item">
                    <p class="stat-number text-primary">{{ report_data.summary.total_users }}</p>
                    <p class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <p class="stat-number text-success">{{ report_data.summary.active_users }}</p>
                    <p class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <p class="stat-number text-danger">{{ report_data.summary.inactive_users }}</p>
                    <p class="stat-label">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <p class="stat-number text-info">{{ report_data.roles_distribution | length }}</p>
                    <p class="stat-label">–†–æ–ª–µ–π</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filter-section">
        <h5>üîç –§–∏–ª—å—Ç—Ä—ã</h5>
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="start_date" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                <input type="date" class="form-control" id="start_date" name="start_date" 
                       value="{{ filters.start_date or '' }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                <input type="date" class="form-control" id="end_date" name="end_date" 
                       value="{{ filters.end_date or '' }}">
            </div>
            <div class="col-md-3">
                <label for="role" class="form-label">–†–æ–ª—å</label>
                <select class="form-control" id="role" name="role">
                    <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                    <option value="owner" {% if filters.role == 'owner' %}selected{% endif %}>–í–ª–∞–¥–µ–ª–µ—Ü</option>
                    <option value="manager" {% if filters.role == 'manager' %}selected{% endif %}>–£–ø—Ä–∞–≤–ª—è—é—â–∏–π</option>
                    <option value="employee" {% if filters.role == 'employee' %}selected{% endif %}>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</option>
                    <option value="superadmin" {% if filters.role == 'superadmin' %}selected{% endif %}>–°—É–ø–µ—Ä–∞–¥–º–∏–Ω</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
    <div class="export-section">
        <h5>üìä –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞</h5>
        <div class="row">
            <div class="col-md-4">
                <a href="/admin/reports/export/users.csv?{% if filters.start_date %}start_date={{ filters.start_date }}&{% endif %}{% if filters.end_date %}end_date={{ filters.end_date }}&{% endif %}{% if filters.role %}role={{ filters.role }}{% endif %}" 
                   class="btn btn-success">
                    <i class="bi bi-file-earmark-spreadsheet"></i> –°–∫–∞—á–∞—Ç—å CSV
                </a>
            </div>
            <div class="col-md-4">
                <button type="button" class="btn btn-info" onclick="alert('PDF —ç–∫—Å–ø–æ—Ä—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ')">
                    <i class="bi bi-file-earmark-pdf"></i> –°–∫–∞—á–∞—Ç—å PDF
                </button>
            </div>
            <div class="col-md-4">
                <button type="button" class="btn btn-warning" onclick="printReport()">
                    <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="users-table">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Telegram</th>
                    <th>–ò–º—è</th>
                    <th>–†–æ–ª—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in report_data.users %}
                <tr>
                    <td><strong>{{ user.id }}</strong></td>
                    <td>
                        <div>
                            <strong>
                                {% if user.username %}
                                    {% if user.username.startswith('@') %}
                                        {{ user.username }}
                                    {% else %}
                                        @{{ user.username }}
                                    {% endif %}
                                {% else %}
                                    –Ω–µ —É–∫–∞–∑–∞–Ω
                                {% endif %}
                            </strong>
                            <br><small class="text-muted">ID: {{ user.telegram_id }}</small>
                        </div>
                    </td>
                    <td>
                        {{ user.first_name or '' }} {{ user.last_name or '' }}
                        {% if user.email %}
                        <br><small class="text-muted">{{ user.email }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="role-badge role-{{ user.role }}">
                            {% if user.role == 'owner' %}–í–ª–∞–¥–µ–ª–µ—Ü
                            {% elif user.role == 'manager' %}–£–ø—Ä–∞–≤–ª—è—é—â–∏–π
                            {% elif user.role == 'employee' %}–°–æ—Ç—Ä—É–¥–Ω–∏–∫
                            {% elif user.role == 'superadmin' %}–°—É–ø–µ—Ä–∞–¥–º–∏–Ω
                            {% else %}{{ user.role | title }}
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <span class="status-{{ 'active' if user.is_active else 'inactive' }}">
                            <i class="bi bi-circle-fill"></i>
                            {{ '–ê–∫—Ç–∏–≤–µ–Ω' if user.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                        </span>
                    </td>
                    <td>
                        {% if user.created_at %}
                        {{ user.created_at[:10] }}
                        <br><small class="text-muted">{{ user.created_at[11:16] }}</small>
                        {% else %}
                        –ù–µ —É–∫–∞–∑–∞–Ω–∞
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            {% if user.role == 'owner' %}
                            <a href="/admin/reports/owners?user_id={{ user.id }}" class="btn btn-outline-info" title="–û–±—ä–µ–∫—Ç—ã">
                                <i class="bi bi-building"></i>
                            </a>
                            {% endif %}
                            <a href="/admin/billing/transactions?user_id={{ user.id }}" class="btn btn-outline-success" title="–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏">
                                <i class="bi bi-credit-card"></i>
                            </a>
                            <button type="button" class="btn btn-outline-warning" title="–°–≤—è–∑–∞—Ç—å—Å—è">
                                <i class="bi bi-envelope"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-people fs-1"></i>
                        <p class="mb-0">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º -->
    {% if report_data.roles_distribution %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º</h6>
                </div>
                <div class="card-body">
                    {% for role, count in report_data.roles_distribution.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="role-badge role-{{ role }}">
                            {% if role == 'owner' %}–í–ª–∞–¥–µ–ª—å—Ü—ã
                            {% elif role == 'manager' %}–£–ø—Ä–∞–≤–ª—è—é—â–∏–µ
                            {% elif role == 'employee' %}–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
                            {% elif role == 'superadmin' %}–°—É–ø–µ—Ä–∞–¥–º–∏–Ω—ã
                            {% else %}{{ role | title }}
                            {% endif %}
                        </span>
                        <strong>{{ count }}</strong>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º</h6>
                </div>
                <div class="card-body">
                    {% for month, count in report_data.monthly_registrations.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ month }}</span>
                        <strong>{{ count }}</strong>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if report_data.users %}
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
            <ul class="pagination">
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="–°–ª–µ–¥—É—é—â–∞—è">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
function printReport() {
    window.print();
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(() => {
    if (!document.hidden) {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    }
}, 5 * 60 * 1000);
</script>
{% endblock %}
