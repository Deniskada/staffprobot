{% extends "admin/base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.user-limits-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.user-limits-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.user-limits-card.has-warnings { border-left-color: #ffc107; }
.user-limits-card.over-limit { border-left-color: #dc3545; }

.limit-bar {
    height: 20px;
    border-radius: 10px;
    background: #e9ecef;
    overflow: hidden;
    margin-bottom: 10px;
}

.limit-fill {
    height: 100%;
    transition: all 0.3s ease;
    border-radius: 10px;
}

.limit-fill.ok { background: #28a745; }
.limit-fill.warning { background: #ffc107; }
.limit-fill.danger { background: #dc3545; }

.user-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-ok { background-color: #d4edda; color: #155724; }
.status-warning { background-color: #fff3cd; color: #856404; }
.status-danger { background-color: #f8d7da; color: #721c24; }

.filter-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
}

.quick-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin: 0;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ title }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/admin/billing/">–ë–∏–ª–ª–∏–Ω–≥</a>
                    </li>
                    <li class="breadcrumb-item active">–õ–∏–º–∏—Ç—ã</li>
                </ol>
            </nav>
        </div>
        <div>
            <button type="button" class="btn btn-outline-primary" onclick="refreshOverview()">
                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <a href="/admin/billing/" class="btn btn-secondary">
                ‚Üê –ö –±–∏–ª–ª–∏–Ω–≥—É
            </a>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="quick-stats">
        <div class="row">
            <div class="col-md-3">
                <div class="stat-item">
                    <p class="stat-number" id="total-users">{{ user_limits | length }}</p>
                    <p class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <p class="stat-number" id="over-limit-users">-</p>
                    <p class="stat-label">–ü—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç—ã</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <p class="stat-number" id="warning-users">-</p>
                    <p class="stat-label">–° –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <p class="stat-number" id="expiring-users">-</p>
                    <p class="stat-label">–ü–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç–µ–∫–∞—é—Ç</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filter-section">
        <h5>üîç –§–∏–ª—å—Ç—Ä—ã</h5>
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="tariff" class="form-label">–¢–∞—Ä–∏—Ñ</label>
                <select class="form-control" id="tariff" name="tariff">
                    <option value="">–í—Å–µ —Ç–∞—Ä–∏—Ñ—ã</option>
                    <option value="–ë–∞–∑–æ–≤—ã–π">–ë–∞–∑–æ–≤—ã–π</option>
                    <option value="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</option>
                    <option value="–ü—Ä–µ–º–∏—É–º">–ü—Ä–µ–º–∏—É–º</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å –ª–∏–º–∏—Ç–æ–≤</label>
                <select class="form-control" id="status" name="status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="ok">–í –Ω–æ—Ä–º–µ</option>
                    <option value="warning">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</option>
                    <option value="over">–ü—Ä–µ–≤—ã—à–µ–Ω—ã</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="payment_status" class="form-label">–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–µ–π</label>
                <select class="form-control" id="payment_status" name="payment_status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="paid">–û–ø–ª–∞—á–µ–Ω–æ</option>
                    <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                    <option value="failed">–ù–µ —É–¥–∞–ª–æ—Å—å</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ª–∏–º–∏—Ç–∞–º–∏ -->
    {% for user_limit in user_limits %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card user-limits-card {% if user_limit.warnings %}has-warnings{% elif not user_limit.limits.objects.allowed or not user_limit.limits.employees.allowed %}over-limit{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-person-circle"></i> 
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{ user_limit.subscription.user_id }}
                    </h6>
                    <div>
                        <span class="badge bg-primary">{{ user_limit.subscription.tariff_name }}</span>
                        {% if user_limit.warnings %}
                        <span class="badge bg-warning">
                            <i class="bi bi-exclamation-triangle"></i> –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                        </span>
                        {% endif %}
                        {% if not user_limit.limits.objects.allowed or not user_limit.limits.employees.allowed %}
                        <span class="badge bg-danger">
                            <i class="bi bi-x-circle"></i> –õ–∏–º–∏—Ç—ã –ø—Ä–µ–≤—ã—à–µ–Ω—ã
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                    <div class="user-info">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                                <p class="mb-1"><strong>ID:</strong> {{ user_limit.subscription.user_id }}</p>
                                <p class="mb-1"><strong>–¢–∞—Ä–∏—Ñ:</strong> {{ user_limit.subscription.tariff_name }}</p>
                                <p class="mb-0"><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ user_limit.subscription.status | title }}</p>
                            </div>
                            <div class="col-md-4">
                                <h6>üìÖ –°—Ä–æ–∫–∏</h6>
                                <p class="mb-1"><strong>–ù–∞—á–∞–ª–æ:</strong> {{ user_limit.subscription.started_at[:10] if user_limit.subscription.started_at else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
                                <p class="mb-0"><strong>–ò—Å—Ç–µ–∫–∞–µ—Ç:</strong> {{ user_limit.subscription.expires_at[:10] if user_limit.subscription.expires_at else '–ë–µ—Å—Å—Ä–æ—á–Ω–∞—è' }}</p>
                            </div>
                            <div class="col-md-4">
                                <h6>üí≥ –ü–ª–∞—Ç–µ–∂–∏</h6>
                                <p class="mb-1">
                                    <span class="status-badge {% if user_limit.payment_status.status == 'paid' %}status-ok{% elif user_limit.payment_status.status == 'failed' %}status-danger{% else %}status-warning{% endif %}">
                                        {{ user_limit.payment_status.status | title }}
                                    </span>
                                </p>
                                <p class="mb-0"><strong>–§—É–Ω–∫—Ü–∏–π:</strong> {{ user_limit.features.count }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- –õ–∏–º–∏—Ç—ã -->
                    <div class="row">
                        <div class="col-md-4">
                            <h6>üè¢ –û–±—ä–µ–∫—Ç—ã</h6>
                            <div class="limit-bar">
                                {% set percentage = (user_limit.limits.objects.details.current / user_limit.limits.objects.details.max * 100) if user_limit.limits.objects.details.max != -1 else 0 %}
                                <div class="limit-fill {% if not user_limit.limits.objects.allowed %}danger{% elif percentage >= 80 %}warning{% else %}ok{% endif %}" 
                                     style="width: {{ percentage }}%"></div>
                            </div>
                            <p class="mb-0">
                                <strong>{{ user_limit.limits.objects.details.current }}</strong>
                                / {{ user_limit.limits.objects.details.max if user_limit.limits.objects.details.max != -1 else '‚àû' }}
                                {% if user_limit.limits.objects.details.remaining != -1 %}
                                (–æ—Å—Ç–∞–ª–æ—Å—å: {{ user_limit.limits.objects.details.remaining }})
                                {% endif %}
                            </p>
                            {% if not user_limit.limits.objects.allowed %}
                            <small class="text-danger">{{ user_limit.limits.objects.message }}</small>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <h6>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h6>
                            <div class="limit-bar">
                                {% set percentage = (user_limit.limits.employees.details.current / user_limit.limits.employees.details.max * 100) if user_limit.limits.employees.details.max != -1 else 0 %}
                                <div class="limit-fill {% if not user_limit.limits.employees.allowed %}danger{% elif percentage >= 80 %}warning{% else %}ok{% endif %}" 
                                     style="width: {{ percentage }}%"></div>
                            </div>
                            <p class="mb-0">
                                <strong>{{ user_limit.limits.employees.details.current }}</strong>
                                / {{ user_limit.limits.employees.details.max if user_limit.limits.employees.details.max != -1 else '‚àû' }}
                                {% if user_limit.limits.employees.details.remaining != -1 %}
                                (–æ—Å—Ç–∞–ª–æ—Å—å: {{ user_limit.limits.employees.details.remaining }})
                                {% endif %}
                            </p>
                            {% if not user_limit.limits.employees.allowed %}
                            <small class="text-danger">{{ user_limit.limits.employees.message }}</small>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <h6>üë®‚Äçüíº –£–ø—Ä–∞–≤–ª—è—é—â–∏–µ</h6>
                            <div class="limit-bar">
                                {% set percentage = (user_limit.limits.managers.details.current / user_limit.limits.managers.details.max * 100) if user_limit.limits.managers.details.max != -1 else 0 %}
                                <div class="limit-fill {% if not user_limit.limits.managers.allowed %}danger{% elif percentage >= 80 %}warning{% else %}ok{% endif %}" 
                                     style="width: {{ percentage }}%"></div>
                            </div>
                            <p class="mb-0">
                                <strong>{{ user_limit.limits.managers.details.current }}</strong>
                                / {{ user_limit.limits.managers.details.max if user_limit.limits.managers.details.max != -1 else '‚àû' }}
                                {% if user_limit.limits.managers.details.remaining != -1 %}
                                (–æ—Å—Ç–∞–ª–æ—Å—å: {{ user_limit.limits.managers.details.remaining }})
                                {% endif %}
                            </p>
                            {% if not user_limit.limits.managers.allowed %}
                            <small class="text-danger">{{ user_limit.limits.managers.message }}</small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
                    {% if user_limit.warnings %}
                    <div class="alert alert-warning mt-3">
                        <h6><i class="bi bi-exclamation-triangle"></i> –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</h6>
                        <ul class="mb-0">
                            {% for warning in user_limit.warnings %}
                            <li>{{ warning }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <div class="mt-3">
                        <div class="btn-group">
                            <a href="/admin/subscriptions/assign?user_id={{ user_limit.subscription.user_id }}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-up-circle"></i> –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ
                            </a>
                            <a href="/admin/billing/transactions?user_id={{ user_limit.subscription.user_id }}" 
                               class="btn btn-outline-info btn-sm">
                                <i class="bi bi-credit-card"></i> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                            </a>
                            <a href="/admin/billing/usage?user_id={{ user_limit.subscription.user_id }}" 
                               class="btn btn-outline-success btn-sm">
                                <i class="bi bi-graph-up"></i> –ú–µ—Ç—Ä–∏–∫–∏
                            </a>
                            <button type="button" class="btn btn-outline-warning btn-sm" 
                                    onclick="contactUser({{ user_limit.subscription.user_id }})">
                                <i class="bi bi-envelope"></i> –°–≤—è–∑–∞—Ç—å—Å—è
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            <h5>üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ª–∏–º–∏—Ç–∞—Ö</h5>
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
        </div>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    updateStatistics();
});

function updateStatistics() {
    const userLimits = {{ user_limits | tojson }};
    
    let overLimitUsers = 0;
    let warningUsers = 0;
    let expiringUsers = 0;
    
    userLimits.forEach(userLimit => {
        if (!userLimit.limits.objects.allowed || !userLimit.limits.employees.allowed) {
            overLimitUsers++;
        }
        
        if (userLimit.warnings && userLimit.warnings.length > 0) {
            warningUsers++;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
        if (userLimit.subscription.expires_at) {
            const expiresAt = new Date(userLimit.subscription.expires_at);
            const now = new Date();
            const daysUntilExpiry = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
            
            if (daysUntilExpiry <= 7) {
                expiringUsers++;
            }
        }
    });
    
    document.getElementById('over-limit-users').textContent = overLimitUsers;
    document.getElementById('warning-users').textContent = warningUsers;
    document.getElementById('expiring-users').textContent = expiringUsers;
}

async function refreshOverview() {
    try {
        const response = await fetch('/owner/limits/admin/api/overview');
        const data = await response.json();
        
        if (data.success) {
            window.location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–∑–æ—Ä–∞: ' + data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–∑–æ—Ä–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–∑–æ—Ä–∞');
    }
}

function contactUser(userId) {
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    alert(`–§—É–Ω–∫—Ü–∏—è —Å–≤—è–∑–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${userId} –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ`);
}
</script>
{% endblock %}
