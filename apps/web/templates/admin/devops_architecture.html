{% extends "admin/base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="bi bi-diagram-3"></i> {{ title }}</h1>
  <div>
    <a class="btn btn-outline-primary" href="/admin/devops">
      ← Назад в DevOps
    </a>
    <a class="btn btn-primary" href="{{ brain_arch_url }}" target="_blank">
      Открыть визуализатор
    </a>
  </div>
  </div>

{% if brain_alive %}
<div class="alert alert-success py-2"><i class="bi bi-check-circle"></i> Project Brain: Online</div>
{% else %}
<div class="alert alert-danger py-2"><i class="bi bi-x-circle"></i> Project Brain: Offline</div>
{% endif %}

<div class="mb-3 d-flex gap-2">
  <form method="post" action="/admin/devops/architecture/reindex">
    <button class="btn btn-secondary" type="submit">Пересобрать (Reindex)</button>
  </form>
  <form method="post" action="/admin/devops/architecture/analyze" class="d-flex gap-2">
    <input class="form-control" name="commit_sha" placeholder="Commit SHA (опц.)" style="max-width:220px"/>
    <button class="btn btn-dark" type="submit">Analyze</button>
  </form>
  <form method="post" action="/admin/devops/architecture/sync-datasets">
    <button class="btn btn-outline-primary" type="submit">Sync Datasets (FAQ/Bugs/Changelog)</button>
  </form>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-dark text-white"><strong>Снапшоты архитектуры</strong></div>
      <div class="card-body">
        {% if snapshots and snapshots|length > 0 %}
        <table class="table table-sm">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nodes</th>
              <th>Edges</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            {% for s in snapshots %}
            <tr>
              <td class="mono">{{ s.id }}</td>
              <td>{{ s.stats_nodes }}</td>
              <td>{{ s.stats_edges }}</td>
              <td><small>{{ s.created_at }}</small></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="alert alert-info mb-0">Нет снапшотов</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-secondary text-white"><strong>Последний Diff</strong></div>
      <div class="card-body">
        {% if diff and diff.cur_stats %}
        <div class="mb-2"><strong>commit:</strong> <span class="mono">{{ diff.commit_sha }}</span></div>
        <div class="row mb-2">
          <div class="col-6">
            <div class="card p-2">
              <div><strong>nodes+</strong>: {{ diff.nodes_added|length }}</div>
              <div><strong>nodes-</strong>: {{ diff.nodes_removed|length }}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="card p-2">
              <div><strong>edges+</strong>: {{ diff.edges_added|length }}</div>
              <div><strong>edges-</strong>: {{ diff.edges_removed|length }}</div>
            </div>
          </div>
        </div>
        <details>
          <summary>Показать JSON</summary>
          <pre class="mono" style="max-height:300px; overflow:auto;">{{ diff | tojson(indent=2) }}</pre>
        </details>
        {% else %}
        <div class="alert alert-info mb-0">Diff недоступен</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}


