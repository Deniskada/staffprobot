{% extends "admin/base_admin.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section h5 {
        margin-bottom: 1rem;
        color: #495057;
        font-weight: 600;
    }
    
    .variable-tag {
        display: inline-block;
        background: #e7f3ff;
        color: #0066cc;
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        margin: 0.25rem;
        font-family: monospace;
        font-size: 0.9rem;
    }
    
    .variable-tag .remove-var {
        margin-left: 0.5rem;
        color: #dc3545;
        cursor: pointer;
    }
    
    .template-preview {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-top: 1rem;
        min-height: 100px;
    }
    
    .helper-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Админ-панель</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_notifications_dashboard') }}">Уведомления</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_notifications_templates_list') }}">Шаблоны</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Создание</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <h2><i class="fas fa-file-alt"></i> {{ title }}</h2>
        </div>
    </div>

    <form id="createTemplateForm" method="POST">
        <div class="row">
            <!-- Основная информация -->
            <div class="col-md-8">
                <div class="form-section">
                    <h5><i class="fas fa-info-circle"></i> Основная информация</h5>
                    
                    <div class="mb-3">
                        <label for="template_key" class="form-label">Ключ шаблона *</label>
                        <input type="text" class="form-control" id="template_key" name="template_key" required
                               pattern="[a-z_]+" placeholder="shift_reminder_custom">
                        <div class="helper-text">Уникальный ключ на английском (строчные буквы и подчёркивание)</div>
                    </div>

                    <div class="mb-3">
                        <label for="name" class="form-label">Название *</label>
                        <input type="text" class="form-control" id="name" name="name" required
                               placeholder="Кастомное напоминание о смене">
                        <div class="helper-text">Понятное название для отображения в интерфейсе</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Описание</label>
                        <textarea class="form-control" id="description" name="description" rows="2"
                                  placeholder="Описание назначения шаблона"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="type" class="form-label">Тип уведомления *</label>
                            <select class="form-select" id="type" name="type" required>
                                <option value="">-- Выберите тип --</option>
                                {% for type in available_types %}
                                <option value="{{ type.value }}">{{ type.label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="channel" class="form-label">Канал доставки</label>
                            <select class="form-select" id="channel" name="channel">
                                <option value="">-- Все каналы --</option>
                                {% for channel in available_channels %}
                                <option value="{{ channel.value }}">{{ channel.label }}</option>
                                {% endfor %}
                            </select>
                            <div class="helper-text">Если не указан - шаблон для всех каналов</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h5><i class="fas fa-code"></i> Содержимое шаблона</h5>

                    <div class="mb-3">
                        <label for="subject_template" class="form-label">Заголовок (Subject)</label>
                        <input type="text" class="form-control" id="subject_template" name="subject_template"
                               placeholder="Напоминание о смене: $shift_date">
                        <div class="helper-text">Используйте $variable для подстановки переменных</div>
                    </div>

                    <div class="mb-3">
                        <label for="plain_template" class="form-label">Текстовый шаблон (Plain Text) *</label>
                        <textarea class="form-control font-monospace" id="plain_template" name="plain_template" rows="8" required
                                  placeholder="Здравствуйте, $user_name!&#10;&#10;Напоминаем о вашей смене:&#10;Дата: $shift_date&#10;Время: $shift_time&#10;Объект: $object_name"></textarea>
                        <div class="helper-text">Обязательное поле. Используйте $variable для подстановки</div>
                    </div>

                    <div class="mb-3">
                        <label for="html_template" class="form-label">HTML шаблон</label>
                        <textarea class="form-control font-monospace" id="html_template" name="html_template" rows="10"
                                  placeholder="<h2>Напоминание о смене</h2>&#10;<p>Здравствуйте, <strong>$user_name</strong>!</p>"></textarea>
                        <div class="helper-text">Опционально. Для Email уведомлений с форматированием</div>
                    </div>
                </div>

                <div class="form-section">
                    <h5><i class="fas fa-tags"></i> Переменные шаблона</h5>
                    
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="new_variable" 
                                   placeholder="user_name" pattern="[a-z_]+">
                            <button type="button" class="btn btn-outline-primary" onclick="addVariable()">
                                <i class="fas fa-plus"></i> Добавить переменную
                            </button>
                        </div>
                        <div class="helper-text">Список доступных переменных для подстановки</div>
                    </div>

                    <div id="variables-container" class="mb-3">
                        <!-- Переменные будут добавлены сюда -->
                    </div>

                    <input type="hidden" id="variables" name="variables" value="[]">
                </div>
            </div>

            <!-- Боковая панель -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Подсказка</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Использование переменных:</strong></p>
                        <ul class="mb-0">
                            <li>Формат: <code>$variable_name</code></li>
                            <li>Пример: <code>$user_name</code></li>
                            <li>Регистр: только строчные</li>
                            <li>Символы: буквы и _</li>
                        </ul>
                        
                        <hr>
                        
                        <p class="mb-2"><strong>Типичные переменные:</strong></p>
                        <ul class="mb-0 small">
                            <li><code>$user_name</code> - имя пользователя</li>
                            <li><code>$shift_date</code> - дата смены</li>
                            <li><code>$shift_time</code> - время смены</li>
                            <li><code>$object_name</code> - название объекта</li>
                            <li><code>$amount</code> - сумма платежа</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-question-circle"></i> Справка</h6>
                    </div>
                    <div class="card-body">
                        <p class="small mb-2"><strong>Кастомные vs статические:</strong></p>
                        <p class="small">Кастомные шаблоны переопределяют статические шаблоны из кода.</p>
                        
                        <hr>
                        
                        <p class="small mb-2"><strong>Версионирование:</strong></p>
                        <p class="small">При каждом изменении создаётся новая версия шаблона.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{{ url_for('admin_notifications_templates_list') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Отмена
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> Создать шаблон
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11000;"></div>
{% endblock %}

{% block extra_js %}
<script>
// Данные для предзаполнения
const prefillData = {{ prefill_data | tojson if prefill_data else 'null' }};

let variables = [];

function addVariable() {
    const input = document.getElementById('new_variable');
    const variable = input.value.trim();
    
    if (!variable) {
        showToast('Введите название переменной', 'warning');
        return;
    }
    
    if (!/^[a-z_]+$/.test(variable)) {
        showToast('Переменная должна содержать только строчные буквы и подчёркивание', 'error');
        return;
    }
    
    if (variables.includes(variable)) {
        showToast('Эта переменная уже добавлена', 'warning');
        return;
    }
    
    variables.push(variable);
    updateVariablesDisplay();
    input.value = '';
}

function removeVariable(variable) {
    variables = variables.filter(v => v !== variable);
    updateVariablesDisplay();
}

function updateVariablesDisplay() {
    const container = document.getElementById('variables-container');
    const hiddenInput = document.getElementById('variables');
    
    if (variables.length === 0) {
        container.innerHTML = '<div class="text-muted">Переменные не добавлены</div>';
    } else {
        container.innerHTML = variables.map(v => 
            `<span class="variable-tag">$${v}<span class="remove-var" onclick="removeVariable('${v}')">&times;</span></span>`
        ).join('');
    }
    
    hiddenInput.value = JSON.stringify(variables);
}

document.getElementById('createTemplateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/admin/notifications/api/templates/create', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast(data.message || 'Шаблон успешно создан', 'success');
            setTimeout(() => {
                window.location.href = '/admin/notifications/templates';
            }, 1500);
        } else {
            showToast(data.detail || 'Ошибка создания шаблона', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Ошибка отправки данных', 'error');
    }
});

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const bgClass = type === 'success' ? 'bg-success' : 
                    type === 'error' ? 'bg-danger' : 
                    type === 'warning' ? 'bg-warning' : 'bg-info';
    
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white ${bgClass} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Функция вставки переменной в позицию курсора
function insertVariableAt(textareaId, variable) {
    const textarea = document.getElementById(textareaId);
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(textarea.selectionEnd);
    
    // Вставляем переменную с $ префиксом
    textarea.value = textBefore + '$' + variable + textAfter;
    
    // Устанавливаем курсор после вставленной переменной
    const newCursorPos = cursorPos + variable.length + 1;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
    
    showToast(`Переменная $${variable} вставлена`, 'info');
}

// Функция создания кнопок для вставки переменных
function createVariableButtons(variables) {
    const variablesContainer = document.getElementById('variables-container');
    
    if (!variables || variables.length === 0) {
        return;
    }
    
    // Добавляем секцию с кнопками вставки ПЕРЕД существующими тегами
    const buttonsHtml = `
        <div class="mb-3 p-3 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Вставить в текст (клик для копирования):</strong>
                <small class="text-muted">Нажмите для вставки в текущую позицию курсора</small>
            </div>
            <div id="insert-buttons" class="d-flex flex-wrap gap-2">
                ${variables.map(v => `
                    <button type="button" class="btn btn-sm btn-outline-primary" 
                            onclick="insertVariableIntoFocused('${v}')"
                            title="Вставить в активное поле">
                        <i class="fas fa-plus-circle"></i> $${v}
                    </button>
                `).join('')}
            </div>
        </div>
    `;
    
    // Вставляем кнопки ПЕРЕД существующим содержимым
    variablesContainer.insertAdjacentHTML('afterbegin', buttonsHtml);
}

// Отслеживание последнего активного textarea
let lastFocusedTextarea = null;

document.addEventListener('DOMContentLoaded', function() {
    const textareas = document.querySelectorAll('textarea, input[type="text"]');
    textareas.forEach(textarea => {
        textarea.addEventListener('focus', function() {
            lastFocusedTextarea = this.id;
        });
    });
});

// Вставка в последнее активное поле или в plain_template по умолчанию
function insertVariableIntoFocused(variable) {
    const targetId = lastFocusedTextarea || 'plain_template';
    insertVariableAt(targetId, variable);
}

// Автозаполнение формы при наличии prefillData
if (prefillData) {
    document.addEventListener('DOMContentLoaded', function() {
        // Заполняем основные поля
        if (prefillData.template_key) {
            document.getElementById('template_key').value = prefillData.template_key;
        }
        if (prefillData.name) {
            document.getElementById('name').value = prefillData.name;
        }
        if (prefillData.type) {
            document.getElementById('type').value = prefillData.type;
            // Делаем поле disabled, чтобы не менять тип при переопределении
            document.getElementById('type').disabled = true;
            // Но добавляем скрытое поле для отправки
            const hiddenType = document.createElement('input');
            hiddenType.type = 'hidden';
            hiddenType.name = 'type';
            hiddenType.value = prefillData.type;
            document.getElementById('createTemplateForm').appendChild(hiddenType);
        }
        if (prefillData.subject_template) {
            document.getElementById('subject_template').value = prefillData.subject_template;
        }
        if (prefillData.plain_template) {
            document.getElementById('plain_template').value = prefillData.plain_template;
        }
        if (prefillData.html_template) {
            document.getElementById('html_template').value = prefillData.html_template;
        }
        
        // Загружаем переменные
        if (prefillData.variables && Array.isArray(prefillData.variables)) {
            variables = prefillData.variables;
            updateVariablesDisplay();
            // Создаём кнопки для вставки
            createVariableButtons(prefillData.variables);
        }
        
        // Показываем подсказку
        showToast('Шаблон загружен! Отредактируйте текст по необходимости', 'success');
    });
}

// Инициализация
updateVariablesDisplay();

// Добавление переменной по Enter
document.getElementById('new_variable').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addVariable();
    }
});
</script>
{% endblock %}

