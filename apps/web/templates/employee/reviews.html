<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отзывы об объектах - StaffProBot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .review-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .review-card:hover {
            transform: translateY(-5px);
        }
        
        .rating-stars {
            color: #ffc107;
        }
        
        .review-tabs {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .review-tabs .nav-link {
            border: none;
            border-radius: 25px;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .review-tabs .nav-link.active {
            background: #28a745;
            color: white;
        }
        
        .create-review-btn {
            border-radius: 25px;
            padding: 10px 25px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .create-review-btn:hover {
            transform: scale(1.05);
        }
        
        .review-meta {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .appeal-btn {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        
        .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        
        .navbar-employee {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .navbar-employee .navbar-brand,
        .navbar-employee .nav-link {
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Навигация сотрудника -->
    <nav class="navbar navbar-expand-lg navbar-employee">
        <div class="container">
            <a class="navbar-brand" href="/employee/">
                <i class="fas fa-user"></i> StaffProBot
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/employee/">
                            <i class="fas fa-tachometer-alt"></i> Дашборд
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/employee/shifts">
                            <i class="fas fa-calendar"></i> Смены
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/employee/objects">
                            <i class="fas fa-building"></i> Объекты
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/employee/reviews">
                            <i class="fas fa-comments"></i> Отзывы
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="container">
            <!-- Заголовок -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1><i class="fas fa-comments"></i> Отзывы об объектах</h1>
                    <p class="text-muted">Оставляйте отзывы о работе на объектах</p>
                </div>
            </div>

            <!-- Уведомления -->
            <div id="alerts-container"></div>

            <!-- Фильтры и действия -->
            <div class="review-tabs">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <ul class="nav nav-pills">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" onclick="filterReviews('my-reviews')">
                                    <i class="fas fa-user"></i> Мои отзывы
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="filterReviews('about-objects')">
                                    <i class="fas fa-building"></i> Об объектах
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="filterReviews('my-appeals')">
                                    <i class="fas fa-gavel"></i> Мои обжалования
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success create-review-btn" onclick="showCreateReviewModal()">
                            <i class="fas fa-plus"></i> Создать отзыв
                        </button>
                    </div>
                </div>
            </div>

            <!-- Информация о правилах -->
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle"></i> Правила подачи отзывов</h6>
                <ul class="mb-0">
                    <li>Вы можете оставлять отзывы только об объектах, где работали</li>
                    <li>Обязательно укажите номер договора для связи отзыва с работой</li>
                    <li>Отзывы проходят модерацию в течение 48 часов</li>
                    <li>Вы можете подать обжалование, если отзыв был отклонен</li>
                    <li>Максимум одно обжалование на отзыв</li>
                </ul>
            </div>

            <!-- Список отзывов -->
            <div id="reviews-container">
                <div class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>
            </div>

            <!-- Пагинация -->
            <div class="row">
                <div class="col-12">
                    <nav aria-label="Пагинация отзывов">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Пагинация будет добавлена динамически -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно создания отзыва -->
    <div class="modal fade" id="createReviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Создать отзыв об объекте</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-review-form">
                        <div class="mb-3">
                            <label for="object-id" class="form-label">Объект *</label>
                            <select class="form-select" id="object-id" required>
                                <option value="">Выберите объект</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contract-id" class="form-label">Номер договора *</label>
                            <select class="form-select" id="contract-id" required>
                                <option value="">Выберите договор</option>
                            </select>
                            <div class="form-text">Обязательно для связи отзыва с работой</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="review-title" class="form-label">Заголовок отзыва *</label>
                            <input type="text" class="form-control" id="review-title" required maxlength="200" 
                                   placeholder="Краткое описание вашего опыта работы на объекте">
                        </div>
                        
                        <div class="mb-3">
                            <label for="review-rating" class="form-label">Оценка объекта *</label>
                            <div class="rating-input">
                                <div class="rating-stars" id="rating-stars">
                                    <i class="far fa-star" data-rating="1"></i>
                                    <i class="far fa-star" data-rating="2"></i>
                                    <i class="far fa-star" data-rating="3"></i>
                                    <i class="far fa-star" data-rating="4"></i>
                                    <i class="far fa-star" data-rating="5"></i>
                                </div>
                                <input type="hidden" id="review-rating" value="5">
                                <div class="form-text">Оцените условия работы, оборудование, безопасность</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="review-content" class="form-label">Подробное описание</label>
                            <textarea class="form-control" id="review-content" rows="4" maxlength="1000" 
                                      placeholder="Опишите ваш опыт работы на объекте: условия, оборудование, коллектив, безопасность..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is-anonymous">
                                <label class="form-check-label" for="is-anonymous">
                                    Анонимный отзыв
                                </label>
                            </div>
                            <div class="form-text">При анонимном отзыве ваше имя не будет показано, но номер договора останется</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Медиа-файлы (опционально)</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="media-upload-container" data-file-type="photo" data-max-files="3">
                                        <label class="form-label">Фотографии</label>
                                        <div class="drop-area border border-dashed rounded p-3 text-center cursor-pointer hover:bg-gray-50">
                                            <input type="file" class="file-input hidden" multiple accept="image/*">
                                            <p class="text-muted">Перетащите фото или выберите файлы</p>
                                            <p class="text-sm text-muted">До 5MB на файл</p>
                                        </div>
                                        <div class="preview-container mt-2"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="media-upload-container" data-file-type="video" data-max-files="1">
                                        <label class="form-label">Видео</label>
                                        <div class="drop-area border border-dashed rounded p-3 text-center cursor-pointer hover:bg-gray-50">
                                            <input type="file" class="file-input hidden" multiple accept="video/*">
                                            <p class="text-muted">Перетащите видео или выберите файл</p>
                                            <p class="text-sm text-muted">До 50MB на файл</p>
                                        </div>
                                        <div class="preview-container mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-success" onclick="submitReview()">
                        <i class="fas fa-paper-plane"></i> Отправить отзыв
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно обжалования -->
    <div class="modal fade" id="appealModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Подать обжалование</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="appeal-form">
                        <input type="hidden" id="appeal-review-id">
                        
                        <div class="alert alert-info">
                            <h6>Информация об отзыве</h6>
                            <div id="appeal-review-info">
                                <!-- Информация об отзыве будет загружена динамически -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="appeal-reason" class="form-label">Причина обжалования *</label>
                            <textarea class="form-control" id="appeal-reason" rows="4" required maxlength="1000" 
                                      placeholder="Опишите, почему вы считаете решение модерации несправедливым..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Доказательства</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="media-upload-container" data-file-type="photo" data-max-files="3">
                                        <label class="form-label">Фотографии</label>
                                        <div class="drop-area border border-dashed rounded p-3 text-center cursor-pointer hover:bg-gray-50">
                                            <input type="file" class="file-input hidden" multiple accept="image/*">
                                            <p class="text-muted">Перетащите фото или выберите файлы</p>
                                        </div>
                                        <div class="preview-container mt-2"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="media-upload-container" data-file-type="document" data-max-files="3">
                                        <label class="form-label">Документы</label>
                                        <div class="drop-area border border-dashed rounded p-3 text-center cursor-pointer hover:bg-gray-50">
                                            <input type="file" class="file-input hidden" multiple accept=".pdf,.doc,.docx">
                                            <p class="text-muted">Перетащите документы или выберите файлы</p>
                                        </div>
                                        <div class="preview-container mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i>
                            <strong>Важно:</strong> Вы можете подать только одно обжалование на отзыв. 
                            Рассмотрение займет до 72 часов.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-warning" onclick="submitAppeal()">
                        <i class="fas fa-gavel"></i> Подать обжалование
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/shared/media_upload.js"></script>
    <script>
        let currentFilter = 'my-reviews';
        let currentPage = 0;
        let selectedRating = 5;

        // Загрузка страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadReviews();
            loadObjects();
            loadContracts();
        });

        // Фильтрация отзывов
        function filterReviews(filter) {
            currentFilter = filter;
            currentPage = 0;
            
            // Обновляем активную вкладку
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.closest('.nav-link').classList.add('active');
            
            loadReviews();
        }

        // Загрузка отзывов
        async function loadReviews() {
            try {
                // TODO: Реализовать API для получения отзывов сотрудника
                const container = document.getElementById('reviews-container');
                
                if (currentFilter === 'my-appeals') {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-gavel fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Мои обжалования</h5>
                            <p class="text-muted">Функция будет реализована в следующих этапах</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Отзывы об объектах</h5>
                            <p class="text-muted">Функция будет реализована в следующих этапах</p>
                            <button class="btn btn-success" onclick="showCreateReviewModal()">
                                <i class="fas fa-plus"></i> Создать первый отзыв
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                showAlert('Ошибка загрузки отзывов', 'danger');
            }
        }

        // Загрузка объектов
        async function loadObjects() {
            try {
                // TODO: Реализовать API для получения объектов сотрудника
                const objectSelect = document.getElementById('object-id');
                objectSelect.innerHTML = '<option value="">Загрузка объектов...</option>';
                
                // Заглушка
                setTimeout(() => {
                    objectSelect.innerHTML = `
                        <option value="">Выберите объект</option>
                        <option value="1">Офис на Тверской</option>
                        <option value="2">Склад в Подольске</option>
                        <option value="3">Магазин на Арбате</option>
                    `;
                }, 1000);
            } catch (error) {
                console.error('Error loading objects:', error);
            }
        }

        // Загрузка договоров
        async function loadContracts() {
            try {
                // TODO: Реализовать API для получения договоров сотрудника
                const contractSelect = document.getElementById('contract-id');
                contractSelect.innerHTML = '<option value="">Загрузка договоров...</option>';
                
                // Заглушка
                setTimeout(() => {
                    contractSelect.innerHTML = `
                        <option value="">Выберите договор</option>
                        <option value="1">Договор #12345 - Офис на Тверской</option>
                        <option value="2">Договор #12346 - Склад в Подольске</option>
                        <option value="3">Договор #12347 - Магазин на Арбате</option>
                    `;
                }, 1000);
            } catch (error) {
                console.error('Error loading contracts:', error);
            }
        }

        // Показ модального окна создания отзыва
        function showCreateReviewModal() {
            const modal = new bootstrap.Modal(document.getElementById('createReviewModal'));
            modal.show();
        }

        // Обработка звездного рейтинга
        document.getElementById('rating-stars').addEventListener('click', function(e) {
            if (e.target.classList.contains('fa-star')) {
                const rating = parseInt(e.target.dataset.rating);
                selectedRating = rating;
                document.getElementById('review-rating').value = rating;
                
                // Обновляем отображение звезд
                const stars = this.querySelectorAll('.fa-star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.className = 'fas fa-star';
                    } else {
                        star.className = 'far fa-star';
                    }
                });
            }
        });

        // Отправка отзыва
        async function submitReview() {
            try {
                const formData = new FormData();
                formData.append('target_type', 'object');
                formData.append('target_id', document.getElementById('object-id').value);
                formData.append('contract_id', document.getElementById('contract-id').value);
                formData.append('title', document.getElementById('review-title').value);
                formData.append('rating', document.getElementById('review-rating').value);
                formData.append('content', document.getElementById('review-content').value);
                formData.append('is_anonymous', document.getElementById('is-anonymous').checked);

                // TODO: Реализовать API для создания отзыва
                console.log('Submitting review:', Object.fromEntries(formData));
                
                showAlert('Отзыв отправлен на модерацию', 'success');
                
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('createReviewModal'));
                modal.hide();
                
                // Очищаем форму
                document.getElementById('create-review-form').reset();
                selectedRating = 5;
                
            } catch (error) {
                console.error('Error submitting review:', error);
                showAlert('Ошибка отправки отзыва', 'danger');
            }
        }

        // Показ модального окна обжалования
        function showAppealModal(reviewId) {
            document.getElementById('appeal-review-id').value = reviewId;
            
            // TODO: Загрузить информацию об отзыве
            document.getElementById('appeal-review-info').innerHTML = `
                <p><strong>Отзыв #${reviewId}</strong></p>
                <p>Статус: <span class="badge bg-danger">Отклонен</span></p>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('appealModal'));
            modal.show();
        }

        // Отправка обжалования
        async function submitAppeal() {
            try {
                const formData = new FormData();
                formData.append('review_id', document.getElementById('appeal-review-id').value);
                formData.append('appeal_reason', document.getElementById('appeal-reason').value);

                // TODO: Реализовать API для создания обжалования
                console.log('Submitting appeal:', Object.fromEntries(formData));
                
                showAlert('Обжалование подано', 'success');
                
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('appealModal'));
                modal.hide();
                
                // Очищаем форму
                document.getElementById('appeal-form').reset();
                
            } catch (error) {
                console.error('Error submitting appeal:', error);
                showAlert('Ошибка подачи обжалования', 'danger');
            }
        }

        // Показ уведомления
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alerts-container');
            const alertId = 'alert-' + Date.now();
            container.innerHTML += `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>
