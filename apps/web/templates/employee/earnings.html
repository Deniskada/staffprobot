{% extends "employee/base_employee.html" %}

{% block title %}–ú–æ–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫{% endblock %}

{% block extra_css %}
<style>
.earnings-summary-card {
    border-left: 4px solid #0d6efd;
}
.earnings-summary-card .card-body {
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(13, 110, 253, 0.05));
}
.earnings-table thead th {
    background-color: #f2f6ff;
}
.earnings-table tfoot td {
    font-weight: 600;
}
.btn-export {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
}
.badge-hours {
    font-size: 0.85rem;
}
.objects-scroll {
    max-height: 18rem;
    overflow-y: auto;
}
.payment-table-scroll {
    max-height: 24rem;
    overflow-y: auto;
    position: relative;
}
.payment-table-scroll .table thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 1;
}
.payment-table-scroll::-webkit-scrollbar {
    width: 6px;
}
.payment-table-scroll::-webkit-scrollbar-thumb {
    background-color: rgba(13, 110, 253, 0.4);
    border-radius: 3px;
}
.column-rate,
.column-amount {
    width: 110px;
    white-space: nowrap;
}
.column-payment {
    width: 140px;
    white-space: nowrap;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h2 class="mb-1">üí∞ –ú–æ–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/employee">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li class="breadcrumb-item active" aria-current="page">–ú–æ–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫</li>
                </ol>
            </nav>
        </div>

        <div class="d-flex align-items-center gap-3">
            <label for="earningsYearSelect" class="form-label mb-0">–ì–æ–¥</label>
            <select id="earningsYearSelect" class="form-select" style="min-width: 140px;">
                {% for y in available_years %}
                <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card earnings-summary-card h-100">
                <div class="card-body">
                    <div class="text-muted mb-2">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                    <div class="fs-3 fw-bold">{{ '%.2f'|format(total_amount) }} ‚ÇΩ</div>
                    <div class="text-muted">c {{ year_start.strftime('%d.%m.%Y') }} –ø–æ {{ year_end.strftime('%d.%m.%Y') }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="text-muted mb-2">–°–º–µ–Ω</div>
                    <div class="fs-3 fw-bold">{{ earnings|length }}</div>
                    <div class="text-muted">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="text-muted mb-2">–û–±—â–µ–µ —á–∏—Å–ª–æ —á–∞—Å–æ–≤</div>
                    <div class="fs-3 fw-bold">{{ '%.2f'|format(total_hours) }}</div>
                    <div class="text-muted">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —á–∞—Å—ã</div>
                </div>
            </div>
        </div>
    </div>

    {% if earnings %}
    <div class="row g-4">
        <div class="col-lg-4 d-flex flex-column gap-4 h-100">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart"></i>
                        –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush objects-scroll">
                        {% for item in summary_by_object %}
                        <div class="list-group-item d-flex justify-content-between">
                            <div>
                                <div class="fw-semibold">{{ item.object_name }}</div>
                                <div class="text-muted small">{{ item.shifts }} —Å–º–µ–Ω ¬∑ {{ '%.2f'|format(item.hours) }} —á</div>
                            </div>
                            <span class="fw-bold">{{ '%.2f'|format(item.amount) }} ‚ÇΩ</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="card flex-grow-1 d-flex flex-column">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calendar-check"></i>
                        –î–∞—Ç—ã –≤—ã–ø–ª–∞—Ç
                    </h5>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    {% if payment_rows %}
                    <div class="table-responsive payment-table-scroll flex-grow-1" data-payment-scroll>
                        <table class="table table-sm mb-0" data-payment-table>
                            <thead class="table-light">
                                <tr>
                                    <th>–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã</th>
                                    <th class="text-end">–ù–∞—á–∏—Å–ª–µ–Ω–æ, ‚ÇΩ</th>
                                    <th>–í—ã–ø–ª–∞—á–µ–Ω–æ</th>
                                    <th class="text-end">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payment_rows %}
                                <tr>
                                    <td>{{ payment.date_label }}</td>
                                    <td class="text-end">
                                        {% if payment.amount is not none %}
                                        {{ '%.2f'|format(payment.amount) }}
                                        {% else %}
                                        <span class="text-muted">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if payment.completed_at %}
                                        <span class="badge bg-success">–í—ã–ø–ª–∞—á–µ–Ω–æ {{ payment.completed_at }}</span>
                                        {% else %}
                                        {% if payment.status == 'pending' %}
                                        <span class="badge bg-warning text-dark">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                                        {% elif payment.status == 'failed' %}
                                        <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                                        {% else %}
                                        <span class="text-muted">‚Äî</span>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-primary payment-filter-btn"
                                            data-payment-filter="{{ payment.date_iso }}"
                                            {% if not payment.has_related_entries %}disabled{% endif %}
                                        >
                                            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-3">
                        <p class="text-muted mb-0">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –≥–æ–¥—É.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table"></i>
                        –ù–∞—á–∏—Å–ª–µ–Ω–∏—è
                    </h5>
                    <div class="d-flex align-items-center gap-3">
                        <div class="form-check mb-0">
                            <input class="form-check-input" type="checkbox" id="earningsShowAll" checked>
                            <label class="form-check-label" for="earningsShowAll">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</label>
                        </div>
                        <span class="badge bg-primary badge-hours" data-earnings-count>{{ earnings|length }} –∑–∞–ø–∏—Å–µ–π</span>
                    </div>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-striped table-hover earnings-table align-middle">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th>–û–±—ä–µ–∫—Ç</th>
                                <th class="text-center">–ß–∞—Å—ã</th>
                                <th class="text-end column-rate">–°—Ç–∞–≤–∫–∞, ‚ÇΩ</th>
                                <th class="column-payment">–í—ã–ø–ª–∞—Ç–∞</th>
                                <th class="text-end column-amount">–°—É–º–º–∞, ‚ÇΩ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in earnings %}
                            <tr data-earnings-row="true" data-payment-date="{{ row.payment_date or '' }}">
                                <td>{{ row.date_label }}</td>
                                <td>
                                    {% if row.type == 'shift' %}
                                    <span class="badge bg-primary">–°–º–µ–Ω–∞</span>
                                    {% elif row.type == 'adjustment' %}
                                        {% if row.amount < 0 %}
                                        <span class="badge bg-danger">–£–¥–µ—Ä–∂–∞–Ω–∏–µ</span>
                                        {% else %}
                                        <span class="badge bg-success">–î–æ–ø–ª–∞—Ç–∞</span>
                                        {% endif %}
                                        {% if row.is_automatic %}
                                        <i class="fas fa-robot text-muted" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ"></i>
                                        {% endif %}
                                    {% else %}
                                    <span class="badge bg-secondary">–ó–∞–ø–∏—Å—å</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if row.description %}
                                    {{ row.description }}
                                    {% elif row.type == 'shift' %}
                                    –°–º–µ–Ω–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>{{ row.object_name }}</td>
                                <td class="text-center">
                                    {% if row.type == 'shift' %}
                                    {{ '%.2f'|format(row.duration_hours) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if row.type == 'shift' %}
                                    {{ '%.2f'|format(row.hourly_rate) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if row.payment_date_label %}
                                    {{ row.payment_date_label }}
                                    {% else %}
                                    <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-semibold">
                                    {% if row.amount < 0 %}
                                    <span class="text-danger">{{ '%.2f'|format(row.amount) }}</span>
                                    {% else %}
                                    <span class="text-success">+{{ '%.2f'|format(row.amount) }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-end fw-bold">–ò—Ç–æ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥:</td>
                                <td class="text-center fw-bold">{{ '%.2f'|format(total_hours) }} —á</td>
                                <td class="text-end fw-bold" colspan="3">
                                    {% if total_amount < 0 %}
                                    <span class="text-danger">{{ '%.2f'|format(total_amount) }} ‚ÇΩ</span>
                                    {% else %}
                                    <span class="text-success">{{ '%.2f'|format(total_amount) }} ‚ÇΩ</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="display-6 mb-3">ü§î</div>
            <h5 class="mb-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</h5>
            <p class="text-muted mb-0">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã.</p>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const yearSelect = document.getElementById('earningsYearSelect');
    if (yearSelect) {
        yearSelect.addEventListener('change', function () {
            const url = new URL(window.location.href);
            url.searchParams.set('year', this.value);
            url.searchParams.delete('page');
            window.location.href = url.toString();
        });
    }

    const showAllCheckbox = document.getElementById('earningsShowAll');
    const paymentButtons = document.querySelectorAll('.payment-filter-btn');
    const earningsRows = document.querySelectorAll('[data-earnings-row]');
    const earningsCounter = document.querySelector('[data-earnings-count]');

    const updateCounter = () => {
        if (!earningsCounter) {
            return;
        }
        const visible = Array.from(earningsRows).filter((row) => row.style.display !== 'none').length;
        earningsCounter.textContent = `${visible} –∑–∞–ø–∏—Å–µ–π`;
    };

    const setButtonState = (button, active) => {
        if (active) {
            button.classList.add('active', 'btn-primary');
            button.classList.remove('btn-outline-primary');
        } else {
            button.classList.remove('active', 'btn-primary');
            button.classList.add('btn-outline-primary');
        }
    };

    const applyFilter = (paymentDate) => {
        earningsRows.forEach((row) => {
            const rowDate = row.dataset.paymentDate || '';
            const match = !paymentDate || rowDate === paymentDate;
            row.style.display = match ? '' : 'none';
        });
        updateCounter();
    };

    applyFilter(null);

    paymentButtons.forEach((button) => {
        button.addEventListener('click', () => {
            if (button.disabled) {
                return;
            }
            const isActive = button.classList.contains('active');
            paymentButtons.forEach((btn) => setButtonState(btn, false));

            if (isActive) {
                if (showAllCheckbox) {
                    showAllCheckbox.checked = true;
                }
                applyFilter(null);
            } else {
                setButtonState(button, true);
                if (showAllCheckbox) {
                    showAllCheckbox.checked = false;
                }
                applyFilter(button.dataset.paymentFilter || null);
            }
        });
    });

    if (showAllCheckbox) {
        showAllCheckbox.addEventListener('change', () => {
            if (showAllCheckbox.checked) {
                paymentButtons.forEach((btn) => setButtonState(btn, false));
                applyFilter(null);
            } else {
                const activeButton = document.querySelector('.payment-filter-btn.active');
                if (!activeButton) {
                    showAllCheckbox.checked = true;
                }
            }
        });
    }

    const paymentScroll = document.querySelector('[data-payment-scroll]');
    const paymentTable = document.querySelector('[data-payment-table]');
    if (paymentScroll && paymentTable) {
        const today = new Date();
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const rows = Array.from(paymentTable.querySelectorAll('tbody tr'));

        let fallbackRow = null;
        let targetRow = null;

        for (const row of rows) {
            const cell = row.querySelector('td');
            if (!cell) {
                continue;
            }
            const parts = cell.textContent.trim().split('.');
            if (parts.length !== 3) {
                continue;
            }
            const [day, month, year] = parts.map(Number);
            const rowDate = new Date(year, month - 1, day);

            if (!fallbackRow) {
                fallbackRow = row;
            }

            if (!targetRow && rowDate >= monthStart) {
                targetRow = row;
            }

            if (rowDate >= monthStart && rowDate <= monthEnd) {
                targetRow = row;
                break;
            }
        }

        const scrollTarget = targetRow || fallbackRow;
        if (scrollTarget) {
            const headerHeight = paymentTable.querySelector('thead')?.offsetHeight || 0;
            const offsetTop = scrollTarget.offsetTop - headerHeight;
            paymentScroll.scrollTo({ top: Math.max(offsetTop - 8, 0), behavior: 'auto' });
        }
    }
});
</script>
{% endblock %}
