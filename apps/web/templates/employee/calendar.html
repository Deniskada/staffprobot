{% extends "employee/base_employee.html" %}

{% block title %}Календарь{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% include 'shared/calendar/grid_unified.html' %}
    </div>
</div>

<!-- Панели: сотруднику не нужен список объектов; панель сотрудников показывает только себя -->
{% include 'shared/calendar/employees_panel.html' %}

<!-- Модальное окно деталей собеседования -->
<div class="modal fade" id="interviewDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-event"></i> Детали собеседования
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="interview-details-content">
                <!-- Контент загружается динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Universal Calendar Integration -->
<script src="{{ url_for('static', path='js/shared/universal_calendar.js') }}"></script>
<script src="{{ 'js/shared/plan_shift_modal.js' | static_version }}"></script>
<script>
    // Инициализация универсального календаря для сотрудника
    document.addEventListener('DOMContentLoaded', function() {
         const CURRENT_EMPLOYEE_ID = {{ current_employee_id }};
         const CURRENT_EMPLOYEE_NAME = {{ current_employee_name | tojson }};

         function notifyCalendar(message, type = 'info') {
            if (type === 'error') {
                alert(message);
            } else {
                console.log(`[${type}] ${message}`);
            }
         }

         // Создаем экземпляр универсального календаря
         if (typeof UniversalCalendarManager !== 'undefined') {
             if (window.PlanShiftModal) {
                 window.PlanShiftModal.configure({
                     role: 'employee',
                     timeslotDetailEndpoint: (timeslotId) => `/employee/calendar/api/timeslot/${timeslotId}`,
                     employeesForObjectEndpoint: (objectId) => `/employee/api/calendar/employees-for-object/${objectId}`,
                     planShiftEndpoint: '/employee/api/calendar/plan-shift',
                     preselectedEmployeeId: CURRENT_EMPLOYEE_ID,
                     lockedEmployeeId: CURRENT_EMPLOYEE_ID,
                     lockedEmployeeName: CURRENT_EMPLOYEE_NAME,
                     lockEmployeeSelection: true,
                     notify: notifyCalendar,
                     preparePlannedShifts: true,
                     refreshCalendar: () => {
                         if (window.universalCalendar && typeof window.universalCalendar.refresh === 'function') {
                             window.universalCalendar.refresh();
                         } else {
                             setTimeout(() => window.location.reload(), 800);
                         }
                     }
                 });
             }

             window.universalCalendar = new UniversalCalendarManager({
                currentDate: new Date({{ year }}, {{ month - 1 }}, 1),
                viewType: 'month',
                baseUrl: '/employee',
                userRole: 'employee',
                apiEndpoint: '/employee/api/calendar/data',
                onShiftClick: function(shiftId) {
                    console.log('Shift clicked:', shiftId);
                    const params = new URLSearchParams({ return_to: '/employee/calendar' });
                    let objectId = null;
                    if (window.calendarData && Array.isArray(window.calendarData.shifts)) {
                        const shift = window.calendarData.shifts.find(s => s.id === shiftId);
                        if (shift && shift.object_id) {
                            objectId = shift.object_id;
                        }
                    }
                    if (objectId) {
                        params.set('object_id', objectId);
                    }
                    params.set('employee_id', CURRENT_EMPLOYEE_ID);

                    const scheduleId = shiftId.toString().startsWith('schedule_')
                        ? shiftId.toString().replace('schedule_', '')
                        : null;
                    if (scheduleId) {
                        params.set('schedule_id', scheduleId);
                    } else {
                        params.set('shift_id', shiftId);
                    }
                    window.location.href = `/employee/shifts/plan?${params.toString()}`;
                },
                onTimeslotClick: function(timeslotId) {
                    console.log('Timeslot clicked:', timeslotId);
                    if (window.PlanShiftModal && typeof window.PlanShiftModal.open === 'function') {
                        window.PlanShiftModal.open(timeslotId);
                        return;
                    }
                    const params = new URLSearchParams({ return_to: '/employee/calendar', timeslot_id: timeslotId, employee_id: CURRENT_EMPLOYEE_ID });
                    window.location.href = `/employee/shifts/plan?${params.toString()}`;
                },
                onDataLoaded: function(calendarData) {
                    console.log('Calendar data loaded:', calendarData);
                    // Используем унифицированную функцию отрисовки
                    if (window.renderCalendarGrid) {
                        window.renderCalendarGrid(calendarData);
                    }
                }
            });
        }
    });
</script>

<script>
// Данные календаря загружаются через API endpoint

function showShiftDetails(shiftId) {
    if (shiftId.toString().startsWith('schedule_')) {
        const scheduleId = shiftId.toString().replace('schedule_', '');
        window.location.href = `/employee/shifts/${scheduleId}?shift_type=schedule`;
    } else {
        window.location.href = `/employee/shifts/${shiftId}?shift_type=shift`;
    }
}

function showTimeslotDetails(timeslotId) {
    window.location.href = `/employee/timeslots/${timeslotId}`;
}

function showInterviewDetails(interviewId) {
    // Загружаем детали собеседования
    fetch(`/employee/api/interviews/${interviewId}`)
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('interviewDetailsModal');
            const content = document.getElementById('interview-details-content');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Информация о собеседовании</h6>
                        <p><strong>Дата:</strong> ${data.date}</p>
                        <p><strong>Время:</strong> ${data.time}</p>
                        <p><strong>Объект:</strong> ${data.object_name}</p>
                        <p><strong>Адрес:</strong> ${data.object_address}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Контактная информация</h6>
                        <p><strong>Контактное лицо:</strong> ${data.contact_person || 'Не указано'}</p>
                        <p><strong>Телефон:</strong> ${data.contact_phone || 'Не указан'}</p>
                        <p><strong>Статус:</strong> <span class="badge bg-info">${data.status}</span></p>
                    </div>
                </div>
                ${data.notes ? `<div class="mt-3"><h6>Примечания:</h6><p>${data.notes}</p></div>` : ''}
            `;
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        })
        .catch(error => {
            console.error('Ошибка загрузки деталей собеседования:', error);
            alert('Ошибка загрузки деталей собеседования');
        });
}

// Функция для обновления отображения тайм-слотов
function updateTimeslotDisplay() {
    const timeslots = document.querySelectorAll('.timeslot-item');
    const max = Math.max(...Array.from(timeslots).map(ts => parseInt(ts.dataset.current) || 0));
    
    timeslots.forEach(ts => {
        const current = parseInt(ts.dataset.current) || 0;
        if (current >= max) ts.style.display = 'none'; else ts.style.display = '';
    });
}
</script>
{% endblock %}