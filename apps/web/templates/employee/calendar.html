{% extends "employee/base_employee.html" %}

{% block title %}Календарь{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% include 'shared/calendar/grid_unified.html' %}
    </div>
</div>

<!-- Панели: сотруднику не нужен список объектов; панель сотрудников показывает только себя -->
{% include 'shared/calendar/employees_panel.html' %}

<!-- Модальное окно деталей собеседования -->
<div class="modal fade" id="interviewDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-event"></i> Детали собеседования
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="interview-details-content">
                <!-- Контент загружается динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Universal Calendar Integration -->
<script src="{{ url_for('static', path='js/shared/universal_calendar.js') }}"></script>
<script>
    // Инициализация универсального календаря для сотрудника
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализируем панели drag&drop
        if (typeof CalendarPanels !== 'undefined') {
            window.calendarPanels = new CalendarPanels('employee');
            window.calendarPanels.init();
        }
        
        // Создаем экземпляр универсального календаря
        if (typeof UniversalCalendarManager !== 'undefined') {
            window.universalCalendar = new UniversalCalendarManager({
                currentDate: new Date({{ year }}, {{ month - 1 }}, 1),
                viewType: 'month',
                baseUrl: '/employee/calendar',
                userRole: 'employee',
                apiEndpoint: '/employee/api/calendar/data',
                onShiftClick: function(shiftId) {
                    console.log('Shift clicked:', shiftId);
                    if (shiftId.toString().startsWith('schedule_')) {
                        const scheduleId = shiftId.toString().replace('schedule_', '');
                        window.location.href = `/employee/shifts/${scheduleId}?shift_type=schedule`;
                    } else {
                        window.location.href = `/employee/shifts/${shiftId}?shift_type=shift`;
                    }
                },
                onTimeslotClick: function(timeslotId) {
                    console.log('Timeslot clicked:', timeslotId);
                    window.location.href = `/employee/timeslots/${timeslotId}`;
                },
                onDataLoaded: function(calendarData) {
                    console.log('Calendar data loaded:', calendarData);
                    // Используем унифицированную функцию отрисовки
                    if (window.renderCalendarGrid) {
                        window.renderCalendarGrid(calendarData);
                    }
                }
            });
        }
    });
</script>

<script>
// Данные календаря загружаются через API endpoint

function showShiftDetails(shiftId) {
    if (shiftId.toString().startsWith('schedule_')) {
        const scheduleId = shiftId.toString().replace('schedule_', '');
        window.location.href = `/employee/shifts/${scheduleId}?shift_type=schedule`;
    } else {
        window.location.href = `/employee/shifts/${shiftId}?shift_type=shift`;
    }
}

function showTimeslotDetails(timeslotId) {
    window.location.href = `/employee/timeslots/${timeslotId}`;
}

function showInterviewDetails(interviewId) {
    // Загружаем детали собеседования
    fetch(`/employee/api/interviews/${interviewId}`)
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('interviewDetailsModal');
            const content = document.getElementById('interview-details-content');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Информация о собеседовании</h6>
                        <p><strong>Дата:</strong> ${data.date}</p>
                        <p><strong>Время:</strong> ${data.time}</p>
                        <p><strong>Объект:</strong> ${data.object_name}</p>
                        <p><strong>Адрес:</strong> ${data.object_address}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Контактная информация</h6>
                        <p><strong>Контактное лицо:</strong> ${data.contact_person || 'Не указано'}</p>
                        <p><strong>Телефон:</strong> ${data.contact_phone || 'Не указан'}</p>
                        <p><strong>Статус:</strong> <span class="badge bg-info">${data.status}</span></p>
                    </div>
                </div>
                ${data.notes ? `<div class="mt-3"><h6>Примечания:</h6><p>${data.notes}</p></div>` : ''}
            `;
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        })
        .catch(error => {
            console.error('Ошибка загрузки деталей собеседования:', error);
            alert('Ошибка загрузки деталей собеседования');
        });
}

// Функция для обновления отображения тайм-слотов
function updateTimeslotDisplay() {
    const timeslots = document.querySelectorAll('.timeslot-item');
    const max = Math.max(...Array.from(timeslots).map(ts => parseInt(ts.dataset.current) || 0));
    
    timeslots.forEach(ts => {
        const current = parseInt(ts.dataset.current) || 0;
        if (current >= max) ts.style.display = 'none'; else ts.style.display = '';
    });
}
</script>
{% endblock %}