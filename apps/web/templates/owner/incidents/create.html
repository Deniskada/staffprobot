{% extends "owner/base_owner.html" %}
{% block title %}Создать инцидент{% endblock %}
{% block content %}
<div class="container mt-4">
  <h3>Создать инцидент</h3>
  <form method="post" action="/owner/incidents/create">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Категория</label>
        <select class="form-select" name="category" required>
          {% for c in categories %}
            <option value="{{ c.name }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Критичность</label>
        <select class="form-select" name="severity">
          <option value="low">Низкая</option>
          <option value="medium" selected>Средняя</option>
          <option value="high">Высокая</option>
          <option value="critical">Критичная</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Номер</label>
        <input type="text" name="custom_number" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label">Дата</label>
        <input type="date" name="custom_date" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label">Объект</label>
        <select class="form-select" name="object_id" id="incidentObject">
          <option value="">— не выбран —</option>
          {% for o in objects %}
            <option value="{{ o.id }}">{{ o.name }} (ID {{ o.id }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Сотрудник</label>
        <select class="form-select" name="employee_id" id="incidentEmployee" disabled>
          <option value="">Сначала выберите объект</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Ущерб (сумма)</label>
        <input type="number" step="0.01" name="damage_amount" class="form-control">
      </div>
      <div class="col-12">
        <label class="form-label">Описание</label>
        <textarea name="notes" rows="8" class="form-control"></textarea>
      </div>
    </div>
    <div class="mt-3">
      <a href="/owner/incidents" class="btn btn-secondary">Отмена</a>
      <button type="submit" class="btn btn-danger">Создать</button>
    </div>
  </form>
</div>
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const objectSelect = document.getElementById('incidentObject');
  const employeeSelect = document.getElementById('incidentEmployee');

  if (!objectSelect || !employeeSelect) {
    console.error('Не удалось инициализировать форму инцидента (создание)');
    return;
  }

  function resetEmployeeSelect(message) {
    employeeSelect.innerHTML = `<option value="">${message}</option>`;
    employeeSelect.disabled = true;
  }

  function renderEmployeeGroups(groups) {
    employeeSelect.innerHTML = '<option value="">Выберите сотрудника</option>';

    if (groups.active && groups.active.length > 0) {
      groups.active.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.id;
        opt.textContent = formatEmployeeName(emp);
        employeeSelect.appendChild(opt);
      });
    }

    if (groups.former && groups.former.length > 0) {
      const divider = document.createElement('option');
      divider.value = '';
      divider.disabled = true;
      divider.textContent = 'Бывшие';
      divider.classList.add('fw-bold', 'fst-italic', 'text-muted');
      employeeSelect.appendChild(divider);

      groups.former.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.id;
        opt.textContent = formatEmployeeName(emp);
        opt.classList.add('fst-italic', 'text-muted');
        employeeSelect.appendChild(opt);
      });
    }

    employeeSelect.disabled = false;
  }

  function formatEmployeeName(emp) {
    const parts = [];
    if (emp.last_name) parts.push(emp.last_name);
    if (emp.first_name) parts.push(emp.first_name);
    if (emp.middle_name) parts.push(emp.middle_name);
    return parts.join(' ').trim() || `ID ${emp.id}`;
  }

  async function loadEmployees(objectId) {
    resetEmployeeSelect('Загрузка сотрудников...');
    try {
      const response = await fetch(`/owner/incidents/api/employees?object_id=${encodeURIComponent(objectId)}`);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();
      renderEmployeeGroups(data || { active: [], former: [] });
    } catch (error) {
      console.error('Ошибка загрузки сотрудников:', error);
      resetEmployeeSelect('Не удалось загрузить сотрудников');
    }
  }

  objectSelect.addEventListener('change', function () {
    const objectId = this.value;
    if (!objectId) {
      resetEmployeeSelect('Сначала выберите объект');
      return;
    }
    loadEmployees(objectId);
  });
});
</script>
{% endblock %}
{% endblock %}


