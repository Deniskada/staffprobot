{% extends "owner/base_owner.html" %}
{% block title %}Тикеты{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between mb-3 align-items-center">
    <h2>Тикеты</h2>
    <div class="d-flex gap-2">
      <div class="btn-group">
        <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-download"></i> Экспорт
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="exportIncidents('excel'); return false;">
            <i class="bi bi-file-earmark-spreadsheet"></i> Excel (.xlsx)
          </a></li>
          <li><a class="dropdown-item" href="#" onclick="exportIncidents('pdf'); return false;">
            <i class="bi bi-file-earmark-pdf"></i> PDF (.pdf)
          </a></li>
        </ul>
      </div>
      <a href="/owner/products" class="btn btn-outline-info">
        <i class="bi bi-box-seam"></i> Товары
      </a>
      <a href="/owner/incidents/categories?incident_type={{ incident_type }}" class="btn btn-outline-secondary">
        <i class="bi bi-tags"></i> Категории
      </a>
      <a href="/owner/incidents/create?incident_type={{ incident_type }}" class="btn btn-danger">
        <i class="fas fa-plus"></i> Создать
      </a>
    </div>
  </div>

  <!-- Табы типов -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link {{ 'active' if incident_type == 'deduction' }}" href="/owner/incidents?incident_type=deduction">
        Удержания <span class="badge bg-secondary">{{ type_counts.get('deduction', 0) }}</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {{ 'active' if incident_type == 'request' }}" href="/owner/incidents?incident_type=request">
        Обращения <span class="badge bg-secondary">{{ type_counts.get('request', 0) }}</span>
      </a>
    </li>
  </ul>

  <!-- Фильтры -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-3" id="filtersForm">
        <input type="hidden" name="incident_type" value="{{ incident_type }}">
        <div class="col-md-12">
          <label class="form-label fw-bold">Статус</label>
          <div class="btn-group flex-wrap" role="group">
            {% set statuses_list = (statuses_filter or '').split(',') if statuses_filter else [] %}
            {% set has_status_filter = statuses_filter or status_filter %}
            <input type="checkbox" class="btn-check" id="status_all" name="statuses" value="all" {% if not has_status_filter %}checked{% endif %} onchange="handleStatusAllChange()">
            <label class="btn btn-sm {{ 'btn-primary' if not has_status_filter else 'btn-outline-primary' }}" for="status_all">Все</label>
            
            <input type="checkbox" class="btn-check" id="status_new" name="statuses" value="new" {% if 'new' in statuses_list or status_filter == 'new' %}checked{% endif %} onchange="handleStatusChange()">
            <label class="btn btn-sm {{ 'btn-primary' if ('new' in statuses_list or status_filter == 'new') else 'btn-outline-primary' }}" for="status_new">Новые</label>
            
            <input type="checkbox" class="btn-check" id="status_in_review" name="statuses" value="in_review" {% if 'in_review' in statuses_list or status_filter == 'in_review' %}checked{% endif %} onchange="handleStatusChange()">
            <label class="btn btn-sm {{ 'btn-primary' if ('in_review' in statuses_list or status_filter == 'in_review') else 'btn-outline-primary' }}" for="status_in_review">На рассмотрении</label>
            
            <input type="checkbox" class="btn-check" id="status_resolved" name="statuses" value="resolved" {% if 'resolved' in statuses_list or status_filter == 'resolved' %}checked{% endif %} onchange="handleStatusChange()">
            <label class="btn btn-sm {{ 'btn-primary' if ('resolved' in statuses_list or status_filter == 'resolved') else 'btn-outline-primary' }}" for="status_resolved">Решённые</label>
            
            <input type="checkbox" class="btn-check" id="status_rejected" name="statuses" value="rejected" {% if 'rejected' in statuses_list or status_filter == 'rejected' %}checked{% endif %} onchange="handleStatusChange()">
            <label class="btn btn-sm {{ 'btn-primary' if ('rejected' in statuses_list or status_filter == 'rejected') else 'btn-outline-primary' }}" for="status_rejected">Отклонённые</label>
            
            <input type="checkbox" class="btn-check" id="status_cancelled" name="statuses" value="cancelled" {% if 'cancelled' in statuses_list or status_filter == 'cancelled' %}checked{% endif %} onchange="handleStatusChange()">
            <label class="btn btn-sm {{ 'btn-primary' if ('cancelled' in statuses_list or status_filter == 'cancelled') else 'btn-outline-primary' }}" for="status_cancelled">Отменённые</label>
          </div>
        </div>
        
        <div class="col-md-3">
          <label class="form-label">Категория</label>
          <select class="form-select form-select-sm" name="category" onchange="applyFilters()">
            <option value="">Все категории</option>
            {% for c in categories %}
              <option value="{{ c.name }}" {% if category_filter == c.name %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-3">
          <label class="form-label">Объект</label>
          <select class="form-select form-select-sm" name="object_id" onchange="applyFilters()">
            <option value="">Все объекты</option>
            {% for o in objects %}
              <option value="{{ o.id }}" {% if object_id_filter == o.id %}selected{% endif %}>{{ o.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-3">
          <label class="form-label">Сотрудник</label>
          <select class="form-select form-select-sm" name="employee_id" onchange="applyFilters()">
            <option value="">Все сотрудники</option>
            {% for e in employees %}
              <option value="{{ e.id }}" {% if employee_id_filter == e.id %}selected{% endif %}>{{ e.last_name }} {{ e.first_name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-3 d-flex align-items-end">
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">Очистить фильтры</button>
        </div>
      </form>
    </div>
  </div>
  
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="text-muted small">
      Показано {{ incidents|length }} из {{ total_count }}
    </div>
    <div>
      <label class="form-label small me-2">На странице:</label>
      <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="changePerPage(this.value)">
        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
      </select>
    </div>
  </div>
  
  <table class="table table-sm table-hover">
    <thead>
      <tr>
        <th>
          <a href="#" onclick="sortTable('number'); return false;" class="text-decoration-none text-dark">
            Номер {% if sort_by == 'number' %}<i class="bi bi-arrow-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
          </a>
        </th>
        <th>
          <a href="#" onclick="sortTable('custom_date'); return false;" class="text-decoration-none text-dark">
            Дата {% if sort_by == 'custom_date' %}<i class="bi bi-arrow-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
          </a>
        </th>
        <th>Категория</th>
        {% if incident_type == 'deduction' %}
        <th>Критичность</th>
        {% endif %}
        <th>Объект</th>
        <th>Сотрудник</th>
        <th>Статус</th>
        {% if incident_type == 'deduction' %}
        <th>Ущерб</th>
        {% else %}
        <th>Компенсация</th>
        {% endif %}
        <th>Создал</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
    {% for inc in incidents %}
      <tr class="{{ 'table-danger' if inc.severity == 'critical' else 'table-warning' if inc.severity == 'high' else '' }}">
        <td>{{ inc.custom_number or '—' }}</td>
        <td>{{ inc.custom_date.strftime('%d.%m.%Y') if inc.custom_date else '—' }}</td>
        <td>{{ inc.category }}</td>
        {% if incident_type == 'deduction' %}
        <td>
          {% if inc.severity == 'critical' %}
            <span class="badge bg-danger">Критично</span>
          {% elif inc.severity == 'high' %}
            <span class="badge bg-warning">Высокая</span>
          {% elif inc.severity == 'medium' %}
            <span class="badge bg-info">Средняя</span>
          {% else %}
            <span class="badge bg-secondary">Низкая</span>
          {% endif %}
        </td>
        {% endif %}
        <td>{{ inc.object.name if inc.object else '—' }}</td>
        <td>
          {% if inc.employee %}
            {{ inc.employee.last_name }} {{ inc.employee.first_name }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>
          {% if inc.status == 'new' %}
            <span class="badge bg-danger">Новый</span>
          {% elif inc.status == 'in_review' %}
            <span class="badge bg-warning">На рассмотрении</span>
          {% elif inc.status == 'resolved' %}
            <span class="badge bg-success">Решён</span>
          {% elif inc.status == 'rejected' %}
            <span class="badge bg-secondary">Отклонён</span>
          {% elif inc.status == 'cancelled' %}
            <span class="badge bg-dark">Отменён</span>
          {% endif %}
        </td>
        <td>
          {% if incident_type == 'deduction' %}
            {{ '{:,.2f}'.format(inc.damage_amount).replace(',', ' ') if inc.damage_amount is not none else '—' }}
          {% else %}
            {% if inc.compensate_purchase %}
              <span class="badge bg-success"><i class="bi bi-check"></i> Да</span>
            {% else %}
              <span class="badge bg-secondary">Нет</span>
            {% endif %}
          {% endif %}
        </td>
        <td>{{ inc.creator.first_name if inc.creator else '—' }}</td>
        <td>
          <a href="/owner/incidents/{{ inc.id }}/edit?return_url={{ (request.url.path + '?' + request.url.query if request.url.query else request.url.path)|urlencode }}" class="btn btn-sm btn-outline-primary me-1" title="Редактировать">
            <i class="bi bi-pencil"></i>
          </a>
          {% if inc.status == 'new' %}
            <form method="post" action="/owner/incidents/{{ inc.id }}/status" class="d-inline" onsubmit="addReturnUrl(this); return true;">
              <input type="hidden" name="new_status" value="in_review">
              <button type="submit" class="btn btn-sm btn-warning" title="Взять на рассмотрение">
                <i class="fas fa-eye"></i>
              </button>
            </form>
          {% elif inc.status == 'in_review' %}
            <form method="post" action="/owner/incidents/{{ inc.id }}/status" class="d-inline" onsubmit="addReturnUrl(this); return true;">
              <input type="hidden" name="new_status" value="resolved">
              <button type="submit" class="btn btn-sm btn-success" title="Решить">
                <i class="fas fa-check"></i>
              </button>
            </form>
            <form method="post" action="/owner/incidents/{{ inc.id }}/status" class="d-inline" onsubmit="addReturnUrl(this); return true;">
              <input type="hidden" name="new_status" value="rejected">
              <button type="submit" class="btn btn-sm btn-secondary" title="Отклонить">
                <i class="fas fa-times"></i>
              </button>
            </form>
          {% endif %}
          {% if inc.status not in ['cancelled', 'resolved', 'rejected'] %}
            <button type="button" class="btn btn-sm btn-outline-danger" title="Отменить" onclick="showCancelModal({{ inc.id }}, '{{ inc.custom_number or ('#' ~ inc.id) }}')">
              <i class="bi bi-x-circle"></i>
            </button>
          {% endif %}
        </td>
      </tr>
    {% else %}
      <tr><td colspan="10" class="text-center text-muted">Тикетов не найдено.</td></tr>
    {% endfor %}
    </tbody>
  </table>
  
  {% if total_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if page == 1 %}disabled{% endif %}">
        <a class="page-link" href="#" onclick="goToPage(1); return false;">Первая</a>
      </li>
      <li class="page-item {% if page == 1 %}disabled{% endif %}">
        <a class="page-link" href="#" onclick="goToPage({{ page - 1 }}); return false;">Назад</a>
      </li>
      <li class="page-item active">
        <span class="page-link">{{ page }} / {{ total_pages }}</span>
      </li>
      <li class="page-item {% if page == total_pages %}disabled{% endif %}">
        <a class="page-link" href="#" onclick="goToPage({{ page + 1 }}); return false;">Вперед</a>
      </li>
      <li class="page-item {% if page == total_pages %}disabled{% endif %}">
        <a class="page-link" href="#" onclick="goToPage({{ total_pages }}); return false;">Последняя</a>
      </li>
    </ul>
  </nav>
  {% endif %}
</div>

<!-- Модальное окно отмены -->
<div class="modal fade" id="cancelIncidentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" id="cancelIncidentForm">
        <input type="hidden" name="cancellation_reason" id="cancelReasonInput">
        <input type="hidden" name="return_url" id="cancelReturnUrlInput">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">Отменить тикет <span id="cancelIncidentNumber"></span>?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">Выберите причину отмены:</p>
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="reason_radio" id="reason_duplicate" value="duplicate" checked>
            <label class="form-check-label" for="reason_duplicate">Ошибочно заведен (дубль)</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="reason_radio" id="reason_not_confirmed" value="not_confirmed">
            <label class="form-check-label" for="reason_not_confirmed">Не подтвердился</label>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="reason_radio" id="reason_owner_decision" value="owner_decision">
            <label class="form-check-label" for="reason_owner_decision">Решение владельца</label>
          </div>
          <div class="mb-3">
            <label for="cancelNotes" class="form-label">Комментарий:</label>
            <textarea class="form-control" id="cancelNotes" name="notes" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-warning">Отменить тикет</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const currentType = '{{ incident_type }}';

function buildBaseUrl() { return '/owner/incidents'; }

function sortTable(field) {
  const params = new URLSearchParams(window.location.search);
  const currentSort = params.get('sort_by') || 'created_at';
  const currentOrder = params.get('sort_order') || 'desc';
  params.set('sort_by', field);
  params.set('sort_order', currentSort === field && currentOrder === 'desc' ? 'asc' : 'desc');
  params.set('page', '1');
  params.set('incident_type', currentType);
  window.location.href = buildBaseUrl() + '?' + params.toString();
}

function goToPage(pageNum) {
  const params = new URLSearchParams(window.location.search);
  params.set('page', pageNum.toString());
  params.set('incident_type', currentType);
  window.location.href = buildBaseUrl() + '?' + params.toString();
}

function addReturnUrl(form) {
  const currentUrl = window.location.pathname + (window.location.search || '');
  form.action = form.action + (form.action.includes('?') ? '&' : '?') + 'return_url=' + encodeURIComponent(currentUrl);
  return true;
}

function handleStatusAllChange() {
  if (document.getElementById('status_all').checked) {
    document.querySelectorAll('input[name="statuses"]:not(#status_all)').forEach(cb => {
      cb.checked = false;
      const label = document.querySelector(`label[for="${cb.id}"]`);
      if (label) { label.classList.remove('btn-primary'); label.classList.add('btn-outline-primary'); }
    });
    updateStatusFilters();
  }
}

function handleStatusChange() {
  const allCb = document.getElementById('status_all');
  const specific = Array.from(document.querySelectorAll('input[name="statuses"]:not(#status_all):checked'));
  if (specific.length > 0) {
    allCb.checked = false;
    document.querySelector('label[for="status_all"]')?.classList.replace('btn-primary', 'btn-outline-primary');
  } else {
    allCb.checked = true;
    document.querySelector('label[for="status_all"]')?.classList.replace('btn-outline-primary', 'btn-primary');
  }
  document.querySelectorAll('input[name="statuses"]:not(#status_all)').forEach(cb => {
    const label = document.querySelector(`label[for="${cb.id}"]`);
    if (label) { cb.checked ? label.classList.replace('btn-outline-primary', 'btn-primary') : label.classList.replace('btn-primary', 'btn-outline-primary'); }
  });
  updateStatusFilters();
}

function updateStatusFilters() {
  const checked = Array.from(document.querySelectorAll('input[name="statuses"]:checked')).map(cb => cb.value).filter(v => v !== 'all');
  const params = new URLSearchParams(window.location.search);
  params.delete('status'); params.delete('statuses'); params.delete('page');
  params.set('incident_type', currentType);
  if (checked.length > 0) params.set('statuses', checked.join(','));
  window.location.href = buildBaseUrl() + '?' + params.toString();
}

function applyFilters() {
  const form = document.getElementById('filtersForm');
  const fd = new FormData(form);
  const params = new URLSearchParams();
  params.set('incident_type', currentType);
  const statuses = Array.from(form.querySelectorAll('input[name="statuses"]:checked')).map(cb => cb.value).filter(v => v !== 'all');
  if (statuses.length > 0) params.set('statuses', statuses.join(','));
  const cat = fd.get('category'); if (cat) params.set('category', cat);
  const oid = fd.get('object_id'); if (oid) params.set('object_id', oid);
  const eid = fd.get('employee_id'); if (eid) params.set('employee_id', eid);
  window.location.href = buildBaseUrl() + '?' + params.toString();
}

function clearFilters() { window.location.href = buildBaseUrl() + '?incident_type=' + currentType; }

function changePerPage(value) {
  const params = new URLSearchParams(window.location.search);
  params.set('per_page', value); params.set('page', '1'); params.set('incident_type', currentType);
  window.location.href = buildBaseUrl() + '?' + params.toString();
}

function showCancelModal(incidentId, incidentNumber) {
  document.getElementById('cancelIncidentNumber').textContent = incidentNumber;
  document.getElementById('cancelIncidentForm').action = `/owner/incidents/${incidentId}/cancel`;
  document.getElementById('cancelReturnUrlInput').value = window.location.href;
  document.getElementById('cancelReasonInput').value = 'duplicate';
  document.getElementById('cancelNotes').value = '';
  document.getElementById('reason_duplicate').checked = true;
  document.querySelectorAll('input[name="reason_radio"]').forEach(r => r.addEventListener('change', function() {
    document.getElementById('cancelReasonInput').value = this.value;
  }));
  new bootstrap.Modal(document.getElementById('cancelIncidentModal')).show();
}

function exportIncidents(format) {
  const params = new URLSearchParams(window.location.search);
  params.set('incident_type', currentType);
  window.location.href = `/owner/incidents/export/${format}?${params.toString()}`;
}
</script>
{% endblock %}
