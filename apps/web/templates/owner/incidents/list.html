{% extends "owner/base_owner.html" %}
{% block title %}Инциденты{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between mb-3 align-items-center">
    <h2>Инциденты</h2>
    <div class="d-flex gap-2">
      <a href="/owner/incidents/categories" class="btn btn-outline-secondary">
        <i class="bi bi-tags"></i> Категории
      </a>
      <a href="/owner/incidents/create" class="btn btn-danger">
        <i class="fas fa-exclamation-triangle"></i> Создать инцидент
      </a>
    </div>
  </div>

  <!-- Фильтры -->
  <div class="mb-3">
    <a href="/owner/incidents" class="btn btn-sm {{ 'btn-primary' if not status_filter else 'btn-outline-primary' }}">Все</a>
    <a href="/owner/incidents?status=new" class="btn btn-sm {{ 'btn-primary' if status_filter == 'new' else 'btn-outline-primary' }}">Новые</a>
    <a href="/owner/incidents?status=in_review" class="btn btn-sm {{ 'btn-primary' if status_filter == 'in_review' else 'btn-outline-primary' }}">На рассмотрении</a>
    <a href="/owner/incidents?status=resolved" class="btn btn-sm {{ 'btn-primary' if status_filter == 'resolved' else 'btn-outline-primary' }}">Решённые</a>
    <a href="/owner/incidents?status=rejected" class="btn btn-sm {{ 'btn-primary' if status_filter == 'rejected' else 'btn-outline-primary' }}">Отклонённые</a>
  </div>
  
  <table class="table table-sm table-hover">
    <thead>
      <tr>
        <th>Номер</th>
        <th>Дата</th>
        <th>Категория</th>
        <th>Критичность</th>
        <th>Объект</th>
        <th>Сотрудник</th>
        <th>Статус</th>
        <th>Ущерб</th>
        <th>Создал</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
    {% for inc in incidents %}
      <tr class="{{ 'table-danger' if inc.severity == 'critical' else 'table-warning' if inc.severity == 'high' else '' }}">
        <td>{{ inc.custom_number or '—' }}</td>
        <td>{{ inc.custom_date.strftime('%d.%m.%Y') if inc.custom_date else '—' }}</td>
        <td>
          {% if inc.category == 'late_arrival' %}
            <i class="fas fa-clock"></i> Опоздание
          {% elif inc.category == 'task_non_completion' %}
            <i class="fas fa-tasks"></i> Невыполнение задачи
          {% elif inc.category == 'damage' %}
            <i class="fas fa-tools"></i> Повреждение
          {% elif inc.category == 'violation' %}
            <i class="fas fa-ban"></i> Нарушение
          {% else %}
            {{ inc.category }}
          {% endif %}
        </td>
        <td>
          {% if inc.severity == 'critical' %}
            <span class="badge bg-danger">Критично</span>
          {% elif inc.severity == 'high' %}
            <span class="badge bg-warning">Высокая</span>
          {% elif inc.severity == 'medium' %}
            <span class="badge bg-info">Средняя</span>
          {% else %}
            <span class="badge bg-secondary">Низкая</span>
          {% endif %}
        </td>
        <td>{{ inc.object.name if inc.object else '—' }}</td>
        <td>
          {% if inc.employee %}
            {{ inc.employee.last_name }} {{ inc.employee.first_name }}
          {% else %}
            {{ inc.employee_id or '—' }}
          {% endif %}
        </td>
        <td>
          {% if inc.status == 'new' %}
            <span class="badge bg-danger">Новый</span>
          {% elif inc.status == 'in_review' %}
            <span class="badge bg-warning">На рассмотрении</span>
          {% elif inc.status == 'resolved' %}
            <span class="badge bg-success">Решён</span>
          {% elif inc.status == 'rejected' %}
            <span class="badge bg-secondary">Отклонён</span>
          {% endif %}
        </td>
        <td>{{ '{:,.2f}'.format(inc.damage_amount).replace(',', ' ') if inc.damage_amount is not none else '—' }}</td>
        <td>
          {% if inc.creator %}
            {{ inc.creator.first_name }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>
          <a href="/owner/incidents/{{ inc.id }}/edit" class="btn btn-sm btn-outline-primary me-1" title="Редактировать">
            <i class="bi bi-pencil"></i>
          </a>
          {% if inc.status == 'new' %}
            <form method="post" action="/owner/incidents/{{ inc.id }}/status" class="d-inline">
              <input type="hidden" name="new_status" value="in_review">
              <button type="submit" class="btn btn-sm btn-warning" title="Взять на рассмотрение">
                <i class="fas fa-eye"></i>
              </button>
            </form>
          {% elif inc.status == 'in_review' %}
            <form method="post" action="/owner/incidents/{{ inc.id }}/status" class="d-inline">
              <input type="hidden" name="new_status" value="resolved">
              <button type="submit" class="btn btn-sm btn-success" title="Решить">
                <i class="fas fa-check"></i>
              </button>
            </form>
            <form method="post" action="/owner/incidents/{{ inc.id }}/status" class="d-inline">
              <input type="hidden" name="new_status" value="rejected">
              <button type="submit" class="btn btn-sm btn-secondary" title="Отклонить">
                <i class="fas fa-times"></i>
              </button>
            </form>
          {% endif %}
          {% if inc.suggested_adjustments and inc.status != 'rejected' %}
            <form method="post" action="/owner/incidents/{{ inc.id }}/apply-adjustments" class="d-inline" onsubmit="return confirm('Применить корректировки?')">
              <button type="submit" class="btn btn-sm btn-info" title="Применить корректировки">
                <i class="fas fa-coins"></i>
              </button>
            </form>
          {% endif %}
        </td>
      </tr>
    {% else %}
      <tr><td colspan="10" class="text-center text-muted">Инцидентов не найдено.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<!-- Убрано модальное создание; используется отдельная страница -->
{% endblock %}
