{% extends "owner/base_owner.html" %}
{% block title %}Редактирование инцидента{% endblock %}
{% block content %}
<div class="container mt-4">
  <h3>Инцидент {{ incident.custom_number or ('#' ~ incident.id) }}</h3>
  
  {% if incident.status in ['resolved', 'rejected', 'cancelled'] %}
  <div class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle"></i> Нельзя редактировать инцидент со статусом "{{ 'Решен' if incident.status == 'resolved' else ('Отклонен' if incident.status == 'rejected' else 'Отменен') }}".
    <a href="{{ back_url if back_url else '/owner/incidents' }}" class="alert-link" id="backToListLink">Вернуться к списку инцидентов</a>
  </div>
  {% else %}
  <form method="post" action="/owner/incidents/{{ incident.id }}/edit">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Номер</label>
        <input type="text" name="custom_number" class="form-control" value="{{ incident.custom_number or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Дата</label>
        <input type="date" name="custom_date" class="form-control" value="{{ incident.custom_date.strftime('%Y-%m-%d') if incident.custom_date else '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Ущерб</label>
        <input type="number" step="0.01" name="damage_amount" class="form-control" value="{{ incident.damage_amount or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Категория</label>
        <select name="category" class="form-select">
          {% for c in categories %}
            <option value="{{ c.name }}" {{ 'selected' if incident.category==c.name else '' }}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Критичность</label>
        <select name="severity" class="form-select">
          {% set severity_labels = {'low':'Низкая','medium':'Средняя','high':'Высокая','critical':'Критичная'} %}
          {% for s,val in severity_labels.items() %}
            <option value="{{ s }}" {{ 'selected' if incident.severity==s else '' }}>{{ val }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Статус</label>
        <select name="status" class="form-select">
          {% set status_labels = {'new':'Новый','in_review':'На рассмотрении','resolved':'Решён','rejected':'Отклонён'} %}
          {% for st,val in status_labels.items() %}
            <option value="{{ st }}" {{ 'selected' if incident.status==st else '' }}>{{ val }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Сотрудник</label>
        <select name="employee_id" class="form-select" id="ownerIncidentEmployee" {% if not incident.object %}disabled{% endif %}>
          <option value="">{% if incident.object %}Выберите сотрудника{% else %}Сначала выберите объект{% endif %}</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Объект</label>
        <select name="object_id" class="form-select" id="ownerIncidentObject">
          <option value="">— не выбран —</option>
          {% for o in objects %}
            <option value="{{ o.id }}" {{ 'selected' if incident.object_id==o.id else '' }}>{{ o.name }} (ID {{ o.id }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12">
        <label class="form-label">Описание</label>
        <textarea name="notes" class="form-control" rows="3">{{ incident.notes or '' }}</textarea>
      </div>
    </div>
    <input type="hidden" name="return_url" value="{{ back_url }}">
    <div class="mt-3">
      <a href="{{ back_url }}" class="btn btn-secondary" id="backToListBtn">Вернуться к списку</a>
      {% if incident.status not in ['cancelled', 'resolved', 'rejected'] %}
        <button type="button" class="btn btn-outline-danger" onclick="showCancelModal({{ incident.id }}, '{{ incident.custom_number or ('#' ~ incident.id) }}')">
          <i class="bi bi-x-circle"></i> Отменить инцидент
        </button>
      {% endif %}
      <button type="submit" class="btn btn-primary">Сохранить</button>
    </div>
  </form>
  {% endif %}
  
  <!-- Модальное окно отмены инцидента -->
  <div class="modal fade" id="cancelIncidentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" id="cancelIncidentForm">
          <input type="hidden" name="cancellation_reason" id="cancelReasonInput">
          <input type="hidden" name="return_url" id="cancelReturnUrlInput">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">Отменить инцидент <span id="cancelIncidentNumber"></span>?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="mb-3">Выберите причину отмены инцидента:</p>
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="reason_radio" id="reason_duplicate" value="duplicate" checked>
              <label class="form-check-label" for="reason_duplicate">
                Ошибочно заведен (дубль)
              </label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="reason_radio" id="reason_not_confirmed" value="not_confirmed">
              <label class="form-check-label" for="reason_not_confirmed">
                Инцидент не подтвердился
              </label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="radio" name="reason_radio" id="reason_owner_decision" value="owner_decision">
              <label class="form-check-label" for="reason_owner_decision">
                Решение владельца
              </label>
            </div>
            <div class="mb-3">
              <label for="cancelNotes" class="form-label">Комментарий (необязательно):</label>
              <textarea class="form-control" id="cancelNotes" name="notes" rows="3" placeholder="Дополнительная информация об отмене"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-warning">Отменить инцидент</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  function showCancelModal(incidentId, incidentNumber) {
  document.getElementById('cancelIncidentNumber').textContent = incidentNumber;
  const backBtn = document.getElementById('backToListBtn');
  const backUrl = backBtn ? backBtn.href : '{{ back_url if back_url else "/owner/incidents" }}';
  const cancelForm = document.getElementById('cancelIncidentForm');
  cancelForm.action = `/owner/incidents/${incidentId}/cancel`;
  document.getElementById('cancelReturnUrlInput').value = backUrl;
  
  // Сброс формы
  document.getElementById('cancelNotes').value = '';
  document.getElementById('reason_duplicate').checked = true;
  document.getElementById('reason_not_confirmed').checked = false;
  document.getElementById('reason_owner_decision').checked = false;
  
  // Обновление скрытого поля при изменении радиокнопок
  document.querySelectorAll('input[name="reason_radio"]').forEach(radio => {
    radio.removeEventListener('change', updateCancelReason);
    radio.addEventListener('change', updateCancelReason);
  });
  document.getElementById('cancelReasonInput').value = 'duplicate';
  
  new bootstrap.Modal(document.getElementById('cancelIncidentModal')).show();
}

function updateCancelReason() {
  const selectedReason = document.querySelector('input[name="reason_radio"]:checked');
  if (selectedReason) {
    document.getElementById('cancelReasonInput').value = selectedReason.value;
  }
}

// Обработка отправки формы отмены
document.getElementById('cancelIncidentForm')?.addEventListener('submit', function(e) {
  const selectedReason = document.querySelector('input[name="reason_radio"]:checked');
  if (!selectedReason) {
    e.preventDefault();
    alert('Пожалуйста, выберите причину отмены');
    return false;
  }
  document.getElementById('cancelReasonInput').value = selectedReason.value;
});
  </script>

  <hr class="my-4">
  <h5>История изменений</h5>
  <table class="table table-sm">
    <thead><tr><th>Когда</th><th>Кто</th><th>Поле</th><th>Старое</th><th>Новое</th></tr></thead>
    <tbody>
      {% set hist = history if history is defined else [] %}
      {% for h in hist %}
        <tr>
          <td>{{ h.changed_at.strftime('%d.%m.%Y %H:%M') if h.changed_at else '—' }}</td>
          <td>{{ h.changer.first_name if h.changer else '—' }}</td>
          <td>{{ h.field }}</td>
          <td>{{ h.old_value or '—' }}</td>
          <td>{{ h.new_value or '—' }}</td>
        </tr>
      {% else %}
        <tr><td colspan="5" class="text-muted">История пуста</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h5 class="mt-4">Корректировки по инциденту</h5>
  <table class="table table-sm table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Тип</th>
        <th>Сумма</th>
        <th>Дата</th>
        <th>Применена</th>
      </tr>
    </thead>
    <tbody>
      {% if adjustments and adjustments|length > 0 %}
        {% for adj in adjustments %}
        <tr>
          <td>{{ adj.id }}</td>
          <td>{{ adj.get_type_label() }}</td>
          <td>{{ adj.amount }}</td>
          <td>{{ adj.created_at.strftime('%d.%m.%Y') if adj.created_at else '—' }}</td>
          <td>{{ 'Да' if adj.is_applied else 'Нет' }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" class="text-muted">Корректировок нет</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const objectSelect = document.getElementById('ownerIncidentObject');
  const employeeSelect = document.getElementById('ownerIncidentEmployee');
  const currentEmployeeId = {{ incident.employee.id if incident.employee else 'null' }};
  const initialGroups = {{ employee_groups | tojson | safe }};

  if (!objectSelect || !employeeSelect) {
    console.error('Не удалось инициализировать форму инцидента (редактирование)');
    return;
  }

  function formatEmployee(emp) {
    const parts = [];
    if (emp.last_name) parts.push(emp.last_name);
    if (emp.first_name) parts.push(emp.first_name);
    if (emp.middle_name) parts.push(emp.middle_name);
    return parts.join(' ').trim() || `ID ${emp.id}`;
  }

  function renderEmployeeGroups(groups, selectedId) {
    employeeSelect.innerHTML = '<option value="">Выберите сотрудника</option>';

    if (groups.active && groups.active.length > 0) {
      groups.active.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.id;
        opt.textContent = formatEmployee(emp);
        if (selectedId && emp.id === selectedId) {
          opt.selected = true;
        }
        employeeSelect.appendChild(opt);
      });
    }

    if (groups.former && groups.former.length > 0) {
      const divider = document.createElement('option');
      divider.value = '';
      divider.disabled = true;
      divider.textContent = 'Бывшие';
      divider.classList.add('fw-bold', 'fst-italic', 'text-muted');
      employeeSelect.appendChild(divider);

      groups.former.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.id;
        opt.textContent = formatEmployee(emp);
        opt.classList.add('fst-italic', 'text-muted');
        if (selectedId && emp.id === selectedId) {
          opt.selected = true;
        }
        employeeSelect.appendChild(opt);
      });
    }

    employeeSelect.disabled = false;
  }

  function resetEmployees(message) {
    employeeSelect.innerHTML = `<option value="">${message}</option>`;
    employeeSelect.disabled = true;
  }

  async function loadEmployees(objectId, selectedId = null) {
    resetEmployees('Загрузка сотрудников...');
    try {
      const resp = await fetch(`/owner/incidents/api/employees?object_id=${encodeURIComponent(objectId)}`);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      const data = await resp.json();
      renderEmployeeGroups(data || { active: [], former: [] }, selectedId);
    } catch (error) {
      console.error('Ошибка загрузки сотрудников:', error);
      resetEmployees('Не удалось загрузить сотрудников');
    }
  }

  objectSelect.addEventListener('change', function () {
    const objectId = this.value;
    if (!objectId) {
      resetEmployees('Сначала выберите объект');
      return;
    }
    employeeSelect.disabled = true;
    loadEmployees(objectId);
  });

  if (objectSelect.value) {
    if (initialGroups && (initialGroups.active.length || initialGroups.former.length)) {
      renderEmployeeGroups(initialGroups, currentEmployeeId);
    } else {
      loadEmployees(objectSelect.value, currentEmployeeId);
    }
  } else {
    resetEmployees('Сначала выберите объект');
  }
});
</script>
{% endblock %}
