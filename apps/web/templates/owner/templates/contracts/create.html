{% extends "owner/base_owner.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
<!-- Summernote WYSIWYG Editor CSS -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-bs5.min.css" rel="stylesheet">
<!-- jQuery for Summernote with integrity check -->
<script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"
    onload="console.log('jQuery загружен успешно')"
    onerror="console.error('Ошибка загрузки jQuery')"
></script>
<!-- Summernote WYSIWYG Editor JS -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-bs5.min.js" onload="console.log('Summernote загружен')"></script>

<style>
/* Стили для блока подсказок тегов */
.card .tag-item {
    border-left: 3px solid #0d6efd;
    padding-left: 8px;
    margin-left: 0;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.card .tag-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}

.card .tag-item code {
    background-color: #f8f9fa;
    color: #0d6efd;
    font-size: 0.9em;
    border-radius: 3px;
    padding: 2px 4px;
    font-family: 'Courier New', monospace;
    cursor: pointer;
}

.card .tag-item code:hover {
    background-color: #e0e7ff;
}

.card .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.card .card-header h5 {
    color: #495057;
}

/* Плавный скрол для sticky бокс */
.sticky-top {
    transition: top 0.3s ease;
}

/* Скрытие категорий при фильтрации */
.tag-category {
    transition: opacity 0.3s ease;
}

.tag-category.hidden {
    display: none;
}

/* Анимация уведомления */
@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-10px); }
    20% { opacity: 1; transform: translateY(0); }
    80% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-10px); }
}

/* Стили для Summernote редактора */
.summernote-editor {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

.note-editor.note-frame .note-editing-area .note-editable {
    font-family: 'Times New Roman', serif;
    font-size: 14px;
    line-height: 1.5;
    color: #333;
    padding: 15px;
}

/* Стили для средного блока редактора */
.summernote-container {
    background: white;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    height: 400px;
    position: relative;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="bi bi-file-earmark-plus"></i> {{ title }}</h1>
        <a href="/owner/templates/contracts" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Назад</a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header"><h5 class="card-title mb-0">Основная информация</h5></div>
        <div class="card-body">
          <form method="POST" id="templateForm">
            <div class="mb-3">
              <label class="form-label">Название *</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Описание</label>
              <textarea name="description" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Версия</label>
              <input type="text" name="version" class="form-control" value="1.0">
            </div>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="isPublic" name="is_public">
              <label class="form-check-label" for="isPublic">Публичный шаблон</label>
            </div>

            <div class="mb-3">
              <label class="form-label">Контент шаблона (Jinja2/HTML) *</label>
              <div class="mb-2">
                <button type="button" id="pasteHtmlBtn" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-code me-1"></i>Вставить как HTML
                </button>
                <span class="small text-muted ms-2">Для форматированного текста из внешних редакторов</span>
              </div>
              <div id="contentEditor" style="min-height: 300px;"></div>
              <textarea name="content" id="content" class="form-control" style="display: none;" required></textarea>
              <div class="form-text">Используйте теги вида {{ "{{ key }}" }} из справочника тегов справа. Используйте кнопку "Вставить как HTML" для сохранения форматирования</div>
            </div>

            <hr>
            <h5 class="mb-3">Схема полей</h5>
            <input type="hidden" name="fields_schema" id="fields_schema">
            <div class="border rounded p-3 mb-3">
              <div id="fieldsList"></div>
              <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addField()"><i class="bi bi-plus"></i> Добавить поле</button>
            </div>

            <div class="d-flex justify-content-between">
              <a href="/owner/templates/contracts" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Отмена</a>
              <button type="submit" class="btn btn-primary"><i class="bi bi-check2"></i> Создать</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Правая колонка с подсказками по тегам -->
    <div class="col-lg-4">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Подсказки по тегам
          </h5>
        </div>
        <div class="card-body">
          <p class="small text-muted mb-3">
            Используйте теги для автоматической подстановки данных в шаблоны договоров:
          </p>
          
          <!-- Фильтр категорий -->
          <div class="mb-3">
            <label class="form-label">Фильтр:</label>
            <select class="form-select form-select-sm" id="tagFilter">
              <option value="all">Все категории</option>
              <option value="system">Системные</option>
              <option value="owner">Владелец</option>
              <option value="company">Компания</option>
              <option value="employee">Сотрудник</option>
              <option value="contract">Договор</option>
            </select>
          </div>
          
          <!-- Теги по категориям -->
          <div id="tagsContainer">
            <!-- Системные теги -->
            <div class="tag-category" data-category="system">
              <h6 class="text-primary mb-2">
                <i class="fas fa-cog me-1"></i>
                Системные теги
              </h6>
              <div class="small mb-3">
                <div class="tag-item mb-2" onclick="copyToClipboard('{{ "{{ current_date }}" }}')">
                  <code>{{ "{{ current_date }}" }}</code>
                  <div class="small text-muted">Текущая дата</div>
                </div>
                <div class="tag-item mb-2" onclick="copyToClipboard('{{ "{{ current_time }}" }}')">
                  <code>{{ "{{ current_time }}" }}</code>
                  <div class="small text-muted">Текущее время</div>
                </div>
                <div class="tag-item mb-2" onclick="copyToClipboard('{{ "{{ current_year }}" }}')">
                  <code>{{ "{{ current_year }}" }}</code>
                  <div class="small text-muted">Текущий год</div>
                </div>
              </div>
            </div>
            
            <!-- Теги владельца -->
            <div class="tag-category" data-category="owner">
              <h6 class="text-success mb-2">
                <i class="fas fa-user me-1"></i>
                Владелец
              </h6>
              {% for tag in all_tags if tag.category == "owner" %}
              <div class="tag-item mb-2" onclick="copyToClipboard('{{ "{{ " + tag.key + " }}" }}')">
                <code>{{ "{{ " + tag.key + " }}" }}</code>
                <div class="small text-muted">{{ tag.label }}</div>
                {% if tag.description %}
                <div class="small text-info">{{ tag.description|truncate(100) }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            
            <!-- Теги компании -->
            <div class="tag-category" data-category="company">
              <h6 class="text-info mb-2">
                <i class="fas fa-building me-1"></i>
                Компания
              </h6>
              {% for tag in all_tags if tag.category == "company" %}
              <div class="tag-item mb-2" onclick="copyToClipboard('{{ "{{ " + tag.key + " }}" }}')">
                <code>{{ "{{ " + tag.key + " }}" }}</code>
                <div class="small text-muted">{{ tag.label }}</div>
                {% if tag.description %}
                <div class="small text-info">{{ tag.description|truncate(100) }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            
            <!-- Теги сотрудника -->
            <div class="tag-category" data-category="employee">
              <h6 class="text-warning mb-2">
                <i class="fas fa-users me-1"></i>
                Сотрудник
              </h6>
              {% for tag in all_tags if tag.category == "employee" %}
              <div class="tag-item mb-2" onclick="copyToClipboard('{{ "{{ " + tag.key + " }}" }}')">
                <code>{{ "{{ " + tag.key + " }}" }}</code>
                <div class="small text-muted">{{ tag.label }}</div>
                {% if tag.description %}
                <div class="small text-info">{{ tag.description|truncate(100) }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            
            <!-- Договорные теги -->
            <div class="tag-category" data-category="contract">
              <h6 class="text-danger mb-2">
                <i class="fas fa-file-contract me-1"></i>
                Договор
              </h6>
              {% for tag in all_tags if tag.category == "contract" %}
              <div class="tag-item mb-2" onclick="copyToClipboard('{{ "{{ " + tag.key + " }}" }}')">
                <code>{{ "{{ " + tag.key + " }}" }}</code>
                <div class="small text-muted">{{ tag.label }}</div>
                {% if tag.description %}
                <div class="small text-info">{{ tag.description|truncate(100) }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          
          <div class="alert alert-info mt-3 mb-0 p-2" style="font-size: 0.8rem;">
            <strong><i class="fas fa-lightbulb me-1"></i>TIP:</strong> Кликните по тегу чтобы скопировать его в буфер обмена<br>
            <strong><i class="fas fa-crown me-1"></i>FORMAT:</strong> Для форматированного текста используйте "Вставить как HTML" в редакторе
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let fields = [];

function addField(field = {key:'', label:'', type:'text', required:false, options:''}) {
  fields.push(field);
  renderFields();
}

function removeField(idx){
  fields.splice(idx,1);
  renderFields();
}

function updateField(idx, prop, value){
  fields[idx][prop] = value;
}

function renderFields(){
  const list = document.getElementById('fieldsList');
  list.innerHTML = fields.map((f, i)=>`
    <div class="border rounded p-2 mb-2">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Key</label>
          <input class="form-control" value="${f.key}" oninput="updateField(${i}, 'key', this.value)">
        </div>
        <div class="col-md-3">
          <label class="form-label">Label</label>
          <input class="form-control" value="${f.label}" oninput="updateField(${i}, 'label', this.value)">
        </div>
        <div class="col-md-2">
          <label class="form-label">Type</label>
          <select class="form-select" onchange="updateField(${i}, 'type', this.value)">
            <option ${f.type==='text'?'selected':''}>text</option>
            <option ${f.type==='number'?'selected':''}>number</option>
            <option ${f.type==='date'?'selected':''}>date</option>
            <option ${f.type==='select'?'selected':''}>select</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Опции (для select)</label>
          <input class="form-control" value="${f.options||''}" oninput="updateField(${i}, 'options', this.value)">
        </div>
        <div class="col-md-1">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" ${f.required?'checked':''} onchange="updateField(${i}, 'required', this.checked)">
            <label class="form-check-label">Req</label>
          </div>
        </div>
      </div>
      <div class="text-end mt-2">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeField(${i})"><i class="bi bi-trash"></i></button>
      </div>
    </div>
  `).join('');
}

// Инициализация Summernote WYSIWYG редактора
window.addEventListener('load', function() {
    console.log('DOM полностью загружен, начинаем инициализацию...');
    initSummernoteEditor();
});

function initSummernoteEditor() {
    // Проверяем что jQuery загружен
    function waitForjQuery(callback, timeout = 10000) {
        const start = Date.now();
        
        function check() {
            if (typeof window.jQuery !== 'undefined') {
                console.log('jQuery найден, инициализируем Summernote...');
                callback(window.jQuery);
            } else if ((Date.now() - start) > timeout) {
                console.error('Тайм-аут ожидания jQuery! Скримма будет недоступна.');
                // Fallback: показываем обычную textarea
                document.getElementById('contentEditor').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } else {
                setTimeout(check, 50);
            }
        }
        check();
    }
    
    waitForjQuery(function($) {
        initializeSummernote($);
    });
}

function initializeSummernote($) {
    try {
        $('#contentEditor').summernote({
            height: 350,
            minHeight: 200,
            maxHeight: 500,
            placeholder: 'Например: Договор с {{ fio }} от {{ date }}',
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'italic', 'clear']],
                ['fontname', ['fontname']],
                ['fontsize', ['fontsize']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link']],
                ['misc', ['undo', 'redo']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            fontNames: ['Times New Roman', 'Arial', 'Georgia', 'Verdana', 'Courier New'],
            fontNamesIgnoreCheck: ['Times New Roman'],
            callbacks: {
                onChange: function(contents, $editable) {
                    // Копируем HTML содержимое в скрытое поле textarea
                    document.getElementById('content').value = contents;
                },
                onPaste: function(e) {
                    const clipboardData = e.originalEvent.clipboardData || window.clipboardData;
                    if (clipboardData && clipboardData.getData) {
                        e.preventDefault();
                        const html = clipboardData.getData('text/html');
                        const text = clipboardData.getData('text/plain');
                        
                        // Если есть HTML разметка, вставляем её
                        if (html) {
                            document.execCommand('insertHTML', false, html);
                        } else {
                            document.execCommand('insertText', false, text);
                        }
                    }
                }
            },
            styleTags: [
                'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                { tag: 'div', name: 'Контейнер блока', class: 'content-block' },
                { tag: 'span', name: 'Встроенный текст', class: 'inline-text' }
            ]
        });
        console.log('Summernote успешно инициализирован!');
        
        // Инициализируем кнопку "Вставить как HTML"
        setupPasteHtmlButton($);
        
    } catch (e) {
        console.error('Ошибка инициализации Summernote:', e);
        // Fallback при ошибке
        fallbackToTextarea();
    }
}

function setupPasteHtmlButton($) {
    $('#pasteHtmlBtn').click(function() {
        // Создаем простое модальное окно для вставки HTML
        var modalHtml = `
            <div class="modal fade" id="htmlPasteModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-code me-2"></i>Вставить форматированный текст
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <label class="form-label">HTML-код для вставки:</label>
                            <textarea id="htmlInput" class="form-control" rows="8" placeholder="Скопируйте отформатированный текст из внешнего редактора (Word, Google Docs, etc.) и вставьте сюда...
                            
Рекомендации:
• Скопируйте текст из Word или другого редактора
• Нажмите Ctrl+V в этом поле
• HTML сохранится автоматически"></textarea>
                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('htmlInput').value='';">
                                    <i class="fas fa-trash me-1"></i>Очистить
                                </button>
                                <span class="small text-muted ms-2">Или вставьте готовый HTML-код</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="button" class="btn btn-primary" id="insertHtmlBtn">
                                <i class="fas fa-paste me-1"></i>Вставить в редактор
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Удаляем старое модальное окно если оно есть
        $('#htmlPasteModal').remove();
        
        // Добавляем новое в body
        $('body').append(modalHtml);
        
        // Показываем модальное окно
        var modal = new bootstrap.Modal(document.getElementById('htmlPasteModal'));
        modal.show();
        
        // Фокус на textarea
        setTimeout(function() {
            document.getElementById('htmlInput').focus();
        }, 300);
        
        // Обработчик для кнопки Вставить
        $('#insertHtmlBtn').click(function() {
            var htmlContent = $('#htmlInput').val();
            
            if (htmlContent && htmlContent.trim()) {
                try {
                    // Вставляем HTML в редактор
                    $('#contentEditor').summernote('pasteHTML', htmlContent);
                    modal.hide();
                    console.log('HTML успешно вставлен в редактор');
                } catch (e) {
                    console.error('Ошибка вставки HTML:', e);
                    alert('Ошибка вставки HTML: ' + e.message);
                }
            } else {
                alert('Вставьте HTML-код в поле выше');
            }
        });
        
        // Очистка модального окна при закрытии
        $('#htmlPasteModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    });
}

function fallbackToTextarea() {
    document.getElementById('contentEditor').style.display = 'none';
    document.getElementById('content').style.display = 'block';
    document.getElementById('content').setAttribute('rows', '10');
    document.getElementById('content').classList.add('form-control');
    console.log('Используется fallback textarea');
}

document.getElementById('templateForm').addEventListener('submit', function(e){
    // Получаем содержимое из Summernote через jQuery
    try {
        if (typeof window.jQuery !== 'undefined') {
            const $ = window.jQuery;
            const content = $('#contentEditor').summernote('code');
            document.getElementById('content').value = content;
        } else {
            console.warn('jQuery недоступен, используем текущее содержимое textarea');
        }
    } catch (error) {
        console.error('Ошибка получения содержимого Summernote:', error);
    }
    
    // Продолжаем стандартную логику
    document.getElementById('fields_schema').value = JSON.stringify(fields);
});

// Функция копирования тега в буфер обмена
function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function() {
            showCopySuccess();
        }).catch(function(err) {
            console.error('Ошибка копирования:', err);
            fallbackCopyToClipboard(text);
        });
    } else {
        fallbackCopyToClipboard(text);
    }
}

// Альтернативный способ копирования для браузеров без поддержки Clipboard API
function fallbackCopyToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess();
        }
    } catch (err) {
        console.error('Не удалось скопировать текст: ', err);
        alert('Скопируйте тег вручную: ' + text);
    }
    
    document.body.removeChild(textArea);
}

// Показать уведомление об успешном копировании
function showCopySuccess() {
    // Создаем временное уведомление
    const notification = document.createElement('div');
    notification.className = 'alert alert-success position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; animation: fadeInOut 2s ease-in-out;';
    notification.innerHTML = '<i class="fas fa-check me-2"></i>Тег скопирован!';
    
    document.body.appendChild(notification);
    
    // Удаляем уведомление через 2 секунды
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 2000);
}

// Обработчик фильтра тегов
document.addEventListener('DOMContentLoaded', function() {
    const tagFilter = document.getElementById('tagFilter');
    if (tagFilter) {
        tagFilter.addEventListener('change', function() {
            const filterValue = this.value;
            const categories = document.querySelectorAll('.tag-category');
            
            categories.forEach(category => {
                const categoryName = category.dataset.category;
                if (filterValue === 'all' || filterValue === categoryName) {
                    category.style.display = 'block';
                    category.classList.remove('hidden');
                } else {
                    category.style.display = 'none';
                    category.classList.add('hidden');
                }
            });
        });
    }
});

renderFields();
</script>
{% endblock %}


