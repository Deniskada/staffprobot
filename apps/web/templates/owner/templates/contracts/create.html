{% extends "owner/base_owner.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
#contentEditor {
    height: 500px;
    font-family: 'Times New Roman', serif;
    font-size: 14px;
}
#contentEditor .ql-editor {
    min-height: 460px;
}
.card .tag-item {
    border-left: 3px solid #0d6efd;
    padding-left: 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.card .tag-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}
.card .tag-item code {
    background-color: #f8f9fa;
    color: #0d6efd;
    font-size: 0.9em;
    border-radius: 3px;
    padding: 2px 4px;
    font-family: 'Courier New', monospace;
    cursor: pointer;
}
.card .tag-item code:hover {
    background-color: #e0e7ff;
}
.tag-category.hidden { display: none; }
@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-10px); }
    20% { opacity: 1; transform: translateY(0); }
    80% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-10px); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="bi bi-file-earmark-plus"></i> {{ title }}</h1>
        <a href="/owner/contract-templates" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Назад</a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header"><h5 class="card-title mb-0">Основная информация</h5></div>
        <div class="card-body">
          <form method="POST" id="templateForm">
            <div class="mb-3">
              <label class="form-label">Название *</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Описание</label>
              <textarea name="description" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Тип договора *</label>
              <select id="contractTypeSelect" class="form-select" required>
                <option value="">— Выберите тип —</option>
                {% for ct in contract_types if ct.code != 'offer' %}
                <option value="{{ ct.id }}" data-code="{{ ct.code }}">{{ ct.label }}</option>
                {% endfor %}
              </select>
              <input type="hidden" name="contract_type_id" id="contractTypeId">
              <input type="hidden" name="is_offer" id="isOfferHidden" value="0">
            </div>
            <div class="mb-3 d-none" id="offerCheckboxWrap">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="isOffer">
                <label class="form-check-label" for="isOffer">
                  <i class="bi bi-file-earmark-check"></i> Оферта (договор присоединения)
                </label>
                <div class="form-text">Сотрудник получит уведомление и подпишет через ПЭП</div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Версия</label>
              <input type="text" name="version" class="form-control" value="1.0">
            </div>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="isPublic" name="is_public">
              <label class="form-check-label" for="isPublic">Публичный шаблон</label>
            </div>

            <div class="mb-3">
              <label class="form-label">Контент шаблона *</label>
              <div class="mb-2">
                <button type="button" id="pasteHtmlBtn" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-code-slash me-1"></i>Вставить как HTML
                </button>
                <button type="button" id="viewSourceBtn" class="btn btn-outline-secondary btn-sm ms-1">
                  <i class="bi bi-filetype-html me-1"></i>Исходный код
                </button>
              </div>
              <div id="contentEditor"></div>
              <textarea name="content" id="content" style="display: none;" required></textarea>
              <div class="form-text">Используйте теги вида {{ "{{ key }}" }} из справочника тегов справа</div>
            </div>

            <hr>
            <h5 class="mb-3">Схема полей</h5>
            <input type="hidden" name="fields_schema" id="fields_schema">
            <div class="border rounded p-3 mb-3">
              <div id="fieldsList"></div>
              <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addField()"><i class="bi bi-plus"></i> Добавить поле</button>
            </div>

            <div class="d-flex justify-content-between">
              <a href="/owner/contract-templates" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Отмена</a>
              <button type="submit" class="btn btn-primary"><i class="bi bi-check2"></i> Создать</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Правая колонка с подсказками по тегам -->
    <div class="col-lg-4">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Подсказки по тегам</h5>
        </div>
        <div class="card-body">
          <p class="small text-muted mb-3">Кликните по тегу, чтобы вставить его в редактор:</p>

          <div class="mb-3">
            <select class="form-select form-select-sm" id="tagFilter">
              <option value="all">Все категории</option>
              <option value="system">Системные</option>
              <option value="owner">Владелец</option>
              <option value="company">Компания</option>
              <option value="employee">Сотрудник</option>
              <option value="contract">Договор</option>
            </select>
          </div>

          <div id="tagsContainer">
            <div class="tag-category" data-category="system">
              <h6 class="text-primary mb-2"><i class="bi bi-gear me-1"></i>Системные</h6>
              <div class="small mb-3">
                <div class="tag-item mb-2" onclick="insertTag('current_date')">
                  <code>{{ "{{ current_date }}" }}</code>
                  <div class="small text-muted">Текущая дата</div>
                </div>
                <div class="tag-item mb-2" onclick="insertTag('current_time')">
                  <code>{{ "{{ current_time }}" }}</code>
                  <div class="small text-muted">Текущее время</div>
                </div>
                <div class="tag-item mb-2" onclick="insertTag('current_year')">
                  <code>{{ "{{ current_year }}" }}</code>
                  <div class="small text-muted">Текущий год</div>
                </div>
              </div>
            </div>

            <div class="tag-category" data-category="owner">
              <h6 class="text-success mb-2"><i class="bi bi-person me-1"></i>Владелец</h6>
              <div class="small mb-3">
              {% for tag in all_tags if tag.category == "owner" %}
              <div class="tag-item mb-2" onclick="insertTag('{{ tag.key }}')">
                <code>{{ "{{ " + tag.key + " }}" }}</code>
                <div class="small text-muted">{{ tag.label }}</div>
              </div>
              {% endfor %}
              </div>
            </div>

            <div class="tag-category" data-category="company">
              <h6 class="text-info mb-2"><i class="bi bi-building me-1"></i>Компания</h6>
              <div class="small mb-3">
              {% for tag in all_tags if tag.category == "company" %}
              <div class="tag-item mb-2" onclick="insertTag('{{ tag.key }}')">
                <code>{{ "{{ " + tag.key + " }}" }}</code>
                <div class="small text-muted">{{ tag.label }}</div>
              </div>
              {% endfor %}
              </div>
            </div>

            <div class="tag-category" data-category="employee">
              <h6 class="text-warning mb-2"><i class="bi bi-people me-1"></i>Сотрудник</h6>
              <div class="small mb-3">
              {% for tag in all_tags if tag.category == "employee" %}
              <div class="tag-item mb-2" onclick="insertTag('{{ tag.key }}')">
                <code>{{ "{{ " + tag.key + " }}" }}</code>
                <div class="small text-muted">{{ tag.label }}</div>
              </div>
              {% endfor %}
              </div>
            </div>

            <div class="tag-category" data-category="contract">
              <h6 class="text-danger mb-2"><i class="bi bi-file-earmark-text me-1"></i>Договор</h6>
              <div class="small mb-3">
              {% for tag in all_tags if tag.category == "contract" %}
              <div class="tag-item mb-2" onclick="insertTag('{{ tag.key }}')">
                <code>{{ "{{ " + tag.key + " }}" }}</code>
                <div class="small text-muted">{{ tag.label }}</div>
              </div>
              {% endfor %}
              </div>
            </div>
          </div>

          <div class="alert alert-info mt-3 mb-0 p-2" style="font-size: 0.8rem;">
            <strong>TIP:</strong> Клик по тегу вставляет его в позицию курсора в редакторе
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
// --- Quill Editor ---
const quill = new Quill('#contentEditor', {
    theme: 'snow',
    placeholder: 'Введите текст шаблона договора...',
    modules: {
        toolbar: [
            [{ header: [1, 2, 3, 4, 5, 6, false] }],
            [{ font: [] }],
            [{ size: ['small', false, 'large', 'huge'] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ color: [] }, { background: [] }],
            [{ script: 'sub' }, { script: 'super' }],
            [{ list: 'ordered' }, { list: 'bullet' }],
            [{ indent: '-1' }, { indent: '+1' }],
            [{ align: [] }],
            ['blockquote'],
            ['link', 'image'],
            ['clean']
        ]
    }
});

// Синхронизация с hidden textarea
quill.on('text-change', function() {
    document.getElementById('content').value = quill.root.innerHTML;
});

// Вставка тега в позицию курсора
function insertTag(key) {
    const tag = '{{ ' + key + ' }}';
    const range = quill.getSelection(true);
    quill.insertText(range.index, tag);
    quill.setSelection(range.index + tag.length);
}

// Кнопка «Вставить как HTML»
document.getElementById('pasteHtmlBtn').addEventListener('click', function() {
    const old = document.getElementById('htmlPasteModal');
    if (old) old.remove();

    document.body.insertAdjacentHTML('beforeend', `
        <div class="modal fade" id="htmlPasteModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-code-slash me-2"></i>Вставить HTML</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="htmlInput" class="form-control font-monospace" rows="12"
                            placeholder="Вставьте HTML-код сюда..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" id="insertHtmlBtn">Вставить</button>
                    </div>
                </div>
            </div>
        </div>
    `);

    const modalEl = document.getElementById('htmlPasteModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    setTimeout(() => document.getElementById('htmlInput').focus(), 300);

    document.getElementById('insertHtmlBtn').addEventListener('click', function() {
        const html = document.getElementById('htmlInput').value.trim();
        if (html) {
            quill.clipboard.dangerouslyPasteHTML(quill.getLength() - 1, html);
            modal.hide();
        }
    });
    modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
});

// Кнопка «Исходный код» — переключение между WYSIWYG и HTML
let sourceMode = false;
const sourceBtn = document.getElementById('viewSourceBtn');
const editorContainer = document.getElementById('contentEditor');

sourceBtn.addEventListener('click', function() {
    if (!sourceMode) {
        // Переход в режим HTML
        const html = quill.root.innerHTML;
        const ta = document.createElement('textarea');
        ta.id = 'sourceTextarea';
        ta.className = 'form-control font-monospace';
        ta.style.height = '500px';
        ta.value = html;
        editorContainer.style.display = 'none';
        editorContainer.parentNode.insertBefore(ta, editorContainer.nextSibling);
        sourceBtn.innerHTML = '<i class="bi bi-eye me-1"></i>Визуальный режим';
        sourceMode = true;
    } else {
        // Возврат в WYSIWYG
        const ta = document.getElementById('sourceTextarea');
        if (ta) {
            quill.root.innerHTML = ta.value;
            ta.remove();
        }
        editorContainer.style.display = '';
        sourceBtn.innerHTML = '<i class="bi bi-filetype-html me-1"></i>Исходный код';
        sourceMode = false;
    }
});

// --- Схема полей ---
let fields = [];

function addField(field = {key:'', label:'', type:'text', required:false, options:''}) {
    fields.push(field);
    renderFields();
}
function removeField(idx) { fields.splice(idx,1); renderFields(); }
function updateField(idx, prop, value) { fields[idx][prop] = value; }

function renderFields() {
    const list = document.getElementById('fieldsList');
    list.innerHTML = fields.map((f, i) => `
        <div class="border rounded p-2 mb-2">
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Key</label>
              <input class="form-control" value="${f.key}" oninput="updateField(${i},'key',this.value)">
            </div>
            <div class="col-md-3">
              <label class="form-label">Label</label>
              <input class="form-control" value="${f.label}" oninput="updateField(${i},'label',this.value)">
            </div>
            <div class="col-md-2">
              <label class="form-label">Type</label>
              <select class="form-select" onchange="updateField(${i},'type',this.value)">
                <option ${f.type==='text'?'selected':''}>text</option>
                <option ${f.type==='number'?'selected':''}>number</option>
                <option ${f.type==='date'?'selected':''}>date</option>
                <option ${f.type==='select'?'selected':''}>select</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Опции</label>
              <input class="form-control" value="${f.options||''}" oninput="updateField(${i},'options',this.value)">
            </div>
            <div class="col-md-1">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" ${f.required?'checked':''} onchange="updateField(${i},'required',this.checked)">
                <label class="form-check-label">Req</label>
              </div>
            </div>
          </div>
          <div class="text-end mt-2">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeField(${i})"><i class="bi bi-trash"></i></button>
          </div>
        </div>
    `).join('');
}
renderFields();

// --- Submit формы ---
document.getElementById('templateForm').addEventListener('submit', function(e) {
    // Синхронизируем HTML из текущего режима
    if (sourceMode) {
        const ta = document.getElementById('sourceTextarea');
        if (ta) quill.root.innerHTML = ta.value;
    }
    document.getElementById('content').value = quill.root.innerHTML;
    document.getElementById('fields_schema').value = JSON.stringify(fields);
});

// --- Фильтр тегов ---
document.getElementById('tagFilter').addEventListener('change', function() {
    const v = this.value;
    document.querySelectorAll('.tag-category').forEach(c => {
        c.classList.toggle('hidden', v !== 'all' && c.dataset.category !== v);
    });
});

// --- Чекбокс «Оферта» ---
(function() {
    const sel = document.getElementById('contractTypeSelect');
    const hidden = document.getElementById('contractTypeId');
    const offerHidden = document.getElementById('isOfferHidden');
    const wrap = document.getElementById('offerCheckboxWrap');
    const cb = document.getElementById('isOffer');
    const OFFER_TYPE_ID = '{{ (contract_types | selectattr("code","equalto","offer") | map(attribute="id") | first) | default("") }}';

    function update() {
        const opt = sel.options[sel.selectedIndex];
        const code = opt ? opt.dataset.code : '';
        if (code === 'gpc_contract' || code === 'services') {
            wrap.classList.remove('d-none');
        } else {
            wrap.classList.add('d-none');
            cb.checked = false;
        }
        hidden.value = (cb.checked && OFFER_TYPE_ID) ? OFFER_TYPE_ID : sel.value;
        offerHidden.value = cb.checked ? '1' : '0';
    }
    sel.addEventListener('change', update);
    cb.addEventListener('change', update);
    update();
})();

// --- Копирование в буфер (fallback для старых тегов) ---
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        const n = document.createElement('div');
        n.className = 'alert alert-success position-fixed';
        n.style.cssText = 'top:20px;right:20px;z-index:9999;animation:fadeInOut 2s ease-in-out';
        n.textContent = 'Скопировано!';
        document.body.appendChild(n);
        setTimeout(() => n.remove(), 2000);
    }).catch(() => {});
}
</script>
{% endblock %}
