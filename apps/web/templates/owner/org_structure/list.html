{% extends "owner/base_owner.html" %}

{% block title %}{{ title }}{% endblock %}

<!-- –ú–∞–∫—Ä–æ—Å –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —É–∑–ª–∞ –¥–µ—Ä–µ–≤–∞ -->
{% macro render_unit(unit, payment_systems, payment_schedules) %}
<div class="card mb-2 ms-{{ unit.level * 3 }}">
    <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
                <h6 class="mb-1">
                    <i class="fas fa-folder{% if unit.children %}-open{% endif %} text-primary"></i>
                    {{ unit.name }}
                    {% if unit.level > 0 %}
                    <span class="badge bg-secondary badge-sm">–£—Ä–æ–≤–µ–Ω—å {{ unit.level }}</span>
                    {% endif %}
                </h6>
                <small class="text-muted">
                    {% if unit.description %}{{ unit.description }} ‚Ä¢ {% endif %}
                    {% if unit.payment_system_id %}
                        {% for ps in payment_systems %}
                            {% if ps.id == unit.payment_system_id %}
                                üí∞ {{ ps.name }}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">üí∞ –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è</span>
                    {% endif %}
                    ‚Ä¢
                    {% if unit.payment_schedule_id %}
                        {% for schedule in payment_schedules %}
                            {% if schedule.id == unit.payment_schedule_id %}
                                üìÖ {{ schedule.name }}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">üìÖ –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è</span>
                    {% endif %}
                </small>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="showEditModal({{ unit.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="fas fa-edit"></i>
                </button>
                {% if unit.level > 0 %}
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteUnit({{ unit.id }}, '{{ unit.name }}')" title="–£–¥–∞–ª–∏—Ç—å">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% if unit.children %}
    {% for child in unit.children %}
        {{ render_unit(child, payment_systems, payment_schedules) }}
    {% endfor %}
{% endif %}
{% endmacro %}

<!-- –ú–∞–∫—Ä–æ—Å –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ options –≤ select -->
{% macro render_unit_options(unit, indent) %}
<option value="{{ unit.id }}">{{ '‚îú‚îÄ ' * indent }}{{ unit.name }}</option>
{% if unit.children %}
    {% for child in unit.children %}
        {{ render_unit_options(child, indent + 1) }}
    {% endfor %}
{% endif %}
{% endmacro %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-sitemap"></i> {{ title }}
                    </h3>
                    <button type="button" class="btn btn-light" onclick="showCreateModal()">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –≤ –ª–æ–≥–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É 
                        –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –µ–¥–∏–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø–ª–∞—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤.
                    </div>
                    
                    <div class="mb-3">
                        <span class="badge bg-secondary">–í—Å–µ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π: {{ units_count }}</span>
                    </div>
                    
                    {% if org_tree %}
                    <div id="org-tree-container">
                        {% for root in org_tree %}
                            {{ render_unit(root, payment_systems, payment_schedules) }}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
<div class="modal fade" id="createUnitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/owner/org-structure/create">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="create_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input type="text" class="form-control" id="create_name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="create_description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="create_description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="create_parent_id" class="form-label">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                        <select class="form-select" id="create_parent_id" name="parent_id">
                            {% for root in org_tree %}
                                {{ render_unit_options(root, 0) }}
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">–ù–æ–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ</small>
                    </div>
                    
                    <hr>
                    <h6><i class="fas fa-coins"></i> –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h6>
                    
                    <div class="mb-3">
                        <label for="create_payment_system_id" class="form-label">–°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã —Ç—Ä—É–¥–∞</label>
                        <select class="form-select" id="create_payment_system_id" name="payment_system_id">
                            <option value="">–ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è</option>
                            {% for ps in payment_systems %}
                            <option value="{{ ps.id }}">{{ ps.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="create_payment_schedule_id" class="form-label">
                            –ì—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç
                            <i class="bi bi-info-circle" 
                               data-bs-toggle="tooltip" 
                               title="–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –≤—ã–ø–ª–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è"></i>
                        </label>
                        <div class="input-group">
                            <select class="form-select" id="create_payment_schedule_id" name="payment_schedule_id" onchange="updateCreateScheduleActions()">
                                <option value="">–ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è</option>
                                {% for schedule in payment_schedules %}
                                <option value="{{ schedule.id }}" 
                                        data-description="{{ schedule.payment_period.get('description', '') if schedule.payment_period else '' }}"
                                        data-is-custom="{{ 'true' if schedule.is_custom else 'false' }}">
                                    {{ schedule.name }}{% if schedule.is_custom %} (–∫–∞—Å—Ç–æ–º–Ω—ã–π){% endif %}
                                </option>
                                {% endfor %}
                                <option value="create_new" style="font-weight: bold; color: #0d6efd;">
                                    ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
                                </option>
                            </select>
                            <button type="button" id="view_create_schedule_btn" class="btn btn-outline-info" onclick="viewCreateSchedule()" style="display: none;">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" id="edit_create_schedule_btn" class="btn btn-outline-primary" onclick="editCreateSchedule()" style="display: none;">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <small class="text-muted" id="create_schedule_description_text"></small>
                    </div>
                    
                    <hr>
                    <h6><i class="fas fa-clock"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ç—Ä–∞—Ñ–æ–≤</h6>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="create_inherit_late_settings" 
                                   name="inherit_late_settings" checked onchange="toggleCreateLateFields()">
                            <label class="form-check-label" for="create_inherit_late_settings">
                                –ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
                            </label>
                        </div>
                    </div>
                    
                    <div class="row" id="create_late_fields">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create_late_threshold" class="form-label">–î–æ–ø—É—Å—Ç–∏–º–æ–µ –æ–ø–æ–∑–¥–∞–Ω–∏–µ (–º–∏–Ω)</label>
                                <input type="number" class="form-control" id="create_late_threshold" 
                                       name="late_threshold_minutes" placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create_late_penalty" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∏–Ω—É—Ç—ã (‚ÇΩ)</label>
                                <input type="number" class="form-control" id="create_late_penalty" 
                                       name="late_penalty_per_minute" step="0.01" placeholder="10.00">
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mt-4"><i class="fas fa-paper-plane"></i> Telegram –≥—Ä—É–ø–ø–∞ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤</h6>
                    <div class="mb-3">
                        <label for="create_telegram_chat" class="form-label">ID Telegram –≥—Ä—É–ø–ø—ã</label>
                        <input type="text" class="form-control" id="create_telegram_chat" 
                               name="telegram_report_chat_id" placeholder="-1001234567890">
                        <small class="form-text text-muted">
                            ID –≥—Ä—É–ø–ø—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –æ—Ç—á–µ—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É –∏ –Ω–∞–ø–∏—à–∏—Ç–µ <code>/get_chat_id</code>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
<div class="modal fade" id="editUnitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editUnitForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_unit_id" name="unit_id">
                    
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="2"></textarea>
                    </div>
                    
                    <hr>
                    <h6><i class="fas fa-coins"></i> –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h6>
                    
                    <div class="mb-3">
                        <label for="edit_payment_system_id" class="form-label">–°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã —Ç—Ä—É–¥–∞</label>
                        <select class="form-select" id="edit_payment_system_id" name="payment_system_id">
                            <option value="">–ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è</option>
                            {% for ps in payment_systems %}
                            <option value="{{ ps.id }}">{{ ps.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_payment_schedule_id" class="form-label">
                            –ì—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç
                            <i class="bi bi-info-circle" 
                               data-bs-toggle="tooltip" 
                               title="–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –≤—ã–ø–ª–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è"></i>
                        </label>
                        <div class="input-group">
                            <select class="form-select" id="edit_payment_schedule_id" name="payment_schedule_id" onchange="updateEditScheduleActions()">
                                <option value="">–ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è</option>
                                {% for schedule in payment_schedules %}
                                <option value="{{ schedule.id }}" 
                                        data-description="{{ schedule.payment_period.get('description', '') if schedule.payment_period else '' }}"
                                        data-is-custom="{{ 'true' if schedule.is_custom else 'false' }}">
                                    {{ schedule.name }}{% if schedule.is_custom %} (–∫–∞—Å—Ç–æ–º–Ω—ã–π){% endif %}
                                </option>
                                {% endfor %}
                                <option value="create_new" style="font-weight: bold; color: #0d6efd;">
                                    ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
                                </option>
                            </select>
                            <button type="button" id="view_edit_schedule_btn" class="btn btn-outline-info" onclick="viewEditSchedule()" style="display: none;">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" id="edit_edit_schedule_btn" class="btn btn-outline-primary" onclick="editEditSchedule()" style="display: none;">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <small class="text-muted" id="edit_schedule_description_text"></small>
                    </div>
                    
                    <hr>
                    <h6><i class="fas fa-clock"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ç—Ä–∞—Ñ–æ–≤</h6>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_inherit_late_settings" 
                                   name="inherit_late_settings" onchange="toggleEditLateFields()">
                            <label class="form-check-label" for="edit_inherit_late_settings">
                                –ù–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
                            </label>
                        </div>
                    </div>
                    
                    <div class="row" id="edit_late_fields">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_late_threshold" class="form-label">–î–æ–ø—É—Å—Ç–∏–º–æ–µ –æ–ø–æ–∑–¥–∞–Ω–∏–µ (–º–∏–Ω)</label>
                                <input type="number" class="form-control" id="edit_late_threshold" 
                                       name="late_threshold_minutes">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_late_penalty" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∏–Ω—É—Ç—ã (‚ÇΩ)</label>
                                <input type="number" class="form-control" id="edit_late_penalty" 
                                       name="late_penalty_per_minute" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mt-4"><i class="fas fa-paper-plane"></i> Telegram –≥—Ä—É–ø–ø–∞ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤</h6>
                    <div class="mb-3">
                        <label for="edit_telegram_chat" class="form-label">ID Telegram –≥—Ä—É–ø–ø—ã</label>
                        <input type="text" class="form-control" id="edit_telegram_chat" 
                               name="telegram_report_chat_id" placeholder="-1001234567890">
                        <small class="form-text text-muted">
                            ID –≥—Ä—É–ø–ø—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –æ—Ç—á–µ—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É –∏ –Ω–∞–ø–∏—à–∏—Ç–µ <code>/get_chat_id</code>
                        </small>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit_is_active" 
                                   name="is_active" value="true">
                            <label class="form-check-label" for="edit_is_active">
                                –ê–∫—Ç–∏–≤–Ω–æ
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è
function showCreateModal() {
    const modal = new bootstrap.Modal(document.getElementById('createUnitModal'));
    modal.show();
    toggleCreateLateFields();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async function showEditModal(unitId) {
    try {
        const response = await fetch(`/owner/org-structure/${unitId}/data`);
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
        
        const unit = await response.json();
        
        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É
        document.getElementById('edit_unit_id').value = unit.id;
        document.getElementById('edit_name').value = unit.name;
        document.getElementById('edit_description').value = unit.description || '';
        document.getElementById('edit_payment_system_id').value = unit.payment_system_id || '';
        document.getElementById('edit_payment_schedule_id').value = unit.payment_schedule_id || '';
        document.getElementById('edit_inherit_late_settings').checked = unit.inherit_late_settings;
        document.getElementById('edit_late_threshold').value = unit.late_threshold_minutes || '';
        document.getElementById('edit_late_penalty').value = unit.late_penalty_per_minute || '';
        document.getElementById('edit_telegram_chat').value = unit.telegram_report_chat_id || '';
        document.getElementById('edit_is_active').checked = unit.is_active;
        
        // –û–±–Ω–æ–≤–∏—Ç—å action —Ñ–æ—Ä–º—ã
        document.getElementById('editUnitForm').action = `/owner/org-structure/${unitId}/edit`;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
        const modal = new bootstrap.Modal(document.getElementById('editUnitModal'));
        modal.show();
        
        toggleEditLateFields();
        
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`);
    }
}

// –£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
async function deleteUnit(unitId, unitName) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ "${unitName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/owner/org-structure/${unitId}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert(`–û—à–∏–±–∫–∞: ${result.message}`);
        }
        
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${e.message}`);
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π —à—Ç—Ä–∞—Ñ–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ)
function toggleCreateLateFields() {
    const checkbox = document.getElementById('create_inherit_late_settings');
    const thresholdInput = document.getElementById('create_late_threshold');
    const penaltyInput = document.getElementById('create_late_penalty');
    
    const readonly = checkbox.checked;
    thresholdInput.readOnly = readonly;
    penaltyInput.readOnly = readonly;
    
    if (readonly) {
        thresholdInput.style.backgroundColor = '#e9ecef';
        penaltyInput.style.backgroundColor = '#e9ecef';
    } else {
        thresholdInput.style.backgroundColor = '';
        penaltyInput.style.backgroundColor = '';
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π —à—Ç—Ä–∞—Ñ–æ–≤ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
function toggleEditLateFields() {
    const checkbox = document.getElementById('edit_inherit_late_settings');
    const thresholdInput = document.getElementById('edit_late_threshold');
    const penaltyInput = document.getElementById('edit_late_penalty');
    
    const readonly = checkbox.checked;
    thresholdInput.readOnly = readonly;
    penaltyInput.readOnly = readonly;
    
    if (readonly) {
        thresholdInput.style.backgroundColor = '#e9ecef';
        penaltyInput.style.backgroundColor = '#e9ecef';
    } else {
        thresholdInput.style.backgroundColor = '';
        penaltyInput.style.backgroundColor = '';
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –≤—ã–ø–ª–∞—Ç (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è)
function updateCreateScheduleActions() {
    const scheduleSelect = document.getElementById('create_payment_schedule_id');
    const selectedOption = scheduleSelect.options[scheduleSelect.selectedIndex];
    const descEl = document.getElementById('create_schedule_description_text');
    const viewBtn = document.getElementById('view_create_schedule_btn');
    const editBtn = document.getElementById('edit_create_schedule_btn');
    
    // –û–±–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
    const description = selectedOption.getAttribute('data-description') || '';
    descEl.textContent = description;
    
    const selectedValue = scheduleSelect.value;
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π"
    if (selectedValue === 'create_new') {
        viewBtn.style.display = 'none';
        editBtn.style.display = 'none';
        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        window.open('/owner/payment-schedules/create', '_blank', 'width=900,height=700');
        // –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
        scheduleSelect.value = '';
        descEl.textContent = '';
    } else if (selectedValue) {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        viewBtn.style.display = 'inline-block';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö
        const isCustom = selectedOption.getAttribute('data-is-custom') === 'true';
        editBtn.style.display = isCustom ? 'inline-block' : 'none';
    } else {
        // –ù–µ—Ç –≤—ã–±–æ—Ä–∞
        viewBtn.style.display = 'none';
        editBtn.style.display = 'none';
    }
}

function viewCreateSchedule() {
    const scheduleSelect = document.getElementById('create_payment_schedule_id');
    const scheduleId = scheduleSelect.value;
    
    if (scheduleId) {
        window.open(`/owner/payment-schedules/${scheduleId}/view`, '_blank', 'width=800,height=600');
    }
}

function editCreateSchedule() {
    const scheduleSelect = document.getElementById('create_payment_schedule_id');
    const selectedOption = scheduleSelect.options[scheduleSelect.selectedIndex];
    const scheduleId = scheduleSelect.value;
    const isCustom = selectedOption.getAttribute('data-is-custom') === 'true';
    
    if (!isCustom) {
        alert('–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏');
        return;
    }
    
    window.open(`/owner/payment-schedules/${scheduleId}/edit`, '_blank', 'width=900,height=700');
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –≤—ã–ø–ª–∞—Ç (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è)
function updateEditScheduleActions() {
    const scheduleSelect = document.getElementById('edit_payment_schedule_id');
    const selectedOption = scheduleSelect.options[scheduleSelect.selectedIndex];
    const descEl = document.getElementById('edit_schedule_description_text');
    const viewBtn = document.getElementById('view_edit_schedule_btn');
    const editBtn = document.getElementById('edit_edit_schedule_btn');
    
    // –û–±–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
    const description = selectedOption.getAttribute('data-description') || '';
    descEl.textContent = description;
    
    const selectedValue = scheduleSelect.value;
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π"
    if (selectedValue === 'create_new') {
        viewBtn.style.display = 'none';
        editBtn.style.display = 'none';
        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        window.open('/owner/payment-schedules/create', '_blank', 'width=900,height=700');
        // –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
        scheduleSelect.value = '';
        descEl.textContent = '';
    } else if (selectedValue) {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        viewBtn.style.display = 'inline-block';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö
        const isCustom = selectedOption.getAttribute('data-is-custom') === 'true';
        editBtn.style.display = isCustom ? 'inline-block' : 'none';
    } else {
        // –ù–µ—Ç –≤—ã–±–æ—Ä–∞
        viewBtn.style.display = 'none';
        editBtn.style.display = 'none';
    }
}

function viewEditSchedule() {
    const scheduleSelect = document.getElementById('edit_payment_schedule_id');
    const scheduleId = scheduleSelect.value;
    
    if (scheduleId) {
        window.open(`/owner/payment-schedules/${scheduleId}/view`, '_blank', 'width=800,height=600');
    }
}

function editEditSchedule() {
    const scheduleSelect = document.getElementById('edit_payment_schedule_id');
    const selectedOption = scheduleSelect.options[scheduleSelect.selectedIndex];
    const scheduleId = scheduleSelect.value;
    const isCustom = selectedOption.getAttribute('data-is-custom') === 'true';
    
    if (!isCustom) {
        alert('–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏');
        return;
    }
    
    window.open(`/owner/payment-schedules/${scheduleId}/edit`, '_blank', 'width=900,height=700');
}
</script>

{% endblock %}

