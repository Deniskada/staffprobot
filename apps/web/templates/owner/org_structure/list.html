{% extends "owner/base_owner.html" %}

{% block title %}–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ —Ñ–∏–Ω–∞–Ω—Å—ã{% endblock %}

<!-- –ú–∞–∫—Ä–æ—Å –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
{% macro render_unit_new(unit, payment_systems, payment_schedules) %}
<div class="org-tree-item" 
     data-level="{{ unit.level }}" 
     data-unit-id="{{ unit.id }}"
     data-schedule-id="{{ unit.payment_schedule_id or '' }}"
     data-system-id="{{ unit.payment_system_id or '' }}"
     onclick="selectOrgUnit({{ unit.id }}, {{ unit.payment_schedule_id or 'null' }}, {{ unit.payment_system_id or 'null' }})">
    <div class="d-flex justify-content-between align-items-center">
        <div class="flex-grow-1">
            <div class="mb-1">
                <span class="org-unit-icon">
                    {% if unit.level == 0 %}üè¢
                    {% elif unit.level == 1 %}üè¨
                    {% elif unit.level == 2 %}üè™
                    {% else %}üìç
                    {% endif %}
                </span>
                <strong>{{ unit.name }}</strong>
            </div>
            <small class="text-muted d-block">
                {% if unit.payment_system_id %}
                    {% for ps in payment_systems %}
                        {% if ps.id == unit.payment_system_id %}
                            <span class="badge-star">‚≠ê</span> {{ ps.name }}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <span class="text-muted-light">üí∞ –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è</span>
                {% endif %}
                ‚Ä¢
                {% if unit.payment_schedule_id %}
                    {% for schedule in payment_schedules %}
                        {% if schedule.id == unit.payment_schedule_id %}
                            üìÖ {{ schedule.name }}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <span class="text-muted-light">üìÖ –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è</span>
                {% endif %}
            </small>
        </div>
        <div class="btn-group" onclick="event.stopPropagation()">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showEditModal({{ unit.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                <i class="fas fa-edit"></i>
            </button>
            {% if unit.level > 0 %}
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteUnit({{ unit.id }}, '{{ unit.name }}')" title="–£–¥–∞–ª–∏—Ç—å">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% if unit.children %}
    {% for child in unit.children %}
        {{ render_unit_new(child, payment_systems, payment_schedules) }}
    {% endfor %}
{% endif %}
{% endmacro %}

<!-- –ú–∞–∫—Ä–æ—Å –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ options –≤ select -->
{% macro render_unit_options(unit, indent) %}
<option value="{{ unit.id }}">{{ '‚îú‚îÄ ' * indent }}{{ unit.name }}</option>
{% if unit.children %}
    {% for child in unit.children %}
        {{ render_unit_options(child, indent + 1) }}
    {% endfor %}
{% endif %}
{% endmacro %}

{% block extra_css %}
<style>
    /* ===== –ò–ï–†–ê–†–•–ò–Ø –ü–û–î–†–ê–ó–î–ï–õ–ï–ù–ò–ô ===== */
    .org-hierarchy-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .org-tree-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 0.5rem;
    }
    
    .org-tree-item {
        position: relative;
        margin-bottom: 0.5rem;
        padding: 0.75rem 1rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .org-tree-item:hover {
        background: #f7fafc;
        border-color: #4299e1;
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(66, 153, 225, 0.15);
    }
    
    .org-tree-item.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .org-tree-item.selected .text-muted,
    .org-tree-item.selected .badge {
        color: white !important;
        background: rgba(255,255,255,0.2) !important;
    }
    
    /* –û—Ç—Å—Ç—É–ø—ã –ø–æ —É—Ä–æ–≤–Ω—è–º —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –ª–∏–Ω–∏—è–º–∏ */
    .org-tree-item[data-level="0"] { margin-left: 0; }
    .org-tree-item[data-level="1"] { margin-left: 2rem; border-left: 3px solid #cbd5e0; }
    .org-tree-item[data-level="2"] { margin-left: 4rem; border-left: 3px solid #cbd5e0; }
    .org-tree-item[data-level="3"] { margin-left: 6rem; border-left: 3px solid #cbd5e0; }
    .org-tree-item[data-level="4"] { margin-left: 8rem; border-left: 3px solid #cbd5e0; }
    
    /* –ò–∫–æ–Ω–∫–∏ –∏ –±–µ–π–¥–∂–∏ */
    .org-unit-icon {
        font-size: 1.2rem;
        margin-right: 0.5rem;
    }
    
    .badge-star {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* ===== SPLIT VIEW LAYOUT ===== */
    .split-view-container {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 1.5rem;
        min-height: 600px;
    }
    
    @media (max-width: 1200px) {
        .split-view-container {
            grid-template-columns: 1fr;
        }
    }
    
    /* ===== –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===== */
    .left-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    /* –ì—Ä–∞—Ñ–∏–∫–∏ –≤—ã–ø–ª–∞—Ç */
    .schedules-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 1.5rem;
    }
    
    .schedule-item {
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .schedule-item:hover {
        background: #f7fafc;
        border-color: #4299e1;
        transform: translateX(2px);
    }
    
    .schedule-item.selected {
        background: #ebf8ff;
        border-color: #4299e1;
        border-left-width: 4px;
    }
    
    .schedule-meta {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }
    
    /* –°–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã */
    .payment-systems-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 1.5rem;
    }
    
    .system-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .system-card.active {
        border-color: #f6ad55;
        background: #fffaf0;
        box-shadow: 0 0 15px rgba(246, 173, 85, 0.2);
    }
    
    .system-card.hourly { border-left: 4px solid #667eea; }
    .system-card.salary { border-left: 4px solid #48bb78; }
    .system-card.hourly_bonus { border-left: 4px solid #f6ad55; }
    
    /* ===== –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===== */
    .right-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
    }
    
    .schedule-details-header {
        padding-bottom: 1rem;
        border-bottom: 2px solid #e2e8f0;
        margin-bottom: 1rem;
    }
    
    .schedule-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .stat-card {
        text-align: center;
        padding: 1rem;
        background: #f7fafc;
        border-radius: 8px;
    }
    
    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2d3748;
    }
    
    .stat-card .stat-label {
        font-size: 0.875rem;
        color: #718096;
        margin-top: 0.25rem;
    }
    
    .schedule-preview-table {
        flex: 1;
        overflow-y: auto;
        margin-top: 1rem;
    }
    
    .schedule-preview-table table {
        width: 100%;
        font-size: 0.875rem;
    }
    
    .schedule-preview-table thead {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 10;
    }
    
    /* Expandable —Å–ø–∏—Å–∫–∏ */
    .expandable-section {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .expandable-header {
        padding: 0.75rem 1rem;
        background: #f7fafc;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }
    
    .expandable-header:hover {
        background: #edf2f7;
    }
    
    .expandable-content {
        padding: 1rem;
        display: none;
    }
    
    .expandable-content.show {
        display: block;
    }
    
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #718096;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    /* Buttons */
    .btn-create-custom {
        width: 100%;
        margin-top: 0.5rem;
        border: 2px dashed #cbd5e0;
        background: transparent;
        color: #4299e1;
        padding: 0.75rem;
        border-radius: 8px;
        transition: all 0.2s;
    }
    
    .btn-create-custom:hover {
        background: #ebf8ff;
        border-color: #4299e1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-sitemap"></i> –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ —Ñ–∏–Ω–∞–Ω—Å—ã
            </h2>
            <p class="text-muted mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –≤—ã–ø–ª–∞—Ç –∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –æ–ø–ª–∞—Ç—ã</p>
        </div>
        <button type="button" class="btn btn-primary" onclick="showCreateModal()">
            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
        </button>
    </div>

    <!-- –£–†–û–í–ï–ù–¨ 1: –ò–µ—Ä–∞—Ä—Ö–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π -->
    <div class="org-hierarchy-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-building"></i> –ò–µ—Ä–∞—Ä—Ö–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
            </h5>
            <span class="badge bg-secondary">–í—Å–µ–≥–æ: {{ units_count }}</span>
        </div>
        
        {% if org_tree %}
        <div class="org-tree-container" id="org-tree-container">
            {% for root in org_tree %}
                {{ render_unit_new(root, payment_systems, payment_schedules) }}
            {% endfor %}
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> 
                –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ –≥—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç –∏ —Å–∏—Å—Ç–µ–º—É –æ–ø–ª–∞—Ç—ã
            </small>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-building"></i>
            <p>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            <button class="btn btn-primary" onclick="showCreateModal()">
                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
            </button>
        </div>
        {% endif %}
    </div>

    <!-- –£–†–û–í–ï–ù–¨ 2: Split View -->
    <div class="split-view-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="left-panel">
            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –≤—ã–ø–ª–∞—Ç -->
            <div class="schedules-section">
                <h6 class="mb-3">
                    <i class="fas fa-calendar-alt"></i> –ì—Ä–∞—Ñ–∏–∫–∏ –≤—ã–ø–ª–∞—Ç
                </h6>
                
                <div id="schedules-list">
                    {% if payment_schedules %}
                        {% for schedule in payment_schedules %}
                        <div class="schedule-item" 
                             data-schedule-id="{{ schedule.id }}"
                             onclick="selectSchedule({{ schedule.id }})">
                            <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                                    <strong>{{ schedule.name }}</strong>
                                    {% if schedule.is_custom %}
                                    <span class="badge bg-purple text-white ms-2">–ö–∞—Å—Ç–æ–º–Ω—ã–π</span>
                    {% endif %}
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="event.stopPropagation(); viewScheduleFullScreen({{ schedule.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="schedule-meta">
                                <small class="badge bg-light text-dark">
                                    {% if schedule.frequency == 'daily' %}–ï–∂–µ–¥–Ω–µ–≤–Ω–æ
                                    {% elif schedule.frequency == 'weekly' %}–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
                                    {% elif schedule.frequency == 'monthly' %}–ï–∂–µ–º–µ—Å—è—á–Ω–æ
                                    {% endif %}
                                </small>
                                <small class="badge bg-light text-dark" id="schedule-usage-{{ schedule.id }}">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <p>–ì—Ä–∞—Ñ–∏–∫–∏ –≤—ã–ø–ª–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        </div>
                    {% endif %}
                </div>
                
                <button class="btn-create-custom" onclick="createCustomSchedule()">
                    <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
                </button>
            </div>

            <!-- –°–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã -->
            <div class="payment-systems-section">
                <h6 class="mb-3">
                    <i class="fas fa-money-check-alt"></i> –°–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã
                </h6>
                
                {% if systems %}
                    {% for system in systems %}
                    <div class="system-card {{ system.calculation_type }}" data-system-id="{{ system.id }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ system.name }}</strong>
                                <div class="mt-1">
                                    {% if system.calculation_type == 'hourly' %}
                                        <span class="badge bg-info">–ü–æ—á–∞—Å–æ–≤–æ–π</span>
                                    {% elif system.calculation_type == 'salary' %}
                                        <span class="badge bg-success">–û–∫–ª–∞–¥–Ω—ã–π</span>
                                    {% elif system.calculation_type == 'hourly_bonus' %}
                                        <span class="badge bg-warning">–° –ø—Ä–µ–º–∏–µ–π</span>
                                    {% endif %}
                                </div>
                            </div>
                            <small class="text-muted" id="system-count-{{ system.id }}">
                                <i class="fas fa-spinner fa-spin"></i>
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-money-check-alt"></i>
                        <p>–°–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="right-panel">
            <div id="schedule-details-content">
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <h5>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫</h5>
                    <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç<br>–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–∞–π–ª–∞) -->
{% include 'owner/org_structure/modals.html' %}
{% endblock %}

{% block extra_js %}
<script src="{{ 'js/shared/payment_schedule_editor.js' | static_version }}"></script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let selectedUnitId = null;
let selectedScheduleId = null;
let selectedSystemId = null;

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadScheduleStats();
    loadSystemStats();
});

// –í—ã–±–æ—Ä –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
function selectOrgUnit(unitId, scheduleId, systemId) {
    // –£–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    document.querySelectorAll('.org-tree-item').forEach(el => el.classList.remove('selected'));
    
    // –í—ã–¥–µ–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
    event.currentTarget.classList.add('selected');
    
    selectedUnitId = unitId;
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫ - –≤—ã–±—Ä–∞—Ç—å –µ–≥–æ
    if (scheduleId) {
        selectSchedule(scheduleId);
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∞ - –≤—ã–¥–µ–ª–∏—Ç—å –µ–µ
    if (systemId) {
        highlightSystem(systemId);
    }
}

// –í—ã–±–æ—Ä –≥—Ä–∞—Ñ–∏–∫–∞
function selectSchedule(scheduleId) {
    // –£–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    document.querySelectorAll('.schedule-item').forEach(el => el.classList.remove('selected'));
    
    // –í—ã–¥–µ–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π
    const scheduleEl = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
    if (scheduleEl) {
        scheduleEl.classList.add('selected');
        selectedScheduleId = scheduleId;
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∞
        loadScheduleDetails(scheduleId);
    }
}

// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã
function highlightSystem(systemId) {
    // –£–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
    document.querySelectorAll('.system-card').forEach(el => el.classList.remove('active'));
    
    // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é
    const systemEl = document.querySelector(`[data-system-id="${systemId}"]`);
    if (systemEl) {
        systemEl.classList.add('active');
        selectedSystemId = systemId;
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∞
async function loadScheduleDetails(scheduleId) {
    const container = document.getElementById('schedule-details-content');
    container.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-3x text-muted"></i></div>';
    
    try {
        const response = await fetch(`/owner/payment-schedules/${scheduleId}/data`);
        if (!response.ok) throw new Error('Failed to load');
        
        const schedule = await response.json();
        
        // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        const statsResponse = await fetch(`/owner/org-structure/schedule-stats/${scheduleId}`);
        const stats = statsResponse.ok ? await statsResponse.json() : { units: [], objects: 0, employees: 0 };
        
        // –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –¥–µ—Ç–∞–ª–∏
        renderScheduleDetails(schedule, stats);
        
    } catch (e) {
        console.error('Error loading schedule details:', e);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞
                            </div>
        `;
    }
}

// –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∞
function renderScheduleDetails(schedule, stats) {
    const frequency = {
        'daily': '–ï–∂–µ–¥–Ω–µ–≤–Ω–æ',
        'weekly': '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ',
        'monthly': '–ï–∂–µ–º–µ—Å—è—á–Ω–æ'
    }[schedule.frequency] || schedule.frequency;
    
    const container = document.getElementById('schedule-details-content');
    
    let html = `
        <div class="schedule-details-header">
            <h4 class="mb-2">
                <i class="fas fa-calendar-alt"></i> ${schedule.name}
                ${schedule.is_custom ? '<span class="badge bg-purple text-white ms-2">–ö–∞—Å—Ç–æ–º–Ω—ã–π</span>' : '<span class="badge bg-secondary ms-2">–°–∏—Å—Ç–µ–º–Ω—ã–π</span>'}
            </h4>
            <p class="text-muted mb-0">
                <i class="fas fa-clock"></i> ${frequency}
                ${schedule.payment_day ? ` ‚Ä¢ –î–µ–Ω—å –≤—ã–ø–ª–∞—Ç—ã: ${schedule.payment_day}` : ''}
            </p>
                    </div>
                    
        <div class="schedule-stats">
            <div class="stat-card">
                <div class="stat-value">${stats.units.length}</div>
                <div class="stat-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</div>
                            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.objects || 0}</div>
                <div class="stat-label">–û–±—ä–µ–∫—Ç–æ–≤</div>
                        </div>
            <div class="stat-card">
                <div class="stat-value">${stats.employees || 0}</div>
                <div class="stat-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                            </div>
                        </div>
    `;
    
    // –°–ø–∏—Å–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
    if (stats.units && stats.units.length > 0) {
        html += `
            <div class="expandable-section">
                <div class="expandable-header" onclick="toggleExpandable(this)">
                    <span><i class="fas fa-building"></i> –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å —ç—Ç–∏–º –≥—Ä–∞—Ñ–∏–∫–æ–º</span>
                    <i class="fas fa-chevron-down"></i>
                            </div>
                <div class="expandable-content">
                    <ul class="list-unstyled mb-0">
        `;
        
        stats.units.forEach(unit => {
            html += `
                <li class="mb-2">
                    <i class="fas fa-folder text-primary"></i>
                    <strong>${unit.name}</strong>
                    <small class="text-muted">(${unit.objects_count || 0} –æ–±—ä–µ–∫—Ç–æ–≤)</small>
                </li>
            `;
        });
        
        html += `
                    </ul>
                        </div>
                    </div>
        `;
    }
    
    // –ü—Ä–µ–≤—å—é –≥—Ä–∞—Ñ–∏–∫–∞ (–ø–µ—Ä–≤—ã–µ 10 –∑–∞–ø–∏—Å–µ–π)
    html += `
        <div class="mt-3">
            <h6 class="mb-2"><i class="fas fa-table"></i> –ü—Ä–µ–≤—å—é –≥—Ä–∞—Ñ–∏–∫–∞ (–ø–µ—Ä–≤—ã–µ 10 –≤—ã–ø–ª–∞—Ç)</h6>
            <div class="schedule-preview-table">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th style="width: 50px;">‚Ññ</th>
                            <th>–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã</th>
                            <th>–ü–µ—Ä–∏–æ–¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" class="text-center"><i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</td></tr>
                    </tbody>
                </table>
                    </div>
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="viewScheduleFullScreen(${schedule.id})">
                    <i class="fas fa-external-link-alt"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
                    </button>
                </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–≤—å—é –≥—Ä–∞—Ñ–∏–∫–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    loadSchedulePreview(schedule.id);
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–≤—å—é –≥—Ä–∞—Ñ–∏–∫–∞
async function loadSchedulePreview(scheduleId) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∂–µ–º placeholder
    setTimeout(() => {
        const tbody = document.querySelector('.schedule-preview-table tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr><td>1</td><td><strong>25.10.2024</strong></td><td>18.10 - 24.10</td></tr>
                <tr><td>2</td><td><strong>01.11.2024</strong></td><td>25.10 - 31.10</td></tr>
                <tr><td>3</td><td><strong>08.11.2024</strong></td><td>01.11 - 07.11</td></tr>
                <tr><td>4</td><td><strong>15.11.2024</strong></td><td>08.11 - 14.11</td></tr>
                <tr><td>5</td><td><strong>22.11.2024</strong></td><td>15.11 - 21.11</td></tr>
                <tr><td colspan="3" class="text-center text-muted"><small>...</small></td></tr>
            `;
        }
    }, 500);
}

// Toggle expandable section
function toggleExpandable(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('i.fa-chevron-down, i.fa-chevron-up');
    
    content.classList.toggle('show');
    
    if (content.classList.contains('show')) {
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

// –û—Ç–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
function viewScheduleFullScreen(scheduleId) {
    window.open(`/owner/payment-schedules/${scheduleId}/view`, '_blank', 'width=1000,height=700');
}

// –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
function createCustomSchedule() {
    // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞');
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
async function loadScheduleStats() {
    try {
        const response = await fetch('/owner/org-structure/schedules-usage');
        if (!response.ok) return;
        
        const data = await response.json();
        
        data.forEach(item => {
            const el = document.getElementById(`schedule-usage-${item.schedule_id}`);
            if (el) {
                el.innerHTML = `${item.units_count} –ø–æ–¥—Ä–∞–∑–¥.`;
            }
        });
    } catch (e) {
        console.error('Error loading schedule stats:', e);
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º –æ–ø–ª–∞—Ç—ã
async function loadSystemStats() {
    try {
        const response = await fetch('/owner/org-structure/systems-usage');
        if (!response.ok) return;
        
        const data = await response.json();
        
        data.forEach(item => {
            const el = document.getElementById(`system-count-${item.system_id}`);
            if (el) {
                el.innerHTML = `${item.count} –ø–æ–¥—Ä–∞–∑–¥.`;
            }
        });
    } catch (e) {
        console.error('Error loading system stats:', e);
    }
}

// ===== –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–∞–π–ª–∞) =====

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è
function showCreateModal() {
    const modal = new bootstrap.Modal(document.getElementById('createUnitModal'));
    modal.show();
    toggleCreateLateFields();
    updateCreateScheduleActions();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async function showEditModal(unitId) {
    try {
        const response = await fetch(`/owner/org-structure/${unitId}/data`);
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
        
        const unit = await response.json();
        
        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É
        document.getElementById('edit_unit_id').value = unit.id;
        document.getElementById('edit_name').value = unit.name;
        document.getElementById('edit_description').value = unit.description || '';
        document.getElementById('edit_payment_system_id').value = unit.payment_system_id || '';
        document.getElementById('edit_payment_schedule_id').value = unit.payment_schedule_id || '';
        document.getElementById('edit_inherit_late_settings').checked = unit.inherit_late_settings;
        document.getElementById('edit_late_threshold').value = unit.late_threshold_minutes || '';
        document.getElementById('edit_late_penalty').value = unit.late_penalty_per_minute || '';
        document.getElementById('edit_inherit_cancellation_settings').checked = unit.inherit_cancellation_settings !== false;
        document.getElementById('edit_cancel_hours').value = unit.cancellation_short_notice_hours || '';
        document.getElementById('edit_cancel_short_fine').value = unit.cancellation_short_notice_fine || '';
        document.getElementById('edit_cancel_invalid_fine').value = unit.cancellation_invalid_reason_fine || '';
        document.getElementById('edit_telegram_chat').value = unit.telegram_report_chat_id || '';
        document.getElementById('edit_is_active').checked = unit.is_active;
        
        document.getElementById('editUnitForm').action = `/owner/org-structure/${unitId}/edit`;
        
        const modal = new bootstrap.Modal(document.getElementById('editUnitModal'));
        modal.show();
        
        toggleEditLateFields();
        toggleEditCancellationFields();
        updateEditScheduleActions();
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`);
    }
}

// –£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
async function deleteUnit(unitId, unitName) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ "${unitName}"?`)) return;
    
    try {
        const response = await fetch(`/owner/org-structure/${unitId}/delete`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert(`–û—à–∏–±–∫–∞: ${result.message}`);
        }
    } catch (e) {
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${e.message}`);
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π —à—Ç—Ä–∞—Ñ–æ–≤
function toggleCreateLateFields() {
    const checkbox = document.getElementById('create_inherit_late_settings');
    const inputs = [
        document.getElementById('create_late_threshold'),
        document.getElementById('create_late_penalty')
    ];
    
    inputs.forEach(input => {
        input.readOnly = checkbox.checked;
        input.style.backgroundColor = checkbox.checked ? '#e9ecef' : '';
    });
}

function toggleEditLateFields() {
    const checkbox = document.getElementById('edit_inherit_late_settings');
    const inputs = [
        document.getElementById('edit_late_threshold'),
        document.getElementById('edit_late_penalty')
    ];
    
    inputs.forEach(input => {
        input.readOnly = checkbox.checked;
        input.style.backgroundColor = checkbox.checked ? '#e9ecef' : '';
    });
}

function toggleCreateCancellationFields() {
    const checkbox = document.getElementById('create_inherit_cancellation_settings');
    const inputs = [
        document.getElementById('create_cancel_hours'),
        document.getElementById('create_cancel_short_fine'),
        document.getElementById('create_cancel_invalid_fine')
    ];
    
    inputs.forEach(input => {
        input.readOnly = checkbox.checked;
        input.style.backgroundColor = checkbox.checked ? '#e9ecef' : '';
    });
}

function toggleEditCancellationFields() {
    const checkbox = document.getElementById('edit_inherit_cancellation_settings');
    const inputs = [
        document.getElementById('edit_cancel_hours'),
        document.getElementById('edit_cancel_short_fine'),
        document.getElementById('edit_cancel_invalid_fine')
    ];
    
    inputs.forEach(input => {
        input.readOnly = checkbox.checked;
        input.style.backgroundColor = checkbox.checked ? '#e9ecef' : '';
    });
}

// –ì—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç - —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
let createPaymentScheduleEditor;
let editPaymentScheduleEditor;

function updateCreateScheduleActions() {
    const scheduleSelect = document.getElementById('create_payment_schedule_id');
    if (!scheduleSelect) return;
    
    const selectedOption = scheduleSelect.options[scheduleSelect.selectedIndex];
    const descEl = document.getElementById('create_schedule_description_text');
    const viewBtn = document.getElementById('view_create_schedule_btn');
    const editBtn = document.getElementById('edit_create_schedule_btn');
    
    const description = selectedOption.getAttribute('data-description') || '';
    if (descEl) descEl.textContent = description;
    
    const selectedValue = scheduleSelect.value;
    
    if (selectedValue === 'create_new') {
        if (viewBtn) viewBtn.style.display = 'none';
        if (editBtn) editBtn.style.display = 'none';
        createNewScheduleForCreate();
        return;
    }
    
    if (selectedValue) {
        if (viewBtn) viewBtn.style.display = 'inline-block';
        const isCustom = selectedOption.getAttribute('data-is-custom') === 'true';
        if (editBtn) editBtn.style.display = isCustom ? 'inline-block' : 'none';
    } else {
        if (viewBtn) viewBtn.style.display = 'none';
        if (editBtn) editBtn.style.display = 'none';
    }
}

function updateEditScheduleActions() {
    const scheduleSelect = document.getElementById('edit_payment_schedule_id');
    if (!scheduleSelect) return;
    
    const selectedOption = scheduleSelect.options[scheduleSelect.selectedIndex];
    const descEl = document.getElementById('edit_schedule_description_text');
    const viewBtn = document.getElementById('view_edit_schedule_btn');
    const editBtn = document.getElementById('edit_edit_schedule_btn');
    
    const description = selectedOption.getAttribute('data-description') || '';
    if (descEl) descEl.textContent = description;
    
    const selectedValue = scheduleSelect.value;
    
    if (selectedValue === 'create_new') {
        if (viewBtn) viewBtn.style.display = 'none';
        if (editBtn) editBtn.style.display = 'none';
        createNewScheduleForEdit();
        return;
    }
    
    if (selectedValue) {
        if (viewBtn) viewBtn.style.display = 'inline-block';
        const isCustom = selectedOption.getAttribute('data-is-custom') === 'true';
        if (editBtn) editBtn.style.display = isCustom ? 'inline-block' : 'none';
    } else {
        if (viewBtn) viewBtn.style.display = 'none';
        if (editBtn) editBtn.style.display = 'none';
    }
}

function createNewScheduleForCreate() {
    if (!createPaymentScheduleEditor) {
        createPaymentScheduleEditor = new PaymentScheduleEditor('paymentScheduleModal', null);
        createPaymentScheduleEditor.init();
    }
    
    window.paymentScheduleEditor = createPaymentScheduleEditor;
    createPaymentScheduleEditor.scheduleId = null;
    
    document.getElementById('schedule_name').value = '';
    document.getElementById('schedule_frequency').value = 'daily';
    createPaymentScheduleEditor.scheduleData = [];
    createPaymentScheduleEditor.onFrequencyChange();
    
    setTimeout(() => createPaymentScheduleEditor.generateSchedule(), 100);
    createPaymentScheduleEditor.show();
    
    const scheduleSelect = document.getElementById('create_payment_schedule_id');
    if (scheduleSelect) scheduleSelect.value = '';
    const descEl = document.getElementById('create_schedule_description_text');
    if (descEl) descEl.textContent = '';
}

function createNewScheduleForEdit() {
    if (!editPaymentScheduleEditor) {
        editPaymentScheduleEditor = new PaymentScheduleEditor('paymentScheduleModal', null);
        editPaymentScheduleEditor.init();
    }
    
    window.paymentScheduleEditor = editPaymentScheduleEditor;
    editPaymentScheduleEditor.scheduleId = null;
    
    document.getElementById('schedule_name').value = '';
    document.getElementById('schedule_frequency').value = 'daily';
    editPaymentScheduleEditor.scheduleData = [];
    editPaymentScheduleEditor.onFrequencyChange();
    
    setTimeout(() => editPaymentScheduleEditor.generateSchedule(), 100);
    editPaymentScheduleEditor.show();
    
    const scheduleSelect = document.getElementById('edit_payment_schedule_id');
    if (scheduleSelect) scheduleSelect.value = '';
    const descEl = document.getElementById('edit_schedule_description_text');
    if (descEl) descEl.textContent = '';
}

function viewCreateSchedule() {
    const scheduleId = document.getElementById('create_payment_schedule_id')?.value;
    if (scheduleId) {
        window.open(`/owner/payment-schedules/${scheduleId}/view`, '_blank', 'width=800,height=600');
    }
}

function viewEditSchedule() {
    const scheduleId = document.getElementById('edit_payment_schedule_id')?.value;
    if (scheduleId) {
        window.open(`/owner/payment-schedules/${scheduleId}/view`, '_blank', 'width=800,height=600');
    }
}

function editCreateSchedule() {
    const scheduleSelect = document.getElementById('create_payment_schedule_id');
    if (!scheduleSelect) return;
    
    const selectedOption = scheduleSelect.options[scheduleSelect.selectedIndex];
    const scheduleId = scheduleSelect.value;
    const isCustom = selectedOption.getAttribute('data-is-custom') === 'true';
    
    if (!isCustom) {
        alert('–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏');
        return;
    }
    
    if (!createPaymentScheduleEditor) {
        createPaymentScheduleEditor = new PaymentScheduleEditor('paymentScheduleModal', null);
        createPaymentScheduleEditor.init();
    }
    
    window.paymentScheduleEditor = createPaymentScheduleEditor;
    createPaymentScheduleEditor.loadSchedule(scheduleId);
    createPaymentScheduleEditor.show();
}

function editEditSchedule() {
    const scheduleSelect = document.getElementById('edit_payment_schedule_id');
    if (!scheduleSelect) return;
    
    const selectedOption = scheduleSelect.options[scheduleSelect.selectedIndex];
    const scheduleId = scheduleSelect.value;
    const isCustom = selectedOption.getAttribute('data-is-custom') === 'true';
    
    if (!isCustom) {
        alert('–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏');
        return;
    }
    
    if (!editPaymentScheduleEditor) {
        editPaymentScheduleEditor = new PaymentScheduleEditor('paymentScheduleModal', null);
        editPaymentScheduleEditor.init();
    }
    
    window.paymentScheduleEditor = editPaymentScheduleEditor;
    editPaymentScheduleEditor.loadSchedule(scheduleId);
    editPaymentScheduleEditor.show();
}
</script>

{% include 'shared/payment_schedule_editor_modal.html' %}
{% endblock %}

