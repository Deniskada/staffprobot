{% extends "owner/base_owner.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/shared/calendar.css') }}">
<style>
/* Owner-specific calendar styles */

/* Drag & Drop Panels */
.drag-drop-panel {
    position: fixed;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 280px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: all 0.3s ease;
}

.drag-drop-panel.collapsed {
    width: 60px;
    height: 60px;
}

.drag-drop-panel.collapsed .panel-content {
    display: none;
}

.drag-drop-panel.collapsed .panel-header h6 {
    display: none;
}

.drag-drop-panel.collapsed .panel-header {
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 5px;
    height: 60px;
    width: 60px;
    border-radius: 50%;
    background: #007bff;
}

.drag-drop-panel.collapsed .panel-header button {
    display: none;
}

.drag-drop-panel.collapsed .collapsed-icon {
    display: flex !important;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.drag-drop-panel.collapsed .objects-count {
    position: absolute;
    top: -5px;
    right: -5px;
}

.drag-drop-panel.collapsed .objects-count .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.4rem;
}

.employees-panel {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 280px;
    max-height: 400px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
}

.employees-panel.collapsed {
    width: 60px;
    height: 60px;
}

.employees-panel.collapsed .panel-content {
    display: none;
}

.employees-panel.collapsed .panel-header h6 {
    display: none;
}

.employees-panel.collapsed .panel-header {
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 5px;
    height: 60px;
    width: 60px;
    border-radius: 50%;
    background: #28a745;
}

.employees-panel.collapsed .panel-header button {
    display: none;
}

.employees-panel.collapsed .collapsed-icon {
    display: flex !important;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.employees-panel.collapsed .employees-count {
    position: absolute;
    top: -5px;
    right: -5px;
}

.employees-panel.collapsed .employees-count .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.4rem;
}

.panel-header {
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 10px 10px 0 0;
}

.panel-content {
    padding: 15px;
    max-height: 250px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
}

.panel-actions {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.object-item, .employee-item {
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: grab;
    transition: all 0.2s ease;
    background: white;
}

.object-item:hover, .employee-item:hover {
    background: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.object-item:active, .employee-item:active {
    cursor: grabbing;
    transform: scale(0.98);
}

.object-name, .employee-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.object-address, .employee-role {
    font-size: 0.8rem;
    color: #6c757d;
}

/* Responsive */
@media (max-width: 768px) {
    .drag-drop-panel, .employees-panel {
        position: relative;
        left: auto;
        right: auto;
        top: auto;
        transform: none;
        width: 100%;
        margin-bottom: 20px;
    }
    
    .drag-drop-panel.collapsed, .employees-panel.collapsed {
        width: 100%;
        height: auto;
    }
    
    .drag-drop-panel.collapsed .panel-header, .employees-panel.collapsed .panel-header {
        flex-direction: row;
        justify-content: space-between;
        padding: 15px;
        height: auto;
        width: 100%;
        border-radius: 10px 10px 0 0;
        background: #f8f9fa;
    }
    
    .drag-drop-panel.collapsed .panel-header h6, .employees-panel.collapsed .panel-header h6 {
        display: block;
    }
    
    .drag-drop-panel.collapsed .panel-header button, .employees-panel.collapsed .panel-header button {
        display: block;
    }
    
    .drag-drop-panel.collapsed .collapsed-icon, .employees-panel.collapsed .collapsed-icon {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">


            <!-- Shared panels -->
            {% include 'shared/calendar/objects_panel.html' %}
            {% include 'shared/calendar/employees_panel.html' %}
            {% include 'shared/calendar/quick_create_form.html' %}

            <!-- Shared Calendar Grid -->
            {% include 'shared/calendar/grid.html' %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='js/shared/calendar.js') }}"></script>
<script src="{{ url_for('static', path='js/shared/calendar_panels.js') }}"></script>
<script>
// Initialize calendar manager
const calendarManager = new CalendarManager({
    currentDate: new Date('{{ current_date }}'),
    viewType: '{{ view_type }}',
    baseUrl: '{{ request.url.path }}',
    onShiftClick: showShiftDetails,
    onTimeslotClick: showTimeslotDetails,
    onDateClick: showDateDetails
});

// Initialize calendar panels for owner role
const calendarPanels = new CalendarPanels('owner');

// Override calendar manager methods for drag&drop
calendarManager.assignEmployeeToTimeslot = async function(employeeId, timeslotId) {
    try {
        console.log('Starting employee assignment:', employeeId, timeslotId);
        
        // Get employee details
        console.log('Fetching employees...');
        const employeeResponse = await fetch(`/owner/api/employees`);
        console.log('Employee response:', employeeResponse.status);
        
        if (!employeeResponse.ok) {
            throw new Error(`HTTP ${employeeResponse.status}: ${employeeResponse.statusText}`);
        }
        
        const employees = await employeeResponse.json();
        console.log('Employees data:', employees);
        
        const employee = employees.find(emp => emp.id == employeeId);
        console.log('Found employee:', employee);
        
        if (!employee) {
            calendarPanels.showNotification('Сотрудник не найден', 'error');
            return;
        }
        
        // Get timeslot details
        console.log('Fetching timeslot...');
        const timeslotResponse = await fetch(`/owner/calendar/api/timeslot/${timeslotId}`);
        console.log('Timeslot response:', timeslotResponse.status);
        
        if (!timeslotResponse.ok) {
            throw new Error(`HTTP ${timeslotResponse.status}: ${timeslotResponse.statusText}`);
        }
        
        const timeslot = await timeslotResponse.json();
        console.log('Found timeslot:', timeslot);
        
        if (!timeslot) {
            calendarPanels.showNotification('Тайм-слот не найден', 'error');
            return;
        }
        
        // Show notification about employee assignment
        calendarPanels.showNotification(`Сотрудник ${employee.name} назначен на тайм-слот ${timeslot.start_time} - ${timeslot.end_time}`, 'success');
        
        // For now, just show success message
        // TODO: Implement actual shift creation
        
    } catch (error) {
        console.error('Error assigning employee:', error);
        calendarPanels.showNotification(`Ошибка назначения сотрудника: ${error.message}`, 'error');
    }
};

calendarManager.createTimeslotFromObject = async function(objectId, timeslotId) {
    try {
        console.log('Creating timeslot from object:', objectId, timeslotId);
        
        // Get object details
        const objectResponse = await fetch(`/owner/calendar/api/objects`);
        const objects = await objectResponse.json();
        const object = objects.find(obj => obj.id == objectId);
        
        console.log('Found object:', object);
        
        if (!object) {
            calendarPanels.showNotification('Объект не найден', 'error');
            return;
        }
        
        // Get timeslot details
        const timeslotResponse = await fetch(`/owner/calendar/api/timeslot/${timeslotId}`);
        const timeslot = await timeslotResponse.json();
        
        console.log('Found timeslot:', timeslot);
        
        if (!timeslot) {
            calendarPanels.showNotification('Тайм-слот не найден', 'error');
            return;
        }
        
        // Show quick create form with pre-filled data
        console.log('Showing quick create form...');
        await calendarPanels.showQuickCreateForm({
            id: objectId,
            name: object.name,
            hourlyRate: object.hourly_rate || 0,
            openingTime: object.opening_time || '09:00',
            closingTime: object.closing_time || '18:00'
        }, timeslot.slot_date);
        
        console.log('Quick create form should be shown');
        
    } catch (error) {
        console.error('Error creating timeslot from object:', error);
        calendarPanels.showNotification('Ошибка создания тайм-слота', 'error');
    }
};

function showShiftDetails(shiftId) {
    // Handle planned shifts (schedule_ prefix)
    if (shiftId.toString().startsWith('schedule_')) {
        const scheduleId = shiftId.toString().replace('schedule_', '');
        window.location.href = `/owner/shifts/${scheduleId}?shift_type=schedule`;
    } else {
        // Regular shift
        window.location.href = `/owner/shifts/${shiftId}`;
    }
}

function showTimeslotDetails(timeslotId) {
    // Redirect to timeslot details page
    window.location.href = `/owner/timeslots/${timeslotId}`;
}

function showDateDetails(date) {
    // Show date details modal or redirect
    console.log('Show date details for:', date);
}

// Initialize panels on page load
document.addEventListener('DOMContentLoaded', function() {
    calendarPanels.init();
    
    // Re-setup drag&drop after calendar is fully loaded
    setTimeout(() => {
        console.log('Re-setting up drag&drop after calendar load');
        calendarManager.setupDragDrop();
    }, 500);
});

</script>
{% endblock %}
