{% extends "owner/base_owner.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/shared/calendar.css') }}">
<style>
/* Фиксированная высота страницы календаря - без вертикального скролла */
html, body {
    height: 100%;
    overflow: hidden;
}

body {
    display: flex;
    flex-direction: column;
}

/* Скрываем footer на странице календаря */
footer {
    display: none !important;
}

.content-wrapper {
    height: calc(100vh - var(--topbar-height, 60px)) !important;
    min-height: unset !important;
    padding: 0 !important;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* Календарь занимает всю высоту */
.calendar-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

.calendar-header-fixed {
    flex-shrink: 0;
}

.calendar-scrollable {
    flex: 1;
    overflow-y: auto !important;
    overflow-x: hidden;
    min-height: 0;
}

</style>
{% endblock %}

{% block content %}

<!-- Shared panels -->
{% include 'shared/calendar/quick_create_form.html' %}

<!-- Shared Calendar Grid -->
{% include 'shared/calendar/grid_unified.html' %}

{% endblock %}

{% block extra_js %}
<!-- Отключен старый calendar.js для тестирования -->
<!-- <script src="{{ url_for('static', path='js/shared/calendar.js') }}"></script> -->
<script src="{{ url_for('static', path='js/shared/calendar_panels.js') }}?v={{ range(1000, 9999) | random }}"></script>
<!-- Universal Calendar Integration -->
<script src="{{ url_for('static', path='js/shared/universal_calendar.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', path='js/shared/plan_shift_modal.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script>
    // Инициализация универсального календаря для владельца
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, CalendarPanels available:', typeof CalendarPanels !== 'undefined');
        // Инициализируем панели drag&drop
        if (typeof CalendarPanels !== 'undefined') {
            console.log('Initializing CalendarPanels for owner');
            window.calendarPanels = new CalendarPanels('owner');
            window.calendarPanels.init();
        } else {
            console.error('CalendarPanels not available!');
        }
        
        const buildOwnerReturnTo = () => {
            const search = window.location.search || '';
            return `/owner/calendar${search}`;
        };

        const navigateToOwnerPlan = (objectId, employeeId) => {
            const params = new URLSearchParams();
            if (objectId) {
                params.set('object_id', objectId);
            }
            if (employeeId) {
                params.set('employee_id', employeeId);
            }
            params.set('return_to', buildOwnerReturnTo());
            window.location.href = `/owner/shifts/plan?${params.toString()}`;
        };

        const openCancellationForm = (scheduleIds, caller = 'owner_calendar') => {
            const params = new URLSearchParams();
            const idList = Array.isArray(scheduleIds) ? scheduleIds : [scheduleIds];
            params.set('shift_type', 'schedule');
            params.set('shift_ids', idList.join(','));
            params.set('return_to', buildOwnerReturnTo());
            params.set('caller', caller);
            window.location.href = `/shared/cancellations/form?${params.toString()}`;
        };

        // Создаем экземпляр универсального календаря
        if (typeof UniversalCalendarManager !== 'undefined') {
            window.universalCalendar = new UniversalCalendarManager({
                currentDate: new Date({{ year }}, {{ month - 1 }}, 1),
                viewType: 'month',
                baseUrl: '/owner/calendar',
                userRole: 'owner',
                apiEndpoint: '/owner/calendar/api/data',
                onShiftClick: function(shiftId, event) {
                    console.log('Shift clicked:', shiftId);
                    if (shiftId.toString().startsWith('schedule_')) {
                        const scheduleId = shiftId.toString().replace('schedule_', '');
                        if (event && event.shiftKey) {
                            window.location.href = `/owner/shifts/${scheduleId}?shift_type=schedule`;
                            return;
                        }
                        // Получаем object_id из данных календаря
                        let objectId = null;
                        if (window.calendarData && window.calendarData.shifts) {
                            const shift = window.calendarData.shifts.find(s => s.id === shiftId);
                            if (shift && shift.object_id) {
                                objectId = shift.object_id;
                            }
                        }
                        // Если не нашли в данных, делаем запрос к API
                        if (!objectId) {
                            fetch(`/owner/shifts/api/schedule/${scheduleId}/object-id`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.object_id) {
                                        const employeeId = data.employee_id || (window.calendarData?.shifts?.find(s => s.id === shiftId)?.user_id) || null;
                                        navigateToOwnerPlan(data.object_id, employeeId);
                                    } else {
                                        const employeeId = data.employee_id || (window.calendarData?.shifts?.find(s => s.id === shiftId)?.user_id) || null;
                                        navigateToOwnerPlan(null, employeeId);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error fetching object_id:', error);
                                    const cached = window.calendarData?.shifts?.find(s => s.id === shiftId);
                                    const employeeId = cached?.user_id || null;
                                    navigateToOwnerPlan(null, employeeId);
                                });
                        } else {
                            const cached = window.calendarData?.shifts?.find(s => s.id === shiftId);
                            const employeeId = cached?.user_id || null;
                            navigateToOwnerPlan(objectId, employeeId);
                        }
                    } else {
                        window.location.href = `/owner/shifts/${shiftId}?shift_type=shift`;
                    }
                },
                onTimeslotClick: function(timeslotId) {
                    console.log('Timeslot clicked:', timeslotId);
                    let objectId = null;
                    let employeeId = null;
                    if (window.calendarData) {
                        if (window.calendarData.timeslots) {
                            const timeslot = window.calendarData.timeslots.find(ts => ts.id == timeslotId);
                            if (timeslot && timeslot.object_id) {
                                objectId = timeslot.object_id;
                            }
                        }
                        if (window.calendarData.shifts) {
                            const plannedShift = window.calendarData.shifts.find(shift => String(shift.time_slot_id) === String(timeslotId) && (shift.status === 'planned' || shift.status === 'confirmed'));
                            if (plannedShift && plannedShift.user_id) {
                                employeeId = plannedShift.user_id;
                            }
                        }
                    }
                    if (window.PlanShiftModal && typeof window.PlanShiftModal.open === 'function') {
                        window.PlanShiftModal.open(timeslotId);
                        return;
                    }
                    const fallbackParams = new URLSearchParams();
                    if (objectId) {
                        fallbackParams.set('object_id', objectId);
                    }
                    if (employeeId) {
                        fallbackParams.set('employee_id', employeeId);
                    }
                    fallbackParams.set('return_to', buildOwnerReturnTo());
                    window.location.href = `/owner/shifts/plan?${fallbackParams.toString()}`;
                },
                onDateClick: function(dateStr) {
                    if (window.calendarPanels && typeof window.calendarPanels.showQuickCreateForm === 'function') {
                        window.calendarPanels.showQuickCreateForm(null, dateStr);
                    }
                },
                onDataLoaded: function(calendarData) {
                    console.log('Calendar data loaded:', calendarData);
                    // Сохраняем данные глобально для использования в onShiftClick
                    window.calendarData = calendarData;
                    // Используем унифицированную функцию отрисовки
                    if (window.renderCalendarGrid) {
                        window.renderCalendarGrid(calendarData);
                    }
                },
                onShiftDelete: function(shiftInfo, event) {
                    if (event) {
                        event.preventDefault();
                    }
                    if (!shiftInfo || shiftInfo.type !== 'planned' || !shiftInfo.scheduleId) {
                        notifyCalendar('Удалять можно только запланированные смены', 'warning');
                        return;
                    }
                    openCancellationForm(String(shiftInfo.scheduleId), 'owner_calendar_delete');
                }
            });
        }
    });
</script>

<script>
function notifyCalendar(message, type = 'info') {
    if (window.calendarPanels && typeof window.calendarPanels.showNotification === 'function') {
        window.calendarPanels.showNotification(message, type);
    } else {
        console.log(`[${type}] ${message}`);
    }
}

if (window.PlanShiftModal) {
    window.PlanShiftModal.configure({
        role: 'owner',
        timeslotDetailEndpoint: (timeslotId) => `/owner/calendar/api/timeslot/${timeslotId}`,
        employeesForObjectEndpoint: (objectId) => `/owner/api/employees/for-object/${objectId}`,
        planShiftEndpoint: '/owner/api/calendar/plan-shift',
        notify: notifyCalendar,
        preparePlannedShifts: true,
        refreshCalendar: () => {
            if (window.universalCalendar && typeof window.universalCalendar.refresh === 'function') {
                window.universalCalendar.refresh();
            } else {
                setTimeout(() => window.location.reload(), 800);
            }
        }
    });
}
</script>

{% endblock %}
