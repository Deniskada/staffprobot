{% extends "owner/base_owner.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.analysis-container {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.analysis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.gap-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #dc3545;
}

.gap-card.no-gaps {
    border-left-color: #28a745;
}

.gap-item {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 10px;
    margin: 5px 0;
    border-left: 3px solid #dc3545;
}

.gap-item.no-gaps {
    border-left-color: #28a745;
    background: #d4edda;
}

.gap-date {
    font-weight: bold;
    color: #495057;
}

.gap-message {
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 5px;
}

.stats-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stats-number {
    font-size: 3em;
    font-weight: bold;
    color: #007bff;
}

.stats-label {
    color: #6c757d;
    font-size: 1.1em;
    margin-top: 10px;
}

.recommendation-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.recommendation-title {
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 10px;
}

.recommendation-list {
    list-style: none;
    padding: 0;
}

.recommendation-list li {
    padding: 5px 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.recommendation-list li:last-child {
    border-bottom: none;
}

.recommendation-list li:before {
    content: "üí° ";
    margin-right: 8px;
}

.object-selector {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.period-selector {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chart-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.no-data {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.no-data i {
    font-size: 4em;
    margin-bottom: 20px;
    opacity: 0.5;
}

.quick-actions {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.quick-actions .btn {
    margin: 5px;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="analysis-header">
        <div class="d-flex align-items-center">
            <h1 class="h3 mb-0 me-3">
                <i class="bi bi-graph-up"></i> {{ title }}
            </h1>
            <span class="badge bg-info fs-6">–ü–µ—Ä–∏–æ–¥: {{ analysis_data.period }}</span>
        </div>
        
        <div class="d-flex align-items-center gap-3">
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–æ–≤ -->
            <div class="btn-group" role="group">
                <a href="/calendar/" class="btn btn-outline-primary">
                    <i class="bi bi-calendar3"></i> –ú–µ—Å—è—Ü
                </a>
                <a href="/calendar/week" class="btn btn-outline-primary">
                    <i class="bi bi-calendar-week"></i> –ù–µ–¥–µ–ª—è
                </a>
            </div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="object-selector">
                <h6 class="mb-3">
                    <i class="bi bi-building"></i> –§–∏–ª—å—Ç—Ä –ø–æ –æ–±—ä–µ–∫—Ç–∞–º
                </h6>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                        {% if selected_object %}
                            {{ selected_object.name }}
                        {% else %}
                            –í—Å–µ –æ–±—ä–µ–∫—Ç—ã
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu w-100">
                        <li><a class="dropdown-item" href="?days={{ days }}">–í—Å–µ –æ–±—ä–µ–∫—Ç—ã</a></li>
                        {% for obj in objects %}
                        <li><a class="dropdown-item" href="?object_id={{ obj.id }}&days={{ days }}">{{ obj.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="period-selector">
                <h6 class="mb-3">
                    <i class="bi bi-calendar-range"></i> –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞
                </h6>
                <div class="btn-group w-100" role="group">
                    <a href="?{% if selected_object_id %}object_id={{ selected_object_id }}&{% endif %}days=7" 
                       class="btn btn-outline-secondary {% if days == 7 %}active{% endif %}">7 –¥–Ω–µ–π</a>
                    <a href="?{% if selected_object_id %}object_id={{ selected_object_id }}&{% endif %}days=30" 
                       class="btn btn-outline-secondary {% if days == 30 %}active{% endif %}">30 –¥–Ω–µ–π</a>
                    <a href="?{% if selected_object_id %}object_id={{ selected_object_id }}&{% endif %}days=90" 
                       class="btn btn-outline-secondary {% if days == 90 %}active{% endif %}">90 –¥–Ω–µ–π</a>
                </div>
            </div>
        </div>
    </div>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ analysis_data.total_gaps }}</div>
                <div class="stats-label">–í—Å–µ–≥–æ –ø—Ä–æ–±–µ–ª–æ–≤</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ analysis_data.object_gaps|length }}</div>
                <div class="stats-label">–û–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">
                    {% set objects_with_gaps = analysis_data.object_gaps.values()|selectattr('gaps_count', '>', 0)|list|length %}
                    {{ objects_with_gaps }}
                </div>
                <div class="stats-label">–û–±—ä–µ–∫—Ç–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">
                    {% if analysis_data.object_gaps|length > 0 %}
                        {{ "%.1f"|format((analysis_data.total_gaps / analysis_data.object_gaps|length) * 100) }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="stats-label">–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–∫—Ä—ã—Ç–∏—è</div>
            </div>
        </div>
    </div>

    <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
    {% if analysis_data.total_gaps > 0 %}
    <div class="recommendation-card">
        <div class="recommendation-title">
            <i class="bi bi-lightbulb"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        </div>
        <ul class="recommendation-list">
            <li>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–±–µ–ª—ã –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–ª–æ—Ç–æ–≤</li>
            <li>–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Å–º–µ–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ –Ω–∞ –Ω–µ–¥–µ–ª—é –≤–ø–µ—Ä–µ–¥</li>
            <li>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</li>
        </ul>
    </div>
    {% endif %}

    <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º -->
    {% if analysis_data.object_gaps %}
        {% for object_id, object_data in analysis_data.object_gaps.items() %}
        <div class="gap-card {% if object_data.gaps_count == 0 %}no-gaps{% endif %}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-building"></i> {{ object_data.object_name }}
                </h5>
                <span class="badge {% if object_data.gaps_count == 0 %}bg-success{% else %}bg-danger{% endif %}">
                    {{ object_data.gaps_count }} –ø—Ä–æ–±–µ–ª–æ–≤
                </span>
            </div>
            
            {% if object_data.gaps_count == 0 %}
                <div class="gap-item no-gaps">
                    <div class="gap-date">‚úÖ –û—Ç–ª–∏—á–Ω–æ!</div>
                    <div class="gap-message">–í—Å–µ –¥–Ω–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ –∏–º–µ—é—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–π–º-—Å–ª–æ—Ç—ã</div>
                </div>
            {% else %}
                {% for gap in object_data.gaps %}
                <div class="gap-item">
                    <div class="gap-date">{{ gap.date.strftime('%d.%m.%Y') }}</div>
                    <div class="gap-message">{{ gap.message }}</div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="no-data">
            <i class="bi bi-inbox"></i>
            <h4>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h4>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –æ–±—ä–µ–∫—Ç—ã –∏ —Ç–∞–π–º-—Å–ª–æ—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            <a href="/owner/objects/create" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç
            </a>
        </div>
    {% endif %}

    <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫—Ä—ã—Ç–∏—è (–∑–∞–≥–ª—É—à–∫–∞) -->
    <div class="chart-container">
        <h5 class="mb-3">
            <i class="bi bi-bar-chart"></i> –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫—Ä—ã—Ç–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        </h5>
        <div class="text-center text-muted">
            <i class="bi bi-graph-up" style="font-size: 3em; opacity: 0.3;"></i>
            <p class="mt-3">–ì—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö</p>
        </div>
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="quick-actions">
    <a href="/owner/objects/create" class="btn btn-primary" title="–°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç">
        <i class="bi bi-plus-lg"></i>
    </a>
    <a href="/timeslots/object/{% if selected_object_id %}{{ selected_object_id }}{% else %}1{% endif %}/create" 
       class="btn btn-success" title="–°–æ–∑–¥–∞—Ç—å —Ç–∞–π–º-—Å–ª–æ—Ç">
        <i class="bi bi-clock"></i>
    </a>
    <a href="/calendar/" class="btn btn-info" title="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">
        <i class="bi bi-calendar3"></i>
    </a>
</div>

<script>
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(function() {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞...');
}, 300000);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'r': // Ctrl+R - –æ–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                e.preventDefault();
                location.reload();
                break;
            case 'n': // Ctrl+N - –Ω–æ–≤—ã–π —Ç–∞–π–º-—Å–ª–æ—Ç
                e.preventDefault();
                window.location.href = '/timeslots/object/{% if selected_object_id %}{{ selected_object_id }}{% else %}1{% endif %}/create';
                break;
            case 'o': // Ctrl+O - –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
                e.preventDefault();
                window.location.href = '/owner/objects/create';
                break;
        }
    }
});
</script>
{% endblock %}
