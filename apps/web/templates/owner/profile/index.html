{% extends "owner/base_owner.html" %}

{% block title %}Профиль владельца{% endblock %}

{% block extra_css %}
<style>
    .tag-category {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .tag-category-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        cursor: pointer;
    }
    
    .tag-category-body {
        padding: 1rem;
    }
    
    .tag-item {
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
        background-color: #fff;
    }
    
    .tag-item.selected {
        border-color: #0d6efd;
        background-color: #e7f3ff;
    }
    
    .tag-checkbox {
        margin-right: 0.5rem;
    }
    
    .tag-label {
        font-weight: 500;
        color: #495057;
    }
    
    .tag-description {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .tag-value-input {
        margin-top: 0.5rem;
        display: none;
    }
    
    .tag-value-input.show {
        display: block;
    }
    
    .profile-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .completion-bar {
        background-color: rgba(255,255,255,0.3);
        border-radius: 1rem;
        height: 0.5rem;
        margin-top: 0.5rem;
        overflow: hidden;
    }
    
    .completion-fill {
        background-color: #fff;
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .legal-type-selector {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .category-icon {
        width: 1.5rem;
        height: 1.5rem;
        margin-right: 0.5rem;
    }
    
    .tag-help-category {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 0.5rem;
    }
    
    .tag-help-header {
        cursor: pointer;
        padding: 0.25rem 0;
    }
    
    .tag-help-header:hover {
        background-color: #f8f9fa;
    }
    
    .tag-help-body {
        margin-top: 0.5rem;
    }
    
    .photo-item img {
        height: 150px;
        object-fit: cover;
    }
    
    .feature-item {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .feature-item.disabled {
        background-color: #f8f9fa;
        opacity: 0.7;
    }
    
    .feature-toggle {
        transform: scale(1.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-user-circle me-2"></i>
                    Профиль владельца
                </h1>
                <div>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="previewProfile()">
                        <i class="fas fa-eye me-1"></i> Предпросмотр
                    </button>
                    <button type="submit" form="profileForm" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if request.query_params.get('success') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        Профиль успешно сохранён!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <form id="profileForm" method="POST" action="/owner/profile/save">
        <div class="row">
            <!-- Левая колонка - настройки профиля -->
            <div class="col-lg-4">
                <!-- Статистика профиля -->
                <div class="profile-stats">
                    <h5 class="mb-1">
                        <i class="fas fa-chart-pie me-2"></i>
                        Заполненность профиля
                    </h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Готовность к использованию</span>
                        <span id="completionPercent">{{ profile.get_completion_percentage() if profile else 0 }}%</span>
                    </div>
                    <div class="completion-bar">
                        <div class="completion-fill" style="width: {{ profile.get_completion_percentage() if profile else 0 }}%"></div>
                    </div>
                </div>

                <!-- Основные настройки -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Основные настройки
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="profile_name" class="form-label">Название профиля</label>
                            <input type="text" class="form-control" id="profile_name" name="profile_name" 
                                   value="{{ profile.profile_name if profile else 'Мой профиль' }}" required>
                        </div>

                        <!-- Тип собственника -->
                        <div class="legal-type-selector">
                            <label class="form-label">Тип собственника</label>
                            {% for legal_type in legal_types %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="legal_type" 
                                       id="legal_type_{{ legal_type.value }}" value="{{ legal_type.value }}"
                                       {% if (profile and profile.legal_type == legal_type.value) or (not profile and legal_type.value == 'individual') %}checked{% endif %}
                                       onchange="updateAvailableTags()">
                                <label class="form-check-label" for="legal_type_{{ legal_type.value }}">
                                    {% if legal_type.value == 'individual' %}
                                        <i class="fas fa-user category-icon"></i>
                                    {% else %}
                                        <i class="fas fa-building category-icon"></i>
                                    {% endif %}
                                    {{ legal_type.label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_public" name="is_public"
                                   {% if profile and profile.is_public %}checked{% endif %}>
                            <label class="form-check-label" for="is_public">
                                <i class="fas fa-globe me-1"></i>
                                Разрешить использование другими пользователями
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Управление профилями организаций -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            Профили организаций
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Реквизиты ИП/ЮЛ для договоров
                        </p>
                        <div id="orgProfilesList" class="mb-2">
                            <!-- Динамически загружается через JS -->
                        </div>
                        <button type="button" class="btn btn-sm btn-primary w-100" onclick="openOrgProfileModal()">
                            <i class="fas fa-plus me-1"></i> Добавить профиль
                        </button>
                    </div>
                </div>

                <!-- Справка по тегам (компактная) -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Справка по ТЭГам
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Теги для подстановки в договоры
                        </p>
                        
                        {% for category, tags in tags_by_category.items() %}
                        <div class="tag-help-category mb-2">
                            <div class="tag-help-header" onclick="toggleTagHelp('{{ category }}')">
                                <strong class="small">
                                    {% if category == 'system' %}
                                        <i class="fas fa-cog"></i> Системные
                                    {% elif category == 'owner' %}
                                        <i class="fas fa-user"></i> Владелец
                                    {% elif category == 'company' %}
                                        <i class="fas fa-building"></i> Компания
                                    {% elif category == 'organization_requisites' %}
                                        <i class="fas fa-file-invoice"></i> Реквизиты
                                    {% elif category == 'employee' %}
                                        <i class="fas fa-users"></i> Сотрудник
                                    {% else %}
                                        <i class="fas fa-tag"></i> {{ category }}
                                    {% endif %}
                                    <i class="fas fa-chevron-down float-end" id="chevron_{{ category }}"></i>
                                </strong>
                        </div>
                            <div class="tag-help-body small" id="taghelp_{{ category }}" style="display: none; padding-left: 1rem;">
                                {% for tag in tags[:5] %}
                                <div class="mb-1">
                                    <code class="small">{{ "{{ " + tag.key + " }}" }}</code> - {{ tag.label }}
                                </div>
                                {% endfor %}
                                {% if tags|length > 5 %}
                                <div class="text-muted small">...и еще {{ tags|length - 5 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Правая колонка - новые секции -->
            <div class="col-lg-8">
                <!-- О компании -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            О компании
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Напишите, чем занимается компания, как долго существует, сколько у вас сотрудников. 
                            Это повлияет на доверие соискателей.
                        </p>
                        <textarea class="form-control" name="about_company" rows="4" maxlength="2000"
                                  placeholder="Расскажите о вашей компании...">{{ profile.about_company if profile else '' }}</textarea>
                        <div class="form-text">Осталось символов: <span id="aboutCharsLeft">2000</span></div>
                    </div>
                </div>

                <!-- Ценности -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-heart me-2"></i>
                            Ценности компании
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Можете рассказать про деловую структуру и принципы компании. 
                            Это поможет найти сотрудников-единомышленников.
                        </p>
                        <textarea class="form-control" name="values" rows="4" maxlength="2000"
                                  placeholder="Опишите ценности и принципы вашей компании...">{{ profile.values if profile else '' }}</textarea>
                        <div class="form-text">Осталось символов: <span id="valuesCharsLeft">2000</span></div>
                    </div>
                </div>

                <!-- Фотографии -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-images me-2"></i>
                            Фотографии
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Загрузите фотографии вашей компании, офиса или команды (до 5 штук)
                        </p>
                        <div id="photosGallery" class="row g-2 mb-3">
                            {% if profile and profile.photos %}
                                {% for photo in profile.photos %}
                                <div class="col-md-4 photo-item" data-index="{{ loop.index0 }}">
                <div class="card">
                                        <img src="{{ photo }}" class="card-img-top" alt="Фото">
                                        <div class="card-body p-2">
                                            <button type="button" class="btn btn-sm btn-danger w-100" 
                                                    onclick="deletePhoto({{ loop.index0 }})">
                                                <i class="fas fa-trash"></i> Удалить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        {% if not profile or not profile.photos or profile.photos|length < 5 %}
                        <div class="input-group">
                            <input type="text" class="form-control" id="photoUrlInput" 
                                   placeholder="URL фотографии или загрузите файл">
                            <button class="btn btn-outline-secondary" type="button" onclick="addPhotoFromUrl()">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                        <div class="mt-2">
                            <input type="file" class="form-control" id="photoFileInput" accept="image/*" 
                                   onchange="uploadPhoto(this)">
                        </div>
                        {% endif %}
                        <input type="hidden" name="photos" id="photosData" 
                               value="{{ profile.photos | tojson if profile and profile.photos else '[]' }}">
                    </div>
                </div>

                <!-- Для связи -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-phone me-2"></i>
                            Для связи
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="contact_phone" class="form-label">Телефон</label>
                            <input type="tel" class="form-control" id="contact_phone" name="contact_phone"
                                   placeholder="+7 (___) ___-__-__"
                                   value="{{ profile.contact_phone if profile else '' }}">
                        </div>
                        <label class="form-label">Доступен в мессенджерах (MAX 1):</label>
                        <div class="form-check">
                            <input class="form-check-input messenger-check" type="checkbox" 
                                   id="messenger_whatsapp" value="whatsapp"
                                   {% if profile and profile.contact_messengers and 'whatsapp' in profile.contact_messengers %}checked{% endif %}>
                            <label class="form-check-label" for="messenger_whatsapp">
                                <i class="fab fa-whatsapp text-success"></i> WhatsApp
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input messenger-check" type="checkbox" 
                                   id="messenger_telegram" value="telegram"
                                   {% if profile and profile.contact_messengers and 'telegram' in profile.contact_messengers %}checked{% endif %}>
                            <label class="form-check-label" for="messenger_telegram">
                                <i class="fab fa-telegram text-info"></i> Telegram
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input messenger-check" type="checkbox" 
                                   id="messenger_max" value="max"
                                   {% if profile and profile.contact_messengers and 'max' in profile.contact_messengers %}checked{% endif %}>
                            <label class="form-check-label" for="messenger_max">
                                <i class="fas fa-comment text-primary"></i> MAX
                            </label>
                        </div>
                        <input type="hidden" name="contact_messengers" id="contactMessengersData"
                               value="{{ profile.contact_messengers | tojson if profile and profile.contact_messengers else '[]' }}">
                    </div>
                </div>

                <!-- Управление функциями -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-toggle-on me-2"></i>
                            Дополнительные функции
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">
                            Управляйте доступностью функций системы. Отключенные функции не будут отображаться в меню.
                        </p>
                        <div id="featuresContainer">
                            <!-- Динамически загружается через JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Модальное окно для профиля организации -->
<div class="modal fade" id="orgProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building me-2"></i>
                    <span id="orgProfileModalTitle">Профиль организации</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="orgProfileForm">
                    <input type="hidden" id="orgProfileId" name="profile_id">
                    
                    <div class="mb-3">
                        <label for="orgProfileName" class="form-label">Название профиля *</label>
                        <input type="text" class="form-control" id="orgProfileName" name="profile_name" 
                               placeholder="Например: ИП Иванов, ООО Ромашка" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Тип *</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="legal_type" 
                                       id="legalTypeIndividual" value="individual" checked
                                       onchange="updateOrgProfileFields()">
                                <label class="form-check-label" for="legalTypeIndividual">
                                    <i class="fas fa-user"></i> ИП / Физ.лицо
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="legal_type" 
                                       id="legalTypeLegal" value="legal"
                                       onchange="updateOrgProfileFields()">
                                <label class="form-check-label" for="legalTypeLegal">
                                    <i class="fas fa-building"></i> Юридическое лицо
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div id="orgProfileFieldsContainer">
                        <!-- Динамические поля реквизитов -->
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="orgProfileDefault" name="is_default">
                        <label class="form-check-label" for="orgProfileDefault">
                            Использовать как профиль по умолчанию
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveOrgProfile()">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ========== Старый код для тегов (можно удалить после переделки) ==========
{% if tags_by_category %}
// Данные тегов по категориям (оставляем для обратной совместимости)
const tagsByCategory = {{ tags_by_category_json | tojson }};

// Переключение видимости категории тегов (справка)
function toggleTagHelp(category) {
    const categoryBody = document.getElementById('taghelp_' + category);
    const chevron = document.getElementById('chevron_' + category);
    
    if (categoryBody.style.display === 'none') {
        categoryBody.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
    } else {
        categoryBody.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
    }
}
{% endif %}

// ========== Новый функционал ==========

// Счётчик символов для textarea
function initCharCounters() {
    const aboutTextarea = document.querySelector('textarea[name="about_company"]');
    const valuesTextarea = document.querySelector('textarea[name="values"]');
    
    if (aboutTextarea) {
        aboutTextarea.addEventListener('input', function() {
            const left = 2000 - this.value.length;
            document.getElementById('aboutCharsLeft').textContent = left;
        });
        // Инициализация
        const left = 2000 - aboutTextarea.value.length;
        document.getElementById('aboutCharsLeft').textContent = left;
    }
    
    if (valuesTextarea) {
        valuesTextarea.addEventListener('input', function() {
            const left = 2000 - this.value.length;
            document.getElementById('valuesCharsLeft').textContent = left;
        });
        // Инициализация
        const left = 2000 - valuesTextarea.value.length;
        document.getElementById('valuesCharsLeft').textContent = left;
    }
}

// Управление мессенджерами (MAX 1)
function initMessengersCheckboxes() {
    const checkboxes = document.querySelectorAll('.messenger-check');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                // Снять отметку с других
                checkboxes.forEach(other => {
                    if (other !== this) other.checked = false;
                });
            }
            updateMessengersData();
        });
    });
}

function updateMessengersData() {
    const checkboxes = document.querySelectorAll('.messenger-check:checked');
    const messengers = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('contactMessengersData').value = JSON.stringify(messengers);
}

// Управление фотографиями
let photosData = [];

function initPhotos() {
    const photosInput = document.getElementById('photosData');
    if (photosInput && photosInput.value) {
        try {
            photosData = JSON.parse(photosInput.value);
        } catch (e) {
            photosData = [];
        }
    }
}

function addPhotoFromUrl() {
    const input = document.getElementById('photoUrlInput');
    const url = input.value.trim();
    
    if (!url) {
        alert('Введите URL фотографии');
        return;
    }
    
    if (photosData.length >= 5) {
        alert('Максимум 5 фотографий');
        return;
    }
    
    photosData.push(url);
    updatePhotosDisplay();
    input.value = '';
}

function uploadPhoto(input) {
    // TODO: реализовать загрузку файла на сервер
    alert('Функция загрузки файлов будет реализована позже');
}

function deletePhoto(index) {
    if (confirm('Удалить фотографию?')) {
        photosData.splice(index, 1);
        updatePhotosDisplay();
    }
}

function updatePhotosDisplay() {
    const gallery = document.getElementById('photosGallery');
    gallery.innerHTML = '';
    
    photosData.forEach((photo, index) => {
        const col = document.createElement('div');
        col.className = 'col-md-4 photo-item';
        col.setAttribute('data-index', index);
        col.innerHTML = `
            <div class="card">
                <img src="${photo}" class="card-img-top" alt="Фото">
                <div class="card-body p-2">
                    <button type="button" class="btn btn-sm btn-danger w-100" 
                            onclick="deletePhoto(${index})">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                </div>
            </div>
        `;
        gallery.appendChild(col);
    });
    
    document.getElementById('photosData').value = JSON.stringify(photosData);
}

// Загрузка профилей организаций
async function loadOrgProfiles() {
    try {
        const response = await fetch('/owner/profile/organization/api/list');
        const data = await response.json();
        
        if (data.success) {
            displayOrgProfiles(data.profiles);
        }
    } catch (error) {
        console.error('Error loading org profiles:', error);
    }
}

function displayOrgProfiles(profiles) {
    const container = document.getElementById('orgProfilesList');
    container.innerHTML = '';
    
    if (!profiles || profiles.length === 0) {
        container.innerHTML = '<p class="text-muted small mb-0">Нет профилей</p>';
        return;
    }
    
    profiles.forEach(profile => {
        const item = document.createElement('div');
        item.className = 'border rounded p-2 mb-2';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${profile.profile_name}</strong>
                    ${profile.is_default ? '<span class="badge bg-primary ms-1">По умолчанию</span>' : ''}
                    <br>
                    <small class="text-muted">${profile.legal_type === 'individual' ? 'ИП' : 'ЮЛ'}</small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="editOrgProfile(${profile.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteOrgProfile(${profile.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Открыть модальное окно профиля организации
async function openOrgProfileModal(profileId = null) {
    const modal = new bootstrap.Modal(document.getElementById('orgProfileModal'));
    
    if (profileId) {
        document.getElementById('orgProfileModalTitle').textContent = 'Редактировать профиль';
        document.getElementById('orgProfileId').value = profileId;
        
        // Загружаем данные профиля
        try {
            const response = await fetch(`/owner/profile/organization/api/${profileId}`);
            const data = await response.json();
            
            if (data.success) {
                const profile = data.profile;
                document.getElementById('orgProfileName').value = profile.profile_name;
                document.getElementById('orgProfileDefault').checked = profile.is_default;
                
                // Устанавливаем тип
                if (profile.legal_type === 'legal') {
                    document.getElementById('legalTypeLegal').checked = true;
                } else {
                    document.getElementById('legalTypeIndividual').checked = true;
                }
                
                updateOrgProfileFields();
                
                // Заполняем реквизиты
                if (profile.requisites) {
                    Object.keys(profile.requisites).forEach(key => {
                        const input = document.querySelector(`#req_${key}`);
                        if (input) {
                            input.value = profile.requisites[key];
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Error loading profile:', error);
        }
    } else {
        document.getElementById('orgProfileModalTitle').textContent = 'Новый профиль';
        document.getElementById('orgProfileForm').reset();
        document.getElementById('orgProfileId').value = '';
        updateOrgProfileFields();
    }
    
    modal.show();
}

function editOrgProfile(profileId) {
    openOrgProfileModal(profileId);
}

async function deleteOrgProfile(profileId) {
    if (!confirm('Удалить профиль организации?')) return;
    
    try {
        const response = await fetch(`/owner/profile/organization/api/${profileId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            await loadOrgProfiles();
        } else {
            alert('Ошибка: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting profile:', error);
        alert('Ошибка удаления профиля');
    }
}

function updateOrgProfileFields() {
    // TODO: динамическое обновление полей реквизитов
    const container = document.getElementById('orgProfileFieldsContainer');
    const legalType = document.querySelector('input[name="legal_type"]:checked').value;
    
    container.innerHTML = '<p class="text-muted">Поля реквизитов будут добавлены...</p>';
}

async function saveOrgProfile() {
    // TODO: реализовать сохранение
    alert('Сохранение профиля будет реализовано');
}

// Загрузка статуса функций
async function loadFeatures() {
    try {
        const response = await fetch('/owner/profile/features/api/status');
        const data = await response.json();
        
        if (data.success) {
            displayFeatures(data.features);
        }
    } catch (error) {
        console.error('Error loading features:', error);
    }
}

function displayFeatures(features) {
    const container = document.getElementById('featuresContainer');
    container.innerHTML = '';
    
    // TODO: отобразить функции с toggle switches
    container.innerHTML = '<p class="text-muted">Функции будут отображены после реализации API...</p>';
}

// Определения полей для реквизитов
const INDIVIDUAL_FIELDS = [
    {key: 'owner_fullname', label: 'ФИО *', type: 'text', required: true},
    {key: 'owner_ogrnip', label: 'ОГРНИП *', type: 'text', required: true, pattern: '^\\d{15}$', hint: '15 цифр'},
    {key: 'owner_inn', label: 'ИНН *', type: 'text', required: true, pattern: '^\\d{12}$', hint: '12 цифр'},
    {key: 'owner_okved', label: 'ОКВЭД', type: 'text'},
    {key: 'owner_phone', label: 'Телефон', type: 'tel'},
    {key: 'owner_email', label: 'E-mail', type: 'email'},
    {key: 'owner_registration_address', label: 'Адрес регистрации', type: 'textarea'},
    {key: 'owner_postal_address', label: 'Почтовый адрес', type: 'textarea'},
    {key: 'owner_account_number', label: 'Расчетный счет', type: 'text', pattern: '^\\d{20}$', hint: '20 цифр'},
    {key: 'owner_bik', label: 'БИК банка', type: 'text', pattern: '^\\d{9}$', hint: '9 цифр'},
    {key: 'owner_correspondent_account', label: 'Корреспондентский счет', type: 'text', pattern: '^\\d{20}$', hint: '20 цифр'}
];

const LEGAL_FIELDS = [
    {key: 'company_full_name', label: 'Наименование организации *', type: 'text', required: true},
    {key: 'company_short_name', label: 'Краткое наименование', type: 'text'},
    {key: 'company_ogrn', label: 'ОГРН *', type: 'text', required: true, pattern: '^\\d{13}$', hint: '13 цифр'},
    {key: 'company_inn', label: 'ИНН *', type: 'text', required: true, pattern: '^\\d{10}$', hint: '10 цифр'},
    {key: 'company_kpp', label: 'КПП *', type: 'text', required: true, pattern: '^\\d{9}$', hint: '9 цифр'},
    {key: 'company_legal_address', label: 'Юридический адрес', type: 'textarea'},
    {key: 'company_postal_address', label: 'Почтовый адрес', type: 'textarea'},
    {key: 'company_okpo', label: 'ОКПО', type: 'text'},
    {key: 'company_okved', label: 'ОКВЭД', type: 'text'},
    {key: 'company_account_number', label: 'Расчетный счет', type: 'text', pattern: '^\\d{20}$', hint: '20 цифр'},
    {key: 'company_bik', label: 'БИК банка', type: 'text', pattern: '^\\d{9}$', hint: '9 цифр'},
    {key: 'company_correspondent_account', label: 'Корреспондентский счет', type: 'text', pattern: '^\\d{20}$', hint: '20 цифр'},
    {key: 'company_director_position', label: 'Должность руководителя', type: 'text'},
    {key: 'company_director_fullname', label: 'ФИО руководителя', type: 'text'},
    {key: 'company_basis', label: 'Действует на основании', type: 'text'}
];

function updateOrgProfileFields() {
    const container = document.getElementById('orgProfileFieldsContainer');
    const legalType = document.querySelector('input[name="legal_type"]:checked').value;
    const fields = legalType === 'individual' ? INDIVIDUAL_FIELDS : LEGAL_FIELDS;
    
    container.innerHTML = '';
    
    fields.forEach(field => {
        const formGroup = document.createElement('div');
        formGroup.className = 'mb-3';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = field.label;
        label.htmlFor = `req_${field.key}`;
        
        let input;
        if (field.type === 'textarea') {
            input = document.createElement('textarea');
            input.rows = 3;
        } else {
            input = document.createElement('input');
            input.type = field.type;
        }
        
        input.className = 'form-control';
        input.id = `req_${field.key}`;
        input.name = field.key;
        input.required = field.required || false;
        
        if (field.pattern) {
            input.pattern = field.pattern;
        }
        
        formGroup.appendChild(label);
        formGroup.appendChild(input);
        
        if (field.hint) {
            const hint = document.createElement('small');
            hint.className = 'form-text text-muted';
            hint.textContent = field.hint;
            formGroup.appendChild(hint);
        }
        
        container.appendChild(formGroup);
    });
}

async function saveOrgProfile() {
    const form = document.getElementById('orgProfileForm');
    const formData = new FormData(form);
    const profileId = document.getElementById('orgProfileId').value;
    
    // Собираем реквизиты
    const requisites = {};
    const legalType = formData.get('legal_type');
    const fields = legalType === 'individual' ? INDIVIDUAL_FIELDS : LEGAL_FIELDS;
    
    fields.forEach(field => {
        const value = formData.get(field.key);
        if (value && value.trim()) {
            requisites[field.key] = value.trim();
        }
    });
    
    const data = {
        profile_name: formData.get('profile_name'),
        legal_type: legalType,
        is_default: formData.get('is_default') === 'on',
        requisites: requisites
    };
    
    try {
        const url = profileId 
            ? `/owner/profile/organization/api/${profileId}/update`
            : '/owner/profile/organization/api/create';
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('orgProfileModal')).hide();
            await loadOrgProfiles();
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        console.error('Error saving profile:', error);
        alert('Ошибка сохранения профиля');
    }
}

// Загрузка и отображение функций
async function loadFeatures() {
    try {
        const response = await fetch('/owner/profile/features/api/status');
        const data = await response.json();
        
        if (data.success) {
            displayFeatures(data.features);
        }
    } catch (error) {
        console.error('Error loading features:', error);
    }
}

function displayFeatures(features) {
    const container = document.getElementById('featuresContainer');
    container.innerHTML = '';
    
    // Группируем функции
    const activeFeatures = features.filter(f => f.available && f.enabled);
    const availableFeatures = features.filter(f => f.available && !f.enabled);
    const unavailableFeatures = features.filter(f => !f.available);
    
    // Активные функции
    if (activeFeatures.length > 0) {
        container.innerHTML += '<h6 class="small text-success mb-2"><i class="fas fa-check-circle"></i> Активные функции</h6>';
        activeFeatures.forEach(feature => renderFeatureItem(container, feature, true));
    }
    
    // Доступные но выключенные
    if (availableFeatures.length > 0) {
        container.innerHTML += '<h6 class="small text-muted mb-2 mt-3"><i class="fas fa-toggle-off"></i> Доступные функции</h6>';
        availableFeatures.forEach(feature => renderFeatureItem(container, feature, true));
    }
    
    // Недоступные в тарифе
    if (unavailableFeatures.length > 0) {
        container.innerHTML += '<h6 class="small text-warning mb-2 mt-3"><i class="fas fa-lock"></i> Требуют обновления тарифа</h6>';
        unavailableFeatures.forEach(feature => renderFeatureItem(container, feature, false));
    }
}

function renderFeatureItem(container, feature, available) {
    const item = document.createElement('div');
    item.className = `feature-item ${!available ? 'disabled' : ''}`;
    
    const html = `
        <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
                <strong>${feature.name}</strong>
                <div class="small text-muted">${feature.description}</div>
            </div>
            <div>
                ${available ? `
                    <div class="form-check form-switch">
                        <input class="form-check-input feature-toggle" type="checkbox" 
                               id="feature_${feature.key}" 
                               ${feature.enabled ? 'checked' : ''}
                               onchange="toggleFeature('${feature.key}', this.checked)">
                    </div>
                ` : `
                    <div>
                        <i class="fas fa-lock text-warning"></i>
                        <a href="/owner/tariff/change" class="btn btn-sm btn-warning ms-2">
                            Сменить тариф
                        </a>
                    </div>
                `}
            </div>
        </div>
    `;
    
    item.innerHTML = html;
    container.appendChild(item);
}

async function toggleFeature(featureKey, enabled) {
    try {
        const response = await fetch('/owner/profile/features/api/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({feature_key: featureKey, enabled: enabled})
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert('Ошибка: ' + (data.error || 'Функция недоступна'));
            // Откатываем toggle
            document.getElementById(`feature_${featureKey}`).checked = !enabled;
        } else {
            // Обновляем меню (перезагрузка страницы для применения изменений)
            setTimeout(() => location.reload(), 500);
        }
    } catch (error) {
        console.error('Error toggling feature:', error);
        alert('Ошибка переключения функции');
        document.getElementById(`feature_${featureKey}`).checked = !enabled;
    }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    initCharCounters();
    initMessengersCheckboxes();
    initPhotos();
    loadOrgProfiles();
    loadFeatures();
    updateMessengersData();
});
</script>
{% endblock %}
                            <div class="tag-category" data-category="{{ category }}">
                                <div class="tag-category-header" onclick="toggleCategory('{{ category }}')">
                                    {% if category == 'system' %}
                                        <i class="fas fa-cog category-icon"></i> Системные теги
                                    {% elif category == 'owner' %}
                                        <i class="fas fa-user category-icon"></i> Данные владельца
                                    {% elif category == 'company' %}
                                        <i class="fas fa-building category-icon"></i> Данные компании
                                    {% elif category == 'employee' %}
                                        <i class="fas fa-users category-icon"></i> Данные сотрудника
                                    {% elif category == 'contract' %}
                                        <i class="fas fa-file-contract category-icon"></i> Договорные данные
                                    {% else %}
                                        <i class="fas fa-tag category-icon"></i> {{ category }}
                                    {% endif %}
                                    <i class="fas fa-chevron-down float-end"></i>
                                </div>
                                <div class="tag-category-body" id="category_{{ category }}">
                                    {% for tag in tags %}
                                    <div class="tag-item" data-tag="{{ tag.key }}">
                                        <div class="d-flex align-items-start">
                                            <input class="form-check-input tag-checkbox" type="checkbox" 
                                                   id="tag_{{ tag.key }}" name="tag_{{ tag.key }}"
                                                   {% if profile and tag.key in profile.active_tags %}checked{% endif %}
                                                   onchange="toggleTagValue('{{ tag.key }}')">
                                            <div class="flex-grow-1">
                                                <label class="tag-label" for="tag_{{ tag.key }}">
                                                    <code>{{ "{{ " + tag.key + " }}" }}</code>
                                                    - {{ tag.label }}
                                                    {% if tag.is_required %}
                                                        <span class="badge bg-danger ms-1">Обязательно</span>
                                                    {% endif %}
                                                </label>
                                                {% if tag.description %}
                                                <div class="tag-description">{{ tag.description }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="tag-value-input{% if profile and tag.key in profile.active_tags %} show{% endif %}" 
                                             id="value_container_{{ tag.key }}">
                                            {% if tag.data_type == 'textarea' %}
                                                <textarea class="form-control" name="value_{{ tag.key }}" 
                                                          placeholder="Введите {{ tag.label.lower() }}" rows="3"
                                                          {% if tag.validation_pattern %}pattern="{{ tag.validation_pattern }}"{% endif %}>{{ profile.get_tag_value(tag.key) if profile else '' }}</textarea>
                                            {% elif tag.data_type == 'select' and tag.options %}
                                                <select class="form-select" name="value_{{ tag.key }}">
                                                    <option value="">Выберите...</option>
                                                    {% for option in tag.options %}
                                                    <option value="{{ option }}" 
                                                            {% if profile and profile.get_tag_value(tag.key) == option %}selected{% endif %}>
                                                        {{ option }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            {% elif tag.data_type == 'date' %}
                                                <input type="date" class="form-control" name="value_{{ tag.key }}" 
                                                       value="{{ profile.get_tag_value(tag.key) if profile else '' }}">
                                            {% elif tag.data_type == 'email' %}
                                                <input type="email" class="form-control" name="value_{{ tag.key }}" 
                                                       placeholder="Введите {{ tag.label.lower() }}"
                                                       value="{{ profile.get_tag_value(tag.key) if profile else '' }}">
                                            {% elif tag.data_type == 'number' %}
                                                <input type="number" class="form-control" name="value_{{ tag.key }}" 
                                                       placeholder="Введите {{ tag.label.lower() }}"
                                                       value="{{ profile.get_tag_value(tag.key) if profile else '' }}">
                                            {% else %}
                                                <input type="text" class="form-control" name="value_{{ tag.key }}" 
                                                       placeholder="Введите {{ tag.label.lower() }}"
                                                       {% if tag.validation_pattern %}pattern="{{ tag.validation_pattern }}"{% endif %}
                                                       value="{{ profile.get_tag_value(tag.key) if profile else '' }}">
                                            {% endif %}
                                            {% if tag.validation_message %}
                                            <div class="form-text text-muted">{{ tag.validation_message }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Модальное окно предпросмотра -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>
                    Предпросмотр профиля
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Данные тегов по категориям
const tagsByCategory = {{ tags_by_category_json | tojson }};

// Переключение видимости категории
function toggleCategory(category) {
    const categoryBody = document.getElementById('category_' + category);
    const chevron = document.querySelector('[onclick="toggleCategory(\'' + category + '\')"] .fa-chevron-down');
    
    if (categoryBody.style.display === 'none') {
        categoryBody.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
    } else {
        categoryBody.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
    }
}

// Переключение поля ввода значения тега
function toggleTagValue(tagKey) {
    const checkbox = document.getElementById('tag_' + tagKey);
    const valueContainer = document.getElementById('value_container_' + tagKey);
    const tagItem = document.querySelector('[data-tag="' + tagKey + '"]');
    
    if (checkbox.checked) {
        valueContainer.classList.add('show');
        tagItem.classList.add('selected');
    } else {
        valueContainer.classList.remove('show');
        tagItem.classList.remove('selected');
        // Очищаем значение
        const input = valueContainer.querySelector('input, select, textarea');
        if (input) input.value = '';
    }
    
    updateCompletionBar();
}

// Обновление доступных тегов в зависимости от типа собственника
function updateAvailableTags() {
    const legalType = document.querySelector('input[name="legal_type"]:checked').value;
    const companyCategory = document.querySelector('[data-category="company"]');
    
    if (legalType === 'individual') {
        // Скрываем категорию компании для ФЛ
        companyCategory.style.display = 'none';
    } else {
        // Показываем категорию компании для ЮЛ
        companyCategory.style.display = 'block';
    }
}

// Обновление индикатора заполненности
function updateCompletionBar() {
    const totalTags = document.querySelectorAll('.tag-checkbox').length;
    const checkedTags = document.querySelectorAll('.tag-checkbox:checked').length;
    const filledTags = document.querySelectorAll('.tag-checkbox:checked').length; // Упрощенно
    
    const percentage = totalTags > 0 ? Math.round((filledTags / totalTags) * 100) : 0;
    
    document.getElementById('completionPercent').textContent = percentage + '%';
    document.querySelector('.completion-fill').style.width = percentage + '%';
}

// Предпросмотр профиля
async function previewProfile() {
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
    
    try {
        const response = await fetch('/owner/profile/preview');
        const data = await response.json();
        
        let html = '<div class="row">';
        
        // Информация о профиле
        html += '<div class="col-md-6">';
        html += '<h6><i class="fas fa-info-circle me-2"></i>Информация о профиле</h6>';
        html += '<table class="table table-sm">';
        html += '<tr><td>Название:</td><td>' + (data.profile?.profile_name || 'Не указано') + '</td></tr>';
        html += '<tr><td>Тип:</td><td>' + (data.profile?.legal_type === 'legal' ? 'Юридическое лицо' : 'Физическое лицо') + '</td></tr>';
        html += '<tr><td>Заполненность:</td><td>' + Math.round(data.completion || 0) + '%</td></tr>';
        html += '<tr><td>Активных тегов:</td><td>' + (data.profile?.active_tags?.length || 0) + '</td></tr>';
        html += '</table>';
        html += '</div>';
        
        // Теги для шаблонов
        html += '<div class="col-md-6">';
        html += '<h6><i class="fas fa-tags me-2"></i>Теги для использования в договорах</h6>';
        html += '<div class="small">';
        
        if (data.tags_for_templates) {
            for (const [key, value] of Object.entries(data.tags_for_templates)) {
                if (value && key !== 'current_date' && key !== 'current_time' && key !== 'current_year') {
                    html += '<div class="mb-1">';
                    html += '<code>{{ ' + key + ' }}</code> → <span class="text-primary">' + value + '</span>';
                    html += '</div>';
                }
            }
        }
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        document.getElementById('previewContent').innerHTML = html;
        
    } catch (error) {
        document.getElementById('previewContent').innerHTML = 
            '<div class="alert alert-danger">Ошибка загрузки предпросмотра: ' + error.message + '</div>';
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    updateAvailableTags();
    updateCompletionBar();
    
    // Добавляем обработчики для обновления заполненности
    document.querySelectorAll('.tag-value-input input, .tag-value-input select, .tag-value-input textarea').forEach(input => {
        input.addEventListener('input', updateCompletionBar);
    });
});
</script>
{% endblock %}
