{% extends "owner/base_owner.html" %}

{% block title %}Профиль владельца{% endblock %}

{% block extra_css %}
<style>
    .tag-category {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .tag-category-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        cursor: pointer;
    }
    
    .tag-category-body {
        padding: 1rem;
    }
    
    .tag-item {
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
        background-color: #fff;
    }
    
    .tag-item.selected {
        border-color: #0d6efd;
        background-color: #e7f3ff;
    }
    
    .tag-checkbox {
        margin-right: 0.5rem;
    }
    
    .tag-label {
        font-weight: 500;
        color: #495057;
    }
    
    .tag-description {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .tag-value-input {
        margin-top: 0.5rem;
        display: none;
    }
    
    .tag-value-input.show {
        display: block;
    }
    
    .profile-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .completion-bar {
        background-color: rgba(255,255,255,0.3);
        border-radius: 1rem;
        height: 0.5rem;
        margin-top: 0.5rem;
        overflow: hidden;
    }
    
    .completion-fill {
        background-color: #fff;
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .legal-type-selector {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .category-icon {
        width: 1.5rem;
        height: 1.5rem;
        margin-right: 0.5rem;
    }
    
    .tag-help-category {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 0.5rem;
    }
    
    .tag-help-header {
        cursor: pointer;
        padding: 0.25rem 0;
    }
    
    .tag-help-header:hover {
        background-color: #f8f9fa;
    }
    
    .tag-help-body {
        margin-top: 0.5rem;
    }
    
    .photo-item img {
        height: 150px;
        object-fit: cover;
    }
    
    .feature-item {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .feature-item.disabled {
        background-color: #f8f9fa;
        opacity: 0.7;
    }
    
    .feature-toggle {
        transform: scale(1.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-user-circle me-2"></i>
                    Профиль владельца
                </h1>
                <div class="text-end">
                    {% if subscription_info %}
                    <div class="badge bg-primary px-3 py-2" style="font-size: 0.95rem;">
                        <i class="bi bi-credit-card me-1"></i>
                        Тариф: <strong>{{ subscription_info.tariff_name }}</strong>
                    </div>
                    {% if subscription_info.expires_at %}
                    <div class="text-muted small mt-1">
                        <i class="bi bi-calendar-check me-1"></i>
                        Действует до: {{ subscription_info.expires_at[:10] }}
                        {% if subscription_info.notes and 'Grace period' in subscription_info.notes %}
                            <span class="badge bg-info ms-1" title="Льготный период">Grace Period</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="badge bg-warning text-dark px-3 py-2" style="font-size: 0.95rem;">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Нет активной подписки
                    </div>
                    <div class="mt-1">
                        <a href="/owner/tariff/change" class="btn btn-sm btn-primary">
                            <i class="bi bi-arrow-up-circle me-1"></i>Выбрать тариф
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if request.query_params.get('success') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        Профиль успешно сохранён!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <form id="profileForm" method="POST" action="/owner/profile/save">
        <div class="row">
            <!-- Левая колонка - настройки профиля -->
            <div class="col-lg-4">
                <!-- Статистика профиля -->
                <div class="profile-stats">
                    <h5 class="mb-1">
                        <i class="fas fa-chart-pie me-2"></i>
                        Заполненность профиля
                    </h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Готовность к использованию</span>
                        <span id="completionPercent">{{ profile.get_completion_percentage() if profile else 0 }}%</span>
                    </div>
                    <div class="completion-bar">
                        <div class="completion-fill" style="width: {{ profile.get_completion_percentage() if profile else 0 }}%"></div>
                    </div>
                </div>

                <!-- Блок "Основные настройки" удален - логика перенесена в профили организаций -->

                <!-- Мои профили -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            Мои профили
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Профили физлиц, ИП и юридических лиц, от имени которых вы можете заключать договоры
                        </p>
                        <div id="orgProfilesList" class="mb-2">
                            <!-- Динамически загружается через JS -->
                        </div>
                        <button type="button" class="btn btn-sm btn-primary w-100" onclick="openOrgProfileModal()">
                            <i class="fas fa-plus me-1"></i> Добавить профиль
                        </button>
                    </div>
                </div>

                <!-- Справка по тегам (компактная) -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Справка по ТЭГам
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Теги для подстановки в договоры
                        </p>
                        
                        {% for category, tags in tags_by_category.items() %}
                        <div class="tag-help-category mb-2">
                            <div class="tag-help-header" onclick="toggleTagHelp('{{ category }}')">
                                <strong class="small">
                                    {% if category == 'system' %}
                                        <i class="fas fa-cog"></i> Системные
                                    {% elif category == 'owner' %}
                                        <i class="fas fa-user"></i> Владелец
                                    {% elif category == 'company' %}
                                        <i class="fas fa-building"></i> Компания
                                    {% elif category == 'organization_requisites' %}
                                        <i class="fas fa-file-invoice"></i> Реквизиты
                                    {% elif category == 'employee' %}
                                        <i class="fas fa-users"></i> Сотрудник
                                    {% else %}
                                        <i class="fas fa-tag"></i> {{ category }}
                                    {% endif %}
                                    <i class="fas fa-chevron-down float-end" id="chevron_{{ category }}"></i>
                                </strong>
                        </div>
                            <div class="tag-help-body small" id="taghelp_{{ category }}" style="display: none; padding-left: 1rem;">
                                {% for tag in tags[:5] %}
                                <div class="mb-1">
                                    <code class="small">{{ "{{ " + tag.key + " }}" }}</code> - {{ tag.label }}
                                </div>
                                {% endfor %}
                                {% if tags|length > 5 %}
                                <div class="text-muted small">...и еще {{ tags|length - 5 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Правая колонка - новые секции -->
            <div class="col-lg-8">
                <!-- О компании -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            О компании
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Напишите, чем занимается компания, как долго существует, сколько у вас сотрудников. 
                            Это повлияет на доверие соискателей.
                        </p>
                        <textarea class="form-control" name="about_company" rows="4" maxlength="2000"
                                  placeholder="Расскажите о вашей компании...">{{ profile.about_company if profile else '' }}</textarea>
                        <div class="form-text">Осталось символов: <span id="aboutCharsLeft">2000</span></div>
                    </div>
                </div>

                <!-- Ценности -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-heart me-2"></i>
                            Ценности компании
                        </h6>
                                </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Можете рассказать про деловую структуру и принципы компании. 
                            Это поможет найти сотрудников-единомышленников.
                        </p>
                        <textarea class="form-control" name="values" rows="4" maxlength="2000"
                                  placeholder="Опишите ценности и принципы вашей компании...">{{ profile.values if profile else '' }}</textarea>
                        <div class="form-text">Осталось символов: <span id="valuesCharsLeft">2000</span></div>
                                            </div>
                                        </div>
                                        
                <!-- Фотографии -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-images me-2"></i>
                            Фотографии
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            Загрузите фотографии вашей компании, офиса или команды (до 5 штук)
                        </p>
                        <div id="photosGallery" class="row g-2 mb-3">
                            {% if profile and profile.photos %}
                                {% for photo in profile.photos %}
                                <div class="col-md-4 photo-item" data-index="{{ loop.index0 }}">
                <div class="card">
                                        <img src="{{ photo }}" class="card-img-top" alt="Фото">
                                        <div class="card-body p-2">
                                            <button type="button" class="btn btn-sm btn-danger w-100" 
                                                    onclick="deletePhoto({{ loop.index0 }})">
                                                <i class="fas fa-trash"></i> Удалить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        {% if not profile or not profile.photos or profile.photos|length < 5 %}
                        <div class="input-group">
                            <input type="text" class="form-control" id="photoUrlInput" 
                                   placeholder="URL фотографии или загрузите файл">
                            <button class="btn btn-outline-secondary" type="button" onclick="addPhotoFromUrl()">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                        <div class="mt-2">
                            <input type="file" class="form-control" id="photoFileInput" accept="image/*" 
                                   onchange="uploadPhoto(this)">
                        </div>
                        {% endif %}
                        <input type="hidden" name="photos" id="photosData" 
                               value="{{ profile.photos | tojson if profile and profile.photos else '[]' }}">
                    </div>
                </div>

                <!-- Для связи -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-phone me-2"></i>
                            Для связи
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="contact_phone" class="form-label">Телефон</label>
                            <input type="tel" class="form-control" id="contact_phone" name="contact_phone"
                                   placeholder="+7 (___) ___-__-__"
                                   data-inputmask="'mask': '+7 (999) 999-99-99'"
                                   value="{{ profile.contact_phone if profile else '' }}">
                            <small class="form-text text-muted">Формат: +7 (XXX) XXX-XX-XX</small>
                        </div>
                        <label class="form-label">Доступен в мессенджерах:</label>
                        <div class="form-check">
                            <input class="form-check-input messenger-check" type="checkbox" 
                                   id="messenger_whatsapp" value="whatsapp"
                                   {% if profile and profile.contact_messengers and 'whatsapp' in profile.contact_messengers %}checked{% endif %}>
                            <label class="form-check-label" for="messenger_whatsapp">
                                <i class="fab fa-whatsapp text-success"></i> WhatsApp
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input messenger-check" type="checkbox" 
                                   id="messenger_telegram" value="telegram"
                                   {% if profile and profile.contact_messengers and 'telegram' in profile.contact_messengers %}checked{% endif %}>
                            <label class="form-check-label" for="messenger_telegram">
                                <i class="fab fa-telegram text-info"></i> Telegram
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input messenger-check" type="checkbox" 
                                   id="messenger_max" value="max"
                                   {% if profile and profile.contact_messengers and 'max' in profile.contact_messengers %}checked{% endif %}>
                            <label class="form-check-label" for="messenger_max">
                                <i class="fas fa-comment text-primary"></i> MAX
                            </label>
                        </div>
                        <input type="hidden" name="contact_messengers" id="contactMessengersData"
                               value="{{ profile.contact_messengers | tojson if profile and profile.contact_messengers else '[]' }}">
                    </div>
                </div>

                <!-- Управление функциями -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-toggle-on me-2"></i>
                            Дополнительные функции
                        </h6>
                    </div>
                    <div class="card-body text-center">
                        <p class="small text-muted mb-3">
                            Управление функциями системы перенесено в отдельный раздел.
                        </p>
                        <a href="/owner/features" class="btn btn-primary btn-sm">
                            <i class="fas fa-toggles me-2"></i>
                            Перейти к настройкам функций
                        </a>
                        <a href="/owner/profile/media-storage" class="btn btn-outline-secondary btn-sm ms-2">
                            <i class="bi bi-cloud-arrow-up me-2"></i>
                            Настройки хранилища
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ========== Старый код для тегов (можно удалить после переделки) ==========
{% if tags_by_category %}
// Данные тегов по категориям (оставляем для обратной совместимости)
const tagsByCategory = {{ tags_by_category_json | tojson }};

// Переключение видимости категории тегов (справка)
function toggleTagHelp(category) {
    const categoryBody = document.getElementById('taghelp_' + category);
    const chevron = document.getElementById('chevron_' + category);
    
    if (categoryBody.style.display === 'none') {
        categoryBody.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
    } else {
        categoryBody.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
    }
}
{% endif %}

// ========== Новый функционал ==========

// Счётчик символов для textarea
function initCharCounters() {
    const aboutTextarea = document.querySelector('textarea[name="about_company"]');
    const valuesTextarea = document.querySelector('textarea[name="values"]');
    
    if (aboutTextarea) {
        aboutTextarea.addEventListener('input', function() {
            const left = 2000 - this.value.length;
            document.getElementById('aboutCharsLeft').textContent = left;
        });
        // Инициализация
        const left = 2000 - aboutTextarea.value.length;
        document.getElementById('aboutCharsLeft').textContent = left;
    }
    
    if (valuesTextarea) {
        valuesTextarea.addEventListener('input', function() {
            const left = 2000 - this.value.length;
            document.getElementById('valuesCharsLeft').textContent = left;
        });
        // Инициализация
        const left = 2000 - valuesTextarea.value.length;
        document.getElementById('valuesCharsLeft').textContent = left;
    }
}

// Управление мессенджерами (разрешено несколько)
function initMessengersCheckboxes() {
    const checkboxes = document.querySelectorAll('.messenger-check');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Разрешаем выбрать любое количество мессенджеров
            updateMessengersData();
        });
    });
}

function updateMessengersData() {
    const checkboxes = document.querySelectorAll('.messenger-check:checked');
    const messengers = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('contactMessengersData').value = JSON.stringify(messengers);
}

// Управление фотографиями
let photosData = [];

function initPhotos() {
    const photosInput = document.getElementById('photosData');
    if (photosInput && photosInput.value) {
        try {
            photosData = JSON.parse(photosInput.value);
        } catch (e) {
            photosData = [];
        }
    }
}

function addPhotoFromUrl() {
    const input = document.getElementById('photoUrlInput');
    const url = input.value.trim();
    
    if (!url) {
        alert('Введите URL фотографии');
        return;
    }
    
    if (photosData.length >= 5) {
        alert('Максимум 5 фотографий');
        return;
    }
    
    photosData.push(url);
    updatePhotosDisplay();
    input.value = '';
}

async function uploadPhoto(input) {
    const file = input.files[0];
    if (!file) {
        return;
    }
    
    // Проверяем размер (максимум 5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('Размер файла не должен превышать 5MB');
        return;
    }
    
    // Проверяем тип файла
    if (!file.type.startsWith('image/')) {
        alert('Выберите изображение');
        return;
    }
    
    if (photosData.length >= 5) {
        alert('Максимум 5 фотографий');
        return;
    }
    
    const formData = new FormData();
    formData.append('photo', file);
    
    try {
        if (window.showGlobalLoader) {
            showGlobalLoader('Загружаем фото профиля...');
        }
        const response = await fetch('/owner/profile/api/photo', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            photosData.push(result.photo_url);
            updatePhotosDisplay();
            input.value = ''; // Очищаем input
            
            // Автоматически сохраняем фото в профиль
            await savePhotosToProfile();
        } else {
            let errorDetail = 'Ошибка при загрузке фото';
            try {
                const error = await response.json();
                errorDetail = error.detail || errorDetail;
            } catch (e) {
                // игнорируем parse error
            }
            alert(errorDetail);
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при загрузке фото');
    } finally {
        if (window.hideGlobalLoader) {
            hideGlobalLoader();
        }
    }
}

function deletePhoto(index) {
    if (confirm('Удалить фотографию?')) {
        photosData.splice(index, 1);
        updatePhotosDisplay();
    }
}

function updatePhotosDisplay() {
    const gallery = document.getElementById('photosGallery');
    gallery.innerHTML = '';
    
    photosData.forEach((photo, index) => {
        const col = document.createElement('div');
        col.className = 'col-md-4 photo-item';
        col.setAttribute('data-index', index);
        col.innerHTML = `
            <div class="card">
                <img src="${photo}" class="card-img-top" alt="Фото">
                <div class="card-body p-2">
                    <button type="button" class="btn btn-sm btn-danger w-100" 
                            onclick="deletePhoto(${index})">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                </div>
            </div>
        `;
        gallery.appendChild(col);
    });
    
    document.getElementById('photosData').value = JSON.stringify(photosData);
}

// Загрузка профилей контрагентов (shared /api/profiles)
async function loadOrgProfiles() {
    try {
        const response = await fetch('/api/profiles/');
        const data = await response.json();
        
        if (data.success) {
            displayOrgProfiles(data.profiles);
        } else {
            console.error('Error loading profiles:', data.error);
        }
    } catch (error) {
        console.error('Error loading profiles:', error);
    }
}

// Временно отключаем загрузку статуса функций на этой странице,
// чтобы не падать на отсутствующем контейнере/API.
function loadFeatures() {
    // no-op
}

function displayOrgProfiles(profiles) {
    const container = document.getElementById('orgProfilesList');
    container.innerHTML = '';
    
    if (!profiles || profiles.length === 0) {
        container.innerHTML = '<p class="text-muted small mb-0">Пока нет ни одного профиля. Нажмите «Добавить профиль», чтобы создать первый.</p>';
        return;
    }
    
    profiles.forEach(profile => {
        const item = document.createElement('div');
        item.className = 'border rounded p-2 mb-2';
        const typeLabel =
            profile.profile_type === 'individual'
                ? 'Физическое лицо'
                : profile.profile_type === 'legal'
                ? 'Юридическое лицо'
                : 'Индивидуальный предприниматель';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${profile.display_name}</strong>
                    ${profile.is_default ? '<span class="badge bg-primary ms-1">По умолчанию</span>' : ''}
                    <br>
                    <small class="text-muted">${typeLabel}</small>
                    ${profile.is_verified ? '<span class="badge bg-success ms-1">KYC</span>' : ''}
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="editOrgProfile(${profile.id}); return false;">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteOrgProfile(${profile.id}); return false;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Открыть мастер-профилей (новый интерфейс)
function openOrgProfileModal(profileId = null) {
    if (profileId) {
        window.location.href = `/owner/profiles?profile_id=${profileId}`;
    } else {
        window.location.href = '/owner/profiles';
    }
}

function editOrgProfile(profileId) {
    openOrgProfileModal(profileId);
    return false; // Предотвращаем default действие
}

async function deleteOrgProfile(profileId) {
    if (!confirm('Удалить профиль?')) return false;
    
    try {
        const response = await fetch(`/api/profiles/${profileId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            await loadOrgProfiles();
        } else {
            alert('Ошибка: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting profile:', error);
        alert('Ошибка удаления профиля');
    }
    return false; // Предотвращаем default действие
}

// Определения полей для реквизитов
const INDIVIDUAL_FIELDS = [
    {key: 'owner_fullname', label: 'ФИО *', type: 'text', required: true},
    {key: 'owner_ogrnip', label: 'ОГРНИП *', type: 'text', required: true, pattern: '^\\d{15}$', hint: '15 цифр'},
    {key: 'owner_inn', label: 'ИНН *', type: 'text', required: true, pattern: '^\\d{12}$', hint: '12 цифр'},
    {key: 'owner_okved', label: 'ОКВЭД', type: 'text'},
    {key: 'owner_phone', label: 'Телефон', type: 'tel'},
    {key: 'owner_email', label: 'E-mail', type: 'email'},
    {key: 'owner_registration_address', label: 'Адрес регистрации', type: 'textarea'},
    {key: 'owner_postal_address', label: 'Почтовый адрес', type: 'textarea'},
    {key: 'owner_account_number', label: 'Расчетный счет', type: 'text', pattern: '^\\d{20}$', hint: '20 цифр'},
    {key: 'owner_bik', label: 'БИК банка', type: 'text', pattern: '^\\d{9}$', hint: '9 цифр'},
    {key: 'owner_correspondent_account', label: 'Корреспондентский счет', type: 'text', pattern: '^\\d{20}$', hint: '20 цифр'}
];

const LEGAL_FIELDS = [
    {key: 'company_full_name', label: 'Наименование организации *', type: 'text', required: true},
    {key: 'company_short_name', label: 'Краткое наименование', type: 'text'},
    {key: 'company_ogrn', label: 'ОГРН *', type: 'text', required: true, pattern: '^\\d{13}$', hint: '13 цифр'},
    {key: 'company_inn', label: 'ИНН *', type: 'text', required: true, pattern: '^\\d{10}$', hint: '10 цифр'},
    {key: 'company_kpp', label: 'КПП *', type: 'text', required: true, pattern: '^\\d{9}$', hint: '9 цифр'},
    {key: 'company_legal_address', label: 'Юридический адрес', type: 'textarea'},
    {key: 'company_postal_address', label: 'Почтовый адрес', type: 'textarea'},
    {key: 'company_okpo', label: 'ОКПО', type: 'text'},
    {key: 'company_okved', label: 'ОКВЭД', type: 'text'},
    {key: 'company_account_number', label: 'Расчетный счет', type: 'text', pattern: '^\\d{20}$', hint: '20 цифр'},
    {key: 'company_bik', label: 'БИК банка', type: 'text', pattern: '^\\d{9}$', hint: '9 цифр'},
    {key: 'company_correspondent_account', label: 'Корреспондентский счет', type: 'text', pattern: '^\\d{20}$', hint: '20 цифр'},
    {key: 'company_director_position', label: 'Должность руководителя', type: 'text'},
    {key: 'company_director_fullname', label: 'ФИО руководителя', type: 'text'},
    {key: 'company_basis', label: 'Действует на основании', type: 'text'}
];

function updateOrgProfileFields() {
    const container = document.getElementById('orgProfileFieldsContainer');
    const legalType = document.querySelector('input[name="legal_type"]:checked').value;
    const fields = legalType === 'individual' ? INDIVIDUAL_FIELDS : LEGAL_FIELDS;
    
    container.innerHTML = '';
    
    fields.forEach(field => {
        const formGroup = document.createElement('div');
        formGroup.className = 'mb-3';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = field.label;
        label.htmlFor = `req_${field.key}`;
        
        let input;
        if (field.type === 'textarea') {
            input = document.createElement('textarea');
            input.rows = 3;
        } else {
            input = document.createElement('input');
            input.type = field.type;
        }
        
        input.className = 'form-control';
        input.id = `req_${field.key}`;
        input.name = field.key;
        input.required = field.required || false;
        
        if (field.pattern) {
            input.pattern = field.pattern;
        }
        
        formGroup.appendChild(label);
        formGroup.appendChild(input);
        
        if (field.hint) {
            const hint = document.createElement('small');
            hint.className = 'form-text text-muted';
            hint.textContent = field.hint;
            formGroup.appendChild(hint);
        }
        
        container.appendChild(formGroup);
    });
}

// Автосохранение профиля (debounce)
let autosaveTimer = null;
function scheduleAutosave(payload) {
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => doAutosave(payload), 600);
}

async function savePhotosToProfile() {
    // Сохраняем массив фото в профиль через autosave
    const payload = { photos: photosData };
    await doAutosave(payload);
}

async function savePhotosToProfile() {
    // Сохраняем массив фото в профиль через autosave
    const payload = { photos: photosData };
    await doAutosave(payload);
}

async function doAutosave(extra) {
    const payload = Object.assign({}, extra);
    try {
        const resp = await fetch('/owner/profile/api/autosave', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!data.success) {
            console.warn('Автосохранение не удалось:', data.error);
        }
    } catch (e) {
        console.warn('Ошибка автосохранения:', e);
    }
}

function initAutosaveBindings() {
    const aboutTextarea = document.querySelector('textarea[name="about_company"]');
    if (aboutTextarea) {
        aboutTextarea.addEventListener('input', () => scheduleAutosave({ about_company: aboutTextarea.value }));
    }
    const valuesTextarea = document.querySelector('textarea[name="values"]');
    if (valuesTextarea) {
        valuesTextarea.addEventListener('input', () => scheduleAutosave({ values: valuesTextarea.value }));
    }
    const phoneInput = document.getElementById('contact_phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', () => scheduleAutosave({ contact_phone: phoneInput.value }));
    }
    const messengerChecks = document.querySelectorAll('.messenger-check');
    messengerChecks.forEach(cb => {
        cb.addEventListener('change', () => {
            updateMessengersData();
            const arr = JSON.parse(document.getElementById('contactMessengersData').value || '[]');
            scheduleAutosave({ contact_messengers: arr });
        });
    });
}

// Встраиваем существующие инициализации
document.addEventListener('DOMContentLoaded', function() {
    initCharCounters();
    initMessengersCheckboxes();
    initPhotos();
    loadOrgProfiles();
    loadFeatures();
    updateMessengersData();
    initPhoneMask();
    initOrgProfileTypeListeners();
    initAutosaveBindings();
});

// Инициализация маски телефона
function initPhoneMask() {
    const phoneInput = document.getElementById('contact_phone');
    if (phoneInput) {
        // Простая маска без библиотеки
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (!value.startsWith('7')) {
                    value = '7' + value;
                }
                let formatted = '+7';
                if (value.length > 1) {
                    formatted += ' (' + value.substring(1, 4);
                }
                if (value.length >= 5) {
                    formatted += ') ' + value.substring(4, 7);
                }
                if (value.length >= 8) {
                    formatted += '-' + value.substring(7, 9);
                }
                if (value.length >= 10) {
                    formatted += '-' + value.substring(9, 11);
                }
                e.target.value = formatted;
            }
        });
    }
}

// Инициализация обработчиков переключателя типа организации в модальном окне
function initOrgProfileTypeListeners() {
    const modal = document.getElementById('orgProfileModal');
    if (modal) {
        const typeRadios = modal.querySelectorAll('input[name="org_legal_type"]');
        typeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Legal type changed to:', this.value);
                updateOrgProfileFields();
    });
});
    }
}
</script>
{% endblock %}
