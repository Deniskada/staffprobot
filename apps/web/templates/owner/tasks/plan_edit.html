{% extends "owner/base_owner.html" %}
{% block title %}Редактировать задачу{% endblock %}
{% block content %}
<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Редактировать задачу</h2>
    <a class="btn btn-outline-secondary" href="/owner/tasks/plan">Назад к списку</a>
  </div>

  <form method="post" action="/owner/tasks/plan/{{ plan.id }}/edit" id="planCreateForm">
    <div class="row g-3">
      <div class="col-12 col-xl-8">
        <div class="card">
          <div class="card-body">
            <div class="mb-3" style="display:none;">
              <label class="form-label">Режим создания</label>
              <div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="creation_mode" id="mode_template" value="template" checked>
                  <label class="form-check-label" for="mode_template">По шаблону</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="creation_mode" id="mode_custom" value="custom">
                  <label class="form-check-label" for="mode_custom">Без шаблона</label>
                </div>
              </div>
            </div>
            {% if template %}
            <div class="alert alert-info">
              <strong>Шаблон:</strong> {{ template.title }} ({{ template.code }})
              {% if template.description %}<br><small>{{ template.description }}</small>{% endif %}
            </div>
            {% endif %}

            <div class="mb-3" id="template_select_group">
              <label for="template_id" class="form-label">Шаблон задачи</label>
              <select class="form-select" id="template_id" name="template_id">
                <option value="">Выберите шаблон</option>
                {% for t in templates_list %}
                  <option value="{{ t.id }}"
                          data-title="{{ t.title }}"
                          data-description="{{ t.description or '' }}"
                          data-mandatory="{{ t.is_mandatory }}"
                          data-media="{{ t.requires_media }}"
                          data-amount="{{ t.default_bonus_amount or '' }}"
                          data-code="{{ t.code }}">
                    {{ t.title }} ({{ t.code }})
                  </option>
                {% endfor %}
              </select>
            </div>

            {# Поля задачи скрыты в режиме редактирования - они берутся из шаблона #}
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-4">
        <div class="card">
          <div class="card-body">
            <div class="mb-3">
              <label for="object_ids" class="form-label">Объекты</label>
              <select class="form-select" id="object_ids" name="object_ids" multiple>
                {% for obj in objects_list %}
                  <option value="{{ obj.id }}" {% if plan.object_ids and obj.id in plan.object_ids %}selected{% elif plan.object_id == obj.id %}selected{% endif %}>{{ obj.name }}</option>
                {% endfor %}
              </select>
              <small class="text-muted">Не выбрано = все объекты. Ctrl+Click для множественного выбора.</small>
            </div>

            <div class="mb-3">
              <label for="planned_date" class="form-label" id="planned_date_label">Дата (опционально)</label>
              <input type="date" class="form-control" id="planned_date" name="planned_date" value="{{ planned_date_str or '' }}">
              <small class="text-muted" id="planned_date_hint">Оставьте пустым для постоянного назначения</small>
            </div>
            <div class="mb-3">
              <label for="planned_time_start" class="form-label">Дедлайн выполнения (опционально)</label>
              <input type="time" class="form-control" id="planned_time_start" name="planned_time_start" value="{{ planned_time_str or '' }}">
              <small class="text-muted">Время, не позже которого задача должна быть выполнена. Будет показано сотруднику в боте. Если не указано, дедлайн не установлен.</small>
            </div>

            <div class="mb-2">
              <label class="form-label">Периодичность</label>
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="recurrence_type" id="recur_none" value="" {% if not plan.recurrence_type %}checked{% endif %}>
                  <label class="form-check-label" for="recur_none" id="recur_none_label">Повторять каждый день</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="recurrence_type" id="recur_weekdays" value="weekdays" {% if plan.recurrence_type == 'weekdays' %}checked{% endif %}>
                  <label class="form-check-label" for="recur_weekdays">По дням недели</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="recurrence_type" id="recur_interval" value="day_interval" {% if plan.recurrence_type == 'day_interval' %}checked{% endif %}>
                  <label class="form-check-label" for="recur_interval">Интервал дней</label>
                </div>
              </div>
            </div>

            <div class="mb-3" id="weekdays_group" style="display:{% if plan.recurrence_type == 'weekdays' %}block{% else %}none{% endif %};">
              <label class="form-label">Выберите дни недели</label>
              <div class="d-flex gap-2 flex-wrap">
                {% for d, n in {1:'Пн',2:'Вт',3:'Ср',4:'Чт',5:'Пт',6:'Сб',7:'Вс'}.items() %}
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="weekday" value="{{ d }}" id="wd_{{ d }}" {% if plan.recurrence_config and plan.recurrence_config.get('weekdays') and d in plan.recurrence_config.get('weekdays') %}checked{% endif %}>
                    <label class="form-check-label" for="wd_{{ d }}">{{ n }}</label>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="mb-3" id="interval_group" style="display:none;">
              <label for="day_interval" class="form-label">Частота повторения (дни)</label>
              <input type="number" class="form-control" id="day_interval" name="day_interval" min="1" value="{% if plan.recurrence_config and plan.recurrence_config.get('interval') %}{{ plan.recurrence_config.get('interval') }}{% endif %}">
              <small class="text-muted">Задача будет повторяться каждые N дней</small>
            </div>

            <div class="mb-3" id="end_date_group" style="display:none;">
              <label for="recurrence_end_date" class="form-label">Дата окончания повторений (опционально)</label>
              <input type="date" class="form-control" id="recurrence_end_date" name="recurrence_end_date" value="{{ recurrence_end_date_str or '' }}">
              <small class="text-muted">Оставьте пустым для бесконечного повторения (пока план активен)</small>
            </div>

            <div class="mb-2">
              <small id="recurrence_preview" class="text-muted"></small>
            </div>

            <div class="d-flex gap-2">
              <a class="btn btn-outline-secondary" href="/owner/tasks/plan">Отмена</a>
              <button type="submit" class="btn btn-primary">Сохранить изменения</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="/static/js/tasks/plan_form.js"></script>
{% endblock %}


