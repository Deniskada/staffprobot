{% extends "owner/base_owner.html" %}
{% block title %}Назначить задачу{% endblock %}
{% block content %}
<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Назначить задачу</h2>
    <a class="btn btn-outline-secondary" href="/owner/tasks/plan">Назад к списку</a>
  </div>

  <form method="post" action="/owner/tasks/plan/create" id="planCreateForm">
    <div class="row g-3">
      <div class="col-12 col-xl-8">
        <div class="card">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Режим создания</label>
              <div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="creation_mode" id="mode_template" value="template" checked>
                  <label class="form-check-label" for="mode_template">По шаблону</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="creation_mode" id="mode_custom" value="custom">
                  <label class="form-check-label" for="mode_custom">Без шаблона</label>
                </div>
              </div>
            </div>

            <div class="mb-3" id="template_select_group">
              <label for="template_id" class="form-label">Шаблон задачи</label>
              <select class="form-select" id="template_id" name="template_id">
                <option value="">Выберите шаблон</option>
                {% for t in templates_list %}
                  <option value="{{ t.id }}"
                          data-title="{{ t.title }}"
                          data-description="{{ t.description or '' }}"
                          data-mandatory="{{ t.is_mandatory }}"
                          data-media="{{ t.requires_media }}"
                          data-amount="{{ t.default_bonus_amount or '' }}"
                          data-code="{{ t.code }}">
                    {{ t.title }} ({{ t.code }})
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label for="task_title" class="form-label">Название задачи</label>
              <input type="text" class="form-control" id="task_title" name="task_title">
            </div>
            <div class="mb-3">
              <label for="task_description" class="form-label">Описание</label>
              <textarea class="form-control" id="task_description" name="task_description" rows="2"></textarea>
            </div>
            <div class="row">
              <div class="col-md-4">
                <div class="form-check mb-3">
                  <input type="checkbox" class="form-check-input" id="task_mandatory" name="task_mandatory" value="1">
                  <label class="form-check-label" for="task_mandatory">Обязательная задача</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check mb-3">
                  <input type="checkbox" class="form-check-input" id="task_media" name="task_media" value="1">
                  <label class="form-check-label" for="task_media">Фотоотчёт</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="task_amount" class="form-label">Премия/Штраф (₽)</label>
                  <input type="number" step="0.01" class="form-control" id="task_amount" name="task_amount">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="task_code" class="form-label">Код</label>
              <input type="text" class="form-control" id="task_code" name="task_code" readonly>
              <small class="text-muted">Генерируется автоматически</small>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-4">
        <div class="card">
          <div class="card-body">
            <div class="mb-3">
              <label for="object_ids" class="form-label">Объекты</label>
              <select class="form-select" id="object_ids" name="object_ids" multiple>
                {% for obj in objects_list %}
                  <option value="{{ obj.id }}">{{ obj.name }}</option>
                {% endfor %}
              </select>
              <small class="text-muted">Не выбрано = все объекты. Ctrl+Click для множественного выбора.</small>
            </div>

            <div class="mb-3">
              <label for="planned_date" class="form-label" id="planned_date_label">Дата (опционально)</label>
              <input type="date" class="form-control" id="planned_date" name="planned_date">
              <small class="text-muted" id="planned_date_hint">Оставьте пустым для постоянного назначения</small>
            </div>
            <div class="mb-3">
              <label for="planned_time_start" class="form-label">Время начала (опционально)</label>
              <input type="time" class="form-control" id="planned_time_start" name="planned_time_start">
              <small class="text-muted">Оставьте пустым для назначения на каждую смену объекта. Если укажете время, задача будет назначена на тайм-слоты с этим временем.</small>
            </div>

            <div class="mb-2">
              <label class="form-label">Периодичность</label>
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="recurrence_type" id="recur_none" value="" checked>
                  <label class="form-check-label" for="recur_none" id="recur_none_label">Повторять каждый день</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="recurrence_type" id="recur_weekdays" value="weekdays">
                  <label class="form-check-label" for="recur_weekdays">По дням недели</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="recurrence_type" id="recur_interval" value="day_interval">
                  <label class="form-check-label" for="recur_interval">Интервал дней</label>
                </div>
              </div>
            </div>

            <div class="mb-3" id="weekdays_group" style="display:none;">
              <label class="form-label">Выберите дни недели</label>
              <div class="d-flex gap-2 flex-wrap">
                {% for d, n in {1:'Пн',2:'Вт',3:'Ср',4:'Чт',5:'Пт',6:'Сб',7:'Вс'}.items() %}
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="weekday" value="{{ d }}" id="wd_{{ d }}">
                    <label class="form-check-label" for="wd_{{ d }}">{{ n }}</label>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="mb-3" id="interval_group" style="display:none;">
              <label for="day_interval" class="form-label">Частота повторения (дни)</label>
              <input type="number" class="form-control" id="day_interval" name="day_interval" min="1">
              <small class="text-muted">Задача будет повторяться каждые N дней</small>
            </div>

            <div class="mb-3" id="end_date_group" style="display:none;">
              <label for="recurrence_end_date" class="form-label">Дата окончания повторений (опционально)</label>
              <input type="date" class="form-control" id="recurrence_end_date" name="recurrence_end_date">
              <small class="text-muted">Оставьте пустым для бесконечного повторения (пока план активен)</small>
            </div>

            <div class="mb-2">
              <small id="recurrence_preview" class="text-muted"></small>
            </div>

            <div class="d-flex gap-2">
              <a class="btn btn-outline-secondary" href="/owner/tasks/plan">Отмена</a>
              <button type="submit" class="btn btn-primary">Назначить</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="/static/js/tasks/plan_form.js"></script>
{% endblock %}


