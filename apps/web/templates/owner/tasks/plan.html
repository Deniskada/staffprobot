{% extends "owner/base_owner.html" %}
{% block title %}Планирование задач{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between mb-3">
    <h2>Планирование задач</h2>
    <a class="btn btn-primary" href="/owner/tasks/plan/create">
      <i class="fas fa-plus"></i> Назначить задачу
    </a>
  </div>
  
  <table class="table table-sm table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Шаблон</th>
        <th>Объект</th>
        <th>Дата/Периодичность</th>
        <th>Время</th>
        <th>Активен</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% for p in plans %}
      <tr class="{{ 'text-muted' if not p.is_active else '' }}">
        <td>{{ p.id }}</td>
        <td>{{ p.template.title if p.template else p.template_id }}</td>
        <td>
          {% if p.object_ids %}
            {% if p.object_ids|length == 1 %}
              {% set obj = objects_list | selectattr('id', 'equalto', p.object_ids[0]) | first %}
              {{ obj.name if obj else '#' + p.object_ids[0]|string }}
            {% else %}
              {% set first_obj = objects_list | selectattr('id', 'equalto', p.object_ids[0]) | first %}
              {{ first_obj.name if first_obj else '#' + p.object_ids[0]|string }} <small class="text-muted">и еще {{ p.object_ids|length - 1 }}</small>
            {% endif %}
          {% elif p.object %}
            {{ p.object.name }}
          {% else %}
            Все
          {% endif %}
        </td>
        <td>
          {% if p.planned_date %}
            {{ p.planned_date.strftime('%d.%m.%Y') }}
          {% elif p.recurrence_type == 'weekdays' and p.recurrence_config %}
            {% set weekday_names = {1: 'Пн', 2: 'Вт', 3: 'Ср', 4: 'Чт', 5: 'Пт', 6: 'Сб', 7: 'Вс'} %}
            Дни: {% for day in p.recurrence_config.weekdays %}{{ weekday_names[day] }}{% if not loop.last %}, {% endif %}{% endfor %}
          {% elif p.recurrence_type == 'day_interval' and p.recurrence_config %}
            Интервал: каждые {{ p.recurrence_config.interval }} дн.
          {% else %}
            Постоянно
          {% endif %}
          {% if p.recurrence_end_date %}<br><small class="text-muted">до {{ p.recurrence_end_date.strftime('%d.%m.%Y') }}</small>{% endif %}
        </td>
        <td>{{ p.planned_time_start.strftime('%H:%M') if p.planned_time_start else '—' }}</td>
        <td>
          {% if p.is_active %}
            <span class="badge bg-success">Активен</span>
          {% else %}
            <span class="badge bg-secondary">Неактивен</span>
          {% endif %}
        </td>
        <td>
          <a class="btn btn-sm btn-primary" href="/owner/tasks/plan/{{ p.id }}/edit" title="Редактировать">
            <i class="fas fa-edit"></i>
          </a>
          <form method="post" action="/owner/tasks/plan/{{ p.id }}/toggle" class="d-inline">
            <button type="submit" class="btn btn-sm {{ 'btn-warning' if p.is_active else 'btn-success' }}" title="{{ 'Выключить' if p.is_active else 'Включить' }}">
              <i class="fas fa-{{ 'pause' if p.is_active else 'play' }}"></i>
            </button>
          </form>
          <form method="post" action="/owner/tasks/plan/{{ p.id }}/delete" class="d-inline" onsubmit="return confirm('Удалить план?')">
            <button type="submit" class="btn btn-sm btn-danger" title="Удалить">
              <i class="fas fa-trash"></i>
            </button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="7" class="text-center text-muted">Планы не найдены. Назначьте шаблон на объект/дату.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<!-- Полноэкранное создание и редактирование вынесено на отдельные страницы /owner/tasks/plan/create и /owner/tasks/plan/{id}/edit -->

<script>
function toggleCreationMode() {
  const mode = document.querySelector('input[name="creation_mode"]:checked').value;
  const templateGroup = document.getElementById('template_select_group');
  const templateSelect = document.getElementById('template_id');
  const titleField = document.getElementById('task_title');
  const descField = document.getElementById('task_description');
  const mandatoryField = document.getElementById('task_mandatory');
  const mediaField = document.getElementById('task_media');
  const amountField = document.getElementById('task_amount');
  const codeField = document.getElementById('task_code');
  
  if (mode === 'template') {
    // Режим "по шаблону": показываем выбор шаблона, поля неактивны и серые
    templateGroup.style.display = 'block';
    templateSelect.required = true;
    [titleField, descField, amountField].forEach(f => {
      f.disabled = true;
      f.style.backgroundColor = '#e9ecef';
    });
    [mandatoryField, mediaField].forEach(f => {
      f.disabled = true;
      f.parentElement.style.opacity = '0.6';
    });
    codeField.disabled = true;
    codeField.style.backgroundColor = '#e9ecef';
    fillFromTemplate(); // Заполним поля из текущего выбранного шаблона
  } else {
    // Режим "без шаблона": скрываем выбор, поля активны
    templateGroup.style.display = 'none';
    templateSelect.required = false;
    templateSelect.value = '';
    [titleField, descField, amountField].forEach(f => {
      f.disabled = false;
      f.style.backgroundColor = '';
      f.value = '';
    });
    [mandatoryField, mediaField].forEach(f => {
      f.disabled = false;
      f.checked = false;
      f.parentElement.style.opacity = '1';
    });
    codeField.disabled = true; // Код всегда readonly
    codeField.style.backgroundColor = '#e9ecef';
    codeField.value = '[авто]';
  }
}

function fillFromTemplate() {
  const templateSelect = document.getElementById('template_id');
  const option = templateSelect.options[templateSelect.selectedIndex];
  
  if (!option || !option.value) {
    // Не выбран шаблон
    document.getElementById('task_title').value = '';
    document.getElementById('task_description').value = '';
    document.getElementById('task_mandatory').checked = false;
    document.getElementById('task_media').checked = false;
    document.getElementById('task_amount').value = '';
    document.getElementById('task_code').value = '';
    return;
  }
  
  // Заполняем поля из data-атрибутов
  document.getElementById('task_title').value = option.dataset.title || '';
  document.getElementById('task_description').value = option.dataset.description || '';
  document.getElementById('task_mandatory').checked = option.dataset.mandatory === 'True';
  document.getElementById('task_media').checked = option.dataset.media === 'True';
  document.getElementById('task_amount').value = option.dataset.amount || '';
  document.getElementById('task_code').value = option.dataset.code || '';
}

function toggleRecurrence() {
  const recurrenceType = document.querySelector('input[name="recurrence_type"]:checked').value;
  const weekdaysGroup = document.getElementById('weekdays_group');
  const intervalGroup = document.getElementById('interval_group');
  const endDateGroup = document.getElementById('end_date_group');
  
  weekdaysGroup.style.display = 'none';
  intervalGroup.style.display = 'none';
  endDateGroup.style.display = 'none';
  
  if (recurrenceType === 'weekdays') {
    weekdaysGroup.style.display = 'block';
    endDateGroup.style.display = 'block';
  } else if (recurrenceType === 'day_interval') {
    intervalGroup.style.display = 'block';
    endDateGroup.style.display = 'block';
  }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
  toggleCreationMode();
  toggleRecurrence();
});
</script>

<!-- Модалы редактирования для каждого плана -->
{% for p in plans %}
{% endfor %}

{% endblock %}

