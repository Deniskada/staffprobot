{% extends "owner/base_owner.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-plus-circle"></i> {{ title }}
                    </h1>
                    <p class="text-muted mb-0">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞</p>
                </div>
                <div>
                    <a href="/owner/timeslots/object/{{ object_id }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Ç–∞–π–º-—Å–ª–æ—Ç–∞–º
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞–π–º-—Å–ª–æ—Ç–µ
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/owner/timeslots/object/{{ object_id }}/create" id="createForm">
                        <input type="hidden" name="creation_mode" id="creation_mode" value="single">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-calendar-event"></i> –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è
                                </label>
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary active" id="btn-single">
                                        –û–¥–∏–Ω –¥–µ–Ω—å
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="btn-series">
                                        –°–µ—Ä–∏—è —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤
                                    </button>
                                </div>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤</div>
                            </div>
                        </div>

                        <div id="mode-single-fields">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="slot_date" class="form-label">
                                        <i class="bi bi-calendar-event"></i> –î–∞—Ç–∞ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ *
                                    </label>
                                    <input type="date"
                                           class="form-control"
                                           id="slot_date"
                                           name="slot_date"
                                           required>
                                    <div class="form-text">–î–∞—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                                </div>
                            </div>
                        </div>

                        <div id="mode-series-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="series_start_date" class="form-label">
                                        <i class="bi bi-calendar-event"></i> –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–µ—Ä–∏–∏ *
                                    </label>
                                    <input type="date"
                                           class="form-control"
                                           id="series_start_date"
                                           name="series_start_date">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="series_end_date" class="form-label">
                                        <i class="bi bi-calendar-event"></i> –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ—Ä–∏–∏ *
                                    </label>
                                    <input type="date"
                                           class="form-control"
                                           id="series_end_date"
                                           name="series_end_date">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-calendar-week"></i> –î–Ω–∏ –Ω–µ–¥–µ–ª–∏</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="weekdays" value="0" id="wd0">
                                        <label class="form-check-label" for="wd0">–ü–Ω</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="weekdays" value="1" id="wd1">
                                        <label class="form-check-label" for="wd1">–í—Ç</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="weekdays" value="2" id="wd2">
                                        <label class="form-check-label" for="wd2">–°—Ä</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="weekdays" value="3" id="wd3">
                                        <label class="form-check-label" for="wd3">–ß—Ç</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="weekdays" value="4" id="wd4">
                                        <label class="form-check-label" for="wd4">–ü—Ç</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="weekdays" value="5" id="wd5">
                                        <label class="form-check-label" for="wd5">–°–±</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="weekdays" value="6" id="wd6">
                                        <label class="form-check-label" for="wd6">–í—Å</label>
                                    </div>
                                </div>
                                <div class="form-text">–ï—Å–ª–∏ –¥–Ω–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="hourly_rate" class="form-label">
                                    <i class="bi bi-currency-dollar"></i> –°—Ç–∞–≤–∫–∞ –∑–∞ —á–∞—Å *
                                </label>
                                <div class="input-group">
                                    <input type="number"
                                           class="form-control"
                                           id="hourly_rate"
                                           name="hourly_rate"
                                           min="0"
                                           step="0.01"
                                           required
                                           value="{{ object.hourly_rate if object.hourly_rate is defined else '' }}">
                                    <span class="input-group-text">‚ÇΩ/—á–∞—Å</span>
                                </div>
                                <div class="form-text">–ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–º —Å–ª–æ—Ç–∞–º</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="max_employees" class="form-label">
                                    <i class="bi bi-people"></i> –õ–∏–º–∏—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ *
                                </label>
                                <input type="number"
                                       class="form-control"
                                       id="max_employees"
                                       name="max_employees"
                                       min="1"
                                       step="1"
                                       value="1"
                                       required>
                                <div class="form-text">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ—Ç–µ</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-clock-history"></i> –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏ *</label>
                            <div id="intervals-container" class="d-grid gap-2">
                                <div class="row g-2 interval-row">
                                    <div class="col-md-5">
                                        <input type="time" class="form-control interval-start" name="interval_start" required inputmode="numeric" pattern="[0-9]{2}:[0-9]{2}">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="time" class="form-control interval-end" name="interval_end" required inputmode="numeric" pattern="[0-9]{2}:[0-9]{2}">
                                    </div>
                                    <div class="col-md-2 d-grid">
                                        <button type="button" class="btn btn-outline-danger btn-remove-interval" disabled>
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-primary" id="btn-add-interval">
                                    <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª
                                </button>
                            </div>
                            <div class="form-text">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å</div>
                        </div>

                        <hr class="my-4">
                        
                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–æ–∑–¥–∞–Ω–∏–π –∏ –∑–∞–¥–∞—á -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="penalize_late_start" 
                                           id="penalize_late_start" checked>
                                    <label class="form-check-label" for="penalize_late_start">
                                        <i class="bi bi-exclamation-triangle text-warning"></i> –®—Ç—Ä–∞—Ñ–æ–≤–∞—Ç—å –∑–∞ –æ–ø–æ–∑–¥–∞–Ω–∏–µ
                                    </label>
                                    <div class="form-text">–ü—Ä–∏–º–µ–Ω—è—Ç—å —à—Ç—Ä–∞—Ñ –∑–∞ –æ–ø–æ–∑–¥–∞–Ω–∏–µ –Ω–∞ –Ω–∞—á–∞–ª–æ —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="ignore_object_tasks" 
                                           id="ignore_object_tasks">
                                    <label class="form-check-label" for="ignore_object_tasks">
                                        <i class="bi bi-x-circle text-danger"></i> –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞
                                    </label>
                                    <div class="form-text">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ó–∞–¥–∞—á–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tasks"></i> –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–º–µ–Ω—É
                                        <i class="fas fa-info-circle text-muted" 
                                           data-bs-toggle="tooltip" 
                                           title="–ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ –≤—Å–µ–º —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–º —Ç–∞–π–º-—Å–ª–æ—Ç–∞–º"></i>
                                    </label>
                                    <div id="tasks-container">
                                        <!-- –ü—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–¥–∞—á -->
                                    </div>
                                    <button type="button" 
                                            class="btn btn-outline-primary btn-sm mt-2" 
                                            onclick="addTask()">
                                        <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
                                    </button>
                                    <div class="form-text">–≠—Ç–∏ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ –≤—Å–µ–º —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–º —Ç–∞–π–º-—Å–ª–æ—Ç–∞–º</div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row">
                            <div class="col-12">
                                <div class="form-check mb-3">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="is_active"
                                           name="is_active"
                                           checked>
                                    <label class="form-check-label" for="is_active">
                                        <i class="bi bi-check-circle"></i> –ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º-—Å–ª–æ—Ç
                                    </label>
                                    <div class="form-text">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º-—Å–ª–æ—Ç—ã –Ω–µ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                                </div>

                                <div class="d-flex justify-content-between flex-wrap gap-2">
                                    <a href="/owner/timeslots/object/{{ object_id }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> –û—Ç–º–µ–Ω–∞
                                    </a>
                                    <div class="text-muted small align-self-center" id="estimate"></div>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="bi bi-check-circle"></i> –°–æ–∑–¥–∞—Ç—å —Ç–∞–π–º-—Å–ª–æ—Ç—ã
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building"></i> –í—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–æ–≤
                    </h5>
                </div>
                <div class="card-body" style="max-height: 320px; overflow: auto;">
                    <!-- –§–æ–ª–±–µ–∫: —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞—ë–º -->
                    <input type="hidden" name="selected_objects" value="{{ object_id }}">
                    {% if all_objects and all_objects|length > 0 %}
                    <div class="d-grid gap-2">
                        {% for o in all_objects %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="{{ o.id }}" id="obj{{ o.id }}" name="selected_objects" {% if o.id == object_id %}checked{% endif %}>
                            <label class="form-check-label" for="obj{{ o.id }}">
                                {{ o.name }}{% if o.address %}, {{ o.address }}{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                        <div class="text-muted">–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç</div>
                    {% endif %}
                    <div class="mt-2 small text-muted">
                        –¢–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ
                    </h5>
                </div>
                <div class="card-body">
                    <h6>{{ object.name }}</h6>
                    <p class="text-muted small mb-2">{{ object.address }}</p>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-primary">{{ object.hourly_rate }} ‚ÇΩ</div>
                                <small class="text-muted">–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-success">{{ object.opening_time }}</div>
                                <small class="text-muted">–û—Ç–∫—Ä—ã—Ç–∏–µ</small>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center mt-2">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-danger">{{ object.closing_time }}</div>
                                <small class="text-muted">–ó–∞–∫—Ä—ã—Ç–∏–µ</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-info">{{ object.max_distance }}–º</div>
                                <small class="text-muted">–ú–∞–∫—Å. —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightbulb"></i> –°–æ–≤–µ—Ç—ã
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0 small">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–±–æ—Ç—ã –æ–±—ä–µ–∫—Ç–∞
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            –°—Ç–∞–≤–∫–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –±–∞–∑–æ–≤–æ–π
                        </li>
                        <li class="mb-0">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è —Å–ª–æ—Ç—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const modeSingleBtn = document.getElementById('btn-single');
const modeSeriesBtn = document.getElementById('btn-series');
const creationModeInput = document.getElementById('creation_mode');
const singleFields = document.getElementById('mode-single-fields');
const seriesFields = document.getElementById('mode-series-fields');

const slotDateInput = document.getElementById('slot_date');
const hourlyRateInput = document.getElementById('hourly_rate');
const maxEmployeesInput = document.getElementById('max_employees');
const seriesStartInput = document.getElementById('series_start_date');
const seriesEndInput = document.getElementById('series_end_date');
const intervalsContainer = document.getElementById('intervals-container');
const addIntervalBtn = document.getElementById('btn-add-interval');
const submitBtn = document.getElementById('submitBtn');
const estimateEl = document.getElementById('estimate');

function setMode(newMode) {
    creationModeInput.value = newMode;
    const isSeries = newMode === 'series';

    singleFields.style.display = isSeries ? 'none' : 'block';
    seriesFields.style.display = isSeries ? 'block' : 'none';

    slotDateInput.required = !isSeries;
    seriesStartInput.required = isSeries;
    seriesEndInput.required = isSeries;

    modeSingleBtn.classList.toggle('active', !isSeries);
    modeSeriesBtn.classList.toggle('active', isSeries);
    // –£—Å—Ç–∞–Ω–æ–≤–∏–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å–µ—Ä–∏–∏, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –º–æ–≥–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å—Å—è
    if (isSeries) {
        const today = new Date().toISOString().split('T')[0];
        if (!seriesStartInput.value) seriesStartInput.value = today;
        if (!seriesEndInput.value) seriesEndInput.value = today;
    }
    updateEstimate();
}

modeSingleBtn.addEventListener('click', () => setMode('single'));
modeSeriesBtn.addEventListener('click', () => setMode('series'));

function addIntervalRow() {
    const row = document.createElement('div');
    row.className = 'row g-2 interval-row';
    row.innerHTML = `
        <div class="col-md-5">
            <input type="time" class="form-control interval-start" name="interval_start" required>
        </div>
        <div class="col-md-5">
            <input type="time" class="form-control interval-end" name="interval_end" required>
        </div>
        <div class="col-md-2 d-grid">
            <button type="button" class="btn btn-outline-danger btn-remove-interval">
                <i class="bi bi-trash"></i>
            </button>
        </div>`;
    intervalsContainer.appendChild(row);
    bindRow(row);
    refreshRemoveButtons();
    updateEstimate();
}

function bindRow(row) {
    const start = row.querySelector('.interval-start');
    const end = row.querySelector('.interval-end');
    const remove = row.querySelector('.btn-remove-interval');
    start.addEventListener('change', validateIntervals);
    end.addEventListener('change', validateIntervals);
    if (remove) remove.addEventListener('click', () => { row.remove(); refreshRemoveButtons(); updateEstimate(); });
}

function refreshRemoveButtons() {
    const rows = intervalsContainer.querySelectorAll('.interval-row');
    rows.forEach((r, idx) => {
        const btn = r.querySelector('.btn-remove-interval');
        if (btn) btn.disabled = rows.length === 1;
    });
}

function getSelectedObjectsCount() {
    const checked = document.querySelectorAll('input[name="selected_objects"]:checked').length;
    if (checked > 0) return checked;
    // –§–æ–ª–±–µ–∫: –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–π selected_objects (—Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç), —Å—á–∏—Ç–∞–µ–º 1
    const hiddenInput = document.querySelector('input[name="selected_objects"][type="hidden"]');
    return hiddenInput ? 1 : 0;
}

function enumerateDates(start, end, weekdays) {
    const res = [];
    const cur = new Date(start);
    const last = new Date(end);
    while (cur <= last) {
        if (!weekdays || weekdays.length === 0 || weekdays.includes(cur.getDay() === 0 ? 6 : cur.getDay() - 1)) {
            res.push(new Date(cur));
        }
        cur.setDate(cur.getDate() + 1);
    }
    return res;
}

function getIntervalsCount() {
    return intervalsContainer.querySelectorAll('.interval-row').length;
}

function updateEstimate() {
    const objects = getSelectedObjectsCount();
    const intervals = getIntervalsCount();
    let days = 1;
    if (creationModeInput.value === 'series') {
        const sd = seriesStartInput.value;
        const ed = seriesEndInput.value;
        if (sd && ed && sd <= ed) {
            const weekdays = Array.from(document.querySelectorAll('input[name="weekdays"]:checked')).map(i => parseInt(i.value));
            days = enumerateDates(sd, ed, weekdays).length;
        } else { days = 0; }
    } else {
        days = slotDateInput.value ? 1 : 0;
    }
    const total = objects * intervals * days;
    estimateEl.textContent = total ? `–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ ~ ${total} —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤` : '';
    submitBtn.disabled = total === 0 || total > 1000;
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ ‚Äî —è–≤–Ω–æ –¥–∏–∑–µ–π–±–ª–∏–º
    if (intervals === 0) submitBtn.disabled = true;
    // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
    if (objects > 0 && intervals > 0 && days > 0 && total <= 1000) submitBtn.disabled = false;
    if (total > 1000) {
        estimateEl.textContent += ' (–ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç 1000)';
    }
}

function validateIntervals() {
    const rows = intervalsContainer.querySelectorAll('.interval-row');
    for (const r of rows) {
        const s = r.querySelector('.interval-start').value;
        const e = r.querySelector('.interval-end').value;
        if (s && e && s >= e) {
            submitBtn.disabled = true;
            return;
        }
    }
    updateEstimate();
}

addIntervalBtn.addEventListener('click', () => { addIntervalRow(); updateEstimate(); });
intervalsContainer.querySelectorAll('.interval-row').forEach(bindRow);
// –¢—Ä–∏–≥–≥–µ—Ä–∏–º –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç –ø–æ—Å–ª–µ –±–∏–Ω–¥–∏–Ω–≥–∞, –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª —É–∂–µ –µ—Å—Ç—å
setTimeout(updateEstimate, 0);

document.getElementById('createForm').addEventListener('submit', function(e) {
    // Final validation and limit check
    const objects = getSelectedObjectsCount();
    const intervals = getIntervalsCount();
    let days = 1;
    if (creationModeInput.value === 'series') {
        const sd = seriesStartInput.value;
        const ed = seriesEndInput.value;
        if (!(sd && ed && sd <= ed)) {
            e.preventDefault();
            alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç —Å–µ—Ä–∏–∏');
            return false;
        }
        const weekdays = Array.from(document.querySelectorAll('input[name="weekdays"]:checked')).map(i => parseInt(i.value));
        days = enumerateDates(sd, ed, weekdays).length;
    } else if (!slotDateInput.value) {
        e.preventDefault();
        alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É');
        return false;
    }
    const total = objects * intervals * days;
    if (total === 0) {
        e.preventDefault();
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç—ã, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏ –¥–∞—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤');
        return false;
    }
    if (total > 1000) {
        e.preventDefault();
        alert('–õ–∏–º–∏—Ç: –Ω–µ –±–æ–ª–µ–µ 1000 —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑');
        return false;
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    slotDateInput.value = today;
    seriesStartInput.setAttribute('min', today);
    seriesEndInput.setAttribute('min', today);
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–µ–º –æ–±—ä–µ–∫—Ç–∞
    const defaultStart = "{{ object.opening_time }}";
    const defaultEnd = "{{ object.closing_time }}";
    const firstStart = intervalsContainer.querySelector('.interval-start');
    const firstEnd = intervalsContainer.querySelector('.interval-end');
    if (firstStart && !firstStart.value && defaultStart) firstStart.value = defaultStart;
    if (firstEnd && !firstEnd.value && defaultEnd) firstEnd.value = defaultEnd;
    // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞
    slotDateInput.addEventListener('change', updateEstimate);
    seriesStartInput.addEventListener('change', updateEstimate);
    seriesEndInput.addEventListener('change', updateEstimate);
    document.querySelectorAll('input[name="weekdays"]').forEach(cb => {
        cb.addEventListener('change', updateEstimate);
    });
    document.querySelectorAll('input[name="selected_objects"]').forEach(cb => {
        cb.addEventListener('change', updateEstimate);
    });
    updateEstimate();
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–∞
function addTask() {
    const container = document.getElementById('tasks-container');
    const taskCount = container.querySelectorAll('.task-item').length;
    const taskItem = document.createElement('div');
    taskItem.className = 'task-item mb-3 border rounded p-3';
    taskItem.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <label class="form-label small">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" 
                       class="form-control" 
                       name="task_texts[]" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ">
            </div>
            <div class="col-md-2">
                <label class="form-label small">–ü—Ä–µ–º–∏—è (‚ÇΩ)</label>
                <input type="number" 
                       class="form-control" 
                       name="task_amounts[]" 
                       value="0"
                       step="0.01">
            </div>
            <div class="col-md-2">
                <label class="form-label small">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è</label>
                <div class="form-check mt-2">
                    <input class="form-check-input" 
                           type="checkbox" 
                           name="task_mandatory[]" 
                           value="${taskCount}" checked>
                    <label class="form-check-label">–î–∞</label>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small">–ú–µ–¥–∏–∞ –æ—Ç—á–µ—Ç</label>
                <div class="form-check mt-2">
                    <input class="form-check-input" 
                           type="checkbox" 
                           name="task_requires_media[]" 
                           value="${taskCount}">
                    <label class="form-check-label">üì∏</label>
                </div>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" 
                        class="btn btn-outline-danger btn-sm w-100" 
                        onclick="removeTask(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(taskItem);
}

function removeTask(button) {
    const taskItem = button.closest('.task-item');
    taskItem.remove();
}
</script>
{% endblock %}
