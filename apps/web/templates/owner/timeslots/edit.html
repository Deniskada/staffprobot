{% extends "owner/base_owner.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-pencil"></i> {{ title }}
                    </h1>
                    <p class="text-muted mb-0">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º-—Å–ª–æ—Ç–∞</p>
                </div>
                <div>
                    <a href="/owner/timeslots/object/{{ timeslot.object_id }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Ç–∞–π–º-—Å–ª–æ—Ç–∞–º
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞–π–º-—Å–ª–æ—Ç–µ
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="editForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="slot_date" class="form-label">
                                    <i class="bi bi-calendar-event"></i> –î–∞—Ç–∞ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ *
                                </label>
                                <input type="date" 
                                       class="form-control" 
                                       id="slot_date" 
                                       name="slot_date" 
                                       value="{{ timeslot.slot_date }}"
                                       required>
                                <div class="form-text">–î–∞—Ç–∞ –¥–ª—è —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="hourly_rate" class="form-label">
                                    <i class="bi bi-currency-dollar"></i> –°—Ç–∞–≤–∫–∞ –∑–∞ —á–∞—Å *
                                </label>
                                <div class="input-group">
                                    <input type="number" 
                                           class="form-control" 
                                           id="hourly_rate" 
                                           name="hourly_rate" 
                                           value="{{ timeslot.hourly_rate }}"
                                           min="0"
                                           step="0.01"
                                           required
                                           placeholder="500">
                                    <span class="input-group-text">‚ÇΩ/—á–∞—Å</span>
                                </div>
                                <div class="form-text">–ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="max_employees" class="form-label">
                                    <i class="bi bi-people"></i> –õ–∏–º–∏—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ *
                                </label>
                                <input type="number"
                                       class="form-control"
                                       id="max_employees"
                                       name="max_employees"
                                       min="1"
                                       step="1"
                                       value="{{ timeslot.max_employees or 1 }}"
                                       required>
                                <div class="form-text">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —ç—Ç–æ—Ç —Ç–∞–π–º-—Å–ª–æ—Ç</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="start_time" class="form-label">
                                    <i class="bi bi-clock"></i> –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ *
                                </label>
                                <input type="time" 
                                       class="form-control" 
                                       id="start_time" 
                                       name="start_time" 
                                       value="{{ timeslot.start_time }}"
                                       required>
                                <div class="form-text">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="end_time" class="form-label">
                                    <i class="bi bi-clock-fill"></i> –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è *
                                </label>
                                <input type="time" 
                                       class="form-control" 
                                       id="end_time" 
                                       name="end_time" 
                                       value="{{ timeslot.end_time }}"
                                       required>
                                <div class="form-text">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="is_active" 
                                           name="is_active" 
                                           {% if timeslot.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">
                                        <i class="bi bi-check-circle"></i> –ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º-—Å–ª–æ—Ç
                                    </label>
                                    <div class="form-text">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º-—Å–ª–æ—Ç—ã –Ω–µ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">
                        
                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–æ–∑–¥–∞–Ω–∏–π –∏ –∑–∞–¥–∞—á -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="penalize_late_start" 
                                           id="penalize_late_start"
                                           {% if timeslot.penalize_late_start %}checked{% endif %}>
                                    <label class="form-check-label" for="penalize_late_start">
                                        <i class="bi bi-exclamation-triangle text-warning"></i> –®—Ç—Ä–∞—Ñ–æ–≤–∞—Ç—å –∑–∞ –æ–ø–æ–∑–¥–∞–Ω–∏–µ
                                    </label>
                                    <div class="form-text">–ü—Ä–∏–º–µ–Ω—è—Ç—å —à—Ç—Ä–∞—Ñ –∑–∞ –æ–ø–æ–∑–¥–∞–Ω–∏–µ –Ω–∞ –Ω–∞—á–∞–ª–æ —ç—Ç–æ–≥–æ —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="ignore_object_tasks" 
                                           id="ignore_object_tasks"
                                           {% if timeslot.ignore_object_tasks %}checked{% endif %}>
                                    <label class="form-check-label" for="ignore_object_tasks">
                                        <i class="bi bi-x-circle text-danger"></i> –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞
                                    </label>
                                    <div class="form-text">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —Ç–∞–π–º-—Å–ª–æ—Ç–∞</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ó–∞–¥–∞—á–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tasks"></i> –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–º–µ–Ω—É
                                        <i class="fas fa-info-circle text-muted" 
                                           data-bs-toggle="tooltip" 
                                           title="–ó–∞–¥–∞—á–∏, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∞–π–º-—Å–ª–æ—Ç–∞"></i>
                                    </label>
                                    <div id="tasks-container">
                                        {% if timeslot.shift_tasks %}
                                            {% for task in timeslot.shift_tasks %}
                                            <div class="task-item mb-3 border rounded p-3">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="form-label small">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               name="task_texts[]" 
                                                               value="{{ task.text if task is mapping else task }}"
                                                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small">–ü—Ä–µ–º–∏—è (‚ÇΩ)</label>
                                                        <input type="number" 
                                                               class="form-control" 
                                                               name="task_amounts[]" 
                                                               value="{{ task.bonus_amount if task is mapping and task.bonus_amount else (task.deduction_amount if task is mapping else 0) }}"
                                                               step="0.01">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è</label>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input" 
                                                                   type="checkbox" 
                                                                   name="task_mandatory[]" 
                                                                   value="{{ loop.index0 }}"
                                                                   {% if task is mapping and task.is_mandatory %}checked{% elif task is not mapping %}checked{% endif %}>
                                                            <label class="form-check-label">–î–∞</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small">–ú–µ–¥–∏–∞ –æ—Ç—á–µ—Ç</label>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input" 
                                                                   type="checkbox" 
                                                                   name="task_requires_media[]" 
                                                                   value="{{ loop.index0 }}"
                                                                   {% if task is mapping and task.requires_media %}checked{% endif %}>
                                                            <label class="form-check-label">üì∏</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-1 d-flex align-items-end">
                                                        <button type="button" 
                                                                class="btn btn-outline-danger btn-sm w-100" 
                                                                onclick="removeTask(this)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <button type="button" 
                                            class="btn btn-outline-primary btn-sm mt-2" 
                                            onclick="addTask()">
                                        <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
                                    </button>
                                    <div class="form-text">
                                        {% if timeslot.ignore_object_tasks %}
                                            –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –∑–∞–¥–∞—á–∏ (–∑–∞–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
                                        {% else %}
                                            –≠—Ç–∏ –∑–∞–¥–∞—á–∏ –¥–æ–ø–æ–ª–Ω—è—Ç –∑–∞–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-between">
                            <a href="/owner/timeslots/object/{{ timeslot.object_id }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ
                    </h5>
                </div>
                <div class="card-body">
                    <h6>{{ object.name }}</h6>
                    <p class="text-muted small mb-2">{{ object.address }}</p>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-primary">{{ object.hourly_rate }} ‚ÇΩ</div>
                                <small class="text-muted">–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-success">{{ object.opening_time }}</div>
                                <small class="text-muted">–û—Ç–∫—Ä—ã—Ç–∏–µ</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center mt-2">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-danger">{{ object.closing_time }}</div>
                                <small class="text-muted">–ó–∞–∫—Ä—ã—Ç–∏–µ</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-info">{{ object.max_distance }}–º</div>
                                <small class="text-muted">–ú–∞–∫—Å. —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ</small>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <div class="text-center">
                        <h6 class="text-muted mb-2">–¢–µ–∫—É—â–∏–π —Ç–∞–π–º-—Å–ª–æ—Ç</h6>
                        <div class="border rounded p-3 bg-light">
                            <div class="fw-bold text-success">{{ timeslot.hourly_rate }} ‚ÇΩ/—á–∞—Å</div>
                            <small class="text-muted">–°—Ç–∞–≤–∫–∞</small>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-info">{{ timeslot.max_employees or 1 }} —á–µ–ª.</span>
                            <small class="text-muted d-block">–õ–∏–º–∏—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history"></i> –¢–µ–∫—É—â–∏–π —Ç–∞–π–º-—Å–ª–æ—Ç
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>{{ timeslot.name }}</strong>
                        {% if timeslot.is_active %}
                        <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                        <span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-primary">{{ timeslot.start_time }}</div>
                                <small class="text-muted">–ù–∞—á–∞–ª–æ</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-danger">{{ timeslot.end_time }}</div>
                                <small class="text-muted">–û–∫–æ–Ω—á–∞–Ω–∏–µ</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-2">
                        <div class="border rounded p-2">
                            <div class="fw-bold text-success">{{ timeslot.hourly_rate }} ‚ÇΩ/—á–∞—Å</div>
                            <small class="text-muted">–°—Ç–∞–≤–∫–∞</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightbulb"></i> –°–æ–≤–µ—Ç—ã
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0 small">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–±–æ—Ç—ã –æ–±—ä–µ–∫—Ç–∞
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            –°—Ç–∞–≤–∫–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –±–∞–∑–æ–≤–æ–π
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            –û—Ç–∫–ª—é—á–∏—Ç–µ —Å–ª–æ—Ç, –µ—Å–ª–∏ –æ–Ω –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                        </li>
                        <li class="mb-0">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–ª–∏—è—é—Ç –Ω–∞ –±—É–¥—É—â–∏–µ —Å–º–µ–Ω—ã
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
document.getElementById('editForm').addEventListener('submit', function(e) {
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    
    if (startTime && endTime && startTime >= endTime) {
        e.preventDefault();
        alert('–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è');
        return false;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ unchecked checkbox'–æ–≤
    const form = e.target;
    
    // penalize_late_start
    if (!document.getElementById('penalize_late_start').checked) {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'penalize_late_start';
        hidden.value = 'false';
        form.appendChild(hidden);
    }
    
    // ignore_object_tasks  
    if (!document.getElementById('ignore_object_tasks').checked) {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'ignore_object_tasks';
        hidden.value = 'false';
        form.appendChild(hidden);
    }
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ —Ç–∞–π–º-—Å–ª–æ—Ç–∞
function addTask() {
    const container = document.getElementById('tasks-container');
    const taskCount = container.querySelectorAll('.task-item').length;
    const taskItem = document.createElement('div');
    taskItem.className = 'task-item mb-3 border rounded p-3';
    taskItem.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <label class="form-label small">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" 
                       class="form-control" 
                       name="task_texts[]" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ">
            </div>
            <div class="col-md-2">
                <label class="form-label small">–ü—Ä–µ–º–∏—è (‚ÇΩ)</label>
                <input type="number" 
                       class="form-control" 
                       name="task_amounts[]" 
                       value="0"
                       step="0.01">
            </div>
            <div class="col-md-2">
                <label class="form-label small">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è</label>
                <div class="form-check mt-2">
                    <input class="form-check-input" 
                           type="checkbox" 
                           name="task_mandatory[]" 
                           value="${taskCount}" checked>
                    <label class="form-check-label">–î–∞</label>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label small">–ú–µ–¥–∏–∞ –æ—Ç—á–µ—Ç</label>
                <div class="form-check mt-2">
                    <input class="form-check-input" 
                           type="checkbox" 
                           name="task_requires_media[]" 
                           value="${taskCount}">
                    <label class="form-check-label">üì∏</label>
                </div>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" 
                        class="btn btn-outline-danger btn-sm w-100" 
                        onclick="removeTask(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(taskItem);
}

function removeTask(button) {
    const taskItem = button.closest('.task-item');
    taskItem.remove();
}
</script>
{% endblock %}
