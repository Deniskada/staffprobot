{% extends "owner/base_owner.html" %}

{% block title %}Начисление #{{ entry.id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-money-bill-wave text-success"></i> Начисление #{{ entry.id }}</h1>
                <a href="/owner/payroll" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> К списку
                </a>
            </div>
            
            <!-- Основная информация -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Основная информация</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Сотрудник:</strong></td>
                                    <td>{{ entry.employee.name if entry.employee else 'ID: ' ~ entry.employee_id }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Период:</strong></td>
                                    <td>
                                        {{ entry.period_start.strftime('%d.%m.%Y') }} - 
                                        {{ entry.period_end.strftime('%d.%m.%Y') }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Часов отработано:</strong></td>
                                    <td>{{ "%.2f"|format(entry.hours_worked) }} ч</td>
                                </tr>
                                <tr>
                                    <td><strong>Почасовая ставка:</strong></td>
                                    <td>{{ "%.2f"|format(entry.hourly_rate) }}₽</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Начислено:</strong></td>
                                    <td><span class="badge bg-primary fs-6">{{ "%.2f"|format(entry.gross_amount) }}₽</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Удержания:</strong></td>
                                    <td><span class="badge bg-danger fs-6">-{{ "%.2f"|format(entry.total_deductions) }}₽</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Доплаты:</strong></td>
                                    <td><span class="badge bg-success fs-6">+{{ "%.2f"|format(entry.total_bonuses) }}₽</span></td>
                                </tr>
                                <tr>
                                    <td><strong>К выплате:</strong></td>
                                    <td><span class="badge bg-success fs-5">{{ "%.2f"|format(entry.net_amount) }}₽</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if entry.notes %}
                    <div class="alert alert-info mt-3">
                        <strong>Комментарий:</strong> {{ entry.notes }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Удержания -->
            <div class="card mb-4">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-minus-circle"></i> Удержания</h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addDeductionModal">
                        <i class="fas fa-plus"></i> Добавить
                    </button>
                </div>
                <div class="card-body">
                    {% if deductions %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Тип</th>
                                    <th>Описание</th>
                                    <th>Сумма</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for deduction in deductions %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">{{ deduction.adjustment_type }}</span>
                                    </td>
                                    <td>{{ deduction.description }}</td>
                                    <td class="text-danger"><strong>{{ "%.2f"|format(deduction.amount|abs) }}₽</strong></td>
                                    <td>{{ deduction.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                    <td>
                                        {% if deduction.adjustment_type in ['manual_bonus', 'manual_deduction'] %}
                                        <button class="btn btn-sm btn-outline-primary btn-edit-adjustment"
                                                data-adjustment-id="{{ deduction.id }}"
                                                data-amount="{{ deduction.amount|abs }}"
                                                data-description="{{ deduction.description }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger btn-delete-adjustment"
                                                data-adjustment-id="{{ deduction.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Удержаний нет</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Доплаты -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Доплаты</h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addBonusModal">
                        <i class="fas fa-plus"></i> Добавить
                    </button>
                </div>
                <div class="card-body">
                    {% if bonuses %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Тип</th>
                                    <th>Описание</th>
                                    <th>Сумма</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bonus in bonuses %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">{{ bonus.adjustment_type }}</span>
                                    </td>
                                    <td>{{ bonus.description }}</td>
                                    <td class="text-success"><strong>{{ "%.2f"|format(bonus.amount) }}₽</strong></td>
                                    <td>{{ bonus.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                    <td>
                                        {% if bonus.adjustment_type in ['manual_bonus', 'manual_deduction'] %}
                                        <button class="btn btn-sm btn-outline-primary btn-edit-adjustment"
                                                data-adjustment-id="{{ bonus.id }}"
                                                data-amount="{{ bonus.amount }}"
                                                data-description="{{ bonus.description }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger btn-delete-adjustment"
                                                data-adjustment-id="{{ bonus.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Доплат нет</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Выплаты -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-hand-holding-usd"></i> Выплаты</h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createPaymentModal">
                        <i class="fas fa-plus"></i> Записать выплату
                    </button>
                </div>
                <div class="card-body">
                    {% if payments %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Дата выплаты</th>
                                    <th>Сумма</th>
                                    <th>Способ</th>
                                    <th>Статус</th>
                                    <th>Подтверждение</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payments %}
                                <tr>
                                    <td>{{ payment.payment_date.strftime('%d.%m.%Y') }}</td>
                                    <td><strong>{{ "%.2f"|format(payment.amount) }}₽</strong></td>
                                    <td>{{ payment.payment_method }}</td>
                                    <td>
                                        {% if payment.status == 'completed' %}
                                        <span class="badge bg-success">Выполнена</span>
                                        {% elif payment.status == 'pending' %}
                                        <span class="badge bg-warning">Ожидание</span>
                                        {% else %}
                                        <span class="badge bg-danger">Ошибка</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ payment.confirmation_code or '-' }}</td>
                                    <td>
                                        {% if payment.status == 'pending' %}
                                        <button class="btn btn-sm btn-success" 
                                                onclick="openConfirmPaymentModal({{ payment.id }})">
                                            <i class="fas fa-check"></i> Подтвердить
                                        </button>
                                        {% elif payment.status == 'completed' %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Выплат нет</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Детали расчёта (calculation_details) -->
            {% if entry.calculation_details %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-calculator"></i> Детали расчёта</h5>
                </div>
                <div class="card-body">
                    <p><strong>Создано:</strong> {{ entry.calculation_details.created_by }} ({{ entry.calculation_details.created_at }})</p>
                    
                    {% if entry.calculation_details.shifts %}
                    <h6 class="mt-3">Смены ({{ entry.calculation_details.shifts | length }}):</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID смены</th>
                                <th>Дата</th>
                                <th>Часы</th>
                                <th>Ставка</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for shift in entry.calculation_details.shifts %}
                            <tr>
                                <td>#{{ shift.shift_id }}</td>
                                <td>{{ shift.date }}</td>
                                <td>{{ shift.hours }} ч</td>
                                <td>{{ shift.rate }}₽/ч</td>
                                <td><strong>{{ shift.amount }}₽</strong></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                    
                    {% if entry.calculation_details.adjustments %}
                    <h6 class="mt-3">Корректировки ({{ entry.calculation_details.adjustments | length }}):</h6>
                    <ul class="list-group">
                    {% for adj in entry.calculation_details.adjustments %}
                        <li class="list-group-item d-flex justify-content-between">
                            <span>
                                <strong>#{{ adj.adjustment_id }}</strong>: {{ adj.type }}
                                {% if adj.description %}({{ adj.description }}){% endif %}
                                {% if adj.shift_id %}<small class="text-muted">смена #{{ adj.shift_id }}</small>{% endif %}
                            </span>
                            <span class="badge {{ 'bg-success' if adj.amount > 0 else 'bg-danger' }}">
                                {{ adj.amount }}₽
                            </span>
                        </li>
                    {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Протокол изменений корректировок -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Протокол изменений</h5>
                </div>
                <div class="card-body">
                    {% set all_events = [] %}
                    {% for adj in deductions + bonuses %}
                        {% set _ = all_events.append({
                            'timestamp': adj.created_at,
                            'type': 'created',
                            'adjustment_id': adj.id,
                            'adjustment_type': adj.adjustment_type,
                            'amount': adj.amount,
                            'description': adj.description,
                            'user_name': adj.creator.last_name ~ ' ' ~ adj.creator.first_name if adj.creator else 'Система'
                        }) %}
                        {% if adj.edit_history %}
                            {% for change in adj.edit_history %}
                                {% set _ = all_events.append({
                                    'timestamp': change.timestamp,
                                    'type': 'edited',
                                    'adjustment_id': adj.id,
                                    'adjustment_type': adj.adjustment_type,
                                    'field': change.field,
                                    'old_value': change.old_value,
                                    'new_value': change.new_value,
                                    'user_id': change.user_id,
                                    'user_name': change.user_name if change.user_name else None
                                }) %}
                            {% endfor %}
                        {% endif %}
                        {% if adj.is_applied and adj.updated_at %}
                            {% set _ = all_events.append({
                                'timestamp': adj.updated_at,
                                'type': 'applied',
                                'adjustment_id': adj.id,
                                'adjustment_type': adj.adjustment_type,
                                'payroll_entry_id': adj.payroll_entry_id
                            }) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if all_events %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Дата/Время</th>
                                    <th>Событие</th>
                                    <th>Детали</th>
                                    <th>Пользователь</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in all_events|sort(attribute='timestamp', reverse=True) %}
                                <tr>
                                    <td>
                                        {% if event.timestamp is string %}
                                            {{ event.timestamp }}
                                        {% else %}
                                            {{ event.timestamp.strftime('%d.%m.%Y %H:%M') }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if event.type == 'created' %}
                                            <span class="badge bg-info">Создание</span>
                                        {% elif event.type == 'edited' %}
                                            <span class="badge bg-warning">Изменение</span>
                                        {% elif event.type == 'applied' %}
                                            <span class="badge bg-success">Применение</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if event.type == 'created' %}
                                            <small>{{ event.adjustment_type }}: {{ event.description }} ({{ "%.2f"|format(event.amount) }}₽)</small>
                                        {% elif event.type == 'edited' %}
                                            <small>{{ event.field }}: {{ event.old_value }} → {{ event.new_value }}</small>
                                        {% elif event.type == 'applied' %}
                                            <small>Применено к начислению #{{ event.payroll_entry_id }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ event.user_name if event.user_name else ('ID: ' ~ event.user_id if event.user_id else 'Система') }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">История изменений пуста</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления удержания -->
<div class="modal fade" id="addDeductionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/owner/payroll/{{ entry.id }}/add-deduction">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Добавить удержание</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="deduction_type" class="form-label">Тип удержания *</label>
                        <select class="form-select" id="deduction_type" name="deduction_type" required>
                            <option value="manual">Ручное удержание</option>
                            <option value="tax">Налог</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="deduction_amount" class="form-label">Сумма (₽) *</label>
                        <input type="number" class="form-control" id="deduction_amount" name="amount" 
                               step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="deduction_description" class="form-label">Описание *</label>
                        <textarea class="form-control" id="deduction_description" name="description" 
                                  rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger">Добавить удержание</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно добавления доплаты -->
<div class="modal fade" id="addBonusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/owner/payroll/{{ entry.id }}/add-bonus">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Добавить доплату</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bonus_type" class="form-label">Тип доплаты *</label>
                        <select class="form-select" id="bonus_type" name="bonus_type" required>
                            <option value="performance">За результат</option>
                            <option value="overtime">Сверхурочные</option>
                            <option value="manual">Ручная доплата</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bonus_amount" class="form-label">Сумма (₽) *</label>
                        <input type="number" class="form-control" id="bonus_amount" name="amount" 
                               step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="bonus_description" class="form-label">Описание *</label>
                        <textarea class="form-control" id="bonus_description" name="description" 
                                  rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Добавить доплату</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно записи выплаты -->
<div class="modal fade" id="createPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/owner/payroll/{{ entry.id }}/create-payment">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Записать выплату</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="payment_amount" class="form-label">Сумма (₽) *</label>
                        <input type="number" class="form-control" id="payment_amount" name="amount" 
                               step="0.01" min="0" value="{{ "%.2f"|format(entry.net_amount) }}" required>
                        <small class="form-text text-muted">К выплате: {{ "%.2f"|format(entry.net_amount) }}₽</small>
                    </div>
                    <div class="mb-3">
                        <label for="payment_date" class="form-label">Дата выплаты *</label>
                        <input type="date" class="form-control" id="payment_date" name="payment_date" 
                               value="{{ today.strftime('%Y-%m-%d') if today else '' }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Способ выплаты *</label>
                        <select class="form-select" id="payment_method" name="payment_method" required>
                            <option value="cash">Наличные</option>
                            <option value="bank_transfer">Банковский перевод</option>
                            <option value="card">Карта</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="payment_notes" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="payment_notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-info">Записать выплату</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения выплаты -->
<div class="modal fade" id="confirmPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="confirmPaymentForm">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Подтвердить выплату</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Подтвердите, что выплата была произведена.</p>
                    <div class="mb-3">
                        <label for="confirmation_code" class="form-label">Код подтверждения</label>
                        <input type="text" class="form-control" id="confirmation_code" name="confirmation_code" 
                               placeholder="Номер транзакции (необязательно)">
                        <small class="form-text text-muted">Например: номер банковской транзакции</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Подтвердить выплату
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования корректировки -->
<div class="modal fade" id="editAdjustmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать корректировку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editAdjustmentForm">
                <input type="hidden" id="edit_adjustment_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_amount" class="form-label">Сумма (₽)</label>
                        <input type="number" class="form-control" id="edit_amount" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Описание</label>
                        <textarea class="form-control" id="edit_description" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openConfirmPaymentModal(paymentId) {
    const form = document.getElementById('confirmPaymentForm');
    form.action = `/owner/payroll/{{ entry.id }}/payments/${paymentId}/complete`;
    const modal = new bootstrap.Modal(document.getElementById('confirmPaymentModal'));
    modal.show();
}

// Редактирование корректировки
document.querySelectorAll('.btn-edit-adjustment').forEach(btn => {
    console.log('Кнопка редактирования найдена:', btn.dataset.adjustmentId);
    btn.addEventListener('click', function() {
        const adjustmentId = this.dataset.adjustmentId;
        const amount = this.dataset.amount;
        const description = this.dataset.description;
        
        console.log('Клик на редактирование:', { adjustmentId, amount, description });
        
        document.getElementById('edit_adjustment_id').value = adjustmentId;
        document.getElementById('edit_amount').value = amount;
        document.getElementById('edit_description').value = description;
        
        const modal = new bootstrap.Modal(document.getElementById('editAdjustmentModal'));
        modal.show();
    });
});

document.getElementById('editAdjustmentForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('Форма редактирования отправлена');
    
    const adjustmentId = document.getElementById('edit_adjustment_id').value;
    const amount = document.getElementById('edit_amount').value;
    const description = document.getElementById('edit_description').value;
    
    console.log('Данные редактирования:', { adjustmentId, amount, description });
    
    const formData = new FormData();
    formData.append('amount', amount);
    formData.append('description', description);
    
    try {
        console.log(`Отправка запроса на /owner/payroll/adjustments/${adjustmentId}/edit`);
        const response = await fetch(`/owner/payroll/adjustments/${adjustmentId}/edit`, {
            method: 'POST',
            body: formData
        });
        
        console.log('Ответ получен, статус:', response.status);
        const data = await response.json();
        console.log('Данные ответа:', data);
        
        if (data.success) {
            alert('Корректировка обновлена!');
            location.reload();
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка редактирования: ' + error);
    }
});

// Удаление корректировки
document.querySelectorAll('.btn-delete-adjustment').forEach(btn => {
    console.log('Кнопка удаления найдена:', btn.dataset.adjustmentId);
    btn.addEventListener('click', async function() {
        console.log('Клик на удаление:', this.dataset.adjustmentId);
        
        if (!confirm('Вы уверены, что хотите удалить эту корректировку?')) {
            return;
        }
        
        const adjustmentId = this.dataset.adjustmentId;
        
        try {
            console.log(`Отправка запроса на /owner/payroll/adjustments/${adjustmentId}/delete`);
            const response = await fetch(`/owner/payroll/adjustments/${adjustmentId}/delete`, {
                method: 'POST'
            });
            
            console.log('Ответ получен, статус:', response.status);
            const data = await response.json();
            console.log('Данные ответа:', data);
            
            if (data.success) {
                alert('Корректировка удалена!');
                location.reload();
            } else {
                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка удаления: ' + error);
        }
    });
});
</script>

{% endblock %}

