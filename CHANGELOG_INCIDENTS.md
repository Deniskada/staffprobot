# Changelog: Типы тикетов, обращения и компенсации

**Дата:** 7 февраля 2026  
**Ветка:** `feature/incident-types-requests`  
**Коммит:** `84793c6d`

---

## Обзор

Система инцидентов расширена типами «Удержания» и «Обращения». Сотрудники могут создавать заявки на расходные материалы, а владельцы/управляющие — рассматривать их и назначать компенсации через корректировки ЗП. Термин «Инциденты» заменён на «Тикеты» во всех интерфейсах.

---

## Новые возможности

### Типы тикетов

- **Удержания** (`deduction`) — прежние инциденты, все существующие записи мигрированы в этот тип
- **Обращения** (`request`) — новый тип для заявок сотрудников на расходные материалы
- Категории тикетов привязаны к типу — у каждого типа свой набор категорий
- Навигация по типам через табы на страницах списка (owner, manager)

### Справочник товаров

- Глобальный каталог товаров владельца: наименование, единица измерения, цена
- CRUD-интерфейс для владельца (`/owner/products`)
- Активация/деактивация товаров

### Позиции обращений

- Обращение содержит список товаров с количеством и ценой
- Снимки наименования и цены товара сохраняются на момент добавления (не зависят от изменений каталога)
- История изменений позиций (кто добавил, кто изменил) доступна сотруднику
- Владелец/управляющий могут добавлять, редактировать и удалять позиции

### Компенсация расходных материалов

- Чекбокс «Компенсировать покупку» при редактировании обращения (owner/manager)
- При переводе обращения в статус «Решён» с отмеченным чекбоксом автоматически создаётся корректировка ЗП типа `expense_compensation`
- Сумма компенсации = сумма всех позиций обращения

### Интерфейс сотрудника

- Раздел «Тикеты» в навигации (`/employee/incidents`)
- Просмотр всех своих тикетов (удержания + обращения)
- Создание обращений с выбором категории, объекта, товаров
- Редактирование обращений до взятия в работу (статус «Новый»)
- Просмотр истории изменений по каждому тикету

### Отчёт «По заявкам»

- Новый тип отчёта в `/owner/reports`
- Фильтры: период, объект, сотрудник
- Сводка: всего заявок, компенсировано, не компенсировано (количество + суммы)
- Детальная таблица с разбивкой по обращениям

---

## Изменения в интерфейсе

- «Инциденты» → «Тикеты» во всех шаблонах owner и manager
- Табы «Удержания» / «Обращения» на страницах списка и категорий
- Динамические формы создания/редактирования в зависимости от типа
- Бейджи типа тикета на страницах просмотра и редактирования

---

## Изменения в БД (миграция `incident_types_260207`)

| Объект | Изменение |
|---|---|
| `incidents` | + `incident_type` (string, NOT NULL, default 'deduction', index) |
| `incidents` | + `compensate_purchase` (boolean, NOT NULL, default false) |
| `incident_categories` | + `incident_type` (string, NOT NULL, default 'deduction', index) |
| `products` | новая таблица (id, owner_id, name, unit, price, is_active, timestamps) |
| `incident_items` | новая таблица (id, incident_id, product_id, product_name, quantity, price, added_by, modified_by, timestamps) |

Существующие записи `incidents` и `incident_categories` автоматически мигрированы в тип `deduction`.

---

## Затронутые файлы

**Модели (5):** `incident.py`, `incident_category.py`, `product.py`, `incident_item.py`, `payroll_adjustment.py`

**Сервисы (5):** `incident_service.py`, `incident_category_service.py`, `product_service.py`, `incident_item_service.py`, `payroll_adjustment_service.py`

**Роуты (4):** `owner_incidents.py`, `owner_products.py`, `manager.py`, `employee_incidents.py`

**Шаблоны (16):** owner (7), manager (6), employee (4) — списки, создание, редактирование, просмотр, категории, отчёты, навигация

**Тесты (1):** `test_incident_service.py` — 18 юнит-тестов

**Миграции (1):** `20260207_incident_types_products.py`
