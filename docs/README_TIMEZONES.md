# –°–∏—Å—Ç–µ–º–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ –≤ StaffProBot

## üåç –û–±–∑–æ—Ä

StaffProBot –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–º–µ–Ω –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á. –ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–æ–Ω–∞—Ö.

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ–±—ä–µ–∫—Ç–∞** - –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è** - –≤—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ–±—ä–µ–∫—Ç–∞
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–æ–Ω** - –ú–æ—Å–∫–≤–∞, –õ–æ–Ω–¥–æ–Ω, –ù—å—é-–ô–æ—Ä–∫, –õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å, –¢–æ–∫–∏–æ, –®–∞–Ω—Ö–∞–π, –°–∏–¥–Ω–µ–π
- **Fallback –Ω–∞ UTC** - –µ—Å–ª–∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UTC
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –≤—Ä–µ–º—è –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

```python
class Object(Base):
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è ...
    timezone = Column(String(50), nullable=True, default="Europe/Moscow")
```

### –£—Ç–∏–ª–∏—Ç—ã

#### WebTimezoneHelper
```python
# apps/web/utils/timezone_utils.py
class WebTimezoneHelper:
    @staticmethod
    def format_datetime_with_timezone(utc_datetime, timezone_str, format_str):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç UTC –≤—Ä–µ–º—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—ä–µ–∫—Ç–∞"""
        
    @staticmethod
    def format_time_with_timezone(utc_datetime, timezone_str, format_str):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è (–±–µ–∑ –¥–∞—Ç—ã) –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ"""
```

#### TimezoneHelper
```python
# core/utils/timezone_helper.py
class TimezoneHelper:
    def utc_to_local(self, utc_datetime, timezone_str):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç UTC –≤—Ä–µ–º—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è"""
        
    def local_to_utc(self, local_datetime, timezone_str):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤ UTC"""
        
    def format_local_time(self, utc_datetime, timezone_str, format_str):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç UTC –≤—Ä–µ–º—è –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è"""
```

## üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞

| –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å | –û–ø–∏—Å–∞–Ω–∏–µ | UTC —Å–º–µ—â–µ–Ω–∏–µ | –õ–µ—Ç–Ω–µ–µ –≤—Ä–µ–º—è |
|--------------|----------|--------------|--------------|
| Europe/Moscow | –ú–æ—Å–∫–≤–∞ | UTC+3 | –ù–µ—Ç |
| Europe/London | –õ–æ–Ω–¥–æ–Ω | UTC+0/+1 | –î–∞ |
| America/New_York | –ù—å—é-–ô–æ—Ä–∫ | UTC-5/-4 | –î–∞ |
| America/Los_Angeles | –õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å | UTC-8/-7 | –î–∞ |
| Asia/Tokyo | –¢–æ–∫–∏–æ | UTC+9 | –ù–µ—Ç |
| Asia/Shanghai | –®–∞–Ω—Ö–∞–π | UTC+8 | –ù–µ—Ç |
| Australia/Sydney | –°–∏–¥–Ω–µ–π | UTC+10/+11 | –î–∞ |

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞

### 1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞

–í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞:

```html
<select class="form-select" id="timezone" name="timezone" required>
    <option value="Europe/Moscow">–ú–æ—Å–∫–≤–∞ (UTC+3)</option>
    <option value="Europe/London">–õ–æ–Ω–¥–æ–Ω (UTC+0/+1)</option>
    <option value="America/New_York">–ù—å—é-–ô–æ—Ä–∫ (UTC-5/-4)</option>
    <!-- ... –¥—Ä—É–≥–∏–µ –æ–ø—Ü–∏–∏ ... -->
</select>
```

### 2. –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞

–í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –∏–∑–º–µ–Ω–∏—Ç–µ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–û–±—ä–µ–∫—Ç—ã" ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç ‚Üí "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
2. –í —Ä–∞–∑–¥–µ–ª–µ "–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å" –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–æ–Ω—É
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 3. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é

–ï—Å–ª–∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Europe/Moscow` (UTC+3).

## üìä –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏

### –í –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

–í—Ä–µ–º—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ–±—ä–µ–∫—Ç–∞:

```python
# –í —Ä–æ—É—Ç–∞—Ö
"start_time": web_timezone_helper.format_datetime_with_timezone(
    shift.start_time, 
    shift.object.timezone if shift.object else 'Europe/Moscow'
)
```

### –í –±–æ—Ç–µ

–í—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```python
# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –±–æ—Ç–∞
user_timezone = timezone_helper.get_user_timezone(user_id)
local_start_time = timezone_helper.format_local_time(start_time_utc, user_timezone)
```

### –í –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á–∞—Ö

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ–±—ä–µ–∫—Ç–∞:

```python
# –í auto_close_shifts
if hasattr(shift.object, 'timezone') and shift.object.timezone:
    object_tz = pytz.timezone(shift.object.timezone)
    end_time = object_tz.localize(end_time).astimezone(pytz.UTC)
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è timezone

```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è 9e47662cd158
ALTER TABLE objects ADD COLUMN timezone VARCHAR(50) DEFAULT 'Europe/Moscow';
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤

```python
# –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –±–µ–∑ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
UPDATE objects SET timezone = 'Europe/Moscow' WHERE timezone IS NULL;
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

```python
def test_timezone_conversion():
    """–¢–µ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤"""
    helper = WebTimezoneHelper()
    
    # UTC –≤—Ä–µ–º—è
    utc_time = datetime(2024, 1, 1, 12, 0, 0, tzinfo=pytz.UTC)
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    moscow_time = helper.format_datetime_with_timezone(
        utc_time, 'Europe/Moscow', '%Y-%m-%d %H:%M'
    )
    
    assert moscow_time == "2024-01-01 15:00"  # UTC+3
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```python
def test_object_timezone_display():
    """–¢–µ—Å—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –æ–±—ä–µ–∫—Ç–∞"""
    # –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º
    object = create_object(timezone='America/New_York')
    
    # –°–æ–∑–¥–∞—Ç—å —Å–º–µ–Ω—É
    shift = create_shift(object_id=object.id, start_time=utc_time)
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    response = client.get(f"/owner/shifts/{shift.id}")
    assert "2024-01-01 07:00" in response.text  # UTC-5
```

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ UTC

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ —É–∫–∞–∑–∞–Ω —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ–±—ä–µ–∫—Ç–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –≤ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–µ `timezone` –≤ –æ–±—ä–µ–∫—Ç–µ
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `WebTimezoneHelper`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ "Unknown timezone"

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–≤–µ—Ä–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –≤ –ë–î
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞
3. –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Ä–µ–º—è –Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞**: –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ –≤–º–µ—Å—Ç–æ datetime –æ–±—ä–µ–∫—Ç–∞

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤ `WebTimezoneHelper`
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Ä–µ–º—è –≤ UTC —Ñ–æ—Ä–º–∞—Ç–µ
3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [pytz –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://pythonhosted.org/pytz/)
- [–°–ø–∏—Å–æ–∫ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones)
- [UTC –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä](https://www.timeanddate.com/worldclock/converter.html)

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è

### v1.0.0 (2024-09-14)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω WebTimezoneHelper –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω TimezoneHelper –¥–ª—è –±–æ—Ç–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ timezone –≤ –º–æ–¥–µ–ª—å Object
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- üîÑ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
- üîÑ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
- üîÑ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –æ–±—ä–µ–∫—Ç–∞
