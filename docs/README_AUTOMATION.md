# –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤ StaffProBot

## ü§ñ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á

StaffProBot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Celery** –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

## üìã –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω

**–ó–∞–¥–∞—á–∞**: `auto_close_shifts`  
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ**: –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00  
**–§–∞–π–ª**: `core/celery/tasks/shift_tasks.py`

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∞–ª–∏—Å—å –≤—á–µ—Ä–∞
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1**: –í—Ä–µ–º—è –∏–∑ —Ç–∞–π–º-—Å–ª–æ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2**: –í—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–±—ä–µ–∫—Ç–∞
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3**: –ü–æ–ª–Ω–æ—á—å (00:00)
3. **–£—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ–±—ä–µ–∫—Ç–∞** - –≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ UTC
4. –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É —Å —Ñ–ª–∞–≥–æ–º `auto_closed = True`
5. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â–µ–µ –≤—Ä–µ–º—è –∏ –æ–ø–ª–∞—Ç—É

#### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
```
Auto-closed 0 shifts at midnight
Auto-close completed: 0 shifts closed
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥

**–ó–∞–¥–∞—á–∞**: `plan_next_year_timeslots`  
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ**: 1 –¥–µ–∫–∞–±—Ä—è –≤ 03:00  
**–§–∞–π–ª**: `core/celery/tasks/shift_tasks.py`

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–π–º-—Å–ª–æ—Ç—ã –Ω–∞ –≤–µ—Å—å —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
3. –£—á–∏—Ç—ã–≤–∞–µ—Ç:
   - `work_days_mask` - –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç—ã
   - `schedule_repeat_weeks` - –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
   - `opening_time` –∏ `closing_time` - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
   - `hourly_rate` - —Å—Ç–∞–≤–∫–∞ –æ–ø–ª–∞—Ç—ã
4. –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–π–º-—Å–ª–æ—Ç—ã

#### –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
```
Planned next year timeslots: created=1722
```

## üåç –°–∏—Å—Ç–µ–º–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏

–í—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ–±—ä–µ–∫—Ç–∞:

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω** - –≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ UTC —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –æ–±—ä–µ–∫—Ç–∞
- **–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤** - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –æ–±—ä–µ–∫—Ç–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
- **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏** - –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –æ–±—ä–µ–∫—Ç–∞

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞

| –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å | UTC —Å–º–µ—â–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------------|--------------|----------|
| Europe/Moscow | UTC+3 | –ú–æ—Å–∫–≤–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| Europe/London | UTC+0/+1 | –õ–æ–Ω–¥–æ–Ω |
| America/New_York | UTC-5/-4 | –ù—å—é-–ô–æ—Ä–∫ |
| America/Los_Angeles | UTC-8/-7 | –õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å |
| Asia/Tokyo | UTC+9 | –¢–æ–∫–∏–æ |
| Asia/Shanghai | UTC+8 | –®–∞–Ω—Ö–∞–π |
| Australia/Sydney | UTC+10/+11 | –°–∏–¥–Ω–µ–π |

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

- **WebTimezoneHelper** - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- **TimezoneHelper** - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –±–æ—Ç–µ
- **–ü–æ–ª–µ timezone** - –≤ –º–æ–¥–µ–ª–∏ Object
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è** - –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery

### –°–µ—Ä–≤–∏—Å—ã:
- **Celery Worker** - –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á–∏
- **Celery Beat** - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
- **RabbitMQ** - –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
- **Redis** - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á:
```python
beat_schedule={
    'auto-close-shifts': {
        'task': 'core.celery.tasks.shift_tasks.auto_close_shifts',
        'schedule': crontab(hour=0, minute=0),  # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00
    },
    'plan-next-year-timeslots': {
        'task': 'core.celery.tasks.shift_tasks.plan_next_year_timeslots',
        'schedule': crontab(hour=3, minute=0, day_of_month=1, month_of_year=12),  # 1 –¥–µ–∫–∞–±—Ä—è –≤ 03:00
    },
}
```

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏

### –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á –≤—Ä—É—á–Ω—É—é:
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω
docker compose -f docker-compose.dev.yml exec celery_worker celery -A core.celery.celery_app call core.celery.tasks.shift_tasks.auto_close_shifts

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º-—Å–ª–æ—Ç–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
docker compose -f docker-compose.dev.yml exec celery_worker celery -A core.celery.celery_app call core.celery.tasks.shift_tasks.plan_next_year_timeslots
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
```bash
# –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
docker compose -f docker-compose.dev.yml exec celery_worker celery -A core.celery.celery_app inspect active

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
docker compose -f docker-compose.dev.yml exec celery_worker celery -A core.celery.celery_app inspect stats
```

### –õ–æ–≥–∏:
```bash
# –õ–æ–≥–∏ worker'–∞
docker compose -f docker-compose.dev.yml logs celery_worker --tail=20

# –õ–æ–≥–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
docker compose -f docker-compose.dev.yml logs celery_beat --tail=20
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –í—Å–µ –∑–∞–¥–∞—á–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- –û—à–∏–±–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

### –ú–µ—Ç—Ä–∏–∫–∏:
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Development:
```bash
docker compose -f docker-compose.dev.yml up -d
```

### Production:
```bash
docker compose -f docker-compose.prod.yml up -d
```

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î:
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `get_async_session()` –≤–º–µ—Å—Ç–æ `DatabaseManager`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Celery Beat –∑–∞–ø—É—â–µ–Ω
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ pidfile –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–¥–∞—á–∞–º–∏:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ worker'–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ RabbitMQ

## üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –≤ `core/celery/tasks/`
2. –î–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ `celery_app.py`
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∑–∞–¥–∞—á—É –≤—Ä—É—á–Ω—É—é
4. –î–æ–±–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

–ü—Ä–∏–º–µ—Ä:
```python
@celery_app.task(base=ShiftTask, bind=True)
def my_automation_task(self):
    """–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏."""
    try:
        # –õ–æ–≥–∏–∫–∞ –∑–∞–¥–∞—á–∏
        return result
    except Exception as e:
        logger.error(f"Error in my_automation_task: {e}")
        return 0
```
